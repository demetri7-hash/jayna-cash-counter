<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, viewport-fit=cover">
  <title>Foot Traffic Analytics | Jayna Gyro</title>

  <link rel="apple-touch-icon" href="https://static.spotapps.co/website_images/ab_websites/229800_website_v1/logo.png">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#00A8E1">

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.js"></script>

  <style>
    /* Jayna Brand Design - Standardized Colors */
    :root {
      --primary-blue: #00A8E1;
      --secondary-blue: #0094D6;
      --light-blue: #E3F4FC;
      --accent-blue: #0081C6;
      --gray-900: #212121;
      --gray-700: #424242;
      --gray-600: #616161;
      --gray-500: #757575;
      --gray-400: #BDBDBD;
      --gray-300: #E0E0E0;
      --gray-100: #F5F5F5;
      --success: #00C853;
      --warning: #FFB300;
      --error: #D32F2F;
      --white: #FFFFFF;

      --jayna-blue: #00A8E1;
      --turquoise: #20B2AA;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    html, body {
      font-family: 'Aptos', 'Segoe UI Variable', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      background: var(--white);
      min-height: 100vh;
      padding: 0;
      overflow-x: hidden;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: var(--white);
      padding: 0;
    }

    .header {
      background: var(--white);
      color: var(--gray-900);
      text-align: center;
      padding: 12px;
      border-bottom: 1px solid var(--gray-300);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
    }

    .header-info {
      text-align: left;
      flex: 1;
    }

    .header h1 {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 2px;
      letter-spacing: 1.5px;
      text-transform: uppercase;
    }

    .header p {
      opacity: 0.7;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .logo {
      max-width: 576px;
      width: 100%;
      height: auto;
      display: block;
      margin: 0 auto 8px auto;
    }

    .nav-links {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .nav-link {
      color: var(--gray-700);
      text-decoration: underline;
      padding: 0;
      font-size: 11px;
      font-weight: 600;
      transition: color 0.15s ease;
      background: transparent;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border: none;
    }

    .nav-link:hover {
      color: var(--gray-900);
    }

    .content {
      padding: 20px;
    }

    .controls {
      background: var(--white);
      border: 2px solid var(--gray-300);
      padding: 20px;
      margin-bottom: 20px;
      display: flex;
      gap: 20px;
      align-items: center;
      flex-wrap: wrap;
    }

    .control-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .control-group label {
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--gray-700);
    }

    .control-group input[type="date"] {
      padding: 12px;
      border: 2px solid var(--gray-300);
      font-size: 14px;
      font-weight: 600;
      min-width: 200px;
    }

    .control-group input[type="date"]:focus {
      outline: none;
      border-color: var(--jayna-blue);
    }

    .toggle-container {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .toggle-switch {
      position: relative;
      width: 60px;
      height: 30px;
      background: var(--gray-300);
      border-radius: 15px;
      cursor: pointer;
      transition: background 0.3s;
    }

    .toggle-switch.active {
      background: var(--jayna-blue);
    }

    .toggle-switch::after {
      content: '';
      position: absolute;
      top: 3px;
      left: 3px;
      width: 24px;
      height: 24px;
      background: var(--white);
      border-radius: 50%;
      transition: transform 0.3s;
    }

    .toggle-switch.active::after {
      transform: translateX(30px);
    }

    .disclaimer {
      font-size: 10px;
      color: var(--gray-500);
      font-style: italic;
      max-width: 300px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: var(--white);
      border: 2px solid var(--gray-300);
      padding: 16px;
    }

    .stat-card h3 {
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--gray-600);
      margin-bottom: 8px;
    }

    .stat-card .value {
      font-size: 32px;
      font-weight: 900;
      color: var(--gray-900);
      margin-bottom: 4px;
    }

    .stat-card .subtitle {
      font-size: 11px;
      color: var(--gray-500);
    }

    .chart-container {
      background: var(--white);
      border: 2px solid var(--gray-300);
      padding: 20px;
      margin-bottom: 20px;
    }

    .chart-container h2 {
      font-size: 16px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 20px;
      color: var(--gray-900);
    }

    #loadingOverlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.9);
      z-index: 99999;
      align-items: center;
      justify-content: center;
      flex-direction: column;
    }

    #loadingOverlay.active {
      display: flex;
    }

    .loading-logo {
      width: 200px;
      height: auto;
      animation: pulse 2s ease-in-out infinite;
    }

    .loading-text {
      color: var(--white);
      font-size: 14px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 2px;
      margin-top: 20px;
    }

    @keyframes pulse {
      0%, 100% {
        opacity: 0.6;
        transform: scale(0.95);
      }
      50% {
        opacity: 1;
        transform: scale(1.05);
      }
    }

  </style>
</head>
<body>
  <!-- Loading Overlay -->
  <div id="loadingOverlay">
    <img src="jayna-logo-new.png" alt="Jayna Gyro" class="loading-logo">
    <div class="loading-text">Loading Analytics...</div>
  </div>

  <div class="container">
    <!-- App Header (Unified System with Blue Card & Nav Buttons) -->
    <div id="appHeader"></div>

    <div class="content">
      <!-- Page Title -->
      <div style="text-align: center; margin-bottom: 24px; margin-top: 20px;">
        <h2 style="font-size: 20px; font-weight: 700; text-transform: uppercase; letter-spacing: 1.5px; color: var(--gray-900); margin-bottom: 4px;">üö∂ FOOT TRAFFIC ANALYTICS</h2>
        <p style="font-size: 12px; color: var(--gray-600); text-transform: uppercase; letter-spacing: 0.5px;">Sales & Visitor Correlation Analysis</p>
      </div>

      <!-- Date Selector & Controls -->
      <div class="controls">
        <div class="control-group">
          <label for="dateSelector">SELECT DATE</label>
          <input type="date" id="dateSelector">
        </div>

        <div class="control-group">
          <label>ADJUST FOR STAFF TRAFFIC</label>
          <div class="toggle-container">
            <div id="staffToggle" class="toggle-switch" onclick="toggleStaffReduction()"></div>
            <span id="staffToggleLabel" style="font-size: 13px; font-weight: 600;">OFF</span>
          </div>
          <div class="disclaimer">
            * Estimates staff reduction based on ~9 employees walking past camera during business hours. Not 100% accurate.
          </div>
        </div>
      </div>

      <!-- Stats Summary -->
      <div class="stats-grid">
        <div class="stat-card">
          <h3>üìä Total Sales</h3>
          <div class="value" id="totalSales">--</div>
          <div class="subtitle">For Selected Date</div>
        </div>

        <div class="stat-card">
          <h3>üö∂ Total Visitors</h3>
          <div class="value" id="totalVisitors">--</div>
          <div class="subtitle" id="visitorSubtitle">Raw Count</div>
        </div>

        <div class="stat-card">
          <h3>üí∞ Sales Per Visitor</h3>
          <div class="value" id="salesPerVisitor">--</div>
          <div class="subtitle">Conversion Metric</div>
        </div>

        <div class="stat-card">
          <h3>‚è∞ Peak Hour</h3>
          <div class="value" id="peakHour">--</div>
          <div class="subtitle">Highest Traffic</div>
        </div>
      </div>

      <!-- Line Chart -->
      <div class="chart-container">
        <h2>üìà Hourly Sales vs Foot Traffic</h2>
        <canvas id="analyticsChart"></canvas>
      </div>

    </div> <!-- /content -->
  </div> <!-- /container -->

  <script>
    // Initialize Supabase clients
    const supabase = window.supabase.createClient(
      'https://zjgzrfzmmjfljjlxznln.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpqZ3pyZnptbWpmbGpqbHh6bmxuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mjc4ODQ2NDEsImV4cCI6MjA0MzQ2MDY0MX0.K40HoaXA3KXGZhyTQj65fCCFcRJ8WIWQGubRhYwZB3k'
    );

    const footTrafficSupabase = window.supabase.createClient(
      'https://gaawtbqpnnbbnsyswqwv.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdhYXd0YnFwbm5iYm5zeXN3cXd2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1MDE1NTAsImV4cCI6MjA3MjA3NzU1MH0.F-y7AIQTWaUe7DRT4OnIZVn94mhXxfhpBbng2aJ8nXg'
    );

    let chartInstance = null;
    let staffReductionEnabled = false;
    let rawFootTrafficData = [];

    // Initialize date selector to today
    function getTodayPacific() {
      const today = new Date();
      const pacificDate = new Date(today.toLocaleString('en-US', { timeZone: 'America/Los_Angeles' }));
      const year = pacificDate.getFullYear();
      const month = String(pacificDate.getMonth() + 1).padStart(2, '0');
      const day = String(pacificDate.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    document.getElementById('dateSelector').value = getTodayPacific();

    // Date change handler
    document.getElementById('dateSelector').addEventListener('change', function() {
      loadAnalytics();
    });

    // Toggle staff reduction
    function toggleStaffReduction() {
      staffReductionEnabled = !staffReductionEnabled;
      const toggle = document.getElementById('staffToggle');
      const label = document.getElementById('staffToggleLabel');

      if (staffReductionEnabled) {
        toggle.classList.add('active');
        label.textContent = 'ON';
        label.style.color = 'var(--jayna-blue)';
      } else {
        toggle.classList.remove('active');
        label.textContent = 'OFF';
        label.style.color = '';
      }

      // Update subtitle
      const subtitle = document.getElementById('visitorSubtitle');
      subtitle.textContent = staffReductionEnabled ? 'Adjusted for Staff' : 'Raw Count';

      // Re-render with adjusted data
      updateStatsAndChart();
    }

    // Show/hide loading
    function showLoading() {
      document.getElementById('loadingOverlay').classList.add('active');
    }

    function hideLoading() {
      document.getElementById('loadingOverlay').classList.remove('active');
    }

    // Main analytics loader
    async function loadAnalytics() {
      showLoading();

      const selectedDate = document.getElementById('dateSelector').value;

      try {
        // Fetch both datasets in parallel
        const [footTrafficData, salesData] = await Promise.all([
          fetchFootTrafficData(selectedDate),
          fetchSalesData(selectedDate)
        ]);

        rawFootTrafficData = footTrafficData;

        // Render
        renderAnalytics(footTrafficData, salesData, selectedDate);

      } catch (error) {
        console.error('Error loading analytics:', error);
        alert('Failed to load analytics: ' + error.message);
      } finally {
        hideLoading();
      }
    }

    // Fetch foot traffic data from Supabase
    async function fetchFootTrafficData(date) {
      const { data, error } = await footTrafficSupabase
        .from('foot_traffic')
        .select('hour, entries')
        .eq('date', date)
        .order('hour', { ascending: true });

      if (error) {
        console.error('Error fetching foot traffic:', error);
        return [];
      }

      return data || [];
    }

    // Fetch sales data from Toast API
    async function fetchSalesData(date) {
      // STEP 1: Authenticate
      const authResponse = await fetch('/api/toast-auth', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      });

      if (!authResponse.ok) {
        throw new Error('Toast authentication failed');
      }

      const authData = await authResponse.json();
      if (!authData.success || !authData.data?.accessToken) {
        throw new Error('Invalid authentication response');
      }

      const accessToken = authData.data.accessToken;

      // STEP 2: Fetch orders for the selected date
      const businessDate = date.replace(/-/g, ''); // YYYYMMDD format

      // Use toast-orders-flexible which handles pagination automatically
      // Copy EXACT pattern from manager.html
      const queryParams = new URLSearchParams({
        accessToken: accessToken,
        startDate: businessDate,
        endDate: businessDate
      });

      const ordersUrl = `/api/toast-orders-flexible?${queryParams.toString()}`;
      console.log('üçû Fetching orders from:', ordersUrl.replace(/accessToken=[^&]*/, 'accessToken=***'));
      console.log('üìÖ Business date:', businessDate);

      const ordersResponse = await fetch(ordersUrl, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json'
        }
      });

      if (!ordersResponse.ok) {
        // Get the actual error message from backend
        const errorData = await ordersResponse.json().catch(() => ({ error: 'Unknown error' }));
        console.error('Toast orders API error:', ordersResponse.status, errorData);
        throw new Error(`Toast API error ${ordersResponse.status}: ${errorData.error || 'Unknown error'}`);
      }

      const ordersResult = await ordersResponse.json();

      if (!ordersResult.success || !ordersResult.data) {
        console.error('Invalid Toast API response:', ordersResult);
        throw new Error(`Invalid response: ${ordersResult.error || 'No data returned'}`);
      }

      const allOrders = ordersResult.data;

      // STEP 3: Group orders by hour and calculate sales
      const hourlyData = {};

      allOrders.forEach(order => {
        // Skip voided/deleted orders
        if (order.voided || order.deleted) return;

        // Use closedDate to determine hour
        if (!order.closedDate) return;

        const closedDate = new Date(order.closedDate);
        const hour = closedDate.getHours();

        if (!hourlyData[hour]) {
          hourlyData[hour] = { sales: 0, orders: 0 };
        }

        // Calculate order total from checks
        if (order.checks && Array.isArray(order.checks)) {
          order.checks.forEach(check => {
            if (!check.voided && !check.deleted) {
              hourlyData[hour].sales += check.amount || 0;
              hourlyData[hour].orders++;
            }
          });
        }
      });

      return hourlyData;
    }

    // Calculate staff reduction
    function calculateStaffReduction(rawCount) {
      // 9 staff members, each passing camera ~4-6 times during their shift
      // Spread across 11.5 hours (10:30am - 10pm)
      // Estimate: 9 staff * 5 passes = 45 total staff entries per day
      // Distributed across hours: ~4 per hour average

      const STAFF_REDUCTION_PER_HOUR = 4;
      return Math.max(0, rawCount - STAFF_REDUCTION_PER_HOUR);
    }

    // Update stats and chart
    function updateStatsAndChart() {
      const selectedDate = document.getElementById('dateSelector').value;
      const footTrafficData = rawFootTrafficData;

      // Apply staff reduction if enabled
      const adjustedFootTrafficData = footTrafficData.map(entry => ({
        ...entry,
        entries: staffReductionEnabled ? calculateStaffReduction(entry.entries) : entry.entries
      }));

      // Re-render stats (sales data stays the same)
      const totalVisitors = adjustedFootTrafficData.reduce((sum, d) => sum + d.entries, 0);
      document.getElementById('totalVisitors').textContent = totalVisitors.toLocaleString();

      // Update chart
      if (chartInstance) {
        const labels = chartInstance.data.labels;
        const salesData = chartInstance.data.datasets[0].data;

        const adjustedTrafficByHour = adjustedFootTrafficData.reduce((acc, entry) => {
          acc[entry.hour] = entry.entries;
          return acc;
        }, {});

        const trafficData = labels.map(label => {
          const hour = parseInt(label.split(':')[0]);
          return adjustedTrafficByHour[hour] || 0;
        });

        chartInstance.data.datasets[1].data = trafficData;
        chartInstance.update();
      }
    }

    // Render analytics
    function renderAnalytics(footTrafficData, salesData, selectedDate) {
      // Apply staff reduction if enabled
      const adjustedFootTrafficData = footTrafficData.map(entry => ({
        ...entry,
        entries: staffReductionEnabled ? calculateStaffReduction(entry.entries) : entry.entries
      }));

      // Calculate stats
      const totalSales = Object.values(salesData).reduce((sum, d) => sum + d.sales, 0);
      const totalVisitors = adjustedFootTrafficData.reduce((sum, d) => sum + d.entries, 0);
      const salesPerVisitor = totalVisitors > 0 ? totalSales / totalVisitors : 0;

      // Find peak hour
      const peakEntry = adjustedFootTrafficData.reduce((max, entry) =>
        entry.entries > (max?.entries || 0) ? entry : max
      , null);
      const peakHourTime = peakEntry ? `${peakEntry.hour}:00` : '--';

      // Update stats display
      document.getElementById('totalSales').textContent = `$${totalSales.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
      document.getElementById('totalVisitors').textContent = totalVisitors.toLocaleString();
      document.getElementById('salesPerVisitor').textContent = `$${salesPerVisitor.toFixed(2)}`;
      document.getElementById('peakHour').textContent = peakHourTime;

      // Render chart
      renderChart(adjustedFootTrafficData, salesData, selectedDate);
    }

    // Render line chart
    function renderChart(footTrafficData, salesData, selectedDate) {
      // Determine closing time (9:30pm on Sunday, 10pm otherwise)
      const date = new Date(selectedDate);
      const dayOfWeek = date.getDay();
      const isSunday = dayOfWeek === 0;
      const closingHour = isSunday ? 21.5 : 22; // 9:30pm = 21.5, 10pm = 22

      // Generate hourly labels from 10:30am to closing
      const labels = [];
      const startHour = 10.5; // 10:30am

      for (let h = startHour; h <= closingHour; h += 0.5) {
        const hour = Math.floor(h);
        const minute = h % 1 === 0.5 ? '30' : '00';
        labels.push(`${hour}:${minute}`);
      }

      // Map foot traffic to labels
      const footTrafficByHour = footTrafficData.reduce((acc, entry) => {
        acc[entry.hour] = entry.entries;
        return acc;
      }, {});

      const trafficData = labels.map(label => {
        const hour = parseInt(label.split(':')[0]);
        return footTrafficByHour[hour] || 0;
      });

      // Map sales to labels
      const salesDataMapped = labels.map(label => {
        const hour = parseInt(label.split(':')[0]);
        return salesData[hour]?.sales || 0;
      });

      // Destroy previous chart
      if (chartInstance) {
        chartInstance.destroy();
      }

      // Create chart
      const ctx = document.getElementById('analyticsChart').getContext('2d');

      chartInstance = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Sales ($)',
              data: salesDataMapped,
              borderColor: '#00A8E1',
              backgroundColor: 'rgba(0, 168, 225, 0.1)',
              borderWidth: 3,
              tension: 0.4,
              yAxisID: 'y-sales',
              pointRadius: 4,
              pointHoverRadius: 6
            },
            {
              label: 'Foot Traffic',
              data: trafficData,
              borderColor: '#20B2AA',
              backgroundColor: 'rgba(32, 178, 170, 0.1)',
              borderWidth: 3,
              tension: 0.4,
              yAxisID: 'y-traffic',
              pointRadius: 4,
              pointHoverRadius: 6
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          aspectRatio: 2.5,
          interaction: {
            mode: 'index',
            intersect: false
          },
          plugins: {
            legend: {
              display: true,
              position: 'top',
              labels: {
                font: {
                  size: 13,
                  weight: '700'
                },
                padding: 15,
                usePointStyle: true
              }
            },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.9)',
              titleFont: {
                size: 13,
                weight: '700'
              },
              bodyFont: {
                size: 12
              },
              padding: 12,
              displayColors: true,
              callbacks: {
                label: function(context) {
                  let label = context.dataset.label || '';
                  if (label) {
                    label += ': ';
                  }
                  if (context.dataset.yAxisID === 'y-sales') {
                    label += '$' + context.parsed.y.toFixed(2);
                  } else {
                    label += context.parsed.y + ' visitors';
                  }
                  return label;
                }
              }
            }
          },
          scales: {
            x: {
              grid: {
                display: true,
                color: 'rgba(0, 0, 0, 0.05)'
              },
              ticks: {
                font: {
                  size: 11,
                  weight: '600'
                }
              }
            },
            'y-sales': {
              type: 'linear',
              position: 'left',
              title: {
                display: true,
                text: 'SALES ($)',
                font: {
                  size: 12,
                  weight: '700'
                },
                color: '#00A8E1'
              },
              ticks: {
                callback: function(value) {
                  return '$' + value.toFixed(0);
                },
                font: {
                  size: 11,
                  weight: '600'
                },
                color: '#00A8E1'
              },
              grid: {
                display: true,
                color: 'rgba(0, 168, 225, 0.1)'
              }
            },
            'y-traffic': {
              type: 'linear',
              position: 'right',
              title: {
                display: true,
                text: 'FOOT TRAFFIC',
                font: {
                  size: 12,
                  weight: '700'
                },
                color: '#20B2AA'
              },
              ticks: {
                font: {
                  size: 11,
                  weight: '600'
                },
                color: '#20B2AA'
              },
              grid: {
                display: false
              }
            }
          }
        }
      });
    }

    // Auto-load on page load
    window.addEventListener('DOMContentLoaded', function() {
      loadAnalytics();
    });
  </script>

  <!-- App Header System -->
  <script src="app-header.js"></script>
</body>
</html>
