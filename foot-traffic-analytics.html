<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, viewport-fit=cover">
  <title>Foot Traffic Analytics | Jayna Gyro</title>

  <link rel="apple-touch-icon" href="https://static.spotapps.co/website_images/ab_websites/229800_website_v1/logo.png">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#00A8E1">

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.js"></script>

  <style>
    /* Jayna Brand Design - Standardized Colors */
    :root {
      --primary-blue: #00A8E1;
      --secondary-blue: #0094D6;
      --light-blue: #E3F4FC;
      --accent-blue: #0081C6;
      --gray-900: #212121;
      --gray-700: #424242;
      --gray-600: #616161;
      --gray-500: #757575;
      --gray-400: #BDBDBD;
      --gray-300: #E0E0E0;
      --gray-100: #F5F5F5;
      --success: #00C853;
      --warning: #FFB300;
      --error: #D32F2F;
      --white: #FFFFFF;

      --jayna-blue: #00A8E1;
      --turquoise: #20B2AA;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    html, body {
      font-family: 'Aptos', 'Segoe UI Variable', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      background: var(--white);
      min-height: 100vh;
      padding: 0;
      overflow-x: hidden;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: var(--white);
      padding: 0;
    }

    .header {
      background: var(--white);
      color: var(--gray-900);
      text-align: center;
      padding: 12px;
      border-radius: 0;
      border-bottom: 1px solid var(--gray-300);
    }

    .header h1 {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 2px;
      letter-spacing: 1.5px;
      text-transform: uppercase;
    }

    .header p {
      opacity: 0.7;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .logo {
      max-width: 576px;
      width: 100%;
      height: auto;
      display: block;
      margin: 0 auto;
    }

    .content {
      padding: 20px;
    }

    .controls {
      background: var(--white);
      border: 2px solid var(--gray-300);
      padding: 20px;
      margin-bottom: 20px;
      display: flex;
      gap: 20px;
      align-items: center;
      flex-wrap: wrap;
    }

    .control-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .control-group label {
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--gray-700);
    }

    .control-group input[type="date"] {
      padding: 12px;
      border: 2px solid var(--gray-300);
      font-size: 14px;
      font-weight: 600;
      min-width: 200px;
    }

    .control-group input[type="date"]:focus {
      outline: none;
      border-color: var(--jayna-blue);
    }

    .toggle-container {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .toggle-switch {
      position: relative;
      width: 60px;
      height: 30px;
      background: var(--gray-300);
      border-radius: 15px;
      cursor: pointer;
      transition: background 0.3s;
    }

    .toggle-switch.active {
      background: var(--jayna-blue);
    }

    .toggle-switch::after {
      content: '';
      position: absolute;
      top: 3px;
      left: 3px;
      width: 24px;
      height: 24px;
      background: var(--white);
      border-radius: 50%;
      transition: transform 0.3s;
    }

    .toggle-switch.active::after {
      transform: translateX(30px);
    }

    .disclaimer {
      font-size: 10px;
      color: var(--gray-500);
      font-style: italic;
      max-width: 300px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: var(--white);
      border: 2px solid var(--gray-300);
      padding: 16px;
    }

    .stat-card h3 {
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--gray-600);
      margin-bottom: 8px;
    }

    .stat-card .value {
      font-size: 32px;
      font-weight: 900;
      color: var(--gray-900);
      margin-bottom: 4px;
    }

    .stat-card .subtitle {
      font-size: 11px;
      color: var(--gray-500);
    }

    .chart-container {
      background: var(--white);
      border: 2px solid var(--gray-300);
      padding: 20px;
      margin-bottom: 20px;
    }

    .chart-container h2 {
      font-size: 16px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 20px;
      color: var(--gray-900);
    }

    #loadingOverlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.9);
      z-index: 99999;
      align-items: center;
      justify-content: center;
      flex-direction: column;
    }

    #loadingOverlay.active {
      display: flex;
    }

    @keyframes pulse {
      0%, 100% {
        opacity: 0.6;
        transform: scale(0.95);
      }
      50% {
        opacity: 1;
        transform: scale(1.05);
      }
    }

    @keyframes pulseRing {
      0% {
        transform: translate(-50%, -50%) scale(0.8);
        opacity: 1;
      }
      100% {
        transform: translate(-50%, -50%) scale(1.4);
        opacity: 0;
      }
    }

    @keyframes logoFloat {
      0%, 100% {
        transform: translate(-50%, -50%) scale(1) rotate(0deg);
      }
      50% {
        transform: translate(-50%, -50%) scale(1.1) rotate(5deg);
      }
    }

    @keyframes logoGlow {
      0%, 100% {
        filter: drop-shadow(0 0 20px rgba(0, 123, 255, 0.8)) brightness(1);
      }
      50% {
        filter: drop-shadow(0 0 40px rgba(0, 200, 255, 1)) brightness(1.2);
      }
    }

  </style>
</head>
<body>
  <!-- Loading Overlay with Animated Logo -->
  <div id="loadingOverlay">
    <div style="text-align: center;">
      <!-- Logo Container with Pulse + Glow Effect -->
      <div style="position: relative; width: 150px; height: 150px; margin: 0 auto;">
        <!-- Animated glowing rings -->
        <div style="
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          width: 150px;
          height: 150px;
          border-radius: 50%;
          border: 3px solid rgba(0, 123, 255, 0.6);
          animation: pulseRing 2s ease-out infinite;
        "></div>

        <div style="
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          width: 150px;
          height: 150px;
          border-radius: 50%;
          border: 3px solid rgba(0, 123, 255, 0.4);
          animation: pulseRing 2s ease-out infinite 0.5s;
        "></div>

        <!-- Main logo with pulse + rotation -->
        <img src="jayna-logo-loading.png" alt="Jayna Logo" style="
          width: 120px;
          height: 120px;
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          animation: logoFloat 3s ease-in-out infinite, logoGlow 2s ease-in-out infinite;
          filter: drop-shadow(0 0 20px rgba(0, 123, 255, 0.8));
          border-radius: 50%;
        ">
      </div>
    </div>
  </div>

  <div class="container">
    <div class="header" style="padding-top: 20px;">
      <img src="jayna-logo-new.png" alt="Jayna Gyro Logo" class="logo" style="max-width: 576px; width: 100%; height: auto; display: block; margin: 0 auto;">
      <h1>JAYNA GYRO</h1>
      <p style="opacity: 0.7;">FOR AUTHORIZED USE ONLY</p>

      <!-- CURRENTLY CLOCKED IN -->
      <div id="clockedInContainer" style="margin: 8px 0; text-align: center;">
        <div id="clockedInList" style="color: #2e7d32; font-size: 12px; font-weight: 500;">
          Loading...
        </div>

        <!-- COMBINED TIPS/HR & LEADER DISPLAY (JAYNA BLUE GRADIENT) -->
        <div id="tipsPerHourCard" style="margin-top: 12px; padding: 8px 12px; background: linear-gradient(135deg, #00A8E1 0%, #0094D6 100%); border: 2px solid #00A8E1; border-radius: 0; position: relative; box-shadow: 0 3px 5px rgba(0,0,0,0.1); transition: all 0.3s ease; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; align-items: center;">

          <!-- LIVE Badge -->
          <div style="position: absolute; top: -6px; right: 8px; background: #dc2626; color: white; padding: 2px 6px; font-size: 8px; font-weight: 700; letter-spacing: 0.6px; display: flex; align-items: center; gap: 3px; z-index: 10;">
            <span style="display: inline-block; width: 5px; height: 5px; background: #fff; border-radius: 50%; animation: pulse 1.5s ease-in-out infinite;"></span>
            LIVE
          </div>

          <!-- LEFT COLUMN: TIPS PER HOUR -->
          <div style="text-align: left;">
            <div style="font-size: 8px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.6px; color: rgba(255,255,255,0.85); margin-bottom: 3px;">
              üíµ TIPS/HR
            </div>
            <div id="tipsPerHourText" style="font-size: 17px; font-weight: 900; color: #fff; line-height: 1; margin-bottom: 2px;">
              Loading...
            </div>
            <div style="font-size: 7px; color: rgba(255,255,255,0.6); font-style: italic;">
              Does not include Cash Tips.
            </div>
          </div>

          <!-- CENTER COLUMN: FOOT TRAFFIC (CLICKABLE) -->
          <div onclick="window.location.href='foot-traffic-analytics.html'" style="text-align: center; padding: 4px; border-left: 1px solid rgba(255,255,255,0.3); border-right: 1px solid rgba(255,255,255,0.3); cursor: pointer; transition: all 0.15s ease;">
            <div style="font-size: 8px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.6px; color: rgba(255,255,255,0.85); margin-bottom: 3px;">
              üö∂ FOOT TRAFFIC
            </div>
            <div id="footTrafficLatestHour" style="font-size: 13px; font-weight: 700; color: #fff; margin-bottom: 2px;">
              --
            </div>
            <div style="font-size: 7px; color: rgba(255,255,255,0.6); margin-bottom: 3px;">
              Latest Hour
            </div>
            <div id="footTrafficDailyTotal" style="font-size: 15px; font-weight: 900; color: #fff;">
              --
            </div>
            <div style="font-size: 7px; color: rgba(255,255,255,0.6); font-style: italic;">
              Click for Analytics ‚Üí
            </div>
          </div>

          <!-- RIGHT COLUMN: TODAY'S LEADER (CLICKABLE) -->
          <div id="topLeaderDisplay" onclick="window.location.href='teamupdates.html'" style="text-align: right; cursor: pointer; transition: all 0.15s ease; padding: 4px; border-left: 1px solid rgba(255,255,255,0.3);">
            <div style="font-size: 8px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.6px; color: rgba(255,255,255,0.85); margin-bottom: 3px;">
              üèÜ TODAY'S LEADER
            </div>
            <div id="topLeaderText" style="font-size: 13px; font-weight: 700; color: #fff;">
              Loading...
            </div>
            <div style="font-size: 7px; color: rgba(255,255,255,0.6); margin-top: 2px; font-style: italic;">
              Click for Team Updates ‚Üí
            </div>
          </div>
        </div>

        <style>
          @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
          }
          #topLeaderDisplay:hover {
            background: rgba(255,255,255,0.1);
          }
        </style>
      </div>

      <!-- VOID & DISCOUNT TRACKING DISPLAY -->
      <div id="voidDiscountDisplay" style="margin-top: 12px; padding: 8px 12px; background: var(--gray-100); border: 2px solid var(--gray-300); text-align: center; font-size: 10px; font-weight: 600; color: var(--gray-700); letter-spacing: 0.5px;">
        Loading today's data...
      </div>

      <!-- MAIN MENU NAVIGATION -->
      <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-top: 20px; margin-bottom: 20px;">
        <a href="cash.html" class="menu-btn primary" style="text-decoration: none; display: block; padding: 14px; background: var(--gray-900); color: white; border: 2px solid var(--gray-900); text-align: center; font-size: 13px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; cursor: pointer; transition: all 0.15s ease;">CASH</a>
        <a href="orders-prep.html" class="menu-btn" style="text-decoration: none; display: block; padding: 14px; background: var(--gray-700); color: white; border: 2px solid var(--gray-700); text-align: center; font-size: 13px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; cursor: pointer; transition: all 0.15s ease;">ORDERS & PREP</a>
        <a href="dry-goods.html" class="menu-btn primary" style="text-decoration: none; display: block; padding: 14px; background: var(--gray-900); color: white; border: 2px solid var(--gray-900); text-align: center; font-size: 13px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; cursor: pointer; transition: all 0.15s ease;">DRY GOODS</a>
        <a href="foh-checklists.html" class="menu-btn" style="text-decoration: none; display: block; padding: 14px; background: var(--gray-700); color: white; border: 2px solid var(--gray-700); text-align: center; font-size: 13px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; cursor: pointer; transition: all 0.15s ease;">FOH</a>
        <a href="boh.html" class="menu-btn primary" style="text-decoration: none; display: block; padding: 14px; background: var(--gray-900); color: white; border: 2px solid var(--gray-900); text-align: center; font-size: 13px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; cursor: pointer; transition: all 0.15s ease;">BOH</a>
        <a href="catering.html" class="menu-btn" style="text-decoration: none; display: block; padding: 14px; background: var(--gray-700); color: white; border: 2px solid var(--gray-700); text-align: center; font-size: 13px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; cursor: pointer; transition: all 0.15s ease;">CATERING</a>
        <a href="drivers.html" class="menu-btn primary" style="text-decoration: none; display: block; padding: 14px; background: var(--gray-900); color: white; border: 2px solid var(--gray-900); text-align: center; font-size: 13px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; cursor: pointer; transition: all 0.15s ease;">DRIVERS</a>
        <a href="tip-pool.html" class="menu-btn" style="text-decoration: none; display: block; padding: 14px; background: var(--gray-700); color: white; border: 2px solid var(--gray-700); text-align: center; font-size: 13px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; cursor: pointer; transition: all 0.15s ease;">MANAGER</a>
        <a href="teamupdates.html" class="menu-btn primary" style="text-decoration: none; display: block; padding: 14px; background: var(--gray-900); color: white; border: 2px solid var(--gray-900); text-align: center; font-size: 13px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; cursor: pointer; transition: all 0.15s ease;">TEAM UPDATES</a>
        <a href="incidents.html" class="menu-btn" style="text-decoration: none; display: block; padding: 14px; background: var(--gray-700); color: white; border: 2px solid var(--gray-700); text-align: center; font-size: 13px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; cursor: pointer; transition: all 0.15s ease;">INCIDENTS</a>
        <a href="foot-traffic-analytics.html" class="menu-btn primary" style="text-decoration: none; display: block; padding: 14px; background: var(--gray-900); color: white; border: 2px solid var(--gray-900); text-align: center; font-size: 13px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; cursor: pointer; transition: all 0.15s ease;">üö∂ ANALYTICS</a>
      </div>

      <p style="opacity: 0.7; margin-top: 12px;">APP CREATED BY DEMETRI GREGORAKIS</p>
    </div>

    <div class="content">
      <!-- Page Title -->
      <div style="text-align: center; margin-bottom: 24px; margin-top: 20px;">
        <h2 style="font-size: 20px; font-weight: 700; text-transform: uppercase; letter-spacing: 1.5px; color: var(--gray-900); margin-bottom: 4px;">üö∂ FOOT TRAFFIC ANALYTICS</h2>
        <p style="font-size: 12px; color: var(--gray-600); text-transform: uppercase; letter-spacing: 0.5px;">Sales & Visitor Correlation Analysis</p>
      </div>

      <!-- Date Selector & Controls -->
      <div class="controls">
        <div class="control-group">
          <label for="dateSelector">SELECT DATE</label>
          <input type="date" id="dateSelector">
        </div>

        <div class="control-group">
          <label>ADJUST FOR STAFF TRAFFIC</label>
          <div class="toggle-container">
            <div id="staffToggle" class="toggle-switch" onclick="toggleStaffReduction()"></div>
            <span id="staffToggleLabel" style="font-size: 13px; font-weight: 600;">OFF</span>
          </div>
          <div class="disclaimer">
            * Estimates staff reduction based on ~9 employees walking past camera during business hours. Not 100% accurate.
          </div>
        </div>
      </div>

      <!-- Stats Summary -->
      <div class="stats-grid">
        <div class="stat-card">
          <h3>üìä Total Sales</h3>
          <div class="value" id="totalSales">--</div>
          <div class="subtitle">For Selected Date</div>
        </div>

        <div class="stat-card">
          <h3>üö∂ Total Visitors</h3>
          <div class="value" id="totalVisitors">--</div>
          <div class="subtitle" id="visitorSubtitle">Raw Count</div>
        </div>

        <div class="stat-card">
          <h3>üí∞ Sales Per Visitor</h3>
          <div class="value" id="salesPerVisitor">--</div>
          <div class="subtitle">Conversion Metric</div>
        </div>

        <div class="stat-card">
          <h3>‚è∞ Peak Hour</h3>
          <div class="value" id="peakHour">--</div>
          <div class="subtitle">Highest Traffic</div>
        </div>
      </div>

      <!-- Line Chart -->
      <div class="chart-container">
        <h2>üìà Hourly Sales vs Foot Traffic</h2>
        <canvas id="analyticsChart"></canvas>
      </div>

    </div> <!-- /content -->
  </div> <!-- /container -->

  <script>
    // Initialize Supabase clients
    const supabase = window.supabase.createClient(
      'https://zjgzrfzmmjfljjlxznln.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpqZ3pyZnptbWpmbGpqbHh6bmxuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mjc4ODQ2NDEsImV4cCI6MjA0MzQ2MDY0MX0.K40HoaXA3KXGZhyTQj65fCCFcRJ8WIWQGubRhYwZB3k'
    );

    const footTrafficSupabase = window.supabase.createClient(
      'https://gaawtbqpnnbbnsyswqwv.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdhYXd0YnFwbm5iYm5zeXN3cXd2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1MDE1NTAsImV4cCI6MjA3MjA3NzU1MH0.F-y7AIQTWaUe7DRT4OnIZVn94mhXxfhpBbng2aJ8nXg'
    );

    let chartInstance = null;
    let staffReductionEnabled = false;
    let rawFootTrafficData = [];

    // Initialize date selector to today
    function getTodayPacific() {
      const today = new Date();
      const pacificDate = new Date(today.toLocaleString('en-US', { timeZone: 'America/Los_Angeles' }));
      const year = pacificDate.getFullYear();
      const month = String(pacificDate.getMonth() + 1).padStart(2, '0');
      const day = String(pacificDate.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    document.getElementById('dateSelector').value = getTodayPacific();

    // Date change handler
    document.getElementById('dateSelector').addEventListener('change', function() {
      loadAnalytics();
    });

    // Toggle staff reduction
    function toggleStaffReduction() {
      staffReductionEnabled = !staffReductionEnabled;
      const toggle = document.getElementById('staffToggle');
      const label = document.getElementById('staffToggleLabel');

      if (staffReductionEnabled) {
        toggle.classList.add('active');
        label.textContent = 'ON';
        label.style.color = 'var(--jayna-blue)';
      } else {
        toggle.classList.remove('active');
        label.textContent = 'OFF';
        label.style.color = '';
      }

      // Update subtitle
      const subtitle = document.getElementById('visitorSubtitle');
      subtitle.textContent = staffReductionEnabled ? 'Adjusted for Staff' : 'Raw Count';

      // Re-render with adjusted data
      updateStatsAndChart();
    }

    // Show/hide loading
    function showLoading() {
      document.getElementById('loadingOverlay').classList.add('active');
    }

    function hideLoading() {
      document.getElementById('loadingOverlay').classList.remove('active');
    }

    // Main analytics loader
    async function loadAnalytics() {
      showLoading();

      const selectedDate = document.getElementById('dateSelector').value;

      try {
        // Fetch both datasets in parallel
        const [footTrafficData, salesData] = await Promise.all([
          fetchFootTrafficData(selectedDate),
          fetchSalesData(selectedDate)
        ]);

        rawFootTrafficData = footTrafficData;

        // Render
        renderAnalytics(footTrafficData, salesData, selectedDate);

      } catch (error) {
        console.error('Error loading analytics:', error);
        alert('Failed to load analytics: ' + error.message);
      } finally {
        hideLoading();
      }
    }

    // Fetch foot traffic data from Supabase
    async function fetchFootTrafficData(date) {
      const { data, error } = await footTrafficSupabase
        .from('foot_traffic')
        .select('hour, entries')
        .eq('date', date)
        .order('hour', { ascending: true });

      if (error) {
        console.error('Error fetching foot traffic:', error);
        return [];
      }

      return data || [];
    }

    // Fetch sales data from Toast API
    async function fetchSalesData(date) {
      // STEP 1: Authenticate
      const authResponse = await fetch('/api/toast-auth', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      });

      if (!authResponse.ok) {
        throw new Error('Toast authentication failed');
      }

      const authData = await authResponse.json();
      if (!authData.success || !authData.data?.accessToken) {
        throw new Error('Invalid authentication response');
      }

      const accessToken = authData.data.accessToken;

      // STEP 2: Fetch orders for the selected date
      const businessDate = date.replace(/-/g, ''); // YYYYMMDD format

      // Use toast-orders-flexible which handles pagination automatically
      // Copy EXACT pattern from manager.html
      const queryParams = new URLSearchParams({
        accessToken: accessToken,
        startDate: businessDate,
        endDate: businessDate
      });

      const ordersUrl = `/api/toast-orders-flexible?${queryParams.toString()}`;
      console.log('üçû Fetching orders from:', ordersUrl.replace(/accessToken=[^&]*/, 'accessToken=***'));
      console.log('üìÖ Business date:', businessDate);

      const ordersResponse = await fetch(ordersUrl, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json'
        }
      });

      if (!ordersResponse.ok) {
        // Get the actual error message from backend
        const errorData = await ordersResponse.json().catch(() => ({ error: 'Unknown error' }));
        console.error('Toast orders API error:', ordersResponse.status, errorData);
        throw new Error(`Toast API error ${ordersResponse.status}: ${errorData.error || 'Unknown error'}`);
      }

      const ordersResult = await ordersResponse.json();

      if (!ordersResult.success || !ordersResult.data) {
        console.error('Invalid Toast API response:', ordersResult);
        throw new Error(`Invalid response: ${ordersResult.error || 'No data returned'}`);
      }

      const allOrders = ordersResult.data;

      // STEP 3: Group orders by hour and calculate sales
      const hourlyData = {};

      allOrders.forEach(order => {
        // Skip voided/deleted orders
        if (order.voided || order.deleted) return;

        // Use closedDate to determine hour
        if (!order.closedDate) return;

        const closedDate = new Date(order.closedDate);
        const hour = closedDate.getHours();

        if (!hourlyData[hour]) {
          hourlyData[hour] = { sales: 0, orders: 0 };
        }

        // Calculate order total from checks
        if (order.checks && Array.isArray(order.checks)) {
          order.checks.forEach(check => {
            if (!check.voided && !check.deleted) {
              hourlyData[hour].sales += check.amount || 0;
              hourlyData[hour].orders++;
            }
          });
        }
      });

      return hourlyData;
    }

    // Calculate staff reduction
    function calculateStaffReduction(rawCount) {
      // 9 staff members, each passing camera ~4-6 times during their shift
      // Spread across 11.5 hours (10:30am - 10pm)
      // Estimate: 9 staff * 5 passes = 45 total staff entries per day
      // Distributed across hours: ~4 per hour average

      const STAFF_REDUCTION_PER_HOUR = 4;
      return Math.max(0, rawCount - STAFF_REDUCTION_PER_HOUR);
    }

    // Update stats and chart
    function updateStatsAndChart() {
      const selectedDate = document.getElementById('dateSelector').value;
      const footTrafficData = rawFootTrafficData;

      // Apply staff reduction if enabled
      const adjustedFootTrafficData = footTrafficData.map(entry => ({
        ...entry,
        entries: staffReductionEnabled ? calculateStaffReduction(entry.entries) : entry.entries
      }));

      // Re-render stats (sales data stays the same)
      const totalVisitors = adjustedFootTrafficData.reduce((sum, d) => sum + d.entries, 0);
      document.getElementById('totalVisitors').textContent = totalVisitors.toLocaleString();

      // Update chart
      if (chartInstance) {
        const labels = chartInstance.data.labels;
        const salesData = chartInstance.data.datasets[0].data;

        const adjustedTrafficByHour = adjustedFootTrafficData.reduce((acc, entry) => {
          acc[entry.hour] = entry.entries;
          return acc;
        }, {});

        const trafficData = labels.map(label => {
          const hour = parseInt(label.split(':')[0]);
          return adjustedTrafficByHour[hour] || 0;
        });

        chartInstance.data.datasets[1].data = trafficData;
        chartInstance.update();
      }
    }

    // Render analytics
    function renderAnalytics(footTrafficData, salesData, selectedDate) {
      // Apply staff reduction if enabled
      const adjustedFootTrafficData = footTrafficData.map(entry => ({
        ...entry,
        entries: staffReductionEnabled ? calculateStaffReduction(entry.entries) : entry.entries
      }));

      // Calculate stats
      const totalSales = Object.values(salesData).reduce((sum, d) => sum + d.sales, 0);
      const totalVisitors = adjustedFootTrafficData.reduce((sum, d) => sum + d.entries, 0);
      const salesPerVisitor = totalVisitors > 0 ? totalSales / totalVisitors : 0;

      // Find peak hour
      const peakEntry = adjustedFootTrafficData.reduce((max, entry) =>
        entry.entries > (max?.entries || 0) ? entry : max
      , null);
      const peakHourTime = peakEntry ? `${peakEntry.hour}:00` : '--';

      // Update stats display
      document.getElementById('totalSales').textContent = `$${totalSales.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
      document.getElementById('totalVisitors').textContent = totalVisitors.toLocaleString();
      document.getElementById('salesPerVisitor').textContent = `$${salesPerVisitor.toFixed(2)}`;
      document.getElementById('peakHour').textContent = peakHourTime;

      // Render chart
      renderChart(adjustedFootTrafficData, salesData, selectedDate);
    }

    // Render line chart
    function renderChart(footTrafficData, salesData, selectedDate) {
      // Determine closing time (9:30pm on Sunday, 10pm otherwise)
      const date = new Date(selectedDate);
      const dayOfWeek = date.getDay();
      const isSunday = dayOfWeek === 0;
      const closingHour = isSunday ? 21.5 : 22; // 9:30pm = 21.5, 10pm = 22

      // Generate hourly labels from 10:30am to closing
      const labels = [];
      const startHour = 10.5; // 10:30am

      for (let h = startHour; h <= closingHour; h += 0.5) {
        const hour = Math.floor(h);
        const minute = h % 1 === 0.5 ? '30' : '00';
        labels.push(`${hour}:${minute}`);
      }

      // Map foot traffic to labels
      const footTrafficByHour = footTrafficData.reduce((acc, entry) => {
        acc[entry.hour] = entry.entries;
        return acc;
      }, {});

      const trafficData = labels.map(label => {
        const hour = parseInt(label.split(':')[0]);
        return footTrafficByHour[hour] || 0;
      });

      // Map sales to labels
      const salesDataMapped = labels.map(label => {
        const hour = parseInt(label.split(':')[0]);
        return salesData[hour]?.sales || 0;
      });

      // Destroy previous chart
      if (chartInstance) {
        chartInstance.destroy();
      }

      // Create chart
      const ctx = document.getElementById('analyticsChart').getContext('2d');

      chartInstance = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Sales ($)',
              data: salesDataMapped,
              borderColor: '#00A8E1',
              backgroundColor: 'rgba(0, 168, 225, 0.1)',
              borderWidth: 3,
              tension: 0.4,
              yAxisID: 'y-sales',
              pointRadius: 4,
              pointHoverRadius: 6
            },
            {
              label: 'Foot Traffic',
              data: trafficData,
              borderColor: '#20B2AA',
              backgroundColor: 'rgba(32, 178, 170, 0.1)',
              borderWidth: 3,
              tension: 0.4,
              yAxisID: 'y-traffic',
              pointRadius: 4,
              pointHoverRadius: 6
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          aspectRatio: 2.5,
          interaction: {
            mode: 'index',
            intersect: false
          },
          plugins: {
            legend: {
              display: true,
              position: 'top',
              labels: {
                font: {
                  size: 13,
                  weight: '700'
                },
                padding: 15,
                usePointStyle: true
              }
            },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.9)',
              titleFont: {
                size: 13,
                weight: '700'
              },
              bodyFont: {
                size: 12
              },
              padding: 12,
              displayColors: true,
              callbacks: {
                label: function(context) {
                  let label = context.dataset.label || '';
                  if (label) {
                    label += ': ';
                  }
                  if (context.dataset.yAxisID === 'y-sales') {
                    label += '$' + context.parsed.y.toFixed(2);
                  } else {
                    label += context.parsed.y + ' visitors';
                  }
                  return label;
                }
              }
            }
          },
          scales: {
            x: {
              grid: {
                display: true,
                color: 'rgba(0, 0, 0, 0.05)'
              },
              ticks: {
                font: {
                  size: 11,
                  weight: '600'
                }
              }
            },
            'y-sales': {
              type: 'linear',
              position: 'left',
              title: {
                display: true,
                text: 'SALES ($)',
                font: {
                  size: 12,
                  weight: '700'
                },
                color: '#00A8E1'
              },
              ticks: {
                callback: function(value) {
                  return '$' + value.toFixed(0);
                },
                font: {
                  size: 11,
                  weight: '600'
                },
                color: '#00A8E1'
              },
              grid: {
                display: true,
                color: 'rgba(0, 168, 225, 0.1)'
              }
            },
            'y-traffic': {
              type: 'linear',
              position: 'right',
              title: {
                display: true,
                text: 'FOOT TRAFFIC',
                font: {
                  size: 12,
                  weight: '700'
                },
                color: '#20B2AA'
              },
              ticks: {
                font: {
                  size: 11,
                  weight: '600'
                },
                color: '#20B2AA'
              },
              grid: {
                display: false
              }
            }
          }
        }
      });
    }

    // Auto-load on page load
    window.addEventListener('DOMContentLoaded', function() {
      loadAnalytics();
      // Initialize header live stats
      initializeHeaderStats();
    });

    // ============================================
    // HEADER LIVE STATS (from app-header.js)
    // ============================================

    function initializeHeaderStats() {
      console.log('üîÑ Initializing header live stats...');
      fetchClockedInEmployees();
      fetchTipsPerHour();
      fetchTopLeader();
      fetchVoidDiscountTracking();
      fetchHeaderFootTraffic();

      // Refresh intervals
      setInterval(fetchClockedInEmployees, 5 * 60 * 1000); // Every 5 minutes
      setInterval(fetchTipsPerHour, 30 * 1000); // Every 30 seconds
      setInterval(fetchTopLeader, 2 * 60 * 1000); // Every 2 minutes
      setInterval(fetchVoidDiscountTracking, 5 * 60 * 1000); // Every 5 minutes
      setInterval(fetchHeaderFootTraffic, 30 * 1000); // Every 30 seconds
    }

    // Clocked In Employees
    async function fetchClockedInEmployees() {
      try {
        const todayPacific = new Date().toLocaleString('en-US', {
          timeZone: 'America/Los_Angeles',
          year: 'numeric',
          month: '2-digit',
          day: '2-digit'
        });
        const [month, day, year] = todayPacific.split(', ')[0].split('/');
        const today = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;

        const authResponse = await fetch('/api/toast-auth', { method: 'POST', headers: { 'Content-Type': 'application/json' } });
        if (!authResponse.ok) { updateClockedInDisplay([]); return; }

        const authData = await authResponse.json();
        if (!authData.success || !authData.data?.accessToken) { updateClockedInDisplay([]); return; }

        const token = authData.data.accessToken;
        const response = await fetch(`/api/toast-clocked-in?date=${today}&token=${encodeURIComponent(token)}`);
        if (!response.ok) { updateClockedInDisplay([]); return; }

        const result = await response.json();
        if (!result.success) { updateClockedInDisplay([]); return; }

        const employees = result.clockedIn.map(emp => emp.fullName);
        updateClockedInDisplay(employees);
      } catch (error) {
        console.error('Error fetching clocked in:', error);
        updateClockedInDisplay([]);
      }
    }

    function updateClockedInDisplay(employees) {
      const listDiv = document.getElementById('clockedInList');
      if (!listDiv) return;
      if (employees.length === 0) {
        listDiv.innerHTML = '<span style="color: #999; font-size: 11px; font-style: italic;">No one clocked in</span>';
        return;
      }
      const namesText = employees.join(' | ');
      listDiv.innerHTML = `
        <div style="color: #2e7d32; font-size: 12px; font-weight: 500;">${namesText}</div>
        <div style="color: #666; font-size: 9px; margin-top: 3px; text-transform: uppercase; letter-spacing: 0.5px;">Clocked In</div>
      `;
    }

    // Tips Per Hour
    async function fetchTipsPerHour() {
      try {
        const response = await fetch('/api/toast-tips-per-hour-today', { method: 'POST' });
        if (!response.ok) { updateTipsPerHourDisplay(null); return; }
        const result = await response.json();
        if (result.success && result.data) {
          updateTipsPerHourDisplay(result.data);
        } else {
          updateTipsPerHourDisplay(null);
        }
      } catch (error) {
        console.error('Error fetching tips/hr:', error);
        updateTipsPerHourDisplay(null);
      }
    }

    function updateTipsPerHourDisplay(data) {
      const displayDiv = document.getElementById('tipsPerHourText');
      if (!displayDiv) return;
      if (!data) {
        displayDiv.innerHTML = '<div style="font-size: 14px;">-</div>';
        return;
      }
      const arrow = data.trendingUp ? '‚Üë' : '‚Üì';
      displayDiv.innerHTML = `<div style="font-size: 17px; font-weight: 900; color: #fff; line-height: 1;">${arrow} $${data.tipsPerHour.toFixed(2)}/hr</div>`;
    }

    // Top Leader
    async function fetchTopLeader() {
      try {
        const nowPacific = new Date(new Date().toLocaleString('en-US', { timeZone: 'America/Los_Angeles' }));
        const currentHour = nowPacific.getHours();
        const todayStart = new Date(nowPacific);
        if (currentHour < 5) {
          todayStart.setDate(todayStart.getDate() - 1);
          todayStart.setHours(5, 0, 0, 0);
        } else {
          todayStart.setHours(5, 0, 0, 0);
        }
        const todayEnd = new Date(todayStart);
        todayEnd.setDate(todayEnd.getDate() + 1);
        todayEnd.setHours(4, 59, 59, 999);

        const startISO = todayStart.toISOString();
        const endISO = todayEnd.toISOString();

        const { data: tasks } = await supabase.from('foh_checklist_tasks').select('completed_by, completed_at, is_completed').eq('is_completed', true).gte('completed_at', startISO).lte('completed_at', endISO);
        const { data: prepCounts } = await supabase.from('prep_count_log').select('counted_by, counted_at').gte('counted_at', startISO).lte('counted_at', endISO);

        const leaderboard = {};
        if (tasks && tasks.length > 0) {
          tasks.forEach(task => {
            const name = task.completed_by || 'Unknown';
            if (!leaderboard[name]) leaderboard[name] = { name, count: 0, lastActivity: null };
            leaderboard[name].count++;
            const activityTime = new Date(task.completed_at);
            if (!leaderboard[name].lastActivity || activityTime > leaderboard[name].lastActivity) {
              leaderboard[name].lastActivity = activityTime;
            }
          });
        }
        if (prepCounts && prepCounts.length > 0) {
          prepCounts.forEach(prep => {
            const name = prep.counted_by || 'Unknown';
            if (!leaderboard[name]) leaderboard[name] = { name, count: 0, lastActivity: null };
            leaderboard[name].count++;
            const activityTime = new Date(prep.counted_at);
            if (!leaderboard[name].lastActivity || activityTime > leaderboard[name].lastActivity) {
              leaderboard[name].lastActivity = activityTime;
            }
          });
        }

        if (Object.keys(leaderboard).length === 0) { updateTopLeaderDisplay(null); return; }

        const sortedLeaderboard = Object.values(leaderboard).sort((a, b) => {
          if (b.count !== a.count) return b.count - a.count;
          return b.lastActivity - a.lastActivity;
        });

        updateTopLeaderDisplay(sortedLeaderboard[0]);
      } catch (error) {
        console.error('Error fetching leader:', error);
        updateTopLeaderDisplay(null);
      }
    }

    function updateTopLeaderDisplay(leader) {
      const displayDiv = document.getElementById('topLeaderText');
      if (!displayDiv) return;
      if (!leader) {
        displayDiv.textContent = 'No activity yet! üéØ';
        return;
      }
      displayDiv.textContent = `${leader.name} (${leader.count} action${leader.count !== 1 ? 's' : ''}) üî•`;
    }

    // Void & Discount Tracking
    async function fetchVoidDiscountTracking() {
      try {
        const todayPacific = new Date().toLocaleString('en-US', { timeZone: 'America/Los_Angeles', year: 'numeric', month: '2-digit', day: '2-digit' });
        const [month, day, year] = todayPacific.split(', ')[0].split('/');
        const today = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;

        const authResponse = await fetch('/api/toast-auth', { method: 'POST', headers: { 'Content-Type': 'application/json' } });
        if (!authResponse.ok) { updateVoidDiscountDisplay(null); return; }

        const authData = await authResponse.json();
        if (!authData.success || !authData.data?.accessToken) { updateVoidDiscountDisplay(null); return; }

        const token = authData.data.accessToken;
        const response = await fetch(`/api/toast-void-discount-tracking?startDate=${today}&endDate=${today}&token=${encodeURIComponent(token)}`);
        if (!response.ok) { updateVoidDiscountDisplay(null); return; }

        const result = await response.json();
        if (result.success) {
          updateVoidDiscountDisplay(result);
        } else {
          updateVoidDiscountDisplay(null);
        }
      } catch (error) {
        console.error('Error fetching void/discount:', error);
        updateVoidDiscountDisplay(null);
      }
    }

    function updateVoidDiscountDisplay(data) {
      const displayDiv = document.getElementById('voidDiscountDisplay');
      if (!displayDiv) return;
      if (!data) {
        displayDiv.innerHTML = '<span style="color: var(--gray-500); font-style: italic;">Unable to load data</span>';
        return;
      }
      const voidCount = data.voidedOrders?.count || 0;
      const discountCount = data.discounts?.count || 0;
      const refundCount = data.refunds?.count || 0;
      const voidedPaymentCount = data.voidedPayments?.count || 0;
      displayDiv.textContent = `VOIDED ORDERS: ${voidCount} | DISCOUNTS: ${discountCount} | REFUNDS: ${refundCount} | VOIDED PAYMENTS: ${voidedPaymentCount}`;
    }

    // Header Foot Traffic (blue card)
    async function fetchHeaderFootTraffic() {
      try {
        const today = getTodayPacific();
        const { data, error } = await footTrafficSupabase.from('foot_traffic').select('hour, entries').eq('date', today).order('hour', { ascending: false });
        if (error) { updateHeaderFootTrafficDisplay(null, null); return; }

        const dailyTotal = data.reduce((sum, row) => sum + (row.entries || 0), 0);
        const latestHourData = data.length > 0 ? data[0] : null;
        const latestHourCount = latestHourData ? latestHourData.entries : 0;

        updateHeaderFootTrafficDisplay(latestHourCount, dailyTotal);
      } catch (err) {
        console.error('Error fetching header foot traffic:', err);
        updateHeaderFootTrafficDisplay(null, null);
      }
    }

    function updateHeaderFootTrafficDisplay(latestHour, dailyTotal) {
      const latestHourDiv = document.getElementById('footTrafficLatestHour');
      const dailyTotalDiv = document.getElementById('footTrafficDailyTotal');
      if (!latestHourDiv || !dailyTotalDiv) return;

      if (latestHour === null || dailyTotal === null) {
        latestHourDiv.textContent = '--';
        dailyTotalDiv.textContent = '--';
        return;
      }
      latestHourDiv.textContent = latestHour.toLocaleString();
      dailyTotalDiv.textContent = dailyTotal.toLocaleString();
    }
  </script>
</body>
</html>
