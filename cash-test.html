<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, viewport-fit=cover">
  <title>Jayna Gyro Cash Counter - VOICE TEST</title>
  
  <link rel="apple-touch-icon" href="https://static.spotapps.co/website_images/ab_websites/229800_website_v1/logo.png">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#00A8E1">
  
  <style>
    /* Jayna Brand Design - Sky Blue & Grayscale */
    :root {
      --primary-blue: #00A8E1;
      --secondary-blue: #0094D6;
      --light-blue: #E3F4FC;
      --accent-blue: #0081C6;
      --gray-900: #212121;
      --gray-700: #424242;
      --gray-600: #616161;
      --gray-500: #757575;
      --gray-400: #BDBDBD;
      --gray-300: #E0E0E0;
      --gray-100: #F5F5F5;
      --success: #00C853;
      --warning: #FFB300;
      --error: #D32F2F;
      --white: #FFFFFF;
      --blue-bg: #dbeafe;
      --blue-text: #1e40af;
      --success-bg: #d1fae5;
      --success-text: #065f46;
      --success-border: #059669;
      --warning-bg: #fef3c7;
      --warning-text: #92400e;
      --warning-border: #f59e0b;
      --error-bg: #fee2e2;
      --error-text: #991b1b;
      --error-border: #dc2626;
    }

    /* Pen Icon Edit Button */
    .modal-edit-icon {
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s ease;
    }
    .modal-edit-icon:hover {
      background: var(--gray-200);
    }
    .modal-edit-icon svg {
      width: 18px;
      height: 18px;
      fill: var(--gray-700);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body {
      font-family: 'Aptos', 'Segoe UI Variable', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      background: var(--white); /* White background to blend with Google Sites header */
      min-height: 100vh;
      padding: 0;
      overflow-x: hidden;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
      background: var(--white);
      border-radius: 0;
      overflow: visible;
      box-shadow: none; /* Remove shadow for seamless Google Sites embed */
      min-height: auto;
      max-height: none;
    }
    .header {
      background: var(--white);
      color: var(--gray-900);
      text-align: center;
      padding: 12px;
      border-radius: 0;
      border-bottom: 1px solid var(--gray-300);
    }
    .header h1 { font-size: 18px; font-weight: 700; margin-bottom: 2px; letter-spacing: 1.5px; text-transform: uppercase; }
    .header p { opacity: 0.7; font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }
    /* Mobile-First Responsive Design */
    .content {
      padding: 12px;
      /* Google Sites full page embed optimization */
      max-height: none;
      overflow: visible;
    }
    .main-menu { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-bottom: 12px; }
    .secondary-links { display: flex; flex-wrap: wrap; gap: 12px; justify-content: center; margin-bottom: 20px; font-size: 11px; }
    .secondary-links a { color: var(--gray-700); text-decoration: underline; cursor: pointer; transition: color 0.15s ease; }
    .secondary-links a:hover { color: var(--gray-900); }
    .menu-btn {
      padding: 16px 12px !important;
      border: 2px solid var(--gray-700) !important;
      border-radius: 0 !important;
      background: var(--gray-700) !important;
      font-size: 11px !important;
      font-weight: 700 !important;
      color: white !important;
      cursor: pointer !important;
      transition: all 0.15s ease !important;
      text-align: center !important;
      min-height: 50px !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      text-transform: uppercase !important;
      letter-spacing: 1.2px !important;
      text-decoration: none !important;
    }
    .menu-btn:hover {
      background: var(--gray-600) !important;
      border-color: var(--gray-600) !important;
      transform: translateY(-1px);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
    }
    .menu-btn.active {
      border-color: var(--gray-600) !important;
      background: var(--gray-600) !important;
      transform: translateY(-1px);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
    }
    .menu-btn.primary {
      background: var(--gray-100) !important;
      color: var(--gray-900) !important;
      border: 2px solid var(--gray-300) !important;
    }
    .menu-btn.primary:hover {
      background: var(--gray-200) !important;
      border-color: var(--gray-400) !important;
    }
    .form-section { 
      display: none; 
      /* Ensure sections don't get cut off */
      min-height: auto;
      overflow: visible;
    }
    .form-section.active {
      display: block;
      /* Force visibility in Google Sites */
      position: relative;
      z-index: 1;
    }
    .form-group { margin-bottom: 12px; }
    .form-group label {
      display: block;
      margin-bottom: 4px;
      font-weight: 700;
      font-size: 10px;
      color: var(--gray-700);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    /* Enhanced Mobile-Friendly Inputs */
    .form-input, .form-select {
      width: 100%;
      padding: 12px 14px;
      border: 1px solid var(--gray-300);
      border-radius: 0;
      font-size: 14px;
      min-height: 44px;
      box-sizing: border-box;
      -webkit-appearance: none;
      appearance: none;
      transition: all 0.15s ease;
      background: var(--white);
      color: var(--gray-900);
    }
    .form-input:focus, .form-select:focus {
      outline: none;
      border-color: var(--primary-blue);
      box-shadow: 0 0 0 2px rgba(0, 217, 217, 0.15);
      background: var(--white);
    }
    
    /* Number inputs with mobile optimization */
    input[type="number"] {
      -webkit-appearance: none;
      -moz-appearance: textfield;
      appearance: none;
      /* Remove number input arrows */
    }
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    input, select, textarea, button {
      font-size: 16px !important;
    }

    .drawer-section {
      margin: 20px 0;
      border: 2px solid var(--gray-300);
      border-radius: 0;
      overflow: hidden;
    }
    .drawer-header {
      background: var(--light-blue);
      padding: 15px 20px;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 15px;
      color: var(--primary-blue);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .skip-toggle {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 16px;
      color: var(--gray-500);
    }
    .skip-toggle input[type="checkbox"] { width: 20px; height: 20px; }
    .drawer-content { padding: 20px; }
    .denom-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 0;
      border-bottom: 1px solid var(--gray-300);
    }
    .denom-row:last-child { border-bottom: none; }
    .denom-label { font-weight: 500; font-size: 18px; color: var(--gray-700); }
    .denom-value { font-size: 16px; color: var(--gray-500); margin-top: 4px; }

    /* Mobile-Optimized Quantity Inputs */
    .qty-input {
      width: 100px;
      height: 56px;
      text-align: center;
      border: 2px solid var(--gray-300);
      border-radius: 0;
      font-size: 20px;
      font-weight: 500;
      color: var(--gray-700);
      -webkit-appearance: none;
      -moz-appearance: textfield;
      appearance: none;
      transition: all 0.2s ease;
      background: var(--white);
    }
    .qty-input:focus {
      outline: none;
      border-color: var(--primary-blue);
      box-shadow: 0 0 0 3px rgba(44, 95, 141, 0.1);
    }
    /* Remove number arrows */
    .qty-input::-webkit-outer-spin-button,
    .qty-input::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    
    /* Disabled denomination inputs */
    .qty-input:disabled {
      background-color: var(--gray-300);
      color: var(--gray-500);
      border-color: var(--gray-300);
      cursor: not-allowed;
    }

    .denom-row.disabled {
      opacity: 0.5;
    }

    .drawer-total {
      margin-top: 15px;
      padding: 15px;
      background: var(--light-blue);
      border-radius: 0;
      text-align: center;
      font-size: 18px;
      font-weight: 600;
      color: var(--primary-blue);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .grand-total {
      background: linear-gradient(135deg, var(--primary-blue) 0%, var(--secondary-blue) 100%);
      color: var(--white);
      padding: 20px;
      border-radius: 0;
      text-align: center;
      margin: 20px 0;
      box-shadow: 0 4px 12px rgba(44, 95, 141, 0.2);
    }
    .grand-total h3 { font-size: 18px; margin-bottom: 8px; font-weight: 600; opacity: 0.9; text-transform: uppercase; letter-spacing: 0.5px; }
    .grand-total .amount { font-size: 36px; font-weight: 600; }
    .notes-area {
      width: 100%;
      min-height: 100px;
      padding: 18px;
      border: 2px solid var(--gray-300);
      border-radius: 0;
      font-size: 16px;
      resize: vertical;
      box-sizing: border-box;
      transition: all 0.2s ease;
    }
    .notes-area:focus {
      outline: none;
      border-color: var(--primary-blue);
      box-shadow: 0 0 0 3px rgba(44, 95, 141, 0.1);
    }
    .submit-btn {
      padding: 14px 20px;
      background: var(--gray-100);
      color: var(--gray-900);
      border: none;
      border-radius: 0;
      font-size: 12px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.15s ease;
      min-height: 48px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
      text-transform: uppercase;
      letter-spacing: 1.2px;
      border: 2px solid var(--gray-300);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      white-space: nowrap;
    }
    .submit-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.12);
      background: var(--gray-300);
    }
    .submit-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
      background: var(--gray-300);
      color: var(--gray-500);
    }
    .am-total-display {
      background: var(--light-blue);
      padding: 20px;
      border-radius: 0;
      margin: 20px 0;
      border: 2px solid rgba(44, 95, 141, 0.1);
    }
    .am-total-display h4 { margin-bottom: 8px; color: var(--primary-blue); font-size: 16px; font-weight: 500; }
    .am-total-display .amount { font-size: 28px; font-weight: 600; color: var(--primary-blue); }

    /* Enhanced Currency Inputs */
    .currency-input {
      width: 100%;
      padding: 20px;
      border: 2px solid var(--gray-300);
      border-radius: 0;
      font-size: 22px;
      text-align: center;
      min-height: 60px;
      box-sizing: border-box;
      -webkit-appearance: none;
      -moz-appearance: textfield;
      appearance: none;
      transition: all 0.2s ease;
      background: var(--white);
      color: var(--gray-700);
    }
    .currency-input:focus {
      outline: none;
      border-color: var(--primary-blue);
      box-shadow: 0 0 0 3px rgba(44, 95, 141, 0.1);
    }
    .currency-input::-webkit-outer-spin-button,
    .currency-input::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    .confirmation-screen { text-align: center; padding: 40px 20px; }
    .confirmation-screen h2 { color: var(--success); margin-bottom: 30px; font-size: 32px; font-weight: 600; }
    .deposit-instruction {
      background: linear-gradient(135deg, var(--success) 0%, #4A8C63 100%);
      color: var(--white);
      padding: 30px;
      border-radius: 0;
      margin: 25px 0;
      font-size: 24px;
      font-weight: 500;
      box-shadow: 0 4px 12px rgba(95, 167, 119, 0.2);
    }
    .return-instruction {
      background: linear-gradient(135deg, var(--warning) 0%, #C69563 100%);
      color: var(--white);
      padding: 30px;
      border-radius: 0;
      margin: 25px 0;
      font-size: 24px;
      font-weight: 500;
      box-shadow: 0 4px 12px rgba(212, 165, 116, 0.2);
    }
    .thank-you { font-size: 22px; color: var(--success); margin: 30px 0; font-weight: 500; }
    .confirm-btn {
      background: linear-gradient(135deg, var(--success) 0%, #4A8C63 100%);
      margin-top: 30px;
    }
    .loading { text-align: center; padding: 40px; }
    .loading-spinner {
      width: 60px;
      height: 60px;
      border: 6px solid var(--gray-300);
      border-top: 6px solid var(--primary-blue);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .message {
      padding: 18px;
      border-radius: 0;
      margin: 20px 0;
      text-align: center;
      font-size: 15px;
      font-weight: 500;
      letter-spacing: 0.3px;
    }
    .message.success {
      background: #E8F5EC;
      color: #2D5F3F;
      border: 2px solid var(--success);
    }
    .message.error {
      background: #F8E6E7;
      color: #6B3638;
      border: 2px solid var(--error);
    }
    .message.info {
      background: var(--light-blue);
      color: var(--primary-blue);
      border: 2px solid var(--secondary-blue);
    }

    /* Typography - Headers */
    h2, h3, h4, h5, h6 {
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 600;
    }
    h2 { font-size: 22px; }
    h3 { font-size: 19px; }
    h4 { font-size: 16px; }
    h5 { font-size: 14px; }
    h6 { font-size: 12px; }

    /* Tip Pool Calculator Styles */
    .cash-needed { color: var(--error); font-weight: 600; }
    .cash-surplus { color: var(--success); font-weight: 600; }
    .hidden { display: none; }
    .skip-content { padding: 25px; }
    .skip-reason {
      width: 100%;
      padding: 18px;
      border: 2px solid var(--gray-300);
      border-radius: 0;
      font-size: 16px;
      min-height: 56px;
      box-sizing: border-box;
      transition: all 0.2s ease;
    }
    .skip-reason:focus {
      outline: none;
      border-color: var(--primary-blue);
      box-shadow: 0 0 0 3px rgba(44, 95, 141, 0.1);
    }
    
    /* Mobile responsive adjustments */
    @media (max-width: 768px) {
      .container { margin: 0; border-radius: 0; }
      .header { padding: 20px; }
      .header h1 { font-size: 24px; }
      .content { padding: 15px; }
      .main-menu { gap: 12px; }
      .menu-btn { padding: 25px 15px; font-size: 16px; min-height: 70px; }
      .denom-row { flex-direction: column; align-items: flex-start; gap: 12px; padding: 20px 0; }
      .qty-input { width: 120px; margin-top: 8px; }
      .grand-total .amount { font-size: 32px; }
      .confirmation-screen h2 { font-size: 28px; }
      .deposit-instruction, .return-instruction { font-size: 20px; padding: 25px; }
    }
    
    @media (max-width: 768px) {
      .main-menu { grid-template-columns: 1fr 1fr; gap: 12px; }
    }

    @media (max-width: 480px) {
      .header h1 { font-size: 20px; }
      .main-menu { grid-template-columns: 1fr; gap: 10px; }
      .main-menu.show-report { grid-template-columns: 1fr; }
      .menu-btn { padding: 20px 15px; min-height: 60px; }
      .secondary-links { font-size: 10px; gap: 10px; }
      .denom-label { font-size: 16px; }
      .qty-input { width: 100px; height: 50px; font-size: 18px; }
      .grand-total .amount { font-size: 28px; }
      .deposit-instruction, .return-instruction { font-size: 18px; padding: 20px; }
    }
    
    /* Google Sites Full Page Embed Optimizations */
    @media screen {
      html {
        /* Force proper viewport handling in Google Sites */
        height: auto !important;
        min-height: 100% !important;
        overflow-y: auto !important;
      }
      
      body {
        /* Ensure body can scroll properly in Google Sites iframe */
        height: auto !important;
        min-height: 100% !important;
        position: relative !important;
        overflow-y: auto !important;
        padding-top: 10px !important; /* Space for Google Sites white bar */
        padding-bottom: 50px !important; /* Extra space at bottom */
      }
      
      .container {
        /* Ensure container doesn't get viewport-locked */
        position: relative !important;
        height: auto !important;
        min-height: auto !important;
        max-height: none !important;
        overflow: visible !important;
        margin-bottom: 50px !important; /* Extra bottom margin */
      }
      
      .submit-btn {
        /* Ensure submit buttons are always accessible */
        position: relative !important;
        z-index: 10 !important;
        margin-bottom: 30px !important;
      }
      
      /* Force visibility of bottom elements in Google Sites */
      .form-section:last-child,
      .form-section .submit-btn:last-child {
        margin-bottom: 100px !important;
      }
    }
    
    /* Elegant Loading Overlay */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      z-index: 9999;
      display: flex;
      justify-content: center;
      align-items: center;
      transition: opacity 0.3s ease;
    }
    .loading-overlay.hidden {
      display: none;
    }
    .loading-content {
      text-align: center;
      padding: 40px;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 0;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    .loading-spinner-elegant {
      width: 60px;
      height: 60px;
      border: 4px solid rgba(102, 126, 234, 0.1);
      border-top: 4px solid #667eea;
      border-radius: 50%;
      animation: spin-elegant 1.2s linear infinite;
      margin: 0 auto 20px;
    }
    @keyframes spin-elegant {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .loading-content h3 {
      margin: 0 0 10px 0;
      font-size: 24px;
      color: #333;
      font-weight: 600;
    }
    .loading-content p {
      margin: 0;
      font-size: 16px;
      color: #666;
      opacity: 0.8;
    }
    
    /* Success Screens */
    .success-screen {
      text-align: center;
      padding: 40px 20px;
      max-width: 600px;
      margin: 0 auto;
    }
    .success-icon {
      font-size: 80px;
      margin-bottom: 20px;
      animation: success-bounce 0.6s ease;
    }
    @keyframes success-bounce {
      0% { transform: scale(0.3); opacity: 0; }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); opacity: 1; }
    }
    .success-screen h2 {
      color: #28a745;
      margin-bottom: 15px;
      font-size: 32px;
      font-weight: 700;
    }
    .success-message {
      font-size: 18px;
      color: #666;
      margin-bottom: 30px;
      line-height: 1.5;
    }
    .success-details {
      background: #f8f9fa;
      border-radius: 0;
      padding: 25px;
      margin: 25px 0;
      border-left: 4px solid #28a745;
    }
    .detail-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      font-size: 16px;
    }
    .detail-row:not(:last-child) {
      border-bottom: 1px solid #e9ecef;
    }
    .detail-row span:first-child {
      color: #666;
      font-weight: 500;
    }
    .detail-row span:last-child {
      color: #333;
      font-weight: 600;
    }
    .success-btn {
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
      margin-top: 30px;
      font-size: 18px;
      padding: 20px 40px;
      border-radius: 0;
      transition: all 0.3s ease;
    }
    .success-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(40, 167, 69, 0.3);
    }

    /* Animated Loading Dots */
    .loading-dots {
      display: flex;
      gap: 4px;
      align-items: center;
    }
    .loading-dots span {
      font-size: 20px;
      color: #059669;
      animation: pulse-dot 1.4s ease-in-out infinite;
      opacity: 0.3;
    }
    @keyframes pulse-dot {
      0%, 100% {
        opacity: 0.3;
        transform: scale(1);
      }
      50% {
        opacity: 1;
        transform: scale(1.2);
      }
    }
  </style>
  
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
  <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
  <!-- Tip Pool Calculator Dependencies -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

  <!-- OCR Dependencies -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>
    // Configure PDF.js worker
    if (typeof pdfjsLib !== 'undefined') {
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    }
  </script>
</head>
<body>
  <div class="container">
    <!-- App Header (Injected by app-header.js) -->
    <div id="appHeader"></div>

    <!-- VOICE TEST BANNER -->
    <div style="background: #fef3c7; border: 3px solid #f59e0b; padding: 16px; margin: 12px; text-align: center; font-weight: 700; font-size: 14px; color: #92400e; letter-spacing: 1px; text-transform: uppercase;">
      üé§ VOICE RECOGNITION TEST PAGE - DO NOT USE FOR PRODUCTION
    </div>

    <div class="content">
    <div id="messageArea"></div>
    
      <div id="amForm" class="form-section">
        <h2 style="margin-bottom: 20px; color: #1e3c72;">Morning Cash Count</h2>
        
        <div class="form-group">
          <label for="amDate">Date:</label>
          <input type="date" id="amDate" class="form-input" required>
        </div>
        
        <div class="form-group">
          <label for="amCounter">Counted by:</label>
          <select id="amCounter" class="form-select" onchange="toggleDenominationInputs('am')" required>
            <option value="">Choose Name</option>
            <option value="Demetri Gregorakis">Demetri Gregorakis</option>
            <option value="Dilan Uzum">Dilan Uzum</option>
            <option value="Erin Best">Erin Best</option>
            <option value="Katerina Perakis">Katerina Perakis</option>
            <option value="Kayla Mccullough">Kayla Mccullough</option>
          </select>
        </div>
        
        <!-- Drawer 1 -->
        <div class="drawer-section">
          <div class="drawer-header">
            <span>Drawer 1</span>
            <div style="display: flex; gap: 12px; align-items: center;">
              <button onclick="startVoiceInput('am', 1)" style="padding: 8px 16px; background: var(--primary-blue); border: 2px solid var(--primary-blue); color: white; font-size: 12px; font-weight: 700; cursor: pointer; text-transform: uppercase; letter-spacing: 0.5px;">
                üé§ Voice Input
              </button>
              <label class="skip-toggle">
                <input type="checkbox" id="amDrawer1Skip" onchange="toggleSkip('am', 1)">
                Skip Drawer
              </label>
            </div>
          </div>
          <div id="amDrawer1Content" class="drawer-content">
            <div id="amDrawer1Denoms"></div>
            <div class="drawer-total" id="amDrawer1Total">$0.00</div>
          </div>
          <div id="amDrawer1SkipContent" class="skip-content hidden">
            <input type="text" class="skip-reason" id="amDrawer1Reason" placeholder="Reason for skipping drawer 1">
          </div>
        </div>
        
        <!-- Drawer 2 -->
        <div class="drawer-section">
          <div class="drawer-header">
            <span>Drawer 2</span>
            <div style="display: flex; gap: 12px; align-items: center;">
              <button onclick="startVoiceInput('am', 2)" style="padding: 8px 16px; background: var(--primary-blue); border: 2px solid var(--primary-blue); color: white; font-size: 12px; font-weight: 700; cursor: pointer; text-transform: uppercase; letter-spacing: 0.5px;">
                üé§ Voice Input
              </button>
              <label class="skip-toggle">
                <input type="checkbox" id="amDrawer2Skip" onchange="toggleSkip('am', 2)">
                Skip Drawer
              </label>
            </div>
          </div>
          <div id="amDrawer2Content" class="drawer-content">
            <div id="amDrawer2Denoms"></div>
            <div class="drawer-total" id="amDrawer2Total">$0.00</div>
          </div>
          <div id="amDrawer2SkipContent" class="skip-content hidden">
            <input type="text" class="skip-reason" id="amDrawer2Reason" placeholder="Reason for skipping drawer 2">
          </div>
        </div>
        
        <div class="grand-total">
          <h3>Total Cash Count</h3>
          <div class="amount" id="amGrandTotal">$0.00</div>
        </div>
        
        <div class="form-group">
          <label for="amNotes">Notes (Optional):</label>
          <textarea id="amNotes" class="notes-area" placeholder="Any notes for the PM shift..."></textarea>
        </div>
        
        <button class="submit-btn" onclick="submitAM()">Submit AM Count</button>
        <button class="submit-btn" onclick="goHome()" style="margin-top: 10px;">Back to Menu</button>
      </div>
      
      <!-- PM Count Form -->
      <div id="pmForm" class="form-section">
        <h2 style="margin-bottom: 20px; color: #1e3c72;">Evening Cash Close</h2>
        
        <div class="form-group">
          <label for="pmDate">Date:</label>
          <input type="date" id="pmDate" class="form-input" required>
        </div>
        
        <div class="form-group">
          <label for="pmCounter">Counted by:</label>
          <select id="pmCounter" class="form-select" onchange="toggleDenominationInputs('pm')" required>
            <option value="">Choose Name</option>
            <option value="Demetri Gregorakis">Demetri Gregorakis</option>
            <option value="Dilan Uzum">Dilan Uzum</option>
            <option value="Erin Best">Erin Best</option>
            <option value="Katerina Perakis">Katerina Perakis</option>
            <option value="Kayla Mccullough">Kayla Mccullough</option>
          </select>
        </div>
        
        <!-- AM Total Display -->
        <div id="amTotalDisplay" class="am-total-display">
          <h4>Morning Count Information:</h4>
          <div style="display: flex; justify-content: space-between; margin: 10px 0; font-size: 14px;">
            <span><strong>Counted by:</strong> <span id="amCounterName">Loading...</span></span>
            <span><strong>Time:</strong> <span id="amCountTime">Loading...</span></span>
          </div>
          <div style="text-align: center; margin: 15px 0;">
            <strong>Starting Amount:</strong>
            <div class="amount" id="pmAmTotal" style="font-size: 28px; margin: 5px 0;">Loading...</div>
          </div>
          <div id="amNotesDisplay" style="background: #fff3cd; padding: 12px; border-radius: 0; margin-top: 15px; border-left: 4px solid #ffc107; display: none;">
            <strong style="color: #856404;">Morning Notes:</strong>
            <div id="amNotes" style="margin-top: 5px; color: #856404;"></div>
          </div>
        </div>
        
        <!-- Drawer 1 -->
        <div class="drawer-section">
          <div class="drawer-header">
            <span>Drawer 1</span>
            <div style="display: flex; gap: 12px; align-items: center;">
              <button onclick="startVoiceInput('pm', 1)" style="padding: 8px 16px; background: var(--primary-blue); border: 2px solid var(--primary-blue); color: white; font-size: 12px; font-weight: 700; cursor: pointer; text-transform: uppercase; letter-spacing: 0.5px;">
                üé§ Voice Input
              </button>
              <label class="skip-toggle">
                <input type="checkbox" id="pmDrawer1Skip" onchange="toggleSkip('pm', 1)">
                Skip Drawer
              </label>
            </div>
          </div>
          <div id="pmDrawer1Content" class="drawer-content">
            <div id="pmDrawer1Denoms"></div>
            <div class="drawer-total" id="pmDrawer1Total">$0.00</div>
          </div>
          <div id="pmDrawer1SkipContent" class="skip-content hidden">
            <input type="text" class="skip-reason" id="pmDrawer1Reason" placeholder="Reason for skipping drawer 1">
          </div>
        </div>

        <!-- Drawer 2 -->
        <div class="drawer-section">
          <div class="drawer-header">
            <span>Drawer 2</span>
            <div style="display: flex; gap: 12px; align-items: center;">
              <button onclick="startVoiceInput('pm', 2)" style="padding: 8px 16px; background: var(--primary-blue); border: 2px solid var(--primary-blue); color: white; font-size: 12px; font-weight: 700; cursor: pointer; text-transform: uppercase; letter-spacing: 0.5px;">
                üé§ Voice Input
              </button>
              <label class="skip-toggle">
                <input type="checkbox" id="pmDrawer2Skip" onchange="toggleSkip('pm', 2)">
                Skip Drawer
              </label>
            </div>
          </div>
          <div id="pmDrawer2Content" class="drawer-content">
            <div id="pmDrawer2Denoms"></div>
            <div class="drawer-total" id="pmDrawer2Total">$0.00</div>
          </div>
          <div id="pmDrawer2SkipContent" class="skip-content hidden">
            <input type="text" class="skip-reason" id="pmDrawer2Reason" placeholder="Reason for skipping drawer 2">
          </div>
        </div>
        
        <div class="grand-total">
          <h3>Total Cash Count</h3>
          <div class="amount" id="pmGrandTotal">$0.00</div>
        </div>
        
        <div class="form-group">
          <label for="toastSales">Toast Cash Sales (Auto-Calculated):</label>
          
          <!-- Auto-calculated display section -->
          <div style="background: var(--gray-100); border: 2px solid var(--gray-300); border-radius: 0; padding: 12px; margin-bottom: 10px;">
            <div style="text-align: center;">
              <div style="display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 10px;">
                <div style="font-size: 32px; font-weight: bold; color: var(--gray-900);" id="autoToastAmount">Loading...</div>
                <div id="toastLoadingIndicator" style="display: none;">
                  <div class="loading-dots">
                    <span style="animation-delay: 0s;">‚óè</span>
                    <span style="animation-delay: 0.2s;">‚óè</span>
                    <span style="animation-delay: 0.4s;">‚óè</span>
                  </div>
                </div>
              </div>

              <!-- Retry Button -->
              <button id="toastRetryBtn" onclick="fetchToastCashSales()" style="padding: 8px 16px; background: #3b82f6; border: 2px solid #3b82f6; color: white; font-size: 11px; font-weight: 700; cursor: pointer; text-transform: uppercase; letter-spacing: 0.5px; border-radius: 0; transition: all 0.15s ease;" onmouseover="this.style.background='#2563eb'; this.style.borderColor='#2563eb'" onmouseout="this.style.background='#3b82f6'; this.style.borderColor='#3b82f6'">
                RETRY
              </button>
            </div>
          </div>
          
          <!-- Hidden field for form processing -->
          <input type="hidden" id="toastSales" value="0">
        </div>
        
        <!-- Discrepancy Validation Section -->
        <div id="discrepancySection" class="form-group" style="display: none;">
          <label>Cash Count vs Toast Sales Validation:</label>
          <div id="discrepancyDisplay" style="border-radius: 0; padding: 20px; margin-bottom: 10px;">
            <!-- Dynamic content will be inserted here -->
          </div>
        </div>
        
        <div class="form-group">
          <label for="cashTips">Cash Tips (whole number):</label>
          <input type="number" id="cashTips" class="currency-input" placeholder="0" step="1" min="0" inputmode="numeric" pattern="[0-9]*" onfocus="this.select()">
        </div>
        
        <div class="form-group">
          <label for="pmNotes">Notes (Optional):</label>
          <textarea id="pmNotes" class="notes-area" placeholder="Any notes about the day..."></textarea>
        </div>
        
        <button class="submit-btn" onclick="submitPM()">Submit PM Close</button>
        <button class="submit-btn" onclick="goHome()" style="margin-top: 10px;">Back to Menu</button>
      </div>

      <!-- AM Success Screen -->
      <div id="amSuccessScreen" class="form-section">
        <div class="success-screen">
          <div class="success-icon"></div>
          <h2>AM Count Submitted!</h2>
          <p class="success-message">Your morning cash count has been successfully recorded and stored.</p>
          <div class="success-details">
            <div class="detail-row">
              <span>Total Counted:</span>
              <span id="amSuccessTotal">$0.00</span>
            </div>
            <div class="detail-row">
              <span>Time Submitted:</span>
              <span id="amSuccessTime">--</span>
            </div>
          </div>
          <button class="submit-btn success-btn" onclick="goHome()">Return to Menu</button>
        </div>
      </div>

      <!-- PM Success Screen -->
      <div id="pmSuccessScreen" class="form-section">
        <div class="success-screen">
          <div class="success-icon"></div>
          <h2>PM Close Completed!</h2>
          <p class="success-message">Evening close successful! Report sent to management.</p>
          
          <div class="deposit-instruction">
            DEPOSIT <span id="depositAmount">$0</span> INTO ENVELOPE
          </div>
          
          <div class="return-instruction">
            RETURN <span id="returnAmount">$0.00</span> TO CASH BOX AND LOCK IN SAFE
          </div>
          
          <button class="submit-btn success-btn" onclick="goHome()">Confirm and Close</button>
        </div>
      </div>
    </div>
  </div>
<script>
  // ==================== UNIVERSAL MODAL HELPERS ====================
  /**
   * Show inline message (replaces alert())
   * @param {string} message - Message to display
   * @param {string} type - 'success', 'error', 'warning', or 'info'
   */
  function showMessage(message, type = 'info') {
    // Remove existing message if any
    const existing = document.getElementById('inlineMessageOverlay');
    if (existing) existing.remove();

    // Create overlay
    const overlay = document.createElement('div');
    overlay.id = 'inlineMessageOverlay';
    overlay.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100000;
      padding: 20px;
    `;

    // Create message box
    const box = document.createElement('div');
    const colors = {
      success: { bg: 'var(--success-bg)', text: 'var(--success-text)', border: 'var(--success-border)' },
      error: { bg: 'var(--error-bg)', text: 'var(--error-text)', border: 'var(--error-border)' },
      warning: { bg: 'var(--warning-bg)', text: 'var(--warning-text)', border: 'var(--warning-border)' },
      info: { bg: 'var(--blue-bg)', text: 'var(--blue-text)', border: 'var(--blue-text)' }
    };
    const color = colors[type] || colors.info;

    box.style.cssText = `
      background: white;
      padding: 24px;
      max-width: 500px;
      width: 100%;
      border: 3px solid ${color.border};
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    `;

    const messageEl = document.createElement('div');
    messageEl.textContent = message;
    messageEl.style.cssText = `
      font-size: 14px;
      line-height: 1.6;
      color: ${color.text};
      margin-bottom: 20px;
      white-space: pre-line;
    `;

    const closeBtn = document.createElement('button');
    closeBtn.textContent = 'OK';
    closeBtn.style.cssText = `
      width: 100%;
      padding: 12px 24px;
      background: var(--gray-900);
      color: white;
      border: 2px solid var(--gray-900);
      font-size: 13px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      cursor: pointer;
    `;
    closeBtn.onclick = () => overlay.remove();

    box.appendChild(messageEl);
    box.appendChild(closeBtn);
    overlay.appendChild(box);
    document.body.appendChild(overlay);

    // Close on overlay click
    overlay.addEventListener('click', (e) => {
      if (e.target === overlay) overlay.remove();
    });
  }

  /**
   * Show confirmation dialog (replaces confirm())
   * @param {string} message - Confirmation message
   * @param {function} onConfirm - Callback if user confirms
   * @param {function} onCancel - Callback if user cancels (optional)
   */
  function showConfirm(message, onConfirm, onCancel = null) {
    // Remove existing confirm if any
    const existing = document.getElementById('inlineConfirmOverlay');
    if (existing) existing.remove();

    // Create overlay
    const overlay = document.createElement('div');
    overlay.id = 'inlineConfirmOverlay';
    overlay.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100000;
      padding: 20px;
    `;

    // Create message box
    const box = document.createElement('div');
    box.style.cssText = `
      background: white;
      padding: 24px;
      max-width: 500px;
      width: 100%;
      border: 3px solid var(--warning-border);
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    `;

    const messageEl = document.createElement('div');
    messageEl.textContent = message;
    messageEl.style.cssText = `
      font-size: 14px;
      line-height: 1.6;
      color: var(--gray-900);
      margin-bottom: 20px;
      white-space: pre-line;
    `;

    const buttonContainer = document.createElement('div');
    buttonContainer.style.cssText = `
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    `;

    const cancelBtn = document.createElement('button');
    cancelBtn.textContent = 'CANCEL';
    cancelBtn.style.cssText = `
      padding: 12px 24px;
      background: var(--gray-100);
      color: var(--gray-900);
      border: 2px solid var(--gray-300);
      font-size: 13px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      cursor: pointer;
    `;
    cancelBtn.onclick = () => {
      overlay.remove();
      if (onCancel) onCancel();
    };

    const confirmBtn = document.createElement('button');
    confirmBtn.textContent = 'CONFIRM';
    confirmBtn.style.cssText = `
      padding: 12px 24px;
      background: #dc2626;
      color: white;
      border: 2px solid #dc2626;
      font-size: 13px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      cursor: pointer;
    `;
    confirmBtn.onclick = () => {
      overlay.remove();
      if (onConfirm) onConfirm();
    };

    buttonContainer.appendChild(cancelBtn);
    buttonContainer.appendChild(confirmBtn);
    box.appendChild(messageEl);
    box.appendChild(buttonContainer);
    overlay.appendChild(box);
    document.body.appendChild(overlay);

    // Close on overlay click = cancel
    overlay.addEventListener('click', (e) => {
      if (e.target === overlay) {
        overlay.remove();
        if (onCancel) onCancel();
      }
    });
  }

  /**
   * Show input prompt (replaces prompt())
   * @param {string} message - Prompt message
   * @param {string} defaultValue - Default input value
   * @param {function} onSubmit - Callback with input value
   * @param {function} onCancel - Callback if canceled (optional)
   */
  function showPrompt(message, defaultValue = '', onSubmit, onCancel = null) {
    // Remove existing prompt if any
    const existing = document.getElementById('inlinePromptOverlay');
    if (existing) existing.remove();

    // Create overlay
    const overlay = document.createElement('div');
    overlay.id = 'inlinePromptOverlay';
    overlay.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100000;
      padding: 20px;
    `;

    // Create message box
    const box = document.createElement('div');
    box.style.cssText = `
      background: white;
      padding: 24px;
      max-width: 500px;
      width: 100%;
      border: 3px solid var(--gray-700);
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    `;

    const messageEl = document.createElement('div');
    messageEl.textContent = message;
    messageEl.style.cssText = `
      font-size: 14px;
      line-height: 1.6;
      color: var(--gray-900);
      margin-bottom: 12px;
      font-weight: 600;
    `;

    const input = document.createElement('input');
    input.type = 'text';
    input.value = defaultValue;
    input.style.cssText = `
      width: 100%;
      padding: 12px;
      border: 2px solid var(--gray-300);
      font-size: 14px;
      margin-bottom: 20px;
      box-sizing: border-box;
    `;

    const buttonContainer = document.createElement('div');
    buttonContainer.style.cssText = `
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    `;

    const cancelBtn = document.createElement('button');
    cancelBtn.textContent = 'CANCEL';
    cancelBtn.style.cssText = `
      padding: 12px 24px;
      background: var(--gray-100);
      color: var(--gray-900);
      border: 2px solid var(--gray-300);
      font-size: 13px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      cursor: pointer;
    `;
    cancelBtn.onclick = () => {
      overlay.remove();
      if (onCancel) onCancel();
    };

    const submitBtn = document.createElement('button');
    submitBtn.textContent = 'OK';
    submitBtn.style.cssText = `
      padding: 12px 24px;
      background: var(--gray-900);
      color: white;
      border: 2px solid var(--gray-900);
      font-size: 13px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      cursor: pointer;
    `;
    submitBtn.onclick = () => {
      const value = input.value.trim();
      overlay.remove();
      if (onSubmit) onSubmit(value);
    };

    // Allow Enter key to submit
    input.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        submitBtn.click();
      }
    });

    buttonContainer.appendChild(cancelBtn);
    buttonContainer.appendChild(submitBtn);
    box.appendChild(messageEl);
    box.appendChild(input);
    box.appendChild(buttonContainer);
    overlay.appendChild(box);
    document.body.appendChild(overlay);

    // Focus input
    setTimeout(() => input.focus(), 100);

    // Close on overlay click = cancel
    overlay.addEventListener('click', (e) => {
      if (e.target === overlay) {
        overlay.remove();
        if (onCancel) onCancel();
      }
    });
  }
  // ==================== END UNIVERSAL MODAL HELPERS ====================

  // Configuration
   const SUPABASE_URL = 'https://gaawtbqpnnbbnsyswqwv.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdhYXd0YnFwbm5iYm5zeXN3cXd2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1MDE1NTAsImV4cCI6MjA3MjA3NzU1MH0.F-y7AIQTWaUe7DRT4OnIZVn94mhXxfhpBbng2aJ8nXg';
  const EMAILJS_CONFIG = {
    PUBLIC_KEY: 'LHbq8j4mlt49O75eo',
    SERVICE_ID: 'service_xm62z73',
    TEMPLATE_ID: 'template_cash_report',
    MANAGER_EMAIL: 'smanager@jaynagyro.com, GSS4168CTJJA73@PRINT.EPSONCONNECT.COM'
  };
  const BOTTLED_SAUCE_ITEMS = [
    { label: 'Spicy Aioli Bottled', aliases: ['spicy aioli bottled', 'spicy aioli - bottled'] },
    { label: 'Tzatziki Bottled', aliases: ['tzatziki bottled', 'tzatziki - bottled'] },
    { label: 'Lemon Vinaigrette Bottled', aliases: ['lemon vinaigrette bottled', 'lemon vinaigrette - bottled'] }
  ];

  // Function to check if an item should be in bottled/to-go section
  function isBottledOrToGoItem(itemName) {
    const name = (itemName || '').trim().toLowerCase();
    // Check if it's in the bottled sauce list
    const isBottled = BOTTLED_SAUCE_ITEMS.some(config => 
      config.aliases.some(alias => name.includes(alias))
    );
    // Check if it has "to go" or "to-go" in the name
    const isToGo = name.includes('to go') || name.includes('to-go');
    return isBottled || isToGo;
  }

  // Elegant Loading and Success Functions
  function showLoading(title, message) {
    const overlay = document.getElementById('loadingOverlay');
    if (!overlay) {
      console.warn('Loading overlay not found - skipping loading display');
      return;
    }
    const titleEl = document.getElementById('loadingTitle');
    const messageEl = document.getElementById('loadingMessage');
    if (titleEl) titleEl.textContent = title;
    if (messageEl) messageEl.textContent = message;
    overlay.style.display = 'flex'; // Override inline style
    // Don't hide sections - loading overlay should appear on top, not replace content
  }

  function hideLoading() {
    const overlay = document.getElementById('loadingOverlay');
    if (overlay) {
      overlay.style.display = 'none';
    }
  }

  function showAMSuccess(total) {
    hideLoading();
    hideAllSections();
    document.getElementById('amSuccessTotal').textContent = `$${total.toFixed(2)}`;
    document.getElementById('amSuccessTime').textContent = new Date().toLocaleString();
    document.getElementById('amSuccessScreen').classList.add('active');
  }

  function showPMSuccess(depositAmount, returnAmount, discrepancy) {
    hideLoading();
    hideAllSections();
    document.getElementById('depositAmount').textContent = `$${depositAmount}`;
    document.getElementById('returnAmount').textContent = `$${returnAmount.toFixed(2)}`;
    document.getElementById('pmSuccessScreen').classList.add('active');
  }

  function showReportSuccess(date) {
    hideLoading();
    hideAllSections();
    document.getElementById('reportSuccessDate').textContent = date;
    document.getElementById('reportSuccessTime').textContent = new Date().toLocaleString();
    document.getElementById('reportSuccessScreen').classList.add('active');
  }
  
  const DENOMINATIONS = [
    { label: '$100', value: 100.00 },
    { label: '$50', value: 50.00 },
    { label: '$20', value: 20.00 },
    { label: '$10', value: 10.00 },
    { label: '$5', value: 5.00 },
    { label: '$1', value: 1.00 },
    { label: '$0.25', value: 0.25 },
    { label: '$0.10', value: 0.10 },
    { label: '$0.05', value: 0.05 },
    { label: '$0.01', value: 0.01 }
  ];
  
  // Password protection for date changes (only Demetri knows this)
  const ADMIN_PASSWORD = 'JaynaGyro2025!';
  const CASH_PASSWORD = 'jaynacash'; // Cash flow access password

  // Session management for manager access (60 minutes)
  function setManagerSession() {
    const now = new Date().getTime();
    const expiryTime = now + (60 * 60 * 1000); // 1 hour from now
    localStorage.setItem('managerSession', expiryTime.toString());
  }

  function isManagerSessionValid() {
    const sessionExpiry = localStorage.getItem('managerSession');
    if (!sessionExpiry) return false;

    const now = new Date().getTime();
    const expiryTime = parseInt(sessionExpiry);

    if (now > expiryTime) {
      // Session expired, clean up
      localStorage.removeItem('managerSession');
      return false;
    }

    return true;
  }

  function clearManagerSession() {
    localStorage.removeItem('managerSession');
  }

  // Session management for cash flow access (30 minutes)
  function setCashSession() {
    const now = new Date().getTime();
    const expiryTime = now + (30 * 60 * 1000); // 30 minutes from now
    localStorage.setItem('cashSession', expiryTime.toString());
  }

  function isCashSessionValid() {
    const sessionExpiry = localStorage.getItem('cashSession');
    if (!sessionExpiry) return false;

    const now = new Date().getTime();
    const expiryTime = parseInt(sessionExpiry);

    if (now > expiryTime) {
      // Session expired, clean up
      localStorage.removeItem('cashSession');
      return false;
    }

    return true;
  }

  function clearCashSession() {
    localStorage.removeItem('cashSession');
  }
  
  let supabase = null;
  let currentAMData = null;
  
  // Initialize app
  document.addEventListener('DOMContentLoaded', function() {
    initializeSupabase();
    initializeEmailJS();
    setTodayDate();

    // Cash flow auto-loads based on time
    loadCashFlowByTime();
  });
  
  function initializeSupabase() {
    if (SUPABASE_URL === 'YOUR_SUPABASE_URL_HERE' || SUPABASE_ANON_KEY === 'YOUR_SUPABASE_ANON_KEY_HERE') {
      showMessage('Please configure Supabase credentials', 'error');
      return;
    }
    try {
      supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      console.log('Supabase initialized');
    } catch (error) {
      console.error('Supabase init failed:', error);
      showMessage('Database connection failed', 'error');
    }
  }
  
  function initializeEmailJS() {
    if (typeof emailjs !== 'undefined') {
      emailjs.init(EMAILJS_CONFIG.PUBLIC_KEY);
    }
  }
  
  function setTodayDate() {
    const today = getPacificDate();
    document.getElementById('amDate').value = today;
    document.getElementById('pmDate').value = today;
    // Note: reportDate element doesn't exist in cash.html (reports section removed)
    
    // Add password protection to date inputs (only if elements exist)
    const amDateEl = document.getElementById('amDate');
    if (amDateEl) {
      amDateEl.addEventListener('change', function() {
        const result = validateDateChange(this);
        if (result instanceof Promise) {
          result.then((success) => {
            if (success) {
              // Update edit PM link visibility after date change
              updateEditLinks();
            }
          });
          return;
        } else {
          // Update edit PM link visibility after date change
          updateEditLinks();
        }
      });
    }

    const pmDateEl = document.getElementById('pmDate');
    if (pmDateEl) {
      pmDateEl.addEventListener('change', function() {
        const result = validateDateChange(this);
        if (result instanceof Promise) {
          result.then((success) => {
            if (success) {
              // Only load AM data if date change was authorized
              loadAMData();
              // Also reload Toast cash sales for the new date
              fetchToastCashSalesForDate(this.value);
              // Update edit AM link visibility after date change
              updateEditLinks();
            }
          });
        } else if (result) {
          // Synchronous case (current date selected)
          loadAMData();
          // Also reload Toast cash sales for the new date
          fetchToastCashSalesForDate(this.value);
          // Update edit AM link visibility after date change
          updateEditLinks();
        }
      });
    }

    const reportDateEl = document.getElementById('reportDate');
    if (reportDateEl) {
      reportDateEl.addEventListener('change', function() {
        const result = validateDateChange(this);
        if (result instanceof Promise) {
          // Handle async validation - input value already reset if needed
          return;
        }
      });
    }
  }
  
  const PACIFIC_TIMEZONE = 'America/Los_Angeles';

  /**
   * Determine the offset (in minutes) for Pacific time at a specific moment.
   * We rely on Intl to hand us either PDT/PST or a GMT offset string.
   */
  function getPacificOffsetMinutes(date) {
    const parts = new Intl.DateTimeFormat('en-US', {
      timeZone: PACIFIC_TIMEZONE,
      timeZoneName: 'short'
    }).formatToParts(date);

    const tzName = parts.find(part => part.type === 'timeZoneName')?.value || 'PST';

    if (tzName.includes('PDT')) return 420; // UTC-7
    if (tzName.includes('PST')) return 480; // UTC-8

    const gmtMatch = tzName.match(/GMT([+-]\d{2})(\d{2})?/i);
    if (gmtMatch) {
      const hours = parseInt(gmtMatch[1], 10);
      const minutes = gmtMatch[2] ? parseInt(gmtMatch[2], 10) : 0;
      return Math.abs(hours) * 60 + minutes;
    }

    // Default to standard time if we hit an unexpected string.
    return 480;
  }

  /**
   * Create a Date that represents a Pacific-local wall clock time by
   * translating the supplied components into the correct UTC instant.
   * We default to 12:00 (noon) to avoid DST edge cases right at midnight.
   */
  function createPacificDate(year, month, day, hour = 12, minute = 0, second = 0) {
    const utcMillis = Date.UTC(year, month - 1, day, hour, minute, second);
    const tempUtcDate = new Date(utcMillis);
    const offsetMinutes = getPacificOffsetMinutes(tempUtcDate);
    return new Date(utcMillis + offsetMinutes * 60000);
  }

  /**
   * Convert any JS Date into a Pacific-local date (defaulting to midday).
   */
  function getPacificMidday(date = new Date()) {
    const parts = new Intl.DateTimeFormat('en-US', {
      timeZone: PACIFIC_TIMEZONE,
      year: 'numeric',
      month: '2-digit',
      day: '2-digit'
    }).formatToParts(date);

    const year = Number(parts.find(part => part.type === 'year')?.value);
    const month = Number(parts.find(part => part.type === 'month')?.value);
    const day = Number(parts.find(part => part.type === 'day')?.value);

    return createPacificDate(year, month, day, 12, 0, 0);
  }

  /**
   * Parse a YYYY-MM-DD string into a Pacific-local Date (midday).
   */
  function parsePacificDate(dateString) {
    if (!dateString) return null;
    const [year, month, day] = dateString.split('-').map(Number);
    if (!year || !month || !day) return null;
    return createPacificDate(year, month, day, 12, 0, 0);
  }

  /**
   * Format a Date as YYYY-MM-DD in Pacific time.
   */
  function formatPacificDate(date) {
    if (!date) return '';
    const parts = new Intl.DateTimeFormat('en-US', {
      timeZone: PACIFIC_TIMEZONE,
      year: 'numeric',
      month: '2-digit',
      day: '2-digit'
    }).formatToParts(date);

    const year = parts.find(part => part.type === 'year')?.value;
    const month = parts.find(part => part.type === 'month')?.value;
    const day = parts.find(part => part.type === 'day')?.value;

    return `${year}-${month}-${day}`;
  }

  /**
   * Format helper for display strings while forcing Pacific timezone.
   */
  function formatPacificDateDisplay(date, options = {}) {
    if (!date) return '';
    return new Intl.DateTimeFormat('en-US', {
      timeZone: PACIFIC_TIMEZONE,
      ...options
    }).format(date);
  }

  function formatPacificWeekday(date) {
    return formatPacificDateDisplay(date, { weekday: 'long' });
  }

  function getPacificHour(date) {
    if (!date) return null;
    const hourString = new Intl.DateTimeFormat('en-US', {
      timeZone: PACIFIC_TIMEZONE,
      hour: '2-digit',
      hour12: false
    }).format(date);
    return Number(hourString);
  }

  /**
   * Add days to a Pacific Date and return the normalized Pacific midday Date.
   */
  function addPacificDays(date, days) {
    if (!date) return null;
    const pacificMidday = getPacificMidday(date);
    const nextUtc = new Date(pacificMidday.getTime() + days * 86400000);
    return getPacificMidday(nextUtc);
  }

  /**
   * Return the current Pacific date as YYYY-MM-DD (optionally pass a Date).
   */
  function getPacificDate(date = new Date()) {
    return formatPacificDate(date);
  }
  
  function showMessage(text, type) {
    // Only show popups for important messages (errors), ignore info/success
    if (type === 'error') {
      showPopupMessage(text, type);
    }
    // Silently ignore info and success messages to prevent bouncing
  }
  
  function showPopupMessage(text, type) {
    const messageType = type === 'error' ? 'Error' : type === 'success' ? 'Success' : 'Notice';
    const backgroundColor = type === 'error' ? '#f44336' : '#4CAF50';
    const iconEmoji = '';
    
    const modalHTML = `
      <div id="messageModal" style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.7);
        z-index: 10000;
        display: flex;
        justify-content: center;
        align-items: center;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      ">
        <div style="
          background: white;
          padding: 30px;
          border-radius: 0;
          box-shadow: 0 10px 30px rgba(0,0,0,0.3);
          max-width: 400px;
          width: 90%;
          text-align: center;
        ">
          <h3 style="margin: 0 0 20px 0; color: ${backgroundColor};">${iconEmoji} ${messageType}</h3>
          <p style="margin: 0 0 25px 0; line-height: 1.4; font-size: 16px;">
            ${text}
          </p>
          <button onclick="closeMessageModal()" style="
            background: ${backgroundColor};
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 0;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
          ">OK</button>
        </div>
      </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
  }
  
  function closeMessageModal() {
    const modal = document.getElementById('messageModal');
    if (modal) {
      modal.remove();
    }
  }
  
  function validateDateChange(inputElement) {
    const selectedDate = inputElement.value;
    const currentDate = getPacificDate();
    
    // If user selects current date, allow it
    if (selectedDate === currentDate) {
      return true;
    }
    
    // If user selects different date, require password using custom modal
    return new Promise((resolve) => {
      showPasswordModal(selectedDate, currentDate, (success) => {
        if (!success) {
          inputElement.value = currentDate;
        }
        resolve(success);
      });
    });
  }
  
  function showPasswordModal(selectedDate, currentDate, callback) {
    // Remove any existing password modal first
    const existingModal = document.getElementById('passwordModal');
    if (existingModal) {
      existingModal.remove();
    }

    // Create modal HTML
    const modalHTML = `
      <div id="passwordModal" style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.7);
        z-index: 10000;
        display: flex;
        justify-content: center;
        align-items: center;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      ">
        <div style="
          background: white;
          padding: 30px;
          border-radius: 0;
          box-shadow: 0 10px 30px rgba(0,0,0,0.3);
          max-width: 400px;
          width: 90%;
          text-align: center;
        ">
          <h3 style="margin: 0 0 20px 0; color: #d32f2f;">Date Change Warning</h3>
          <p style="margin: 0 0 15px 0; line-height: 1.4;">
            You are trying to change the date from<br>
            <strong>TODAY (${currentDate})</strong> to <strong>${selectedDate}</strong>
          </p>
          <p style="margin: 0 0 20px 0; color: #d32f2f; font-weight: bold;">
            This could overwrite existing data!
          </p>
          <p style="margin: 0 0 15px 0;">Enter admin password to continue:</p>
          <input type="password" id="passwordInput" style="
            width: 80%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 0;
            font-size: 16px;
            text-align: center;
            margin-bottom: 20px;
          " placeholder="Password (JaynaGyro2025!)">
          <div id="passwordError" style="color: #d32f2f; margin-bottom: 10px; font-size: 14px; display: none;"></div>
          <div>
            <button onclick="window.cashPasswordSubmit()" style="
              background: var(--gray-700);
              color: white;
              border: none;
              padding: 10px 20px;
              border-radius: 0;
              margin: 0 10px;
              cursor: pointer;
              font-size: 16px;
            ">Continue</button>
            <button onclick="window.cashPasswordCancel()" style="
              background: var(--error);
              color: white;
              border: none;
              padding: 10px 20px;
              border-radius: 0;
              margin: 0 10px;
              cursor: pointer;
              font-size: 16px;
            ">Cancel</button>
          </div>
        </div>
      </div>
    `;

    // Add modal to page
    document.body.insertAdjacentHTML('beforeend', modalHTML);

    // Store callback for button handlers
    window.passwordModalCallback = callback;

    // Focus password input after a short delay to ensure it's rendered
    setTimeout(() => {
      const input = document.getElementById('passwordInput');
      if (input) {
        input.focus();

        // Add enter key support
        input.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            e.preventDefault();
            window.cashPasswordSubmit();
          }
        });
      }
    }, 100);
  }
  
  // Make these globally accessible for onclick handlers
  window.cashPasswordSubmit = function() {
    const passwordInput = document.getElementById('passwordInput');
    const passwordError = document.getElementById('passwordError');
    const modal = document.getElementById('passwordModal');

    if (!passwordInput || !modal) {
      console.error('Password modal elements not found');
      return;
    }

    const password = passwordInput.value;

    console.log('Checking password...');

    if (password === ADMIN_PASSWORD) {
      console.log('‚úÖ Password correct!');
      // Silent success - no bouncing message
      modal.remove();
      if (window.passwordModalCallback) {
        window.passwordModalCallback(true);
      }
    } else {
      console.log('‚ùå Password incorrect');
      // Show inline error instead of modal
      if (passwordError) {
        passwordError.textContent = '‚ùå Incorrect password. Try: JaynaGyro2025!';
        passwordError.style.display = 'block';
      }
      passwordInput.value = '';
      passwordInput.focus();
      // Don't close modal or call callback on wrong password - let user try again
    }
  };

  window.cashPasswordCancel = function() {
    const modal = document.getElementById('passwordModal');
    if (modal) {
      modal.remove();
    }
    if (window.passwordModalCallback) {
      window.passwordModalCallback(false);
    }
  };

  // General password protection function for manager features
  function requirePasswordFor(featureName, callback) {
    // Check if we have a valid session first
    if (isManagerSessionValid()) {
      // Session is valid, proceed directly
      callback();
      return;
    }

    // No valid session, show password modal
    showManagerPasswordModal(featureName, callback);
  }

  // Catering access function - redirects to catering.html with session persistence
  function accessCatering() {
    window.location.href = 'catering.html';
  }

  // Manager Logs access function - redirects to managerlogs.html with session persistence
  function accessManagerLogs() {
    window.location.href = 'managerlogs.html';
  }

  // Scheduling access function - redirects to scheduling.html with session persistence
  function accessScheduling() {
    window.location.href = 'scheduling.html';
  }

  function showManagerPasswordModal(featureName, callback) {
    // Create modal HTML for manager features
    const modalHTML = `
      <div id="passwordModal" style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.7);
        z-index: 10000;
        display: flex;
        justify-content: center;
        align-items: center;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      ">
        <div style="
          background: white;
          padding: 30px;
          border-radius: 0;
          box-shadow: 0 10px 30px rgba(0,0,0,0.3);
          max-width: 400px;
          width: 90%;
          text-align: center;
        ">
          <h3 style="margin: 0 0 20px 0; color: #d32f2f;">Manager Access Required</h3>
          <p style="margin: 0 0 15px 0; line-height: 1.4;">
            <strong>${featureName}</strong> requires manager authorization.
          </p>
          <p style="margin: 0 0 20px 0; color: #666;">
            This feature contains sensitive financial data and management tools.
          </p>
          <p style="margin: 0 0 15px 0;">Enter manager password:</p>
          <input type="password" id="passwordInput" style="
            width: 80%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 0;
            font-size: 16px;
            text-align: center;
            margin-bottom: 20px;
          " placeholder="Manager Password">
          <div>
            <button onclick="submitManagerPassword()" style="
              background: var(--gray-700);
              color: white;
              border: none;
              padding: 10px 20px;
              border-radius: 0;
              margin: 0 10px;
              cursor: pointer;
              font-size: 16px;
            ">Access ${featureName}</button>
            <button onclick="cancelManagerPassword()" style="
              background: var(--error);
              color: white;
              border: none;
              padding: 10px 20px;
              border-radius: 0;
              margin: 0 10px;
              cursor: pointer;
              font-size: 16px;
            ">Cancel</button>
          </div>
        </div>
      </div>
    `;
    
    // Add modal to page
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // Focus password input
    document.getElementById('passwordInput').focus();
    
    // Store callback for button handlers
    window.managerPasswordCallback = callback;
    
    // Add enter key support
    document.getElementById('passwordInput').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        submitManagerPassword();
      }
    });
  }

  async function submitManagerPassword() {
    const password = document.getElementById('passwordInput').value;
    const modal = document.getElementById('passwordModal');

    // Get master password from Supabase (cloud-based, works across ALL devices)
    let masterPassword = ADMIN_PASSWORD;
    try {
      const { data: masterPwdData } = await supabase
        .from('manager_passwords')
        .select('*')
        .eq('username', 'SYSTEM_MASTER_PASSWORD')
        .eq('is_active', true)
        .limit(1)
        .single();

      if (masterPwdData && masterPwdData.full_name) {
        masterPassword = masterPwdData.full_name;
      }
    } catch (error) {
      // No custom master password set, use default
      console.log('Using default master password');
    }

    const customPasswords = JSON.parse(localStorage.getItem('customPasswords') || '[]');
    const validPasswords = [masterPassword, ...customPasswords];

    if (validPasswords.includes(password)) {
      // Success - set manager session and execute the protected function
      setManagerSession();
      modal.remove();
      showMessage('Manager access granted for 1 hour', 'success');
      window.managerPasswordCallback();
    } else {
      showMessage('Incorrect manager password. Access denied.', 'error');
      modal.remove();
    }
  }

  function cancelManagerPassword() {
    const modal = document.getElementById('passwordModal');
    modal.remove();
    // Don't call callback on cancel
  }

  function logoutManager() {
    clearManagerSession();
    showMessage('Manager session ended', 'success');
  }

  // Note: Manager session status tracking removed (not needed for cash.html)
  // Cash page doesn't have sessionStatus or logoutBtn elements


  function hideAllSections() {
    console.log('hideAllSections() called - this might be hiding tip pool results!');
    console.trace('hideAllSections call stack');
    document.querySelectorAll('.form-section').forEach(section => section.classList.remove('active'));
  }
  
  function goHome() {
    console.log('goHome() called - this will hide tip pool results!');
    console.trace('goHome call stack');
    hideAllSections();

    const mainMenu = document.getElementById('mainMenu');
    if (mainMenu) {
      mainMenu.style.display = 'grid';
    } else {
      console.warn('mainMenu element not found - reloading page instead');
      window.location.reload();
    }

    // Reset container width
    const container = document.querySelector('.container');
    if (container) {
      container.style.maxWidth = '600px';
    }
  }

  // Toast API Integration
  let autoCalculatedToastAmount = 0;
  
  async function fetchToastCashSales() {
    // Use the selected PM date from the date picker
    const selectedDate = document.getElementById('pmDate').value;
    if (!selectedDate) {
      console.warn('No PM date selected, using today');
      const today = new Date();
      const businessDate = formatDateForToast(today);
      await fetchToastCashSalesForDate(businessDate);
    } else {
      // Use the selected date
      console.log('Fetching Toast cash sales for selected date:', selectedDate);
      await fetchToastCashSalesForDate(selectedDate);
    }
  }

  async function fetchToastCashSalesForDate(dateInput) {
    // Show loading state with animated indicator
    const loadingIndicator = document.getElementById('toastLoadingIndicator');
    const retryBtn = document.getElementById('toastRetryBtn');

    loadingIndicator.style.display = 'block';

    // Disable retry button during fetch
    retryBtn.disabled = true;
    retryBtn.style.opacity = '0.5';
    retryBtn.style.cursor = 'not-allowed';

    document.getElementById('autoToastAmount').textContent = 'Loading...';

    try {
      // Handle both date string (YYYY-MM-DD) and formatted date (YYYYMMDD)
      let businessDate;
      if (dateInput.includes('-')) {
        // Convert YYYY-MM-DD to YYYYMMDD
        const dateObj = new Date(dateInput + 'T12:00:00'); // Add time to avoid timezone issues
        businessDate = formatDateForToast(dateObj);
      } else {
        // Already in YYYYMMDD format
        businessDate = dateInput;
      }

      console.log('üîÑ Starting 2-attempt fetch for Toast cash sales:', businessDate);

      // First authenticate with Toast
      const authResponse = await fetch('/api/toast-auth', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      });

      if (!authResponse.ok) {
        throw new Error('Failed to authenticate with Toast API');
      }

      const authData = await authResponse.json();
      if (!authData.success || !authData.data?.accessToken) {
        throw new Error('Toast authentication failed');
      }

      // RETRY LOGIC: Fetch 2 times and use the highest amount (most complete data)
      const attempts = [];
      const token = authData.data.accessToken;

      for (let i = 1; i <= 2; i++) {
        console.log(`üîÑ Attempt ${i}/2: Fetching cash sales...`);

        try {
          const paymentsUrl = `/api/toast-payments?businessDate=${businessDate}&token=${encodeURIComponent(token)}`;
          const paymentsResponse = await fetch(paymentsUrl);

          if (!paymentsResponse.ok) {
            console.warn(`Attempt ${i} failed: HTTP ${paymentsResponse.status}`);
            attempts.push({ success: false, attempt: i, error: `HTTP ${paymentsResponse.status}` });
            continue;
          }

          const paymentsData = await paymentsResponse.json();
          if (!paymentsData.success) {
            console.warn(`Attempt ${i} failed:`, paymentsData.error);
            attempts.push({ success: false, attempt: i, error: paymentsData.error });
            continue;
          }

          // Success! Store this attempt's result
          attempts.push({
            success: true,
            attempt: i,
            totalCashAmount: paymentsData.totalCashAmount,
            totalCashPayments: paymentsData.totalCashPayments,
            totalPaymentGuids: paymentsData.totalPaymentGuids
          });

          console.log(`‚úÖ Attempt ${i} success: $${paymentsData.totalCashAmount.toFixed(2)} (${paymentsData.totalCashPayments} payments)`);

          // Small delay between attempts to avoid rate limiting
          if (i < 2) {
            await new Promise(resolve => setTimeout(resolve, 500));
          }

        } catch (error) {
          console.warn(`Attempt ${i} error:`, error.message);
          attempts.push({ success: false, attempt: i, error: error.message });
        }
      }

      // Find successful attempts
      const successfulAttempts = attempts.filter(a => a.success);

      if (successfulAttempts.length === 0) {
        throw new Error('All 2 fetch attempts failed. Please try again.');
      }

      // Use the HIGHEST amount (most complete data)
      const bestAttempt = successfulAttempts.reduce((max, current) =>
        current.totalCashAmount > max.totalCashAmount ? current : max
      );

      // Console logs for developer debugging
      const amounts = successfulAttempts.map(a => a.totalCashAmount);
      const minAmount = Math.min(...amounts);
      const maxAmount = Math.max(...amounts);
      const hasDiscrepancy = maxAmount !== minAmount;

      console.log('üìä Fetch Results:');
      console.log(`   - Successful attempts: ${successfulAttempts.length}/2`);
      console.log(`   - Amounts: $${amounts.map(a => a.toFixed(2)).join(', $')}`);
      console.log(`   - Using HIGHEST: $${bestAttempt.totalCashAmount.toFixed(2)} (Attempt ${bestAttempt.attempt})`);
      if (hasDiscrepancy) {
        console.log(`   - ‚ö†Ô∏è Discrepancy detected (Range: $${minAmount.toFixed(2)}-$${maxAmount.toFixed(2)})`);
      } else {
        console.log(`   - ‚úÖ All ${successfulAttempts.length} attempts matched`);
      }

      // Store the auto-calculated amount
      autoCalculatedToastAmount = bestAttempt.totalCashAmount;

      // Update the hidden field for form processing
      document.getElementById('toastSales').value = autoCalculatedToastAmount.toFixed(2);

      // Show simple result (just the dollar amount)
      document.getElementById('autoToastAmount').textContent = `$${autoCalculatedToastAmount.toFixed(2)}`;

      // Hide loading indicator on success
      loadingIndicator.style.display = 'none';

      // Re-enable retry button
      retryBtn.disabled = false;
      retryBtn.style.opacity = '1';
      retryBtn.style.cursor = 'pointer';

      console.log('‚úÖ Toast cash sales fetched successfully:', autoCalculatedToastAmount);

      // Trigger discrepancy validation if we're in PM mode
      const pmGrandTotal = document.getElementById('pmGrandTotal');
      if (pmGrandTotal && pmGrandTotal.textContent !== '$0.00') {
        const pmTotal = parseFloat(pmGrandTotal.textContent.replace('$', '').replace(',', '')) || 0;
        validatePMDiscrepancy(pmTotal);
      }

    } catch (error) {
      console.error('‚ùå Toast API fetch error:', error);

      // Hide loading indicator on error
      loadingIndicator.style.display = 'none';

      // Re-enable retry button (so they can retry after error)
      retryBtn.disabled = false;
      retryBtn.style.opacity = '1';
      retryBtn.style.cursor = 'pointer';

      // Show simple error state (just show $0.00, details in console)
      document.getElementById('autoToastAmount').textContent = '$0.00';

      // Reset auto amount
      autoCalculatedToastAmount = 0;
      document.getElementById('toastSales').value = '0';
    }
  }

  function formatDateForToast(date) {
    // Convert to YYYYMMDD format for Toast API
    // CRITICAL: Use Pacific timezone components, not UTC!
    // At 11:30 PM Pacific (Nov 4), UTC is already Nov 5
    const formatter = new Intl.DateTimeFormat('en-US', {
      timeZone: 'America/Los_Angeles',
      year: 'numeric',
      month: '2-digit',
      day: '2-digit'
    });

    const parts = formatter.formatToParts(date);
    const year = parts.find(p => p.type === 'year').value;
    const month = parts.find(p => p.type === 'month').value;
    const day = parts.find(p => p.type === 'day').value;

    return `${year}${month}${day}`;
  }
  
  function startAMCount() {
    // Keep main menu visible at top
    hideAllSections();
    document.getElementById('amForm').classList.add('active');
    setupDenominations('am');

    // Show "Edit PM Count" link if viewing a past date
    const selectedDate = document.getElementById('amDate').value;
    const today = getPacificDate();
    if (selectedDate && selectedDate !== today) {
      console.log('üìÖ Past date selected in AM flow - showing Edit PM link');
      showEditPMLink();
    }
  }

  async function startPMCount() {
    // Keep main menu visible at top
    hideAllSections();
    document.getElementById('pmForm').classList.add('active');
    setupDenominations('pm');

    await loadAMData();

    // Show "Update AM Counts" link if viewing past date OR if it's today (existing behavior)
    const selectedDate = document.getElementById('pmDate').value;
    const today = getPacificDate();
    if (selectedDate && selectedDate !== today) {
      console.log('üìÖ Past date selected in PM flow - showing Edit AM link');
      showEditAMLink();
    } else if (selectedDate === today) {
      // Keep existing behavior for today
      showEditAMLink();
    }

    // Automatically fetch Toast cash sales when PM section loads
    console.log('PM Count started - automatically fetching Toast cash sales...');
    try {
      await fetchToastCashSales();
    } catch (error) {
      console.error('Auto-fetch Toast sales failed:', error);
      // Don't block the UI - user can still proceed manually if needed
    }
  }

  /**
   * Smart Cash Button - Time-based AM/PM flow with password protection
   * 7AM-7PM PT: AM Count
   * 7PM-2AM PT: PM Close
   * 2AM-7AM PT: No flow available
   */
  function startSmartCashFlow() {
    // No password needed - handled by app-header navigation
    loadCashFlowByTime();
  }

  function showCashPasswordModal() {
    const modal = document.createElement('div');
    modal.id = 'cashPasswordModal'; // Add unique ID for safe removal
    modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10000;';

    modal.innerHTML = `
      <div style="background: white; padding: 40px; border-radius: 0; border: 3px solid var(--gray-700); max-width: 400px; width: 90%;">
        <h3 style="margin: 0 0 20px 0; font-size: 18px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;">Cash Flow Access</h3>
        <p style="margin-bottom: 20px; color: var(--gray-700); font-size: 13px;">Enter password to access cash counting:</p>
        <input type="password" id="cashPasswordInput" placeholder="Enter password" style="width: 100%; padding: 12px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 14px; margin-bottom: 20px; box-sizing: border-box;" />
        <div style="display: flex; gap: 12px;">
          <button onclick="closeCashPasswordModal()" style="flex: 1; padding: 12px 24px; background: var(--gray-100); border: 2px solid var(--gray-300); color: var(--gray-900); font-size: 13px; font-weight: 700; cursor: pointer; text-transform: uppercase; letter-spacing: 0.5px;">Cancel</button>
          <button onclick="verifyCashPassword()" style="flex: 1; padding: 12px 24px; background: var(--gray-900); border: 2px solid var(--gray-900); color: white; font-size: 13px; font-weight: 700; cursor: pointer; text-transform: uppercase; letter-spacing: 0.5px;">Submit</button>
        </div>
      </div>
    `;

    document.body.appendChild(modal);

    // Focus password input
    setTimeout(() => {
      document.getElementById('cashPasswordInput').focus();
    }, 100);

    // Add enter key support
    document.getElementById('cashPasswordInput').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        verifyCashPassword();
      }
    });
  }

  function closeCashPasswordModal() {
    const modal = document.getElementById('cashPasswordModal');
    if (modal && modal.parentNode) {
      modal.parentNode.removeChild(modal);
    }
  }

  function verifyCashPassword() {
    const input = document.getElementById('cashPasswordInput');
    if (!input) {
      console.error('Cash password input not found');
      return;
    }

    const password = input.value;

    if (password === CASH_PASSWORD) {
      // Set 30-minute session
      setCashSession();

      // Remove modal
      closeCashPasswordModal();

      // Load appropriate flow
      loadCashFlowByTime();
    } else {
      showMessage('Incorrect password. Access denied.', 'error');
      closeCashPasswordModal();
    }
  }

  // ===== AM DATA EXISTS - SHOW PM FLOW WITH EDIT LINK =====

  async function startPMCountWithEditLink() {
    // Start PM flow normally
    await startPMCount();

    // Add "Edit AM Count" link after PM form loads
    showEditAMLink();
  }

  function showEditAMLink() {
    // Find PM form and add simple text link under title
    const pmForm = document.getElementById('pmForm');
    if (!pmForm) return;

    // Check if link already exists
    if (document.getElementById('editAMLinkContainer')) return;

    // Create simple text link
    const editLinkContainer = document.createElement('div');
    editLinkContainer.id = 'editAMLinkContainer';
    editLinkContainer.style.cssText = 'text-align: center; margin: -15px 0 20px 0;';

    editLinkContainer.innerHTML = `
      <a href="javascript:void(0)" onclick="editAMCount()" style="font-size: 11px; color: rgba(0,0,0,0.8); text-decoration: underline; cursor: pointer;">
        Update AM Counts
      </a>
    `;

    // Insert right after the h2 title
    const h2 = pmForm.querySelector('h2');
    if (h2 && h2.nextSibling) {
      pmForm.insertBefore(editLinkContainer, h2.nextSibling);
    } else {
      pmForm.insertBefore(editLinkContainer, pmForm.firstChild);
    }
  }

  // ===== EDIT AM COUNT WITH PASSWORD PROTECTION =====

  let isEditingExistingAM = false; // Track if we're editing existing data

  function editAMCount() {
    console.log('üîê Edit AM Count requested - showing password modal');
    showEditAMPasswordModal();
  }

  function showEditAMPasswordModal() {
    const modal = document.createElement('div');
    modal.id = 'editAMPasswordModal';
    modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 10000;';

    modal.innerHTML = `
      <div style="background: white; padding: 40px; max-width: 450px; width: 90%; border: 3px solid var(--warning-border);">
        <h3 style="margin: 0 0 15px 0; font-size: 18px; font-weight: 700; color: var(--warning-text); text-transform: uppercase; letter-spacing: 1px;">‚ö†Ô∏è WARNING: Edit AM Count</h3>
        <p style="margin-bottom: 20px; color: var(--gray-700); font-size: 14px; line-height: 1.5;">
          You are about to edit today's AM cash count. This will allow you to modify the morning baseline that has already been submitted.
        </p>
        <p style="margin-bottom: 20px; color: var(--error-text); font-size: 13px; font-weight: 600;">
          Enter master password or custom password to proceed:
        </p>
        <input type="password" id="editAMPasswordInput" placeholder="Enter password" style="width: 100%; padding: 14px; border: 2px solid var(--gray-300); font-size: 14px; margin-bottom: 20px; box-sizing: border-box;" />
        <div style="display: flex; gap: 12px;">
          <button onclick="closeEditAMPasswordModal()" style="flex: 1; padding: 14px; background: var(--gray-100); border: 2px solid var(--gray-300); color: var(--gray-900); font-size: 13px; font-weight: 700; cursor: pointer; text-transform: uppercase; letter-spacing: 0.5px;">Cancel</button>
          <button onclick="verifyEditAMPassword()" style="flex: 1; padding: 14px; background: var(--warning-border); border: 2px solid var(--warning-border); color: white; font-size: 13px; font-weight: 700; cursor: pointer; text-transform: uppercase; letter-spacing: 0.5px;">Proceed</button>
        </div>
      </div>
    `;

    document.body.appendChild(modal);

    setTimeout(() => {
      const input = document.getElementById('editAMPasswordInput');
      if (input) input.focus();
    }, 100);

    // Enter key support
    document.getElementById('editAMPasswordInput').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') verifyEditAMPassword();
    });
  }

  function closeEditAMPasswordModal() {
    const modal = document.getElementById('editAMPasswordModal');
    if (modal) modal.remove();
  }

  async function verifyEditAMPassword() {
    const input = document.getElementById('editAMPasswordInput');
    if (!input) return;

    const password = input.value.trim();

    // Master password
    const masterPassword = 'JaynaGyro2025!';

    // Custom passwords from localStorage
    const customPasswords = JSON.parse(localStorage.getItem('customPasswords') || '[]');
    const validPasswords = [masterPassword, ...customPasswords];

    if (validPasswords.includes(password)) {
      closeEditAMPasswordModal();
      console.log('‚úÖ Password verified - loading AM count for editing');

      // Set editing flag
      isEditingExistingAM = true;

      // Load AM form with existing data
      await loadAndShowAMFormForEditing();
    } else {
      showMessage('Incorrect password. Access denied.', 'error');
      closeEditAMPasswordModal();
    }
  }

  function addEditingByDropdown(shift, originalCounter) {
    // Check if already exists
    if (document.getElementById(`${shift}EditingByGroup`)) return;

    // Find the original counter form group
    const counterSelect = document.getElementById(`${shift}Counter`);
    const counterGroup = counterSelect.closest('.form-group');

    // Create new form group for "Editing By"
    const editingByGroup = document.createElement('div');
    editingByGroup.className = 'form-group';
    editingByGroup.id = `${shift}EditingByGroup`;
    editingByGroup.style.cssText = 'margin-top: 20px; padding-top: 20px; border-top: 2px solid var(--warning-border); background: var(--warning-bg); padding: 15px; margin-bottom: 20px;';

    editingByGroup.innerHTML = `
      <label for="${shift}EditingBy" style="color: var(--warning-text);">AM COUNT EDITING BY:</label>
      <select id="${shift}EditingBy" class="form-select" required>
        <option value="">Choose Name to Enable Editing</option>
        <option value="Demetri Gregorakis">Demetri Gregorakis</option>
        <option value="Dilan Uzum">Dilan Uzum</option>
        <option value="Erin Best">Erin Best</option>
        <option value="Katerina Perakis">Katerina Perakis</option>
        <option value="Kayla Mccullough">Kayla Mccullough</option>
      </select>
      <p style="margin-top: 8px; font-size: 11px; color: var(--warning-text); font-style: italic;">
        Original count by: <strong>${originalCounter}</strong>
      </p>
    `;

    // Insert after the original counter group
    counterGroup.parentNode.insertBefore(editingByGroup, counterGroup.nextSibling);

    // Add change event listener to enable denomination inputs
    document.getElementById(`${shift}EditingBy`).addEventListener('change', function() {
      if (this.value) {
        console.log(`‚úÖ Editing by ${this.value} - enabling denomination fields`);
        toggleDenominationInputs(shift);
      }
    });
  }

  async function loadAndShowAMFormForEditing() {
    const today = getPacificDate();
    const amData = await getAMData(today);

    if (!amData) {
      showMessage('No AM data found to edit', 'error');
      return;
    }

    console.log('üìù Loading AM form with existing data:', amData);

    // Show AM form
    hideAllSections();
    document.getElementById('amForm').classList.add('active');
    setupDenominations('am');

    // Pre-populate ALL fields
    document.getElementById('amDate').value = amData.date;
    document.getElementById('amCounter').value = amData.counter;
    document.getElementById('amNotes').value = amData.notes || '';

    // Disable original counter dropdown when editing
    document.getElementById('amCounter').disabled = true;
    document.getElementById('amCounter').style.opacity = '0.6';
    document.getElementById('amCounter').style.cursor = 'not-allowed';

    // Add "Editing By" dropdown right after original counter dropdown
    addEditingByDropdown('am', amData.counter);

    // Drawer 1
    if (amData.drawer1.skipped) {
      document.getElementById('amDrawer1Skip').checked = true;
      toggleSkip('am', 1);
      document.getElementById('amDrawer1Reason').value = amData.drawer1.skipReason || '';
    } else {
      // Pre-populate drawer 1 denominations
      DENOMINATIONS.forEach((denom, index) => {
        const key = getDenominationKey(denom.value);
        const value = amData.drawer1.counts[key] || 0;
        document.getElementById(`amD1Q${index}`).value = value;
      });
      updateCalculations('am', 1);
    }

    // Drawer 2
    if (amData.drawer2.skipped) {
      document.getElementById('amDrawer2Skip').checked = true;
      toggleSkip('am', 2);
      document.getElementById('amDrawer2Reason').value = amData.drawer2.skipReason || '';
    } else {
      // Pre-populate drawer 2 denominations
      DENOMINATIONS.forEach((denom, index) => {
        const key = getDenominationKey(denom.value);
        const value = amData.drawer2.counts[key] || 0;
        document.getElementById(`amD2Q${index}`).value = value;
      });
      updateCalculations('am', 2);
    }

    showMessage('‚úèÔ∏è Editing existing AM count. Make your changes and resubmit.', 'info');
  }

  // ===== EDIT PM COUNT WITH PASSWORD PROTECTION =====

  function updateEditLinks() {
    // Remove any existing edit links first
    const existingAMLink = document.getElementById('editAMLinkContainer');
    const existingPMLink = document.getElementById('editPMLinkContainer');
    if (existingAMLink) existingAMLink.remove();
    if (existingPMLink) existingPMLink.remove();

    // Get current date
    const today = getPacificDate();

    // Check if AM form is visible
    const amForm = document.getElementById('amForm');
    if (amForm && amForm.classList.contains('active')) {
      const selectedDate = document.getElementById('amDate').value;
      if (selectedDate && selectedDate !== today) {
        console.log('üìÖ Showing Edit PM link (past date in AM flow)');
        showEditPMLink();
      }
    }

    // Check if PM form is visible
    const pmForm = document.getElementById('pmForm');
    if (pmForm && pmForm.classList.contains('active')) {
      const selectedDate = document.getElementById('pmDate').value;
      // Always show edit AM link in PM flow (past date OR today)
      console.log('üìÖ Showing Edit AM link in PM flow');
      showEditAMLink();
    }
  }

  function showEditPMLink() {
    // Find AM form and add simple text link under title
    const amForm = document.getElementById('amForm');
    if (!amForm) return;

    // Check if link already exists
    if (document.getElementById('editPMLinkContainer')) return;

    // Create simple text link
    const editLinkContainer = document.createElement('div');
    editLinkContainer.id = 'editPMLinkContainer';
    editLinkContainer.style.cssText = 'text-align: center; margin: -15px 0 20px 0;';

    editLinkContainer.innerHTML = `
      <a href="javascript:void(0)" onclick="editPMCount()" style="font-size: 11px; color: rgba(0,0,0,0.8); text-decoration: underline; cursor: pointer;">
        Go to PM Count for This Date
      </a>
    `;

    // Insert right after the h2 title
    const h2 = amForm.querySelector('h2');
    if (h2 && h2.nextSibling) {
      amForm.insertBefore(editLinkContainer, h2.nextSibling);
    } else {
      amForm.insertBefore(editLinkContainer, amForm.firstChild);
    }
  }

  function editPMCount() {
    console.log('üîê Edit PM Count requested - showing password modal');
    showEditPMPasswordModal();
  }

  function showEditPMPasswordModal() {
    const modal = document.createElement('div');
    modal.id = 'editPMPasswordModal';
    modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 10000;';

    modal.innerHTML = `
      <div style="background: white; padding: 40px; max-width: 450px; width: 90%; border: 3px solid var(--warning-border);">
        <h3 style="margin: 0 0 15px 0; font-size: 18px; font-weight: 700; color: var(--warning-text); text-transform: uppercase; letter-spacing: 1px;">‚ö†Ô∏è WARNING: Access PM Count</h3>
        <p style="margin-bottom: 20px; color: var(--gray-700); font-size: 14px; line-height: 1.5;">
          You are about to access the PM cash close for this date. This will allow you to add a new PM count or modify an existing one.
        </p>
        <p style="margin-bottom: 20px; color: var(--error-text); font-size: 13px; font-weight: 600;">
          Enter master password to proceed:
        </p>
        <input type="password" id="editPMPasswordInput" placeholder="Enter password" style="width: 100%; padding: 14px; border: 2px solid var(--gray-300); font-size: 14px; margin-bottom: 20px; box-sizing: border-box;" />
        <div style="display: flex; gap: 12px;">
          <button onclick="closeEditPMPasswordModal()" style="flex: 1; padding: 14px; background: var(--gray-100); border: 2px solid var(--gray-300); color: var(--gray-900); font-size: 13px; font-weight: 700; cursor: pointer; text-transform: uppercase; letter-spacing: 0.5px;">Cancel</button>
          <button onclick="verifyEditPMPassword()" style="flex: 1; padding: 14px; background: var(--warning-border); border: 2px solid var(--warning-border); color: white; font-size: 13px; font-weight: 700; cursor: pointer; text-transform: uppercase; letter-spacing: 0.5px;">Proceed</button>
        </div>
      </div>
    `;

    document.body.appendChild(modal);

    setTimeout(() => {
      const input = document.getElementById('editPMPasswordInput');
      if (input) input.focus();
    }, 100);

    // Enter key support
    document.getElementById('editPMPasswordInput').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') verifyEditPMPassword();
    });
  }

  function closeEditPMPasswordModal() {
    const modal = document.getElementById('editPMPasswordModal');
    if (modal) modal.remove();
  }

  async function verifyEditPMPassword() {
    const input = document.getElementById('editPMPasswordInput');
    if (!input) return;

    const password = input.value.trim();

    // Master password
    const masterPassword = 'JaynaGyro2025!';

    // Custom passwords from localStorage
    const customPasswords = JSON.parse(localStorage.getItem('customPasswords') || '[]');
    const validPasswords = [masterPassword, ...customPasswords];

    if (validPasswords.includes(password)) {
      closeEditPMPasswordModal();
      console.log('‚úÖ Password verified - loading PM count for editing');

      // Load PM form with existing data for the selected date
      await loadAndShowPMFormForEditing();
    } else {
      showMessage('Incorrect password. Access denied.', 'error');
      closeEditPMPasswordModal();
    }
  }

  async function loadAndShowPMFormForEditing() {
    const selectedDate = document.getElementById('amDate').value;
    if (!selectedDate) {
      showMessage('No date selected', 'error');
      return;
    }

    // CRITICAL FIX: Set the PM date BEFORE calling startPMCount()
    // because startPMCount() -> loadAMData() reads from pmDate.value
    document.getElementById('pmDate').value = selectedDate;

    const pmData = await getPMData(selectedDate);

    // Show PM form (works for both new entry and editing)
    await startPMCount();

    if (pmData) {
      // PM data EXISTS - pre-populate for editing
      console.log('üìù Loading PM form with existing data:', pmData);

      document.getElementById('pmCounter').value = pmData.counter;
      document.getElementById('pmNotes').value = pmData.notes || '';
      document.getElementById('depositAmount').value = pmData.deposit_amount || '';
      document.getElementById('cashTips').value = pmData.cash_tips || '';

      // Pre-populate drawers if they exist
      if (pmData.drawer1) {
        if (pmData.drawer1.skipped) {
          document.getElementById('pmDrawer1Skip').checked = true;
          toggleSkip('pm', 1);
          document.getElementById('pmDrawer1Reason').value = pmData.drawer1.skipReason || '';
        } else {
          DENOMINATIONS.forEach((denom, index) => {
            const key = getDenominationKey(denom.value);
            const value = pmData.drawer1.counts[key] || 0;
            document.getElementById(`pmD1Q${index}`).value = value;
          });
          updateCalculations('pm', 1);
        }
      }

      if (pmData.drawer2) {
        if (pmData.drawer2.skipped) {
          document.getElementById('pmDrawer2Skip').checked = true;
          toggleSkip('pm', 2);
          document.getElementById('pmDrawer2Reason').value = pmData.drawer2.skipReason || '';
        } else {
          DENOMINATIONS.forEach((denom, index) => {
            const key = getDenominationKey(denom.value);
            const value = pmData.drawer2.counts[key] || 0;
            document.getElementById(`pmD2Q${index}`).value = value;
          });
          updateCalculations('pm', 2);
        }
      }

      showMessage('‚úèÔ∏è Editing existing PM count. Make your changes and resubmit.', 'info');
    } else {
      // NO PM data - blank form for NEW entry
      console.log('üìù No PM data found - loading blank form for new entry');
      showMessage('üí° No PM data exists for this date. Fill out the form to create a new PM count.', 'info');

      // Fetch Toast sales for the selected date
      try {
        await fetchToastCashSalesForDate(selectedDate);
      } catch (error) {
        console.error('Failed to fetch Toast sales:', error);
      }
    }
  }

  function getDenominationKey(value) {
    const map = {
      100: 'hundreds',
      50: 'fifties',
      20: 'twenties',
      10: 'tens',
      5: 'fives',
      1: 'ones',
      0.25: 'quarters',
      0.10: 'dimes',
      0.05: 'nickels',
      0.01: 'pennies'
    };
    return map[value];
  }

  // ===== CONFIRMATION MODAL BEFORE OVERWRITING =====

  function showConfirmOverwriteAMModal(callback) {
    const modal = document.createElement('div');
    modal.id = 'confirmOverwriteModal';
    modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; z-index: 10000;';

    modal.innerHTML = `
      <div style="background: white; padding: 40px; max-width: 500px; width: 90%; border: 3px solid var(--error-border);">
        <h3 style="margin: 0 0 15px 0; font-size: 20px; font-weight: 700; color: var(--error-text); text-transform: uppercase; letter-spacing: 1px;">‚ö†Ô∏è CONFIRM OVERWRITE</h3>
        <p style="margin-bottom: 20px; color: var(--gray-700); font-size: 15px; line-height: 1.6;">
          You are about to <strong>overwrite</strong> the existing AM cash count that was already submitted today.
        </p>
        <p style="margin-bottom: 25px; color: var(--error-text); font-size: 14px; font-weight: 600;">
          This will replace the morning baseline in the database. Are you sure you want to proceed?
        </p>
        <div style="display: flex; gap: 12px;">
          <button onclick="closeConfirmOverwriteModal()" style="flex: 1; padding: 16px; background: var(--gray-100); border: 2px solid var(--gray-300); color: var(--gray-900); font-size: 14px; font-weight: 700; cursor: pointer; text-transform: uppercase; letter-spacing: 0.5px;">Cancel</button>
          <button onclick="confirmOverwrite()" style="flex: 1; padding: 16px; background: var(--error-border); border: 2px solid var(--error-border); color: white; font-size: 14px; font-weight: 700; cursor: pointer; text-transform: uppercase; letter-spacing: 0.5px;">Yes, Overwrite</button>
        </div>
      </div>
    `;

    document.body.appendChild(modal);

    // Store callback globally
    window.overwriteCallback = callback;
  }

  function closeConfirmOverwriteModal() {
    const modal = document.getElementById('confirmOverwriteModal');
    if (modal) modal.remove();
    window.overwriteCallback = null;
  }

  function confirmOverwrite() {
    // Save callback BEFORE closing modal (which clears it)
    const callback = window.overwriteCallback;
    closeConfirmOverwriteModal();
    if (callback) {
      callback();
    }
  }

  async function loadCashFlowByTime() {
    // CRITICAL: Check if AM data already exists for today
    const today = getPacificDate();
    console.log(`üîç Checking for existing AM data for: ${today}`);

    const existingAMData = await getAMData(today);

    if (existingAMData) {
      console.log('‚úÖ AM data found for today - automatically loading PM flow');
      console.log('üìä AM Data:', existingAMData);
      await startPMCountWithEditLink();
      return;
    }

    console.log('üìù No AM data found - using time-based flow');

    // Get Pacific time
    const now = new Date();
    const pacificTime = new Date(now.toLocaleString('en-US', { timeZone: 'America/Los_Angeles' }));
    const hour = pacificTime.getHours();
    const minutes = pacificTime.getMinutes();

    console.log(`Smart Cash Flow: Current time is ${hour}:${minutes.toString().padStart(2, '0')} PT`);
    console.log(`Pacific time object:`, pacificTime);

    // 6AM-7PM (06:00-19:00): AM Count
    if (hour >= 6 && hour < 19) {
      console.log('‚úÖ Loading AM Count (6AM-7PM window)');
      startAMCount();
    }
    // 7PM-2AM (19:00-02:00): PM Close
    else if (hour >= 19 || hour < 2) {
      console.log('‚úÖ Loading PM Close (7PM-2AM window)');
      startPMCount();
    }
    // 2AM-6AM: No flow available
    else {
      console.log('‚è∞ No cash flow available (2AM-6AM window)');
      showMessage('Cash counting is not available at this time. Please try between 6:00 AM and 2:00 AM Pacific Time.', 'error');
    }
  }

  // ===== MANUAL CASH FLOW NAVIGATION =====
  // Detect hash fragments from WATCHDOG manual buttons
  document.addEventListener('DOMContentLoaded', function() {
    const hash = window.location.hash;

    if (hash === '#am-count') {
      console.log('Manual AM Count triggered via hash');
      window.location.hash = ''; // Clear hash to prevent repeated triggers
      startSmartCashFlowManual('am');
    } else if (hash === '#pm-count') {
      console.log('Manual PM Count triggered via hash');
      window.location.hash = ''; // Clear hash to prevent repeated triggers
      startSmartCashFlowManual('pm');
    }
  });

  function startSmartCashFlowManual(flowType) {
    // Check if session is valid
    if (isCashSessionValid()) {
      // Session valid, proceed directly
      if (flowType === 'am') {
        startAMCount();
      } else {
        startPMCount();
      }
      return;
    }

    // No valid session, show password modal with manual flow type
    showCashPasswordModalManual(flowType);
  }

  function showCashPasswordModalManual(flowType) {
    const flowName = flowType === 'am' ? 'AM Count (Morning Baseline)' : 'PM Count (Evening Close)';
    const modal = document.createElement('div');
    modal.id = 'cashPasswordModal';
    modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10000;';

    modal.innerHTML = `
      <div style="background: white; padding: 40px; border-radius: 0; border: 3px solid var(--gray-700); max-width: 400px; width: 90%;">
        <h3 style="margin: 0 0 20px 0; font-size: 18px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;">Manual Cash Flow Access</h3>
        <p style="margin-bottom: 20px; color: var(--gray-700); font-size: 13px;">Enter password to access <strong>${flowName}</strong>:</p>
        <input type="password" id="cashPasswordInput" placeholder="Enter password" style="width: 100%; padding: 12px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 14px; margin-bottom: 20px; box-sizing: border-box;" />
        <div style="display: flex; gap: 12px;">
          <button onclick="closeCashPasswordModal()" style="flex: 1; padding: 12px 24px; background: var(--gray-100); border: 2px solid var(--gray-300); color: var(--gray-900); font-size: 13px; font-weight: 700; cursor: pointer; text-transform: uppercase; letter-spacing: 0.5px;">Cancel</button>
          <button onclick="verifyCashPasswordManual('${flowType}')" style="flex: 1; padding: 12px 24px; background: var(--gray-900); border: 2px solid var(--gray-900); color: white; font-size: 13px; font-weight: 700; cursor: pointer; text-transform: uppercase; letter-spacing: 0.5px;">Submit</button>
        </div>
      </div>
    `;

    document.body.appendChild(modal);

    setTimeout(() => {
      document.getElementById('cashPasswordInput').focus();
    }, 100);

    document.getElementById('cashPasswordInput').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        verifyCashPasswordManual(flowType);
      }
    });
  }

  function verifyCashPasswordManual(flowType) {
    const input = document.getElementById('cashPasswordInput');
    if (!input) {
      console.error('Cash password input not found');
      return;
    }

    const password = input.value;

    if (password === CASH_PASSWORD) {
      setCashSession();
      closeCashPasswordModal();

      // Load specified flow
      if (flowType === 'am') {
        startAMCount();
      } else {
        startPMCount();
      }
    } else {
      showMessage('Incorrect password. Access denied.', 'error');
      closeCashPasswordModal();
    }
  }

  function showReports() {
    // Keep main menu visible at top
    hideAllSections();
    document.getElementById('reportsForm').classList.add('active');
  }
  
  function showTipPool() {
    // Keep main menu visible at top
    hideAllSections();
    document.getElementById('tipPoolForm').classList.add('active');
    
    // Show results if we have loaded data
    if (tipPoolRecords.length > 0) {
      document.getElementById('tipPoolResults').style.display = 'block';
      document.getElementById('tipPoolPdfBtn').style.display = 'inline-block';
      document.getElementById('combinedReportSection').style.display = 'block';
    }
  }
  
  // ===== CASHBOX FUNCTIONS =====
  
  function showCashbox() {
    // Keep main menu visible at top
    hideAllSections();
    document.getElementById('cashboxSection').classList.add('active');
    loadPreviousCashboxData();
  }
  
  function toggleCashboxDenominationInputs() {
    const counterSelect = document.getElementById('cashboxCounter');
    const otherNameGroup = document.getElementById('cashboxOtherNameGroup');
    const denominationInputs = document.getElementById('cashboxDenominationInputs');
    
    if (counterSelect.value === 'Other') {
      otherNameGroup.style.display = 'block';
    } else {
      otherNameGroup.style.display = 'none';
    }
    
    if (counterSelect.value && counterSelect.value !== '') {
      denominationInputs.style.display = 'block';
    } else {
      denominationInputs.style.display = 'none';
    }
  }
  
  function calculateCashboxTotal() {
    const denominations = [
      { id: 'cashbox_hundreds', value: 100 },
      { id: 'cashbox_fifties', value: 50 },
      { id: 'cashbox_twenties', value: 20 },
      { id: 'cashbox_tens', value: 10 },
      { id: 'cashbox_fives', value: 5 },
      { id: 'cashbox_ones', value: 1 },
      { id: 'cashbox_quarters', value: 0.25 },
      { id: 'cashbox_dimes', value: 0.10 },
      { id: 'cashbox_nickels', value: 0.05 },
      { id: 'cashbox_pennies', value: 0.01 }
    ];
    
    let total = 0;
    denominations.forEach(denom => {
      const count = parseInt(document.getElementById(denom.id).value) || 0;
      total += count * denom.value;
    });
    
    document.getElementById('cashboxTotal').textContent = `$${total.toFixed(2)}`;
    return total;
  }
  
  async function loadPreviousCashboxData() {
    try {
      // Get the most recent cashbox count for reconciliation
      const { data, error } = await supabase
        .from('cashbox_counts')
        .select('*')
        .order('date', { ascending: false })
        .limit(1);
      
      if (error) throw error;
      
      if (data && data.length > 0) {
        const lastCount = data[0];
        showReconciliation(lastCount);
      }
    } catch (error) {
      console.error('Error loading previous cashbox data:', error);
    }
  }
  
  function showReconciliation(lastCount) {
    const reconciliationSection = document.getElementById('cashboxReconciliation');
    const reconciliationDetails = document.getElementById('reconciliationDetails');

    const lastDate = new Date(lastCount.date).toLocaleDateString();
    const lastAmount = lastCount.total;

    reconciliationDetails.innerHTML = `
      <div style="margin-bottom: 10px;">
        <strong>Previous Cashbox Count:</strong> ${lastDate} - $${lastAmount.toFixed(2)}
      </div>
      <div style="margin-bottom: 10px; font-size: 12px; color: #856404;">
        <strong>Reconciliation Logic:</strong><br>
        Expected This Week = Previous Week + Daily Discrepancies<br>
        <em>Note: AM register loading amounts do not affect total cashbox reconciliation</em>
      </div>
      <div style="font-size: 12px; color: #856404;">
        After entering your count, we'll calculate discrepancies and verify reconciliation.
      </div>
    `;

    reconciliationSection.style.display = 'block';
  }

  // Tip Pool Cashbox Functions (separate from main cashbox counting)
  function toggleTipPoolCashboxInputs() {
    const counterSelect = document.getElementById('tipPoolCashboxCounter');
    const otherNameGroup = document.getElementById('tipPoolCashboxOtherNameGroup');
    const denominationInputs = document.getElementById('tipPoolCashboxDenominationInputs');

    if (counterSelect.value === 'Other') {
      otherNameGroup.style.display = 'block';
    } else {
      otherNameGroup.style.display = 'none';
    }

    if (counterSelect.value && counterSelect.value !== '') {
      denominationInputs.style.display = 'block';
    } else {
      denominationInputs.style.display = 'none';
    }
  }

  function calculateTipPoolCashboxTotal() {
    const denominations = [
      { id: 'tipPool_cashbox_hundreds', value: 100 },
      { id: 'tipPool_cashbox_fifties', value: 50 },
      { id: 'tipPool_cashbox_twenties', value: 20 },
      { id: 'tipPool_cashbox_tens', value: 10 },
      { id: 'tipPool_cashbox_fives', value: 5 },
      { id: 'tipPool_cashbox_ones', value: 1 },
      { id: 'tipPool_cashbox_quarters', value: 0.25 },
      { id: 'tipPool_cashbox_dimes', value: 0.10 },
      { id: 'tipPool_cashbox_nickels', value: 0.05 },
      { id: 'tipPool_cashbox_pennies', value: 0.01 }
    ];

    let total = 0;
    denominations.forEach(denom => {
      const count = parseInt(document.getElementById(denom.id).value) || 0;
      total += count * denom.value;
    });

    document.getElementById('tipPoolCashboxTotal').textContent = `$${total.toFixed(2)}`;
    return total;
  }

  function getTipPoolCashboxData() {
    // Get counter name
    const counterSelect = document.getElementById('tipPoolCashboxCounter');
    let counterName = counterSelect.value;

    if (counterName === 'Other') {
      counterName = document.getElementById('tipPoolCashboxOtherName').value;
    }

    // If no counter selected, return null (optional feature)
    if (!counterName) {
      return null;
    }

    // Get total
    const total = calculateTipPoolCashboxTotal();

    // If total is 0, return null
    if (total === 0) {
      return null;
    }

    // Get denominations
    const denominations = {
      hundreds: parseInt(document.getElementById('tipPool_cashbox_hundreds').value) || 0,
      fifties: parseInt(document.getElementById('tipPool_cashbox_fifties').value) || 0,
      twenties: parseInt(document.getElementById('tipPool_cashbox_twenties').value) || 0,
      tens: parseInt(document.getElementById('tipPool_cashbox_tens').value) || 0,
      fives: parseInt(document.getElementById('tipPool_cashbox_fives').value) || 0,
      ones: parseInt(document.getElementById('tipPool_cashbox_ones').value) || 0,
      quarters: parseInt(document.getElementById('tipPool_cashbox_quarters').value) || 0,
      dimes: parseInt(document.getElementById('tipPool_cashbox_dimes').value) || 0,
      nickels: parseInt(document.getElementById('tipPool_cashbox_nickels').value) || 0,
      pennies: parseInt(document.getElementById('tipPool_cashbox_pennies').value) || 0
    };

    return {
      counter: counterName,
      total: total,
      denominations: denominations,
      date: getPacificDate()
    };
  }

  async function saveCashboxCountFromTipPool(cashboxData) {
    try {
      console.log('üíæ Saving cashbox count from tip pool:', cashboxData);

      // Save to database
      const { data, error } = await supabase
        .from('cashbox_counts')
        .insert([{
          date: cashboxData.date,
          counter: cashboxData.counter,
          total: cashboxData.total,
          denominations: cashboxData.denominations,
          notes: 'Entered from tip pool calculator'
        }]);

      if (error) {
        // Check if it's a duplicate date error
        if (error.code === '23505') {
          console.log('‚ö†Ô∏è Cashbox count already exists for this date, updating instead...');
          const { data: updateData, error: updateError } = await supabase
            .from('cashbox_counts')
            .update({
              counter: cashboxData.counter,
              total: cashboxData.total,
              denominations: cashboxData.denominations,
              notes: 'Updated from tip pool calculator'
            })
            .eq('date', cashboxData.date);

          if (updateError) throw updateError;
          console.log('‚úÖ Cashbox count updated successfully');
        } else {
          throw error;
        }
      } else {
        console.log('‚úÖ Cashbox count saved successfully');
      }

      return cashboxData.total;
    } catch (error) {
      console.error('‚ùå Error saving cashbox count:', error);
      throw error;
    }
  }

  async function saveCashboxCount() {
    try {
      const counterSelect = document.getElementById('cashboxCounter');
      const otherName = document.getElementById('cashboxOtherName').value;
      
      let counterName = counterSelect.value;
      if (counterName === 'Other') {
        counterName = otherName;
      }
      
      if (!counterName) {
        throw new Error('Please select or enter a name');
      }
      
      const total = calculateCashboxTotal();
      if (total === 0) {
        throw new Error('Please enter denomination counts');
      }
      
      const denominations = {
        hundreds: parseInt(document.getElementById('cashbox_hundreds').value) || 0,
        fifties: parseInt(document.getElementById('cashbox_fifties').value) || 0,
        twenties: parseInt(document.getElementById('cashbox_twenties').value) || 0,
        tens: parseInt(document.getElementById('cashbox_tens').value) || 0,
        fives: parseInt(document.getElementById('cashbox_fives').value) || 0,
        ones: parseInt(document.getElementById('cashbox_ones').value) || 0,
        quarters: parseInt(document.getElementById('cashbox_quarters').value) || 0,
        dimes: parseInt(document.getElementById('cashbox_dimes').value) || 0,
        nickels: parseInt(document.getElementById('cashbox_nickels').value) || 0,
        pennies: parseInt(document.getElementById('cashbox_pennies').value) || 0
      };
      
      const { data, error } = await supabase
        .from('cashbox_counts')
        .insert([{
          date: getPacificDate(),
          counter: counterName,
          denominations: denominations,
          total: total,
          timestamp: new Date().toISOString()
        }]);
      
      if (error) throw error;
      
      showMessage(`Cashbox count saved successfully! Total: $${total.toFixed(2)}`, 'success');
      
      // Reset form
      document.getElementById('cashboxCounter').value = '';
      document.getElementById('cashboxOtherName').value = '';
      toggleCashboxDenominationInputs();
      
      // Reset all denomination inputs
      Object.keys(denominations).forEach(key => {
        document.getElementById(`cashbox_${key}`).value = '0';
      });
      calculateCashboxTotal();
      
    } catch (error) {
      showMessage(error.message, 'error');
    }
  }
  
  async function saveCashboxCountFromReport(total) {
    try {
      const counterName = tipPoolSummary.calculatedByName || 'Unknown';
      
      const { data, error } = await supabase
        .from('cashbox_counts')
        .insert([{
          date: getPacificDate(),
          counter: counterName,
          denominations: { manual_entry: true }, // Mark as manual entry from report
          total: total,
          timestamp: new Date().toISOString(),
          notes: 'Entered during combined report generation'
        }]);
      
      if (error) throw error;
      
      console.log('Cashbox count saved from report:', total);
      
    } catch (error) {
      console.error('Error saving cashbox count from report:', error);
    }
  }
  
  async function getCashboxReconciliation(currentTotal) {
    try {
      // Get the two most recent cashbox counts for comparison
      const { data, error } = await supabase
        .from('cashbox_counts')
        .select('*')
        .order('date', { ascending: false })
        .limit(2);
      
      if (error) throw error;
      
      if (!data || data.length === 0) {
        return {
          isFirstCount: true,
          currentTotal: currentTotal,
          message: 'First cashbox count recorded - baseline established'
        };
      }
      
      if (data.length === 1) {
        return {
          isFirstCount: true,
          currentTotal: currentTotal,
          previousTotal: null,
          message: 'Second cashbox count - reconciliation will begin next week'
        };
      }
      
      const current = data[0]; // Most recent (just saved)
      const previous = data[1]; // Previous week
      
      // Get date range for daily discrepancies between the two cashbox counts
      const startDate = new Date(previous.date);
      const endDate = new Date(current.date);
      
      // Fetch daily cash count data for the period (need more fields for Excess calculation)
      const { data: discrepancyData, error: discrepancyError } = await supabase
        .from('cash_counts')
        .select('pm_discrepancy, pm_amount_to_keep, am_total, date')
        .gte('date', previous.date)
        .lt('date', current.date) // Use < to exclude current date
        .not('pm_discrepancy', 'is', null)
        .order('date', { ascending: true });

      if (discrepancyError) throw discrepancyError;

      // Calculate total discrepancies for the period
      const totalDiscrepancies = discrepancyData ?
        discrepancyData.reduce((sum, day) => sum + (day.pm_discrepancy || 0), 0) : 0;

      // CRITICAL FIX: Calculate total Excess returned to cashbox
      // Excess = Net change to cashbox each day (what went back in minus what came out)
      // Formula: (pm_amount_to_keep) - (am_total)
      // Positive excess = cash returned to box, Negative excess = cash taken from box
      const totalExcessReturned = discrepancyData ?
        discrepancyData.reduce((sum, day) => {
          const pmKeep = day.pm_amount_to_keep || 0;
          const amTotal = day.am_total || 0;
          const dailyExcess = pmKeep - amTotal;
          return sum + dailyExcess;
        }, 0) : 0;

      console.log('üìä Cashbox Reconciliation Breakdown:');
      console.log(`   Previous Week Total: $${previous.total.toFixed(2)}`);
      console.log(`   Total Discrepancies: $${totalDiscrepancies.toFixed(2)}`);
      console.log(`   Total Excess Returned: $${totalExcessReturned.toFixed(2)}`);

      // CORRECT RECONCILIATION FORMULA (FIXED):
      // Week_N_Ending_Cashbox = Week_N_Starting_Cashbox + Sum(Daily_Discrepancies) + Sum(Daily_Excess)
      // This accounts for BOTH daily over/under AND actual cash flow in/out of cashbox
      const expectedEnding = previous.total + totalDiscrepancies + totalExcessReturned;
      const actualVariance = currentTotal - expectedEnding;

      console.log(`   Expected Ending: $${expectedEnding.toFixed(2)}`);
      console.log(`   Actual Ending: $${currentTotal.toFixed(2)}`);
      console.log(`   Variance: $${actualVariance.toFixed(2)}`);
      
      return {
        isFirstCount: false,
        currentTotal: currentTotal,
        currentDate: new Date(current.date).toLocaleDateString(),
        previousTotal: previous.total,
        previousDate: new Date(previous.date).toLocaleDateString(),
        totalDiscrepancies: totalDiscrepancies,
        totalExcessReturned: totalExcessReturned, // NEW: Include Excess in return object
        expectedEnding: expectedEnding,
        actualVariance: actualVariance,
        discrepancyDays: discrepancyData ? discrepancyData.length : 0,
        reconciliationStatus: Math.abs(actualVariance) < 0.01 ? 'BALANCED' :
                             actualVariance > 0 ? 'OVERAGE' : 'SHORTAGE',
        message: Math.abs(actualVariance) < 0.01 ?
                'Perfect reconciliation! Cashbox balances correctly.' :
                actualVariance > 0 ?
                `Unexplained overage of $${actualVariance.toFixed(2)}` :
                `Unexplained shortage of $${Math.abs(actualVariance).toFixed(2)}`
      };
      
    } catch (error) {
      console.error('Error getting cashbox reconciliation:', error);
      return null;
    }
  }

  // ==================== VOICE RECOGNITION FUNCTIONS ====================

  let voiceRecognition = null;
  let isListening = false;

  function startVoiceInput(shift, drawer) {
    // Check browser support
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

    if (!SpeechRecognition) {
      showMessage('Voice recognition is not supported in this browser. Please use Chrome, Edge, or Safari.', 'error');
      return;
    }

    // Check if counter name is selected
    const counterSelect = document.getElementById(`${shift}Counter`);
    if (!counterSelect || !counterSelect.value.trim()) {
      showMessage('Please select a counter name first.', 'warning');
      return;
    }

    // Check if drawer is skipped
    const skipBox = document.getElementById(`${shift}Drawer${drawer}Skip`);
    if (skipBox && skipBox.checked) {
      showMessage('Cannot use voice input on a skipped drawer. Uncheck "Skip Drawer" first.', 'warning');
      return;
    }

    // Initialize recognition
    voiceRecognition = new SpeechRecognition();
    voiceRecognition.continuous = false; // Stop after one result
    voiceRecognition.interimResults = false; // Only final results
    voiceRecognition.lang = 'en-US';

    // Show listening indicator
    const button = event.target.closest('button');
    const originalText = button.innerHTML;
    button.innerHTML = 'üî¥ Listening...';
    button.style.background = '#D32F2F'; // Red to indicate recording
    button.disabled = true;
    isListening = true;

    voiceRecognition.onresult = (event) => {
      const transcript = event.results[0][0].transcript.toLowerCase();
      console.log('Voice transcript:', transcript);

      // Parse denominations from speech
      const parsedDenoms = parseDenominations(transcript);

      // Populate denomination inputs
      let successCount = 0;
      Object.keys(parsedDenoms).forEach(denomName => {
        const qty = parsedDenoms[denomName];
        const denomIndex = getDenominationIndex(denomName);

        if (denomIndex !== -1) {
          const inputId = `${shift}D${drawer}Q${denomIndex}`;
          const input = document.getElementById(inputId);
          if (input) {
            input.value = qty;
            successCount++;
          }
        }
      });

      // Update calculations
      updateCalculations(shift, drawer);

      // Show success message
      if (successCount > 0) {
        showMessage(`‚úì Voice input successful! Populated ${successCount} denomination${successCount > 1 ? 's' : ''}.`, 'success');
      } else {
        showMessage('No denominations recognized. Try saying: "3 twenties, 2 tens, 10 fives"', 'warning');
      }
    };

    voiceRecognition.onerror = (event) => {
      console.error('Voice recognition error:', event.error);
      let errorMsg = 'Voice recognition error: ';

      switch(event.error) {
        case 'not-allowed':
        case 'service-not-allowed':
          errorMsg += 'Microphone permission denied. Please allow microphone access in browser settings.';
          break;
        case 'no-speech':
          errorMsg += 'No speech detected. Please try again.';
          break;
        case 'network':
          errorMsg += 'Network error. Check your internet connection.';
          break;
        default:
          errorMsg += event.error;
      }

      showMessage(errorMsg, 'error');
    };

    voiceRecognition.onend = () => {
      // Reset button
      button.innerHTML = originalText;
      button.style.background = 'var(--primary-blue)';
      button.disabled = false;
      isListening = false;
    };

    // Start listening
    try {
      voiceRecognition.start();
      showMessage('üé§ Listening... Say denominations like: "3 twenties, 2 tens, 10 fives"', 'info');
    } catch (error) {
      console.error('Failed to start voice recognition:', error);
      button.innerHTML = originalText;
      button.style.background = 'var(--primary-blue)';
      button.disabled = false;
      isListening = false;
      showMessage('Failed to start voice recognition. Please try again.', 'error');
    }
  }

  function parseDenominations(transcript) {
    const result = {};

    // Denomination patterns (with various spellings/pronunciations)
    const patterns = {
      hundreds: /(\d+)\s*(hundreds?|hundred dollar bills?|100s?|100 dollar)/gi,
      fifties: /(\d+)\s*(fifties|fifty dollar bills?|50s?|50 dollar)/gi,
      twenties: /(\d+)\s*(twenties|twenty dollar bills?|20s?|20 dollar)/gi,
      tens: /(\d+)\s*(tens?|ten dollar bills?|10s?|10 dollar)/gi,
      fives: /(\d+)\s*(fives?|five dollar bills?|5s?|5 dollar)/gi,
      ones: /(\d+)\s*(ones?|one dollar bills?|1s?|1 dollar|singles?)/gi,
      quarters: /(\d+)\s*(quarters?|quarter dollars?)/gi,
      dimes: /(\d+)\s*(dimes?)/gi,
      nickels: /(\d+)\s*(nickels?)/gi,
      pennies: /(\d+)\s*(pennies|penny|cents?)/gi
    };

    // Extract quantities for each denomination
    Object.keys(patterns).forEach(denomName => {
      const matches = [...transcript.matchAll(patterns[denomName])];
      if (matches.length > 0) {
        // Use the last match if multiple found
        const qty = parseInt(matches[matches.length - 1][1]);
        if (!isNaN(qty) && qty >= 0) {
          result[denomName] = qty;
        }
      }
    });

    return result;
  }

  function getDenominationIndex(denomName) {
    // Map denomination names to DENOMINATIONS array indices
    const mapping = {
      'hundreds': 0,
      'fifties': 1,
      'twenties': 2,
      'tens': 3,
      'fives': 4,
      'ones': 5,
      'quarters': 6,
      'dimes': 7,
      'nickels': 8,
      'pennies': 9
    };

    return mapping[denomName] !== undefined ? mapping[denomName] : -1;
  }

  function showMessage(message, type = 'info') {
    const messageArea = document.getElementById('messageArea');
    if (!messageArea) return;

    const colors = {
      success: { bg: '#d1fae5', border: '#059669', text: '#065f46' },
      error: { bg: '#fee2e2', border: '#dc2626', text: '#991b1b' },
      warning: { bg: '#fef3c7', border: '#f59e0b', text: '#92400e' },
      info: { bg: '#dbeafe', border: '#1e40af', text: '#1e40af' }
    };

    const color = colors[type] || colors.info;

    messageArea.innerHTML = `
      <div style="background: ${color.bg}; border: 2px solid ${color.border}; padding: 12px; margin: 12px 0; border-radius: 0; color: ${color.text}; font-weight: 600; font-size: 13px;">
        ${message}
      </div>
    `;

    // Auto-hide after 5 seconds for success/info messages
    if (type === 'success' || type === 'info') {
      setTimeout(() => {
        if (messageArea.innerHTML.includes(message)) {
          messageArea.innerHTML = '';
        }
      }, 5000);
    }
  }

  // ==================== END VOICE RECOGNITION FUNCTIONS ====================

  function setupDenominations(shift) {
    [1, 2].forEach(drawer => {
      const container = document.getElementById(`${shift}Drawer${drawer}Denoms`);
      container.innerHTML = '';
      
      DENOMINATIONS.forEach((denom, index) => {
        const row = document.createElement('div');
        row.className = 'denom-row';
        row.innerHTML = `
          <div>
            <div class="denom-label">${denom.label}</div>
            <div class="denom-value" id="${shift}D${drawer}V${index}">0 √ó $${denom.value.toFixed(2)} = $0.00</div>
          </div>
          <input type="number" class="qty-input" id="${shift}D${drawer}Q${index}" 
                 min="0" step="1" value="0" 
                 inputmode="numeric" pattern="[0-9]*"
                 oninput="updateCalculations('${shift}', ${drawer})" 
                 onfocus="this.select()">
        `;
        container.appendChild(row);
      });
    });
    
    // Apply disabled state based on current name selection
    toggleDenominationInputs(shift);
  }
  
  function toggleSkip(shift, drawer) {
    const skipBox = document.getElementById(`${shift}Drawer${drawer}Skip`);
    const content = document.getElementById(`${shift}Drawer${drawer}Content`);
    const skipContent = document.getElementById(`${shift}Drawer${drawer}SkipContent`);
    
    if (skipBox.checked) {
      content.classList.add('hidden');
      skipContent.classList.remove('hidden');
    } else {
      content.classList.remove('hidden');
      skipContent.classList.add('hidden');
    }
    updateCalculations(shift, drawer);
  }
  
  function toggleDenominationInputs(shift) {
    const counterSelect = document.getElementById(`${shift}Counter`);
    if (!counterSelect) return; // Safety check
    
    const hasName = counterSelect.value.trim() !== '';
    
    // Toggle denomination inputs for both drawers
    for (let drawer = 1; drawer <= 2; drawer++) {
      DENOMINATIONS.forEach((denom, index) => {
        const qtyInput = document.getElementById(`${shift}D${drawer}Q${index}`);
        if (!qtyInput) return; // Safety check
        
        const denomRow = qtyInput.closest('.denom-row');
        if (!denomRow) return; // Safety check
        
        if (hasName) {
          qtyInput.disabled = false;
          denomRow.classList.remove('disabled');
        } else {
          qtyInput.disabled = true;
          qtyInput.value = ''; // Clear any existing values
          denomRow.classList.add('disabled');
        }
      });
      
      // Update calculations after enabling/disabling
      updateCalculations(shift, drawer);
    }
  }
  
  function updateCalculations(shift, drawer) {
    const skipBox = document.getElementById(`${shift}Drawer${drawer}Skip`);
    let drawerTotal = 0;
    
    if (!skipBox.checked) {
      DENOMINATIONS.forEach((denom, index) => {
        const qtyInput = document.getElementById(`${shift}D${drawer}Q${index}`);
        const qty = parseInt(qtyInput.value) || 0;
        const value = qty * denom.value;
        
        document.getElementById(`${shift}D${drawer}V${index}`).textContent = 
          `${qty} √ó $${denom.value.toFixed(2)} = $${value.toFixed(2)}`;
        
        drawerTotal += value;
      });
    }
    
    document.getElementById(`${shift}Drawer${drawer}Total`).textContent = `$${drawerTotal.toFixed(2)}`;
    updateGrandTotal(shift);
  }
  
  function updateGrandTotal(shift) {
    const drawer1Skip = document.getElementById(`${shift}Drawer1Skip`).checked;
    const drawer2Skip = document.getElementById(`${shift}Drawer2Skip`).checked;
    
    const drawer1Total = drawer1Skip ? 0 : parseFloat(document.getElementById(`${shift}Drawer1Total`).textContent.replace('$', ''));
    const drawer2Total = drawer2Skip ? 0 : parseFloat(document.getElementById(`${shift}Drawer2Total`).textContent.replace('$', ''));
    
    const grandTotal = drawer1Total + drawer2Total;
    document.getElementById(`${shift}GrandTotal`).textContent = `$${grandTotal.toFixed(2)}`;
    
    // Add discrepancy validation for PM shift only
    if (shift === 'pm') {
      validatePMDiscrepancy(grandTotal);
    }
  }

  function validatePMDiscrepancy(pmTotal) {
    const discrepancySection = document.getElementById('discrepancySection');
    const discrepancyDisplay = document.getElementById('discrepancyDisplay');
    
    // Get AM total and Toast sales
    const amTotalText = document.getElementById('pmAmTotal').textContent;
    const toastSales = autoCalculatedToastAmount || 0;
    
    // Only validate if we have all necessary data
    if (!amTotalText || amTotalText === 'Loading...' || amTotalText === 'Please select a date' || toastSales === 0) {
      discrepancySection.style.display = 'none';
      return;
    }
    
    const amTotal = parseFloat(amTotalText.replace('$', '').replace(',', '')) || 0;
    const netCashChange = pmTotal - amTotal; // This should equal Toast sales
    const discrepancy = netCashChange - toastSales;
    const absDiscrepancy = Math.abs(discrepancy);
    
    // Show the section
    discrepancySection.style.display = 'block';
    
    // Determine warning level and styling
    let borderColor, backgroundColor, textColor, warningLevel, warningMessage, warningIcon;
    
    if (absDiscrepancy <= 3) {
      // Good - within $3
      borderColor = '#28a745';
      backgroundColor = '#d4edda';
      textColor = '#155724';
      warningLevel = 'GOOD';
      warningMessage = 'Cash count matches Toast sales within acceptable range.';
      warningIcon = '';
    } else if (absDiscrepancy <= 10) {
      // Warning - $3-$10
      borderColor = '#ffc107';
      backgroundColor = '#fff3cd';
      textColor = '#856404';
      warningLevel = 'SUGGESTION';
      warningMessage = 'Consider recounting your cash to ensure accuracy, but you may proceed if confident.';
      warningIcon = '';
    } else {
      // Severe - over $10
      borderColor = '#dc3545';
      backgroundColor = '#f8d7da';
      textColor = '#721c24';
      warningLevel = 'IMPORTANT';
      warningMessage = 'Significant discrepancy detected. Please recount everything carefully or confirm you want to proceed.';
      warningIcon = '';
    }
    
    // Add recount notice for any discrepancy above $3
    let recountNotice = '';
    if (absDiscrepancy > 3) {
      recountNotice = `<div style="background: rgba(23, 162, 184, 0.1); padding: 10px; border-radius: 0; font-size: 13px; margin-top: 10px; border-left: 3px solid #17a2b8;">
        <strong>üí° Tip:</strong> Please recount your drawers, and if you still have a discrepancy, try to press the <strong>"RETRY"</strong> button above to make sure Toast Cash Sales are up to date.
      </div>`;
    }

    // Add special message for negative discrepancies
    let negativeWarning = '';
    if (discrepancy < 0) {
      negativeWarning = `<div style="background: rgba(220, 53, 69, 0.1); padding: 8px; border-radius: 0; font-size: 13px; margin-top: 10px;">
        <strong>Cash Tips Impact:</strong> This ${Math.abs(discrepancy).toFixed(2)} shortage will be deducted from cash tips. Please verify your count is accurate.
      </div>`;
    }

    discrepancyDisplay.style.border = `2px solid ${borderColor}`;
    discrepancyDisplay.style.background = backgroundColor;
    discrepancyDisplay.style.color = textColor;

    discrepancyDisplay.innerHTML = `
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <span style="font-weight: 700; font-size: 16px;">${warningIcon} Cash vs Toast Validation</span>
        <span style="background: ${borderColor}; color: white; padding: 6px 12px; border-radius: 0; font-size: 12px; font-weight: 600;">
          ${warningLevel}
        </span>
      </div>

      <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin: 15px 0; text-align: center;">
        <div>
          <div style="font-size: 12px; opacity: 0.8;">Net Cash Change</div>
          <div style="font-size: 24px; font-weight: bold;">$${netCashChange.toFixed(2)}</div>
          <div style="font-size: 11px; opacity: 0.7;">PM Total - AM Total</div>
        </div>
        <div>
          <div style="font-size: 12px; opacity: 0.8;">Toast Sales</div>
          <div style="font-size: 24px; font-weight: bold;">$${toastSales.toFixed(2)}</div>
          <div style="font-size: 11px; opacity: 0.7;">Expected Amount</div>
        </div>
        <div>
          <div style="font-size: 12px; opacity: 0.8;">Discrepancy</div>
          <div style="font-size: 24px; font-weight: bold; color: ${discrepancy >= 0 ? borderColor : '#dc3545'};">
            ${discrepancy >= 0 ? '+' : ''}$${discrepancy.toFixed(2)}
          </div>
          <div style="font-size: 11px; opacity: 0.7;">${discrepancy >= 0 ? 'Overage' : 'Shortage'}</div>
        </div>
      </div>

      <div style="background: rgba(${borderColor === '#28a745' ? '40, 167, 69' : borderColor === '#ffc107' ? '255, 193, 7' : '220, 53, 69'}, 0.1); padding: 10px; border-radius: 0; font-size: 13px; text-align: center;">
        <strong>${warningMessage}</strong>
      </div>

      ${recountNotice}
      ${negativeWarning}
    `;
  }
  
  async function loadAMData() {
    const date = document.getElementById('pmDate').value;
    console.log('Loading AM data for date:', date);
    
    if (!date) {
      document.getElementById('pmAmTotal').textContent = 'Please select a date';
      document.getElementById('amCounterName').textContent = 'Please select a date';
      document.getElementById('amCountTime').textContent = 'Please select a date';
      return;
    }
    
    // Show loading state
    document.getElementById('pmAmTotal').textContent = 'Loading...';
    document.getElementById('amCounterName').textContent = 'Loading...';
    document.getElementById('amCountTime').textContent = 'Loading...';
    
    try {
      if (!supabase) {
        throw new Error('Database not connected');
      }
      
      console.log('Querying Supabase for AM data...');
      const amData = await getAMData(date);
      console.log('AM data result:', amData);
      
      if (amData && amData.total > 0) {
        currentAMData = amData;
        document.getElementById('pmAmTotal').textContent = `$${amData.total.toFixed(2)}`;
        
        // FIX: Set AM counter name and timestamp
        document.getElementById('amCounterName').textContent = amData.counter || 'N/A';
        document.getElementById('amCountTime').textContent = amData.timestamp ? new Date(amData.timestamp).toLocaleString() : 'N/A';
        
        // Handle AM notes display
        const amNotesDisplay = document.getElementById('amNotesDisplay');
        const amNotesEl = document.getElementById('amNotes');
        if (amData.notes && amData.notes.trim()) {
          amNotesEl.textContent = amData.notes;
          amNotesDisplay.style.display = 'block';
        } else {
          amNotesDisplay.style.display = 'none';
        }
        
        // Removed "AM data loaded successfully" message to prevent bouncing
      } else {
        currentAMData = null;
        document.getElementById('pmAmTotal').textContent = 'No AM data found';
        document.getElementById('amCounterName').textContent = 'No AM data found';
        document.getElementById('amCountTime').textContent = 'No AM data found';
        const amNotesDisplay = document.getElementById('amNotesDisplay');
        if (amNotesDisplay) amNotesDisplay.style.display = 'none';
        showMessage(`No AM count found for ${date}`, 'error');
      }
    } catch (error) {
      console.error('Error loading AM data:', error);
      document.getElementById('pmAmTotal').textContent = 'Error loading AM data';
      document.getElementById('amCounterName').textContent = 'Error loading AM data';
      document.getElementById('amCountTime').textContent = 'Error loading AM data';
      showMessage(`Error: ${error.message}`, 'error');
    }
  }
  
  function collectFormData(shift) {
    // Check if we're editing (Editing By dropdown exists)
    const editingBySelect = document.getElementById(`${shift}EditingBy`);
    const counter = editingBySelect && editingBySelect.value
      ? editingBySelect.value
      : document.getElementById(`${shift}Counter`).value;

    const date = document.getElementById(`${shift}Date`).value;
    const notes = document.getElementById(`${shift}Notes`).value.trim();

    if (!counter) throw new Error('Please select a name');
    if (!date) throw new Error('Please select a date');
    
    const drawer1Skip = document.getElementById(`${shift}Drawer1Skip`).checked;
    const drawer2Skip = document.getElementById(`${shift}Drawer2Skip`).checked;
    
    const drawer1Data = collectDrawerData(shift, 1, drawer1Skip);
    const drawer2Data = collectDrawerData(shift, 2, drawer2Skip);
    
    const data = {
      shift: shift,
      counter: counter,
      date: date,
      timestamp: new Date().toISOString(),
      drawer1: drawer1Data,
      drawer2: drawer2Data,
      drawer1Total: drawer1Data.total, // Add individual drawer totals for email template
      drawer2Total: drawer2Data.total,
      notes: notes || null,
      total: drawer1Data.total + drawer2Data.total
    };
    
    if (shift === 'pm') {
      // Use auto-calculated Toast amount (no manual override)
      const toastSales = autoCalculatedToastAmount || 0;
      const cashTips = parseInt(document.getElementById('cashTips').value) || 0;
      
      data.toastSales = toastSales;
      data.cashTips = cashTips;
      data.amTotal = currentAMData ? currentAMData.total : 0;
      
      // Always indicate auto-calculated method
      data.toastSalesMethod = 'auto_calculated';
    }
    
    return data;
  }
  
  function collectDrawerData(shift, drawer, skipped) {
    if (skipped) {
      const reason = document.getElementById(`${shift}Drawer${drawer}Reason`).value.trim();
      return {
        skipped: true,
        skipReason: reason || 'No reason provided',
        counts: {},
        total: 0
      };
    }
    
    const counts = {};
    let total = 0;
    
    // Map denomination labels to email template keys
    const denominationKeys = [
      'hundreds',    // $100
      'fifties',     // $50
      'twenties',    // $20
      'tens',        // $10
      'fives',       // $5
      'ones',        // $1
      'quarters',    // $0.25
      'dimes',       // $0.10
      'nickels',     // $0.05
      'pennies'      // $0.01
    ];
    
    DENOMINATIONS.forEach((denom, index) => {
      const qty = parseInt(document.getElementById(`${shift}D${drawer}Q${index}`).value) || 0;
      // Store with both the original label and the email template key
      counts[denom.label] = qty;
      counts[denominationKeys[index]] = qty;
      total += qty * denom.value;
    });
    
    return {
      skipped: false,
      skipReason: null,
      counts: counts,
      total: Math.round(total * 100) / 100
    };
  }
  
  async function submitAM() {
    try {
      // CRITICAL: Check if we're editing existing data
      if (isEditingExistingAM) {
        console.log('‚ö†Ô∏è Editing existing AM data - showing confirmation modal');

        // Show confirmation modal before proceeding
        showConfirmOverwriteAMModal(async () => {
          // User confirmed - proceed with overwrite
          await performAMSubmit();
        });
      } else {
        // Fresh AM count - no confirmation needed
        await performAMSubmit();
      }

    } catch (error) {
      hideLoading();
      console.error('AM submission error:', error);
      showMessage(`Error: ${error.message}`, 'error');
    }
  }

  async function performAMSubmit() {
    showLoading('Submitting AM Count', 'Recording your morning cash count...');

    const data = collectFormData('am');
    await storeAMData(data);

    // Reset editing flag
    isEditingExistingAM = false;

    // Show elegant success screen
    showAMSuccess(data.total);
    resetForm('am');
  }
  
  async function submitPM() {
    try {
      showLoading('Processing PM Close', 'Calculating totals and sending report to management...');
      
      const data = collectFormData('pm');
      const calculations = calculatePMAmounts(data);
      
      await storePMData(data, calculations);
      await sendEmailReport(data, calculations);
      
      // Show elegant success screen with deposit/return instructions
      showPMSuccess(calculations.depositAmount, calculations.returnAmount, calculations.discrepancy);
      
    } catch (error) {
      hideLoading();
      console.error('PM submission error:', error);
      
      // Check if it's a validation error (these shouldn't reset the form)
      const isValidationError = error.message.includes('Please select') || 
                               error.message.includes('required') ||
                               error.message.includes('name') ||
                               error.message.includes('date');
      
      showMessage(`Error: ${error.message}`, 'error');
      
      // Only redirect home for non-validation errors (like network issues)
      if (!isValidationError) {
        goHome();
      }
    }
  }
  
  function calculatePMAmounts(data) {
    const amTotal = data.amTotal;
    const pmTotal = data.total;
    const toastSales = data.toastSales;
    const cashTips = data.cashTips;
    
    // Drawer change = PM - AM
    const drawerChange = pmTotal - amTotal;
    
    // Actual cash in
    const actualCashIn = drawerChange;
    
    // Expected vs actual (Toast sales vs actual cash in)
    const discrepancy = actualCashIn - toastSales;
    
    // Step 1: Calculate raw deposit amount
    const rawDepositAmount = toastSales + cashTips;
    
    // Step 2: Round deposit to whole dollars (what staff actually deposits)
    const depositAmount = Math.round(rawDepositAmount);
    
    // Step 3: Calculate deposit rounding adjustment needed
    const depositRoundingAdjustment = depositAmount - rawDepositAmount;
    
    // Step 4: Handle deposit rounding with whole dollar tip adjustments
    let depositTipAdjustment = 0;
    let depositExcessToCashbox = 0;
    
    if (depositRoundingAdjustment > 0) {
      // Need extra money for rounding - take whole dollars from tips
      depositTipAdjustment = Math.ceil(depositRoundingAdjustment);
      depositExcessToCashbox = depositTipAdjustment - depositRoundingAdjustment;
    } else if (depositRoundingAdjustment < 0) {
      // Deposit rounded down - staff keeps the rounding benefit
      depositExcessToCashbox = Math.abs(depositRoundingAdjustment);
    }
    
    // Step 5: Handle shortage/overage adjustments with whole dollars
    let shortageTipAdjustment = 0;
    let shortageExcessToCashbox = 0;
    
    if (discrepancy < 0) {
      // SHORTAGE: Take whole dollars from tips to cover shortage
      const shortageAmount = Math.abs(discrepancy);
      shortageTipAdjustment = Math.ceil(shortageAmount);
      shortageExcessToCashbox = shortageTipAdjustment - shortageAmount;
    }
    
    // Step 6: Calculate final tip amounts
    const totalTipAdjustment = depositTipAdjustment + shortageTipAdjustment;
    let finalCashTips = cashTips - totalTipAdjustment;
    
    // Ensure tips don't go negative
    if (finalCashTips < 0) {
      const shortfall = Math.abs(finalCashTips);
      finalCashTips = 0;
      // Add shortfall to what business owes staff (tracked but not paid)
    }
    
    // Final tips are always whole dollars (floor any remaining decimals)
    const adjustedTips = Math.floor(finalCashTips);
    const tipDecimalRemainder = finalCashTips - adjustedTips;
    
    // Step 7: Calculate return amount to cashbox
    let returnAmount = amTotal;
    
    // Add overage to cashbox
    if (discrepancy > 0) {
      returnAmount += discrepancy;
    }
    
    // Add all excess amounts to cashbox
    returnAmount += depositExcessToCashbox + shortageExcessToCashbox + tipDecimalRemainder;
    
    return {
      amTotal,
      pmTotal,
      drawerChange,
      actualCashIn,
      toastSales,
      cashTips, // Original tips reported
      discrepancy,
      tipAdjustment: totalTipAdjustment, // Total amount taken from tips
      adjustedTips, // Final whole dollar tips
      depositAmount, // Rounded deposit amount (what staff deposits)
      returnAmount, // What goes back to cashbox
      drawerOver: discrepancy > 0 ? discrepancy : 0,
      drawerShort: discrepancy < 0 ? Math.abs(discrepancy) : 0,
      restaurantOwed: toastSales, // Exact Toast sales amount
      staffOwed: adjustedTips, // Final tips after adjustment
      // New fields for tracking the logic
      rawDepositAmount, // Original exact deposit amount
      depositRoundingAdjustment, // How much rounding was needed
      depositTipAdjustment, // Whole dollars taken from tips for rounding
      depositExcessToCashbox, // Excess from deposit rounding adjustments
      shortageTipAdjustment, // Whole dollars taken from tips for shortage
      shortageExcessToCashbox, // Excess from shortage adjustments
      tipDecimalRemainder // Decimal remainder from final tip flooring
    };
  }
  
  async function storeAMData(data) {
    if (!supabase) throw new Error('Database not connected');

    const { error } = await supabase
      .from('cash_counts')
      .upsert({
        date: data.date,
        am_counter: data.counter,
        am_timestamp: data.timestamp,
        am_total: data.total,
        am_drawer1_total: data.drawer1.total,
        am_drawer1_skip: data.drawer1.skipped,
        am_drawer1_skip_reason: data.drawer1.skipReason,
        am_drawer1_data: data.drawer1.counts,
        am_drawer2_total: data.drawer2.total,
        am_drawer2_skip: data.drawer2.skipped,
        am_drawer2_skip_reason: data.drawer2.skipReason,
        am_drawer2_data: data.drawer2.counts,
        am_notes: data.notes
      }, {
        onConflict: 'date',
        ignoreDuplicates: false
      });

    if (error) throw new Error(`Database error: ${error.message}`);
  }
  
  async function storePMData(data, calculations) {
    if (!supabase) throw new Error('Database not connected');
    
    const { error } = await supabase
      .from('cash_counts')
      .update({
        pm_counter: data.counter,
        pm_timestamp: data.timestamp,
        pm_total: data.total,
        pm_cash_tips: data.cashTips,
        pm_toast_sales: data.toastSales,
        pm_drawer1_total: data.drawer1.total,
        pm_drawer1_skip: data.drawer1.skipped,
        pm_drawer1_skip_reason: data.drawer1.skipReason,
        pm_drawer1_data: data.drawer1.counts,
        pm_drawer2_total: data.drawer2.total,
        pm_drawer2_skip: data.drawer2.skipped,
        pm_drawer2_skip_reason: data.drawer2.skipReason,
        pm_drawer2_data: data.drawer2.counts,
        pm_notes: data.notes,
        pm_discrepancy: calculations.discrepancy,
        pm_adjusted_tips: calculations.adjustedTips,
        pm_drawer_over_amount: calculations.drawerOver,
        pm_deposit_amount: calculations.depositAmount,
        pm_amount_to_keep: calculations.returnAmount
      })
      .eq('date', data.date);
    
    if (error) throw new Error(`Database error: ${error.message}`);
  }
  
  async function getAMData(date) {
    if (!supabase) return null;

    const { data, error } = await supabase
      .from('cash_counts')
      .select('*')
      .eq('date', date)
      .maybeSingle(); // Use maybeSingle() instead of single() to avoid 406 errors

    if (error || !data || !data.am_total) return null;

    return {
      date: data.date,
      counter: data.am_counter,
      timestamp: data.am_timestamp,
      total: data.am_total,
      drawer1: {
        total: data.am_drawer1_total,
        skipped: data.am_drawer1_skip,
        skipReason: data.am_drawer1_skip_reason,
        counts: data.am_drawer1_data
      },
      drawer2: {
        total: data.am_drawer2_total,
        skipped: data.am_drawer2_skip,
        skipReason: data.am_drawer2_skip_reason,
        counts: data.am_drawer2_data
      },
      notes: data.am_notes
    };
  }

  async function getPMData(date) {
    if (!supabase) return null;

    const { data, error } = await supabase
      .from('cash_counts')
      .select('*')
      .eq('date', date)
      .maybeSingle();

    if (error || !data || !data.pm_total) return null;

    return {
      date: data.date,
      counter: data.pm_counter,
      timestamp: data.pm_timestamp,
      total: data.pm_total,
      deposit_amount: data.pm_deposit_amount,
      cash_tips: data.pm_cash_tips,
      drawer1: {
        total: data.pm_drawer1_total,
        skipped: data.pm_drawer1_skip,
        skipReason: data.pm_drawer1_skip_reason,
        counts: data.pm_drawer1_data
      },
      drawer2: {
        total: data.pm_drawer2_total,
        skipped: data.pm_drawer2_skip,
        skipReason: data.pm_drawer2_skip_reason,
        counts: data.pm_drawer2_data
      },
      notes: data.pm_notes
    };
  }

  async function sendEmailReport(data, calculations) {
    // Format date with day of the week
    const dateObj = new Date(data.date + 'T00:00:00');
    const dayOfWeek = dateObj.toLocaleDateString('en-US', { weekday: 'long' }).toUpperCase();
    const formattedDate = dateObj.toLocaleDateString('en-US', { 
      year: 'numeric', 
      month: 'long', 
      day: 'numeric' 
    }).toUpperCase();
    
    const templateParams = {
      to_email: EMAILJS_CONFIG.MANAGER_EMAIL,
      date: data.date,
      day_of_week: dayOfWeek,
      formatted_date: formattedDate,
      am_counter: currentAMData ? currentAMData.counter : 'N/A',
      counter: data.counter, // PM counter (was pm_counter)
      am_timestamp: currentAMData ? new Date(currentAMData.timestamp).toLocaleString() : 'N/A',
      pm_timestamp: new Date(data.timestamp).toLocaleString(),
      am_total: calculations.amTotal.toFixed(2),
      pm_total: calculations.pmTotal.toFixed(2),
      total_cash: calculations.pmTotal.toFixed(2), // Template expects total_cash
      drawer_change: calculations.drawerChange.toFixed(2),
      actual_cash_in: calculations.actualCashIn.toFixed(2),
      toast_sales: calculations.toastSales.toFixed(2),
      original_tips: calculations.cashTips.toFixed(2),
      discrepancy: Math.abs(calculations.discrepancy).toFixed(2),
      discrepancy_direction: calculations.discrepancy >= 0 ? 'Over' : 'Short',
      discrepancy_sign: calculations.discrepancy >= 0 ? '+' : '-',
      large_discrepancy_flag: Math.abs(calculations.discrepancy) > 10 ? ' LARGE DISCREPANCY!' : '',
      tip_adjustment: (calculations.shortageTipAdjustment || 0) > 0 ? (calculations.shortageTipAdjustment || 0).toFixed(2) : null,
      adjusted_tips: calculations.adjustedTips.toString(), // Whole dollars only
      deposit_amount: calculations.depositAmount.toString(), // Already rounded to whole dollar
      amount_to_keep: calculations.returnAmount.toFixed(2), // Template expects amount_to_keep
      return_breakdown: (calculations.returnAmount - calculations.amTotal).toFixed(2),
      drawer_over: calculations.drawerOver.toFixed(2),
      drawer_short: calculations.drawerShort.toFixed(2),
      am_notes: currentAMData ? (currentAMData.notes || '') : '',
      notes: data.notes || '', // Template expects notes (not pm_notes)
      has_discrepancy: calculations.discrepancy !== 0 ? 'true' : 'false',
      // Add drawer breakdown for comparison table
      has_am_comparison: currentAMData ? 'true' : 'false',
      am_drawer1_total: currentAMData ? currentAMData.drawer1.total.toFixed(2) : '0.00',
      am_drawer2_total: currentAMData ? currentAMData.drawer2.total.toFixed(2) : '0.00',
      pm_drawer1_total: data.drawer1Total.toFixed(2),
      pm_drawer2_total: data.drawer2Total.toFixed(2),
      am_grand_total: calculations.amTotal.toFixed(2),
      pm_grand_total: calculations.pmTotal.toFixed(2),
      // Manager breakdown fields
      restaurant_owed: calculations.toastSales.toFixed(2),
      staff_owed: calculations.adjustedTips.toString(), // Whole dollars only
      total_accounted: (calculations.toastSales + calculations.adjustedTips).toFixed(2),
      
      // Deposit rounding breakdown fields
      raw_deposit_amount: calculations.rawDepositAmount ? calculations.rawDepositAmount.toFixed(2) : null,
      deposit_rounding_adjustment: calculations.depositRoundingAdjustment ? calculations.depositRoundingAdjustment.toFixed(2) : null,
      deposit_tip_adjustment: calculations.depositTipAdjustment ? calculations.depositTipAdjustment.toFixed(2) : null,
      deposit_excess_to_cashbox: calculations.depositExcessToCashbox ? calculations.depositExcessToCashbox.toFixed(2) : null,
      has_deposit_rounding: (calculations.depositRoundingAdjustment && Math.abs(calculations.depositRoundingAdjustment) > 0) ? 'true' : 'false',
      
      // AM Drawer 1 denomination breakdown
      am_drawer1_100: currentAMData ? (currentAMData.drawer1.counts.hundreds || 0) : 0,
      am_drawer1_100_total: currentAMData ? ((currentAMData.drawer1.counts.hundreds || 0) * 100).toFixed(2) : '0.00',
      am_drawer1_50: currentAMData ? (currentAMData.drawer1.counts.fifties || 0) : 0,
      am_drawer1_50_total: currentAMData ? ((currentAMData.drawer1.counts.fifties || 0) * 50).toFixed(2) : '0.00',
      am_drawer1_20: currentAMData ? (currentAMData.drawer1.counts.twenties || 0) : 0,
      am_drawer1_20_total: currentAMData ? ((currentAMData.drawer1.counts.twenties || 0) * 20).toFixed(2) : '0.00',
      am_drawer1_10: currentAMData ? (currentAMData.drawer1.counts.tens || 0) : 0,
      am_drawer1_10_total: currentAMData ? ((currentAMData.drawer1.counts.tens || 0) * 10).toFixed(2) : '0.00',
      am_drawer1_5: currentAMData ? (currentAMData.drawer1.counts.fives || 0) : 0,
      am_drawer1_5_total: currentAMData ? ((currentAMData.drawer1.counts.fives || 0) * 5).toFixed(2) : '0.00',
      am_drawer1_1: currentAMData ? (currentAMData.drawer1.counts.ones || 0) : 0,
      am_drawer1_1_total: currentAMData ? ((currentAMData.drawer1.counts.ones || 0) * 1).toFixed(2) : '0.00',
      am_drawer1_quarter: currentAMData ? (currentAMData.drawer1.counts.quarters || 0) : 0,
      am_drawer1_quarter_total: currentAMData ? ((currentAMData.drawer1.counts.quarters || 0) * 0.25).toFixed(2) : '0.00',
      am_drawer1_dime: currentAMData ? (currentAMData.drawer1.counts.dimes || 0) : 0,
      am_drawer1_dime_total: currentAMData ? ((currentAMData.drawer1.counts.dimes || 0) * 0.10).toFixed(2) : '0.00',
      am_drawer1_nickel: currentAMData ? (currentAMData.drawer1.counts.nickels || 0) : 0,
      am_drawer1_nickel_total: currentAMData ? ((currentAMData.drawer1.counts.nickels || 0) * 0.05).toFixed(2) : '0.00',
      am_drawer1_penny: currentAMData ? (currentAMData.drawer1.counts.pennies || 0) : 0,
      am_drawer1_penny_total: currentAMData ? ((currentAMData.drawer1.counts.pennies || 0) * 0.01).toFixed(2) : '0.00',
      
      // AM Drawer 2 denomination breakdown
      am_drawer2_100: currentAMData ? (currentAMData.drawer2.counts.hundreds || 0) : 0,
      am_drawer2_100_total: currentAMData ? ((currentAMData.drawer2.counts.hundreds || 0) * 100).toFixed(2) : '0.00',
      am_drawer2_50: currentAMData ? (currentAMData.drawer2.counts.fifties || 0) : 0,
      am_drawer2_50_total: currentAMData ? ((currentAMData.drawer2.counts.fifties || 0) * 50).toFixed(2) : '0.00',
      am_drawer2_20: currentAMData ? (currentAMData.drawer2.counts.twenties || 0) : 0,
      am_drawer2_20_total: currentAMData ? ((currentAMData.drawer2.counts.twenties || 0) * 20).toFixed(2) : '0.00',
      am_drawer2_10: currentAMData ? (currentAMData.drawer2.counts.tens || 0) : 0,
      am_drawer2_10_total: currentAMData ? ((currentAMData.drawer2.counts.tens || 0) * 10).toFixed(2) : '0.00',
      am_drawer2_5: currentAMData ? (currentAMData.drawer2.counts.fives || 0) : 0,
      am_drawer2_5_total: currentAMData ? ((currentAMData.drawer2.counts.fives || 0) * 5).toFixed(2) : '0.00',
      am_drawer2_1: currentAMData ? (currentAMData.drawer2.counts.ones || 0) : 0,
      am_drawer2_1_total: currentAMData ? ((currentAMData.drawer2.counts.ones || 0) * 1).toFixed(2) : '0.00',
      am_drawer2_quarter: currentAMData ? (currentAMData.drawer2.counts.quarters || 0) : 0,
      am_drawer2_quarter_total: currentAMData ? ((currentAMData.drawer2.counts.quarters || 0) * 0.25).toFixed(2) : '0.00',
      am_drawer2_dime: currentAMData ? (currentAMData.drawer2.counts.dimes || 0) : 0,
      am_drawer2_dime_total: currentAMData ? ((currentAMData.drawer2.counts.dimes || 0) * 0.10).toFixed(2) : '0.00',
      am_drawer2_nickel: currentAMData ? (currentAMData.drawer2.counts.nickels || 0) : 0,
      am_drawer2_nickel_total: currentAMData ? ((currentAMData.drawer2.counts.nickels || 0) * 0.05).toFixed(2) : '0.00',
      am_drawer2_penny: currentAMData ? (currentAMData.drawer2.counts.pennies || 0) : 0,
      am_drawer2_penny_total: currentAMData ? ((currentAMData.drawer2.counts.pennies || 0) * 0.01).toFixed(2) : '0.00',
      
      // PM Drawer 1 denomination breakdown
      pm_drawer1_100: data.drawer1.counts.hundreds || 0,
      pm_drawer1_100_total: ((data.drawer1.counts.hundreds || 0) * 100).toFixed(2),
      pm_drawer1_50: data.drawer1.counts.fifties || 0,
      pm_drawer1_50_total: ((data.drawer1.counts.fifties || 0) * 50).toFixed(2),
      pm_drawer1_20: data.drawer1.counts.twenties || 0,
      pm_drawer1_20_total: ((data.drawer1.counts.twenties || 0) * 20).toFixed(2),
      pm_drawer1_10: data.drawer1.counts.tens || 0,
      pm_drawer1_10_total: ((data.drawer1.counts.tens || 0) * 10).toFixed(2),
      pm_drawer1_5: data.drawer1.counts.fives || 0,
      pm_drawer1_5_total: ((data.drawer1.counts.fives || 0) * 5).toFixed(2),
      pm_drawer1_1: data.drawer1.counts.ones || 0,
      pm_drawer1_1_total: ((data.drawer1.counts.ones || 0) * 1).toFixed(2),
      pm_drawer1_quarter: data.drawer1.counts.quarters || 0,
      pm_drawer1_quarter_total: ((data.drawer1.counts.quarters || 0) * 0.25).toFixed(2),
      pm_drawer1_dime: data.drawer1.counts.dimes || 0,
      pm_drawer1_dime_total: ((data.drawer1.counts.dimes || 0) * 0.10).toFixed(2),
      pm_drawer1_nickel: data.drawer1.counts.nickels || 0,
      pm_drawer1_nickel_total: ((data.drawer1.counts.nickels || 0) * 0.05).toFixed(2),
      pm_drawer1_penny: data.drawer1.counts.pennies || 0,
      pm_drawer1_penny_total: ((data.drawer1.counts.pennies || 0) * 0.01).toFixed(2),
      
      // PM Drawer 2 denomination breakdown
      pm_drawer2_100: data.drawer2.counts.hundreds || 0,
      pm_drawer2_100_total: ((data.drawer2.counts.hundreds || 0) * 100).toFixed(2),
      pm_drawer2_50: data.drawer2.counts.fifties || 0,
      pm_drawer2_50_total: ((data.drawer2.counts.fifties || 0) * 50).toFixed(2),
      pm_drawer2_20: data.drawer2.counts.twenties || 0,
      pm_drawer2_20_total: ((data.drawer2.counts.twenties || 0) * 20).toFixed(2),
      pm_drawer2_10: data.drawer2.counts.tens || 0,
      pm_drawer2_10_total: ((data.drawer2.counts.tens || 0) * 10).toFixed(2),
      pm_drawer2_5: data.drawer2.counts.fives || 0,
      pm_drawer2_5_total: ((data.drawer2.counts.fives || 0) * 5).toFixed(2),
      pm_drawer2_1: data.drawer2.counts.ones || 0,
      pm_drawer2_1_total: ((data.drawer2.counts.ones || 0) * 1).toFixed(2),
      pm_drawer2_quarter: data.drawer2.counts.quarters || 0,
      pm_drawer2_quarter_total: ((data.drawer2.counts.quarters || 0) * 0.25).toFixed(2),
      pm_drawer2_dime: data.drawer2.counts.dimes || 0,
      pm_drawer2_dime_total: ((data.drawer2.counts.dimes || 0) * 0.10).toFixed(2),
      pm_drawer2_nickel: data.drawer2.counts.nickels || 0,
      pm_drawer2_nickel_total: ((data.drawer2.counts.nickels || 0) * 0.05).toFixed(2),
      pm_drawer2_penny: data.drawer2.counts.pennies || 0,
      pm_drawer2_penny_total: ((data.drawer2.counts.pennies || 0) * 0.01).toFixed(2)
    };
    
    const response = await emailjs.send(
      EMAILJS_CONFIG.SERVICE_ID,
      EMAILJS_CONFIG.TEMPLATE_ID,
      templateParams
    );
    
    if (!response.status === 200) {
      throw new Error('Email send failed');
    }
  }
  
  async function generateReport() {
    const date = document.getElementById('reportDate').value;
    if (!date) {
      showMessage('Please select a date', 'error');
      return;
    }

    try {
      showLoading('Generating Report', 'Creating email report for management...');
      
      const amData = await getAMData(date);
      if (!amData) {
        throw new Error('No data found for this date');
      }
      
      // For report generation, we'll use stored PM data or create a basic report
      const { data: fullData } = await supabase
        .from('cash_counts')
        .select('*')
        .eq('date', date)
        .single();
      
      if (fullData && fullData.pm_total) {
        // Full day report - recalculate using the same logic as PM flow
        const reportData = {
          date: date,
          counter: fullData.pm_counter,
          total: fullData.pm_total,
          toastSales: fullData.pm_toast_sales,
          cashTips: fullData.pm_cash_tips,
          amTotal: fullData.am_total,
          notes: fullData.pm_notes
        };
        
        // Use same calculation function as PM flow for consistency
        const calculations = calculatePMAmounts({
          amTotal: fullData.am_total,
          total: fullData.pm_total,
          toastSales: fullData.pm_toast_sales,
          cashTips: fullData.pm_cash_tips
        });
        
        currentAMData = amData;
        await sendEmailReport(reportData, calculations);
      } else {
        throw new Error('Incomplete data for this date');
      }
      
      // Show elegant success screen
      showReportSuccess(date);
      
    } catch (error) {
      hideLoading();
      console.error('Report generation error:', error);
      showMessage(`Error: ${error.message}`, 'error');
    }
  }
  
  // New Report Functions
  function toggleReportType() {
    const reportType = document.querySelector('input[name="reportType"]:checked').value;
    const singleGroup = document.getElementById('singleDateGroup');
    const weeklyGroup = document.getElementById('weeklyRangeGroup');
    
    if (reportType === 'single') {
      singleGroup.style.display = 'block';
      weeklyGroup.style.display = 'none';
    } else {
      singleGroup.style.display = 'none';
      weeklyGroup.style.display = 'block';
      // Load saved weeks when weekly report is selected
      loadSavedWeeks();
    }
  }

  // Load Saved Weekly Reports for Dropdown
  async function loadSavedWeeks() {
    const dropdown = document.getElementById('savedWeeksDropdown');
    
    try {
      dropdown.innerHTML = '<option value="">Loading saved reports...</option>';
      
      if (!supabase) {
        dropdown.innerHTML = '<option value="">Database connection not available</option>';
        return;
      }

      const { data: savedReports, error } = await supabase
        .from('weekly_combined_reports')
        .select('id, week_start_date, week_end_date, generated_by, generated_at')
        .order('week_start_date', { ascending: false });

      if (error) {
        console.error('Error loading saved reports:', error);
        dropdown.innerHTML = '<option value="">Error loading reports</option>';
        return;
      }

      if (!savedReports || savedReports.length === 0) {
        dropdown.innerHTML = '<option value="">No saved weekly reports found. Generate a weekly combined report first.</option>';
        return;
      }

      // Populate dropdown with saved reports
      dropdown.innerHTML = '<option value="">Select a saved weekly report...</option>';
      
      savedReports.forEach(report => {
        const startDate = new Date(report.week_start_date).toLocaleDateString();
        const endDate = new Date(report.week_end_date).toLocaleDateString();
        const generatedDate = new Date(report.generated_at).toLocaleDateString();
        
        const option = document.createElement('option');
        option.value = report.id;
        option.textContent = `Week of ${startDate} - ${endDate} (Generated: ${generatedDate})`;
        dropdown.appendChild(option);
      });

    } catch (error) {
      console.error('Error in loadSavedWeeks:', error);
      dropdown.innerHTML = '<option value="">Error loading reports</option>';
    }
  }

  // Generate Historical Report from Database
  async function generateHistoricalReport() {
    const reportTypeElement = document.querySelector('input[name="reportType"]:checked');

    if (!reportTypeElement) {
      showMessage('Please select a report type (Daily or Weekly)', 'warning');
      return;
    }
    
    const reportType = reportTypeElement.value;
    console.log('Generate Historical Report - Report type:', reportType);
    
    try {
      showLoading('Generating Historical Report', 'Retrieving data from database...');
      
      if (reportType === 'single') {
        await generateSingleDayHistoricalReport();
      } else {
        await generateWeeklyHistoricalReport();
      }
      
      hideLoading();
      showSuccessMessage('Historical report generated successfully!', 'reportsForm');
      
    } catch (error) {
      hideLoading();
      showErrorMessage('Error generating historical report: ' + error.message, 'reportsForm');
      console.error('Historical report error:', error);
    }
  }

  // Generate Single Day Historical Report
  async function generateSingleDayHistoricalReport() {
    const reportDate = document.getElementById('reportDate').value;
    
    if (!reportDate) {
      throw new Error('Please select a date for the report');
    }
    
    if (!supabase) {
      throw new Error('Database connection not available');
    }
    
    // Query for complete daily cash count data
    const { data: fullData, error: dataError } = await supabase
      .from('cash_counts')
      .select('*')
      .eq('date', reportDate)
      .single();
    
    if (dataError) {
      console.error('Database error details:', dataError);
      throw new Error(`Database query failed: ${dataError.message}`);
    }
    
    if (!fullData) {
      throw new Error(`No cash count data found for ${reportDate}. This date may not have been processed yet.`);
    }
    
    // Check if we have both AM and PM data
    if (!fullData.am_total && !fullData.pm_total) {
      throw new Error(`No AM or PM data found for ${reportDate}. This date may not have been processed yet.`);
    }
    
    // Display single day report in modal using PM flow format
    displayPMFlowSingleDayReportModal(fullData, reportDate);
  }
  
  // Display Single Day Report in Modal using PM Flow Format
  function displayPMFlowSingleDayReportModal(fullData, reportDate) {
    console.log('=== PM FLOW SINGLE DAY REPORT MODAL ===');
    
    // Generate comprehensive HTML content using PM flow format
    const reportHtml = generatePMFlowSingleDayReportHtml(fullData, reportDate);
    
    // Create modal overlay
    const overlay = document.createElement('div');
    overlay.id = 'singleDayReportOverlay';
    overlay.style.cssText = `
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      width: 100vw !important;
      height: 100vh !important;
      background: rgba(0, 0, 0, 0.8) !important;
      z-index: 99999 !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      overflow: auto !important;
    `;
    
    const contentBox = document.createElement('div');
    contentBox.style.cssText = `
      background: white !important;
      margin: 20px !important;
      padding: 0 !important;
      border-radius: 12px !important;
      max-width: 95vw !important;
      max-height: 95vh !important;
      overflow: hidden !important;
      position: relative !important;
      box-shadow: 0 8px 32px rgba(0,0,0,0.4) !important;
      display: flex !important;
      flex-direction: column !important;
    `;
    
    // Add header with controls
    const headerDiv = document.createElement('div');
    headerDiv.style.cssText = `
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%) !important;
      padding: 20px 30px !important;
      color: white !important;
      display: flex !important;
      justify-content: space-between !important;
      align-items: center !important;
      flex-shrink: 0 !important;
    `;
    
    const titleDiv = document.createElement('div');
    titleDiv.innerHTML = `
      <h2 style="margin: 0; font-size: 24px; font-weight: 600;">Daily Cash Report</h2>
      <p style="margin: 5px 0 0 0; opacity: 0.9; font-size: 16px;">${new Date(reportDate).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
    `;
    
    const controlsDiv = document.createElement('div');
    controlsDiv.style.cssText = `
      display: flex !important;
      gap: 15px !important;
      align-items: center !important;
    `;
    
    // PDF Download button
    const pdfBtn = document.createElement('button');
    pdfBtn.innerHTML = 'Download PDF';
    pdfBtn.style.cssText = `
      background: rgba(255,255,255,0.2) !important;
      color: white !important;
      border: 2px solid rgba(255,255,255,0.4) !important;
      padding: 10px 20px !important;
      border-radius: 8px !important;
      cursor: pointer !important;
      font-size: 14px !important;
      font-weight: 500 !important;
      transition: all 0.3s ease !important;
    `;
    pdfBtn.onmouseover = () => pdfBtn.style.background = 'rgba(255,255,255,0.3)';
    pdfBtn.onmouseout = () => pdfBtn.style.background = 'rgba(255,255,255,0.2)';
    pdfBtn.onclick = () => generatePMFlowSingleDayPDF(fullData, reportDate);
    
    // Close button
    const closeBtn = document.createElement('button');
    closeBtn.innerHTML = 'X';
    closeBtn.style.cssText = `
      background: rgba(255,255,255,0.2) !important;
      color: white !important;
      border: 2px solid rgba(255,255,255,0.4) !important;
      padding: 8px 12px !important;
      border-radius: 50% !important;
      cursor: pointer !important;
      font-size: 18px !important;
      font-weight: bold !important;
      width: 40px !important;
      height: 40px !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      transition: all 0.3s ease !important;
    `;
    closeBtn.onmouseover = () => closeBtn.style.background = 'rgba(255,80,80,0.8)';
    closeBtn.onmouseout = () => closeBtn.style.background = 'rgba(255,255,255,0.2)';
    closeBtn.onclick = () => document.body.removeChild(overlay);
    
    controlsDiv.appendChild(pdfBtn);
    controlsDiv.appendChild(closeBtn);
    headerDiv.appendChild(titleDiv);
    headerDiv.appendChild(controlsDiv);
    
    // Add content area
    const contentDiv = document.createElement('div');
    contentDiv.style.cssText = `
      padding: 30px !important;
      overflow: auto !important;
      flex: 1 !important;
      background: #f8f9fa !important;
    `;
    contentDiv.innerHTML = reportHtml;
    
    contentBox.appendChild(headerDiv);
    contentBox.appendChild(contentDiv);
    overlay.appendChild(contentBox);
    document.body.appendChild(overlay);
    
    console.log('PM Flow single day report modal created and displayed');
  }
  
  // Generate Enhanced Single Day Report HTML
  function generateEnhancedSingleDayReportHtml(dayData, reportDate) {
    const formattedDate = new Date(reportDate).toLocaleDateString('en-US', { 
      weekday: 'long', 
      year: 'numeric', 
      month: 'long', 
      day: 'numeric' 
    });
    
    const weekStart = new Date(dayData.weekly_combined_reports.week_start_date).toLocaleDateString();
    const weekEnd = new Date(dayData.weekly_combined_reports.week_end_date).toLocaleDateString();
    
    return `
      <div style="max-width: 1200px; margin: 0 auto; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
        
        <!-- Header Summary Cards -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px;">
          
          <!-- Date & Staff Info Card -->
          <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 0; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
            <div style="display: flex; align-items: center; margin-bottom: 15px;">
              <span style="font-size: 24px; margin-right: 10px;"></span>
              <h3 style="margin: 0; font-size: 18px; font-weight: 600;">Date & Staff</h3>
            </div>
            <div style="space-y: 8px;">
              <p style="margin: 8px 0; font-size: 16px;"><strong>Date:</strong> ${formattedDate}</p>
              <p style="margin: 8px 0; font-size: 14px;"><strong>Report Week:</strong> ${weekStart} - ${weekEnd}</p>
              <p style="margin: 8px 0; font-size: 14px;"><strong>Night Counter:</strong> ${dayData.night_counter || 'N/A'}</p>
              <p style="margin: 8px 0; font-size: 12px; opacity: 0.9;"><strong>Generated:</strong> ${new Date().toLocaleString()}</p>
            </div>
          </div>

          <!-- Cash Flow Summary Card -->
          <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 25px; border-radius: 0; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
            <div style="display: flex; align-items: center; margin-bottom: 15px;">
              <span style="font-size: 24px; margin-right: 10px;"></span>
              <h3 style="margin: 0; font-size: 18px; font-weight: 600;">Cash Flow</h3>
            </div>
            <div style="space-y: 8px;">
              <p style="margin: 8px 0; font-size: 16px;"><strong>Toast Sales:</strong> $${dayData.toast_sales?.toFixed(2) || '0.00'}</p>
              <p style="margin: 8px 0; font-size: 14px;"><strong>Actual Cash In:</strong> $${dayData.actual_cash_in?.toFixed(2) || '0.00'}</p>
              <p style="margin: 8px 0; font-size: 14px;"><strong>Discrepancy:</strong> ${dayData.discrepancy >= 0 ? '+' : ''}$${Math.abs(dayData.discrepancy || 0).toFixed(2)}</p>
              <p style="margin: 8px 0; font-size: 14px;"><strong>Excess:</strong> $${dayData.excess?.toFixed(2) || '0.00'}</p>
            </div>
          </div>

          <!-- Performance Indicators Card -->
          <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 25px; border-radius: 0; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
            <div style="display: flex; align-items: center; margin-bottom: 15px;">
              <span style="font-size: 24px; margin-right: 10px;"></span>
              <h3 style="margin: 0; font-size: 18px; font-weight: 600;">Performance</h3>
            </div>
            <div style="space-y: 8px;">
              <p style="margin: 8px 0; font-size: 14px;"><strong>Accuracy:</strong> ${Math.abs(dayData.discrepancy || 0) < 5 ? 'Excellent' : Math.abs(dayData.discrepancy || 0) < 20 ? 'Good' : 'Needs Review'}</p>
              <p style="margin: 8px 0; font-size: 14px;"><strong>Variance:</strong> ${((Math.abs(dayData.discrepancy || 0) / (dayData.toast_sales || 1)) * 100).toFixed(1)}%</p>
              <p style="margin: 8px 0; font-size: 14px;"><strong>Week Generated By:</strong> ${dayData.weekly_combined_reports.generated_by || 'N/A'}</p>
            </div>
          </div>
        </div>

        <!-- Detailed Analysis Section -->
        <div style="background: white; border-radius: 0; box-shadow: 0 4px 20px rgba(0,0,0,0.08); overflow: hidden; margin-bottom: 30px;">
          <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px;">
            <h3 style="margin: 0; font-size: 20px; font-weight: 600; display: flex; align-items: center;">
              <span style="margin-right: 10px;"></span>
              Detailed Cash Analysis
            </h3>
          </div>
          
          <div style="padding: 30px;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px;">
              
              <!-- Revenue Breakdown -->
              <div>
                <h4 style="color: #333; margin-bottom: 20px; font-size: 16px; font-weight: 600; border-bottom: 2px solid #667eea; padding-bottom: 8px;">Revenue Breakdown</h4>
                <div style="space-y: 12px;">
                  <div style="display: flex; justify-content: space-between; padding: 12px; background: #f8f9fa; border-radius: 0; border-left: 4px solid #28a745;">
                    <span style="font-weight: 500;">Toast Sales Reported</span>
                    <span style="font-weight: 600; color: #28a745;">$${dayData.toast_sales?.toFixed(2) || '0.00'}</span>
                  </div>
                  <div style="display: flex; justify-content: space-between; padding: 12px; background: #f8f9fa; border-radius: 0; border-left: 4px solid #17a2b8;">
                    <span style="font-weight: 500;">Actual Cash Collected</span>
                    <span style="font-weight: 600; color: #17a2b8;">$${dayData.actual_cash_in?.toFixed(2) || '0.00'}</span>
                  </div>
                  <div style="display: flex; justify-content: space-between; padding: 12px; background: #f8f9fa; border-radius: 0; border-left: 4px solid ${dayData.discrepancy >= 0 ? '#28a745' : '#dc3545'};">
                    <span style="font-weight: 500;">Cash Variance</span>
                    <span style="font-weight: 600; color: ${dayData.discrepancy >= 0 ? '#28a745' : '#dc3545'};">${dayData.discrepancy >= 0 ? '+' : ''}$${Math.abs(dayData.discrepancy || 0).toFixed(2)}</span>
                  </div>
                </div>
              </div>

              <!-- Operational Metrics -->
              <div>
                <h4 style="color: #333; margin-bottom: 20px; font-size: 16px; font-weight: 600; border-bottom: 2px solid #f093fb; padding-bottom: 8px;">Operational Metrics</h4>
                <div style="space-y: 12px;">
                  <div style="display: flex; justify-content: space-between; padding: 12px; background: #f8f9fa; border-radius: 0; border-left: 4px solid #6f42c1;">
                    <span style="font-weight: 500;">Cash Excess to Tips</span>
                    <span style="font-weight: 600; color: #6f42c1;">$${dayData.excess?.toFixed(2) || '0.00'}</span>
                  </div>
                  <div style="display: flex; justify-content: space-between; padding: 12px; background: #f8f9fa; border-radius: 0; border-left: 4px solid #fd7e14;">
                    <span style="font-weight: 500;">Accuracy Rate</span>
                    <span style="font-weight: 600; color: #fd7e14;">${Math.abs(dayData.discrepancy || 0) < 5 ? '98%+' : Math.abs(dayData.discrepancy || 0) < 20 ? '95%+' : '90%-'}</span>
                  </div>
                  <div style="display: flex; justify-content: space-between; padding: 12px; background: #f8f9fa; border-radius: 0; border-left: 4px solid #20c997;">
                    <span style="font-weight: 500;">Status</span>
                    <span style="font-weight: 600; color: #20c997;">${Math.abs(dayData.discrepancy || 0) < 10 ? 'Balanced' : 'Review Needed'}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Raw Data Section -->
        <div style="background: white; border-radius: 0; box-shadow: 0 4px 20px rgba(0,0,0,0.08); overflow: hidden; margin-bottom: 30px;">
          <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 20px;">
            <h3 style="margin: 0; font-size: 20px; font-weight: 600; display: flex; align-items: center;">
              <span style="margin-right: 10px;"></span>
              Complete Data Summary
            </h3>
          </div>
          
          <div style="padding: 30px;">
            <div style="overflow-x: auto;">
              <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                <thead>
                  <tr style="background: #f8f9fa;">
                    <th style="padding: 15px; text-align: left; border-bottom: 2px solid #dee2e6; font-weight: 600; color: #495057;">Field</th>
                    <th style="padding: 15px; text-align: right; border-bottom: 2px solid #dee2e6; font-weight: 600; color: #495057;">Value</th>
                    <th style="padding: 15px; text-align: left; border-bottom: 2px solid #dee2e6; font-weight: 600; color: #495057;">Description</th>
                  </tr>
                </thead>
                <tbody>
                  <tr style="border-bottom: 1px solid #dee2e6;">
                    <td style="padding: 12px; font-weight: 500;">Date</td>
                    <td style="padding: 12px; text-align: right;">${formattedDate}</td>
                    <td style="padding: 12px; color: #6c757d;">Business day for this report</td>
                  </tr>
                  <tr style="border-bottom: 1px solid #dee2e6; background: #f8f9fa;">
                    <td style="padding: 12px; font-weight: 500;">Night Counter</td>
                    <td style="padding: 12px; text-align: right;">${dayData.night_counter || 'N/A'}</td>
                    <td style="padding: 12px; color: #6c757d;">Staff member who completed closing count</td>
                  </tr>
                  <tr style="border-bottom: 1px solid #dee2e6;">
                    <td style="padding: 12px; font-weight: 500;">Toast Sales</td>
                    <td style="padding: 12px; text-align: right; color: #28a745; font-weight: 600;">$${dayData.toast_sales?.toFixed(2) || '0.00'}</td>
                    <td style="padding: 12px; color: #6c757d;">Total sales reported by POS system</td>
                  </tr>
                  <tr style="border-bottom: 1px solid #dee2e6; background: #f8f9fa;">
                    <td style="padding: 12px; font-weight: 500;">Actual Cash In</td>
                    <td style="padding: 12px; text-align: right; color: #17a2b8; font-weight: 600;">$${dayData.actual_cash_in?.toFixed(2) || '0.00'}</td>
                    <td style="padding: 12px; color: #6c757d;">Physical cash counted in registers</td>
                  </tr>
                  <tr style="border-bottom: 1px solid #dee2e6;">
                    <td style="padding: 12px; font-weight: 500;">Discrepancy</td>
                    <td style="padding: 12px; text-align: right; color: ${dayData.discrepancy >= 0 ? '#28a745' : '#dc3545'}; font-weight: 600;">${dayData.discrepancy >= 0 ? '+' : ''}$${Math.abs(dayData.discrepancy || 0).toFixed(2)}</td>
                    <td style="padding: 12px; color: #6c757d;">Difference between expected and actual cash</td>
                  </tr>
                  <tr style="border-bottom: 1px solid #dee2e6; background: #f8f9fa;">
                    <td style="padding: 12px; font-weight: 500;">Excess</td>
                    <td style="padding: 12px; text-align: right; color: #6f42c1; font-weight: 600;">$${dayData.excess?.toFixed(2) || '0.00'}</td>
                    <td style="padding: 12px; color: #6c757d;">Amount moved from tips to balance operations</td>
                  </tr>
                  <tr style="border-bottom: 1px solid #dee2e6;">
                    <td style="padding: 12px; font-weight: 500;">Week Start</td>
                    <td style="padding: 12px; text-align: right;">${weekStart}</td>
                    <td style="padding: 12px; color: #6c757d;">Start of report week containing this day</td>
                  </tr>
                  <tr style="border-bottom: 1px solid #dee2e6; background: #f8f9fa;">
                    <td style="padding: 12px; font-weight: 500;">Week End</td>
                    <td style="padding: 12px; text-align: right;">${weekEnd}</td>
                    <td style="padding: 12px; color: #6c757d;">End of report week containing this day</td>
                  </tr>
                  <tr style="border-bottom: 1px solid #dee2e6;">
                    <td style="padding: 12px; font-weight: 500;">Weekly Report By</td>
                    <td style="padding: 12px; text-align: right;">${dayData.weekly_combined_reports.generated_by || 'N/A'}</td>
                    <td style="padding: 12px; color: #6c757d;">Manager who generated the weekly report</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Notes Section -->
        <div style="background: white; border-radius: 0; box-shadow: 0 4px 20px rgba(0,0,0,0.08); overflow: hidden; margin-bottom: 20px;">
          <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 20px;">
            <h3 style="margin: 0; font-size: 20px; font-weight: 600; display: flex; align-items: center;">
              <span style="margin-right: 10px;"></span>
              Important Notes
            </h3>
          </div>
          
          <div style="padding: 30px;">
            <div style="background: #e3f2fd; border-left: 4px solid #2196f3; padding: 20px; border-radius: 0; margin-bottom: 20px;">
              <h4 style="margin: 0 0 10px 0; color: #1976d2; font-size: 16px;">Understanding the Data</h4>
              <ul style="margin: 10px 0 0 20px; color: #424242; line-height: 1.6;">
                <li><strong>Discrepancy:</strong> Shows cash over/under compared to expected sales (negative = short, positive = over)</li>
                <li><strong>Excess:</strong> Amount taken from tips to balance daily operations</li>
                <li><strong>Accuracy Rate:</strong> Calculated based on variance from expected cash amounts</li>
              </ul>
            </div>
            
            <div style="background: #f3e5f5; border-left: 4px solid #9c27b0; padding: 20px; border-radius: 0;">
              <h4 style="margin: 0 0 10px 0; color: #7b1fa2; font-size: 16px;">Performance Benchmarks</h4>
              <ul style="margin: 10px 0 0 20px; color: #424242; line-height: 1.6;">
                <li><strong>Excellent:</strong> Discrepancy under $5 (98%+ accuracy)</li>
                <li><strong>Good:</strong> Discrepancy $5-$20 (95%+ accuracy)</li>
                <li><strong>Review Needed:</strong> Discrepancy over $20 (requires attention)</li>
              </ul>
            </div>
          </div>
        </div>

        <!-- Footer -->
        <div style="text-align: center; padding: 20px; color: #6c757d; font-size: 12px; border-top: 1px solid #dee2e6;">
          <p style="margin: 0;">Report generated by Jayna Gyro Cash Counter v3.0+ | ${new Date().toLocaleString()}</p>
          <p style="margin: 5px 0 0 0;">Designed and coded by Demetri Gregorakis | demetri_gregorakis@icloud.com</p>
        </div>
      </div>
    `;
  }

  // Generate Weekly Historical Report
  async function generateWeeklyHistoricalReport() {
    const reportId = document.getElementById('savedWeeksDropdown').value;
    
    console.log('Selected report ID:', reportId);
    
    if (!reportId) {
      throw new Error('Please select a saved weekly report from the dropdown');
    }
    
    if (!supabase) {
      throw new Error('Database connection not available');
    }
    
    // Get the saved report data including the generated HTML content
    const { data: reportData, error: reportError } = await supabase
      .from('weekly_combined_reports')
      .select('*')
      .eq('id', reportId)
      .single();
    
    if (reportError) {
      console.error('Report query error:', reportError);
      throw new Error(`Failed to load report: ${reportError.message}`);
    }
    
    if (!reportData) {
      throw new Error('Report not found');
    }
    
    console.log('Retrieved report data:', reportData);
    console.log('Has cash HTML:', !!reportData.generated_cash_report_html);
    console.log('Has tip pool HTML:', !!reportData.generated_tip_pool_html);
    
    // Display the saved HTML content directly
    const reportContent = document.getElementById('reportContent');
    
    console.log('About to set report content...');
    console.log('Report data keys:', Object.keys(reportData));
    console.log('Cash HTML length:', reportData.generated_cash_report_html?.length || 0);
    console.log('Tip pool HTML length:', reportData.generated_tip_pool_html?.length || 0);
    
    if (reportData.generated_cash_report_html && reportData.generated_tip_pool_html) {
      // We have saved HTML content - display it in the main content area like tip pool results!
      const mainContentHtml = `
        <div style="max-width: 1200px; margin: 0 auto; padding: 20px;">
          <div style="background: #f8f9fa; padding: 20px; border-radius: 0; margin-bottom: 20px; border-left: 4px solid #28a745;">
            <h3 style="margin: 0 0 10px 0; color: #28a745;">Historical Report Retrieved</h3>
            <p style="margin: 0; font-size: 14px;">Report for: ${new Date(reportData.week_start_date).toLocaleDateString()} - ${new Date(reportData.week_end_date).toLocaleDateString()}</p>
            <p style="margin: 0; font-size: 14px;">Generated by: ${reportData.generated_by} on ${new Date(reportData.generated_at).toLocaleDateString()}</p>
            <div style="text-align: center; margin-top: 15px;">
              <button class="submit-btn" onclick="downloadHistoricalReportPDF('${reportData.week_start_date}', '${reportData.week_end_date}')" style="margin-right: 10px;">Download PDF</button>
              <button class="submit-btn" onclick="goHome()">Back to Menu</button>
            </div>
          </div>
          
          <div style="margin-bottom: 30px;">
            <h3 style="color: #1e3c72; margin-bottom: 15px; border-bottom: 2px solid #1e3c72; padding-bottom: 5px;">WEEKLY CASH REPORT</h3>
            ${reportData.generated_cash_report_html}
          </div>
          
          <div>
            <h3 style="color: #1e3c72; margin-bottom: 15px; border-bottom: 2px solid #1e3c72; padding-bottom: 5px;">TIP POOL DISTRIBUTION</h3>
            ${reportData.generated_tip_pool_html}
          </div>
          
          <div style="text-align: center; margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 0;">
            <button class="submit-btn" onclick="downloadHistoricalReportPDF('${reportData.week_start_date}', '${reportData.week_end_date}')" style="margin-right: 10px;">Download PDF</button>
            <button class="submit-btn" onclick="goHome()">Back to Menu</button>
          </div>
        </div>
      `;
      
      console.log('Setting main content HTML...');
      console.log('HTML length:', mainContentHtml.length);
      
      // Use the proven working method - set content and show like tip pool results
      reportContent.innerHTML = mainContentHtml;
      
      // Store the report data globally for PDF generation
      window.currentHistoricalReport = reportData;
      
      // Hide all sections and show the results (copy exact pattern from tip pool)
      hideAllSections();
      
      console.log('Looking for reportResults element...');
      const reportResultsElement = document.getElementById('reportResults');
      console.log('reportResults element found:', !!reportResultsElement);
      console.log('reportResults element:', reportResultsElement);
      
      if (reportResultsElement) {
        console.log('=== ALTERNATIVE DISPLAY METHOD ===');
        
        // NUCLEAR OPTION: Create a completely new modal-style overlay
        const overlay = document.createElement('div');
        overlay.id = 'reportOverlay';
        overlay.style.cssText = `
          position: fixed !important;
          top: 0 !important;
          left: 0 !important;
          width: 100vw !important;
          height: 100vh !important;
          background: rgba(0, 0, 0, 0.8) !important;
          z-index: 99999 !important;
          display: flex !important;
          align-items: center !important;
          justify-content: center !important;
          overflow: auto !important;
        `;
        
        const contentBox = document.createElement('div');
        contentBox.style.cssText = `
          background: white !important;
          margin: 20px !important;
          padding: 30px !important;
          border-radius: 8px !important;
          max-width: 90vw !important;
          max-height: 90vh !important;
          overflow: auto !important;
          position: relative !important;
          box-shadow: 0 4px 20px rgba(0,0,0,0.3) !important;
        `;
        
        // Add close button
        const closeBtn = document.createElement('button');
        closeBtn.innerHTML = 'X Close Report';
        closeBtn.style.cssText = `
          position: sticky !important;
          top: 0 !important;
          right: 0 !important;
          float: right !important;
          background: #dc3545 !important;
          color: white !important;
          border: none !important;
          padding: 10px 15px !important;
          border-radius: 4px !important;
          cursor: pointer !important;
          margin-bottom: 20px !important;
          font-size: 14px !important;
        `;
        closeBtn.onclick = () => document.body.removeChild(overlay);
        
        // Add PDF download button
        const downloadBtn = document.createElement('button');
        downloadBtn.innerHTML = 'Download PDF';
        downloadBtn.style.cssText = `
          position: sticky !important;
          top: 0 !important;
          right: 120px !important;
          float: right !important;
          background: #28a745 !important;
          color: white !important;
          border: none !important;
          padding: 10px 15px !important;
          border-radius: 4px !important;
          cursor: pointer !important;
          margin-bottom: 20px !important;
          margin-right: 10px !important;
          font-size: 14px !important;
        `;
        downloadBtn.onclick = () => {
          if (window.currentHistoricalReport) {
            downloadHistoricalReportPDF(window.currentHistoricalReport.week_start_date, window.currentHistoricalReport.week_end_date);
          } else {
            showMessage('Report data not available for PDF download', 'error');
          }
        };
        
        // Copy the content (clean it up to remove duplicate forms)
        contentBox.appendChild(closeBtn);
        contentBox.appendChild(downloadBtn);
        const contentDiv = document.createElement('div');
        
        // Clean the content - remove any tip pool forms that shouldn't be there
        let cleanContent = reportContent.innerHTML;
        
        // Remove the Weekly Combined Report section and all form elements
        cleanContent = cleanContent.replace(/<div[^>]*id="combinedReportSection"[^>]*>.*?<\/div>/gs, '');
        cleanContent = cleanContent.replace(/<div[^>]*id="tipPoolForm"[^>]*>.*?<\/div>/gs, '');
        cleanContent = cleanContent.replace(/<form[^>]*>.*?<\/form>/gs, '');
        cleanContent = cleanContent.replace(/<button[^>]*onclick="goHome\(\)"[^>]*>.*?<\/button>/gs, '');
        cleanContent = cleanContent.replace(/Weekly Combined Report[\s\S]*?Generate Combined Weekly Report/g, '');
        cleanContent = cleanContent.replace(/Download PDF Back to Menu/g, '');
        
        contentDiv.innerHTML = cleanContent;
        contentBox.appendChild(contentDiv);
        
        overlay.appendChild(contentBox);
        document.body.appendChild(overlay);
        
        console.log('Created modal overlay for report display');
        console.log('Report should be visible as modal overlay!');
        
      } else {
        console.error('reportResults element not found!');
      }
      
      console.log('Historical report content should now be visible');
      
    } else {
      // Fallback: no HTML content saved, show basic info
      const legacyContentHtml = `
        <div style="max-width: 800px; margin: 0 auto; padding: 20px;">
          <div style="background: #fff3cd; padding: 20px; border-radius: 0; border-left: 4px solid #ffc107;">
            <h3 style="margin: 0 0 10px 0; color: #856404;">Legacy Report Format</h3>
            <p style="margin: 0 0 10px 0; font-size: 14px;">This report was generated before HTML content saving was implemented.</p>
            <p style="margin: 0; font-size: 14px;"><strong>Report Details:</strong></p>
            <ul style="margin: 10px 0 0 20px;">
              <li>Week: ${new Date(reportData.week_start_date).toLocaleDateString()} - ${new Date(reportData.week_end_date).toLocaleDateString()}</li>
              <li>Generated by: ${reportData.generated_by}</li>
              <li>Generated on: ${new Date(reportData.generated_at).toLocaleDateString()}</li>
              <li>Total Tips: $${reportData.total_tips || 0}</li>
              <li>Tip Pool Total: $${reportData.tip_pool_total || 0}</li>
            </ul>
            <div style="text-align: center; margin-top: 20px;">
              <button class="submit-btn" onclick="goHome()">Back to Menu</button>
            </div>
          </div>
        </div>
      `;
      
      console.log('Setting legacy content HTML...');
      reportContent.innerHTML = legacyContentHtml;
      
      hideAllSections();
      
      console.log('Looking for reportResults element (legacy)...');
      const reportResultsElement = document.getElementById('reportResults');
      console.log('reportResults element found (legacy):', !!reportResultsElement);
      
      if (reportResultsElement) {
        console.log('=== ALTERNATIVE DISPLAY METHOD (LEGACY) ===');
        
        // NUCLEAR OPTION: Create a completely new modal-style overlay
        const overlay = document.createElement('div');
        overlay.id = 'reportOverlayLegacy';
        overlay.style.cssText = `
          position: fixed !important;
          top: 0 !important;
          left: 0 !important;
          width: 100vw !important;
          height: 100vh !important;
          background: rgba(0, 0, 0, 0.8) !important;
          z-index: 99999 !important;
          display: flex !important;
          align-items: center !important;
          justify-content: center !important;
          overflow: auto !important;
        `;
        
        const contentBox = document.createElement('div');
        contentBox.style.cssText = `
          background: white !important;
          margin: 20px !important;
          padding: 30px !important;
          border-radius: 8px !important;
          max-width: 90vw !important;
          max-height: 90vh !important;
          overflow: auto !important;
          position: relative !important;
          box-shadow: 0 4px 20px rgba(0,0,0,0.3) !important;
        `;
        
        // Add close button
        const closeBtn = document.createElement('button');
        closeBtn.innerHTML = 'X Close Report (Legacy)';
        closeBtn.style.cssText = `
          position: sticky !important;
          top: 0 !important;
          right: 0 !important;
          float: right !important;
          background: #dc3545 !important;
          color: white !important;
          border: none !important;
          padding: 10px 15px !important;
          border-radius: 4px !important;
          cursor: pointer !important;
          margin-bottom: 20px !important;
          font-size: 14px !important;
        `;
        closeBtn.onclick = () => document.body.removeChild(overlay);
        
        // Set fallback content
        contentBox.appendChild(closeBtn);
        const contentDiv = document.createElement('div');
        contentDiv.innerHTML = '<h2>Legacy Report Content</h2><p>This is the legacy path display.</p>';
        contentBox.appendChild(contentDiv);
        
        overlay.appendChild(contentBox);
        document.body.appendChild(overlay);
        
        console.log('Created modal overlay for report display (legacy)');
        
      } else {
        console.error('reportResults element not found (legacy)!');
      }
    }
  }

  // Generate PM Flow Single Day Report HTML
  function generatePMFlowSingleDayReportHtml(fullData, reportDate) {
    // Format date with day of the week
    const dateObj = new Date(reportDate + 'T00:00:00');
    const dayOfWeek = dateObj.toLocaleDateString('en-US', { weekday: 'long' }).toUpperCase();
    const formattedDate = dateObj.toLocaleDateString('en-US', { 
      year: 'numeric', 
      month: 'long', 
      day: 'numeric' 
    }).toUpperCase();
    
    // Calculate amounts using PM flow logic
    const amTotal = fullData.am_total || 0;
    const pmTotal = fullData.pm_total || 0;
    const toastSales = fullData.pm_toast_sales || 0;
    const originalTips = fullData.pm_cash_tips || 0;
    const actualCashIn = pmTotal - amTotal;
    const discrepancy = actualCashIn - toastSales;
    const discrepancySign = discrepancy >= 0 ? '+' : '-';
    const largeDiscrepancyFlag = Math.abs(discrepancy) > 10 ? ' LARGE DISCREPANCY!' : '';
    
    // Additional PM flow calculations
    const tipAdjustment = (originalTips - (fullData.pm_adjusted_tips || originalTips));
    const rawDepositAmount = fullData.pm_deposit_amount ? (toastSales + originalTips) : 0;
    const roundedDepositAmount = fullData.pm_deposit_amount || 0;
    const depositRoundingAdjustment = rawDepositAmount - roundedDepositAmount;
    const depositTipAdjustment = fullData.pm_adjusted_tips ? (originalTips - fullData.pm_adjusted_tips) : 0;
    const depositExcessToCashbox = Math.abs(depositRoundingAdjustment);
    const returnBreakdown = fullData.pm_amount_to_keep ? (fullData.pm_amount_to_keep - amTotal) : 0;
    
    // Helper function to get denomination breakdown
    function getDenominationBreakdown(drawerData, prefix) {
      if (!drawerData) return `<div style="color: #999; font-style: italic;">No data available</div>`;
      
      const counts = drawerData.counts || drawerData;
      
      return `
        <div>$100: ${counts.hundreds || 0} = $${((counts.hundreds || 0) * 100).toFixed(2)}</div>
        <div>$50: ${counts.fifties || 0} = $${((counts.fifties || 0) * 50).toFixed(2)}</div>
        <div>$20: ${counts.twenties || 0} = $${((counts.twenties || 0) * 20).toFixed(2)}</div>
        <div>$10: ${counts.tens || 0} = $${((counts.tens || 0) * 10).toFixed(2)}</div>
        <div>$5: ${counts.fives || 0} = $${((counts.fives || 0) * 5).toFixed(2)}</div>
        <div>$1: ${counts.ones || 0} = $${((counts.ones || 0) * 1).toFixed(2)}</div>
        <div>¬¢25: ${counts.quarters || 0} = $${((counts.quarters || 0) * 0.25).toFixed(2)}</div>
        <div>¬¢10: ${counts.dimes || 0} = $${((counts.dimes || 0) * 0.10).toFixed(2)}</div>
        <div>¬¢5: ${counts.nickels || 0} = $${((counts.nickels || 0) * 0.05).toFixed(2)}</div>
        <div>¬¢1: ${counts.pennies || 0} = $${((counts.pennies || 0) * 0.01).toFixed(2)}</div>
      `;
    }
    
    return `
      <div style="font-family: Arial, sans-serif; margin: 0; padding: 8px; font-size: 12px; line-height: 1.3; max-width: 800px;">
        
        <div style="text-align: center; font-weight: bold; font-size: 18px; margin-bottom: 4px; border-bottom: 2px solid #000; padding-bottom: 6px;">
          JAYNA GYRO DAILY CASH REPORT
        </div>
        
        <div style="text-align: center; font-weight: bold; font-size: 16px; margin-bottom: 12px; padding-bottom: 6px;">
          ${dayOfWeek} ${formattedDate}
        </div>

        <!-- Staff and Timing Info -->
        <div style="border: 1px solid #000; margin: 6px 0; padding: 8px;">
          <div style="display: table; width: 100%;">
            <div style="display: table-cell; width: 50%; vertical-align: top; padding: 0 6px; border-right: 1px solid #ccc;">
              <div style="display: flex; justify-content: space-between; margin: 2px 0; max-width: 180px;">
                <span style="font-weight: bold; text-align: right; padding-right: 10px;">AM Counter:</span>
                <span style="text-align: left; font-weight: bold;">${fullData.am_counter || 'N/A'}</span>
              </div>
              <div style="display: flex; justify-content: space-between; margin: 2px 0; max-width: 180px;">
                <span style="font-weight: bold; text-align: right; padding-right: 10px;">AM Time:</span>
                <span style="text-align: left; font-weight: bold;">${fullData.am_timestamp ? new Date(fullData.am_timestamp).toLocaleString() : 'N/A'}</span>
              </div>
            </div>
            <div style="display: table-cell; width: 50%; vertical-align: top; padding: 0 6px;">
              <div style="display: flex; justify-content: space-between; margin: 2px 0; max-width: 180px;">
                <span style="font-weight: bold; text-align: right; padding-right: 10px;">PM Counter:</span>
                <span style="text-align: left; font-weight: bold;">${fullData.pm_counter || 'N/A'}</span>
              </div>
              <div style="display: flex; justify-content: space-between; margin: 2px 0; max-width: 180px;">
                <span style="font-weight: bold; text-align: right; padding-right: 10px;">PM Time:</span>
                <span style="text-align: left; font-weight: bold;">${fullData.pm_timestamp ? new Date(fullData.pm_timestamp).toLocaleString() : 'N/A'}</span>
              </div>
            </div>
          </div>
        </div>

        ${amTotal > 0 ? `
        <!-- Cash Summary -->
        <div style="border: 1px solid #000; margin: 6px 0; padding: 8px;">
          <div style="font-weight: bold; font-size: 14px; text-align: center; margin-bottom: 6px; border-bottom: 1px solid #000; padding-bottom: 3px;">CASH FLOW SUMMARY</div>
          <div style="display: table; width: 100%;">
            <div style="display: table-cell; width: 50%; vertical-align: top; padding: 0 6px; border-right: 1px solid #ccc;">
              <div style="display: flex; justify-content: space-between; margin: 2px 0; max-width: 180px;">
                <span style="font-weight: bold; text-align: right; padding-right: 10px;">Starting Cash (AM):</span>
                <span style="text-align: left; font-weight: bold;">$${amTotal.toFixed(2)}</span>
              </div>
              <div style="display: flex; justify-content: space-between; margin: 2px 0; max-width: 180px;">
                <span style="font-weight: bold; text-align: right; padding-right: 10px;">Ending Cash (PM):</span>
                <span style="text-align: left; font-weight: bold;">$${pmTotal.toFixed(2)}</span>
              </div>
              <div style="display: flex; justify-content: space-between; margin: 2px 0; max-width: 180px;">
                <span style="font-weight: bold; text-align: right; padding-right: 10px;">Actual Cash In:</span>
                <span style="text-align: left; font-weight: bold;">$${actualCashIn.toFixed(2)}</span>
              </div>
            </div>
            <div style="display: table-cell; width: 50%; vertical-align: top; padding: 0 6px;">
              <div style="display: flex; justify-content: space-between; margin: 2px 0; max-width: 180px;">
                <span style="font-weight: bold; text-align: right; padding-right: 10px;">Toast Sales:</span>
                <span style="text-align: left; font-weight: bold;">$${toastSales.toFixed(2)}</span>
              </div>
              <div style="display: flex; justify-content: space-between; margin: 2px 0; max-width: 180px;">
                <span style="font-weight: bold; text-align: right; padding-right: 10px;">Original Tips:</span>
                <span style="text-align: left; font-weight: bold;">$${originalTips.toFixed(2)}</span>
              </div>
              <div style="display: flex; justify-content: space-between; margin: 2px 0; max-width: 180px;">
                <span style="font-weight: bold; text-align: right; padding-right: 10px;">Discrepancy:</span>
                <span style="text-align: left; font-weight: bold;">${discrepancySign}$${Math.abs(discrepancy).toFixed(2)}${largeDiscrepancyFlag}</span>
              </div>
            </div>
          </div>
        </div>
        ` : ''}

        ${fullData.pm_deposit_amount ? `
        <!-- Deposit Instructions -->
        <div style="background-color: #e6ffe6; border: 2px solid #000; padding: 8px; text-align: center; font-weight: bold; font-size: 13px; margin: 6px 0;">
          DEPOSIT IN ENVELOPE: $${fullData.pm_deposit_amount}
          <div style="font-size: 10px;">(Toast Sales $${toastSales.toFixed(2)} + Original Tips $${originalTips.toFixed(2)})</div>
        </div>
        <div style="background-color: #fff0e6; border: 2px solid #000; padding: 8px; text-align: center; font-weight: bold; font-size: 13px; margin: 6px 0;">
          RETURN TO CASHBOX/SAFE: $${fullData.pm_amount_to_keep ? fullData.pm_amount_to_keep.toFixed(2) : '0.00'}
        </div>
        ` : ''}

        <!-- Notes Section -->
        <div style="display: table; width: 100%; margin: 6px 0;">
          <div style="display: table-cell; width: 50%; padding: 6px; border: 1px solid #000; vertical-align: top; text-align: center; font-weight: bold; background-color: #e6f3ff;">
            <div style="font-weight: bold; text-align: center; margin-bottom: 4px;">AM NOTES</div>
            <div style="text-align: center; font-weight: bold;">
              ${fullData.am_notes || 'No AM Notes'}
            </div>
          </div>
          <div style="display: table-cell; width: 50%; padding: 6px; border: 1px solid #000; border-left: none; vertical-align: top; text-align: center; font-weight: bold; background-color: #fff8f0;">
            <div style="font-weight: bold; text-align: center; margin-bottom: 4px;">PM NOTES</div>
            <div style="text-align: center; font-weight: bold;">
              ${fullData.pm_notes || 'No PM Notes'}
            </div>
          </div>
        </div>

        <!-- Manager Breakdown -->
        <div style="border: 1px solid #000; margin: 6px 0; padding: 8px;">
          <div style="font-weight: bold; font-size: 14px; text-align: center; margin-bottom: 6px; border-bottom: 1px solid #000; padding-bottom: 3px;">MANAGER BREAKDOWN</div>
          <div style="display: table; width: 100%;">
            <div style="display: table-row;"><div style="display: table-cell; padding: 3px 6px; border-bottom: 1px dotted #ccc; font-weight: bold; width: 50%; text-align: right; padding-right: 10px;">Starting Cash Total:</div><div style="display: table-cell; padding: 3px 6px; border-bottom: 1px dotted #ccc; text-align: left; font-weight: bold; width: 50%; padding-left: 10px;">$${amTotal.toFixed(2)}</div></div>
            <div style="display: table-row;"><div style="display: table-cell; padding: 3px 6px; border-bottom: 1px dotted #ccc; font-weight: bold; width: 50%; text-align: right; padding-right: 10px;">Ending Cash Total:</div><div style="display: table-cell; padding: 3px 6px; border-bottom: 1px dotted #ccc; text-align: left; font-weight: bold; width: 50%; padding-left: 10px;">$${pmTotal.toFixed(2)}</div></div>
            <div style="display: table-row;"><div style="display: table-cell; padding: 3px 6px; border-bottom: 1px dotted #ccc; font-weight: bold; width: 50%; text-align: right; padding-right: 10px;">Actual Cash In:</div><div style="display: table-cell; padding: 3px 6px; border-bottom: 1px dotted #ccc; text-align: left; font-weight: bold; width: 50%; padding-left: 10px;">$${actualCashIn.toFixed(2)}</div></div>
            <div style="display: table-row;"><div style="display: table-cell; padding: 3px 6px; border-bottom: 1px dotted #ccc; font-weight: bold; width: 50%; text-align: right; padding-right: 10px;">Toast Sales Reported:</div><div style="display: table-cell; padding: 3px 6px; border-bottom: 1px dotted #ccc; text-align: left; font-weight: bold; width: 50%; padding-left: 10px;">$${toastSales.toFixed(2)}</div></div>
            <div style="display: table-row;"><div style="display: table-cell; padding: 3px 6px; border-bottom: 1px dotted #ccc; font-weight: bold; width: 50%; text-align: right; padding-right: 10px;">Tips Reported by Staff:</div><div style="display: table-cell; padding: 3px 6px; border-bottom: 1px dotted #ccc; text-align: left; font-weight: bold; width: 50%; padding-left: 10px;">$${originalTips.toFixed(2)}</div></div>
            <div style="display: table-row;"><div style="display: table-cell; padding: 3px 6px; border-bottom: 1px dotted #ccc; font-weight: bold; width: 50%; text-align: right; padding-right: 10px;">Discrepancy (Drawers vs Toast):</div><div style="display: table-cell; padding: 3px 6px; border-bottom: 1px dotted #ccc; text-align: left; font-weight: bold; width: 50%; padding-left: 10px;">${discrepancySign}$${Math.abs(discrepancy).toFixed(2)}</div></div>
            ${tipAdjustment > 0 ? `
            <div style="display: table-row;"><div style="display: table-cell; padding: 3px 6px; border-bottom: 1px dotted #ccc; font-weight: bold; width: 50%; text-align: right; padding-right: 10px;">Cash Tip Adjustment:</div><div style="display: table-cell; padding: 3px 6px; border-bottom: 1px dotted #ccc; text-align: left; font-weight: bold; width: 50%; padding-left: 10px;">-$${tipAdjustment.toFixed(2)}</div></div>
            ` : ''}
            ${Math.abs(depositRoundingAdjustment) > 0.001 ? `
            <div style="display: table-row; background-color: #fff3cd;"><div style="display: table-cell; padding: 3px 6px; border-bottom: 1px dotted #ccc; font-weight: bold; width: 50%; text-align: right; padding-right: 10px;">Raw Deposit Amount:</div><div style="display: table-cell; padding: 3px 6px; border-bottom: 1px dotted #ccc; text-align: left; font-weight: bold; width: 50%; padding-left: 10px;">$${rawDepositAmount.toFixed(2)}</div></div>
            <div style="display: table-row; background-color: #fff3cd;"><div style="display: table-cell; padding: 3px 6px; border-bottom: 1px dotted #ccc; font-weight: bold; width: 50%; text-align: right; padding-right: 10px;">Rounded Deposit Amount:</div><div style="display: table-cell; padding: 3px 6px; border-bottom: 1px dotted #ccc; text-align: left; font-weight: bold; width: 50%; padding-left: 10px;">$${roundedDepositAmount}</div></div>
            <div style="display: table-row; background-color: #fff3cd;"><div style="display: table-cell; padding: 3px 6px; border-bottom: 1px dotted #ccc; font-weight: bold; width: 50%; text-align: right; padding-right: 10px;">Rounding Adjustment Needed:</div><div style="display: table-cell; padding: 3px 6px; border-bottom: 1px dotted #ccc; text-align: left; font-weight: bold; width: 50%; padding-left: 10px;">$${depositRoundingAdjustment.toFixed(2)}</div></div>
            <div style="display: table-row; background-color: #fff3cd;"><div style="display: table-cell; padding: 3px 6px; border-bottom: 1px dotted #ccc; font-weight: bold; width: 50%; text-align: right; padding-right: 10px;">Taken from Tips (Whole $):</div><div style="display: table-cell; padding: 3px 6px; border-bottom: 1px dotted #ccc; text-align: left; font-weight: bold; width: 50%; padding-left: 10px;">${depositTipAdjustment > 0 ? `-$${depositTipAdjustment.toFixed(2)}` : '-$'}</div></div>
            <div style="display: table-row; background-color: #fff3cd;"><div style="display: table-cell; padding: 3px 6px; border-bottom: 1px dotted #ccc; font-weight: bold; width: 50%; text-align: right; padding-right: 10px;">Excess to Cashbox:</div><div style="display: table-cell; padding: 3px 6px; border-bottom: 1px dotted #ccc; text-align: left; font-weight: bold; width: 50%; padding-left: 10px;">+$${depositExcessToCashbox.toFixed(2)}</div></div>
            ` : ''}
            ${fullData.pm_deposit_amount ? `
            <div style="display: table-row;"><div style="display: table-cell; padding: 3px 6px; border-bottom: 1px dotted #ccc; font-weight: bold; width: 50%; text-align: right; padding-right: 10px;">Owed to Restaurant:</div><div style="display: table-cell; padding: 3px 6px; border-bottom: 1px dotted #ccc; text-align: left; font-weight: bold; width: 50%; padding-left: 10px;">$${toastSales.toFixed(2)}</div></div>
            <div style="display: table-row;"><div style="display: table-cell; padding: 3px 6px; border-bottom: 1px dotted #ccc; font-weight: bold; width: 50%; text-align: right; padding-right: 10px;">Cash Tips Owed to Staff:</div><div style="display: table-cell; padding: 3px 6px; border-bottom: 1px dotted #ccc; text-align: left; font-weight: bold; width: 50%; padding-left: 10px;">$${fullData.pm_adjusted_tips || originalTips}</div></div>
            <div style="display: table-row;"><div style="display: table-cell; padding: 3px 6px; border-bottom: 1px dotted #ccc; font-weight: bold; width: 50%; text-align: right; padding-right: 10px;">Returned to Cashbox:</div><div style="display: table-cell; padding: 3px 6px; border-bottom: 1px dotted #ccc; text-align: left; font-weight: bold; width: 50%; padding-left: 10px;">$${returnBreakdown.toFixed(2)} + AM Total</div></div>
            ` : ''}
          </div>
        </div>

        <!-- Complete Cash Count Breakdown -->
        <div style="border: 1px solid #000; margin: 6px 0; padding: 8px;">
          <div style="font-weight: bold; font-size: 14px; text-align: center; margin-bottom: 6px; border-bottom: 1px solid #000; padding-bottom: 3px;">COMPLETE CASH COUNT BREAKDOWN</div>
          <div style="display: table; width: 100%;">
            <!-- AM Counts -->
            <div style="display: table-cell; width: 50%; vertical-align: top; padding: 0 6px; border-right: 1px solid #ccc;">
              <div style="text-align: center; font-weight: bold; font-size: 10px; margin-bottom: 4px; background-color: #e6f3ff; padding: 3px;">AM COUNTS</div>
              
              <div style="font-size: 10px; line-height: 1.2;">
                <div style="font-weight: bold; text-decoration: underline; margin-bottom: 3px;">DRAWER A</div>
                ${getDenominationBreakdown(fullData.am_drawer1_data, 'am_drawer1')}
                <div style="font-weight: bold; border-top: 1px solid #000; margin-top: 3px; padding-top: 3px;">TOTAL: $${fullData.am_drawer1_total ? fullData.am_drawer1_total.toFixed(2) : '0.00'}</div>
              </div>
              
              <div style="font-size: 10px; line-height: 1.2; margin-top: 6px;">
                <div style="font-weight: bold; text-decoration: underline; margin-bottom: 3px;">DRAWER B</div>
                ${getDenominationBreakdown(fullData.am_drawer2_data, 'am_drawer2')}
                <div style="font-weight: bold; border-top: 1px solid #000; margin-top: 3px; padding-top: 3px;">TOTAL: $${fullData.am_drawer2_total ? fullData.am_drawer2_total.toFixed(2) : '0.00'}</div>
              </div>
              
              <div style="font-weight: bold; text-align: center; padding: 4px; border: 2px solid #000; margin-top: 6px; font-size: 10px; background-color: #e6f3ff;">TOTAL AM: $${amTotal.toFixed(2)}</div>
            </div>
            
            <!-- PM Counts -->
            <div style="display: table-cell; width: 50%; vertical-align: top; padding: 0 6px;">
              <div style="text-align: center; font-weight: bold; font-size: 10px; margin-bottom: 4px; background-color: #fff8f0; padding: 3px;">PM COUNTS</div>
              
              <div style="font-size: 10px; line-height: 1.2;">
                <div style="font-weight: bold; text-decoration: underline; margin-bottom: 3px;">DRAWER A</div>
                ${getDenominationBreakdown(fullData.pm_drawer1_data, 'pm_drawer1')}
                <div style="font-weight: bold; border-top: 1px solid #000; margin-top: 3px; padding-top: 3px;">TOTAL: $${fullData.pm_drawer1_total ? fullData.pm_drawer1_total.toFixed(2) : '0.00'}</div>
              </div>
              
              <div style="font-size: 10px; line-height: 1.2; margin-top: 6px;">
                <div style="font-weight: bold; text-decoration: underline; margin-bottom: 3px;">DRAWER B</div>
                ${getDenominationBreakdown(fullData.pm_drawer2_data, 'pm_drawer2')}
                <div style="font-weight: bold; border-top: 1px solid #000; margin-top: 3px; padding-top: 3px;">TOTAL: $${fullData.pm_drawer2_total ? fullData.pm_drawer2_total.toFixed(2) : '0.00'}</div>
              </div>
              
              <div style="font-weight: bold; text-align: center; padding: 4px; border: 2px solid #000; margin-top: 6px; font-size: 10px; background-color: #fff8f0;">TOTAL PM: $${pmTotal.toFixed(2)}</div>
            </div>
          </div>
        </div>
      </div>
    `;
  }

  // Generate PM Flow Single Day PDF Report
  async function generatePMFlowSingleDayPDF(fullData, reportDate) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'letter' });
    
    const pageWidth = doc.internal.pageSize.getWidth();
    const pageHeight = doc.internal.pageSize.getHeight();
    const margin = 20; // Tight margins like screenshot
    let currentY = margin + 10;
    
    // Helper function to draw bordered sections like screenshot
    function drawBorderedSection(x, y, width, height, fillColor = null) {
      doc.setDrawColor(0, 0, 0);
      doc.setLineWidth(0.5);
      if (fillColor) {
        doc.setFillColor(fillColor[0], fillColor[1], fillColor[2]);
        doc.rect(x, y, width, height, 'FD');
      } else {
        doc.rect(x, y, width, height, 'S');
      }
    }
    
    // Helper function for denomination breakdown in tight format
    function drawDenominationBreakdown(drawerData, startX, startY, width, title) {
      let y = startY + 10;
      
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(8);
      doc.text(title, startX + 3, y);
      y += 12;
      
      if (!drawerData) {
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(7);
        doc.text('(Detailed counts not available)', startX + 3, y);
        return y + 15;
      }
      
      // Handle JSON string data from database
      let counts = drawerData;
      if (typeof drawerData === 'string') {
        try {
          counts = JSON.parse(drawerData);
        } catch (e) {
          doc.setFont('helvetica', 'normal');
          doc.setFontSize(7);
          doc.text('(Detailed counts not available)', startX + 3, y);
          return y + 15;
        }
      }
      
      // Access counts property if it exists, otherwise use the object directly
      if (counts && counts.counts) {
        counts = counts.counts;
      }
      
      if (!counts || typeof counts !== 'object') {
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(7);
        doc.text('(Detailed counts not available)', startX + 3, y);
        return y + 15;
      }
      
      doc.setFont('helvetica', 'normal');
      doc.setFontSize(7);
      
      // All denominations in tight format
      const denominations = [
        { name: '$100', field: 'hundreds', value: 100 },
        { name: '$50', field: 'fifties', value: 50 },
        { name: '$20', field: 'twenties', value: 20 },
        { name: '$10', field: 'tens', value: 10 },
        { name: '$5', field: 'fives', value: 5 },
        { name: '$1', field: 'ones', value: 1 },
        { name: '¬¢25', field: 'quarters', value: 0.25 },
        { name: '¬¢10', field: 'dimes', value: 0.10 },
        { name: '¬¢5', field: 'nickels', value: 0.05 },
        { name: '¬¢1', field: 'pennies', value: 0.01 }
      ];
      
      let hasAnyData = false;
      denominations.forEach(denom => {
        const count = counts[denom.field] || 0;
        if (count > 0) {
          hasAnyData = true;
          const total = (count * denom.value).toFixed(2);
          doc.text(`${denom.name}: ${count} = $${total}`, startX + 3, y);
          y += 9;
        }
      });
      
      // If no denomination data, show fallback message
      if (!hasAnyData) {
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(7);
        doc.text('(Detailed counts not available)', startX + 3, y);
        y += 12;
      }
      
      return y;
    }
    
    // Format date
    const dateObj = new Date(reportDate + 'T00:00:00');
    const dayOfWeek = dateObj.toLocaleDateString('en-US', { weekday: 'long' }).toUpperCase();
    const formattedDate = dateObj.toLocaleDateString('en-US', { 
      year: 'numeric', 
      month: 'long', 
      day: 'numeric' 
    }).toUpperCase();
    
    // Calculate amounts
    const amTotal = fullData.am_total || 0;
    const pmTotal = fullData.pm_total || 0;
    const toastSales = fullData.pm_toast_sales || 0;
    const originalTips = fullData.pm_cash_tips || 0;
    const actualCashIn = pmTotal - amTotal;
    const discrepancy = actualCashIn - toastSales;
    const discrepancySign = discrepancy >= 0 ? '+' : '-';
    
    // Debug: Log the drawer data structure
    console.log('PDF Generation - Drawer Data Debug:');
    console.log('AM Drawer 1:', fullData.am_drawer1_data);
    console.log('AM Drawer 2:', fullData.am_drawer2_data); 
    console.log('PM Drawer 1:', fullData.pm_drawer1_data);
    console.log('PM Drawer 2:', fullData.pm_drawer2_data);
    
    const tipAdjustment = (originalTips - (fullData.pm_adjusted_tips || originalTips));
    const rawDepositAmount = fullData.pm_deposit_amount ? (toastSales + originalTips) : 0;
    const roundedDepositAmount = fullData.pm_deposit_amount || 0;
    const depositRoundingAdjustment = rawDepositAmount - roundedDepositAmount;
    const depositTipAdjustment = fullData.pm_adjusted_tips ? (originalTips - fullData.pm_adjusted_tips) : 0;
    const depositExcessToCashbox = Math.abs(depositRoundingAdjustment);
    const returnBreakdown = fullData.pm_amount_to_keep ? (fullData.pm_amount_to_keep - amTotal) : 0;
    
    // Header - exactly like screenshot
    drawBorderedSection(margin, currentY, pageWidth - 2 * margin, 25);
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(14);
    doc.text('JAYNA GYRO DAILY CASH REPORT', pageWidth / 2, currentY + 17, { align: 'center' });
    currentY += 25;
    
    // Date header - tight
    drawBorderedSection(margin, currentY, pageWidth - 2 * margin, 20);
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(12);
    doc.text(`${dayOfWeek} ${formattedDate}`, pageWidth / 2, currentY + 14, { align: 'center' });
    currentY += 20;
    
    // Staff info - tight like screenshot
    drawBorderedSection(margin, currentY, pageWidth - 2 * margin, 35);
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(8);
    
    const amTime = fullData.am_timestamp ? new Date(fullData.am_timestamp).toLocaleString() : 'N/A';
    const pmTime = fullData.pm_timestamp ? new Date(fullData.pm_timestamp).toLocaleString() : 'N/A';
    
    doc.text(`AM Counter: ${fullData.am_counter || 'N/A'}`, margin + 5, currentY + 12);
    doc.text(`AM Time: ${amTime}`, margin + 5, currentY + 24);
    doc.text(`PM Counter: ${fullData.pm_counter || 'N/A'}`, pageWidth / 2 + 5, currentY + 12);
    doc.text(`PM Time: ${pmTime}`, pageWidth / 2 + 5, currentY + 24);
    currentY += 35;
    
    // Cash Flow Summary header
    drawBorderedSection(margin, currentY, pageWidth - 2 * margin, 15);
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(10);
    doc.text('CASH FLOW SUMMARY', pageWidth / 2, currentY + 11, { align: 'center' });
    currentY += 15;
    
    // Cash flow content
    drawBorderedSection(margin, currentY, pageWidth - 2 * margin, 50);
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(8);
    
    // Left column - right aligned
    doc.text(`Starting Cash (AM): $${amTotal.toFixed(2)}`, pageWidth / 2 - 5, currentY + 12, { align: 'right' });
    doc.text(`Ending Cash (PM): $${pmTotal.toFixed(2)}`, pageWidth / 2 - 5, currentY + 24, { align: 'right' });
    doc.text(`Actual Cash In: $${actualCashIn.toFixed(2)}`, pageWidth / 2 - 5, currentY + 36, { align: 'right' });
    
    // Right column - left aligned
    doc.text(`Toast Sales: $${toastSales.toFixed(2)}`, pageWidth / 2 + 5, currentY + 12);
    doc.text(`Original Tips: $${originalTips.toFixed(2)}`, pageWidth / 2 + 5, currentY + 24);
    doc.text(`Discrepancy: ${discrepancySign}$${Math.abs(discrepancy).toFixed(2)}`, pageWidth / 2 + 5, currentY + 36);
    currentY += 50;
    
    // Deposit sections - highlighted like screenshot
    if (fullData.pm_deposit_amount) {
      drawBorderedSection(margin, currentY, pageWidth - 2 * margin, 20, [230, 255, 230]);
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(10);
      doc.text(`DEPOSIT IN ENVELOPE: $${fullData.pm_deposit_amount}`, pageWidth / 2, currentY + 14, { align: 'center' });
      currentY += 20;
      
      drawBorderedSection(margin, currentY, pageWidth - 2 * margin, 15, [255, 240, 230]);
      const returnAmount = fullData.pm_amount_to_keep ? fullData.pm_amount_to_keep.toFixed(2) : '0.00';
      doc.text(`RETURN TO CASHBOX/SAFE: $${returnAmount}`, pageWidth / 2, currentY + 11, { align: 'center' });
      currentY += 15;
    }
    
    // Notes header
    drawBorderedSection(margin, currentY, pageWidth - 2 * margin, 15);
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(8);
    doc.text('AM NOTES', margin + (pageWidth - 2 * margin) / 4, currentY + 11, { align: 'center' });
    doc.text('PM NOTES', margin + 3 * (pageWidth - 2 * margin) / 4, currentY + 11, { align: 'center' });
    currentY += 15;
    
    // Notes content
    drawBorderedSection(margin, currentY, pageWidth - 2 * margin, 25);
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(8);
    const amNotes = fullData.am_notes || 'No AM Notes';
    const pmNotes = fullData.pm_notes || 'No PM Notes';
    // Center-align notes content
    doc.text(amNotes, margin + (pageWidth - 2 * margin) / 4, currentY + 15, { align: 'center', maxWidth: (pageWidth - 2 * margin) / 2 - 10 });
    doc.text(pmNotes, margin + 3 * (pageWidth - 2 * margin) / 4, currentY + 15, { align: 'center', maxWidth: (pageWidth - 2 * margin) / 2 - 10 });
    currentY += 25;
    
    // Manager Breakdown header
    drawBorderedSection(margin, currentY, pageWidth - 2 * margin, 15);
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(10);
    doc.text('MANAGER BREAKDOWN', pageWidth / 2, currentY + 11, { align: 'center' });
    currentY += 15;
    
    // Manager breakdown items
    const managerItems = [
      ['Starting Cash Total:', `$${amTotal.toFixed(2)}`],
      ['Ending Cash Total:', `$${pmTotal.toFixed(2)}`],
      ['Actual Cash In:', `$${actualCashIn.toFixed(2)}`],
      ['Toast Sales Reported:', `$${toastSales.toFixed(2)}`],
      ['Tips Reported by Staff:', `$${originalTips.toFixed(2)}`],
      ['Discrepancy (Drawers vs Toast):', `${discrepancySign}$${Math.abs(discrepancy).toFixed(2)}`]
    ];
    
    if (tipAdjustment > 0) {
      managerItems.push(['Cash Tip Adjustment:', `-$${tipAdjustment.toFixed(2)}`]);
    }
    
    if (Math.abs(depositRoundingAdjustment) > 0.001) {
      managerItems.push(
        ['Raw Deposit Amount:', `$${rawDepositAmount.toFixed(2)}`],
        ['Rounded Deposit Amount:', `$${roundedDepositAmount}`],
        ['Rounding Adjustment Needed:', `$${depositRoundingAdjustment.toFixed(2)}`],
        ['Taken from Tips (Whole $):', depositTipAdjustment > 0 ? `-$${depositTipAdjustment.toFixed(2)}` : '-$'],
        ['Excess to Cashbox:', `+$${depositExcessToCashbox.toFixed(2)}`]
      );
    }
    
    if (fullData.pm_deposit_amount) {
      managerItems.push(
        ['Owed to Restaurant:', `$${toastSales.toFixed(2)}`],
        ['Cash Tips Owed to Staff:', `$${fullData.pm_adjusted_tips || originalTips}`],
        ['Returned to Cashbox:', `$${returnBreakdown.toFixed(2)} + AM Total`]
      );
    }
    
    const managerHeight = managerItems.length * 10 + 15;
    drawBorderedSection(margin, currentY, pageWidth - 2 * margin, managerHeight);
    
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(8);
    let managerY = currentY + 12;
    
    // Calculate center point with small gap
    const centerPoint = pageWidth / 2;
    const gapSize = 5; // Small gap between label and value
    
    managerItems.forEach(([label, value]) => {
      // Right-align labels to center minus gap
      doc.text(label, centerPoint - gapSize, managerY, { align: 'right' });
      // Left-align values from center plus gap
      doc.text(value, centerPoint + gapSize, managerY);
      managerY += 10;
    });
    
    currentY += managerHeight;
    
    // Complete Cash Count Breakdown header
    drawBorderedSection(margin, currentY, pageWidth - 2 * margin, 15);
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(10);
    doc.text('COMPLETE CASH COUNT BREAKDOWN', pageWidth / 2, currentY + 11, { align: 'center' });
    currentY += 15;
    
    // AM/PM headers
    drawBorderedSection(margin, currentY, pageWidth - 2 * margin, 15);
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(9);
    doc.text('AM COUNTS', margin + (pageWidth - 2 * margin) / 4, currentY + 11, { align: 'center' });
    doc.text('PM COUNTS', margin + 3 * (pageWidth - 2 * margin) / 4, currentY + 11, { align: 'center' });
    currentY += 15;
    
    // Calculate dynamic breakdown section height
    const halfWidth = (pageWidth - 2 * margin) / 2;
    
    // First, calculate the content without drawing to get the height
    let tempY = currentY + 10;
    let amY1 = tempY + 25; // Estimate for Drawer 1 start
    let pmY1 = tempY + 25;
    
    // Estimate heights based on data availability
    const estimateDrawerHeight = (drawerData) => {
      if (!drawerData) return 25;
      let count = 0;
      
      // Parse and count denominations
      let counts = drawerData;
      if (typeof drawerData === 'string') {
        try { counts = JSON.parse(drawerData); } catch (e) { return 25; }
      }
      if (counts && counts.counts) counts = counts.counts;
      if (!counts) return 25;
      
      const denominations = ['hundreds', 'fifties', 'twenties', 'tens', 'fives', 'ones', 'quarters', 'dimes', 'nickels', 'pennies'];
      denominations.forEach(field => { if ((counts[field] || 0) > 0) count++; });
      
      return Math.max(25, count * 9 + 20); // 9px per line + header
    };
    
    const am1Height = estimateDrawerHeight(fullData.am_drawer1_data);
    const pm1Height = estimateDrawerHeight(fullData.pm_drawer1_data);
    const am2Height = estimateDrawerHeight(fullData.am_drawer2_data);
    const pm2Height = estimateDrawerHeight(fullData.pm_drawer2_data);
    
    const drawer1MaxHeight = Math.max(am1Height, pm1Height);
    const drawer2MaxHeight = Math.max(am2Height, pm2Height);
    const breakdownHeight = drawer1MaxHeight + drawer2MaxHeight + 40; // Extra padding
    
    // Now draw the actual section
    drawBorderedSection(margin, currentY, pageWidth - 2 * margin, breakdownHeight);
    
    // Draw vertical divider
    doc.setDrawColor(0, 0, 0);
    doc.setLineWidth(0.5);
    doc.line(margin + halfWidth, currentY, margin + halfWidth, currentY + breakdownHeight);
    
    // Drawer 1 breakdowns
    let amY1Actual = drawDenominationBreakdown(fullData.am_drawer1_data, margin, currentY, halfWidth, 'DRAWER 1');
    let pmY1Actual = drawDenominationBreakdown(fullData.pm_drawer1_data, margin + halfWidth, currentY, halfWidth, 'DRAWER 1');
    
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(8);
    doc.text(`TOTAL: $${fullData.am_drawer1_total ? fullData.am_drawer1_total.toFixed(2) : '0.00'}`, margin + 3, amY1Actual + 8);
    doc.text(`TOTAL: $${fullData.pm_drawer1_total ? fullData.pm_drawer1_total.toFixed(2) : '0.00'}`, margin + halfWidth + 3, pmY1Actual + 8);
    
    let drawerMidY = Math.max(amY1Actual, pmY1Actual) + 18;
    
    // Drawer 2 breakdowns
    let amY2Actual = drawDenominationBreakdown(fullData.am_drawer2_data, margin, drawerMidY, halfWidth, 'DRAWER 2');
    let pmY2Actual = drawDenominationBreakdown(fullData.pm_drawer2_data, margin + halfWidth, drawerMidY, halfWidth, 'DRAWER 2');
    
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(8);
    doc.text(`TOTAL: $${fullData.am_drawer2_total ? fullData.am_drawer2_total.toFixed(2) : '0.00'}`, margin + 3, amY2Actual + 8);
    doc.text(`TOTAL: $${fullData.pm_drawer2_total ? fullData.pm_drawer2_total.toFixed(2) : '0.00'}`, margin + halfWidth + 3, pmY2Actual + 8);
    
    currentY += breakdownHeight;
    
    // Final totals - highlighted like screenshot
    drawBorderedSection(margin, currentY, halfWidth, 20, [230, 243, 255]);
    drawBorderedSection(margin + halfWidth, currentY, halfWidth, 20, [255, 248, 240]);
    
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(10);
    doc.text(`TOTAL AM: $${amTotal.toFixed(2)}`, margin + halfWidth / 2, currentY + 14, { align: 'center' });
    doc.text(`TOTAL PM: $${pmTotal.toFixed(2)}`, margin + halfWidth + halfWidth / 2, currentY + 14, { align: 'center' });
    
    // Save PDF
    const fileName = `Jayna_Gyro_Daily_Report_${reportDate}.pdf`;
    doc.save(fileName);
  }

  // Generate Single Day PDF Report
  async function generateSingleDayPDF(dayData, reportDate) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'letter' });
    
    const pageWidth = doc.internal.pageSize.getWidth();
    const pageHeight = doc.internal.pageSize.getHeight();
    const margin = 40;
    let currentY = margin;
    
    // Helper function to check for page break and add new page if needed
    function checkPageBreak(requiredSpace) {
      if (currentY + requiredSpace > pageHeight - margin) {
        doc.addPage();
        currentY = margin;
        return true;
      }
      return false;
    }
    
    // Helper function to add a colored section header
    function addSectionHeader(title, color = [102, 126, 234]) {
      checkPageBreak(35);
      doc.setFillColor(color[0], color[1], color[2]);
      doc.rect(margin, currentY, pageWidth - 2 * margin, 25, 'F');
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(12);
      doc.setTextColor(255, 255, 255);
      doc.text(title, margin + 10, currentY + 16);
      currentY += 35;
      doc.setTextColor(0, 0, 0); // Reset text color
    }
    
    // Header with enhanced styling
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(20);
    doc.setTextColor(50, 50, 50);
    doc.text('JAYNA GYRO DAILY REPORT', margin, currentY);
    
    currentY += 30;
    const formattedDate = new Date(reportDate).toLocaleDateString('en-US', { 
      weekday: 'long', 
      year: 'numeric', 
      month: 'long', 
      day: 'numeric' 
    });
    
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(14);
    doc.setTextColor(102, 126, 234);
    doc.text(`${formattedDate.toUpperCase()}`, margin, currentY);
    
    currentY += 20;
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(9);
    doc.setTextColor(100, 100, 100);
    doc.text(`Generated: ${new Date().toLocaleString().toUpperCase()}`, margin, currentY);
    doc.text(`Night Counter: ${(dayData.night_counter || 'N/A').toUpperCase()}`, margin, currentY + 12);
    
    currentY += 35;
    
    // Summary Cards Section
    addSectionHeader('FINANCIAL SUMMARY', [102, 126, 234]);
    
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(10);
    
    const summaryData = [
      ['TOAST SALES REPORTED:', `$${dayData.toast_sales?.toFixed(2) || '0.00'}`, [40, 167, 69]],
      ['ACTUAL CASH COLLECTED:', `$${dayData.actual_cash_in?.toFixed(2) || '0.00'}`, [23, 162, 184]],
      ['CASH DISCREPANCY:', `${dayData.discrepancy >= 0 ? '+' : ''}$${Math.abs(dayData.discrepancy || 0).toFixed(2)}`, dayData.discrepancy >= 0 ? [40, 167, 69] : [220, 53, 69]],
      ['EXCESS TO TIPS:', `$${dayData.excess?.toFixed(2) || '0.00'}`, [111, 66, 193]]
    ];
    
    summaryData.forEach((row, index) => {
      checkPageBreak(20);
      
      // Background color for alternating rows
      if (index % 2 === 0) {
        doc.setFillColor(248, 249, 250);
        doc.rect(margin, currentY - 5, pageWidth - 2 * margin, 18, 'F');
      }
      
      doc.setFont('helvetica', 'bold');
      doc.setTextColor(73, 80, 87);
      doc.text(row[0], margin + 10, currentY + 8);
      
      doc.setFont('helvetica', 'bold');
      doc.setTextColor(row[2][0], row[2][1], row[2][2]);
      const valueWidth = doc.getTextWidth(row[1]);
      doc.text(row[1], pageWidth - margin - valueWidth - 10, currentY + 8);
      
      currentY += 18;
    });
    
    currentY += 20;
    
    // Performance Analysis Section
    addSectionHeader('PERFORMANCE ANALYSIS', [240, 147, 251]);
    
    const variance = ((Math.abs(dayData.discrepancy || 0) / (dayData.toast_sales || 1)) * 100);
    const accuracyStatus = Math.abs(dayData.discrepancy || 0) < 5 ? 'EXCELLENT (98%+)' : 
                          Math.abs(dayData.discrepancy || 0) < 20 ? 'GOOD (95%+)' : 
                          'NEEDS REVIEW (90%-)';
    const statusColor = Math.abs(dayData.discrepancy || 0) < 5 ? [40, 167, 69] : 
                       Math.abs(dayData.discrepancy || 0) < 20 ? [255, 193, 7] : 
                       [220, 53, 69];
    
    const performanceData = [
      ['ACCURACY RATING:', accuracyStatus, statusColor],
      ['VARIANCE PERCENTAGE:', `${variance.toFixed(2)}%`, [108, 117, 125]],
      ['OPERATIONAL STATUS:', Math.abs(dayData.discrepancy || 0) < 10 ? 'BALANCED' : 'REVIEW NEEDED', Math.abs(dayData.discrepancy || 0) < 10 ? [40, 167, 69] : [255, 193, 7]]
    ];
    
    performanceData.forEach((row, index) => {
      checkPageBreak(20);
      
      if (index % 2 === 0) {
        doc.setFillColor(248, 249, 250);
        doc.rect(margin, currentY - 5, pageWidth - 2 * margin, 18, 'F');
      }
      
      doc.setFont('helvetica', 'bold');
      doc.setTextColor(73, 80, 87);
      doc.text(row[0], margin + 10, currentY + 8);
      
      doc.setFont('helvetica', 'bold');
      doc.setTextColor(row[2][0], row[2][1], row[2][2]);
      const valueWidth = doc.getTextWidth(row[1]);
      doc.text(row[1], pageWidth - margin - valueWidth - 10, currentY + 8);
      
      currentY += 18;
    });
    
    currentY += 20;
    
    // Detailed Data Table Section
    addSectionHeader('COMPLETE DATA SUMMARY', [79, 172, 254]);
    
    const weekStart = new Date(dayData.weekly_combined_reports.week_start_date).toLocaleDateString();
    const weekEnd = new Date(dayData.weekly_combined_reports.week_end_date).toLocaleDateString();
    
    const detailedData = [
      ['Report Date:', formattedDate],
      ['Night Counter:', dayData.night_counter || 'N/A'],
      ['Toast Sales:', `$${dayData.toast_sales?.toFixed(2) || '0.00'}`],
      ['Actual Cash In:', `$${dayData.actual_cash_in?.toFixed(2) || '0.00'}`],
      ['Discrepancy:', `${dayData.discrepancy >= 0 ? '+' : ''}$${Math.abs(dayData.discrepancy || 0).toFixed(2)}`],
      ['Excess Amount:', `$${dayData.excess?.toFixed(2) || '0.00'}`],
      ['Report Week:', `${weekStart} - ${weekEnd}`],
      ['Weekly Report By:', dayData.weekly_combined_reports.generated_by || 'N/A']
    ];
    
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(9);
    doc.setTextColor(80, 80, 80);
    
    // Table headers
    checkPageBreak(25);
    doc.setFillColor(52, 58, 64);
    doc.rect(margin, currentY, (pageWidth - 2 * margin) * 0.6, 20, 'F');
    doc.rect(margin + (pageWidth - 2 * margin) * 0.6, currentY, (pageWidth - 2 * margin) * 0.4, 20, 'F');
    
    doc.setTextColor(255, 255, 255);
    doc.text('FIELD', margin + 10, currentY + 13);
    doc.text('VALUE', margin + (pageWidth - 2 * margin) * 0.6 + 10, currentY + 13);
    currentY += 20;
    
    // Table data
    detailedData.forEach((row, index) => {
      checkPageBreak(18);
      
      // Alternating row colors
      const bgColor = index % 2 === 0 ? [248, 249, 250] : [255, 255, 255];
      doc.setFillColor(bgColor[0], bgColor[1], bgColor[2]);
      doc.rect(margin, currentY, pageWidth - 2 * margin, 18, 'F');
      
      // Border lines
      doc.setDrawColor(222, 226, 230);
      doc.setLineWidth(0.5);
      doc.line(margin, currentY + 18, pageWidth - margin, currentY + 18);
      doc.line(margin + (pageWidth - 2 * margin) * 0.6, currentY, margin + (pageWidth - 2 * margin) * 0.6, currentY + 18);
      
      doc.setFont('helvetica', 'bold');
      doc.setTextColor(73, 80, 87);
      doc.text(row[0], margin + 10, currentY + 12);
      
      doc.setFont('helvetica', 'normal');
      doc.setTextColor(33, 37, 41);
      doc.text(row[1], margin + (pageWidth - 2 * margin) * 0.6 + 10, currentY + 12);
      
      currentY += 18;
    });
    
    currentY += 30;
    
    // Performance Benchmarks Section
    addSectionHeader('PERFORMANCE BENCHMARKS', [255, 112, 67]);
    
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(9);
    doc.setTextColor(73, 80, 87);
    
    const benchmarks = [
      '‚Ä¢ EXCELLENT: Discrepancy under $5.00 (98%+ accuracy)',
      '‚Ä¢ GOOD: Discrepancy $5.00-$20.00 (95%+ accuracy)', 
      '‚Ä¢ REVIEW NEEDED: Discrepancy over $20.00 (requires management attention)',
      '',
      '‚Ä¢ DISCREPANCY: Difference between expected and actual cash (negative = short, positive = over)',
      '‚Ä¢ EXCESS: Amount taken from tips to balance daily operations and account for variances'
    ];
    
    benchmarks.forEach(benchmark => {
      checkPageBreak(15);
      doc.text(benchmark, margin + 10, currentY);
      currentY += 15;
    });
    
    // Footer
    if (currentY < pageHeight - 100) {
      currentY = pageHeight - 80;
    } else {
      checkPageBreak(80);
    }
    
    doc.setDrawColor(222, 226, 230);
    doc.setLineWidth(1);
    doc.line(margin, currentY, pageWidth - margin, currentY);
    currentY += 15;
    
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(8);
    doc.setTextColor(73, 80, 87);
    const creditText = 'Jayna Gyro Cash Counter v3.0+ | Report Generation App';
    const emailText = 'Designed and coded by Demetri Gregorakis | demetri_gregorakis@icloud.com';
    
    const creditWidth = doc.getTextWidth(creditText);
    const emailWidth = doc.getTextWidth(emailText);
    const centerXCredit = (pageWidth - creditWidth) / 2;
    const centerXEmail = (pageWidth - emailWidth) / 2;
    
    doc.text(creditText, centerXCredit, currentY);
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(7);
    doc.setTextColor(108, 117, 125);
    doc.text(emailText, centerXEmail, currentY + 12);
    
    // Save PDF with enhanced filename
    const filename = `Jayna_Daily_Report_${reportDate.replace(/-/g, '_')}_Enhanced.pdf`;
    doc.save(filename);
  }

  // Generate Weekly Historical PDF Report
  async function generateWeeklyHistoricalPDF(weeklyData, startDate, endDate) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'letter' });
    
    const pageWidth = doc.internal.pageSize.getWidth();
    const margin = 40;
    let currentY = margin;
    
    // Header
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(16);
    doc.setTextColor(0, 0, 0);
    doc.text('JAYNA GYRO HISTORICAL WEEKLY REPORT', margin, currentY + 12);
    
    currentY += 30;
    doc.setFontSize(9);
    doc.setFont('helvetica', 'normal');
    const dateRange = `${startDate.toUpperCase()} TO ${endDate.toUpperCase()}`;
    doc.text(`WEEK OF: ${dateRange}`, margin, currentY);
    doc.text(`GENERATED BY: ${(weeklyData.generated_by || 'N/A').toUpperCase()}`, margin, currentY + 12);
    doc.text(`GENERATED: ${new Date().toLocaleString().toUpperCase()}`, margin, currentY + 24);
    
    // Summary section
    currentY += 50;
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(12);
    doc.text('WEEKLY SUMMARY', margin, currentY);
    
    currentY += 20;
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(9);
    
    // Build summary lines with voided tips breakdown if applicable
    const summaryLines = [
      `TOAST CASH SALES REPORTED: $${weeklyData.total_toast_sales.toFixed(2)}`,
      `ACTUAL CASH IN: $${weeklyData.actual_cash_in.toFixed(2)}`,
      `TOTAL DISCREPANCY: $${weeklyData.total_discrepancy.toFixed(2)}`,
      `ENVELOPE DEPOSITS: $${weeklyData.envelope_deposits.toFixed(2)}`
    ];

    // Add credit tips breakdown if voided tips exist
    if (tipPoolSummary.voidedTipsTotal && tipPoolSummary.voidedTipsTotal > 0) {
      summaryLines.push(`CREDIT TIPS (GROSS): $${tipPoolSummary.creditTipsGross.toFixed(2)}`);
      summaryLines.push(`  - VOIDED TIPS: -$${tipPoolSummary.voidedTipsTotal.toFixed(2)}`);
      summaryLines.push(`CREDIT TIPS (NET): $${weeklyData.credit_tips.toFixed(2)}`);
    } else {
      summaryLines.push(`CREDIT TIPS: $${weeklyData.credit_tips.toFixed(2)}`);
    }

    summaryLines.push(
      `CASH TIPS: $${weeklyData.cash_tips.toFixed(2)}`,
      `EZCATER TIPS: $${weeklyData.ezcater_tips.toFixed(2)}`,
      `TOTAL TIPS: $${weeklyData.total_tips.toFixed(2)}`,
      `TDS DRIVER: $${weeklyData.tds_driver_tips.toFixed(2)}`,
      `TIP POOL TOTAL (MINUS TDS): $${weeklyData.tip_pool_total.toFixed(2)}`,
      `HOURLY RATE: $${weeklyData.hourly_rate.toFixed(2)}`,
      `CASH NEEDED: $${weeklyData.cash_needed.toFixed(2)}`
    );
    
    summaryLines.forEach((line, index) => {
      if (index % 2 === 0) {
        doc.text(line, margin, currentY + Math.floor(index / 2) * 15);
      } else {
        doc.text(line, margin + 280, currentY + Math.floor(index / 2) * 15);
      }
    });
    
    // Employee tips table
    if (weeklyData.weekly_employee_tips && weeklyData.weekly_employee_tips.length > 0) {
      currentY += Math.ceil(summaryLines.length / 2) * 15 + 30;
      
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(12);
      doc.text('EMPLOYEE TIP DISTRIBUTION', margin, currentY);
      
      currentY += 20;
      
      const employeeTableData = weeklyData.weekly_employee_tips.map(emp => [
        `${emp.employee_first_name} ${emp.employee_last_name}`,
        emp.hours_worked.toFixed(1),
        emp.equity_percentage.toFixed(0),
        emp.weighted_hours.toFixed(1),
        `$${emp.tips_due.toFixed(2)}`
      ]);
      
      doc.autoTable({
        head: [['EMPLOYEE', 'HOURS', 'EQUITY (%)', 'WEIGHTED', 'DUE']],
        body: employeeTableData,
        startY: currentY,
        margin: { left: margin, right: margin },
        styles: { font: 'helvetica', fontSize: 8, textColor: [0, 0, 0] },
        headStyles: { font: 'helvetica', fontStyle: 'bold', fillColor: [245, 245, 245] }
      });
      
      currentY = doc.autoTable.previous.finalY + 20;
    }
    
    // Daily breakdown table
    if (weeklyData.weekly_daily_breakdown && weeklyData.weekly_daily_breakdown.length > 0) {
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(12);
      doc.text('DAILY CASH BREAKDOWN', margin, currentY);
      
      currentY += 15;
      doc.setFont('helvetica', 'normal');
      doc.setFontSize(8);
      doc.text(`* Only showing ${weeklyData.weekly_daily_breakdown.length} days with PM cash count data`, margin, currentY);
      
      currentY += 15;
      
      // Filter and format the data better
      const dailyTableData = weeklyData.weekly_daily_breakdown
        .filter(day => day.toast_sales > 0 || day.actual_cash_in > 0) // Only show days with actual data
        .map(day => [
          day.date,
          day.night_counter || 'N/A',
          day.toast_sales > 0 ? `$${day.toast_sales.toFixed(2)}` : 'No Data',
          day.actual_cash_in > 0 ? `$${day.actual_cash_in.toFixed(2)}` : 'No Data', 
          Math.abs(day.discrepancy) > 0.01 ? `${day.discrepancy >= 0 ? '+' : ''}$${day.discrepancy.toFixed(2)}` : '$0.00',
          day.excess > 0 ? `$${day.excess.toFixed(2)}` : '$0.00'
        ]);
      
      doc.autoTable({
        head: [['DATE', 'NIGHT COUNTER', 'TOAST SALES', 'ACTUAL CASH IN', 'DISCREPANCY', 'EXCESS']],
        body: dailyTableData,
        startY: currentY,
        margin: { left: margin, right: margin },
        styles: { font: 'helvetica', fontSize: 7, textColor: [0, 0, 0] },
        headStyles: { font: 'helvetica', fontStyle: 'bold', fillColor: [245, 245, 245] },
        didParseCell: function(data) {
          // Color discrepancy column
          if (data.column.index === 4 && data.row.index < dailyTableData.length) {
            const cellValue = data.cell.text[0];
            if (cellValue && cellValue.includes('-')) {
              data.cell.styles.textColor = [139, 69, 19]; // Dark red
              data.cell.styles.fontStyle = 'italic';
            } else if (cellValue && cellValue.includes('+')) {
              data.cell.styles.textColor = [34, 139, 34]; // Dark green
            }
          }
        }
      });
    }
    
    // Save PDF
    const filename = `Historical_Weekly_Report_${startDate.replace(/-/g, '_')}_to_${endDate.replace(/-/g, '_')}.pdf`;
    doc.save(filename);
  }
  
  async function generateAndDownloadReport() {
    const reportType = document.querySelector('input[name="reportType"]:checked').value;
    
    try {
      showLoading('Generating PDF Report', 'Creating your report...');
      
      if (reportType === 'single') {
        await generateSingleDayPDF();
      } else {
        await generateDateRangePDF();
      }
      
      hideLoading();
      showPDFSuccessMessage();
      
    } catch (error) {
      hideLoading();
      console.error('Report generation error:', error);
      showMessage(`Error: ${error.message}`, 'error');
    }
  }
  
  function showPDFSuccessMessage() {
    const modalHTML = `
      <div id="pdfSuccessModal" style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.7);
        z-index: 10000;
        display: flex;
        justify-content: center;
        align-items: center;
      ">
        <div style="
          background: white;
          padding: 40px;
          border-radius: 0;
          text-align: center;
          max-width: 400px;
          width: 90%;
          box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        ">
          <div style="font-size: 48px; margin-bottom: 20px;"></div>
          <h2 style="color: #28a745; margin-bottom: 15px; font-size: 24px;">PDF Downloaded Successfully!</h2>
          <p style="color: #666; margin-bottom: 30px; font-size: 16px;">Your cash report has been generated and downloaded.</p>
          <button onclick="closePDFSuccessModal(); goHome();" style="
            background: var(--gray-700);
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 16px;
            border-radius: 0;
            cursor: pointer;
            margin-right: 10px;
          ">Return to Menu</button>
          <button onclick="closePDFSuccessModal();" style="
            background: var(--gray-600);
            color: white;
            border: none;
            padding: 12px 20px;
            font-size: 16px;
            border-radius: 0;
            cursor: pointer;
          ">Stay Here</button>
        </div>
      </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
  }
  
  function closePDFSuccessModal() {
    const modal = document.getElementById('pdfSuccessModal');
    if (modal) {
      modal.remove();
    }
  }

  function showTipPoolSuccessMessage() {
    const modalHTML = `
      <div id="tipPoolSuccessModal" style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.7);
        z-index: 10000;
        display: flex;
        justify-content: center;
        align-items: center;
      ">
        <div style="
          background: white;
          padding: 40px;
          border-radius: 0;
          text-align: center;
          max-width: 400px;
          width: 90%;
          box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        ">
          <div style="font-size: 48px; margin-bottom: 20px;"></div>
          <h2 style="color: #28a745; margin-bottom: 15px; font-size: 24px;">Tip Pool PDF Downloaded Successfully!</h2>
          <p style="color: #666; margin-bottom: 30px; font-size: 16px;">Your tip pool distribution report has been generated and downloaded.</p>
          <button onclick="closeTipPoolSuccessModal(); goHome();" style="
            background: var(--gray-700);
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 16px;
            border-radius: 0;
            cursor: pointer;
            margin-right: 10px;
          ">Return to Menu</button>
          <button onclick="closeTipPoolSuccessModal();" style="
            background: var(--gray-600);
            color: white;
            border: none;
            padding: 12px 20px;
            font-size: 16px;
            border-radius: 0;
            cursor: pointer;
          ">Stay Here</button>
        </div>
      </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
  }
  
  function closeTipPoolSuccessModal() {
    const modal = document.getElementById('tipPoolSuccessModal');
    if (modal) {
      modal.remove();
    }
  }
  
  async function generateSingleDayPDF() {
    const date = document.getElementById('reportDate').value;
    console.log('generateSingleDayPDF called with date:', date);
    
    if (!date) {
      throw new Error('Please select a date');
    }
    
    console.log('Getting AM data for date:', date);
    const amData = await getAMData(date);
    console.log('AM data retrieved:', amData);
    
    if (!amData) {
      throw new Error('No AM data found for this date');
    }
    
    console.log('Getting PM data for date:', date);
    const { data: fullData, error } = await supabase
      .from('cash_counts')
      .select('*')
      .eq('date', date)
      .single();
    
    console.log('PM data retrieved:', fullData, 'Error:', error);
    
    if (!fullData || !fullData.pm_total) {
      throw new Error('No PM data found for this date');
    }
    
    console.log('Generating report HTML...');
    
    // Calculate PM amounts using same logic as PM flow for consistency
    const calculations = calculatePMAmounts({
      amTotal: amData.total,
      total: fullData.pm_total,
      toastSales: fullData.pm_toast_sales,
      cashTips: fullData.pm_cash_tips
    });
    
    console.log('Calculations for report:', calculations);
    
    // Create enhanced pmData with calculation results
    const enhancedPmData = {
      ...fullData,
      // Add calculated fields for deposit rounding breakdown
      raw_deposit_amount: calculations.rawDepositAmount ? calculations.rawDepositAmount.toFixed(2) : null,
      deposit_rounding_adjustment: calculations.depositRoundingAdjustment ? calculations.depositRoundingAdjustment.toFixed(2) : null,
      deposit_tip_adjustment: calculations.depositTipAdjustment ? calculations.depositTipAdjustment.toFixed(2) : null,
      deposit_excess_to_cashbox: calculations.depositExcessToCashbox ? calculations.depositExcessToCashbox.toFixed(2) : null,
      // Only show deposit rounding breakdown if:
      // 1. There's actually a meaningful rounding adjustment (> 0.001)
      // 2. This data was processed with the new logic (stored amount matches rounded amount)
      has_deposit_rounding: (
        calculations.depositRoundingAdjustment && 
        Math.abs(calculations.depositRoundingAdjustment) > 0.001 &&
        Math.abs(fullData.pm_deposit_amount - calculations.depositAmount) < 0.001
      ) ? 'true' : 'false',
      deposit_amount: calculations.depositAmount.toString()
    };
    
    console.log('Enhanced PM Data:', enhancedPmData);
    
    // Generate full single day report (same format as email)
    const reportHtml = generateSingleDayReportHtml(date, amData, enhancedPmData);
    console.log('Report HTML generated, creating PDF...');
    
    // Set the content in the hidden div
    const reportContent = document.getElementById('reportContent');
    if (reportContent) {
      reportContent.innerHTML = reportHtml;
      
      // Generate PDF
      const filename = `jayna-gyro-daily-report-${date}.pdf`;
      await generatePDF(reportContent, filename);
      
    } else {
      throw new Error('Report content element not found');
    }
  }
  
  async function generateDateRangePDF() {
    // IMPORTANT: Tip pool reports MUST use Monday-Sunday date ranges (7 days)
    // startDate = Monday, endDate = Sunday (the week_end_date stored in database)
    // Example: Monday 9/29/2025 through Sunday 10/5/2025
    // All dates stored as YYYY-MM-DD format (e.g., "2025-10-05" for Sunday)

    const startDate = document.getElementById('reportStartDate').value;
    const endDate = document.getElementById('reportEndDate').value;
    const realEnvelopeAmount = parseFloat(document.getElementById('realEnvelopeAmount').value) || null;

    if (!startDate || !endDate) {
      throw new Error('Please select both start and end dates');
    }

    // Handle dates properly with timezone-safe parsing (append T12:00:00 to force local time)
    // This prevents UTC midnight interpretation which shifts dates by timezone offset
    const start = new Date(startDate + 'T12:00:00');
    const end = new Date(endDate + 'T12:00:00');
    
    if (start > end) {
      throw new Error('Start date must be before end date');
    }
    
    // Check if date range exceeds 7 days
    const daysDiff = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
    if (daysDiff > 7) {
      throw new Error('Date range cannot exceed 7 days');
    }
    
    console.log('Date range query:', { startDate, endDate, daysDiff });
    
    const { data: rangeData } = await supabase
      .from('cash_counts')
      .select('*')
      .gte('date', startDate)
      .lte('date', endDate)
      .not('pm_total', 'is', null)
      .order('date', { ascending: true });
    
    if (!rangeData || rangeData.length === 0) {
      throw new Error('No data found for this date range');
    }
    
    // Generate date range summary report
    const reportHtml = generateDateRangeReportHtml(startDate, endDate, rangeData, realEnvelopeAmount);
    
    // Set the content in the hidden div
    const reportContent = document.getElementById('reportContent');
    if (reportContent) {
      reportContent.innerHTML = reportHtml;
      
      // Generate PDF
      const filename = `jayna-gyro-range-report-${startDate}-to-${endDate}.pdf`;
      await generatePDF(reportContent, filename);
      
    } else {
      throw new Error('Report content element not found');
    }
  }
  
  async function generatePDF(element, filename) {
    console.log('Generating PDF with filename:', filename);
    
    // Extract only the body content, skipping the CSS
    const fullHTML = element.innerHTML;
    
    // Find the start of the actual content (after </style> tag)
    const contentStart = fullHTML.indexOf('</style>') + 8;
    const contentEnd = fullHTML.lastIndexOf('</html>');
    
    let bodyContent = '';
    if (contentStart > 7 && contentEnd > contentStart) {
      // Extract content between </style> and </html>
      bodyContent = fullHTML.substring(contentStart, contentEnd);
      // Remove any remaining head/body tags and just keep the content
      bodyContent = bodyContent.replace(/<\/head>|<body>|<\/body>/g, '').trim();
    } else {
      // Fallback: try to find content starting with "JAYNA GYRO"
      const jaynaStart = fullHTML.indexOf('JAYNA GYRO DAILY CASH REPORT');
      if (jaynaStart > 0) {
        bodyContent = fullHTML.substring(jaynaStart);
        bodyContent = bodyContent.replace(/<\/html>|<\/body>/g, '').trim();
      } else {
        bodyContent = element.innerHTML;
      }
    }
    
    // Create a temporary element with just the clean content and basic styling
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = `
      <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 8px; font-size: 9px; line-height: 1.1; }
        .header { text-align: center; font-weight: bold; font-size: 16px; margin-bottom: 2px; border-bottom: 2px solid #000; padding-bottom: 4px; }
        .date-header { text-align: center; font-weight: bold; font-size: 14px; margin-bottom: 8px; padding-bottom: 4px; text-transform: uppercase; letter-spacing: 0.3px; }
        .section { border: 1px solid #000; margin: 4px 0; padding: 6px; }
        .section-title { font-weight: bold; font-size: 12px; text-align: center; margin-bottom: 4px; border-bottom: 1px solid #000; padding-bottom: 2px; text-transform: uppercase; letter-spacing: 0.3px; }
        .two-column { display: table; width: 100%; }
        .column { display: table-cell; width: 50%; vertical-align: top; padding: 0 4px; }
        .column:first-child { border-right: 1px solid #ccc; }
        .data-row { display: flex; justify-content: space-between; margin: 1px 0; max-width: 150px; }
        .label { font-weight: bold; text-align: right; padding-right: 8px; }
        .value { text-align: left; font-weight: bold; }
        .deposit-box { background-color: #e6ffe6; border: 2px solid #000; padding: 6px; text-align: center; font-weight: bold; font-size: 11px; margin: 4px 0; }
        .keep-box { background-color: #fff0e6; border: 2px solid #000; padding: 6px; text-align: center; font-weight: bold; font-size: 11px; margin: 4px 0; }
        .notes-section { display: table; width: 100%; margin: 4px 0; }
        .notes-column { display: table-cell; width: 50%; padding: 4px; border: 1px solid #000; vertical-align: top; text-align: center; font-weight: bold; }
        .notes-column:first-child { border-right: none; }
        .breakdown-grid { display: table; width: 100%; }
        .breakdown-row { display: table-row; }
        .breakdown-cell { display: table-cell; padding: 2px 4px; border-bottom: 1px dotted #ccc; }
        .breakdown-label { font-weight: bold; width: 50%; text-align: right; padding-right: 8px; }
        .breakdown-value { text-align: left; font-weight: bold; width: 50%; padding-left: 8px; }
        .cash-count { font-size: 7px; line-height: 1.0; }
        .drawer-total { font-weight: bold; border-top: 1px solid #000; margin-top: 2px; padding-top: 2px; }
        .shift-total { font-weight: bold; text-align: center; padding: 3px; border: 2px solid #000; margin-top: 4px; font-size: 8px; }
        .am-bg { background-color: #e6f3ff; }
        .pm-bg { background-color: #fff8f0; }
      </style>
      ${bodyContent}
    `;
    
    // Hide the original element and show the temp one
    const originalParent = element.parentNode;
    const originalDisplay = element.style.display;
    
    // Insert temp div and hide original
    document.body.appendChild(tempDiv);
    element.style.display = 'none';
    
    // Configure PDF options for better output
    const opt = {
      margin: 0.5,
      filename: filename,
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { 
        scale: 2,
        useCORS: true,
        backgroundColor: '#ffffff',
        width: 800,
        height: tempDiv.scrollHeight,
        logging: false
      },
      jsPDF: { 
        unit: 'in', 
        format: 'letter', 
        orientation: 'portrait' 
      }
    };
    
    try {
      // Generate PDF from the clean temp element
      await html2pdf().set(opt).from(tempDiv).save();
      console.log('PDF generated and downloaded successfully');
    } catch (pdfError) {
      console.error('PDF generation error:', pdfError);
      throw pdfError;
    } finally {
      // Clean up: remove temp div and restore original
      try {
        if (tempDiv && tempDiv.parentNode) {
          document.body.removeChild(tempDiv);
        }
        if (element) {
          element.style.display = originalDisplay;
        }
      } catch (cleanupError) {
        console.error('Cleanup error:', cleanupError);
      }
    }
  }
  
  // Download Historical Report as PDF
  async function downloadHistoricalReportPDF(startDate, endDate) {
    try {
      console.log('Downloading historical report PDF...');
      
      if (!window.currentHistoricalReport) {
        throw new Error('No historical report data available');
      }
      
      const reportData = window.currentHistoricalReport;
      const reportContent = document.getElementById('reportContent');
      
      if (!reportContent) {
        throw new Error('Report content not found');
      }
      
      // Generate PDF from the displayed content
      const filename = `jayna-gyro-historical-report-${startDate}-to-${endDate}.pdf`;
      await generatePDF(reportContent, filename);
      
      console.log('Historical report PDF downloaded successfully');
      
    } catch (error) {
      console.error('Error downloading historical report PDF:', error);
      showErrorMessage('Failed to download PDF: ' + error.message, 'reportResults');
    }
  }
  
  function generateSingleDayReportHtml(date, amData, pmData) {
    console.log('generateSingleDayReportHtml called with:');
    console.log('date:', date);
    console.log('amData:', amData);
    console.log('pmData:', pmData);
    
    // Validate data exists
    if (!amData || !pmData) {
      console.error('Missing data - amData:', !!amData, 'pmData:', !!pmData);
      return '<div style="padding: 20px; color: red; font-size: 18px;">Error: Missing report data</div>';
    }
    
    const dayOfWeek = new Date(date + 'T12:00:00').toLocaleDateString('en-US', { weekday: 'long' }).toUpperCase();
    const formattedDate = new Date(date + 'T12:00:00').toLocaleDateString('en-US', { 
      year: 'numeric', 
      month: 'long', 
      day: 'numeric' 
    }).toUpperCase();
    
    const actualCashIn = pmData.pm_total - amData.total;
    const discrepancySign = pmData.pm_discrepancy >= 0 ? '+' : '';
    const tipAdjustment = pmData.pm_discrepancy < 0 ? Math.abs(pmData.pm_discrepancy) : 0;
    
    // Helper function to get denomination counts and totals
    function getDenomData(drawerData, denomKey) {
      if (!drawerData || !drawerData) return { count: 0, total: 0 };
      
      // Map display format to stored format
      const denomMapping = {
        '$100': 'hundreds',
        '$50': 'fifties', 
        '$20': 'twenties',
        '$10': 'tens',
        '$5': 'fives',
        '$1': 'ones',
        '¬¢25': 'quarters',
        '¬¢10': 'dimes', 
        '¬¢5': 'nickels',
        '¬¢1': 'pennies'
      };
      
      const dataKey = denomMapping[denomKey];
      if (!dataKey) return { count: 0, total: 0 };
      
      const count = parseInt(drawerData[dataKey]) || 0;
      const denomValues = {
        '$100': 100, '$50': 50, '$20': 20, '$10': 10, '$5': 5, '$1': 1,
        '¬¢25': 0.25, '¬¢10': 0.10, '¬¢5': 0.05, '¬¢1': 0.01
      };
      const value = denomValues[denomKey] || 0;
      return { count, total: (count * value).toFixed(2) };
    }
    
    const htmlContent = `
    <!DOCTYPE html>
    <html>
    <head>
        <style>
            body {
                font-family: Arial, sans-serif;
                margin: 0;
                padding: 8px;
                font-size: 9px;
                line-height: 1.1;
            }
            .header {
                text-align: center;
                font-weight: bold;
                font-size: 16px;
                margin-bottom: 2px;
                border-bottom: 2px solid #000;
                padding-bottom: 4px;
            }
            .date-header {
                text-align: center;
                font-weight: bold;
                font-size: 14px;
                margin-bottom: 8px;
                padding-bottom: 4px;
            }
            .section {
                border: 1px solid #000;
                margin: 4px 0;
                padding: 6px;
            }
            .section-title {
                font-weight: bold;
                font-size: 12px;
                text-align: center;
                margin-bottom: 4px;
                border-bottom: 1px solid #000;
                padding-bottom: 2px;
            }
            .two-column {
                display: table;
                width: 100%;
            }
            .column {
                display: table-cell;
                width: 50%;
                vertical-align: top;
                padding: 0 4px;
            }
            .column:first-child {
                border-right: 1px solid #ccc;
            }
            .data-row {
                display: flex;
                justify-content: space-between;
                margin: 1px 0;
                max-width: 150px;
            }
            .label {
                font-weight: bold;
                text-align: right;
                padding-right: 8px;
            }
            .value {
                text-align: left;
                font-weight: bold;
            }
            .deposit-box {
                background-color: #e6ffe6;
                border: 2px solid #000;
                padding: 6px;
                text-align: center;
                font-weight: bold;
                font-size: 11px;
                margin: 4px 0;
            }
            .keep-box {
                background-color: #fff0e6;
                border: 2px solid #000;
                padding: 6px;
                text-align: center;
                font-weight: bold;
                font-size: 11px;
                margin: 4px 0;
            }
            .notes-section {
                display: table;
                width: 100%;
                margin: 4px 0;
            }
            .notes-column {
                display: table-cell;
                width: 50%;
                padding: 4px;
                border: 1px solid #000;
                vertical-align: top;
                text-align: center;
                font-weight: bold;
            }
            .notes-column:first-child {
                border-right: none;
            }
            .breakdown-grid {
                display: table;
                width: 100%;
            }
            .breakdown-row {
                display: table-row;
            }
            .breakdown-cell {
                display: table-cell;
                padding: 2px 4px;
                border-bottom: 1px dotted #ccc;
            }
            .breakdown-label {
                font-weight: bold;
                width: 50%;
                text-align: right;
                padding-right: 8px;
            }
            .breakdown-value {
                text-align: left;
                font-weight: bold;
                width: 50%;
                padding-left: 8px;
            }
            .cash-count {
                font-size: 7px;
                line-height: 1.0;
            }
            .drawer-total {
                font-weight: bold;
                border-top: 1px solid #000;
                margin-top: 2px;
                padding-top: 2px;
            }
            .shift-total {
                font-weight: bold;
                text-align: center;
                padding: 3px;
                border: 2px solid #000;
                margin-top: 4px;
                font-size: 8px;
            }
            .am-bg { background-color: #e6f3ff; }
            .pm-bg { background-color: #fff8f0; }
        </style>
    </head>
    <body>
        <div class="header">
            JAYNA GYRO DAILY CASH REPORT
        </div>
        <div class="date-header">
            ${dayOfWeek} ${formattedDate}
        </div>
        <div style="text-align: center; font-size: 8px; color: #666; margin-bottom: 8px; border-bottom: 1px dotted #ccc; padding-bottom: 4px;">
            Report Generated: ${new Date().toLocaleString()}
        </div>

        <!-- Staff and Timing Info -->
        <div class="section">
            <div class="two-column">
                <div class="column">
                    <div class="data-row">
                        <span class="label">AM Counter:</span>
                        <span class="value">${amData.counter}</span>
                    </div>
                    <div class="data-row">
                        <span class="label">AM Time:</span>
                        <span class="value">${new Date(amData.timestamp).toLocaleTimeString()}</span>
                    </div>
                </div>
                <div class="column">
                    <div class="data-row">
                        <span class="label">PM Counter:</span>
                        <span class="value">${pmData.pm_counter}</span>
                    </div>
                    <div class="data-row">
                        <span class="label">PM Time:</span>
                        <span class="value">${new Date(pmData.pm_timestamp).toLocaleTimeString()}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Cash Summary -->
        <div class="section">
            <div class="section-title">CASH FLOW SUMMARY</div>
            <div class="two-column">
                <div class="column">
                    <div class="data-row">
                        <span class="label">Starting Cash (AM):</span>
                        <span class="value">$${amData.total.toFixed(2)}</span>
                    </div>
                    <div class="data-row">
                        <span class="label">Ending Cash (PM):</span>
                        <span class="value">$${pmData.pm_total.toFixed(2)}</span>
                    </div>
                    <div class="data-row">
                        <span class="label">Actual Cash In:</span>
                        <span class="value">$${actualCashIn.toFixed(2)}</span>
                    </div>
                </div>
                <div class="column">
                    <div class="data-row">
                        <span class="label">Toast Sales:</span>
                        <span class="value">$${pmData.pm_toast_sales.toFixed(2)}</span>
                    </div>
                    <div class="data-row">
                        <span class="label">Original Tips:</span>
                        <span class="value">$${pmData.pm_cash_tips.toFixed(2)}</span>
                    </div>
                    <div class="data-row">
                        <span class="label">Discrepancy:</span>
                        <span class="value">${discrepancySign}$${Math.abs(pmData.pm_discrepancy).toFixed(2)}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Deposit Instructions -->
        <div class="deposit-box">
            DEPOSIT IN ENVELOPE: $${pmData.pm_deposit_amount}
            <div style="font-size: 8px;">(Toast Sales $${pmData.pm_toast_sales.toFixed(2)} + Original Tips $${pmData.pm_cash_tips.toFixed(2)})</div>
        </div>
        <div class="keep-box">
            RETURN TO CASHBOX/SAFE: $${pmData.pm_amount_to_keep.toFixed(2)}
        </div>

        <!-- Notes Section -->
        <div class="notes-section">
            <div class="notes-column am-bg">
                <div style="font-weight: bold; text-align: center; margin-bottom: 3px;">AM NOTES</div>
                <div style="text-align: center; font-weight: bold;">
                    ${amData.notes || 'No AM Notes'}
                </div>
            </div>
            <div class="notes-column pm-bg">
                <div style="font-weight: bold; text-align: center; margin-bottom: 3px;">PM NOTES</div>
                <div style="text-align: center; font-weight: bold;">
                    ${pmData.pm_notes || 'No PM Notes'}
                </div>
            </div>
        </div>

        <!-- Manager Breakdown -->
        <div class="section">
            <div class="section-title">MANAGER BREAKDOWN</div>
            <div class="breakdown-grid">
                <div class="breakdown-row">
                    <div class="breakdown-cell breakdown-label">Starting Cash Total:</div>
                    <div class="breakdown-cell breakdown-value">$${amData.total.toFixed(2)}</div>
                </div>
                <div class="breakdown-row">
                    <div class="breakdown-cell breakdown-label">Ending Cash Total:</div>
                    <div class="breakdown-cell breakdown-value">$${pmData.pm_total.toFixed(2)}</div>
                </div>
                <div class="breakdown-row">
                    <div class="breakdown-cell breakdown-label">Actual Cash In:</div>
                    <div class="breakdown-cell breakdown-value">$${actualCashIn.toFixed(2)}</div>
                </div>
                <div class="breakdown-row">
                    <div class="breakdown-cell breakdown-label">Toast Sales Reported:</div>
                    <div class="breakdown-cell breakdown-value">$${pmData.pm_toast_sales.toFixed(2)}</div>
                </div>
                <div class="breakdown-row">
                    <div class="breakdown-cell breakdown-label">Tips Reported by Staff:</div>
                    <div class="breakdown-cell breakdown-value">$${pmData.pm_cash_tips.toFixed(2)}</div>
                </div>
                <div class="breakdown-row">
                    <div class="breakdown-cell breakdown-label">Discrepancy (Drawers vs Toast):</div>
                    <div class="breakdown-cell breakdown-value">${discrepancySign}$${Math.abs(pmData.pm_discrepancy).toFixed(2)}</div>
                </div>
                ${tipAdjustment > 0 ? `
                <div class="breakdown-row">
                    <div class="breakdown-cell breakdown-label">Cash Tip Adjustment:</div>
                    <div class="breakdown-cell breakdown-value">-$${tipAdjustment.toFixed(2)}</div>
                </div>` : ''}
                ${pmData.has_deposit_rounding === 'true' ? `
                <div class="breakdown-row" style="background-color: #fff3cd;">
                    <div class="breakdown-cell breakdown-label">Raw Deposit Amount:</div>
                    <div class="breakdown-cell breakdown-value">$${pmData.raw_deposit_amount}</div>
                </div>
                <div class="breakdown-row" style="background-color: #fff3cd;">
                    <div class="breakdown-cell breakdown-label">Rounded Deposit Amount:</div>
                    <div class="breakdown-cell breakdown-value">$${pmData.deposit_amount}</div>
                </div>
                <div class="breakdown-row" style="background-color: #fff3cd;">
                    <div class="breakdown-cell breakdown-label">Rounding Adjustment Needed:</div>
                    <div class="breakdown-cell breakdown-value">$${pmData.deposit_rounding_adjustment}</div>
                </div>
                <div class="breakdown-row" style="background-color: #fff3cd;">
                    <div class="breakdown-cell breakdown-label">Taken from Tips (Whole $):</div>
                    <div class="breakdown-cell breakdown-value">-$${pmData.deposit_tip_adjustment}</div>
                </div>
                <div class="breakdown-row" style="background-color: #fff3cd;">
                    <div class="breakdown-cell breakdown-label">Excess to Cashbox:</div>
                    <div class="breakdown-cell breakdown-value">+$${pmData.deposit_excess_to_cashbox}</div>
                </div>` : ''}
                <div class="breakdown-row">
                    <div class="breakdown-cell breakdown-label">Owed to Restaurant:</div>
                    <div class="breakdown-cell breakdown-value">$${pmData.pm_toast_sales.toFixed(2)}</div>
                </div>
                <div class="breakdown-row">
                    <div class="breakdown-cell breakdown-label">Cash Tips Owed to Staff:</div>
                    <div class="breakdown-cell breakdown-value">$${pmData.pm_adjusted_tips.toFixed(2)}</div>
                </div>
                <div class="breakdown-row">
                    <div class="breakdown-cell breakdown-label">Returned to Cashbox:</div>
                    <div class="breakdown-cell breakdown-value">$${(pmData.pm_amount_to_keep - amData.total).toFixed(2)} + AM Total</div>
                </div>
            </div>
        </div>

        <!-- Complete Cash Count Breakdown -->
        <div class="section">
            <div class="section-title">COMPLETE CASH COUNT BREAKDOWN</div>
            <div class="two-column">
                <!-- AM Counts -->
                <div class="column">
                    <div style="text-align: center; font-weight: bold; font-size: 8px; margin-bottom: 3px; background-color: #e6f3ff; padding: 2px;">AM COUNTS</div>
                    
                    <div class="cash-count">
                        <div style="font-weight: bold; text-decoration: underline; margin-bottom: 2px;">DRAWER 1</div>
                        ${['$100', '$50', '$20', '$10', '$5', '$1', '¬¢25', '¬¢10', '¬¢5', '¬¢1'].map(denom => {
                          const data = getDenomData(amData.drawer1.counts, denom);
                          return `<div>${denom}: ${data.count} = $${data.total}</div>`;
                        }).join('')}
                        <div class="drawer-total">TOTAL: $${amData.drawer1.total.toFixed(2)}</div>
                    </div>
                    
                    <div class="cash-count" style="margin-top: 4px;">
                        <div style="font-weight: bold; text-decoration: underline; margin-bottom: 2px;">DRAWER 2</div>
                        ${['$100', '$50', '$20', '$10', '$5', '$1', '¬¢25', '¬¢10', '¬¢5', '¬¢1'].map(denom => {
                          const data = getDenomData(amData.drawer2.counts, denom);
                          return `<div>${denom}: ${data.count} = $${data.total}</div>`;
                        }).join('')}
                        <div class="drawer-total">TOTAL: $${amData.drawer2.total.toFixed(2)}</div>
                    </div>
                    
                    <div class="shift-total am-bg">TOTAL AM: $${amData.total.toFixed(2)}</div>
                </div>
                
                <!-- PM Counts -->
                <div class="column">
                    <div style="text-align: center; font-weight: bold; font-size: 8px; margin-bottom: 3px; background-color: #fff8f0; padding: 2px;">PM COUNTS</div>
                    
                    <div class="cash-count">
                        <div style="font-weight: bold; text-decoration: underline; margin-bottom: 2px;">DRAWER 1</div>
                        ${['$100', '$50', '$20', '$10', '$5', '$1', '¬¢25', '¬¢10', '¬¢5', '¬¢1'].map(denom => {
                          const data = getDenomData(pmData.pm_drawer1_data, denom);
                          return `<div>${denom}: ${data.count} = $${data.total}</div>`;
                        }).join('')}
                        <div class="drawer-total">TOTAL: $${pmData.pm_drawer1_total.toFixed(2)}</div>
                    </div>
                    
                    <div class="cash-count" style="margin-top: 4px;">
                        <div style="font-weight: bold; text-decoration: underline; margin-bottom: 2px;">DRAWER 2</div>
                        ${['$100', '$50', '$20', '$10', '$5', '$1', '¬¢25', '¬¢10', '¬¢5', '¬¢1'].map(denom => {
                          const data = getDenomData(pmData.pm_drawer2_data, denom);
                          return `<div>${denom}: ${data.count} = $${data.total}</div>`;
                        }).join('')}
                        <div class="drawer-total">TOTAL: $${pmData.pm_drawer2_total.toFixed(2)}</div>
                    </div>
                    
                    <div class="shift-total pm-bg">TOTAL PM: $${pmData.pm_total.toFixed(2)}</div>
                </div>
            </div>
            
            <!-- Overall Drawer Totals Summary -->
            <div style="margin-top: 8px; padding-top: 8px; border-top: 2px solid #000;">
                <div style="text-align: center; font-weight: bold; font-size: 10px; margin-bottom: 6px;">DRAWER TOTALS SUMMARY</div>
                <div class="two-column">
                    <div class="column">
                        <div style="font-size: 8px; font-weight: bold; text-align: center; margin-bottom: 3px;">DRAWER 1 TOTALS</div>
                        <div style="font-size: 8px;">
                            <div style="display: flex; justify-content: space-between; margin: 1px 0;">
                                <span>AM:</span>
                                <span>$${amData.drawer1.total.toFixed(2)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin: 1px 0;">
                                <span>PM:</span>
                                <span>$${pmData.pm_drawer1_total.toFixed(2)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin: 1px 0; border-top: 1px solid #000; padding-top: 1px; font-weight: bold;">
                                <span>Change:</span>
                                <span>$${(pmData.pm_drawer1_total - amData.drawer1.total).toFixed(2)}</span>
                            </div>
                        </div>
                    </div>
                    <div class="column">
                        <div style="font-size: 8px; font-weight: bold; text-align: center; margin-bottom: 3px;">DRAWER 2 TOTALS</div>
                        <div style="font-size: 8px;">
                            <div style="display: flex; justify-content: space-between; margin: 1px 0;">
                                <span>AM:</span>
                                <span>$${amData.drawer2.total.toFixed(2)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin: 1px 0;">
                                <span>PM:</span>
                                <span>$${pmData.pm_drawer2_total.toFixed(2)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin: 1px 0; border-top: 1px solid #000; padding-top: 1px; font-weight: bold;">
                                <span>Change:</span>
                                <span>$${(pmData.pm_drawer2_total - amData.drawer2.total).toFixed(2)}</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div style="text-align: center; font-weight: bold; font-size: 9px; margin-top: 6px; padding: 4px; border: 2px solid #000; background-color: #f0f0f0;">
                    COMBINED DRAWER CHANGE: $${(actualCashIn).toFixed(2)}
                </div>
            </div>
        </div>
    </body>
    </html>
    `;
    
    console.log('Generated HTML length:', htmlContent.length);
    return htmlContent;
  }
  
  function generateDateRangeReportHtml(startDate, endDate, data, realEnvelopeAmount = null) {
    // Calculate totals according to requirements
    let totalToastSalesReported = 0;
    let totalActualCashIn = 0;
    let totalDiscrepancy = 0;
    let totalOriginalCashTips = 0;
    let totalAdjustedCashTips = 0;
    let totalEnvelopeDeposits = 0;
    let totalBackToCashbox = 0;
    
    data.forEach(day => {
      totalToastSalesReported += day.pm_toast_sales || 0;
      totalActualCashIn += (day.pm_total - day.am_total) || 0;
      totalDiscrepancy += day.pm_discrepancy || 0;
      totalOriginalCashTips += day.pm_cash_tips || 0;
      totalAdjustedCashTips += day.pm_adjusted_tips || 0;
      totalEnvelopeDeposits += day.pm_deposit_amount || 0;
      // Fix: Calculate actual excess returned to cashbox (not total amount)
      totalBackToCashbox += (day.pm_amount_to_keep - day.am_total) || 0;
    });
    
    return `
      <div style="font-family: Arial, sans-serif; max-width: 900px; margin: 0 auto; font-size: 14px; line-height: 1.3;">
        <!-- Title with Confidential -->
        <div style="text-align: center; margin-bottom: 25px; padding: 15px; background: #f0f0f0; border-radius: 0; border: 2px solid #000;">
          <h2 style="margin: 0; color: #333; font-size: 18px; font-weight: bold;">**CONFIDENTIAL**</h2>
          <h2 style="margin: 5px 0; color: #333; font-size: 16px;">JAYNA GYRO MULTI-DAY CASH REPORT</h2>
          <p style="margin: 5px 0; font-size: 14px; color: #666; font-weight: bold;">
            ${new Date(startDate + 'T12:00:00').toLocaleDateString()} - ${new Date(endDate + 'T12:00:00').toLocaleDateString()}
          </p>
          <p style="margin: 5px 0; font-size: 12px; color: #888;">${data.length} days included</p>
        </div>
        
        <!-- Key Totals Grid -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px;">
          
          <div style="background: #e6f3ff; padding: 15px; border: 2px solid #000; border-radius: 0; text-align: center;">
            <h4 style="margin: 0 0 8px 0; color: #1e3c72; font-size: 12px;">TOTAL TOAST CASH SALES REPORTED</h4>
            <p style="font-size: 20px; font-weight: bold; margin: 0; color: #1e3c72;">$${totalToastSalesReported.toFixed(2)}</p>
          </div>
          
          <div style="background: #f0f8ff; padding: 15px; border: 2px solid #000; border-radius: 0; text-align: center;">
            <h4 style="margin: 0 0 8px 0; color: #28a745; font-size: 12px;">TOTAL ACTUAL CASH IN</h4>
            <p style="font-size: 20px; font-weight: bold; margin: 0; color: #28a745;">$${totalActualCashIn.toFixed(2)}</p>
            <p style="font-size: 10px; margin: 5px 0 0 0; color: #666;">(Based on PM-AM counts for each day)</p>
          </div>
          
          <div style="background: #ffe6e6; padding: 15px; border: 2px solid #000; border-radius: 0; text-align: center;">
            <h4 style="margin: 0 0 8px 0; color: #dc3545; font-size: 12px;">TOTAL DISCREPANCY</h4>
            <p style="font-size: 20px; font-weight: bold; margin: 0; color: #dc3545;">
              ${totalDiscrepancy >= 0 ? '+' : ''}$${totalDiscrepancy.toFixed(2)}
            </p>
            <p style="font-size: 10px; margin: 5px 0 0 0; color: #666;">(Between Toast and Count)</p>
          </div>
          
          <div style="background: #fff3e0; padding: 15px; border: 2px solid #000; border-radius: 0; text-align: center;">
            <h4 style="margin: 0 0 8px 0; color: #ff9800; font-size: 12px;">TOTAL CASH TIPS ORIGINALLY REPORTED</h4>
            <p style="font-size: 20px; font-weight: bold; margin: 0; color: #ff9800;">$${totalOriginalCashTips.toFixed(2)}</p>
          </div>
          
          <div style="background: #f3e5f5; padding: 15px; border: 2px solid #000; border-radius: 0; text-align: center;">
            <h4 style="margin: 0 0 8px 0; color: #9c27b0; font-size: 12px;">TOTAL ADJUSTED CASH TIPS</h4>
            <p style="font-size: 20px; font-weight: bold; margin: 0; color: #9c27b0;">$${totalAdjustedCashTips.toFixed(2)}</p>
            <p style="font-size: 10px; margin: 5px 0 0 0; color: #666;">(Adjusted to make up for discrepancies)</p>
          </div>
          
          <div style="background: #e8f5e8; padding: 15px; border: 2px solid #000; border-radius: 0; text-align: center;">
            <h4 style="margin: 0 0 8px 0; color: #2e7d32; font-size: 12px;">TOTAL ENVELOPE DEPOSITS</h4>
            <p style="font-size: 20px; font-weight: bold; margin: 0; color: #2e7d32;">$${totalEnvelopeDeposits}</p>
          </div>
          
          <div style="background: #fff8e1; padding: 15px; border: 2px solid #000; border-radius: 0; text-align: center;">
            <h4 style="margin: 0 0 8px 0; color: #f57c00; font-size: 12px;">TOTAL "BACK TO CASHBOX"</h4>
            <p style="font-size: 20px; font-weight: bold; margin: 0; color: #f57c00;">$${totalBackToCashbox.toFixed(2)}</p>
          </div>
          
          ${realEnvelopeAmount !== null ? `
          <div style="background: #f3e5f5; padding: 15px; border: 2px solid #000; border-radius: 0; text-align: center;">
            <h4 style="margin: 0 0 8px 0; color: #7b1fa2; font-size: 12px;">REAL ENVELOPE AMOUNT</h4>
            <p style="font-size: 20px; font-weight: bold; margin: 0; color: #7b1fa2;">$${realEnvelopeAmount.toFixed(2)}</p>
          </div>
          
          <div style="background: #e8f5e8; padding: 15px; border: 2px solid #000; border-radius: 0; text-align: center;">
            <h4 style="margin: 0 0 8px 0; color: #2e7d32; font-size: 12px;">ENVELOPE DIFFERENCE</h4>
            <p style="font-size: 20px; font-weight: bold; margin: 0; color: ${(realEnvelopeAmount - totalEnvelopeDeposits) >= 0 ? '#2e7d32' : '#d32f2f'};">
              $${(realEnvelopeAmount - totalEnvelopeDeposits).toFixed(2)}
            </p>
          </div>
          ` : ''}
          
        </div>
        
        <!-- Daily Breakdown Table -->
        <div style="border: 2px solid #000; margin: 20px 0; border-radius: 0; overflow: hidden;">
          <div style="background: #f0f0f0; padding: 10px; border-bottom: 2px solid #000;">
            <h4 style="margin: 0; text-align: center; font-size: 14px;">DAILY BREAKDOWN</h4>
          </div>
          
          <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
              <thead>
                <tr style="background: #f8f9fa;">
                  <th style="border: 1px solid #000; padding: 8px; text-align: left;">Date</th>
                  <th style="border: 1px solid #000; padding: 8px; text-align: center;">Counter</th>
                  <th style="border: 1px solid #000; padding: 8px; text-align: right;">Toast Sales</th>
                  <th style="border: 1px solid #000; padding: 8px; text-align: right;">Actual Cash In</th>
                  <th style="border: 1px solid #000; padding: 8px; text-align: right;">Discrepancy</th>
                  <th style="border: 1px solid #000; padding: 8px; text-align: right;">Envelope</th>
                  <th style="border: 1px solid #000; padding: 8px; text-align: right;">Cashbox</th>
                </tr>
              </thead>
              <tbody>
                ${data.map(day => {
                  const actualCashIn = day.pm_total - day.am_total;
                  const discrepancySign = day.pm_discrepancy >= 0 ? '+' : '';
                  return `
                    <tr>
                      <td style="border: 1px solid #000; padding: 6px; font-weight: bold;">
                        ${new Date(day.date + 'T12:00:00').toLocaleDateString()}
                      </td>
                      <td style="border: 1px solid #000; padding: 6px; text-align: center;">
                        ${day.pm_counter || 'N/A'}
                      </td>
                      <td style="border: 1px solid #000; padding: 6px; text-align: right;">
                        $${(day.pm_toast_sales || 0).toFixed(2)}
                      </td>
                      <td style="border: 1px solid #000; padding: 6px; text-align: right;">
                        $${actualCashIn.toFixed(2)}
                      </td>
                      <td style="border: 1px solid #000; padding: 6px; text-align: right; color: ${day.pm_discrepancy >= 0 ? '#28a745' : '#dc3545'};">
                        ${discrepancySign}$${Math.abs(day.pm_discrepancy || 0).toFixed(2)}
                      </td>
                      <td style="border: 1px solid #000; padding: 6px; text-align: right;">
                        $${day.pm_deposit_amount || 0}
                      </td>
                      <td style="border: 1px solid #000; padding: 6px; text-align: right;">
                        $${(day.pm_amount_to_keep || 0).toFixed(2)}
                      </td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          </div>
        </div>

        <!-- Notes and Labor Summary Section (2 columns) -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 0;">

          <!-- Left Column: Daily Notes -->
          <div style="border: 2px solid #000; border-radius: 0; overflow: hidden;">
            <div style="background: #f0f0f0; padding: 10px; border-bottom: 2px solid #000;">
              <h4 style="margin: 0; text-align: center; font-size: 14px;">DAILY NOTES</h4>
            </div>
            <div style="padding: 12px; max-height: 300px; overflow-y: auto;">
              ${data.map(day => {
                const hasNotes = (day.am_notes && day.am_notes.trim()) || (day.pm_notes && day.pm_notes.trim());
                if (!hasNotes) return '';
                return `
                  <div style="margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-left: 4px solid #667eea; border-radius: 0;">
                    <div style="font-weight: bold; color: #1e3c72; margin-bottom: 5px;">
                      ${new Date(day.date + 'T12:00:00').toLocaleDateString()}
                    </div>
                    ${day.am_notes && day.am_notes.trim() ? `
                      <div style="margin: 5px 0; font-size: 12px;">
                        <span style="font-weight: bold; color: #666;">AM:</span> ${day.am_notes}
                      </div>
                    ` : ''}
                    ${day.pm_notes && day.pm_notes.trim() ? `
                      <div style="margin: 5px 0; font-size: 12px;">
                        <span style="font-weight: bold; color: #666;">PM:</span> ${day.pm_notes}
                      </div>
                    ` : ''}
                  </div>
                `;
              }).join('') || '<p style="text-align: center; color: #999; padding: 20px;">No notes for this period</p>'}
            </div>
          </div>

          <!-- Right Column: Labor Summary -->
          <div style="border: 2px solid #000; border-radius: 0; overflow: hidden;">
            <div style="background: #f0f0f0; padding: 10px; border-bottom: 2px solid #000;">
              <h4 style="margin: 0; text-align: center; font-size: 14px;">WEEKLY LABOR SUMMARY</h4>
            </div>
            <div style="padding: 12px;">
              ${typeof tipPoolSummary !== 'undefined' && tipPoolSummary.laborData ? `
                <!-- Labor Breakdown -->
                <div style="margin-bottom: 12px;">
                  <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #ddd; font-size: 12px;">
                    <span>Base Labor Cost:</span>
                    <span style="font-weight: bold;">$${tipPoolSummary.laborData.baseLaborCost.toFixed(2)}</span>
                  </div>
                  <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #ddd; font-size: 12px;">
                    <span>Manager Salary (prorated):</span>
                    <span style="font-weight: bold;">$${tipPoolSummary.laborData.demetriSalary.toFixed(2)}</span>
                  </div>
                  <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #ddd; font-size: 12px;">
                    <span>Subtotal:</span>
                    <span style="font-weight: bold;">$${tipPoolSummary.laborData.subtotalLabor.toFixed(2)}</span>
                  </div>
                  <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 2px solid #000; font-size: 12px;">
                    <span>Payroll Burden (33%):</span>
                    <span style="font-weight: bold;">$${tipPoolSummary.laborData.payrollBurden.toFixed(2)}</span>
                  </div>
                  <div style="display: flex; justify-content: space-between; padding: 8px 0; font-size: 13px;">
                    <span style="font-weight: bold;">True Total Labor Cost:</span>
                    <span style="font-weight: bold; color: #1e3c72;">$${tipPoolSummary.laborData.trueTotalLaborCost.toFixed(2)}</span>
                  </div>
                </div>

                <!-- Labor Percentage Analysis -->
                <div style="background: ${tipPoolSummary.laborData.laborVariance > 0 ? '#ffe6e6' : '#e8f5e8'}; padding: 12px; border-radius: 0; border: 2px solid ${tipPoolSummary.laborData.laborVariance > 0 ? '#dc3545' : '#28a745'}; margin-top: 12px;">
                  <div style="text-align: center; margin-bottom: 8px;">
                    <div style="font-size: 11px; color: #666; margin-bottom: 4px;">NET SALES ${tipPoolSummary.laborData.usingEzcaterSales ? '(includes EZCater)' : ''}</div>
                    <div style="font-size: 16px; font-weight: bold;">$${tipPoolSummary.laborData.netSales.toFixed(2)}</div>
                    ${tipPoolSummary.laborData.usingEzcaterSales ? `
                    <div style="font-size: 9px; color: #666; margin-top: 4px;">
                      Base: $${tipPoolSummary.laborData.baseNetSales.toFixed(2)} + EZCater: $${tipPoolSummary.laborData.ezcaterSales.toFixed(2)}
                    </div>
                    ` : ''}
                  </div>
                  <div style="text-align: center; margin-bottom: 8px;">
                    <div style="font-size: 11px; color: #666; margin-bottom: 4px;">LABOR PERCENTAGE</div>
                    <div style="font-size: 24px; font-weight: bold; color: ${tipPoolSummary.laborData.laborVariance > 0 ? '#dc3545' : '#28a745'};">
                      ${tipPoolSummary.laborData.laborPercentage.toFixed(2)}%
                    </div>
                  </div>
                  <div style="display: flex; justify-content: space-between; padding: 6px 0; border-top: 1px solid #ddd; font-size: 11px;">
                    <span>Industry Benchmark:</span>
                    <span style="font-weight: bold;">${tipPoolSummary.laborData.industryBenchmark.toFixed(1)}%</span>
                  </div>
                  <div style="display: flex; justify-content: space-between; padding: 6px 0; font-size: 11px;">
                    <span>Variance:</span>
                    <span style="font-weight: bold; color: ${tipPoolSummary.laborData.laborVariance > 0 ? '#dc3545' : '#28a745'};">
                      ${tipPoolSummary.laborData.laborVariance > 0 ? '+' : ''}${tipPoolSummary.laborData.laborVariance.toFixed(2)}%
                      ${tipPoolSummary.laborData.laborVariance > 0 ? 'OVER' : 'UNDER'}
                    </span>
                  </div>
                </div>

                <div style="margin-top: 10px; padding: 8px; background: #f8f9fa; border-radius: 0; font-size: 10px; text-align: center; color: #666;">
                  <strong>Note:</strong> Includes $85k annual manager salary ($1,634.62/week) + 33% payroll burden
                </div>
              ` : `
                <p style="text-align: center; color: #999; padding: 20px; font-size: 12px;">
                  Labor data not available.<br>
                  Calculate tip pool first to see labor summary.
                </p>
              `}
            </div>
          </div>

        </div>
      </div>
    `;
  }
  
  function resetForm(shift) {
    document.getElementById(`${shift}Counter`).value = '';
    document.getElementById(`${shift}Notes`).value = '';
    
    // Reset drawer skips
    document.getElementById(`${shift}Drawer1Skip`).checked = false;
    document.getElementById(`${shift}Drawer2Skip`).checked = false;
    toggleSkip(shift, 1);
    toggleSkip(shift, 2);
    
    // Reset all denomination inputs
    DENOMINATIONS.forEach((denom, index) => {
      document.getElementById(`${shift}D1Q${index}`).value = '0';
      document.getElementById(`${shift}D2Q${index}`).value = '0';
    });
    
    if (shift === 'pm') {
      document.getElementById('toastSales').value = '';
      document.getElementById('cashTips').value = '';
    }
    
    updateCalculations(shift, 1);
    updateCalculations(shift, 2);
  }

</script>

<!-- App Header Navigation -->
<script src="./app-header.js"></script>
<script>
  // Auto-start cash flow when page loads
  document.addEventListener('DOMContentLoaded', () => {
    // Wait a moment for header to render first
    setTimeout(() => {
      startSmartCashFlow();
    }, 100);
  });
</script>

</body>
</html>
