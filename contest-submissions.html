<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Form Submissions - Teacher's Feast Contest Admin</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #46B0E4 0%, #176F9A 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            text-align: center;
        }

        h1 {
            font-size: 28px;
            color: #176F9A;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-bottom: 10px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
        }

        .stat-number {
            font-size: 36px;
            font-weight: 700;
            color: #176F9A;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
        }

        .section h2 {
            color: #176F9A;
            font-size: 20px;
            margin-bottom: 20px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 3px solid #e0f2fe;
        }

        .tab {
            padding: 12px 24px;
            background: var(--gray-100);
            color: var(--gray-700);
            border: none;
            cursor: pointer;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            border-radius: 0;
            transition: all 0.15s ease;
        }

        .tab.active {
            background: #176F9A;
            color: white;
        }

        .filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
            padding: 20px;
            background: #f0f9ff;
            border-radius: 10px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filter-group label {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #176F9A;
        }

        .filter-group input,
        .filter-group select {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }

        .btn {
            background: linear-gradient(135deg, #46B0E4 0%, #176F9A 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 14px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(70, 176, 228, 0.4);
        }

        .btn-secondary {
            background: white;
            color: #176F9A;
            border: 2px solid #46B0E4;
        }

        .btn-success {
            background: #059669;
            color: white;
        }

        .btn-delete {
            background: #dc2626;
            color: white;
            border: none;
            padding: 6px 12px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-delete:hover {
            background: #991b1b;
            transform: translateY(-1px);
        }

        .actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0f2fe;
            font-size: 13px;
        }

        th {
            background: #f0f9ff;
            color: #176F9A;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 11px;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
        }

        tr:hover {
            background: #f9fafb;
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-form {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-instagram {
            background: #dbeafe;
            color: #1e40af;
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid #e0f2fe;
            border-top: 4px solid #46B0E4;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #9ca3af;
        }

        .empty-state h3 {
            font-size: 18px;
            margin-bottom: 10px;
        }

        .table-container {
            overflow-x: auto;
            max-height: 600px;
            overflow-y: auto;
        }

        .quick-links {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .quick-links a {
            text-decoration: none;
        }

        .export-notice {
            background: #fef3c7;
            border: 2px solid #f59e0b;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 13px;
            color: #92400e;
        }

        @media (max-width: 768px) {
            .filters {
                grid-template-columns: 1fr;
            }

            .stats {
                grid-template-columns: 1fr 1fr;
            }

            table {
                font-size: 12px;
            }

            th, td {
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìã Form Submissions & Newsletter</h1>
            <p style="color: #666; margin-top: 10px;">View all contest votes and newsletter signups</p>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="totalVotes">--</div>
                <div class="stat-label">Total Votes</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="formVotes">--</div>
                <div class="stat-label">Form Votes (2pts)</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="instagramVotes">--</div>
                <div class="stat-label">Instagram Votes (1pt)</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="newsletterSignups">--</div>
                <div class="stat-label">Newsletter Signups</div>
            </div>
        </div>

        <div class="section">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('votes')">All Votes</button>
                <button class="tab" onclick="switchTab('newsletter')">Newsletter Subscribers</button>
            </div>

            <!-- VOTES TAB -->
            <div id="votesTab">
                <h2>üó≥Ô∏è All Contest Votes</h2>

                <div class="filters">
                    <div class="filter-group">
                        <label>Vote Type</label>
                        <select id="filterVoteType" onchange="filterVotes()">
                            <option value="">All Types</option>
                            <option value="form">Form Votes (2pts)</option>
                            <option value="instagram">Instagram Tags (1pt)</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>School</label>
                        <select id="filterSchool" onchange="filterVotes()">
                            <option value="">All Schools</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Date From</label>
                        <input type="date" id="filterDateFrom" onchange="filterVotes()">
                    </div>
                    <div class="filter-group">
                        <label>Date To</label>
                        <input type="date" id="filterDateTo" onchange="filterVotes()">
                    </div>
                    <div class="filter-group">
                        <label>Search Name/Email</label>
                        <input type="text" id="filterSearch" placeholder="Search..." onkeyup="filterVotes()">
                    </div>
                </div>

                <div class="actions">
                    <button class="btn btn-success" onclick="exportVotesToCSV()">üì• Export Votes to CSV</button>
                    <button class="btn btn-secondary" onclick="loadVotes()">üîÑ Refresh</button>
                    <button class="btn btn-secondary" onclick="clearFilters()">‚úï Clear Filters</button>
                </div>

                <div class="loading" id="votesLoading">
                    <div class="spinner"></div>
                    <p>Loading votes...</p>
                </div>

                <div id="votesTableContainer" style="display: none;">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date/Time</th>
                                    <th>Type</th>
                                    <th>School</th>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Phone</th>
                                    <th>Points</th>
                                    <th>Instagram Username</th>
                                    <th>IP Address</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="votesTableBody"></tbody>
                        </table>
                    </div>
                    <p style="margin-top: 15px; color: #666; font-size: 13px;">
                        Showing <strong id="votesCount">0</strong> votes
                    </p>
                </div>

                <div id="votesEmpty" class="empty-state" style="display: none;">
                    <h3>No votes found</h3>
                    <p>No votes match your current filters</p>
                </div>
            </div>

            <!-- NEWSLETTER TAB -->
            <div id="newsletterTab" style="display: none;">
                <h2>üìß Newsletter Subscribers</h2>

                <div class="export-notice">
                    <strong>üìä Export for Email Marketing:</strong> Use the CSV export to import contacts into Mailchimp, Constant Contact, or your email service provider.
                </div>

                <div class="filters">
                    <div class="filter-group">
                        <label>Status</label>
                        <select id="filterNewsletterStatus" onchange="filterNewsletter()">
                            <option value="">All Subscribers</option>
                            <option value="true">Active</option>
                            <option value="false">Inactive</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>School</label>
                        <select id="filterNewsletterSchool" onchange="filterNewsletter()">
                            <option value="">All Schools</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Search Name/Email</label>
                        <input type="text" id="filterNewsletterSearch" placeholder="Search..." onkeyup="filterNewsletter()">
                    </div>
                </div>

                <div class="actions">
                    <button class="btn btn-success" onclick="exportNewsletterToCSV()">üì• Export Newsletter to CSV</button>
                    <button class="btn btn-secondary" onclick="loadNewsletter()">üîÑ Refresh</button>
                </div>

                <div class="loading" id="newsletterLoading">
                    <div class="spinner"></div>
                    <p>Loading newsletter subscribers...</p>
                </div>

                <div id="newsletterTableContainer" style="display: none;">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Subscribed Date</th>
                                    <th>Full Name</th>
                                    <th>Email</th>
                                    <th>Phone</th>
                                    <th>School</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="newsletterTableBody"></tbody>
                        </table>
                    </div>
                    <p style="margin-top: 15px; color: #666; font-size: 13px;">
                        Showing <strong id="newsletterCount">0</strong> subscribers
                    </p>
                </div>

                <div id="newsletterEmpty" class="empty-state" style="display: none;">
                    <h3>No subscribers found</h3>
                    <p>No newsletter subscribers yet</p>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>üîó Quick Links</h2>
            <div class="quick-links">
                <a href="/teachers-feast-contest.html" class="btn" target="_blank">üìä Public Leaderboard</a>
                <a href="/contest-admin.html" class="btn btn-secondary" target="_blank">üèÜ Admin Dashboard</a>
                <a href="/contest-scraper-config.html" class="btn btn-secondary" target="_blank">‚öôÔ∏è Scraper Config</a>
                <a href="/contest-instagram-handles.html" class="btn btn-secondary" target="_blank">üì∏ Instagram Handles</a>
            </div>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

        const supabase = createClient(
            'https://gaawtbqpnnbbnsyswqwv.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdhYXd0YnFwbm5iYm5zeXN3cXd2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1MDE1NTAsImV4cCI6MjA3MjA3NzU1MH0.F-y7AIQTWaUe7DRT4OnIZVn94mhXxfhpBbng2aJ8nXg'
        );

        let allVotes = [];
        let filteredVotes = [];
        let allNewsletter = [];
        let filteredNewsletter = [];
        let allSchools = [];

        // Tab switching
        window.switchTab = function(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));

            if (tab === 'votes') {
                document.querySelector('.tab:nth-child(1)').classList.add('active');
                document.getElementById('votesTab').style.display = 'block';
                document.getElementById('newsletterTab').style.display = 'none';
                loadVotes();
            } else {
                document.querySelector('.tab:nth-child(2)').classList.add('active');
                document.getElementById('votesTab').style.display = 'none';
                document.getElementById('newsletterTab').style.display = 'block';
                loadNewsletter();
            }
        };

        // Load votes
        window.loadVotes = async function() {
            document.getElementById('votesLoading').style.display = 'block';
            document.getElementById('votesTableContainer').style.display = 'none';
            document.getElementById('votesEmpty').style.display = 'none';

            try {
                const { data, error } = await supabase
                    .from('teacher_feast_votes')
                    .select('*')
                    .order('voted_at', { ascending: false });

                if (error) throw error;

                allVotes = data;
                filteredVotes = data;

                // Load schools for filter dropdown
                await loadSchoolsFilter();

                // Update stats
                updateStats();

                // Display votes
                displayVotes(filteredVotes);

                document.getElementById('votesLoading').style.display = 'none';
                document.getElementById('votesTableContainer').style.display = 'block';

            } catch (error) {
                console.error('Error loading votes:', error);
                alert('Error loading votes: ' + error.message);
                document.getElementById('votesLoading').style.display = 'none';
            }
        };

        // Load newsletter
        window.loadNewsletter = async function() {
            document.getElementById('newsletterLoading').style.display = 'block';
            document.getElementById('newsletterTableContainer').style.display = 'none';
            document.getElementById('newsletterEmpty').style.display = 'none';

            try {
                const { data, error } = await supabase
                    .from('teacher_feast_newsletter')
                    .select('*')
                    .order('subscribed_at', { ascending: false });

                if (error) throw error;

                allNewsletter = data;
                filteredNewsletter = data;

                displayNewsletter(filteredNewsletter);

                document.getElementById('newsletterLoading').style.display = 'none';
                document.getElementById('newsletterTableContainer').style.display = 'block';

            } catch (error) {
                console.error('Error loading newsletter:', error);
                alert('Error loading newsletter: ' + error.message);
                document.getElementById('newsletterLoading').style.display = 'none';
            }
        };

        // Load schools for filter
        async function loadSchoolsFilter() {
            try {
                const { data, error } = await supabase
                    .from('teacher_feast_schools')
                    .select('school_name')
                    .order('school_name');

                if (error) throw error;

                allSchools = data;

                // Populate school filter dropdowns
                const filterSchool = document.getElementById('filterSchool');
                const filterNewsletterSchool = document.getElementById('filterNewsletterSchool');

                data.forEach(school => {
                    const option1 = document.createElement('option');
                    option1.value = school.school_name;
                    option1.textContent = school.school_name;
                    filterSchool.appendChild(option1);

                    const option2 = document.createElement('option');
                    option2.value = school.school_name;
                    option2.textContent = school.school_name;
                    filterNewsletterSchool.appendChild(option2);
                });

            } catch (error) {
                console.error('Error loading schools:', error);
            }
        }

        // Update stats
        function updateStats() {
            const totalVotes = allVotes.length;
            const formVotes = allVotes.filter(v => v.vote_type === 'form').length;
            const instagramVotes = allVotes.filter(v => v.vote_type === 'instagram').length;
            const newsletterSignups = allNewsletter.length;

            document.getElementById('totalVotes').textContent = totalVotes;
            document.getElementById('formVotes').textContent = formVotes;
            document.getElementById('instagramVotes').textContent = instagramVotes;
            document.getElementById('newsletterSignups').textContent = newsletterSignups;
        }

        // Display votes
        function displayVotes(votes) {
            const tbody = document.getElementById('votesTableBody');
            tbody.innerHTML = '';

            if (votes.length === 0) {
                document.getElementById('votesTableContainer').style.display = 'none';
                document.getElementById('votesEmpty').style.display = 'block';
                return;
            }

            votes.forEach(vote => {
                const row = document.createElement('tr');

                const votedDate = new Date(vote.voted_at);
                const formattedDate = votedDate.toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                const badgeClass = vote.vote_type === 'form' ? 'badge-form' : 'badge-instagram';
                const badgeText = vote.vote_type === 'form' ? 'FORM' : 'INSTAGRAM';

                // Create cells
                const dateCell = document.createElement('td');
                dateCell.textContent = formattedDate;

                const typeCell = document.createElement('td');
                const badge = document.createElement('span');
                badge.className = `badge ${badgeClass}`;
                badge.textContent = badgeText;
                typeCell.appendChild(badge);

                const schoolCell = document.createElement('td');
                const schoolStrong = document.createElement('strong');
                schoolStrong.textContent = vote.school_name;
                schoolCell.appendChild(schoolStrong);

                const nameCell = document.createElement('td');
                nameCell.textContent = vote.full_name || '-';

                const emailCell = document.createElement('td');
                emailCell.textContent = vote.email || '-';

                const phoneCell = document.createElement('td');
                phoneCell.textContent = vote.phone || '-';

                const pointsCell = document.createElement('td');
                const pointsStrong = document.createElement('strong');
                pointsStrong.textContent = vote.points;
                pointsCell.appendChild(pointsStrong);

                const igCell = document.createElement('td');
                igCell.textContent = vote.instagram_username || '-';

                const ipCell = document.createElement('td');
                ipCell.style.fontFamily = 'monospace';
                ipCell.style.fontSize = '11px';
                ipCell.textContent = vote.ip_address || '-';

                const actionsCell = document.createElement('td');
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn-delete';
                deleteBtn.textContent = 'üóëÔ∏è DELETE';
                deleteBtn.onclick = () => deleteVote(vote.id, vote.school_name, vote.points);
                actionsCell.appendChild(deleteBtn);

                // Append all cells
                row.appendChild(dateCell);
                row.appendChild(typeCell);
                row.appendChild(schoolCell);
                row.appendChild(nameCell);
                row.appendChild(emailCell);
                row.appendChild(phoneCell);
                row.appendChild(pointsCell);
                row.appendChild(igCell);
                row.appendChild(ipCell);
                row.appendChild(actionsCell);

                tbody.appendChild(row);
            });

            document.getElementById('votesCount').textContent = votes.length;
            document.getElementById('votesTableContainer').style.display = 'block';
            document.getElementById('votesEmpty').style.display = 'none';
        }

        // Display newsletter
        function displayNewsletter(subscribers) {
            const tbody = document.getElementById('newsletterTableBody');
            tbody.innerHTML = '';

            if (subscribers.length === 0) {
                document.getElementById('newsletterTableContainer').style.display = 'none';
                document.getElementById('newsletterEmpty').style.display = 'block';
                return;
            }

            subscribers.forEach(sub => {
                const row = document.createElement('tr');

                const subDate = new Date(sub.subscribed_at);
                const formattedDate = subDate.toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric'
                });

                const statusBadge = sub.is_active
                    ? '<span class="badge badge-form">ACTIVE</span>'
                    : '<span class="badge" style="background: #fee2e2; color: #991b1b;">INACTIVE</span>';

                row.innerHTML = `
                    <td>${formattedDate}</td>
                    <td><strong>${sub.full_name}</strong></td>
                    <td>${sub.email}</td>
                    <td>${sub.phone || '-'}</td>
                    <td>${sub.school_name || '-'}</td>
                    <td>${statusBadge}</td>
                `;

                tbody.appendChild(row);
            });

            document.getElementById('newsletterCount').textContent = subscribers.length;
            document.getElementById('newsletterTableContainer').style.display = 'block';
            document.getElementById('newsletterEmpty').style.display = 'none';
        }

        // Filter votes
        window.filterVotes = function() {
            const voteType = document.getElementById('filterVoteType').value;
            const school = document.getElementById('filterSchool').value;
            const dateFrom = document.getElementById('filterDateFrom').value;
            const dateTo = document.getElementById('filterDateTo').value;
            const search = document.getElementById('filterSearch').value.toLowerCase();

            filteredVotes = allVotes.filter(vote => {
                // Vote type filter
                if (voteType && vote.vote_type !== voteType) return false;

                // School filter
                if (school && vote.school_name !== school) return false;

                // Date filters
                if (dateFrom) {
                    const voteDate = new Date(vote.voted_at).toISOString().split('T')[0];
                    if (voteDate < dateFrom) return false;
                }
                if (dateTo) {
                    const voteDate = new Date(vote.voted_at).toISOString().split('T')[0];
                    if (voteDate > dateTo) return false;
                }

                // Search filter
                if (search) {
                    const name = (vote.full_name || '').toLowerCase();
                    const email = (vote.email || '').toLowerCase();
                    const schoolName = (vote.school_name || '').toLowerCase();
                    if (!name.includes(search) && !email.includes(search) && !schoolName.includes(search)) {
                        return false;
                    }
                }

                return true;
            });

            displayVotes(filteredVotes);
        };

        // Filter newsletter
        window.filterNewsletter = function() {
            const status = document.getElementById('filterNewsletterStatus').value;
            const school = document.getElementById('filterNewsletterSchool').value;
            const search = document.getElementById('filterNewsletterSearch').value.toLowerCase();

            filteredNewsletter = allNewsletter.filter(sub => {
                // Status filter
                if (status !== '') {
                    const isActive = status === 'true';
                    if (sub.is_active !== isActive) return false;
                }

                // School filter
                if (school && sub.school_name !== school) return false;

                // Search filter
                if (search) {
                    const name = (sub.full_name || '').toLowerCase();
                    const email = (sub.email || '').toLowerCase();
                    if (!name.includes(search) && !email.includes(search)) {
                        return false;
                    }
                }

                return true;
            });

            displayNewsletter(filteredNewsletter);
        };

        // Clear filters
        window.clearFilters = function() {
            document.getElementById('filterVoteType').value = '';
            document.getElementById('filterSchool').value = '';
            document.getElementById('filterDateFrom').value = '';
            document.getElementById('filterDateTo').value = '';
            document.getElementById('filterSearch').value = '';
            filterVotes();
        };

        // Export votes to CSV
        window.exportVotesToCSV = function() {
            if (filteredVotes.length === 0) {
                alert('No votes to export');
                return;
            }

            const headers = ['Date/Time', 'Type', 'School', 'Name', 'Email', 'Phone', 'Points', 'Instagram Username', 'IP Address'];
            const rows = filteredVotes.map(vote => {
                const votedDate = new Date(vote.voted_at).toLocaleString('en-US');
                return [
                    votedDate,
                    vote.vote_type,
                    vote.school_name,
                    vote.full_name || '',
                    vote.email || '',
                    vote.phone || '',
                    vote.points,
                    vote.instagram_username || '',
                    vote.ip_address || ''
                ];
            });

            const csvContent = [
                headers.join(','),
                ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
            ].join('\n');

            downloadCSV(csvContent, 'teacher-feast-votes.csv');
        };

        // Export newsletter to CSV
        window.exportNewsletterToCSV = function() {
            if (filteredNewsletter.length === 0) {
                alert('No newsletter subscribers to export');
                return;
            }

            const headers = ['Subscribed Date', 'Full Name', 'Email', 'Phone', 'School', 'Status'];
            const rows = filteredNewsletter.map(sub => {
                const subDate = new Date(sub.subscribed_at).toLocaleDateString('en-US');
                return [
                    subDate,
                    sub.full_name,
                    sub.email,
                    sub.phone || '',
                    sub.school_name || '',
                    sub.is_active ? 'Active' : 'Inactive'
                ];
            });

            const csvContent = [
                headers.join(','),
                ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
            ].join('\n');

            downloadCSV(csvContent, 'teacher-feast-newsletter.csv');
        };

        // Download CSV helper
        function downloadCSV(content, filename) {
            const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Delete vote with confirmation modal
        window.deleteVote = async function(voteId, schoolName, points) {
            // Create custom confirmation modal
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10000;';

            const modalContent = document.createElement('div');
            modalContent.style.cssText = 'background: white; padding: 30px; max-width: 500px; border-radius: 15px; text-align: center;';

            modalContent.innerHTML = `
                <h3 style="color: #dc2626; margin-bottom: 15px; font-size: 20px;">‚ö†Ô∏è Confirm Delete</h3>
                <p style="margin-bottom: 20px; color: #666;">Are you sure you want to delete this vote?</p>
                <p style="margin-bottom: 20px; font-weight: 600; color: #176F9A;">School: ${schoolName}<br>Points: ${points}</p>
                <p style="margin-bottom: 30px; font-size: 13px; color: #999;">This action cannot be undone.</p>
                <div style="display: flex; gap: 10px; justify-content: center;">
                    <button id="confirmDeleteBtn" class="btn" style="background: #dc2626;">DELETE</button>
                    <button id="cancelDeleteBtn" class="btn btn-secondary">CANCEL</button>
                </div>
            `;

            modal.appendChild(modalContent);
            document.body.appendChild(modal);

            // Handle cancel
            document.getElementById('cancelDeleteBtn').onclick = () => {
                document.body.removeChild(modal);
            };

            // Handle confirm
            document.getElementById('confirmDeleteBtn').onclick = async () => {
                try {
                    // Disable button and show loading
                    document.getElementById('confirmDeleteBtn').textContent = 'DELETING...';
                    document.getElementById('confirmDeleteBtn').disabled = true;

                    // Delete vote from database
                    const { error: deleteError } = await supabase
                        .from('teacher_feast_votes')
                        .delete()
                        .eq('id', voteId);

                    if (deleteError) throw deleteError;

                    // Decrement school votes using negative points
                    const { error: decrementError } = await supabase.rpc('increment_school_votes', {
                        school_name_param: schoolName,
                        points_param: -points  // Negative to decrement
                    });

                    if (decrementError) {
                        console.error('Decrement error:', decrementError);
                        // Continue even if decrement fails - vote is deleted
                    }

                    // Remove modal
                    document.body.removeChild(modal);

                    // Show success message
                    const successDiv = document.createElement('div');
                    successDiv.style.cssText = 'position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #d1fae5; border: 2px solid #059669; color: #065f46; padding: 15px 30px; border-radius: 10px; z-index: 10001; font-weight: 600;';
                    successDiv.textContent = '‚úÖ Vote deleted successfully';
                    document.body.appendChild(successDiv);

                    setTimeout(() => {
                        document.body.removeChild(successDiv);
                    }, 3000);

                    // Reload votes
                    await loadVotes();

                } catch (error) {
                    console.error('Delete error:', error);
                    document.body.removeChild(modal);

                    // Show error message
                    const errorDiv = document.createElement('div');
                    errorDiv.style.cssText = 'position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #fee2e2; border: 2px solid #dc2626; color: #991b1b; padding: 15px 30px; border-radius: 10px; z-index: 10001; font-weight: 600;';
                    errorDiv.textContent = '‚ùå Failed to delete vote: ' + error.message;
                    document.body.appendChild(errorDiv);

                    setTimeout(() => {
                        document.body.removeChild(errorDiv);
                    }, 5000);
                }
            };
        };

        // Load votes on page load
        loadVotes();
    </script>
</body>
</html>
