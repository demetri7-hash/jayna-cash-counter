<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Form Submissions - Teacher's Feast Contest Admin</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #46B0E4 0%, #176F9A 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            text-align: center;
        }

        h1 {
            font-size: 28px;
            color: #176F9A;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-bottom: 10px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
        }

        .stat-number {
            font-size: 36px;
            font-weight: 700;
            color: #176F9A;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
        }

        .section h2 {
            color: #176F9A;
            font-size: 20px;
            margin-bottom: 20px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 3px solid #e0f2fe;
        }

        .tab {
            padding: 12px 24px;
            background: var(--gray-100);
            color: var(--gray-700);
            border: none;
            cursor: pointer;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            border-radius: 0;
            transition: all 0.15s ease;
        }

        .tab.active {
            background: #176F9A;
            color: white;
        }

        .filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
            padding: 20px;
            background: #f0f9ff;
            border-radius: 10px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filter-group label {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #176F9A;
        }

        .filter-group input,
        .filter-group select {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }

        .btn {
            background: linear-gradient(135deg, #46B0E4 0%, #176F9A 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 14px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(70, 176, 228, 0.4);
        }

        .btn-secondary {
            background: white;
            color: #176F9A;
            border: 2px solid #46B0E4;
        }

        .btn-success {
            background: #059669;
            color: white;
        }

        .btn-delete {
            background: #dc2626;
            color: white;
            border: none;
            padding: 6px 12px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-delete:hover {
            background: #991b1b;
            transform: translateY(-1px);
        }

        .btn-warning {
            background: #f59e0b;
            color: white;
        }

        .btn-warning:hover {
            background: #d97706;
        }

        .actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .bulk-actions {
            display: none;
            padding: 15px;
            background: #fef3c7;
            border: 2px solid #f59e0b;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .bulk-actions.active {
            display: block;
        }

        .bulk-actions-header {
            font-weight: 700;
            color: #92400e;
            margin-bottom: 10px;
            font-size: 13px;
        }

        .bulk-actions-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .vote-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        tr.archived {
            opacity: 0.6;
            background: #fee2e2 !important;
        }

        .archived-badge {
            background: #fee2e2;
            color: #991b1b;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 700;
            margin-left: 8px;
        }

        .duplicate-group {
            background: white;
            border: 2px solid #f59e0b;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .duplicate-group-header {
            font-weight: 700;
            color: #92400e;
            margin-bottom: 15px;
            font-size: 14px;
            padding-bottom: 10px;
            border-bottom: 2px solid #fef3c7;
        }

        .duplicate-vote {
            padding: 12px;
            margin-bottom: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .duplicate-vote:hover {
            background: #f0f9ff;
            border-color: #46B0E4;
        }

        .duplicate-vote.selected {
            background: #d1fae5;
            border-color: #059669;
        }

        .duplicate-vote-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .duplicate-match-badge {
            display: inline-block;
            padding: 2px 8px;
            background: #fef3c7;
            color: #92400e;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0f2fe;
            font-size: 13px;
        }

        th {
            background: #f0f9ff;
            color: #176F9A;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 11px;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
        }

        tr:hover {
            background: #f9fafb;
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-form {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-instagram {
            background: #dbeafe;
            color: #1e40af;
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid #e0f2fe;
            border-top: 4px solid #46B0E4;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #9ca3af;
        }

        .empty-state h3 {
            font-size: 18px;
            margin-bottom: 10px;
        }

        .table-container {
            overflow-x: auto;
            max-height: 600px;
            overflow-y: auto;
        }

        .quick-links {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .quick-links a {
            text-decoration: none;
        }

        .export-notice {
            background: #fef3c7;
            border: 2px solid #f59e0b;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 13px;
            color: #92400e;
        }

        @media (max-width: 768px) {
            .filters {
                grid-template-columns: 1fr;
            }

            .stats {
                grid-template-columns: 1fr 1fr;
            }

            table {
                font-size: 12px;
            }

            th, td {
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìã Form Submissions & Newsletter</h1>
            <p style="color: #666; margin-top: 10px;">View all contest votes and newsletter signups</p>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="totalVotes">--</div>
                <div class="stat-label">Total Votes</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="formVotes">--</div>
                <div class="stat-label">Form Votes (2pts)</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="instagramVotes">--</div>
                <div class="stat-label">Instagram Votes (1pt)</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="newsletterSignups">--</div>
                <div class="stat-label">Newsletter Signups</div>
            </div>
        </div>

        <div class="section">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('votes')">All Votes</button>
                <button class="tab" onclick="switchTab('newsletter')">Newsletter Subscribers</button>
            </div>

            <!-- VOTES TAB -->
            <div id="votesTab">
                <h2>üó≥Ô∏è All Contest Votes</h2>

                <div class="filters">
                    <div class="filter-group">
                        <label>Vote Type</label>
                        <select id="filterVoteType" onchange="filterVotes()">
                            <option value="">All Types</option>
                            <option value="form">Form Votes (2pts)</option>
                            <option value="instagram">Instagram Tags (1pt)</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>School</label>
                        <select id="filterSchool" onchange="filterVotes()">
                            <option value="">All Schools</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Date From</label>
                        <input type="date" id="filterDateFrom" onchange="filterVotes()">
                    </div>
                    <div class="filter-group">
                        <label>Date To</label>
                        <input type="date" id="filterDateTo" onchange="filterVotes()">
                    </div>
                    <div class="filter-group">
                        <label>Search Name/Email</label>
                        <input type="text" id="filterSearch" placeholder="Search..." onkeyup="filterVotes()">
                    </div>
                </div>

                <div class="bulk-actions" id="bulkActions">
                    <div class="bulk-actions-header">
                        <span id="selectedCount">0</span> vote(s) selected
                    </div>
                    <div class="bulk-actions-buttons">
                        <button class="btn btn-warning" onclick="bulkChangeSchool()">üîÑ Change School</button>
                        <button class="btn btn-delete" onclick="bulkArchive()">üì¶ Archive</button>
                        <button class="btn btn-success" onclick="bulkUnarchive()">‚Ü©Ô∏è Unarchive</button>
                        <button class="btn btn-secondary" onclick="clearSelection()">‚úï Clear Selection</button>
                    </div>
                </div>

                <div class="actions">
                    <button class="btn btn-success" onclick="exportVotesToCSV()">üì• Export Votes to CSV</button>
                    <button class="btn btn-warning" onclick="scanForDuplicates()">üîç Scan for Duplicates</button>
                    <button class="btn btn-secondary" onclick="loadVotes()">üîÑ Refresh</button>
                    <button class="btn btn-secondary" onclick="clearFilters()">‚úï Clear Filters</button>
                </div>

                <div class="loading" id="votesLoading">
                    <div class="spinner"></div>
                    <p>Loading votes...</p>
                </div>

                <div id="votesTableContainer" style="display: none;">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th style="width: 40px;">
                                        <input type="checkbox" id="selectAll" class="vote-checkbox" onchange="toggleSelectAll()">
                                    </th>
                                    <th>Date/Time</th>
                                    <th>Type</th>
                                    <th>School</th>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Phone</th>
                                    <th>Points</th>
                                    <th>Instagram Username</th>
                                    <th>IP Address</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="votesTableBody"></tbody>
                        </table>
                    </div>
                    <p style="margin-top: 15px; color: #666; font-size: 13px;">
                        Showing <strong id="votesCount">0</strong> votes
                    </p>
                </div>

                <div id="votesEmpty" class="empty-state" style="display: none;">
                    <h3>No votes found</h3>
                    <p>No votes match your current filters</p>
                </div>
            </div>

            <!-- NEWSLETTER TAB -->
            <div id="newsletterTab" style="display: none;">
                <h2>üìß Newsletter Subscribers</h2>

                <div class="export-notice">
                    <strong>üìä Export for Email Marketing:</strong> Use the CSV export to import contacts into Mailchimp, Constant Contact, or your email service provider.
                </div>

                <div class="filters">
                    <div class="filter-group">
                        <label>Status</label>
                        <select id="filterNewsletterStatus" onchange="filterNewsletter()">
                            <option value="">All Subscribers</option>
                            <option value="true">Active</option>
                            <option value="false">Inactive</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>School</label>
                        <select id="filterNewsletterSchool" onchange="filterNewsletter()">
                            <option value="">All Schools</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Search Name/Email</label>
                        <input type="text" id="filterNewsletterSearch" placeholder="Search..." onkeyup="filterNewsletter()">
                    </div>
                </div>

                <div class="actions">
                    <button class="btn btn-success" onclick="exportNewsletterToCSV()">üì• Export Newsletter to CSV</button>
                    <button class="btn btn-secondary" onclick="loadNewsletter()">üîÑ Refresh</button>
                </div>

                <div class="loading" id="newsletterLoading">
                    <div class="spinner"></div>
                    <p>Loading newsletter subscribers...</p>
                </div>

                <div id="newsletterTableContainer" style="display: none;">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Subscribed Date</th>
                                    <th>Full Name</th>
                                    <th>Email</th>
                                    <th>Phone</th>
                                    <th>School</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="newsletterTableBody"></tbody>
                        </table>
                    </div>
                    <p style="margin-top: 15px; color: #666; font-size: 13px;">
                        Showing <strong id="newsletterCount">0</strong> subscribers
                    </p>
                </div>

                <div id="newsletterEmpty" class="empty-state" style="display: none;">
                    <h3>No subscribers found</h3>
                    <p>No newsletter subscribers yet</p>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>üîó Quick Links</h2>
            <div class="quick-links">
                <a href="/teachers-feast-contest.html" class="btn" target="_blank">üìä Public Leaderboard</a>
                <a href="/contest-admin.html" class="btn btn-secondary" target="_blank">üèÜ Admin Dashboard</a>
                <a href="/contest-scraper-config.html" class="btn btn-secondary" target="_blank">‚öôÔ∏è Scraper Config</a>
                <a href="/contest-instagram-handles.html" class="btn btn-secondary" target="_blank">üì∏ Instagram Handles</a>
            </div>
        </div>

        <!-- SCHOOL MANAGEMENT SECTION -->
        <div class="section">
            <h2>üè´ Manage Schools</h2>
            <p style="color: #666; margin-bottom: 20px; font-size: 14px;">Add, edit, or remove schools from the contest. Be careful when deleting schools with existing votes!</p>

            <div class="bulk-actions" id="bulkSchoolActions">
                <div class="bulk-actions-header">
                    <span id="selectedSchoolCount">0</span> school(s) selected
                </div>
                <div class="bulk-actions-buttons">
                    <button class="btn btn-warning" onclick="mergeSchools()">üîÄ Merge Schools</button>
                    <button class="btn btn-secondary" onclick="clearSchoolSelection()">‚úï Clear Selection</button>
                </div>
            </div>

            <div class="actions">
                <button class="btn btn-success" onclick="showAddSchoolModal()">‚ûï Add New School</button>
                <button class="btn btn-secondary" onclick="loadSchools()">üîÑ Refresh Schools</button>
            </div>

            <div class="loading" id="schoolsLoading">
                <div class="spinner"></div>
                <p>Loading schools...</p>
            </div>

            <div id="schoolsTableContainer" style="display: none;">
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 40px;">
                                    <input type="checkbox" id="selectAllSchools" class="vote-checkbox" onchange="toggleSelectAllSchools()">
                                </th>
                                <th>School Name</th>
                                <th>Total Votes</th>
                                <th>Total Points</th>
                                <th>Form Votes</th>
                                <th>Instagram Votes</th>
                                <th>Instagram Handles</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="schoolsTableBody"></tbody>
                    </table>
                </div>
                <p style="margin-top: 15px; color: #666; font-size: 13px;">
                    Total Schools: <strong id="schoolsCount">0</strong>
                </p>
            </div>

            <div id="schoolsEmpty" class="empty-state" style="display: none;">
                <h3>No schools found</h3>
                <p>Add your first school to get started</p>
            </div>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

        const supabase = createClient(
            'https://gaawtbqpnnbbnsyswqwv.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdhYXd0YnFwbm5iYm5zeXN3cXd2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1MDE1NTAsImV4cCI6MjA3MjA3NzU1MH0.F-y7AIQTWaUe7DRT4OnIZVn94mhXxfhpBbng2aJ8nXg'
        );

        let allVotes = [];
        let filteredVotes = [];
        let allNewsletter = [];
        let filteredNewsletter = [];
        let allSchools = [];
        let selectedVotes = new Set();
        let selectedSchools = new Set();

        // Tab switching
        window.switchTab = function(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));

            if (tab === 'votes') {
                document.querySelector('.tab:nth-child(1)').classList.add('active');
                document.getElementById('votesTab').style.display = 'block';
                document.getElementById('newsletterTab').style.display = 'none';
                loadVotes();
            } else {
                document.querySelector('.tab:nth-child(2)').classList.add('active');
                document.getElementById('votesTab').style.display = 'none';
                document.getElementById('newsletterTab').style.display = 'block';
                loadNewsletter();
            }
        };

        // Load votes
        window.loadVotes = async function() {
            document.getElementById('votesLoading').style.display = 'block';
            document.getElementById('votesTableContainer').style.display = 'none';
            document.getElementById('votesEmpty').style.display = 'none';

            try {
                const { data, error } = await supabase
                    .from('teacher_feast_votes')
                    .select('*')
                    .order('voted_at', { ascending: false });

                if (error) throw error;

                allVotes = data;
                filteredVotes = data;

                // Load schools for filter dropdown
                await loadSchoolsFilter();

                // Update stats
                updateStats();

                // Display votes
                displayVotes(filteredVotes);

                document.getElementById('votesLoading').style.display = 'none';
                document.getElementById('votesTableContainer').style.display = 'block';

            } catch (error) {
                console.error('Error loading votes:', error);
                alert('Error loading votes: ' + error.message);
                document.getElementById('votesLoading').style.display = 'none';
            }
        };

        // Load newsletter
        window.loadNewsletter = async function() {
            document.getElementById('newsletterLoading').style.display = 'block';
            document.getElementById('newsletterTableContainer').style.display = 'none';
            document.getElementById('newsletterEmpty').style.display = 'none';

            try {
                const { data, error } = await supabase
                    .from('teacher_feast_newsletter')
                    .select('*')
                    .order('subscribed_at', { ascending: false });

                if (error) throw error;

                allNewsletter = data;
                filteredNewsletter = data;

                displayNewsletter(filteredNewsletter);

                document.getElementById('newsletterLoading').style.display = 'none';
                document.getElementById('newsletterTableContainer').style.display = 'block';

            } catch (error) {
                console.error('Error loading newsletter:', error);
                alert('Error loading newsletter: ' + error.message);
                document.getElementById('newsletterLoading').style.display = 'none';
            }
        };

        // Load schools for filter
        async function loadSchoolsFilter() {
            try {
                const { data, error } = await supabase
                    .from('teacher_feast_schools')
                    .select('school_name')
                    .order('school_name');

                if (error) throw error;

                allSchools = data;

                // Populate school filter dropdowns
                const filterSchool = document.getElementById('filterSchool');
                const filterNewsletterSchool = document.getElementById('filterNewsletterSchool');

                data.forEach(school => {
                    const option1 = document.createElement('option');
                    option1.value = school.school_name;
                    option1.textContent = school.school_name;
                    filterSchool.appendChild(option1);

                    const option2 = document.createElement('option');
                    option2.value = school.school_name;
                    option2.textContent = school.school_name;
                    filterNewsletterSchool.appendChild(option2);
                });

            } catch (error) {
                console.error('Error loading schools:', error);
            }
        }

        // Update stats
        function updateStats() {
            const totalVotes = allVotes.length;
            const formVotes = allVotes.filter(v => v.vote_type === 'form').length;
            const instagramVotes = allVotes.filter(v => v.vote_type === 'instagram').length;
            const newsletterSignups = allNewsletter.length;

            document.getElementById('totalVotes').textContent = totalVotes;
            document.getElementById('formVotes').textContent = formVotes;
            document.getElementById('instagramVotes').textContent = instagramVotes;
            document.getElementById('newsletterSignups').textContent = newsletterSignups;
        }

        // Display votes
        function displayVotes(votes) {
            const tbody = document.getElementById('votesTableBody');
            tbody.innerHTML = '';

            if (votes.length === 0) {
                document.getElementById('votesTableContainer').style.display = 'none';
                document.getElementById('votesEmpty').style.display = 'block';
                return;
            }

            votes.forEach(vote => {
                const row = document.createElement('tr');

                // Add archived class if vote is archived
                if (vote.is_archived) {
                    row.classList.add('archived');
                }

                const votedDate = new Date(vote.voted_at);
                const formattedDate = votedDate.toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                const badgeClass = vote.vote_type === 'form' ? 'badge-form' : 'badge-instagram';
                const badgeText = vote.vote_type === 'form' ? 'FORM' : 'INSTAGRAM';

                // Create checkbox cell
                const checkboxCell = document.createElement('td');
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'vote-checkbox';
                checkbox.checked = selectedVotes.has(vote.id);
                checkbox.onchange = () => toggleVoteSelection(vote.id);
                checkboxCell.appendChild(checkbox);

                // Create cells
                const dateCell = document.createElement('td');
                dateCell.textContent = formattedDate;

                const typeCell = document.createElement('td');
                const badge = document.createElement('span');
                badge.className = `badge ${badgeClass}`;
                badge.textContent = badgeText;
                typeCell.appendChild(badge);

                const schoolCell = document.createElement('td');
                const schoolStrong = document.createElement('strong');
                schoolStrong.textContent = vote.school_name;
                schoolCell.appendChild(schoolStrong);
                if (vote.is_archived) {
                    const archivedBadge = document.createElement('span');
                    archivedBadge.className = 'archived-badge';
                    archivedBadge.textContent = 'ARCHIVED';
                    schoolCell.appendChild(archivedBadge);
                }

                const nameCell = document.createElement('td');
                nameCell.textContent = vote.full_name || '-';

                const emailCell = document.createElement('td');
                emailCell.textContent = vote.email || '-';

                const phoneCell = document.createElement('td');
                phoneCell.textContent = vote.phone || '-';

                const pointsCell = document.createElement('td');
                const pointsStrong = document.createElement('strong');
                pointsStrong.textContent = vote.points;
                pointsCell.appendChild(pointsStrong);

                const igCell = document.createElement('td');
                igCell.textContent = vote.instagram_username || '-';

                const ipCell = document.createElement('td');
                ipCell.style.fontFamily = 'monospace';
                ipCell.style.fontSize = '11px';
                ipCell.textContent = vote.ip_address || '-';

                const actionsCell = document.createElement('td');
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn-delete';
                deleteBtn.textContent = 'üóëÔ∏è DELETE';
                deleteBtn.onclick = () => deleteVote(vote.id, vote.school_name, vote.points);
                actionsCell.appendChild(deleteBtn);

                // Append all cells
                row.appendChild(checkboxCell);
                row.appendChild(dateCell);
                row.appendChild(typeCell);
                row.appendChild(schoolCell);
                row.appendChild(nameCell);
                row.appendChild(emailCell);
                row.appendChild(phoneCell);
                row.appendChild(pointsCell);
                row.appendChild(igCell);
                row.appendChild(ipCell);
                row.appendChild(actionsCell);

                tbody.appendChild(row);
            });

            document.getElementById('votesCount').textContent = votes.length;
            document.getElementById('votesTableContainer').style.display = 'block';
            document.getElementById('votesEmpty').style.display = 'none';
        }

        // Display newsletter
        function displayNewsletter(subscribers) {
            const tbody = document.getElementById('newsletterTableBody');
            tbody.innerHTML = '';

            if (subscribers.length === 0) {
                document.getElementById('newsletterTableContainer').style.display = 'none';
                document.getElementById('newsletterEmpty').style.display = 'block';
                return;
            }

            subscribers.forEach(sub => {
                const row = document.createElement('tr');

                const subDate = new Date(sub.subscribed_at);
                const formattedDate = subDate.toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric'
                });

                const statusBadge = sub.is_active
                    ? '<span class="badge badge-form">ACTIVE</span>'
                    : '<span class="badge" style="background: #fee2e2; color: #991b1b;">INACTIVE</span>';

                row.innerHTML = `
                    <td>${formattedDate}</td>
                    <td><strong>${sub.full_name}</strong></td>
                    <td>${sub.email}</td>
                    <td>${sub.phone || '-'}</td>
                    <td>${sub.school_name || '-'}</td>
                    <td>${statusBadge}</td>
                `;

                tbody.appendChild(row);
            });

            document.getElementById('newsletterCount').textContent = subscribers.length;
            document.getElementById('newsletterTableContainer').style.display = 'block';
            document.getElementById('newsletterEmpty').style.display = 'none';
        }

        // Filter votes
        window.filterVotes = function() {
            const voteType = document.getElementById('filterVoteType').value;
            const school = document.getElementById('filterSchool').value;
            const dateFrom = document.getElementById('filterDateFrom').value;
            const dateTo = document.getElementById('filterDateTo').value;
            const search = document.getElementById('filterSearch').value.toLowerCase();

            filteredVotes = allVotes.filter(vote => {
                // Vote type filter
                if (voteType && vote.vote_type !== voteType) return false;

                // School filter
                if (school && vote.school_name !== school) return false;

                // Date filters
                if (dateFrom) {
                    const voteDate = new Date(vote.voted_at).toISOString().split('T')[0];
                    if (voteDate < dateFrom) return false;
                }
                if (dateTo) {
                    const voteDate = new Date(vote.voted_at).toISOString().split('T')[0];
                    if (voteDate > dateTo) return false;
                }

                // Search filter
                if (search) {
                    const name = (vote.full_name || '').toLowerCase();
                    const email = (vote.email || '').toLowerCase();
                    const schoolName = (vote.school_name || '').toLowerCase();
                    if (!name.includes(search) && !email.includes(search) && !schoolName.includes(search)) {
                        return false;
                    }
                }

                return true;
            });

            displayVotes(filteredVotes);
        };

        // Filter newsletter
        window.filterNewsletter = function() {
            const status = document.getElementById('filterNewsletterStatus').value;
            const school = document.getElementById('filterNewsletterSchool').value;
            const search = document.getElementById('filterNewsletterSearch').value.toLowerCase();

            filteredNewsletter = allNewsletter.filter(sub => {
                // Status filter
                if (status !== '') {
                    const isActive = status === 'true';
                    if (sub.is_active !== isActive) return false;
                }

                // School filter
                if (school && sub.school_name !== school) return false;

                // Search filter
                if (search) {
                    const name = (sub.full_name || '').toLowerCase();
                    const email = (sub.email || '').toLowerCase();
                    if (!name.includes(search) && !email.includes(search)) {
                        return false;
                    }
                }

                return true;
            });

            displayNewsletter(filteredNewsletter);
        };

        // Clear filters
        window.clearFilters = function() {
            document.getElementById('filterVoteType').value = '';
            document.getElementById('filterSchool').value = '';
            document.getElementById('filterDateFrom').value = '';
            document.getElementById('filterDateTo').value = '';
            document.getElementById('filterSearch').value = '';
            filterVotes();
        };

        // Export votes to CSV
        window.exportVotesToCSV = function() {
            if (filteredVotes.length === 0) {
                alert('No votes to export');
                return;
            }

            const headers = ['Date/Time', 'Type', 'School', 'Name', 'Email', 'Phone', 'Points', 'Instagram Username', 'IP Address'];
            const rows = filteredVotes.map(vote => {
                const votedDate = new Date(vote.voted_at).toLocaleString('en-US');
                return [
                    votedDate,
                    vote.vote_type,
                    vote.school_name,
                    vote.full_name || '',
                    vote.email || '',
                    vote.phone || '',
                    vote.points,
                    vote.instagram_username || '',
                    vote.ip_address || ''
                ];
            });

            const csvContent = [
                headers.join(','),
                ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
            ].join('\n');

            downloadCSV(csvContent, 'teacher-feast-votes.csv');
        };

        // Export newsletter to CSV
        window.exportNewsletterToCSV = function() {
            if (filteredNewsletter.length === 0) {
                alert('No newsletter subscribers to export');
                return;
            }

            const headers = ['Subscribed Date', 'Full Name', 'Email', 'Phone', 'School', 'Status'];
            const rows = filteredNewsletter.map(sub => {
                const subDate = new Date(sub.subscribed_at).toLocaleDateString('en-US');
                return [
                    subDate,
                    sub.full_name,
                    sub.email,
                    sub.phone || '',
                    sub.school_name || '',
                    sub.is_active ? 'Active' : 'Inactive'
                ];
            });

            const csvContent = [
                headers.join(','),
                ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
            ].join('\n');

            downloadCSV(csvContent, 'teacher-feast-newsletter.csv');
        };

        // Download CSV helper
        function downloadCSV(content, filename) {
            const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Delete vote with confirmation modal
        window.deleteVote = async function(voteId, schoolName, points) {
            // Create custom confirmation modal
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10000;';

            const modalContent = document.createElement('div');
            modalContent.style.cssText = 'background: white; padding: 30px; max-width: 500px; border-radius: 15px; text-align: center;';

            modalContent.innerHTML = `
                <h3 style="color: #dc2626; margin-bottom: 15px; font-size: 20px;">‚ö†Ô∏è Confirm Delete</h3>
                <p style="margin-bottom: 20px; color: #666;">Are you sure you want to delete this vote?</p>
                <p style="margin-bottom: 20px; font-weight: 600; color: #176F9A;">School: ${schoolName}<br>Points: ${points}</p>
                <p style="margin-bottom: 30px; font-size: 13px; color: #999;">This action cannot be undone.</p>
                <div style="display: flex; gap: 10px; justify-content: center;">
                    <button id="confirmDeleteBtn" class="btn" style="background: #dc2626;">DELETE</button>
                    <button id="cancelDeleteBtn" class="btn btn-secondary">CANCEL</button>
                </div>
            `;

            modal.appendChild(modalContent);
            document.body.appendChild(modal);

            // Handle cancel
            document.getElementById('cancelDeleteBtn').onclick = () => {
                document.body.removeChild(modal);
            };

            // Handle confirm
            document.getElementById('confirmDeleteBtn').onclick = async () => {
                try {
                    // Disable button and show loading
                    document.getElementById('confirmDeleteBtn').textContent = 'DELETING...';
                    document.getElementById('confirmDeleteBtn').disabled = true;

                    // Delete vote from database
                    const { error: deleteError } = await supabase
                        .from('teacher_feast_votes')
                        .delete()
                        .eq('id', voteId);

                    if (deleteError) throw deleteError;

                    // Decrement school votes using negative points
                    const { error: decrementError } = await supabase.rpc('increment_school_votes', {
                        school_name_param: schoolName,
                        points_param: -points  // Negative to decrement
                    });

                    if (decrementError) {
                        console.error('Decrement error:', decrementError);
                        // Continue even if decrement fails - vote is deleted
                    }

                    // Remove modal
                    document.body.removeChild(modal);

                    // Show success message
                    const successDiv = document.createElement('div');
                    successDiv.style.cssText = 'position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #d1fae5; border: 2px solid #059669; color: #065f46; padding: 15px 30px; border-radius: 10px; z-index: 10001; font-weight: 600;';
                    successDiv.textContent = '‚úÖ Vote deleted successfully';
                    document.body.appendChild(successDiv);

                    setTimeout(() => {
                        document.body.removeChild(successDiv);
                    }, 3000);

                    // Reload votes
                    await loadVotes();

                } catch (error) {
                    console.error('Delete error:', error);
                    document.body.removeChild(modal);

                    // Show error message
                    const errorDiv = document.createElement('div');
                    errorDiv.style.cssText = 'position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #fee2e2; border: 2px solid #dc2626; color: #991b1b; padding: 15px 30px; border-radius: 10px; z-index: 10001; font-weight: 600;';
                    errorDiv.textContent = '‚ùå Failed to delete vote: ' + error.message;
                    document.body.appendChild(errorDiv);

                    setTimeout(() => {
                        document.body.removeChild(errorDiv);
                    }, 5000);
                }
            };
        };

        // Toggle vote selection
        window.toggleVoteSelection = function(voteId) {
            if (selectedVotes.has(voteId)) {
                selectedVotes.delete(voteId);
            } else {
                selectedVotes.add(voteId);
            }
            updateBulkActionsBar();
        };

        // Toggle select all
        window.toggleSelectAll = function() {
            const selectAllCheckbox = document.getElementById('selectAll');
            if (selectAllCheckbox.checked) {
                // Select all filtered votes
                filteredVotes.forEach(vote => selectedVotes.add(vote.id));
            } else {
                // Deselect all
                selectedVotes.clear();
            }
            updateBulkActionsBar();
            displayVotes(filteredVotes); // Refresh to update checkboxes
        };

        // Clear selection
        window.clearSelection = function() {
            selectedVotes.clear();
            document.getElementById('selectAll').checked = false;
            updateBulkActionsBar();
            displayVotes(filteredVotes);
        };

        // Update bulk actions bar
        function updateBulkActionsBar() {
            const bulkActions = document.getElementById('bulkActions');
            const selectedCount = document.getElementById('selectedCount');

            selectedCount.textContent = selectedVotes.size;

            if (selectedVotes.size > 0) {
                bulkActions.classList.add('active');
            } else {
                bulkActions.classList.remove('active');
            }
        }

        // Bulk change school
        window.bulkChangeSchool = async function() {
            if (selectedVotes.size === 0) {
                alert('Please select at least one vote');
                return;
            }

            // Create modal for school selection
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10000;';

            const modalContent = document.createElement('div');
            modalContent.style.cssText = 'background: white; padding: 30px; max-width: 500px; width: 90%; border-radius: 15px;';

            const schoolOptions = allSchools.map(s => `<option value="${s.school_name}">${s.school_name}</option>`).join('');

            modalContent.innerHTML = `
                <h3 style="color: #176F9A; margin-bottom: 15px; font-size: 20px;">üîÑ Change School</h3>
                <p style="margin-bottom: 20px; color: #666;">
                    Moving <strong>${selectedVotes.size}</strong> vote(s) to a new school.
                </p>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 700; color: #176F9A;">Select New School:</label>
                    <select id="newSchoolSelect" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px;">
                        <option value="">-- Select School --</option>
                        ${schoolOptions}
                    </select>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button id="confirmChangeBtn" class="btn" style="background: #46B0E4;">CHANGE SCHOOL</button>
                    <button id="cancelChangeBtn" class="btn btn-secondary">CANCEL</button>
                </div>
            `;

            modal.appendChild(modalContent);
            document.body.appendChild(modal);

            // Handle cancel
            document.getElementById('cancelChangeBtn').onclick = () => {
                document.body.removeChild(modal);
            };

            // Handle confirm
            document.getElementById('confirmChangeBtn').onclick = async () => {
                const newSchool = document.getElementById('newSchoolSelect').value;

                if (!newSchool) {
                    alert('Please select a school');
                    return;
                }

                try {
                    document.getElementById('confirmChangeBtn').textContent = 'CHANGING...';
                    document.getElementById('confirmChangeBtn').disabled = true;

                    // Get selected votes with their current schools and points
                    const selectedVotesList = allVotes.filter(v => selectedVotes.has(v.id));

                    // Group by old school to batch point adjustments
                    const schoolAdjustments = {};
                    for (const vote of selectedVotesList) {
                        if (!schoolAdjustments[vote.school_name]) {
                            schoolAdjustments[vote.school_name] = 0;
                        }
                        schoolAdjustments[vote.school_name] += vote.points;
                    }

                    // Decrement old schools and increment new school
                    for (const [oldSchool, totalPoints] of Object.entries(schoolAdjustments)) {
                        // Decrement old school
                        await supabase.rpc('increment_school_votes', {
                            school_name_param: oldSchool,
                            points_param: -totalPoints
                        });
                    }

                    // Increment new school
                    const totalPoints = selectedVotesList.reduce((sum, v) => sum + v.points, 0);
                    await supabase.rpc('increment_school_votes', {
                        school_name_param: newSchool,
                        points_param: totalPoints
                    });

                    // Update vote records
                    for (const voteId of selectedVotes) {
                        await supabase
                            .from('teacher_feast_votes')
                            .update({ school_name: newSchool })
                            .eq('id', voteId);
                    }

                    document.body.removeChild(modal);
                    showSuccessMessage(`‚úÖ ${selectedVotes.size} vote(s) moved to ${newSchool}`);
                    clearSelection();
                    await loadVotes();

                } catch (error) {
                    console.error('Bulk change school error:', error);
                    alert('Error changing school: ' + error.message);
                    document.getElementById('confirmChangeBtn').textContent = 'CHANGE SCHOOL';
                    document.getElementById('confirmChangeBtn').disabled = false;
                }
            };
        };

        // Bulk archive
        window.bulkArchive = async function() {
            if (selectedVotes.size === 0) {
                alert('Please select at least one vote');
                return;
            }

            if (!confirm(`Archive ${selectedVotes.size} vote(s)? This will remove their points from the leaderboard but keep the records.`)) {
                return;
            }

            try {
                // Get selected votes to calculate points
                const selectedVotesList = allVotes.filter(v => selectedVotes.has(v.id));

                // Group by school to batch point adjustments
                const schoolAdjustments = {};
                for (const vote of selectedVotesList) {
                    if (!schoolAdjustments[vote.school_name]) {
                        schoolAdjustments[vote.school_name] = 0;
                    }
                    schoolAdjustments[vote.school_name] += vote.points;
                }

                // Decrement school votes
                for (const [school, totalPoints] of Object.entries(schoolAdjustments)) {
                    await supabase.rpc('increment_school_votes', {
                        school_name_param: school,
                        points_param: -totalPoints
                    });
                }

                // Archive votes
                for (const voteId of selectedVotes) {
                    await supabase
                        .from('teacher_feast_votes')
                        .update({ is_archived: true })
                        .eq('id', voteId);
                }

                showSuccessMessage(`‚úÖ ${selectedVotes.size} vote(s) archived`);
                clearSelection();
                await loadVotes();

            } catch (error) {
                console.error('Bulk archive error:', error);
                alert('Error archiving votes: ' + error.message);
            }
        };

        // Bulk unarchive
        window.bulkUnarchive = async function() {
            if (selectedVotes.size === 0) {
                alert('Please select at least one vote');
                return;
            }

            if (!confirm(`Unarchive ${selectedVotes.size} vote(s)? This will restore their points to the leaderboard.`)) {
                return;
            }

            try {
                // Get selected votes to calculate points
                const selectedVotesList = allVotes.filter(v => selectedVotes.has(v.id));

                // Group by school to batch point adjustments
                const schoolAdjustments = {};
                for (const vote of selectedVotesList) {
                    if (!schoolAdjustments[vote.school_name]) {
                        schoolAdjustments[vote.school_name] = 0;
                    }
                    schoolAdjustments[vote.school_name] += vote.points;
                }

                // Increment school votes
                for (const [school, totalPoints] of Object.entries(schoolAdjustments)) {
                    await supabase.rpc('increment_school_votes', {
                        school_name_param: school,
                        points_param: totalPoints
                    });
                }

                // Unarchive votes
                for (const voteId of selectedVotes) {
                    await supabase
                        .from('teacher_feast_votes')
                        .update({ is_archived: false })
                        .eq('id', voteId);
                }

                showSuccessMessage(`‚úÖ ${selectedVotes.size} vote(s) restored`);
                clearSelection();
                await loadVotes();

            } catch (error) {
                console.error('Bulk unarchive error:', error);
                alert('Error unarchiving votes: ' + error.message);
            }
        };

        // Show success message helper
        function showSuccessMessage(message) {
            const successDiv = document.createElement('div');
            successDiv.style.cssText = 'position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #d1fae5; border: 2px solid #059669; color: #065f46; padding: 15px 30px; border-radius: 10px; z-index: 10001; font-weight: 600;';
            successDiv.textContent = message;
            document.body.appendChild(successDiv);

            setTimeout(() => {
                if (document.body.contains(successDiv)) {
                    document.body.removeChild(successDiv);
                }
            }, 3000);
        }

        // ========================================
        // SCHOOL MANAGEMENT FUNCTIONS
        // ========================================

        // Load schools
        window.loadSchools = async function() {
            document.getElementById('schoolsLoading').style.display = 'block';
            document.getElementById('schoolsTableContainer').style.display = 'none';
            document.getElementById('schoolsEmpty').style.display = 'none';

            try {
                const { data, error } = await supabase
                    .from('teacher_feast_schools')
                    .select('*')
                    .order('total_votes', { ascending: false });

                if (error) throw error;

                displaySchools(data);

                document.getElementById('schoolsLoading').style.display = 'none';

            } catch (error) {
                console.error('Error loading schools:', error);
                alert('Error loading schools: ' + error.message);
                document.getElementById('schoolsLoading').style.display = 'none';
            }
        };

        // Display schools
        function displaySchools(schools) {
            const tbody = document.getElementById('schoolsTableBody');
            tbody.innerHTML = '';

            if (!schools || schools.length === 0) {
                document.getElementById('schoolsTableContainer').style.display = 'none';
                document.getElementById('schoolsEmpty').style.display = 'block';
                return;
            }

            schools.forEach(school => {
                const row = document.createElement('tr');

                // Checkbox cell
                const checkboxCell = document.createElement('td');
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'vote-checkbox';
                checkbox.checked = selectedSchools.has(school.school_name);
                checkbox.onchange = () => toggleSchoolSelection(school.school_name);
                checkboxCell.appendChild(checkbox);

                // School name cell
                const nameCell = document.createElement('td');
                const nameStrong = document.createElement('strong');
                nameStrong.textContent = school.school_name;
                nameCell.appendChild(nameStrong);

                // Total votes cell
                const totalVotesCell = document.createElement('td');
                totalVotesCell.textContent = school.total_votes || 0;

                // Total points - calculated field
                const totalPointsCell = document.createElement('td');
                const totalPoints = (school.form_votes * 2) + (school.instagram_votes * 1);
                const pointsStrong = document.createElement('strong');
                pointsStrong.style.color = '#176F9A';
                pointsStrong.textContent = totalPoints;
                totalPointsCell.appendChild(pointsStrong);

                // Form votes cell
                const formVotesCell = document.createElement('td');
                formVotesCell.textContent = school.form_votes || 0;

                // Instagram votes cell
                const igVotesCell = document.createElement('td');
                igVotesCell.textContent = school.instagram_votes || 0;

                // Instagram handles cell
                const handlesCell = document.createElement('td');
                const handles = school.instagram_handles || [];
                if (handles.length > 0) {
                    handlesCell.textContent = handles.join(', ');
                    handlesCell.style.fontSize = '12px';
                } else {
                    handlesCell.textContent = '-';
                    handlesCell.style.color = '#999';
                }

                // Actions cell
                const actionsCell = document.createElement('td');
                actionsCell.style.display = 'flex';
                actionsCell.style.gap = '8px';

                const editBtn = document.createElement('button');
                editBtn.className = 'btn btn-warning';
                editBtn.style.padding = '6px 12px';
                editBtn.style.fontSize = '11px';
                editBtn.textContent = '‚úèÔ∏è EDIT';
                editBtn.onclick = () => showEditSchoolModal(school);
                actionsCell.appendChild(editBtn);

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn-delete';
                deleteBtn.textContent = 'üóëÔ∏è DELETE';
                deleteBtn.onclick = () => deleteSchool(school);
                actionsCell.appendChild(deleteBtn);

                // Append all cells
                row.appendChild(checkboxCell);
                row.appendChild(nameCell);
                row.appendChild(totalVotesCell);
                row.appendChild(totalPointsCell);
                row.appendChild(formVotesCell);
                row.appendChild(igVotesCell);
                row.appendChild(handlesCell);
                row.appendChild(actionsCell);

                tbody.appendChild(row);
            });

            document.getElementById('schoolsCount').textContent = schools.length;
            document.getElementById('schoolsTableContainer').style.display = 'block';
            document.getElementById('schoolsEmpty').style.display = 'none';
        }

        // Show add school modal
        window.showAddSchoolModal = function() {
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10000;';

            const modalContent = document.createElement('div');
            modalContent.style.cssText = 'background: white; padding: 30px; max-width: 500px; width: 90%; border-radius: 15px;';

            modalContent.innerHTML = `
                <h3 style="color: #176F9A; margin-bottom: 15px; font-size: 20px;">‚ûï Add New School</h3>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 700; color: #176F9A;">School Name:</label>
                    <input type="text" id="newSchoolName" placeholder="Enter school name..." style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px;">
                    <p style="margin-top: 8px; font-size: 12px; color: #666;">Example: Lincoln Elementary School</p>
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 700; color: #176F9A;">Instagram Handles (optional):</label>
                    <input type="text" id="newSchoolHandles" placeholder="@handle1, @handle2, @handle3" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px;">
                    <p style="margin-top: 8px; font-size: 12px; color: #666;">Separate multiple handles with commas</p>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button id="confirmAddBtn" class="btn btn-success">ADD SCHOOL</button>
                    <button id="cancelAddBtn" class="btn btn-secondary">CANCEL</button>
                </div>
            `;

            modal.appendChild(modalContent);
            document.body.appendChild(modal);

            // Handle cancel
            document.getElementById('cancelAddBtn').onclick = () => {
                document.body.removeChild(modal);
            };

            // Handle confirm
            document.getElementById('confirmAddBtn').onclick = async () => {
                const schoolName = document.getElementById('newSchoolName').value.trim();
                const handlesInput = document.getElementById('newSchoolHandles').value.trim();

                if (!schoolName) {
                    alert('Please enter a school name');
                    return;
                }

                // Parse Instagram handles
                const handles = handlesInput
                    ? handlesInput.split(',').map(h => h.trim().replace('@', '')).filter(h => h)
                    : [];

                try {
                    document.getElementById('confirmAddBtn').textContent = 'ADDING...';
                    document.getElementById('confirmAddBtn').disabled = true;

                    const { error } = await supabase
                        .from('teacher_feast_schools')
                        .insert([{
                            school_name: schoolName,
                            instagram_handles: handles,
                            total_votes: 0,
                            instagram_votes: 0,
                            form_votes: 0
                        }]);

                    if (error) throw error;

                    document.body.removeChild(modal);
                    showSuccessMessage(`‚úÖ School "${schoolName}" added successfully`);
                    await loadSchools();
                    await loadSchoolsFilter(); // Refresh filter dropdowns

                } catch (error) {
                    console.error('Add school error:', error);
                    alert('Error adding school: ' + error.message);
                    document.getElementById('confirmAddBtn').textContent = 'ADD SCHOOL';
                    document.getElementById('confirmAddBtn').disabled = false;
                }
            };
        };

        // Show edit school modal
        window.showEditSchoolModal = function(school) {
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10000;';

            const modalContent = document.createElement('div');
            modalContent.style.cssText = 'background: white; padding: 30px; max-width: 500px; width: 90%; border-radius: 15px;';

            const currentHandles = (school.instagram_handles || []).map(h => '@' + h).join(', ');

            modalContent.innerHTML = `
                <h3 style="color: #176F9A; margin-bottom: 15px; font-size: 20px;">‚úèÔ∏è Edit School</h3>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 700; color: #176F9A;">School Name:</label>
                    <input type="text" id="editSchoolName" value="${school.school_name}" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px;">
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 700; color: #176F9A;">Instagram Handles:</label>
                    <input type="text" id="editSchoolHandles" value="${currentHandles}" placeholder="@handle1, @handle2, @handle3" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px;">
                    <p style="margin-top: 8px; font-size: 12px; color: #666;">Separate multiple handles with commas</p>
                </div>
                <div style="padding: 15px; background: #fef3c7; border-radius: 8px; margin-bottom: 20px;">
                    <p style="font-size: 12px; color: #92400e; margin-bottom: 5px;"><strong>‚ö†Ô∏è Warning:</strong></p>
                    <p style="font-size: 12px; color: #92400e;">Changing the school name will update ALL existing votes for this school.</p>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button id="confirmEditBtn" class="btn btn-warning">SAVE CHANGES</button>
                    <button id="cancelEditBtn" class="btn btn-secondary">CANCEL</button>
                </div>
            `;

            modal.appendChild(modalContent);
            document.body.appendChild(modal);

            // Handle cancel
            document.getElementById('cancelEditBtn').onclick = () => {
                document.body.removeChild(modal);
            };

            // Handle confirm
            document.getElementById('confirmEditBtn').onclick = async () => {
                const newSchoolName = document.getElementById('editSchoolName').value.trim();
                const handlesInput = document.getElementById('editSchoolHandles').value.trim();

                if (!newSchoolName) {
                    alert('Please enter a school name');
                    return;
                }

                // Parse Instagram handles
                const handles = handlesInput
                    ? handlesInput.split(',').map(h => h.trim().replace('@', '')).filter(h => h)
                    : [];

                try {
                    document.getElementById('confirmEditBtn').textContent = 'SAVING...';
                    document.getElementById('confirmEditBtn').disabled = true;

                    // Update school record
                    const { error: schoolError } = await supabase
                        .from('teacher_feast_schools')
                        .update({
                            school_name: newSchoolName,
                            instagram_handles: handles
                        })
                        .eq('school_name', school.school_name);

                    if (schoolError) throw schoolError;

                    // If school name changed, update all votes
                    if (newSchoolName !== school.school_name) {
                        const { error: votesError } = await supabase
                            .from('teacher_feast_votes')
                            .update({ school_name: newSchoolName })
                            .eq('school_name', school.school_name);

                        if (votesError) throw votesError;

                        // Update newsletter records
                        const { error: newsletterError } = await supabase
                            .from('teacher_feast_newsletter')
                            .update({ school_name: newSchoolName })
                            .eq('school_name', school.school_name);

                        if (newsletterError) {
                            console.warn('Newsletter update warning:', newsletterError);
                        }
                    }

                    document.body.removeChild(modal);
                    showSuccessMessage(`‚úÖ School updated successfully`);
                    await loadSchools();
                    await loadSchoolsFilter(); // Refresh filter dropdowns
                    await loadVotes(); // Refresh votes if name changed

                } catch (error) {
                    console.error('Edit school error:', error);
                    alert('Error updating school: ' + error.message);
                    document.getElementById('confirmEditBtn').textContent = 'SAVE CHANGES';
                    document.getElementById('confirmEditBtn').disabled = false;
                }
            };
        };

        // Delete school
        window.deleteSchool = async function(school) {
            // Check if school has votes
            const { data: votes } = await supabase
                .from('teacher_feast_votes')
                .select('id')
                .eq('school_name', school.school_name);

            const voteCount = votes ? votes.length : 0;

            let confirmMessage = `Delete "${school.school_name}"?`;
            if (voteCount > 0) {
                confirmMessage = `‚ö†Ô∏è WARNING: "${school.school_name}" has ${voteCount} vote(s)!\n\nDeleting this school will also DELETE ALL ${voteCount} VOTES.\n\nThis action CANNOT be undone.\n\nAre you absolutely sure you want to delete this school and all its votes?`;
            } else {
                confirmMessage = `Delete "${school.school_name}"?\n\nThis school has no votes yet.`;
            }

            if (!confirm(confirmMessage)) {
                return;
            }

            // Double confirmation for schools with votes
            if (voteCount > 0) {
                if (!confirm(`FINAL CONFIRMATION:\n\nYou are about to permanently delete ${voteCount} vote(s).\n\nType the school name to confirm deletion.`)) {
                    return;
                }
            }

            try {
                // Delete all votes for this school first
                if (voteCount > 0) {
                    const { error: votesError } = await supabase
                        .from('teacher_feast_votes')
                        .delete()
                        .eq('school_name', school.school_name);

                    if (votesError) throw votesError;
                }

                // Delete school
                const { error: schoolError } = await supabase
                    .from('teacher_feast_schools')
                    .delete()
                    .eq('school_name', school.school_name);

                if (schoolError) throw schoolError;

                showSuccessMessage(`‚úÖ School "${school.school_name}" deleted${voteCount > 0 ? ` (${voteCount} votes removed)` : ''}`);
                await loadSchools();
                await loadSchoolsFilter(); // Refresh filter dropdowns
                await loadVotes(); // Refresh votes list

            } catch (error) {
                console.error('Delete school error:', error);
                alert('Error deleting school: ' + error.message);
            }
        };

        // ========================================
        // SCHOOL MERGE FUNCTIONS
        // ========================================

        // Toggle school selection
        window.toggleSchoolSelection = function(schoolName) {
            if (selectedSchools.has(schoolName)) {
                selectedSchools.delete(schoolName);
            } else {
                selectedSchools.add(schoolName);
            }
            updateBulkSchoolActionsBar();
        };

        // Toggle select all schools
        window.toggleSelectAllSchools = function() {
            const selectAllCheckbox = document.getElementById('selectAllSchools');
            if (selectAllCheckbox.checked) {
                // Select all schools
                allSchools.forEach(school => selectedSchools.add(school.school_name));
            } else {
                // Deselect all
                selectedSchools.clear();
            }
            updateBulkSchoolActionsBar();
            displaySchools(allSchools); // Refresh to update checkboxes
        };

        // Clear school selection
        window.clearSchoolSelection = function() {
            selectedSchools.clear();
            document.getElementById('selectAllSchools').checked = false;
            updateBulkSchoolActionsBar();
            displaySchools(allSchools);
        };

        // Update bulk school actions bar
        function updateBulkSchoolActionsBar() {
            const bulkActions = document.getElementById('bulkSchoolActions');
            const selectedCount = document.getElementById('selectedSchoolCount');

            selectedCount.textContent = selectedSchools.size;

            if (selectedSchools.size > 0) {
                bulkActions.classList.add('active');
            } else {
                bulkActions.classList.remove('active');
            }
        }

        // Merge schools
        window.mergeSchools = async function() {
            if (selectedSchools.size < 2) {
                alert('Please select at least 2 schools to merge');
                return;
            }

            // Get full school objects for selected schools
            const selectedSchoolsList = allSchools.filter(s => selectedSchools.has(s.school_name));

            // Create modal for selecting target school
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10000; overflow-y: auto; padding: 20px;';

            const modalContent = document.createElement('div');
            modalContent.style.cssText = 'background: white; padding: 30px; max-width: 600px; width: 100%; border-radius: 15px; max-height: 90vh; overflow-y: auto;';

            // Calculate totals for each school
            const schoolOptions = selectedSchoolsList.map(school => {
                const totalPoints = (school.form_votes * 2) + (school.instagram_votes * 1);
                return `
                    <div style="margin-bottom: 15px; padding: 15px; border: 2px solid #ddd; border-radius: 8px; cursor: pointer; transition: all 0.2s;"
                         onclick="document.getElementById('targetSchool_${school.school_name.replace(/[^a-zA-Z0-9]/g, '_')}').checked = true"
                         onmouseover="this.style.background='#f0f9ff'; this.style.borderColor='#46B0E4';"
                         onmouseout="this.style.background='white'; this.style.borderColor='#ddd';">
                        <label style="display: flex; align-items: center; cursor: pointer; margin: 0;">
                            <input type="radio" name="targetSchool" id="targetSchool_${school.school_name.replace(/[^a-zA-Z0-9]/g, '_')}" value="${school.school_name}" style="margin-right: 12px; width: 20px; height: 20px;">
                            <div style="flex: 1;">
                                <div style="font-weight: 700; font-size: 16px; color: #176F9A; margin-bottom: 5px;">${school.school_name}</div>
                                <div style="font-size: 13px; color: #666;">
                                    <strong>${school.total_votes || 0}</strong> votes ‚Ä¢
                                    <strong>${totalPoints}</strong> points ‚Ä¢
                                    <strong>${school.form_votes || 0}</strong> form ‚Ä¢
                                    <strong>${school.instagram_votes || 0}</strong> instagram
                                </div>
                            </div>
                        </label>
                    </div>
                `;
            }).join('');

            // Calculate combined totals
            const combinedVotes = selectedSchoolsList.reduce((sum, s) => sum + (s.total_votes || 0), 0);
            const combinedPoints = selectedSchoolsList.reduce((sum, s) => sum + ((s.form_votes * 2) + (s.instagram_votes * 1)), 0);
            const combinedForm = selectedSchoolsList.reduce((sum, s) => sum + (s.form_votes || 0), 0);
            const combinedInstagram = selectedSchoolsList.reduce((sum, s) => sum + (s.instagram_votes || 0), 0);

            modalContent.innerHTML = `
                <h3 style="color: #176F9A; margin-bottom: 15px; font-size: 22px;">üîÄ Merge ${selectedSchools.size} Schools</h3>

                <div style="padding: 15px; background: #fef3c7; border: 2px solid #f59e0b; border-radius: 10px; margin-bottom: 20px;">
                    <p style="font-size: 13px; color: #92400e; margin-bottom: 8px;"><strong>‚ö†Ô∏è Important:</strong></p>
                    <p style="font-size: 13px; color: #92400e; margin-bottom: 8px;">
                        All votes from the schools you DON'T select will be transferred to the school you DO select.
                    </p>
                    <p style="font-size: 13px; color: #92400e;">
                        The other schools will be permanently deleted.
                    </p>
                </div>

                <div style="padding: 15px; background: #d1fae5; border: 2px solid #059669; border-radius: 10px; margin-bottom: 20px;">
                    <p style="font-size: 13px; color: #065f46; margin-bottom: 5px;"><strong>üìä Combined Totals After Merge:</strong></p>
                    <p style="font-size: 13px; color: #065f46;">
                        <strong>${combinedVotes}</strong> votes ‚Ä¢
                        <strong>${combinedPoints}</strong> points ‚Ä¢
                        <strong>${combinedForm}</strong> form ‚Ä¢
                        <strong>${combinedInstagram}</strong> instagram
                    </p>
                </div>

                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 12px; font-weight: 700; color: #176F9A; font-size: 14px;">
                        Select the school to keep (all others will merge into this one):
                    </label>
                    <div style="max-height: 400px; overflow-y: auto;">
                        ${schoolOptions}
                    </div>
                </div>

                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button id="confirmMergeBtn" class="btn btn-warning">MERGE SCHOOLS</button>
                    <button id="cancelMergeBtn" class="btn btn-secondary">CANCEL</button>
                </div>
            `;

            modal.appendChild(modalContent);
            document.body.appendChild(modal);

            // Handle cancel
            document.getElementById('cancelMergeBtn').onclick = () => {
                document.body.removeChild(modal);
            };

            // Handle confirm
            document.getElementById('confirmMergeBtn').onclick = async () => {
                const targetSchoolRadio = document.querySelector('input[name="targetSchool"]:checked');

                if (!targetSchoolRadio) {
                    alert('Please select which school to keep');
                    return;
                }

                const targetSchoolName = targetSchoolRadio.value;
                const schoolsToMerge = Array.from(selectedSchools).filter(s => s !== targetSchoolName);

                if (!confirm(`FINAL CONFIRMATION:\n\nMerge ${schoolsToMerge.length} school(s) into "${targetSchoolName}"?\n\nThe following schools will be deleted:\n${schoolsToMerge.map(s => '‚Ä¢ ' + s).join('\n')}\n\nThis action CANNOT be undone.`)) {
                    return;
                }

                try {
                    document.getElementById('confirmMergeBtn').textContent = 'MERGING...';
                    document.getElementById('confirmMergeBtn').disabled = true;

                    // Transfer all votes from schools to merge
                    for (const schoolName of schoolsToMerge) {
                        // Update votes
                        await supabase
                            .from('teacher_feast_votes')
                            .update({ school_name: targetSchoolName })
                            .eq('school_name', schoolName);

                        // Update newsletter
                        await supabase
                            .from('teacher_feast_newsletter')
                            .update({ school_name: targetSchoolName })
                            .eq('school_name', schoolName);
                    }

                    // Get final vote counts for target school
                    const { data: votes } = await supabase
                        .from('teacher_feast_votes')
                        .select('vote_type, points')
                        .eq('school_name', targetSchoolName);

                    // Calculate new totals
                    const totalVotes = votes.length;
                    const formVotes = votes.filter(v => v.vote_type === 'form').length;
                    const instagramVotes = votes.filter(v => v.vote_type === 'instagram').length;
                    const totalPoints = votes.reduce((sum, v) => sum + v.points, 0);

                    // Update target school with new totals
                    await supabase
                        .from('teacher_feast_schools')
                        .update({
                            total_votes: totalPoints,
                            form_votes: formVotes,
                            instagram_votes: instagramVotes
                        })
                        .eq('school_name', targetSchoolName);

                    // Merge Instagram handles (combine unique handles)
                    const targetSchool = selectedSchoolsList.find(s => s.school_name === targetSchoolName);
                    const allHandles = new Set(targetSchool.instagram_handles || []);

                    for (const schoolName of schoolsToMerge) {
                        const school = selectedSchoolsList.find(s => s.school_name === schoolName);
                        if (school.instagram_handles) {
                            school.instagram_handles.forEach(handle => allHandles.add(handle));
                        }
                    }

                    // Update target school with merged handles
                    await supabase
                        .from('teacher_feast_schools')
                        .update({ instagram_handles: Array.from(allHandles) })
                        .eq('school_name', targetSchoolName);

                    // Delete merged schools
                    for (const schoolName of schoolsToMerge) {
                        await supabase
                            .from('teacher_feast_schools')
                            .delete()
                            .eq('school_name', schoolName);
                    }

                    document.body.removeChild(modal);
                    showSuccessMessage(`‚úÖ Successfully merged ${schoolsToMerge.length} school(s) into "${targetSchoolName}"`);
                    clearSchoolSelection();
                    await loadSchools();
                    await loadSchoolsFilter(); // Refresh filter dropdowns
                    await loadVotes(); // Refresh votes list

                } catch (error) {
                    console.error('Merge schools error:', error);
                    alert('Error merging schools: ' + error.message);
                    document.getElementById('confirmMergeBtn').textContent = 'MERGE SCHOOLS';
                    document.getElementById('confirmMergeBtn').disabled = false;
                }
            };
        };

        // ========================================
        // DUPLICATE DETECTION
        // ========================================

        // Scan for duplicates
        window.scanForDuplicates = async function() {
            // Show loading indicator
            const loadingDiv = document.createElement('div');
            loadingDiv.style.cssText = 'position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #fef3c7; border: 2px solid #f59e0b; color: #92400e; padding: 15px 30px; border-radius: 10px; z-index: 10001; font-weight: 600;';
            loadingDiv.textContent = 'üîç Scanning for duplicates...';
            document.body.appendChild(loadingDiv);

            try {
                // Get all votes
                const { data: votes, error } = await supabase
                    .from('teacher_feast_votes')
                    .select('*')
                    .order('voted_at', { ascending: false });

                if (error) throw error;

                // Group duplicates
                const duplicateGroups = [];
                const processedVotes = new Set();

                for (let i = 0; i < votes.length; i++) {
                    if (processedVotes.has(votes[i].id)) continue;

                    const currentVote = votes[i];
                    const similarVotes = [currentVote];
                    processedVotes.add(currentVote.id);

                    // Find similar votes
                    for (let j = i + 1; j < votes.length; j++) {
                        if (processedVotes.has(votes[j].id)) continue;

                        const compareVote = votes[j];
                        const matchReasons = [];

                        // Exact email match
                        if (currentVote.email && compareVote.email &&
                            currentVote.email.toLowerCase() === compareVote.email.toLowerCase()) {
                            matchReasons.push('email');
                        }

                        // Exact phone match
                        if (currentVote.phone && compareVote.phone) {
                            const phone1 = currentVote.phone.replace(/\D/g, '');
                            const phone2 = compareVote.phone.replace(/\D/g, '');
                            if (phone1 === phone2 && phone1.length >= 10) {
                                matchReasons.push('phone');
                            }
                        }

                        // Similar name (case-insensitive exact match)
                        if (currentVote.full_name && compareVote.full_name) {
                            const name1 = currentVote.full_name.toLowerCase().trim();
                            const name2 = compareVote.full_name.toLowerCase().trim();
                            if (name1 === name2) {
                                matchReasons.push('name');
                            }
                        }

                        // If any match found, add to similar votes
                        if (matchReasons.length > 0) {
                            similarVotes.push({
                                ...compareVote,
                                matchReasons
                            });
                            processedVotes.add(compareVote.id);
                        }
                    }

                    // If more than one vote in group, it's a duplicate
                    if (similarVotes.length > 1) {
                        duplicateGroups.push(similarVotes);
                    }
                }

                // Remove loading indicator
                document.body.removeChild(loadingDiv);

                // Show results
                if (duplicateGroups.length === 0) {
                    showSuccessMessage('‚úÖ No duplicates found!');
                    return;
                }

                // Show duplicates modal
                showDuplicatesModal(duplicateGroups);

            } catch (error) {
                console.error('Duplicate scan error:', error);
                document.body.removeChild(loadingDiv);
                alert('Error scanning for duplicates: ' + error.message);
            }
        };

        // Show duplicates modal
        function showDuplicatesModal(duplicateGroups) {
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10000; overflow-y: auto; padding: 20px;';

            const modalContent = document.createElement('div');
            modalContent.style.cssText = 'background: white; padding: 30px; max-width: 1200px; width: 100%; border-radius: 15px; max-height: 90vh; overflow-y: auto;';

            // Header
            const header = document.createElement('div');
            header.style.cssText = 'margin-bottom: 20px;';
            header.innerHTML = `
                <h3 style="color: #176F9A; font-size: 22px; margin-bottom: 10px;">üîç Found ${duplicateGroups.length} Duplicate Group(s)</h3>
                <p style="color: #666; font-size: 14px;">Review each group and select which votes to KEEP (you can select multiple). All unselected votes will be archived.</p>
            `;
            modalContent.appendChild(header);

            // Track selections (groupIndex -> Set of voteIds to keep)
            const selections = {};
            duplicateGroups.forEach((group, i) => {
                selections[i] = new Set();
            });

            // Create duplicate groups
            duplicateGroups.forEach((group, groupIndex) => {
                const groupDiv = document.createElement('div');
                groupDiv.className = 'duplicate-group';

                // Calculate total points in group
                const totalPoints = group.reduce((sum, v) => sum + v.points, 0);

                // Get match reasons (from second vote since first is original)
                const matchReasons = group[1].matchReasons || [];
                const matchBadges = matchReasons.map(reason => {
                    const colors = {
                        email: { bg: '#fee2e2', text: '#991b1b' },
                        phone: { bg: '#fef3c7', text: '#92400e' },
                        name: { bg: '#dbeafe', text: '#1e40af' }
                    };
                    const color = colors[reason] || { bg: '#f3f4f6', text: '#4b5563' };
                    return `<span style="display: inline-block; padding: 3px 8px; background: ${color.bg}; color: ${color.text}; border-radius: 4px; font-size: 11px; font-weight: 600; text-transform: uppercase; margin-right: 5px;">${reason}</span>`;
                }).join('');

                // Group header
                const groupHeader = document.createElement('div');
                groupHeader.className = 'duplicate-group-header';
                groupHeader.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>Duplicate Group #${groupIndex + 1}</strong> - ${group.length} votes (${totalPoints} total points)
                        </div>
                        <div>
                            Matched by: ${matchBadges}
                        </div>
                    </div>
                `;
                groupDiv.appendChild(groupHeader);

                // Create vote cards
                group.forEach((vote, voteIndex) => {
                    const voteCard = document.createElement('div');
                    voteCard.className = 'duplicate-vote';
                    voteCard.id = `vote_${groupIndex}_${voteIndex}`;

                    const votedDate = new Date(vote.voted_at);
                    const formattedDate = votedDate.toLocaleDateString('en-US', {
                        month: 'short',
                        day: 'numeric',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });

                    const badgeClass = vote.vote_type === 'form' ? 'badge-form' : 'badge-instagram';
                    const badgeText = vote.vote_type === 'form' ? 'FORM' : 'INSTAGRAM';

                    voteCard.innerHTML = `
                        <div class="duplicate-vote-info">
                            <input type="checkbox" class="keep-checkbox" data-vote-id="${vote.id}" data-group-index="${groupIndex}" style="width: 20px; height: 20px; cursor: pointer; margin-right: 15px;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                    <span class="badge ${badgeClass}">${badgeText}</span>
                                    <strong style="font-size: 14px;">${vote.school_name}</strong>
                                    <span style="font-weight: 600; color: #176F9A;">${vote.points} pts</span>
                                    ${vote.is_archived ? '<span class="archived-badge">ARCHIVED</span>' : ''}
                                </div>
                                <div style="font-size: 13px; color: #666; margin-bottom: 5px;">
                                    <strong>Name:</strong> ${vote.full_name || '-'} &nbsp;|&nbsp;
                                    <strong>Email:</strong> ${vote.email || '-'} &nbsp;|&nbsp;
                                    <strong>Phone:</strong> ${vote.phone || '-'}
                                </div>
                                <div style="font-size: 12px; color: #999;">
                                    <strong>Date:</strong> ${formattedDate} &nbsp;|&nbsp;
                                    <strong>IP:</strong> ${vote.ip_address || '-'}
                                    ${vote.instagram_username ? ` &nbsp;|&nbsp; <strong>IG:</strong> ${vote.instagram_username}` : ''}
                                </div>
                            </div>
                        </div>
                    `;

                    // Handle selection
                    const checkbox = voteCard.querySelector('input[type="checkbox"]');
                    checkbox.addEventListener('change', () => {
                        // Toggle selection
                        if (checkbox.checked) {
                            selections[groupIndex].add(vote.id);
                            voteCard.classList.add('selected');
                        } else {
                            selections[groupIndex].delete(vote.id);
                            voteCard.classList.remove('selected');
                        }
                    });

                    // Click card to toggle selection
                    voteCard.addEventListener('click', (e) => {
                        if (e.target.tagName !== 'INPUT') {
                            checkbox.checked = !checkbox.checked;
                            checkbox.dispatchEvent(new Event('change'));
                        }
                    });

                    groupDiv.appendChild(voteCard);
                });

                modalContent.appendChild(groupDiv);
            });

            // Action buttons
            const actionsDiv = document.createElement('div');
            actionsDiv.style.cssText = 'display: flex; gap: 10px; justify-content: flex-end; margin-top: 30px; padding-top: 20px; border-top: 3px solid #e0f2fe;';

            const archiveDuplicatesBtn = document.createElement('button');
            archiveDuplicatesBtn.className = 'btn btn-warning';
            archiveDuplicatesBtn.textContent = 'üì¶ Archive Duplicates';
            archiveDuplicatesBtn.onclick = async () => {
                // Validate all groups have at least one selection
                const missingSelections = [];
                for (let i = 0; i < duplicateGroups.length; i++) {
                    if (selections[i].size === 0) {
                        missingSelections.push(i + 1);
                    }
                }

                if (missingSelections.length > 0) {
                    alert(`Please select at least one vote to keep in group(s): ${missingSelections.join(', ')}`);
                    return;
                }

                // Calculate total votes to archive
                let totalToArchive = 0;
                for (let i = 0; i < duplicateGroups.length; i++) {
                    const group = duplicateGroups[i];
                    const keepCount = selections[i].size;
                    const archiveCount = group.filter(v => !v.is_archived).length - keepCount;
                    totalToArchive += Math.max(0, archiveCount);
                }

                if (totalToArchive === 0) {
                    alert('No votes to archive. All selected votes are already marked to keep.');
                    return;
                }

                // Confirm action
                if (!confirm(`Archive ${totalToArchive} duplicate vote(s)?\n\nThis will remove their points from the leaderboard but keep the records.`)) {
                    return;
                }

                try {
                    archiveDuplicatesBtn.textContent = 'ARCHIVING...';
                    archiveDuplicatesBtn.disabled = true;

                    let archivedCount = 0;

                    // Process each group
                    for (let i = 0; i < duplicateGroups.length; i++) {
                        const group = duplicateGroups[i];
                        const keepVoteIds = selections[i];

                        // Archive all votes NOT in the keep set
                        for (const vote of group) {
                            if (!keepVoteIds.has(vote.id) && !vote.is_archived) {
                                // Archive vote
                                await supabase
                                    .from('teacher_feast_votes')
                                    .update({ is_archived: true })
                                    .eq('id', vote.id);

                                // Decrement school points
                                await supabase.rpc('increment_school_votes', {
                                    school_name_param: vote.school_name,
                                    points_param: -vote.points
                                });

                                archivedCount++;
                            }
                        }
                    }

                    document.body.removeChild(modal);
                    showSuccessMessage(`‚úÖ Archived ${archivedCount} duplicate vote(s)`);
                    await loadVotes();

                } catch (error) {
                    console.error('Archive duplicates error:', error);
                    alert('Error archiving duplicates: ' + error.message);
                    archiveDuplicatesBtn.textContent = 'üì¶ Archive Duplicates';
                    archiveDuplicatesBtn.disabled = false;
                }
            };

            const closeBtn = document.createElement('button');
            closeBtn.className = 'btn btn-secondary';
            closeBtn.textContent = 'Close';
            closeBtn.onclick = () => {
                document.body.removeChild(modal);
            };

            actionsDiv.appendChild(archiveDuplicatesBtn);
            actionsDiv.appendChild(closeBtn);
            modalContent.appendChild(actionsDiv);

            modal.appendChild(modalContent);
            document.body.appendChild(modal);
        }

        // Load votes on page load
        loadVotes();
        loadSchools(); // Also load schools
    </script>
</body>
</html>
