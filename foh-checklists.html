<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, viewport-fit=cover">
  <title>FOH Checklists - Jayna Gyro</title>

  <link rel="apple-touch-icon" href="https://static.spotapps.co/website_images/ab_websites/229800_website_v1/logo.png">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#00A8E1">

  <style>
    /* Jayna Brand Design - Sky Blue & Grayscale */
    :root {
      --primary-blue: #00A8E1;
      --secondary-blue: #0094D6;
      --light-blue: #E3F4FC;
      --accent-blue: #0081C6;
      --gray-900: #212121;
      --gray-700: #424242;
      --gray-600: #616161;
      --gray-500: #757575;
      --gray-400: #BDBDBD;
      --gray-300: #E0E0E0;
      --gray-100: #F5F5F5;
      --success: #00C853;
      --warning: #FFB300;
      --error: #D32F2F;
      --white: #FFFFFF;
      --blue-bg: #dbeafe;
      --blue-text: #1e40af;
      --success-bg: #d1fae5;
      --success-text: #065f46;
      --success-border: #059669;
      --warning-bg: #fef3c7;
      --warning-text: #92400e;
      --warning-border: #f59e0b;
      --error-bg: #fee2e2;
      --error-text: #991b1b;
      --error-border: #dc2626;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body {
      font-family: 'Aptos', 'Segoe UI Variable', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      background: var(--white);
      min-height: 100vh;
      padding: 0;
      overflow-x: hidden;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
      background: var(--white);
      border-radius: 0;
      overflow: visible;
      box-shadow: none;
      min-height: auto;
      max-height: none;
    }
    .header {
      background: var(--white);
      color: var(--gray-900);
      text-align: center;
      padding: 12px;
      border-radius: 0;
      border-bottom: 1px solid var(--gray-300);
    }
    .header h1 { font-size: 18px; font-weight: 700; margin-bottom: 2px; letter-spacing: 1.5px; text-transform: uppercase; }
    .header p { opacity: 0.7; font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }
    .content {
      padding: 12px;
      max-height: none;
      overflow: visible;
    }
    .main-menu { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px; }
    .menu-btn {
      padding: 16px 12px;
      border: 2px solid var(--gray-300);
      border-radius: 0;
      background: var(--gray-100);
      font-size: 11px;
      font-weight: 700;
      color: var(--gray-900);
      cursor: pointer;
      transition: all 0.15s ease;
      text-align: center;
      min-height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      text-transform: uppercase;
      letter-spacing: 1.2px;
      text-decoration: none;
    }
    .menu-btn:hover {
      background: var(--gray-300);
      color: var(--gray-900);
      border-color: var(--gray-400);
      transform: translateY(-1px);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
    }
    .menu-btn.primary {
      background: var(--white);
      color: var(--gray-700);
      border-color: var(--gray-300);
    }
    .menu-btn.primary:hover {
      background: var(--gray-100);
      border-color: var(--gray-400);
    }
    .form-section {
      display: none;
      min-height: auto;
      overflow: visible;
    }
    .form-section.active {
      display: block;
      position: relative;
      z-index: 1;
    }
    .submit-btn {
      padding: 14px 20px;
      background: var(--gray-100);
      color: var(--gray-900);
      border: none;
      border-radius: 0;
      font-size: 12px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.15s ease;
      min-height: 48px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
      text-transform: uppercase;
      letter-spacing: 1.2px;
      border: 2px solid var(--gray-300);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      white-space: nowrap;
    }
    .submit-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.12);
      background: var(--gray-300);
    }
    .message {
      padding: 18px;
      border-radius: 0;
      margin: 20px 0;
      text-align: center;
      font-size: 15px;
      font-weight: 500;
      letter-spacing: 0.3px;
    }
    .message.success {
      background: #E8F5EC;
      color: #2D5F3F;
      border: 2px solid var(--success);
    }
    .message.error {
      background: #F8E6E7;
      color: #6B3638;
      border: 2px solid var(--error);
    }
    .message.info {
      background: var(--light-blue);
      color: var(--primary-blue);
      border: 2px solid var(--secondary-blue);
    }

    /* Loading Overlay */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      z-index: 9999;
      display: flex;
      justify-content: center;
      align-items: center;
      transition: opacity 0.3s ease;
    }
    .loading-overlay.hidden {
      display: none;
    }
    .loading-content {
      text-align: center;
      padding: 40px;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 0;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    .loading-spinner-elegant {
      width: 60px;
      height: 60px;
      border: 4px solid rgba(102, 126, 234, 0.1);
      border-top: 4px solid #667eea;
      border-radius: 50%;
      animation: spin-elegant 1.2s linear infinite;
      margin: 0 auto 20px;
    }
    @keyframes spin-elegant {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .loading-content h3 {
      margin: 0 0 10px 0;
      font-size: 24px;
      color: #333;
      font-weight: 600;
    }
    .loading-content p {
      margin: 0;
      font-size: 16px;
      color: #666;
      opacity: 0.8;
    }

    /* Tabs */
    .tabs {
      display: flex;
      border-bottom: 2px solid var(--gray-300);
      overflow-x: auto;
      overflow-y: hidden;
      -webkit-overflow-scrolling: touch;
      gap: 4px;
    }
    .tab-link {
      flex: 0 0 auto;
      padding: 12px 10px;
      min-width: 80px;
      background: var(--gray-100);
      color: var(--gray-700);
      border: none;
      cursor: pointer;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      transition: all 0.15s ease;
    }
    .tab-link.active,
    .tab-link:hover {
      background: var(--gray-700);
      color: var(--white);
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="foh-checklists-data.js"></script>
</head>
<body>
  <!-- Loading Overlay -->
  <div id="loadingOverlay" style="
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    z-index: 9999;
    justify-content: center;
    align-items: center;
  ">
    <div style="
      text-align: center;
      color: white;
    ">
      <div class="spinner" style="
        border: 8px solid #f3f3f3;
        border-top: 8px solid #4CAF50;
        border-radius: 50%;
        width: 60px;
        height: 60px;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
      "></div>
      <h3 id="loadingTitle" style="
        font-size: 18px;
        font-weight: bold;
        margin-bottom: 10px;
      ">Loading...</h3>
      <p id="loadingMessage" style="
        font-size: 14px;
        color: #ccc;
      ">Please wait</p>
    </div>
  </div>

  <style>
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>

  <div class="container">
    <div class="header">
      <img src="jayna-logo.png" alt="Jayna Gyro Logo" style="width: 80px; height: 80px; margin-bottom: 12px;">
      <h1 style="margin-bottom: 4px;">JAYNA GYRO</h1>
      <h2 style="font-size: 18px; font-weight: 600; margin-bottom: 4px; letter-spacing: 1.5px;">INTERNAL FUNCTION APP</h2>
      <p style="font-size: 11px; font-weight: 500; letter-spacing: 1px; margin-bottom: 8px;">FOR AUTHORIZED USE ONLY</p>
      <p style="opacity: 0.7;">App created by Demetri Gregorakis</p>
    </div>

    <div class="content">
      <div id="messageArea"></div>

      <!-- Main Menu -->
      <div id="mainMenu" class="main-menu">
        <a href="index.html" class="menu-btn primary">AM Count</a>
        <a href="index.html" class="menu-btn primary">PM Close</a>
        <a href="index.html" class="menu-btn" style="background: var(--gray-700) !important; color: white !important; border-color: var(--gray-700) !important;">Orders & Prep</a>
      </div>

      <!-- FOH Checklist System Section -->
      <div id="fohSystemForm" class="form-section active">
        <h2 style="margin-bottom: 20px; color: var(--gray-900);">FOH Checklists</h2>

        <!-- Tab Navigation -->
        <div style="position: sticky; top: 0; z-index: 100; background: var(--white); margin-bottom: 20px; padding-bottom: 10px;">
          <div class="tabs" style="display: flex; border-bottom: 2px solid var(--gray-300); overflow-x: auto; overflow-y: hidden; -webkit-overflow-scrolling: touch; gap: 4px;">
            <button class="tab-link active" onclick="openFOHTab(event, 'fohWorkflow')" style="
              flex: 0 0 auto;
              padding: 12px 10px;
              min-width: 80px;
              background: var(--gray-700);
              color: var(--white);
              border: none;
              cursor: pointer;
              font-size: 11px;
              font-weight: 700;
              text-transform: uppercase;
              letter-spacing: 0.8px;
              transition: all 0.15s ease;
            ">CHECKLISTS</button>
            <button class="tab-link" onclick="openFOHManagerEdit(event)" style="
              flex: 0 0 auto;
              padding: 12px 10px;
              min-width: 80px;
              background: var(--gray-100);
              color: var(--gray-700);
              border: none;
              cursor: pointer;
              font-size: 11px;
              font-weight: 700;
              text-transform: uppercase;
              letter-spacing: 0.8px;
              transition: all 0.15s ease;
            ">EDIT</button>
            <button class="tab-link" onclick="openFOHManagerWatchdog(event)" style="
              flex: 0 0 auto;
              padding: 12px 10px;
              min-width: 80px;
              background: var(--gray-100);
              color: var(--gray-700);
              border: none;
              cursor: pointer;
              font-size: 11px;
              font-weight: 700;
              text-transform: uppercase;
              letter-spacing: 0.8px;
              transition: all 0.15s ease;
            ">WATCHDOG</button>
          </div>
        </div>

        <!-- Tab Content: Workflow Selection / Checklist -->
        <div id="fohWorkflow" class="tab-content" style="display: block;">
          <div id="fohWorkflowContent">
            <p style="text-align: center; padding: 20px;">Loading...</p>
          </div>
        </div>

        <!-- Tab Content: Manager Edit -->
        <div id="fohEdit" class="tab-content" style="display: none;">
          <div id="fohEditContent">
            <p style="text-align: center; padding: 20px;">Loading editor...</p>
          </div>
        </div>

        <!-- Tab Content: Manager Watchdog -->
        <div id="fohWatchdog" class="tab-content" style="display: none;">
          <div id="fohWatchdogContent">
            <p style="text-align: center; padding: 20px;">Loading historical data...</p>
          </div>
        </div>

        <a href="index.html" class="submit-btn" style="margin-top: 20px; text-decoration: none;">Back to Menu</a>
      </div>
    </div>
  </div>

<script>
  // Configuration
  const SUPABASE_URL = 'https://gaawtbqpnnbbnsyswqwv.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdhYXd0YnFwbm5iYm5zeXN3cXd2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1MDE1NTAsImV4cCI6MjA3MjA3NzU1MH0.F-y7AIQTWaUe7DRT4OnIZVn94mhXxfhpBbng2aJ8nXg';

  // Password protection
  const ADMIN_PASSWORD = 'JaynaGyro2025!';

  let supabase = null;

  // Initialize app
  document.addEventListener('DOMContentLoaded', function() {
    initializeSupabase();
    renderWorkflowSelector();
  });

  // Initialize Supabase
  function initializeSupabase() {
    const { createClient } = window.supabase;
    supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  }

  // ============================================
  // DATABASE FUNCTIONS - Checklist Definitions
  // ============================================

  /**
   * Load checklist from database with all sections, tasks, and categories
   */
  async function loadChecklistFromDatabase(checklistType) {
    try {
      // 1. Load checklist definition
      const { data: definition, error: defError } = await supabase
        .from('checklist_definitions')
        .select('*')
        .eq('type', checklistType)
        .single();

      if (defError) {
        console.error('Error loading checklist definition:', defError);
        // Fallback to FOH_CHECKLISTS if not in database yet
        return getChecklistByType(checklistType);
      }

      if (!definition) {
        // Fallback to FOH_CHECKLISTS if not found
        return getChecklistByType(checklistType);
      }

      // 2. Load sections for this checklist
      const { data: sections, error: secError } = await supabase
        .from('checklist_sections')
        .select('*')
        .eq('checklist_id', definition.id)
        .order('display_order', { ascending: true });

      if (secError) throw secError;

      // 3. Build checklist object
      const checklist = {
        type: definition.type,
        title: definition.title,
        timeRange: definition.time_range,
        description: definition.description,
        staffCount: definition.staff_count,
        hasRatings: definition.has_ratings,
        hasNotes: definition.has_notes,
        ratingScale: definition.rating_scale,
        start_hour: definition.start_hour,
        start_minute: definition.start_minute,
        end_hour: definition.end_hour,
        end_minute: definition.end_minute,
        sections: []
      };

      // 4. Load tasks/categories for each section
      for (const section of sections) {
        const sectionObj = {
          name: section.name,
          description: section.description,
          type: section.section_type
        };

        if (section.section_type === 'checkbox') {
          // Load tasks for checkbox sections
          const { data: tasks, error: taskError } = await supabase
            .from('checklist_section_tasks')
            .select('*')
            .eq('section_id', section.id)
            .order('display_order', { ascending: true });

          if (taskError) throw taskError;

          sectionObj.tasks = tasks.map(t => ({
            text: t.task_text,
            is_required: t.is_required || false
          }));

        } else if (section.section_type === 'rating') {
          // Load categories for rating sections
          const { data: categories, error: catError } = await supabase
            .from('checklist_section_categories')
            .select('*')
            .eq('section_id', section.id)
            .order('display_order', { ascending: true });

          if (catError) throw catError;

          sectionObj.categories = categories.map(c => ({
            name: c.name,
            description: c.description || ''
          }));
        }

        checklist.sections.push(sectionObj);
      }

      console.log('✓ Loaded checklist from database:', checklistType);
      return checklist;

    } catch (error) {
      console.error('Error loading checklist from database:', error);
      // Fallback to FOH_CHECKLISTS
      return getChecklistByType(checklistType);
    }
  }

  /**
   * Save checklist definition to database
   */
  async function saveChecklistToDatabase(checklistType, checklistData) {
    const managerName = localStorage.getItem('foh_username') || 'Manager';

    try {
      showLoading('Saving Checklist', 'Updating database...');

      // 1. Upsert checklist definition
      const { data: definition, error: defError } = await supabase
        .from('checklist_definitions')
        .upsert({
          type: checklistType,
          title: checklistData.title,
          time_range: checklistData.timeRange,
          description: checklistData.description,
          staff_count: checklistData.staffCount,
          has_ratings: checklistData.hasRatings,
          has_notes: checklistData.hasNotes,
          rating_scale: checklistData.ratingScale || null,
          start_hour: checklistData.start_hour,
          start_minute: checklistData.start_minute,
          end_hour: checklistData.end_hour,
          end_minute: checklistData.end_minute,
          updated_at: new Date().toISOString(),
          updated_by: managerName
        }, {
          onConflict: 'type'
        })
        .select()
        .single();

      if (defError) throw defError;

      const checklistId = definition.id;

      // 2. Delete all existing sections (cascade will delete tasks/categories)
      const { error: deleteError } = await supabase
        .from('checklist_sections')
        .delete()
        .eq('checklist_id', checklistId);

      if (deleteError) throw deleteError;

      // 3. Insert new sections with tasks/categories
      for (let i = 0; i < checklistData.sections.length; i++) {
        const section = checklistData.sections[i];

        // Insert section
        const { data: sectionData, error: secError } = await supabase
          .from('checklist_sections')
          .insert({
            checklist_id: checklistId,
            name: section.name,
            description: section.description || null,
            section_type: section.type,
            display_order: i
          })
          .select()
          .single();

        if (secError) throw secError;

        const sectionId = sectionData.id;

        // Insert tasks or categories based on section type
        if (section.type === 'checkbox' && section.tasks && section.tasks.length > 0) {
          const tasks = section.tasks.map((task, index) => {
            // Handle both string format (legacy) and object format (new)
            const taskText = typeof task === 'string' ? task : task.text;
            const isRequired = typeof task === 'object' ? (task.is_required || false) : false;

            return {
              section_id: sectionId,
              task_text: taskText,
              is_required: isRequired,
              display_order: index
            };
          });

          const { error: taskError } = await supabase
            .from('checklist_section_tasks')
            .insert(tasks);

          if (taskError) throw taskError;

        } else if (section.type === 'rating' && section.categories && section.categories.length > 0) {
          const categories = section.categories.map((cat, index) => ({
            section_id: sectionId,
            name: cat.name,
            description: cat.description || null,
            display_order: index
          }));

          const { error: catError } = await supabase
            .from('checklist_section_categories')
            .insert(categories);

          if (catError) throw catError;
        }
      }

      hideLoading();
      console.log('✓ Checklist saved to database:', checklistType);
      return true;

    } catch (error) {
      hideLoading();
      console.error('Error saving checklist to database:', error);
      throw error;
    }
  }

  /**
   * Load all checklist types (ALWAYS returns all 5 from FOH_CHECKLISTS)
   * Individual checklists load from database with fallback to static data
   */
  async function loadAllChecklistsFromDatabase() {
    // Always return all 5 checklist types from FOH_CHECKLISTS
    // This ensures EDIT tab shows all 5 checklists
    // Individual checklists will load from database or fall back to static data
    return Object.keys(FOH_CHECKLISTS);
  }

  // ============================================
  // PHOTO UPLOAD FUNCTIONS
  // ============================================

  /**
   * Compress image before upload (reduces storage space)
   * Resizes to max 1920px wide, converts to JPEG at 80% quality
   */
  async function compressImage(file, maxWidth = 1920, quality = 0.8) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.readAsDataURL(file);
      reader.onload = (e) => {
        const img = new Image();
        img.src = e.target.result;
        img.onload = () => {
          const canvas = document.createElement('canvas');
          let width = img.width;
          let height = img.height;

          // Resize if wider than maxWidth
          if (width > maxWidth) {
            height = (height * maxWidth) / width;
            width = maxWidth;
          }

          canvas.width = width;
          canvas.height = height;

          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, width, height);

          // Convert to blob (JPEG format)
          canvas.toBlob(
            (blob) => {
              resolve(blob);
            },
            'image/jpeg',
            quality
          );
        };
        img.onerror = reject;
      };
      reader.onerror = reject;
    });
  }

  /**
   * Upload photo to Supabase Storage
   * Returns public URL of uploaded photo
   */
  async function uploadPhoto(file, folder = 'task-photos') {
    try {
      // Compress image first
      const compressedBlob = await compressImage(file);

      // Generate unique filename
      const fileExt = 'jpg'; // Always JPEG after compression
      const fileName = `${Date.now()}_${Math.random().toString(36).substring(7)}.${fileExt}`;
      const filePath = `${folder}/${fileName}`;

      // Upload to Supabase Storage
      const { data, error } = await supabase.storage
        .from('foh-checklist-photos')
        .upload(filePath, compressedBlob, {
          contentType: 'image/jpeg',
          upsert: false
        });

      if (error) throw error;

      // Get public URL
      const { data: { publicUrl } } = supabase.storage
        .from('foh-checklist-photos')
        .getPublicUrl(filePath);

      console.log('✓ Photo uploaded:', publicUrl);
      return publicUrl;

    } catch (error) {
      console.error('Error uploading photo:', error);
      throw error;
    }
  }

  /**
   * Upload task photo (1 photo limit per task)
   */
  async function uploadTaskPhoto(taskId, sessionId, file) {
    const username = localStorage.getItem('foh_username') || 'Staff';

    try {
      // Check if photo already exists for this task
      const { data: existingPhotos, error: checkError } = await supabase
        .from('foh_checklist_task_photos')
        .select('id')
        .eq('task_id', taskId)
        .eq('session_id', sessionId)
        .eq('is_deleted', false);

      if (checkError) throw checkError;

      if (existingPhotos && existingPhotos.length > 0) {
        showMessage('Only 1 photo allowed per task. Delete existing photo first.', 'error');
        return null;
      }

      // Upload photo to storage
      showLoading('Uploading Photo', 'Compressing and uploading...');
      const photoUrl = await uploadPhoto(file, 'task-photos');

      // Save photo record to database
      const { data, error } = await supabase
        .from('foh_checklist_task_photos')
        .insert({
          task_id: taskId,
          session_id: sessionId,
          photo_url: photoUrl,
          uploaded_by: username,
          uploaded_at: new Date().toISOString()
        })
        .select()
        .single();

      if (error) throw error;

      hideLoading();
      showMessage('✅ Photo uploaded successfully!', 'success');
      return data;

    } catch (error) {
      hideLoading();
      console.error('Error uploading task photo:', error);
      showMessage(`Error uploading photo: ${error.message}`, 'error');
      return null;
    }
  }

  /**
   * Upload session photo (5 photo limit per session)
   */
  async function uploadSessionPhoto(sessionId, file, caption = '') {
    const username = localStorage.getItem('foh_username') || 'Staff';

    try {
      // Check photo count (max 5)
      const { data: existingPhotos, error: checkError } = await supabase
        .from('foh_checklist_session_photos')
        .select('id')
        .eq('session_id', sessionId)
        .eq('is_deleted', false);

      if (checkError) throw checkError;

      if (existingPhotos && existingPhotos.length >= 5) {
        showMessage('Maximum 5 photos allowed per session. Delete a photo first.', 'error');
        return null;
      }

      // Upload photo to storage
      showLoading('Uploading Photo', 'Compressing and uploading...');
      const photoUrl = await uploadPhoto(file, 'session-photos');

      // Get next display order
      const displayOrder = existingPhotos ? existingPhotos.length : 0;

      // Save photo record to database
      const { data, error } = await supabase
        .from('foh_checklist_session_photos')
        .insert({
          session_id: sessionId,
          photo_url: photoUrl,
          caption: caption || null,
          uploaded_by: username,
          uploaded_at: new Date().toISOString(),
          display_order: displayOrder
        })
        .select()
        .single();

      if (error) throw error;

      hideLoading();
      showMessage('✅ Photo uploaded successfully!', 'success');
      return data;

    } catch (error) {
      hideLoading();
      console.error('Error uploading session photo:', error);
      showMessage(`Error uploading photo: ${error.message}`, 'error');
      return null;
    }
  }

  /**
   * Soft delete photo (staff can delete their own)
   * Photo remains in database and Watchdog with deletion info
   */
  async function deletePhoto(photoId, photoType = 'task') {
    const username = localStorage.getItem('foh_username') || 'Staff';
    const tableName = photoType === 'task' ? 'foh_checklist_task_photos' : 'foh_checklist_session_photos';

    try {
      // Soft delete: mark as deleted with username and timestamp
      const { error } = await supabase
        .from(tableName)
        .update({
          is_deleted: true,
          deleted_by: username,
          deleted_at: new Date().toISOString()
        })
        .eq('id', photoId);

      if (error) throw error;

      showMessage('✅ Photo deleted (visible to managers in Watchdog)', 'success');
      return true;

    } catch (error) {
      console.error('Error deleting photo:', error);
      showMessage(`Error deleting photo: ${error.message}`, 'error');
      return false;
    }
  }

  /**
   * Load photos for a task
   */
  async function loadTaskPhotos(taskId, sessionId) {
    try {
      const { data, error } = await supabase
        .from('foh_checklist_task_photos')
        .select('*')
        .eq('task_id', taskId)
        .eq('session_id', sessionId)
        .order('uploaded_at', { ascending: true });

      if (error) throw error;

      return data || [];
    } catch (error) {
      console.error('Error loading task photos:', error);
      return [];
    }
  }

  /**
   * Load photos for a session
   */
  async function loadSessionPhotos(sessionId) {
    try {
      const { data, error } = await supabase
        .from('foh_checklist_session_photos')
        .select('*')
        .eq('session_id', sessionId)
        .order('display_order', { ascending: true });

      if (error) throw error;

      return data || [];
    } catch (error) {
      console.error('Error loading session photos:', error);
      return [];
    }
  }

  /**
   * Handle Task Photo Upload from file input
   */
  async function handleTaskPhotoUpload(taskId, sessionId, event) {
    const file = event.target.files[0];
    if (!file) return;

    try {
      const result = await uploadTaskPhoto(taskId, sessionId, file);
      if (result) {
        // Reload and display photos for this task
        await displayTaskPhotos(taskId, sessionId);
        // Clear file input
        event.target.value = '';
      }
    } catch (error) {
      console.error('Error handling task photo upload:', error);
      showMessage(`Error uploading photo: ${error.message}`, 'error');
    }
  }

  /**
   * Display photos for a specific task
   */
  async function displayTaskPhotos(taskId, sessionId) {
    const container = document.getElementById(`photoDisplay_${taskId}`);
    if (!container) return;

    // Load photos for this task
    const photos = await loadTaskPhotos(taskId, sessionId);

    if (photos.length === 0) {
      container.innerHTML = '';
      return;
    }

    let html = '<div style="display: flex; gap: 8px; flex-wrap: wrap;">';

    photos.forEach(photo => {
      const isDeleted = photo.is_deleted;

      html += `
        <div style="position: relative; ${isDeleted ? 'opacity: 0.5;' : ''}">
          <img
            src="${photo.photo_url}"
            alt="Task photo"
            style="
              width: 80px;
              height: 80px;
              object-fit: cover;
              border: 2px solid ${isDeleted ? '#dc2626' : 'var(--gray-300)'};
              border-radius: 0;
              cursor: pointer;
            "
            onclick="window.open('${photo.photo_url}', '_blank')"
          />
          ${!isDeleted ? `
            <button
              onclick="deleteTaskPhotoUI('${photo.id}', '${taskId}', '${sessionId}')"
              style="
                position: absolute;
                top: -8px;
                right: -8px;
                width: 24px;
                height: 24px;
                background: #dc2626;
                color: white;
                border: 2px solid white;
                border-radius: 50%;
                font-size: 12px;
                font-weight: 700;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 0;
              "
            >✕</button>
          ` : `
            <div style="
              position: absolute;
              bottom: 0;
              left: 0;
              right: 0;
              background: rgba(220, 38, 38, 0.9);
              color: white;
              font-size: 9px;
              font-weight: 700;
              padding: 2px 4px;
              text-align: center;
            ">DELETED</div>
          `}
        </div>
      `;
    });

    html += '</div>';
    container.innerHTML = html;
  }

  /**
   * Delete task photo (soft delete) with UI update
   */
  async function deleteTaskPhotoUI(photoId, taskId, sessionId) {
    const success = await deletePhoto(photoId, 'task');
    if (success) {
      await displayTaskPhotos(taskId, sessionId);
    }
  }

  /**
   * Handle Session Photos Upload (multiple files, max 5)
   */
  async function handleSessionPhotosUpload(event) {
    const files = Array.from(event.target.files);
    if (files.length === 0) return;

    const sessionId = fohSystemState.currentSession.id;

    // Check current photo count
    const existingPhotos = await loadSessionPhotos(sessionId);
    const nonDeletedCount = existingPhotos.filter(p => !p.is_deleted).length;

    if (nonDeletedCount + files.length > 5) {
      showMessage(`Cannot upload ${files.length} photos. Maximum 5 photos per session (${nonDeletedCount} already uploaded).`, 'error');
      event.target.value = '';
      return;
    }

    try {
      // Upload each file
      for (const file of files) {
        await uploadSessionPhoto(sessionId, file);
      }

      // Reload and display photos
      await displaySessionPhotos(sessionId);

      // Clear file input
      event.target.value = '';

    } catch (error) {
      console.error('Error handling session photos upload:', error);
      showMessage(`Error uploading photos: ${error.message}`, 'error');
    }
  }

  /**
   * Display photos for session
   */
  async function displaySessionPhotos(sessionId) {
    const container = document.getElementById('sessionPhotosDisplay');
    if (!container) return;

    // Load photos for this session
    const photos = await loadSessionPhotos(sessionId);

    if (photos.length === 0) {
      container.innerHTML = '';
      return;
    }

    let html = '<div style="display: flex; gap: 12px; flex-wrap: wrap; margin-top: 12px;">';

    photos.forEach(photo => {
      const isDeleted = photo.is_deleted;

      html += `
        <div style="position: relative; ${isDeleted ? 'opacity: 0.5;' : ''}">
          <img
            src="${photo.photo_url}"
            alt="Session photo"
            style="
              width: 100px;
              height: 100px;
              object-fit: cover;
              border: 2px solid ${isDeleted ? '#dc2626' : 'var(--gray-300)'};
              border-radius: 0;
              cursor: pointer;
            "
            onclick="window.open('${photo.photo_url}', '_blank')"
          />
          ${!isDeleted ? `
            <button
              onclick="deleteSessionPhotoUI('${photo.id}', '${sessionId}')"
              style="
                position: absolute;
                top: -8px;
                right: -8px;
                width: 24px;
                height: 24px;
                background: #dc2626;
                color: white;
                border: 2px solid white;
                border-radius: 50%;
                font-size: 12px;
                font-weight: 700;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 0;
              "
            >✕</button>
          ` : `
            <div style="
              position: absolute;
              bottom: 0;
              left: 0;
              right: 0;
              background: rgba(220, 38, 38, 0.9);
              color: white;
              font-size: 9px;
              font-weight: 700;
              padding: 2px 4px;
              text-align: center;
            ">DELETED</div>
          `}
        </div>
      `;
    });

    html += '</div>';
    container.innerHTML = html;
  }

  /**
   * Delete session photo (soft delete) with UI update
   */
  async function deleteSessionPhotoUI(photoId, sessionId) {
    const success = await deletePhoto(photoId, 'session');
    if (success) {
      await displaySessionPhotos(sessionId);
    }
  }

  // Loading functions
  function showLoading(title, message) {
    const overlay = document.getElementById('loadingOverlay');
    document.getElementById('loadingTitle').textContent = title;
    document.getElementById('loadingMessage').textContent = message;
    overlay.style.display = 'flex';
  }

  function hideLoading() {
    document.getElementById('loadingOverlay').style.display = 'none';
  }

  // Message display
  function showMessage(text, type) {
    const messageArea = document.getElementById('messageArea');
    messageArea.innerHTML = `<div class="message ${type}">${text}</div>`;
    setTimeout(() => messageArea.innerHTML = '', 5000);
  }

  // ============================================
  // SESSION MANAGEMENT (60-minute manager access)
  // ============================================

  function setManagerSession() {
    const now = new Date().getTime();
    const expiryTime = now + (60 * 60 * 1000); // 60 minutes from now
    localStorage.setItem('managerSession', expiryTime.toString());
    console.log('✓ Manager session set (60 minutes)');
  }

  function isManagerSessionValid() {
    const sessionExpiry = localStorage.getItem('managerSession');
    if (!sessionExpiry) return false;

    const now = new Date().getTime();
    const expiryTime = parseInt(sessionExpiry);

    if (now > expiryTime) {
      // Session expired, clean up
      localStorage.removeItem('managerSession');
      return false;
    }

    return true;
  }

  function clearManagerSession() {
    localStorage.removeItem('managerSession');
    console.log('✓ Manager session cleared');
  }

  function getRemainingSessionMinutes() {
    if (!isManagerSessionValid()) return 0;

    const sessionExpiry = localStorage.getItem('managerSession');
    const expiryTime = parseInt(sessionExpiry);
    const now = new Date().getTime();
    return Math.ceil((expiryTime - now) / (60 * 1000));
  }

  // Password requirement - Using inline modal instead of prompt() (blocked in sandboxed iframe)
  // Now with persistent 60-minute session support
  function requirePasswordFor(featureName, callback) {
    // Check if manager session is still valid
    if (isManagerSessionValid()) {
      const remainingMinutes = getRemainingSessionMinutes();
      console.log(`✓ Manager session valid (${remainingMinutes} min remaining)`);
      callback();
      return;
    }
    // Create password modal overlay
    const modal = document.createElement('div');
    modal.id = 'passwordModal';
    modal.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      padding: 20px;
    `;

    const modalContent = document.createElement('div');
    modalContent.style.cssText = `
      background: white;
      padding: 32px;
      max-width: 400px;
      width: 100%;
      border: 3px solid var(--gray-700);
      border-radius: 0;
    `;

    modalContent.innerHTML = `
      <h3 style="margin: 0 0 12px 0; font-size: 18px; font-weight: 700; color: var(--gray-900); text-transform: uppercase; letter-spacing: 1px;">
        Password Required
      </h3>
      <p style="margin: 0 0 20px 0; font-size: 13px; color: var(--gray-600);">
        Enter password to access ${featureName}
      </p>
      <input
        type="password"
        id="passwordInput"
        placeholder="Enter password"
        style="
          width: 100%;
          padding: 14px;
          border: 2px solid var(--gray-300);
          border-radius: 0;
          font-size: 14px;
          margin-bottom: 20px;
          box-sizing: border-box;
        "
      />
      <div style="display: flex; gap: 12px;">
        <button
          id="passwordCancelBtn"
          style="
            flex: 1;
            padding: 14px 24px;
            background: var(--gray-100);
            color: var(--gray-900);
            border: 2px solid var(--gray-300);
            border-radius: 0;
            font-size: 13px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            transition: all 0.15s ease;
          "
        >CANCEL</button>
        <button
          id="passwordSubmitBtn"
          style="
            flex: 1;
            padding: 14px 24px;
            background: var(--gray-900);
            color: white;
            border: 2px solid var(--gray-900);
            border-radius: 0;
            font-size: 13px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            transition: all 0.15s ease;
          "
        >SUBMIT</button>
      </div>
    `;

    modal.appendChild(modalContent);
    document.body.appendChild(modal);

    const passwordInput = document.getElementById('passwordInput');
    const submitBtn = document.getElementById('passwordSubmitBtn');
    const cancelBtn = document.getElementById('passwordCancelBtn');

    // Focus password input
    setTimeout(() => passwordInput.focus(), 100);

    // Handle submit - Check against hardcoded password AND database
    const handleSubmit = async () => {
      const enteredPassword = passwordInput.value;

      // Check hardcoded ADMIN_PASSWORD first (fallback)
      if (enteredPassword === ADMIN_PASSWORD) {
        setManagerSession(); // Set 60-minute session
        document.body.removeChild(modal);
        showMessage('✅ Manager session active (60 minutes)', 'success');
        callback();
        return;
      }

      // Check against database passwords
      try {
        const passwordHash = simpleHash(enteredPassword);

        const { data: passwords, error } = await supabase
          .from('manager_passwords')
          .select('*')
          .eq('password_hash', passwordHash)
          .eq('is_active', true)
          .limit(1);

        if (error) {
          console.error('Error checking password:', error);
          // Fall through to incorrect password message
        }

        if (passwords && passwords.length > 0) {
          // Valid password found in database
          setManagerSession(); // Set 60-minute session
          document.body.removeChild(modal);
          showMessage(`✅ Manager session active (60 minutes) - ${passwords[0].username}`, 'success');
          callback();
          return;
        }

        // No match found
        showMessage('Incorrect password!', 'error');
        passwordInput.value = '';
        passwordInput.focus();

      } catch (error) {
        console.error('Error verifying password:', error);
        showMessage('Error verifying password!', 'error');
        passwordInput.value = '';
        passwordInput.focus();
      }
    };

    // Handle cancel
    const handleCancel = () => {
      document.body.removeChild(modal);
    };

    submitBtn.onclick = handleSubmit;
    cancelBtn.onclick = handleCancel;
    passwordInput.onkeypress = (e) => {
      if (e.key === 'Enter') {
        handleSubmit();
      }
    };

    // Click outside to close
    modal.onclick = (e) => {
      if (e.target === modal) {
        handleCancel();
      }
    };
  }

  // Pacific time helpers
  function getPacificDate() {
    const now = new Date();
    const pacificTime = new Date(now.toLocaleString('en-US', { timeZone: 'America/Los_Angeles' }));
    const year = pacificTime.getFullYear();
    const month = String(pacificTime.getMonth() + 1).padStart(2, '0');
    const day = String(pacificTime.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
  }

  function getPacificHour(date) {
    const pacificTime = new Date(date.toLocaleString('en-US', { timeZone: 'America/Los_Angeles' }));
    return pacificTime.getHours();
  }

  function formatPacificDateDisplay(date, options) {
    return new Date(date).toLocaleString('en-US', {
      timeZone: 'America/Los_Angeles',
      ...options
    });
  }

  // FOH CHECKLIST SYSTEM
  // ====================================

  // FOH System State
  const fohSystemState = {
    currentSession: null,
    currentChecklist: null,
    tasks: [],
    ratings: [],
    staffName: '',
    staffName2: '',
    allChecklists: {} // Will be populated on page load
  };

  /**
   * Initialize FOH System - Load all checklists from database
   */
  async function initializeFOHSystem() {
    try {
      // Load all checklist types from database
      const checklistTypes = Object.keys(FOH_CHECKLISTS);

      for (const checklistType of checklistTypes) {
        const checklist = await loadChecklistFromDatabase(checklistType);
        if (checklist) {
          fohSystemState.allChecklists[checklistType] = checklist;
          console.log(`✓ Loaded checklist: ${checklistType}`);
        }
      }

      console.log(`✅ FOH System initialized. ${Object.keys(fohSystemState.allChecklists).length} checklists loaded.`);

    } catch (error) {
      console.error('Error initializing FOH system:', error);
      // Fallback to static data if database fails
      Object.keys(FOH_CHECKLISTS).forEach(type => {
        fohSystemState.allChecklists[type] = FOH_CHECKLISTS[type];
      });
      console.log('⚠️ Using fallback static checklist data');
    }
  }

  // Initialize system on page load
  initializeFOHSystem();

  /**
   * Open FOH Tab - Using EXACT pattern from working openOrderTab
   */
  function openFOHTab(event, tabName) {
    console.log('openFOHTab:', tabName);

    // Hide all FOH tab contents
    const tabContents = document.querySelectorAll('#fohSystemForm .tab-content');
    tabContents.forEach(content => content.style.display = 'none');

    // Remove active class from all FOH tab links
    const tabLinks = document.querySelectorAll('#fohSystemForm .tab-link');
    tabLinks.forEach(link => {
      link.style.background = 'var(--gray-100)';
      link.style.color = 'var(--gray-700)';
    });

    // Show selected tab and mark button as active
    document.getElementById(tabName).style.display = 'block';
    if (event && event.target) {
      event.target.style.background = 'var(--gray-700)';
      event.target.style.color = 'white';
    }

    console.log('✅ Tab switched to:', tabName);
  }

  /**
   * Get Available Checklists - Filter by current Pacific time
   */
  function getAvailableChecklists() {
    const now = new Date();
    const pacificTime = new Date(now.toLocaleString('en-US', { timeZone: 'America/Los_Angeles' }));
    const currentHour = pacificTime.getHours();
    const currentMinute = pacificTime.getMinutes();

    // Convert current time to minutes since midnight for easier comparison
    const currentTimeMinutes = (currentHour * 60) + currentMinute;

    // Get all checklist types
    const allChecklistTypes = Object.keys(FOH_CHECKLISTS);
    const availableChecklists = [];

    allChecklistTypes.forEach(checklistType => {
      const checklist = fohSystemState.allChecklists?.[checklistType];

      if (!checklist) {
        console.log(`⚠️ Checklist not loaded: ${checklistType}`);
        return;
      }

      // If checklist has time range defined, check if current time is within range
      if (checklist.start_hour !== undefined && checklist.end_hour !== undefined) {
        const startTimeMinutes = (checklist.start_hour * 60) + (checklist.start_minute || 0);
        const endTimeMinutes = (checklist.end_hour * 60) + (checklist.end_minute || 0);

        // Check if current time is within range
        if (currentTimeMinutes >= startTimeMinutes && currentTimeMinutes < endTimeMinutes) {
          availableChecklists.push(checklist);
        }
      } else {
        // If no time range defined, always show (fallback for checklists without time data)
        availableChecklists.push(checklist);
      }
    });

    console.log(`⏰ Time check: ${currentHour}:${currentMinute} (${currentTimeMinutes} minutes)`);
    console.log(`✅ Available checklists: ${availableChecklists.length}/${allChecklistTypes.length}`);

    return availableChecklists;
  }

  /**
   * Render Workflow Selector - Shows available checklists based on time
   */
  function renderWorkflowSelector() {
    console.log('renderWorkflowSelector() called');

    const container = document.getElementById('fohWorkflowContent');

    if (!container) {
      console.error('❌ fohWorkflowContent container not found!');
      alert('Error: Cannot find workflow content container');
      return;
    }

    console.log('✅ Container found:', container);

    // Get available checklists based on current Pacific time
    const availableChecklists = getAvailableChecklists();

    console.log('Available checklists:', availableChecklists.length, availableChecklists);

    if (availableChecklists.length === 0) {
      const now = new Date();
      const hour = getPacificHour(now);
      console.log('⚠️ No checklists available. Current Pacific hour:', hour);

      container.innerHTML = `
        <div style="text-align: center; padding: 40px;">
          <p style="font-size: 16px; color: var(--gray-700); margin-bottom: 12px;">
            ⏰ No checklists available at this time
          </p>
          <p style="font-size: 13px; color: var(--gray-500);">
            Checklists are time-based. Check back during operating hours.<br>
            Current Pacific hour: ${hour}
          </p>
        </div>
      `;
      return;
    }

    let html = `
      <div style="margin-bottom: 20px; padding: 16px; background: var(--blue-bg); border-left: 4px solid var(--blue-text); border-radius: 0;">
        <p style="color: var(--blue-text); font-size: 13px; font-weight: 600; margin: 0;">
          📋 Select a checklist to begin. Available checklists update based on time of day.
        </p>
      </div>

      <div style="display: grid; gap: 16px;">
    `;

    availableChecklists.forEach(checklist => {
      html += `
        <div style="
          background: white;
          border: 2px solid var(--gray-300);
          padding: 20px;
          cursor: pointer;
          transition: all 0.15s ease;
          border-radius: 0;
        "
        onmouseover="this.style.borderColor='var(--gray-700)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)';"
        onmouseout="this.style.borderColor='var(--gray-300)'; this.style.boxShadow='none';"
        onclick="selectChecklist('${checklist.type}')">

          <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
            <h3 style="margin: 0; font-size: 16px; font-weight: 700; color: var(--gray-900); text-transform: uppercase; letter-spacing: 1px;">
              ${checklist.title}
            </h3>
            <span style="
              background: var(--gray-700);
              color: white;
              padding: 4px 10px;
              font-size: 11px;
              font-weight: 700;
              letter-spacing: 0.5px;
              border-radius: 0;
            ">${checklist.timeRange}</span>
          </div>

          <p style="margin: 0 0 12px 0; font-size: 13px; color: var(--gray-600); line-height: 1.5;">
            ${checklist.description}
          </p>

          <div style="display: flex; gap: 12px; font-size: 12px; color: var(--gray-500);">
            ${checklist.staffCount > 1 ?
              `<span>👥 ${checklist.staffCount} Staff Members</span>` :
              `<span>👤 ${checklist.staffCount} Staff Member</span>`
            }
            ${checklist.hasRatings ? '<span>⭐ Includes Ratings</span>' : ''}
            ${checklist.hasNotes ? '<span>📝 Notes for Next Shift</span>' : ''}
          </div>
        </div>
      `;
    });

    html += '</div>';

    console.log('About to insert HTML, length:', html.length);

    container.innerHTML = html;

    console.log('✅ HTML inserted into container');
  }

  /**
   * Select Checklist - Check for existing session or create new one
   */
  async function selectChecklist(checklistType) {
    const checklist = getChecklistByType(checklistType);
    if (!checklist) {
      showMessage('Checklist not found!', 'error');
      return;
    }

    fohSystemState.currentChecklist = checklist;

    showLoading('Checking...', 'Looking for active checklist session...');

    try {
      // Check for existing incomplete session for this checklist type today
      const { data: existingSessions, error } = await supabase
        .from('foh_checklist_sessions')
        .select('*')
        .eq('checklist_type', checklistType)
        .eq('session_date', getPacificDate())
        .eq('is_complete', false)
        .order('started_at', { ascending: false })
        .limit(1);

      if (error) throw error;

      hideLoading();

      if (existingSessions && existingSessions.length > 0) {
        // Found existing session - join it!
        await joinExistingSession(existingSessions[0]);
      } else {
        // No existing session - show name input to create new one
        renderStaffNameInput();
      }
    } catch (error) {
      hideLoading();
      console.error('Error checking for existing session:', error);
      showMessage(`Error: ${error.message}`, 'error');
    }
  }

  /**
   * Join Existing Session - Load tasks/ratings from existing incomplete session
   */
  async function joinExistingSession(session) {
    showLoading('Joining Session', 'Loading checklist data...');

    try {
      // Get stored username from localStorage
      const savedUsername = localStorage.getItem('foh_username') || '';

      fohSystemState.currentSession = session;
      fohSystemState.staffName = savedUsername;

      // Load existing tasks
      const { data: tasks, error: tasksError } = await supabase
        .from('foh_checklist_tasks')
        .select('*')
        .eq('session_id', session.id)
        .order('task_order');

      if (tasksError) throw tasksError;
      fohSystemState.tasks = tasks || [];

      // Load existing ratings
      const { data: ratings, error: ratingsError } = await supabase
        .from('foh_checklist_ratings')
        .select('*')
        .eq('session_id', session.id);

      if (ratingsError) throw ratingsError;
      fohSystemState.ratings = ratings || [];

      hideLoading();

      // If no username in localStorage, prompt for it
      if (!savedUsername) {
        promptForUsername();
      } else {
        // Render checklist
        renderChecklist();
      }
    } catch (error) {
      hideLoading();
      console.error('Error joining session:', error);
      showMessage(`Error joining session: ${error.message}`, 'error');
    }
  }

  /**
   * Render Staff Name Input Screen (for new sessions)
   */
  function renderStaffNameInput() {
    const container = document.getElementById('fohWorkflowContent');
    const checklist = fohSystemState.currentChecklist;

    // Get saved username from localStorage
    const savedUsername = localStorage.getItem('foh_username') || '';

    const html = `
      <div style="max-width: 600px; margin: 0 auto;">
        <div style="margin-bottom: 24px; padding: 16px; background: var(--gray-100); border-radius: 0; border: 2px solid var(--gray-300);">
          <h3 style="margin: 0 0 8px 0; font-size: 16px; font-weight: 700; color: var(--gray-900); text-transform: uppercase; letter-spacing: 1px;">
            ${checklist.title}
          </h3>
          <p style="margin: 0; font-size: 13px; color: var(--gray-600);">
            ${checklist.description}
          </p>
        </div>

        <div style="margin-bottom: 24px;">
          <label style="display: block; margin-bottom: 8px; font-size: 12px; font-weight: 700; color: var(--gray-700); text-transform: uppercase; letter-spacing: 0.5px;">
            Your Name *
          </label>
          <input
            type="text"
            id="fohStaffName"
            value="${savedUsername}"
            placeholder="Enter your name"
            style="
              width: 100%;
              padding: 14px;
              border: 2px solid var(--gray-300);
              border-radius: 0;
              font-size: 14px;
              box-sizing: border-box;
            "
            onfocus="this.style.borderColor='var(--gray-700)'"
            onblur="this.style.borderColor='var(--gray-300)'"
          />
          <p style="margin: 8px 0 0 0; font-size: 11px; color: var(--gray-500);">
            Your name will be saved and used for all your actions in this checklist
          </p>
        </div>

        <div style="display: flex; gap: 12px;">
          <button
            onclick="renderWorkflowSelector()"
            style="
              flex: 1;
              padding: 14px 24px;
              background: var(--gray-100);
              color: var(--gray-900);
              border: 2px solid var(--gray-300);
              border-radius: 0;
              font-size: 13px;
              font-weight: 700;
              text-transform: uppercase;
              letter-spacing: 0.5px;
              cursor: pointer;
              transition: all 0.15s ease;
            "
            onmouseover="this.style.background='var(--gray-200)'"
            onmouseout="this.style.background='var(--gray-100)'"
          >CANCEL</button>

          <button
            onclick="startChecklistSession()"
            style="
              flex: 2;
              padding: 14px 24px;
              background: var(--gray-900);
              color: white;
              border: 2px solid var(--gray-900);
              border-radius: 0;
              font-size: 13px;
              font-weight: 700;
              text-transform: uppercase;
              letter-spacing: 0.5px;
              cursor: pointer;
              transition: all 0.15s ease;
            "
            onmouseover="this.style.background='#000'"
            onmouseout="this.style.background='var(--gray-900)'"
          >START CHECKLIST</button>
        </div>
      </div>
    `;

    container.innerHTML = html;

    // Auto-focus name input
    setTimeout(() => {
      const nameInput = document.getElementById('fohStaffName');
      if (nameInput && !savedUsername) {
        nameInput.focus();
      }
    }, 100);
  }

  /**
   * Start Checklist Session - Create session in database
   */
  async function startChecklistSession() {
    const staffName = document.getElementById('fohStaffName').value.trim();

    if (!staffName) {
      showMessage('Please enter your name!', 'error');
      document.getElementById('fohStaffName').focus();
      return;
    }

    // Save username to localStorage for future use
    localStorage.setItem('foh_username', staffName);

    const checklist = fohSystemState.currentChecklist;

    showLoading('Starting Checklist', 'Creating session...');

    try {
      // Create session in database
      const sessionData = {
        checklist_type: checklist.type,
        staff_name: staffName,
        staff_name_2: null, // No longer using second name
        session_date: getPacificDate(),
        session_time: new Date().toLocaleTimeString('en-US', {
          timeZone: 'America/Los_Angeles',
          hour12: false
        }),
        started_at: new Date().toISOString(),
        is_complete: false
      };

      const { data, error } = await supabase
        .from('foh_checklist_sessions')
        .insert([sessionData])
        .select()
        .single();

      if (error) throw error;

      fohSystemState.currentSession = data;
      fohSystemState.staffName = staffName;

      // Create initial task records
      await createInitialTasks();

      hideLoading();

      // Render checklist
      renderChecklist();

    } catch (error) {
      hideLoading();
      console.error('Error starting checklist session:', error);
      showMessage(`Error starting checklist: ${error.message}`, 'error');
    }
  }

  /**
   * Create Initial Task Records in Database
   */
  async function createInitialTasks() {
    const checklist = fohSystemState.currentChecklist;
    const sessionId = fohSystemState.currentSession.id;

    const taskRecords = [];
    let taskOrder = 0;

    checklist.sections.forEach(section => {
      if (section.type === 'checkbox') {
        section.tasks.forEach(task => {
          // Handle both string format (legacy) and object format (new)
          const taskText = typeof task === 'string' ? task : task.text;
          const isRequired = typeof task === 'object' ? (task.is_required || false) : false;

          taskRecords.push({
            session_id: sessionId,
            checklist_type: checklist.type,
            section_name: section.name,
            task_text: taskText,
            is_required: isRequired,
            task_order: taskOrder++,
            is_completed: false
          });
        });
      }
    });

    if (taskRecords.length > 0) {
      const { data, error } = await supabase
        .from('foh_checklist_tasks')
        .insert(taskRecords)
        .select();

      if (error) throw error;

      fohSystemState.tasks = data;
    }
  }

  /**
   * Render Checklist - Main checklist view with tasks
   */
  function renderChecklist() {
    const container = document.getElementById('fohWorkflowContent');
    const checklist = fohSystemState.currentChecklist;
    const session = fohSystemState.currentSession;

    // Count required tasks
    const requiredTasksCount = fohSystemState.tasks.filter(t => t.is_required === true).length;
    const completedRequiredCount = fohSystemState.tasks.filter(t => t.is_required === true && t.is_completed === true).length;

    let html = `
      <!-- Session Header -->
      <div style="margin-bottom: 24px; padding: 20px; background: var(--success-bg); border-left: 4px solid var(--success-border); border-radius: 0;">
        <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 12px;">
          <div>
            <h3 style="margin: 0 0 8px 0; font-size: 16px; font-weight: 700; color: var(--success-text); text-transform: uppercase; letter-spacing: 1px;">
              ${checklist.title}
            </h3>
            <div style="font-size: 13px; color: var(--success-text); line-height: 1.6;">
              <div style="display: flex; align-items: center; gap: 8px;">
                <span>👤 ${fohSystemState.staffName || 'Not set'}</span>
                <button
                  onclick="changeUsername()"
                  style="
                    padding: 4px 8px;
                    background: var(--success-border);
                    color: white;
                    border: none;
                    border-radius: 0;
                    font-size: 10px;
                    font-weight: 700;
                    text-transform: uppercase;
                    letter-spacing: 0.5px;
                    cursor: pointer;
                    transition: all 0.15s ease;
                  "
                  onmouseover="this.style.background='#047857'"
                  onmouseout="this.style.background='var(--success-border)'"
                >Change Name</button>
              </div>
              <div>📅 ${formatPacificDateDisplay(new Date(session.started_at), {
                month: 'short',
                day: 'numeric',
                year: 'numeric',
                hour: 'numeric',
                minute: '2-digit',
                hour12: true
              })}</div>
            </div>
          </div>
          <div style="text-align: right;">
            <div id="checklistProgress" style="font-size: 14px; font-weight: 700; color: var(--success-text);">
              0 / ${fohSystemState.tasks.length} Tasks
            </div>
            ${requiredTasksCount > 0 ? `
              <div id="requiredTasksProgress" style="font-size: 12px; color: #92400e; margin-top: 4px; font-weight: 600;">
                ${completedRequiredCount} / ${requiredTasksCount} Required
              </div>
            ` : ''}
            <div style="font-size: 12px; color: var(--success-text); margin-top: 4px;">
              Auto-saving...
            </div>
          </div>
        </div>
      </div>
    `;

    // Render each section
    checklist.sections.forEach((section, sectionIndex) => {
      if (section.type === 'checkbox') {
        html += renderCheckboxSection(section, sectionIndex);
      } else if (section.type === 'rating') {
        html += renderRatingSection(section, sectionIndex);
      }
    });

    // Notes section (if applicable)
    if (checklist.hasNotes) {
      html += `
        <div style="margin-top: 30px; padding: 20px; background: white; border: 2px solid var(--gray-300); border-radius: 0;">
          <h4 style="margin: 0 0 12px 0; font-size: 14px; font-weight: 700; color: var(--gray-900); text-transform: uppercase; letter-spacing: 1px;">
            NOTES FOR INCOMING CREW
          </h4>
          <textarea
            id="fohSessionNotes"
            placeholder="Leave any notes or observations for the next shift..."
            style="
              width: 100%;
              min-height: 100px;
              padding: 12px;
              border: 2px solid var(--gray-300);
              border-radius: 0;
              font-size: 13px;
              font-family: inherit;
              box-sizing: border-box;
              resize: vertical;
            "
            onfocus="this.style.borderColor='var(--gray-700)'"
            onblur="this.style.borderColor='var(--gray-300)'; autoSaveNotes();"
          ></textarea>

          <!-- Photo Upload Section -->
          <div style="margin-top: 16px;">
            <h5 style="margin: 0 0 8px 0; font-size: 12px; font-weight: 700; color: var(--gray-700); text-transform: uppercase; letter-spacing: 0.5px;">
              📸 ATTACH PHOTOS (Max 5)
            </h5>
            <button
              onclick="document.getElementById('sessionPhotoInput').click();"
              style="
                padding: 8px 16px;
                background: var(--gray-100);
                border: 2px solid var(--gray-300);
                border-radius: 0;
                font-size: 12px;
                font-weight: 600;
                color: var(--gray-700);
                cursor: pointer;
                transition: all 0.15s ease;
              "
              onmouseover="this.style.borderColor='var(--gray-700)'"
              onmouseout="this.style.borderColor='var(--gray-300)'"
            >➕ Add Photos</button>
            <input
              type="file"
              id="sessionPhotoInput"
              accept="image/*"
              capture="environment"
              multiple
              style="display: none;"
              onchange="handleSessionPhotosUpload(event)"
            />
            <div id="sessionPhotosDisplay" style="margin-top: 12px;"></div>
          </div>
        </div>
      `;
    }

    // Action buttons
    html += `
      <div style="margin-top: 30px; display: flex; gap: 12px; flex-wrap: wrap;">
        <button
          onclick="confirmCancelChecklist()"
          style="
            flex: 1;
            min-width: 200px;
            padding: 14px 24px;
            background: var(--gray-100);
            color: var(--gray-900);
            border: 2px solid var(--gray-300);
            border-radius: 0;
            font-size: 13px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            transition: all 0.15s ease;
          "
          onmouseover="this.style.background='var(--gray-200)'"
          onmouseout="this.style.background='var(--gray-100)'"
        >CANCEL CHECKLIST</button>

        <button
          onclick="completeChecklistSession()"
          style="
            flex: 2;
            min-width: 200px;
            padding: 14px 24px;
            background: var(--success-border);
            color: white;
            border: 2px solid var(--success-border);
            border-radius: 0;
            font-size: 13px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            transition: all 0.15s ease;
          "
          onmouseover="this.style.background='#047857'"
          onmouseout="this.style.background='var(--success-border)'"
        >✓ COMPLETE & SUBMIT</button>
      </div>
    `;

    container.innerHTML = html;
    updateProgress();

    // Load photos for all tasks
    loadAllTaskPhotos();
  }

  /**
   * Load photos for all tasks in current session
   */
  async function loadAllTaskPhotos() {
    const sessionId = fohSystemState.currentSession?.id;
    if (!sessionId) return;

    // Load photos for each task
    for (const task of fohSystemState.tasks) {
      await displayTaskPhotos(task.id, sessionId);
    }

    // Load session photos
    await displaySessionPhotos(sessionId);
  }

  /**
   * Render Checkbox Section
   */
  function renderCheckboxSection(section, sectionIndex) {
    let html = `
      <div style="margin-bottom: 24px; background: white; border: 2px solid var(--gray-300); border-radius: 0; overflow: hidden;">
        <div style="background: var(--gray-700); color: white; padding: 14px 16px;">
          <h4 style="margin: 0; font-size: 14px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;">
            ${section.name}
          </h4>
          ${section.description ? `
            <p style="margin: 8px 0 0 0; font-size: 12px; opacity: 0.9; line-height: 1.5;">
              ${section.description}
            </p>
          ` : ''}
        </div>

        <div style="padding: 16px;">
    `;

    section.tasks.forEach((task, taskIndex) => {
      // Handle both string format (legacy) and object format (new)
      const taskText = typeof task === 'string' ? task : task.text;
      const isRequired = typeof task === 'object' ? (task.is_required || false) : false;

      const taskRecord = fohSystemState.tasks.find(t =>
        t.section_name === section.name && t.task_text === taskText
      );

      if (!taskRecord) return;

      const isChecked = taskRecord.is_completed;

      html += `
        <div style="
          display: flex;
          align-items: flex-start;
          gap: 12px;
          padding: 12px;
          margin-bottom: 8px;
          background: ${isChecked ? 'var(--success-bg)' : 'var(--gray-100)'};
          border-left: 3px solid ${isChecked ? 'var(--success-border)' : (isRequired ? '#f59e0b' : 'var(--gray-300)')};
          cursor: pointer;
          transition: all 0.15s ease;
        "
        onclick="toggleTask('${taskRecord.id}')"
        onmouseover="this.style.background='${isChecked ? '#d1fae5' : 'var(--gray-200)'}'"
        onmouseout="this.style.background='${isChecked ? 'var(--success-bg)' : 'var(--gray-100)'}'">

          <input
            type="checkbox"
            ${isChecked ? 'checked' : ''}
            style="
              width: 20px;
              height: 20px;
              margin-top: 2px;
              cursor: pointer;
              flex-shrink: 0;
            "
            onclick="event.stopPropagation(); toggleTask('${taskRecord.id}')"
          />

          <div style="flex: 1;">
            <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
              <span style="font-size: 13px; color: var(--gray-900); line-height: 1.5; ${isChecked ? 'text-decoration: line-through; opacity: 0.7;' : ''}">
                ${taskText}
              </span>
              ${isRequired ? `
                <span style="
                  display: inline-block;
                  padding: 2px 8px;
                  background: #fef3c7;
                  color: #92400e;
                  border: 1px solid #f59e0b;
                  border-radius: 0;
                  font-size: 10px;
                  font-weight: 700;
                  text-transform: uppercase;
                  letter-spacing: 0.5px;
                ">REQUIRED</span>
              ` : ''}
            </div>
            ${isChecked && taskRecord.completed_by ? `
              <div style="font-size: 11px; color: var(--gray-600); margin-top: 4px; font-style: italic;">
                ✓ ${taskRecord.completed_by} • ${formatPacificDateDisplay(new Date(taskRecord.completed_at), {
                  hour: 'numeric',
                  minute: '2-digit',
                  hour12: true
                })}
              </div>
            ` : ''}

            <!-- Photo Upload Section -->
            <div id="taskPhotos_${taskRecord.id}" style="margin-top: 8px;">
              <button
                onclick="event.stopPropagation(); document.getElementById('photoInput_${taskRecord.id}').click();"
                style="
                  padding: 6px 12px;
                  background: var(--gray-100);
                  border: 2px solid var(--gray-300);
                  border-radius: 0;
                  font-size: 11px;
                  font-weight: 600;
                  color: var(--gray-700);
                  cursor: pointer;
                  transition: all 0.15s ease;
                "
                onmouseover="this.style.borderColor='var(--gray-700)'"
                onmouseout="this.style.borderColor='var(--gray-300)'"
              >📸 Add Photo</button>
              <input
                type="file"
                id="photoInput_${taskRecord.id}"
                accept="image/*"
                capture="environment"
                style="display: none;"
                onchange="handleTaskPhotoUpload('${taskRecord.id}', '${fohSystemState.currentSession.id}', event)"
              />
              <div id="photoDisplay_${taskRecord.id}" style="margin-top: 8px;"></div>
            </div>
          </div>
        </div>
      `;
    });

    html += '</div></div>';
    return html;
  }

  /**
   * Render Rating Section
   */
  function renderRatingSection(section, sectionIndex) {
    const checklist = fohSystemState.currentChecklist;

    let html = `
      <div style="margin-bottom: 24px; background: white; border: 2px solid var(--gray-300); border-radius: 0; overflow: hidden;">
        <div style="background: var(--gray-700); color: white; padding: 14px 16px;">
          <h4 style="margin: 0 0 8px 0; font-size: 14px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;">
            ${section.name}
          </h4>
          ${checklist.ratingScale ? `
            <p style="margin: 0; font-size: 11px; opacity: 0.9;">
              ${checklist.ratingScale}
            </p>
          ` : ''}
        </div>

        <div style="padding: 16px;">
    `;

    section.categories.forEach((category, catIndex) => {
      const existingRating = fohSystemState.ratings.find(r => r.category_name === category.name);
      const currentRating = existingRating ? existingRating.rating : 3;

      html += `
        <div style="margin-bottom: 20px; padding: 16px; background: var(--gray-100); border-radius: 0;">
          <div style="margin-bottom: 12px;">
            <div style="font-size: 13px; font-weight: 700; color: var(--gray-900); margin-bottom: 4px;">
              ${category.name}
            </div>
            ${category.description ? `
              <div style="font-size: 12px; color: var(--gray-600);">
                ${category.description}
              </div>
            ` : ''}
          </div>

          <div style="display: flex; align-items: center; gap: 16px;">
            <div style="flex: 1;">
              <input
                type="range"
                min="1"
                max="5"
                value="${currentRating}"
                id="rating_${sectionIndex}_${catIndex}"
                style="width: 100%; height: 8px; cursor: pointer;"
                oninput="updateRatingDisplay('${sectionIndex}_${catIndex}', this.value)"
                onchange="autoSaveRating('${category.name}', this.value)"
              />
            </div>
            <div
              id="ratingValue_${sectionIndex}_${catIndex}"
              style="
                min-width: 60px;
                text-align: center;
                font-size: 24px;
                font-weight: 700;
                color: ${getRatingColor(currentRating)};
              "
            >${currentRating}</div>
          </div>

          <textarea
            id="ratingNotes_${sectionIndex}_${catIndex}"
            placeholder="Optional notes..."
            style="
              width: 100%;
              margin-top: 12px;
              padding: 10px;
              border: 2px solid var(--gray-300);
              border-radius: 0;
              font-size: 12px;
              font-family: inherit;
              box-sizing: border-box;
              resize: vertical;
              min-height: 60px;
            "
            onfocus="this.style.borderColor='var(--gray-700)'"
            onblur="this.style.borderColor='var(--gray-300)'; autoSaveRatingNotes('${category.name}', this.value);"
          >${existingRating ? (existingRating.notes || '') : ''}</textarea>
        </div>
      `;
    });

    html += '</div></div>';
    return html;
  }

  /**
   * Get Rating Color
   */
  function getRatingColor(rating) {
    if (rating <= 2) return '#dc2626'; // Red
    if (rating === 3) return '#f59e0b'; // Orange
    return '#059669'; // Green
  }

  /**
   * Update Rating Display
   */
  function updateRatingDisplay(id, value) {
    const display = document.getElementById(`ratingValue_${id}`);
    if (display) {
      display.textContent = value;
      display.style.color = getRatingColor(parseInt(value));
    }
  }

  /**
   * Toggle Task Completion - Auto-save to database
   */
  async function toggleTask(taskId) {
    const taskRecord = fohSystemState.tasks.find(t => t.id === taskId);
    if (!taskRecord) return;

    const newStatus = !taskRecord.is_completed;
    const staffName = fohSystemState.staffName;

    try {
      const updateData = {
        is_completed: newStatus,
        updated_at: new Date().toISOString()
      };

      if (newStatus) {
        updateData.completed_by = staffName;
        updateData.completed_at = new Date().toISOString();
      } else {
        updateData.unchecked_by = staffName;
        updateData.unchecked_at = new Date().toISOString();
      }

      const { error } = await supabase
        .from('foh_checklist_tasks')
        .update(updateData)
        .eq('id', taskId);

      if (error) throw error;

      // Update local state
      taskRecord.is_completed = newStatus;
      if (newStatus) {
        taskRecord.completed_by = staffName;
        taskRecord.completed_at = updateData.completed_at;
      }

      // Re-render checklist
      renderChecklist();

    } catch (error) {
      console.error('Error toggling task:', error);
      showMessage(`Error updating task: ${error.message}`, 'error');
    }
  }

  /**
   * Auto-save Rating
   */
  async function autoSaveRating(categoryName, ratingValue) {
    const sessionId = fohSystemState.currentSession.id;
    const checklistType = fohSystemState.currentChecklist.type;
    const staffName = fohSystemState.staffName;

    try {
      // Check if rating exists
      const existing = fohSystemState.ratings.find(r => r.category_name === categoryName);

      if (existing) {
        // Update existing rating
        const { error } = await supabase
          .from('foh_checklist_ratings')
          .update({
            rating: parseInt(ratingValue),
            rated_by: staffName,
            rated_at: new Date().toISOString()
          })
          .eq('id', existing.id);

        if (error) throw error;

        existing.rating = parseInt(ratingValue);
        existing.rated_by = staffName;
      } else {
        // Create new rating
        const ratingData = {
          session_id: sessionId,
          checklist_type: checklistType,
          category_name: categoryName,
          rating: parseInt(ratingValue),
          rated_by: staffName,
          rated_at: new Date().toISOString()
        };

        const { data, error } = await supabase
          .from('foh_checklist_ratings')
          .insert([ratingData])
          .select()
          .single();

        if (error) throw error;

        fohSystemState.ratings.push(data);
      }

      console.log(`✓ Rating saved: ${categoryName} = ${ratingValue}`);

    } catch (error) {
      console.error('Error saving rating:', error);
      showMessage(`Error saving rating: ${error.message}`, 'error');
    }
  }

  /**
   * Auto-save Rating Notes
   */
  async function autoSaveRatingNotes(categoryName, notes) {
    const existing = fohSystemState.ratings.find(r => r.category_name === categoryName);

    if (!existing) {
      console.log('Rating not yet created, notes will be saved when rating is set');
      return;
    }

    try {
      const { error } = await supabase
        .from('foh_checklist_ratings')
        .update({
          notes: notes.trim() || null
        })
        .eq('id', existing.id);

      if (error) throw error;

      existing.notes = notes.trim();
      console.log(`✓ Rating notes saved for: ${categoryName}`);

    } catch (error) {
      console.error('Error saving rating notes:', error);
    }
  }

  /**
   * Auto-save Session Notes
   */
  async function autoSaveNotes() {
    const notesInput = document.getElementById('fohSessionNotes');
    if (!notesInput) return;

    const notes = notesInput.value.trim();
    const sessionId = fohSystemState.currentSession.id;

    try {
      const { error } = await supabase
        .from('foh_checklist_sessions')
        .update({
          notes: notes || null,
          updated_at: new Date().toISOString()
        })
        .eq('id', sessionId);

      if (error) throw error;

      fohSystemState.currentSession.notes = notes;
      console.log('✓ Session notes saved');

    } catch (error) {
      console.error('Error saving session notes:', error);
    }
  }

  /**
   * Update Progress Counter
   */
  function updateProgress() {
    const progressDiv = document.getElementById('checklistProgress');
    if (!progressDiv) return;

    const completed = fohSystemState.tasks.filter(t => t.is_completed).length;
    const total = fohSystemState.tasks.length;

    progressDiv.textContent = `${completed} / ${total} Tasks`;
  }

  /**
   * Complete Checklist Session
   */
  async function completeChecklistSession() {
    const completed = fohSystemState.tasks.filter(t => t.is_completed).length;
    const total = fohSystemState.tasks.length;
    const percentComplete = total > 0 ? Math.round((completed / total) * 100) : 0;

    // Check required tasks
    const requiredTasks = fohSystemState.tasks.filter(t => t.is_required === true);
    const incompleteRequired = requiredTasks.filter(t => !t.is_completed);

    if (incompleteRequired.length > 0) {
      const taskList = incompleteRequired.map(t => `• ${t.task_text}`).join('\n');
      showMessage(
        `Cannot submit checklist!\n\n${incompleteRequired.length} required task(s) incomplete:\n${taskList}`,
        'error'
      );
      return; // Block submission
    }

    // Show warning if not 100% complete, but proceed anyway
    if (percentComplete < 100) {
      console.log(`⚠️ Submitting incomplete checklist: ${percentComplete}% completed`);
    }

    showLoading('Completing Checklist', 'Saving final data...');

    try {
      const sessionId = fohSystemState.currentSession.id;

      // Mark session as complete
      const { error } = await supabase
        .from('foh_checklist_sessions')
        .update({
          is_complete: true,
          completed_at: new Date().toISOString(),
          updated_at: new Date().toISOString()
        })
        .eq('id', sessionId);

      if (error) throw error;

      hideLoading();

      // Show success message
      const container = document.getElementById('fohWorkflowContent');
      container.innerHTML = `
        <div style="text-align: center; padding: 60px 20px;">
          <div style="font-size: 72px; margin-bottom: 24px;">✅</div>
          <h2 style="margin: 0 0 16px 0; font-size: 24px; font-weight: 700; color: var(--gray-900); text-transform: uppercase; letter-spacing: 1px;">
            Checklist Complete!
          </h2>
          <p style="margin: 0 0 32px 0; font-size: 16px; color: var(--gray-600);">
            ${fohSystemState.currentChecklist.title} completed by ${fohSystemState.staffName}${fohSystemState.staffName2 ? ` & ${fohSystemState.staffName2}` : ''}
          </p>
          <div style="display: inline-block; padding: 12px 24px; background: var(--success-bg); border-radius: 0; margin-bottom: 32px;">
            <div style="font-size: 14px; color: var(--success-text); font-weight: 700;">
              ${completed} / ${total} Tasks Completed (${percentComplete}%)
            </div>
          </div>
          <div>
            <button
              onclick="renderWorkflowSelector()"
              style="
                padding: 14px 32px;
                background: var(--gray-900);
                color: white;
                border: 2px solid var(--gray-900);
                border-radius: 0;
                font-size: 13px;
                font-weight: 700;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                cursor: pointer;
                transition: all 0.15s ease;
              "
              onmouseover="this.style.background='#000'"
              onmouseout="this.style.background='var(--gray-900)'"
            >START NEW CHECKLIST</button>
          </div>
        </div>
      `;

    } catch (error) {
      hideLoading();
      console.error('Error completing checklist:', error);
      showMessage(`Error completing checklist: ${error.message}`, 'error');
    }
  }

  /**
   * Confirm Cancel Checklist
   */
  function confirmCancelChecklist() {
    // Cancel button styling is sufficient warning - proceed directly
    console.log('✅ Checklist cancelled - returning to workflow selector');
    renderWorkflowSelector();
  }

  /**
   * Prompt for Username - Shows modal when localStorage is empty
   */
  function promptForUsername() {
    const modal = document.createElement('div');
    modal.id = 'usernameModal';
    modal.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      padding: 20px;
    `;

    const modalContent = document.createElement('div');
    modalContent.style.cssText = `
      background: white;
      padding: 32px;
      max-width: 400px;
      width: 100%;
      border: 3px solid var(--gray-700);
      border-radius: 0;
    `;

    modalContent.innerHTML = `
      <h3 style="margin: 0 0 12px 0; font-size: 18px; font-weight: 700; color: var(--gray-900); text-transform: uppercase; letter-spacing: 1px;">
        Enter Your Name
      </h3>
      <p style="margin: 0 0 20px 0; font-size: 13px; color: var(--gray-600);">
        Please enter your name to continue working on this checklist
      </p>
      <input
        type="text"
        id="usernameInput"
        placeholder="Enter your name"
        style="
          width: 100%;
          padding: 14px;
          border: 2px solid var(--gray-300);
          border-radius: 0;
          font-size: 14px;
          margin-bottom: 20px;
          box-sizing: border-box;
        "
      />
      <div style="display: flex; gap: 12px;">
        <button
          id="usernameCancelBtn"
          style="
            flex: 1;
            padding: 14px 24px;
            background: var(--gray-100);
            color: var(--gray-900);
            border: 2px solid var(--gray-300);
            border-radius: 0;
            font-size: 13px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            transition: all 0.15s ease;
          "
        >CANCEL</button>
        <button
          id="usernameSubmitBtn"
          style="
            flex: 1;
            padding: 14px 24px;
            background: var(--gray-900);
            color: white;
            border: 2px solid var(--gray-900);
            border-radius: 0;
            font-size: 13px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            transition: all 0.15s ease;
          "
        >CONTINUE</button>
      </div>
    `;

    modal.appendChild(modalContent);
    document.body.appendChild(modal);

    const usernameInput = document.getElementById('usernameInput');
    const submitBtn = document.getElementById('usernameSubmitBtn');
    const cancelBtn = document.getElementById('usernameCancelBtn');

    // Focus username input
    setTimeout(() => usernameInput.focus(), 100);

    // Handle submit
    const handleSubmit = () => {
      const username = usernameInput.value.trim();
      if (!username) {
        showMessage('Please enter your name!', 'error');
        usernameInput.focus();
        return;
      }

      // Save to localStorage and update state
      localStorage.setItem('foh_username', username);
      fohSystemState.staffName = username;

      // Remove modal
      document.body.removeChild(modal);

      // Render checklist
      renderChecklist();
    };

    // Handle cancel
    const handleCancel = () => {
      document.body.removeChild(modal);
      renderWorkflowSelector();
    };

    submitBtn.onclick = handleSubmit;
    cancelBtn.onclick = handleCancel;
    usernameInput.onkeypress = (e) => {
      if (e.key === 'Enter') {
        handleSubmit();
      }
    };

    // Click outside to close
    modal.onclick = (e) => {
      if (e.target === modal) {
        handleCancel();
      }
    };
  }

  /**
   * Change Username - Allows changing username mid-session
   */
  function changeUsername() {
    const currentUsername = fohSystemState.staffName || '';

    const modal = document.createElement('div');
    modal.id = 'changeUsernameModal';
    modal.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      padding: 20px;
    `;

    const modalContent = document.createElement('div');
    modalContent.style.cssText = `
      background: white;
      padding: 32px;
      max-width: 400px;
      width: 100%;
      border: 3px solid var(--gray-700);
      border-radius: 0;
    `;

    modalContent.innerHTML = `
      <h3 style="margin: 0 0 12px 0; font-size: 18px; font-weight: 700; color: var(--gray-900); text-transform: uppercase; letter-spacing: 1px;">
        Change Your Name
      </h3>
      <p style="margin: 0 0 20px 0; font-size: 13px; color: var(--gray-600);">
        Update your name for future checklist actions
      </p>
      <input
        type="text"
        id="newUsernameInput"
        value="${currentUsername}"
        placeholder="Enter your name"
        style="
          width: 100%;
          padding: 14px;
          border: 2px solid var(--gray-300);
          border-radius: 0;
          font-size: 14px;
          margin-bottom: 20px;
          box-sizing: border-box;
        "
      />
      <div style="display: flex; gap: 12px;">
        <button
          id="changeUsernameCancelBtn"
          style="
            flex: 1;
            padding: 14px 24px;
            background: var(--gray-100);
            color: var(--gray-900);
            border: 2px solid var(--gray-300);
            border-radius: 0;
            font-size: 13px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            transition: all 0.15s ease;
          "
        >CANCEL</button>
        <button
          id="changeUsernameSubmitBtn"
          style="
            flex: 1;
            padding: 14px 24px;
            background: var(--gray-900);
            color: white;
            border: 2px solid var(--gray-900);
            border-radius: 0;
            font-size: 13px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            transition: all 0.15s ease;
          "
        >SAVE</button>
      </div>
    `;

    modal.appendChild(modalContent);
    document.body.appendChild(modal);

    const usernameInput = document.getElementById('newUsernameInput');
    const submitBtn = document.getElementById('changeUsernameSubmitBtn');
    const cancelBtn = document.getElementById('changeUsernameCancelBtn');

    // Focus and select input
    setTimeout(() => {
      usernameInput.focus();
      usernameInput.select();
    }, 100);

    // Handle submit
    const handleSubmit = () => {
      const newUsername = usernameInput.value.trim();
      if (!newUsername) {
        showMessage('Please enter your name!', 'error');
        usernameInput.focus();
        return;
      }

      // Save to localStorage and update state
      localStorage.setItem('foh_username', newUsername);
      fohSystemState.staffName = newUsername;

      // Remove modal
      document.body.removeChild(modal);

      // Re-render checklist to show new name
      renderChecklist();

      showMessage(`Name updated to: ${newUsername}`, 'success');
    };

    // Handle cancel
    const handleCancel = () => {
      document.body.removeChild(modal);
    };

    submitBtn.onclick = handleSubmit;
    cancelBtn.onclick = handleCancel;
    usernameInput.onkeypress = (e) => {
      if (e.key === 'Enter') {
        handleSubmit();
      }
    };

    // Click outside to close
    modal.onclick = (e) => {
      if (e.target === modal) {
        handleCancel();
      }
    };
  }

  /**
   * Open Manager Edit - Requires password
   */
  function openFOHManagerEdit(evt) {
    requirePasswordFor('FOH Checklist Editor', () => {
      openFOHTab(evt, 'fohEdit');
      loadManagerEditor();
    });
  }

  /**
   * Load Manager Editor - Checklist editing interface
   */
  async function loadManagerEditor() {
    const container = document.getElementById('fohEditContent');

    showLoading('Loading Checklists', 'Fetching checklist definitions...');

    // Get all checklist types from database (with fallback)
    const checklistTypes = await loadAllChecklistsFromDatabase();

    // Load basic info for each checklist
    const checklists = {};
    for (const type of checklistTypes) {
      checklists[type] = await loadChecklistFromDatabase(type);
    }

    hideLoading();

    let html = `
      <div style="margin-bottom: 24px; padding: 20px; background: var(--blue-bg); border-left: 4px solid var(--blue-text); border-radius: 0;">
        <h3 style="margin: 0 0 8px 0; font-size: 16px; font-weight: 700; color: var(--blue-text); text-transform: uppercase; letter-spacing: 1px;">
          ⚙️ CHECKLIST EDITOR
        </h3>
        <p style="margin: 0; font-size: 13px; color: var(--blue-text); line-height: 1.6;">
          Edit checklist definitions, add/remove tasks, modify time ranges, and manage all checklist settings.
        </p>
      </div>

      <!-- CREATE NEW CHECKLIST BUTTON -->
      <div style="margin-bottom: 24px;">
        <div
          style="
            background: var(--success-bg);
            border: 2px solid var(--success-border);
            padding: 20px;
            cursor: pointer;
            transition: all 0.15s ease;
            border-radius: 0;
            text-align: center;
          "
          onmouseover="this.style.background='#a7f3d0'; this.style.borderColor='#047857';"
          onmouseout="this.style.background='var(--success-bg)'; this.style.borderColor='var(--success-border)';"
          onclick="createNewChecklist()"
        >
          <h4 style="margin: 0 0 8px 0; font-size: 18px; font-weight: 700; color: var(--success-text); text-transform: uppercase; letter-spacing: 1px;">
            ➕ CREATE NEW CHECKLIST
          </h4>
          <p style="margin: 0; font-size: 13px; color: var(--success-text);">
            Add a new custom checklist to the system
          </p>
        </div>
      </div>

      <div style="display: grid; gap: 16px; margin-bottom: 24px;">
    `;

    checklistTypes.forEach(type => {
      const checklist = checklists[type];

      html += `
        <div style="
          background: white;
          border: 2px solid var(--gray-300);
          padding: 20px;
          cursor: pointer;
          transition: all 0.15s ease;
          border-radius: 0;
        "
        onmouseover="this.style.borderColor='var(--gray-700)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)';"
        onmouseout="this.style.borderColor='var(--gray-300)'; this.style.boxShadow='none';"
        onclick="editChecklist('${type}')">

          <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 12px; margin-bottom: 12px;">
            <div style="flex: 1;">
              <h4 style="margin: 0 0 8px 0; font-size: 16px; font-weight: 700; color: var(--gray-900); text-transform: uppercase; letter-spacing: 1px;">
                ${checklist.title}
              </h4>
              <p style="margin: 0 0 8px 0; font-size: 13px; color: var(--gray-600); line-height: 1.5;">
                ${checklist.description}
              </p>
              <div style="display: flex; gap: 16px; flex-wrap: wrap; font-size: 12px; color: var(--gray-500);">
                <span>🕒 ${checklist.timeRange}</span>
                <span>👥 ${checklist.staffCount} Staff</span>
                <span>📋 ${checklist.sections.length} Sections</span>
                ${checklist.hasRatings ? '<span>⭐ Ratings</span>' : ''}
                ${checklist.hasNotes ? '<span>📝 Notes</span>' : ''}
              </div>
            </div>
            <div>
              <button
                style="
                  padding: 10px 20px;
                  background: var(--gray-900);
                  color: white;
                  border: 2px solid var(--gray-900);
                  border-radius: 0;
                  font-size: 11px;
                  font-weight: 700;
                  text-transform: uppercase;
                  letter-spacing: 0.5px;
                  cursor: pointer;
                  transition: all 0.15s ease;
                "
                onmouseover="this.style.background='#000'"
                onmouseout="this.style.background='var(--gray-900)'"
              >✏️ EDIT</button>
            </div>
          </div>
        </div>
      `;
    });

    html += `
      </div>
    `;

    container.innerHTML = html;
  }

  /**
   * Create New Checklist - Show empty form for creating custom checklist
   */
  function createNewChecklist() {
    // Generate new checklist type ID
    const customNumber = Math.floor(Date.now() / 1000); // Unix timestamp
    const newChecklistType = `custom_${customNumber}`;

    // Create empty checklist object
    const newChecklist = {
      type: newChecklistType,
      title: 'New Custom Checklist',
      timeRange: '9:00 AM - 5:00 PM',
      description: 'Enter description here',
      staffCount: 1,
      hasRatings: false,
      hasNotes: true,
      ratingScale: '',
      start_hour: 9,
      start_minute: 0,
      end_hour: 17,
      end_minute: 0,
      sections: [
        {
          name: 'Section 1',
          description: '',
          type: 'checkbox',
          tasks: [
            { text: 'Task 1', is_required: false }
          ]
        }
      ]
    };

    // Call editChecklist with the new checklist
    editChecklist(newChecklistType, newChecklist);
  }

  /**
   * Edit Checklist - Show detailed editor for specific checklist
   * @param {string} checklistType - The checklist type ID
   * @param {object} providedChecklist - Optional: Pre-loaded checklist (for new checklists)
   */
  async function editChecklist(checklistType, providedChecklist = null) {
    let checklist;

    if (providedChecklist) {
      // Use provided checklist (for new checklists)
      checklist = providedChecklist;
    } else {
      // Load from database
      showLoading('Loading Checklist', 'Fetching checklist data...');
      checklist = await loadChecklistFromDatabase(checklistType);
      hideLoading();

      if (!checklist) return;
    }

    const container = document.getElementById('fohEditContent');

    let html = `
      <!-- Header with Back Button -->
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3 style="margin: 0; font-size: 18px; font-weight: 700; color: var(--gray-900); text-transform: uppercase; letter-spacing: 1px;">
          ✏️ EDITING: ${checklist.title}
        </h3>
        <button
          onclick="loadManagerEditor()"
          style="
            padding: 10px 20px;
            background: var(--gray-100);
            color: var(--gray-900);
            border: 2px solid var(--gray-300);
            border-radius: 0;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            transition: all 0.15s ease;
          "
          onmouseover="this.style.background='var(--gray-200)'"
          onmouseout="this.style.background='var(--gray-100)'"
        >← BACK TO LIST</button>
      </div>

      <!-- Basic Info Section -->
      <div style="margin-bottom: 24px; background: white; border: 2px solid var(--gray-300); border-radius: 0; overflow: hidden;">
        <div style="background: var(--gray-700); color: white; padding: 14px 16px;">
          <h4 style="margin: 0; font-size: 14px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;">
            📋 BASIC INFORMATION
          </h4>
        </div>
        <div style="padding: 20px;">
          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 8px; font-size: 11px; font-weight: 700; color: var(--gray-700); text-transform: uppercase; letter-spacing: 0.5px;">
              Checklist Title
            </label>
            <input
              type="text"
              id="edit_title"
              value="${checklist.title}"
              style="
                width: 100%;
                padding: 12px;
                border: 2px solid var(--gray-300);
                border-radius: 0;
                font-size: 14px;
                box-sizing: border-box;
              "
              onfocus="this.style.borderColor='var(--gray-700)'"
              onblur="this.style.borderColor='var(--gray-300)'"
            />
          </div>

          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 8px; font-size: 11px; font-weight: 700; color: var(--gray-700); text-transform: uppercase; letter-spacing: 0.5px;">
              Description
            </label>
            <textarea
              id="edit_description"
              style="
                width: 100%;
                min-height: 80px;
                padding: 12px;
                border: 2px solid var(--gray-300);
                border-radius: 0;
                font-size: 13px;
                font-family: inherit;
                box-sizing: border-box;
                resize: vertical;
              "
              onfocus="this.style.borderColor='var(--gray-700)'"
              onblur="this.style.borderColor='var(--gray-300)'"
            >${checklist.description}</textarea>
          </div>

          <!-- Time Range Settings -->
          <div style="margin-bottom: 20px; padding: 16px; background: var(--gray-100); border-left: 3px solid var(--gray-700); border-radius: 0;">
            <h5 style="margin: 0 0 12px 0; font-size: 12px; font-weight: 700; color: var(--gray-700); text-transform: uppercase; letter-spacing: 0.5px;">
              ⏰ AVAILABILITY TIME RANGE
            </h5>
            <p style="margin: 0 0 12px 0; font-size: 11px; color: var(--gray-600);">
              Controls when staff can access this checklist
            </p>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
              <!-- Start Time -->
              <div>
                <label style="display: block; margin-bottom: 8px; font-size: 11px; font-weight: 700; color: var(--gray-700); text-transform: uppercase; letter-spacing: 0.5px;">
                  Start Time
                </label>
                <div style="display: flex; gap: 8px;">
                  <input
                    type="number"
                    id="edit_startHour"
                    value="${checklist.start_hour !== undefined ? checklist.start_hour : 9}"
                    min="0"
                    max="23"
                    placeholder="Hour"
                    style="
                      flex: 1;
                      padding: 12px;
                      border: 2px solid var(--gray-300);
                      border-radius: 0;
                      font-size: 14px;
                      box-sizing: border-box;
                    "
                    onfocus="this.style.borderColor='var(--gray-700)'"
                    onblur="this.style.borderColor='var(--gray-300)'"
                  />
                  <span style="padding: 12px 8px; font-size: 14px; font-weight: 700;">:</span>
                  <input
                    type="number"
                    id="edit_startMinute"
                    value="${checklist.start_minute !== undefined ? checklist.start_minute : 0}"
                    min="0"
                    max="59"
                    placeholder="Min"
                    style="
                      flex: 1;
                      padding: 12px;
                      border: 2px solid var(--gray-300);
                      border-radius: 0;
                      font-size: 14px;
                      box-sizing: border-box;
                    "
                    onfocus="this.style.borderColor='var(--gray-700)'"
                    onblur="this.style.borderColor='var(--gray-300)'"
                  />
                </div>
                <p style="margin: 4px 0 0 0; font-size: 10px; color: var(--gray-500);">24-hour format (e.g., 9:00)</p>
              </div>

              <!-- End Time -->
              <div>
                <label style="display: block; margin-bottom: 8px; font-size: 11px; font-weight: 700; color: var(--gray-700); text-transform: uppercase; letter-spacing: 0.5px;">
                  End Time
                </label>
                <div style="display: flex; gap: 8px;">
                  <input
                    type="number"
                    id="edit_endHour"
                    value="${checklist.end_hour !== undefined ? checklist.end_hour : 17}"
                    min="0"
                    max="24"
                    placeholder="Hour"
                    style="
                      flex: 1;
                      padding: 12px;
                      border: 2px solid var(--gray-300);
                      border-radius: 0;
                      font-size: 14px;
                      box-sizing: border-box;
                    "
                    onfocus="this.style.borderColor='var(--gray-700)'"
                    onblur="this.style.borderColor='var(--gray-300)'"
                  />
                  <span style="padding: 12px 8px; font-size: 14px; font-weight: 700;">:</span>
                  <input
                    type="number"
                    id="edit_endMinute"
                    value="${checklist.end_minute !== undefined ? checklist.end_minute : 0}"
                    min="0"
                    max="59"
                    placeholder="Min"
                    style="
                      flex: 1;
                      padding: 12px;
                      border: 2px solid var(--gray-300);
                      border-radius: 0;
                      font-size: 14px;
                      box-sizing: border-box;
                    "
                    onfocus="this.style.borderColor='var(--gray-700)'"
                    onblur="this.style.borderColor='var(--gray-300)'"
                  />
                </div>
                <p style="margin: 4px 0 0 0; font-size: 10px; color: var(--gray-500);">24-hour format (e.g., 17:00)</p>
              </div>
            </div>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
            <div>
              <label style="display: block; margin-bottom: 8px; font-size: 11px; font-weight: 700; color: var(--gray-700); text-transform: uppercase; letter-spacing: 0.5px;">
                Time Range Display (for staff)
              </label>
              <input
                type="text"
                id="edit_timeRange"
                value="${checklist.timeRange}"
                placeholder="e.g., 9:00 AM - 5:00 PM"
                style="
                  width: 100%;
                  padding: 12px;
                  border: 2px solid var(--gray-300);
                  border-radius: 0;
                  font-size: 14px;
                  box-sizing: border-box;
                "
                onfocus="this.style.borderColor='var(--gray-700)'"
                onblur="this.style.borderColor='var(--gray-300)'"
              />
              <p style="margin: 4px 0 0 0; font-size: 10px; color: var(--gray-500);">Display text only, not actual time logic</p>
            </div>
            <div>
              <label style="display: block; margin-bottom: 8px; font-size: 11px; font-weight: 700; color: var(--gray-700); text-transform: uppercase; letter-spacing: 0.5px;">
                Staff Count
              </label>
              <input
                type="number"
                id="edit_staffCount"
                value="${checklist.staffCount}"
                min="1"
                max="10"
                style="
                  width: 100%;
                  padding: 12px;
                  border: 2px solid var(--gray-300);
                  border-radius: 0;
                  font-size: 14px;
                  box-sizing: border-box;
                "
                onfocus="this.style.borderColor='var(--gray-700)'"
                onblur="this.style.borderColor='var(--gray-300)'"
              />
            </div>
          </div>

          <div style="display: flex; gap: 24px; margin-bottom: 20px;">
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input
                type="checkbox"
                id="edit_hasRatings"
                ${checklist.hasRatings ? 'checked' : ''}
                style="width: 20px; height: 20px; cursor: pointer;"
              />
              <span style="font-size: 13px; font-weight: 600; color: var(--gray-700);">Has Ratings</span>
            </label>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input
                type="checkbox"
                id="edit_hasNotes"
                ${checklist.hasNotes ? 'checked' : ''}
                style="width: 20px; height: 20px; cursor: pointer;"
              />
              <span style="font-size: 13px; font-weight: 600; color: var(--gray-700);">Has Notes Section</span>
            </label>
          </div>

          ${checklist.hasRatings ? `
            <div style="margin-bottom: 20px;">
              <label style="display: block; margin-bottom: 8px; font-size: 11px; font-weight: 700; color: var(--gray-700); text-transform: uppercase; letter-spacing: 0.5px;">
                Rating Scale Description
              </label>
              <input
                type="text"
                id="edit_ratingScale"
                value="${checklist.ratingScale || ''}"
                placeholder="e.g., 1 – MAJOR ISSUES | 3 – ACCEPTABLE | 5 – GUEST-READY"
                style="
                  width: 100%;
                  padding: 12px;
                  border: 2px solid var(--gray-300);
                  border-radius: 0;
                  font-size: 14px;
                  box-sizing: border-box;
                "
                onfocus="this.style.borderColor='var(--gray-700)'"
                onblur="this.style.borderColor='var(--gray-300)'"
              />
            </div>
          ` : ''}
        </div>
      </div>

      <!-- Sections Editor -->
      <div id="sectionsEditor"></div>

      <!-- Save Button -->
      <div style="margin-top: 32px; display: flex; gap: 12px; justify-content: flex-end;">
        <button
          onclick="loadManagerEditor()"
          style="
            padding: 14px 32px;
            background: var(--gray-100);
            color: var(--gray-900);
            border: 2px solid var(--gray-300);
            border-radius: 0;
            font-size: 13px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            transition: all 0.15s ease;
          "
          onmouseover="this.style.background='var(--gray-200)'"
          onmouseout="this.style.background='var(--gray-100)'"
        >CANCEL</button>

        <button
          onclick="saveChecklistChanges('${checklistType}')"
          style="
            padding: 14px 32px;
            background: var(--success-border);
            color: white;
            border: 2px solid var(--success-border);
            border-radius: 0;
            font-size: 13px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            transition: all 0.15s ease;
          "
          onmouseover="this.style.background='#047857'"
          onmouseout="this.style.background='var(--success-border)'"
        >💾 SAVE CHANGES</button>
      </div>
    `;

    container.innerHTML = html;

    // Render sections editor
    renderSectionsEditor(checklist);
  }

  /**
   * Render Sections Editor
   */
  function renderSectionsEditor(checklist) {
    const container = document.getElementById('sectionsEditor');

    let html = `
      <div style="margin-bottom: 24px; background: white; border: 2px solid var(--gray-300); border-radius: 0; overflow: hidden;">
        <div style="background: var(--gray-700); color: white; padding: 14px 16px; display: flex; justify-content: space-between; align-items: center;">
          <h4 style="margin: 0; font-size: 14px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;">
            📑 SECTIONS & TASKS
          </h4>
          <button
            onclick="addNewSection('${checklist.type}')"
            style="
              padding: 8px 16px;
              background: var(--success-border);
              color: white;
              border: 2px solid var(--success-border);
              border-radius: 0;
              font-size: 10px;
              font-weight: 700;
              text-transform: uppercase;
              letter-spacing: 0.5px;
              cursor: pointer;
              transition: all 0.15s ease;
            "
            onmouseover="this.style.background='#047857'"
            onmouseout="this.style.background='var(--success-border)'"
          >➕ ADD SECTION</button>
        </div>
        <div id="sections_container" style="padding: 20px;">
    `;

    checklist.sections.forEach((section, sectionIndex) => {
      html += `
        <div id="section_${sectionIndex}" style="margin-bottom: 24px; padding: 16px; background: var(--gray-100); border-left: 3px solid var(--gray-700); border-radius: 0;">
          <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px;">
            <div style="flex: 1;">
              <input
                type="text"
                id="section_name_${sectionIndex}"
                value="${section.name}"
                placeholder="Section Name"
                style="
                  width: 100%;
                  padding: 10px;
                  border: 2px solid var(--gray-300);
                  border-radius: 0;
                  font-size: 14px;
                  font-weight: 700;
                  margin-bottom: 8px;
                  box-sizing: border-box;
                "
                onfocus="this.style.borderColor='var(--gray-700)'"
                onblur="this.style.borderColor='var(--gray-300)'"
              />
              ${section.description ? `
                <input
                  type="text"
                  id="section_desc_${sectionIndex}"
                  value="${section.description}"
                  placeholder="Section Description (optional)"
                  style="
                    width: 100%;
                    padding: 10px;
                    border: 2px solid var(--gray-300);
                    border-radius: 0;
                    font-size: 13px;
                    box-sizing: border-box;
                  "
                  onfocus="this.style.borderColor='var(--gray-700)'"
                  onblur="this.style.borderColor='var(--gray-300)'"
                />
              ` : ''}
              <select
                id="section_type_${sectionIndex}"
                style="
                  width: 100%;
                  padding: 10px;
                  border: 2px solid var(--gray-300);
                  border-radius: 0;
                  font-size: 13px;
                  margin-top: 8px;
                  box-sizing: border-box;
                "
              >
                <option value="checkbox" ${section.type === 'checkbox' ? 'selected' : ''}>Checkbox Tasks</option>
                <option value="rating" ${section.type === 'rating' ? 'selected' : ''}>Rating Categories</option>
              </select>
            </div>
            <button
              onclick="deleteSection(${sectionIndex})"
              style="
                margin-left: 12px;
                padding: 8px 12px;
                background: #dc2626;
                color: white;
                border: 2px solid #dc2626;
                border-radius: 0;
                font-size: 10px;
                font-weight: 700;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                cursor: pointer;
                transition: all 0.15s ease;
              "
              onmouseover="this.style.background='#b91c1c'"
              onmouseout="this.style.background='#dc2626'"
            >🗑️ DELETE</button>
          </div>

          <div id="section_items_${sectionIndex}">
      `;

      if (section.type === 'checkbox' && section.tasks) {
        html += `
          <div style="margin-bottom: 12px;">
            <label style="display: block; margin-bottom: 8px; font-size: 10px; font-weight: 700; color: var(--gray-600); text-transform: uppercase; letter-spacing: 0.5px;">
              ✅ TASKS
            </label>
        `;

        // Display each task as a separate row with required checkbox
        section.tasks.forEach((task, taskIndex) => {
          // Handle both string format (legacy) and object format (new)
          const taskText = typeof task === 'string' ? task : task.text;
          const isRequired = typeof task === 'object' ? (task.is_required || false) : false;

          html += `
            <div style="display: flex; gap: 8px; margin-bottom: 8px; align-items: center;">
              <input
                type="text"
                id="task_text_${sectionIndex}_${taskIndex}"
                value="${taskText}"
                placeholder="Task description"
                style="
                  flex: 1;
                  padding: 10px;
                  border: 2px solid var(--gray-300);
                  border-radius: 0;
                  font-size: 13px;
                  box-sizing: border-box;
                "
                onfocus="this.style.borderColor='var(--gray-700)'"
                onblur="this.style.borderColor='var(--gray-300)'"
              />
              <label style="
                display: flex;
                align-items: center;
                gap: 6px;
                padding: 8px 12px;
                background: var(--gray-100);
                border: 2px solid var(--gray-300);
                border-radius: 0;
                font-size: 11px;
                font-weight: 600;
                white-space: nowrap;
                cursor: pointer;
              ">
                <input
                  type="checkbox"
                  id="task_required_${sectionIndex}_${taskIndex}"
                  ${isRequired ? 'checked' : ''}
                  style="cursor: pointer;"
                />
                REQUIRED
              </label>
              <button
                onclick="deleteTask(${sectionIndex}, ${taskIndex})"
                style="
                  padding: 10px 12px;
                  background: #dc2626;
                  color: white;
                  border: 2px solid #dc2626;
                  border-radius: 0;
                  font-size: 11px;
                  font-weight: 700;
                  cursor: pointer;
                  transition: all 0.15s ease;
                "
                onmouseover="this.style.background='#b91c1c'"
                onmouseout="this.style.background='#dc2626'"
              >✕</button>
            </div>
          `;
        });

        html += `
            <button
              onclick="addTask(${sectionIndex})"
              style="
                margin-top: 8px;
                padding: 10px 16px;
                background: var(--gray-100);
                color: var(--gray-700);
                border: 2px solid var(--gray-300);
                border-radius: 0;
                font-size: 11px;
                font-weight: 700;
                text-transform: uppercase;
                cursor: pointer;
                transition: all 0.15s ease;
              "
              onmouseover="this.style.borderColor='var(--gray-700)'"
              onmouseout="this.style.borderColor='var(--gray-300)'"
            >➕ ADD TASK</button>
          </div>
        `;
      } else if (section.type === 'rating' && section.categories) {
        html += `
          <div style="margin-bottom: 12px;">
            <label style="display: block; margin-bottom: 8px; font-size: 10px; font-weight: 700; color: var(--gray-600); text-transform: uppercase; letter-spacing: 0.5px;">
              ⭐ Rating Categories
            </label>
        `;

        section.categories.forEach((cat, catIndex) => {
          html += `
            <div style="display: flex; gap: 8px; margin-bottom: 8px;">
              <input
                type="text"
                id="cat_name_${sectionIndex}_${catIndex}"
                value="${cat.name}"
                placeholder="Category Name"
                style="
                  flex: 1;
                  padding: 10px;
                  border: 2px solid var(--gray-300);
                  border-radius: 0;
                  font-size: 13px;
                  box-sizing: border-box;
                "
                onfocus="this.style.borderColor='var(--gray-700)'"
                onblur="this.style.borderColor='var(--gray-300)'"
              />
              <input
                type="text"
                id="cat_desc_${sectionIndex}_${catIndex}"
                value="${cat.description || ''}"
                placeholder="Description (optional)"
                style="
                  flex: 1;
                  padding: 10px;
                  border: 2px solid var(--gray-300);
                  border-radius: 0;
                  font-size: 13px;
                  box-sizing: border-box;
                "
                onfocus="this.style.borderColor='var(--gray-700)'"
                onblur="this.style.borderColor='var(--gray-300)'"
              />
              <button
                onclick="deleteCategory(${sectionIndex}, ${catIndex})"
                style="
                  padding: 10px 12px;
                  background: #dc2626;
                  color: white;
                  border: 2px solid #dc2626;
                  border-radius: 0;
                  font-size: 11px;
                  font-weight: 700;
                  cursor: pointer;
                  transition: all 0.15s ease;
                "
                onmouseover="this.style.background='#b91c1c'"
                onmouseout="this.style.background='#dc2626'"
              >✕</button>
            </div>
          `;
        });

        html += `
            <button
              onclick="addCategory(${sectionIndex})"
              style="
                margin-top: 8px;
                padding: 8px 16px;
                background: var(--gray-700);
                color: white;
                border: 2px solid var(--gray-700);
                border-radius: 0;
                font-size: 11px;
                font-weight: 700;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                cursor: pointer;
                transition: all 0.15s ease;
              "
              onmouseover="this.style.background='#000'"
              onmouseout="this.style.background='var(--gray-700)'"
            >➕ ADD CATEGORY</button>
          </div>
        `;
      }

      html += `
          </div>
        </div>
      `;
    });

    html += `
        </div>
      </div>
    `;

    container.innerHTML = html;
  }

  /**
   * Save Checklist Changes - Persist all edits to database
   */
  async function saveChecklistChanges(checklistType) {
    try {
      // Load current checklist to get sections structure
      const currentChecklist = await loadChecklistFromDatabase(checklistType);
      if (!currentChecklist) {
        showMessage('Error: Could not load current checklist', 'error');
        return;
      }

      // Collect basic info from form
      const title = document.getElementById('edit_title')?.value.trim();
      const description = document.getElementById('edit_description')?.value.trim();
      const timeRange = document.getElementById('edit_timeRange')?.value.trim();
      const staffCount = parseInt(document.getElementById('edit_staffCount')?.value) || 1;
      const hasRatings = document.getElementById('edit_hasRatings')?.checked || false;
      const hasNotes = document.getElementById('edit_hasNotes')?.checked || false;
      const ratingScale = document.getElementById('edit_ratingScale')?.value.trim() || null;

      // Collect time range values (actual availability logic)
      const startHour = parseInt(document.getElementById('edit_startHour')?.value);
      const startMinute = parseInt(document.getElementById('edit_startMinute')?.value) || 0;
      const endHour = parseInt(document.getElementById('edit_endHour')?.value);
      const endMinute = parseInt(document.getElementById('edit_endMinute')?.value) || 0;

      // Validate required fields
      if (!title || !description || !timeRange) {
        showMessage('Please fill in all required fields (Title, Description, Time Range)', 'error');
        return;
      }

      // Collect all sections data
      const sections = [];
      currentChecklist.sections.forEach((section, sectionIndex) => {
        const sectionName = document.getElementById(`section_name_${sectionIndex}`)?.value.trim();
        const sectionDesc = document.getElementById(`section_desc_${sectionIndex}`)?.value.trim() || '';
        const sectionType = document.getElementById(`section_type_${sectionIndex}`)?.value;

        if (!sectionName) return; // Skip unnamed sections

        const sectionObj = {
          name: sectionName,
          description: sectionDesc,
          type: sectionType
        };

        if (sectionType === 'checkbox') {
          // Collect tasks (text + required flag)
          const tasks = [];
          let taskIndex = 0;
          while (document.getElementById(`task_text_${sectionIndex}_${taskIndex}`)) {
            const taskText = document.getElementById(`task_text_${sectionIndex}_${taskIndex}`)?.value.trim();
            const isRequired = document.getElementById(`task_required_${sectionIndex}_${taskIndex}`)?.checked || false;

            if (taskText) {
              tasks.push({
                text: taskText,
                is_required: isRequired
              });
            }

            taskIndex++;
          }
          sectionObj.tasks = tasks;

        } else if (sectionType === 'rating') {
          // Collect categories (name + description pairs)
          const categories = [];
          let catIndex = 0;
          while (document.getElementById(`cat_name_${sectionIndex}_${catIndex}`)) {
            const catName = document.getElementById(`cat_name_${sectionIndex}_${catIndex}`)?.value.trim();
            const catDesc = document.getElementById(`cat_desc_${sectionIndex}_${catIndex}`)?.value.trim() || '';

            if (catName) {
              categories.push({
                name: catName,
                description: catDesc
              });
            }

            catIndex++;
          }
          sectionObj.categories = categories;
        }

        sections.push(sectionObj);
      });

      // Validate at least one section
      if (sections.length === 0) {
        showMessage('Checklist must have at least one section!', 'error');
        return;
      }

      // Build checklist data object
      const checklistData = {
        title,
        description,
        timeRange,
        staffCount,
        hasRatings,
        hasNotes,
        ratingScale,
        start_hour: startHour,
        start_minute: startMinute,
        end_hour: endHour,
        end_minute: endMinute,
        sections
      };

      // Save to database
      await saveChecklistToDatabase(checklistType, checklistData);

      showMessage('✅ Checklist saved successfully to database!', 'success');

      // Reload editor after brief delay
      setTimeout(() => {
        loadManagerEditor();
      }, 1500);

    } catch (error) {
      console.error('Error saving checklist:', error);
      showMessage(`Error saving checklist: ${error.message}`, 'error');
    }
  }

  /**
   * Placeholder functions for dynamic section/task management
   */
  function addNewSection(checklistType) {
    showMessage('Add Section feature coming soon!', 'info');
  }

  function deleteSection(index) {
    showMessage('Delete Section feature coming soon!', 'info');
  }

  function addCategory(sectionIndex) {
    showMessage('Add Category feature coming soon!', 'info');
  }

  function deleteCategory(sectionIndex, catIndex) {
    showMessage('Delete Category feature coming soon!', 'info');
  }

  /**
   * Add Task - Add a new task row to a section
   */
  function addTask(sectionIndex) {
    showMessage('Add Task feature coming soon! Please save and reload to see new tasks.', 'info');
    // NOTE: For now, users should use the regular flow - edit task text and save
    // A future enhancement could dynamically inject new task rows without reload
  }

  /**
   * Delete Task - Remove a task from a section
   */
  function deleteTask(sectionIndex, taskIndex) {
    const taskInput = document.getElementById(`task_text_${sectionIndex}_${taskIndex}`);
    if (!taskInput) return;

    // Clear the task text (will be filtered out on save)
    taskInput.value = '';
    taskInput.style.background = '#fee2e2'; // Red tint
    taskInput.disabled = true;

    // Mark row as deleted visually
    const row = taskInput.closest('div');
    if (row) {
      row.style.opacity = '0.5';
      row.style.textDecoration = 'line-through';
    }

    showMessage('✓ Task marked for deletion. Click SAVE CHANGES to apply.', 'success');
  }

  /**
   * Open Manager Watchdog - Requires password
   */
  function openFOHManagerWatchdog(evt) {
    requirePasswordFor('FOH Manager Watchdog', () => {
      openFOHTab(evt, 'fohWatchdog');
      loadManagerWatchdog();
    });
  }

  /**
   * Load Manager Watchdog - Historical data view + password management
   */
  async function loadManagerWatchdog() {
    const container = document.getElementById('fohWatchdogContent');

    container.innerHTML = `
      <!-- Tab Selector -->
      <div style="display: flex; gap: 8px; margin-bottom: 20px; border-bottom: 2px solid var(--gray-300);">
        <button
          id="watchdogTab_history"
          onclick="showWatchdogSection('history')"
          style="
            padding: 12px 20px;
            background: var(--gray-700);
            color: white;
            border: none;
            border-radius: 0;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            cursor: pointer;
            transition: all 0.15s ease;
          "
        >📊 HISTORY</button>
        <button
          id="watchdogTab_passwords"
          onclick="showWatchdogSection('passwords')"
          style="
            padding: 12px 20px;
            background: var(--gray-100);
            color: var(--gray-700);
            border: none;
            border-radius: 0;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            cursor: pointer;
            transition: all 0.15s ease;
          "
        >🔐 PASSWORDS</button>
      </div>

      <!-- History Section -->
      <div id="watchdog_history" style="display: block;">
        <div style="margin-bottom: 20px;">
          <label style="display: block; margin-bottom: 8px; font-size: 12px; font-weight: 700; color: var(--gray-700); text-transform: uppercase; letter-spacing: 0.5px;">
            Select Date
          </label>
          <input
            type="date"
            id="watchdogDate"
            value="${getPacificDate()}"
            style="
              padding: 12px;
              border: 2px solid var(--gray-300);
              border-radius: 0;
              font-size: 14px;
            "
            onchange="loadWatchdogData(this.value)"
          />
        </div>

        <div id="watchdogDataContainer">
          <p style="text-align: center; padding: 20px;">Loading data...</p>
        </div>
      </div>

      <!-- Password Management Section -->
      <div id="watchdog_passwords" style="display: none;">
        <div id="passwordManagementContainer">
          <p style="text-align: center; padding: 20px;">Loading password management...</p>
        </div>
      </div>
    `;

    // Load today's data
    loadWatchdogData(getPacificDate());
  }

  /**
   * Show Watchdog Section
   */
  function showWatchdogSection(section) {
    // Hide all sections
    document.getElementById('watchdog_history').style.display = 'none';
    document.getElementById('watchdog_passwords').style.display = 'none';

    // Update button styles
    const historyBtn = document.getElementById('watchdogTab_history');
    const passwordsBtn = document.getElementById('watchdogTab_passwords');

    historyBtn.style.background = 'var(--gray-100)';
    historyBtn.style.color = 'var(--gray-700)';
    passwordsBtn.style.background = 'var(--gray-100)';
    passwordsBtn.style.color = 'var(--gray-700)';

    // Show selected section
    if (section === 'history') {
      document.getElementById('watchdog_history').style.display = 'block';
      historyBtn.style.background = 'var(--gray-700)';
      historyBtn.style.color = 'white';
    } else if (section === 'passwords') {
      document.getElementById('watchdog_passwords').style.display = 'block';
      passwordsBtn.style.background = 'var(--gray-700)';
      passwordsBtn.style.color = 'white';
      loadPasswordManagement();
    }
  }

  /**
   * Load Watchdog Data for specific date
   */
  async function loadWatchdogData(date) {
    const container = document.getElementById('watchdogDataContainer');

    try {
      showLoading('Loading Data', 'Fetching checklist history...');

      // Fetch sessions for the selected date
      const { data: sessions, error: sessionsError } = await supabase
        .from('foh_checklist_sessions')
        .select('*')
        .eq('session_date', date)
        .order('started_at', { ascending: false });

      if (sessionsError) throw sessionsError;

      if (!sessions || sessions.length === 0) {
        hideLoading();
        container.innerHTML = `
          <div style="text-align: center; padding: 40px;">
            <p style="font-size: 16px; color: var(--gray-600);">
              No checklists found for ${formatPacificDateDisplay(new Date(date + 'T12:00:00'), {
                month: 'long',
                day: 'numeric',
                year: 'numeric'
              })}
            </p>
          </div>
        `;
        return;
      }

      // Fetch tasks and ratings for each session
      const sessionIds = sessions.map(s => s.id);

      const { data: tasks, error: tasksError } = await supabase
        .from('foh_checklist_tasks')
        .select('*')
        .in('session_id', sessionIds);

      if (tasksError) throw tasksError;

      // Debug: Log task data to verify completed_by is saved
      console.log('📊 Watchdog Tasks Loaded:', tasks.length, 'tasks');
      const completedTasksWithUser = tasks.filter(t => t.is_completed && t.completed_by);
      console.log('✅ Completed tasks with username:', completedTasksWithUser.length);
      if (completedTasksWithUser.length > 0) {
        console.log('Sample completed task:', completedTasksWithUser[0]);
      }

      const { data: ratings, error: ratingsError } = await supabase
        .from('foh_checklist_ratings')
        .select('*')
        .in('session_id', sessionIds);

      if (ratingsError) throw ratingsError;

      hideLoading();

      // Render watchdog view
      renderWatchdogData(sessions, tasks, ratings);

    } catch (error) {
      hideLoading();
      console.error('Error loading watchdog data:', error);
      container.innerHTML = `
        <div style="text-align: center; padding: 40px;">
          <p style="font-size: 16px; color: var(--error-text);">
            Error loading data: ${error.message}
          </p>
        </div>
      `;
    }
  }

  /**
   * Render Watchdog Data
   */
  function renderWatchdogData(sessions, tasks, ratings) {
    const container = document.getElementById('watchdogDataContainer');

    let html = `
      <div style="margin-bottom: 20px; padding: 16px; background: var(--blue-bg); border-left: 4px solid var(--blue-text); border-radius: 0;">
        <p style="color: var(--blue-text); font-size: 13px; font-weight: 600; margin: 0;">
          📊 ${sessions.length} checklist session${sessions.length !== 1 ? 's' : ''} found
        </p>
      </div>
    `;

    sessions.forEach(session => {
      const sessionTasks = tasks.filter(t => t.session_id === session.id);
      const sessionRatings = ratings.filter(r => r.session_id === session.id);
      const completedTasks = sessionTasks.filter(t => t.is_completed).length;
      const totalTasks = sessionTasks.length;
      const percentComplete = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;

      const checklist = getChecklistByType(session.checklist_type);
      const checklistTitle = checklist ? checklist.title : session.checklist_type;

      html += `
        <div style="margin-bottom: 24px; background: white; border: 2px solid var(--gray-300); border-radius: 0; overflow: hidden;">
          <div style="background: ${session.is_complete ? 'var(--success-bg)' : 'var(--warning-bg)'}; padding: 16px; border-bottom: 2px solid var(--gray-300);">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 12px; margin-bottom: 12px;">
              <div>
                <h3 style="margin: 0 0 8px 0; font-size: 16px; font-weight: 700; color: ${session.is_complete ? 'var(--success-text)' : 'var(--warning-text)'}; text-transform: uppercase; letter-spacing: 1px;">
                  ${checklistTitle}
                </h3>
                <div style="font-size: 13px; color: ${session.is_complete ? 'var(--success-text)' : 'var(--warning-text)'}; line-height: 1.6;">
                  <div>👤 ${session.staff_name}${session.staff_name_2 ? ` & ${session.staff_name_2}` : ''}</div>
                  <div>🕒 Started: ${formatPacificDateDisplay(new Date(session.started_at), {
                    hour: 'numeric',
                    minute: '2-digit',
                    hour12: true
                  })}</div>
                  ${session.completed_at ? `
                    <div>✅ Completed: ${formatPacificDateDisplay(new Date(session.completed_at), {
                      hour: 'numeric',
                      minute: '2-digit',
                      hour12: true
                    })}</div>
                  ` : '<div>⚠️ Not completed</div>'}
                </div>
              </div>
              <div style="text-align: right;">
                <div style="font-size: 24px; font-weight: 700; color: ${session.is_complete ? 'var(--success-text)' : 'var(--warning-text)'};">
                  ${percentComplete}%
                </div>
                <div style="font-size: 12px; color: ${session.is_complete ? 'var(--success-text)' : 'var(--warning-text)'};">
                  ${completedTasks} / ${totalTasks} tasks
                </div>
              </div>
            </div>

            <!-- Delete Session Button -->
            <div style="text-align: right;">
              <button
                onclick="confirmDeleteSession('${session.id}', '${session.session_date}')"
                style="
                  padding: 8px 16px;
                  background: #dc2626;
                  color: white;
                  border: 2px solid #dc2626;
                  border-radius: 0;
                  font-size: 11px;
                  font-weight: 700;
                  text-transform: uppercase;
                  letter-spacing: 0.5px;
                  cursor: pointer;
                  transition: all 0.15s ease;
                "
                onmouseover="this.style.background='#b91c1c'"
                onmouseout="this.style.background='#dc2626'"
              >🗑️ DELETE SESSION</button>
            </div>
          </div>

          <div style="padding: 16px;">
            <!-- Task Breakdown -->
            <details style="margin-bottom: 16px;">
              <summary style="cursor: pointer; font-size: 14px; font-weight: 700; color: var(--gray-900); padding: 8px; background: var(--gray-100); border-radius: 0;">
                📋 Task Details (${completedTasks} / ${totalTasks})
              </summary>
              <div style="margin-top: 12px; padding-left: 12px;">
      `;

      // Group tasks by section
      const tasksBySection = {};
      sessionTasks.forEach(task => {
        if (!tasksBySection[task.section_name]) {
          tasksBySection[task.section_name] = [];
        }
        tasksBySection[task.section_name].push(task);
      });

      Object.keys(tasksBySection).forEach(sectionName => {
        const sectionTasks = tasksBySection[sectionName];
        const sectionCompleted = sectionTasks.filter(t => t.is_completed).length;

        html += `
          <div style="margin-bottom: 16px;">
            <div style="font-size: 13px; font-weight: 700; color: var(--gray-700); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">
              ${sectionName} (${sectionCompleted} / ${sectionTasks.length})
            </div>
        `;

        sectionTasks.forEach(task => {
          html += `
            <div style="margin-bottom: 12px; padding: 8px; background: ${task.is_completed ? 'var(--success-bg)' : 'var(--gray-100)'}; border-radius: 0; border-left: 3px solid ${task.is_completed ? 'var(--success-border)' : 'var(--gray-300)'};">
              <div style="display: flex; align-items: flex-start; gap: 8px; margin-bottom: 8px;">
                <span style="flex-shrink: 0; font-size: 14px;">${task.is_completed ? '✅' : '⬜'}</span>
                <div style="flex: 1; ${task.is_completed ? 'text-decoration: line-through; opacity: 0.8;' : ''}">
                  <div style="font-size: 13px; font-weight: 600; color: var(--gray-900);">
                    ${task.task_text}
                  </div>
                  ${task.is_completed && task.completed_by ? `
                    <div style="font-size: 11px; color: var(--success-text); margin-top: 4px; font-weight: 600; text-decoration: none !important; opacity: 1 !important;">
                      ✓ Completed by ${task.completed_by} • ${formatPacificDateDisplay(new Date(task.completed_at), {
                        hour: 'numeric',
                        minute: '2-digit',
                        hour12: true
                      })}
                    </div>
                  ` : ''}
                  ${!task.is_completed ? `
                    <div style="font-size: 11px; color: var(--error-text); margin-top: 4px; font-weight: 600;">
                      ⚠️ NOT COMPLETED
                    </div>
                  ` : ''}
                </div>
              </div>

              <!-- Manager Notes Section -->
              <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--gray-300);">
                <label style="display: block; margin-bottom: 4px; font-size: 10px; font-weight: 700; color: var(--gray-600); text-transform: uppercase; letter-spacing: 0.5px;">
                  📝 Manager Notes
                </label>
                <textarea
                  id="managerNote_${task.id}"
                  placeholder="Add manager notes or observations..."
                  style="
                    width: 100%;
                    min-height: 60px;
                    padding: 8px;
                    border: 2px solid var(--gray-300);
                    border-radius: 0;
                    font-size: 12px;
                    font-family: inherit;
                    box-sizing: border-box;
                    resize: vertical;
                  "
                  onfocus="this.style.borderColor='var(--gray-700)'"
                  onblur="this.style.borderColor='var(--gray-300)'; saveManagerNote('${task.id}', this.value);"
                >${task.manager_note || ''}</textarea>
                ${task.manager_note_by ? `
                  <div style="font-size: 10px; color: var(--gray-500); margin-top: 4px; font-style: italic;">
                    Last edited by ${task.manager_note_by} • ${formatPacificDateDisplay(new Date(task.manager_note_at), {
                      month: 'short',
                      day: 'numeric',
                      hour: 'numeric',
                      minute: '2-digit',
                      hour12: true
                    })}
                  </div>
                ` : ''}
              </div>
            </div>
          `;
        });

        html += '</div>';
      });

      html += `
              </div>
            </details>
      `;

      // Ratings
      if (sessionRatings.length > 0) {
        html += `
          <details style="margin-bottom: 16px;">
            <summary style="cursor: pointer; font-size: 14px; font-weight: 700; color: var(--gray-900); padding: 8px; background: var(--gray-100); border-radius: 0;">
              ⭐ Quality Ratings (${sessionRatings.length})
            </summary>
            <div style="margin-top: 12px; padding-left: 12px;">
        `;

        sessionRatings.forEach(rating => {
          html += `
            <div style="margin-bottom: 12px; padding: 12px; background: var(--gray-100); border-left: 3px solid ${getRatingColor(rating.rating)}; border-radius: 0;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                <span style="font-size: 13px; font-weight: 700; color: var(--gray-900);">
                  ${rating.category_name}
                </span>
                <span style="font-size: 20px; font-weight: 700; color: ${getRatingColor(rating.rating)};">
                  ${rating.rating} / 5
                </span>
              </div>
              ${rating.notes ? `
                <div style="font-size: 12px; color: var(--gray-600); margin-top: 8px; font-style: italic;">
                  "${rating.notes}"
                </div>
              ` : ''}
              <div style="font-size: 11px; color: var(--gray-500); margin-top: 4px;">
                Rated by ${rating.rated_by}
              </div>
            </div>
          `;
        });

        html += `
            </div>
          </details>
        `;
      }

      // Notes
      if (session.notes) {
        html += `
          <div style="margin-top: 16px; padding: 12px; background: var(--blue-bg); border-left: 3px solid var(--blue-text); border-radius: 0;">
            <div style="font-size: 12px; font-weight: 700; color: var(--blue-text); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">
              📝 Notes for Incoming Crew
            </div>
            <div style="font-size: 13px; color: var(--blue-text); line-height: 1.5; white-space: pre-wrap;">
              ${session.notes}
            </div>
          </div>
        `;
      }

      html += `
          </div>
        </div>
      `;
    });

    container.innerHTML = html;
  }

  /**
   * Save Manager Note - With username + timestamp tracking
   */
  async function saveManagerNote(taskId, noteText) {
    const note = noteText.trim();

    // Get manager username from localStorage
    const managerName = localStorage.getItem('foh_username') || 'Manager';

    try {
      const updateData = {
        manager_note: note || null,
        manager_note_by: note ? managerName : null,
        manager_note_at: note ? new Date().toISOString() : null
      };

      const { error } = await supabase
        .from('foh_checklist_tasks')
        .update(updateData)
        .eq('id', taskId);

      if (error) throw error;

      console.log(`✓ Manager note saved for task ${taskId}`);

      // Show brief success indicator
      const textarea = document.getElementById(`managerNote_${taskId}`);
      if (textarea) {
        const originalBorder = textarea.style.borderColor;
        textarea.style.borderColor = 'var(--success-border)';
        setTimeout(() => {
          textarea.style.borderColor = originalBorder;
        }, 1000);
      }

    } catch (error) {
      console.error('Error saving manager note:', error);
      showMessage(`Error saving note: ${error.message}`, 'error');
    }
  }

  /**
   * Confirm Delete Session - Show confirmation modal
   */
  function confirmDeleteSession(sessionId, sessionDate) {
    requirePasswordFor('Delete Session', () => {
      // Show confirmation modal
      const modal = document.createElement('div');
      modal.id = 'confirmDeleteModal';
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        padding: 20px;
      `;

      const modalContent = document.createElement('div');
      modalContent.style.cssText = `
        background: white;
        padding: 32px;
        max-width: 500px;
        width: 100%;
        border: 3px solid #dc2626;
        border-radius: 0;
      `;

      modalContent.innerHTML = `
        <h3 style="margin: 0 0 12px 0; font-size: 18px; font-weight: 700; color: #dc2626; text-transform: uppercase; letter-spacing: 1px;">
          ⚠️ DELETE SESSION
        </h3>
        <p style="margin: 0 0 20px 0; font-size: 14px; color: var(--gray-700); line-height: 1.6;">
          Are you sure you want to delete this entire checklist session?
          <br><br>
          <strong>This action cannot be undone!</strong>
          <br><br>
          All tasks, ratings, and notes for this session will be permanently removed.
        </p>
        <div style="display: flex; gap: 12px;">
          <button
            id="deleteSessionCancelBtn"
            style="
              flex: 1;
              padding: 14px 24px;
              background: var(--gray-100);
              color: var(--gray-900);
              border: 2px solid var(--gray-300);
              border-radius: 0;
              font-size: 13px;
              font-weight: 700;
              text-transform: uppercase;
              letter-spacing: 0.5px;
              cursor: pointer;
              transition: all 0.15s ease;
            "
          >CANCEL</button>
          <button
            id="deleteSessionConfirmBtn"
            style="
              flex: 1;
              padding: 14px 24px;
              background: #dc2626;
              color: white;
              border: 2px solid #dc2626;
              border-radius: 0;
              font-size: 13px;
              font-weight: 700;
              text-transform: uppercase;
              letter-spacing: 0.5px;
              cursor: pointer;
              transition: all 0.15s ease;
            "
          >DELETE SESSION</button>
        </div>
      `;

      modal.appendChild(modalContent);
      document.body.appendChild(modal);

      const confirmBtn = document.getElementById('deleteSessionConfirmBtn');
      const cancelBtn = document.getElementById('deleteSessionCancelBtn');

      // Handle confirm
      const handleConfirm = () => {
        document.body.removeChild(modal);
        deleteSession(sessionId, sessionDate);
      };

      // Handle cancel
      const handleCancel = () => {
        document.body.removeChild(modal);
      };

      confirmBtn.onclick = handleConfirm;
      cancelBtn.onclick = handleCancel;

      // Click outside to close
      modal.onclick = (e) => {
        if (e.target === modal) {
          handleCancel();
        }
      };
    });
  }

  /**
   * Delete Session - Remove session, tasks, and ratings from database
   */
  async function deleteSession(sessionId, sessionDate) {
    showLoading('Deleting Session', 'Removing all data...');

    try {
      // Delete in reverse order of foreign key dependencies

      // 1. Delete all ratings for this session
      const { error: ratingsError } = await supabase
        .from('foh_checklist_ratings')
        .delete()
        .eq('session_id', sessionId);

      if (ratingsError) throw ratingsError;

      // 2. Delete all tasks for this session
      const { error: tasksError } = await supabase
        .from('foh_checklist_tasks')
        .delete()
        .eq('session_id', sessionId);

      if (tasksError) throw tasksError;

      // 3. Delete the session itself
      const { error: sessionError } = await supabase
        .from('foh_checklist_sessions')
        .delete()
        .eq('id', sessionId);

      if (sessionError) throw sessionError;

      hideLoading();

      showMessage('✅ Session deleted successfully!', 'success');

      // Reload the watchdog data for this date
      setTimeout(() => {
        loadWatchdogData(sessionDate);
      }, 1000);

    } catch (error) {
      hideLoading();
      console.error('Error deleting session:', error);
      showMessage(`Error deleting session: ${error.message}`, 'error');
    }
  }

  // ====================================
  // PASSWORD MANAGEMENT SYSTEM
  // ====================================

  /**
   * Load Password Management Interface
   */
  async function loadPasswordManagement() {
    const container = document.getElementById('passwordManagementContainer');

    showLoading('Loading', 'Fetching manager passwords...');

    try {
      // Fetch all manager passwords from database
      const { data: passwords, error } = await supabase
        .from('manager_passwords')
        .select('*')
        .order('created_at', { ascending: false });

      if (error) throw error;

      hideLoading();

      let html = `
        <div style="margin-bottom: 24px; padding: 20px; background: var(--blue-bg); border-left: 4px solid var(--blue-text); border-radius: 0;">
          <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
            <div>
              <h3 style="margin: 0 0 8px 0; font-size: 16px; font-weight: 700; color: var(--blue-text); text-transform: uppercase; letter-spacing: 1px;">
                🔐 MANAGER PASSWORD MANAGEMENT
              </h3>
              <p style="margin: 0; font-size: 13px; color: var(--blue-text); line-height: 1.6;">
                Create and manage passwords for manager access to FOH checklists.
              </p>
            </div>
            <button
              onclick="showAddPasswordForm()"
              style="
                padding: 12px 24px;
                background: var(--success-border);
                color: white;
                border: 2px solid var(--success-border);
                border-radius: 0;
                font-size: 12px;
                font-weight: 700;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                cursor: pointer;
                transition: all 0.15s ease;
              "
              onmouseover="this.style.background='#047857'"
              onmouseout="this.style.background='var(--success-border)'"
            >➕ ADD NEW PASSWORD</button>
          </div>
        </div>

        <div id="addPasswordForm" style="display: none;"></div>

        <div id="passwordsList">
      `;

      if (!passwords || passwords.length === 0) {
        html += `
          <div style="text-align: center; padding: 60px 20px; background: var(--gray-100); border: 2px solid var(--gray-300); border-radius: 0;">
            <div style="font-size: 48px; margin-bottom: 16px;">🔒</div>
            <h3 style="margin: 0 0 8px 0; font-size: 16px; font-weight: 700; color: var(--gray-700);">
              NO PASSWORDS CONFIGURED
            </h3>
            <p style="margin: 0; font-size: 13px; color: var(--gray-500);">
              Click "ADD NEW PASSWORD" to create your first manager password
            </p>
          </div>
        `;
      } else {
        passwords.forEach(pwd => {
          const statusColor = pwd.is_active ? 'var(--success-border)' : 'var(--error-border)';
          const statusBg = pwd.is_active ? 'var(--success-bg)' : 'var(--error-bg)';
          const statusText = pwd.is_active ? 'var(--success-text)' : 'var(--error-text)';

          html += `
            <div style="margin-bottom: 16px; background: white; border: 2px solid var(--gray-300); border-radius: 0; overflow: hidden;">
              <div style="padding: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 12px; margin-bottom: 16px;">
                  <div style="flex: 1;">
                    <h4 style="margin: 0 0 8px 0; font-size: 16px; font-weight: 700; color: var(--gray-900);">
                      ${pwd.username}
                    </h4>
                    ${pwd.full_name ? `
                      <p style="margin: 0 0 8px 0; font-size: 13px; color: var(--gray-600);">
                        ${pwd.full_name}
                      </p>
                    ` : ''}
                    <div style="display: flex; gap: 12px; flex-wrap: wrap; font-size: 12px; color: var(--gray-500);">
                      <span>📅 Created ${formatPacificDateDisplay(new Date(pwd.created_at), {
                        month: 'short',
                        day: 'numeric',
                        year: 'numeric'
                      })}</span>
                      ${pwd.created_by ? `<span>👤 by ${pwd.created_by}</span>` : ''}
                      ${pwd.role ? `<span>🎭 Role: ${pwd.role}</span>` : ''}
                    </div>
                  </div>
                  <div>
                    <span style="
                      display: inline-block;
                      padding: 6px 12px;
                      background: ${statusBg};
                      color: ${statusText};
                      border-radius: 0;
                      font-size: 11px;
                      font-weight: 700;
                      text-transform: uppercase;
                      letter-spacing: 0.5px;
                    ">${pwd.is_active ? '✅ ACTIVE' : '❌ INACTIVE'}</span>
                  </div>
                </div>

                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                  <button
                    onclick="editPassword('${pwd.id}')"
                    style="
                      padding: 10px 16px;
                      background: var(--gray-700);
                      color: white;
                      border: 2px solid var(--gray-700);
                      border-radius: 0;
                      font-size: 11px;
                      font-weight: 700;
                      text-transform: uppercase;
                      letter-spacing: 0.5px;
                      cursor: pointer;
                      transition: all 0.15s ease;
                    "
                    onmouseover="this.style.background='#000'"
                    onmouseout="this.style.background='var(--gray-700)'"
                  >✏️ EDIT</button>

                  <button
                    onclick="togglePasswordStatus('${pwd.id}', ${!pwd.is_active})"
                    style="
                      padding: 10px 16px;
                      background: ${pwd.is_active ? 'var(--warning-border)' : 'var(--success-border)'};
                      color: white;
                      border: 2px solid ${pwd.is_active ? 'var(--warning-border)' : 'var(--success-border)'};
                      border-radius: 0;
                      font-size: 11px;
                      font-weight: 700;
                      text-transform: uppercase;
                      letter-spacing: 0.5px;
                      cursor: pointer;
                      transition: all 0.15s ease;
                    "
                  >${pwd.is_active ? '🚫 DEACTIVATE' : '✅ ACTIVATE'}</button>

                  <button
                    onclick="confirmDeletePassword('${pwd.id}', '${pwd.username}')"
                    style="
                      padding: 10px 16px;
                      background: #dc2626;
                      color: white;
                      border: 2px solid #dc2626;
                      border-radius: 0;
                      font-size: 11px;
                      font-weight: 700;
                      text-transform: uppercase;
                      letter-spacing: 0.5px;
                      cursor: pointer;
                      transition: all 0.15s ease;
                    "
                    onmouseover="this.style.background='#b91c1c'"
                    onmouseout="this.style.background='#dc2626'"
                  >🗑️ DELETE</button>
                </div>
              </div>
            </div>
          `;
        });
      }

      html += '</div>';

      container.innerHTML = html;

    } catch (error) {
      hideLoading();
      console.error('Error loading passwords:', error);
      container.innerHTML = `
        <div style="text-align: center; padding: 40px;">
          <p style="font-size: 16px; color: var(--error-text);">
            Error loading passwords: ${error.message}
          </p>
        </div>
      `;
    }
  }

  /**
   * Show Add Password Form
   */
  function showAddPasswordForm() {
    const formContainer = document.getElementById('addPasswordForm');

    formContainer.innerHTML = `
      <div style="margin-bottom: 24px; background: white; border: 2px solid var(--gray-300); border-radius: 0; overflow: hidden;">
        <div style="background: var(--success-bg); border-bottom: 2px solid var(--success-border); padding: 14px 16px;">
          <h4 style="margin: 0; font-size: 14px; font-weight: 700; color: var(--success-text); text-transform: uppercase; letter-spacing: 1px;">
            ➕ ADD NEW MANAGER PASSWORD
          </h4>
        </div>
        <div style="padding: 20px;">
          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 8px; font-size: 11px; font-weight: 700; color: var(--gray-700); text-transform: uppercase; letter-spacing: 0.5px;">
              Username (Login ID) *
            </label>
            <input
              type="text"
              id="new_username"
              placeholder="e.g., manager1, john_doe"
              style="
                width: 100%;
                padding: 12px;
                border: 2px solid var(--gray-300);
                border-radius: 0;
                font-size: 14px;
                box-sizing: border-box;
              "
              onfocus="this.style.borderColor='var(--gray-700)'"
              onblur="this.style.borderColor='var(--gray-300)'"
            />
            <p style="margin: 4px 0 0 0; font-size: 11px; color: var(--gray-500);">
              Must be unique. No spaces. Use lowercase and underscores.
            </p>
          </div>

          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 8px; font-size: 11px; font-weight: 700; color: var(--gray-700); text-transform: uppercase; letter-spacing: 0.5px;">
              Full Name (Optional)
            </label>
            <input
              type="text"
              id="new_fullname"
              placeholder="e.g., John Doe"
              style="
                width: 100%;
                padding: 12px;
                border: 2px solid var(--gray-300);
                border-radius: 0;
                font-size: 14px;
                box-sizing: border-box;
              "
              onfocus="this.style.borderColor='var(--gray-700)'"
              onblur="this.style.borderColor='var(--gray-300)'"
            />
          </div>

          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 8px; font-size: 11px; font-weight: 700; color: var(--gray-700); text-transform: uppercase; letter-spacing: 0.5px;">
              Password *
            </label>
            <div style="position: relative;">
              <input
                type="password"
                id="new_password"
                placeholder="Enter strong password"
                style="
                  width: 100%;
                  padding: 12px;
                  padding-right: 50px;
                  border: 2px solid var(--gray-300);
                  border-radius: 0;
                  font-size: 14px;
                  box-sizing: border-box;
                "
                onfocus="this.style.borderColor='var(--gray-700)'"
                onblur="this.style.borderColor='var(--gray-300)'"
                oninput="validatePasswordStrength(this.value, 'new_password_strength')"
              />
              <button
                type="button"
                onclick="togglePasswordVisibility('new_password')"
                style="
                  position: absolute;
                  right: 8px;
                  top: 50%;
                  transform: translateY(-50%);
                  background: none;
                  border: none;
                  cursor: pointer;
                  font-size: 18px;
                  padding: 4px 8px;
                "
              >👁️</button>
            </div>
            <div id="new_password_strength" style="margin-top: 8px;"></div>
            <p style="margin: 4px 0 0 0; font-size: 11px; color: var(--gray-500);">
              Minimum 8 characters. Include uppercase, lowercase, numbers, and symbols.
            </p>
          </div>

          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 8px; font-size: 11px; font-weight: 700; color: var(--gray-700); text-transform: uppercase; letter-spacing: 0.5px;">
              Role (Optional)
            </label>
            <select
              id="new_role"
              style="
                width: 100%;
                padding: 12px;
                border: 2px solid var(--gray-300);
                border-radius: 0;
                font-size: 14px;
                box-sizing: border-box;
              "
            >
              <option value="">Select role...</option>
              <option value="Manager">Manager</option>
              <option value="Supervisor">Supervisor</option>
              <option value="Admin">Admin</option>
            </select>
          </div>

          <div style="display: flex; gap: 12px; justify-content: flex-end;">
            <button
              onclick="hideAddPasswordForm()"
              style="
                padding: 14px 24px;
                background: var(--gray-100);
                color: var(--gray-900);
                border: 2px solid var(--gray-300);
                border-radius: 0;
                font-size: 13px;
                font-weight: 700;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                cursor: pointer;
                transition: all 0.15s ease;
              "
              onmouseover="this.style.background='var(--gray-200)'"
              onmouseout="this.style.background='var(--gray-100)'"
            >CANCEL</button>

            <button
              onclick="saveNewPassword()"
              style="
                padding: 14px 24px;
                background: var(--success-border);
                color: white;
                border: 2px solid var(--success-border);
                border-radius: 0;
                font-size: 13px;
                font-weight: 700;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                cursor: pointer;
                transition: all 0.15s ease;
              "
              onmouseover="this.style.background='#047857'"
              onmouseout="this.style.background='var(--success-border)'"
            >💾 CREATE PASSWORD</button>
          </div>
        </div>
      </div>
    `;

    formContainer.style.display = 'block';

    // Focus username field
    setTimeout(() => {
      document.getElementById('new_username').focus();
    }, 100);
  }

  /**
   * Hide Add Password Form
   */
  function hideAddPasswordForm() {
    document.getElementById('addPasswordForm').style.display = 'none';
    document.getElementById('addPasswordForm').innerHTML = '';
  }

  /**
   * Validate Password Strength
   */
  function validatePasswordStrength(password, elementId) {
    const strengthDiv = document.getElementById(elementId);
    if (!strengthDiv) return;

    if (!password) {
      strengthDiv.innerHTML = '';
      return;
    }

    let strength = 0;
    let feedback = [];

    // Length check
    if (password.length >= 8) strength++;
    if (password.length >= 12) strength++;
    else feedback.push('Use 12+ characters');

    // Character type checks
    if (/[a-z]/.test(password)) strength++;
    else feedback.push('Add lowercase letters');

    if (/[A-Z]/.test(password)) strength++;
    else feedback.push('Add uppercase letters');

    if (/[0-9]/.test(password)) strength++;
    else feedback.push('Add numbers');

    if (/[^a-zA-Z0-9]/.test(password)) strength++;
    else feedback.push('Add symbols (!@#$%^&*)');

    let color, text, bgColor;
    if (strength <= 2) {
      color = 'var(--error-text)';
      bgColor = 'var(--error-bg)';
      text = '❌ WEAK';
    } else if (strength <= 4) {
      color = 'var(--warning-text)';
      bgColor = 'var(--warning-bg)';
      text = '⚠️ MEDIUM';
    } else {
      color = 'var(--success-text)';
      bgColor = 'var(--success-bg)';
      text = '✅ STRONG';
    }

    strengthDiv.innerHTML = `
      <div style="padding: 8px 12px; background: ${bgColor}; border-left: 3px solid ${color}; border-radius: 0;">
        <div style="font-size: 11px; font-weight: 700; color: ${color}; margin-bottom: 4px;">
          ${text}
        </div>
        ${feedback.length > 0 ? `
          <div style="font-size: 10px; color: ${color};">
            ${feedback.join(' • ')}
          </div>
        ` : ''}
      </div>
    `;
  }

  /**
   * Toggle Password Visibility
   */
  function togglePasswordVisibility(inputId) {
    const input = document.getElementById(inputId);
    if (!input) return;

    if (input.type === 'password') {
      input.type = 'text';
    } else {
      input.type = 'password';
    }
  }

  /**
   * Simple Hash Function (for basic password storage)
   * NOTE: In production, use proper bcrypt/argon2 on backend
   */
  function simpleHash(str) {
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
      const char = str.charCodeAt(i);
      hash = ((hash << 5) - hash) + char;
      hash = hash & hash;
    }
    return hash.toString(36);
  }

  /**
   * Save New Password
   */
  async function saveNewPassword() {
    const username = document.getElementById('new_username').value.trim();
    const fullname = document.getElementById('new_fullname').value.trim();
    const password = document.getElementById('new_password').value;
    const role = document.getElementById('new_role').value;

    // Validation
    if (!username) {
      showMessage('Username is required!', 'error');
      document.getElementById('new_username').focus();
      return;
    }

    // Username format validation
    if (!/^[a-z0-9_]+$/.test(username)) {
      showMessage('Username must be lowercase letters, numbers, and underscores only!', 'error');
      document.getElementById('new_username').focus();
      return;
    }

    if (!password) {
      showMessage('Password is required!', 'error');
      document.getElementById('new_password').focus();
      return;
    }

    if (password.length < 8) {
      showMessage('Password must be at least 8 characters!', 'error');
      document.getElementById('new_password').focus();
      return;
    }

    showLoading('Creating Password', 'Saving manager password...');

    try {
      // Get current user from localStorage
      const createdBy = localStorage.getItem('foh_username') || 'System';

      // Hash password (basic hashing - use proper backend encryption in production)
      const passwordHash = simpleHash(password);

      const passwordData = {
        username: username,
        full_name: fullname || null,
        password_hash: passwordHash,
        role: role || null,
        is_active: true,
        created_by: createdBy,
        created_at: new Date().toISOString()
      };

      const { data, error } = await supabase
        .from('manager_passwords')
        .insert([passwordData])
        .select()
        .single();

      if (error) throw error;

      hideLoading();
      hideAddPasswordForm();
      showMessage(`✅ Password created for ${username}!`, 'success');

      // Reload password list
      setTimeout(() => {
        loadPasswordManagement();
      }, 1000);

    } catch (error) {
      hideLoading();
      console.error('Error saving password:', error);

      if (error.code === '23505') {
        showMessage('Username already exists! Choose a different username.', 'error');
      } else {
        showMessage(`Error creating password: ${error.message}`, 'error');
      }
    }
  }

  /**
   * Edit Password
   */
  function editPassword(passwordId) {
    showMessage('Edit password feature coming soon! For now, you can delete and recreate.', 'info');
  }

  /**
   * Toggle Password Status (Active/Inactive)
   */
  async function togglePasswordStatus(passwordId, newStatus) {
    showLoading('Updating', 'Changing password status...');

    try {
      const updatedBy = localStorage.getItem('foh_username') || 'System';

      const { error } = await supabase
        .from('manager_passwords')
        .update({
          is_active: newStatus,
          updated_by: updatedBy,
          updated_at: new Date().toISOString()
        })
        .eq('id', passwordId);

      if (error) throw error;

      hideLoading();
      showMessage(`✅ Password ${newStatus ? 'activated' : 'deactivated'}!`, 'success');

      // Reload password list
      setTimeout(() => {
        loadPasswordManagement();
      }, 1000);

    } catch (error) {
      hideLoading();
      console.error('Error updating password:', error);
      showMessage(`Error updating password: ${error.message}`, 'error');
    }
  }

  /**
   * Confirm Delete Password
   */
  function confirmDeletePassword(passwordId, username) {
    const modal = document.createElement('div');
    modal.id = 'confirmDeletePasswordModal';
    modal.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      padding: 20px;
    `;

    const modalContent = document.createElement('div');
    modalContent.style.cssText = `
      background: white;
      padding: 32px;
      max-width: 500px;
      width: 100%;
      border: 3px solid #dc2626;
      border-radius: 0;
    `;

    modalContent.innerHTML = `
      <h3 style="margin: 0 0 12px 0; font-size: 18px; font-weight: 700; color: #dc2626; text-transform: uppercase; letter-spacing: 1px;">
        ⚠️ DELETE PASSWORD
      </h3>
      <p style="margin: 0 0 20px 0; font-size: 14px; color: var(--gray-700); line-height: 1.6;">
        Are you sure you want to delete the password for <strong>${username}</strong>?
        <br><br>
        <strong>This action cannot be undone!</strong>
        <br><br>
        The manager will no longer be able to access the system with this username.
      </p>
      <div style="display: flex; gap: 12px;">
        <button
          id="deletePasswordCancelBtn"
          style="
            flex: 1;
            padding: 14px 24px;
            background: var(--gray-100);
            color: var(--gray-900);
            border: 2px solid var(--gray-300);
            border-radius: 0;
            font-size: 13px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            transition: all 0.15s ease;
          "
        >CANCEL</button>
        <button
          id="deletePasswordConfirmBtn"
          style="
            flex: 1;
            padding: 14px 24px;
            background: #dc2626;
            color: white;
            border: 2px solid #dc2626;
            border-radius: 0;
            font-size: 13px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            transition: all 0.15s ease;
          "
        >DELETE PASSWORD</button>
      </div>
    `;

    modal.appendChild(modalContent);
    document.body.appendChild(modal);

    const confirmBtn = document.getElementById('deletePasswordConfirmBtn');
    const cancelBtn = document.getElementById('deletePasswordCancelBtn');

    const handleConfirm = () => {
      document.body.removeChild(modal);
      deletePassword(passwordId, username);
    };

    const handleCancel = () => {
      document.body.removeChild(modal);
    };

    confirmBtn.onclick = handleConfirm;
    cancelBtn.onclick = handleCancel;

    modal.onclick = (e) => {
      if (e.target === modal) {
        handleCancel();
      }
    };
  }

  /**
   * Delete Password
   */
  async function deletePassword(passwordId, username) {
    showLoading('Deleting', 'Removing password...');

    try {
      const { error } = await supabase
        .from('manager_passwords')
        .delete()
        .eq('id', passwordId);

      if (error) throw error;

      hideLoading();
      showMessage(`✅ Password deleted for ${username}!`, 'success');

      // Reload password list
      setTimeout(() => {
        loadPasswordManagement();
      }, 1000);

    } catch (error) {
      hideLoading();
      console.error('Error deleting password:', error);
      showMessage(`Error deleting password: ${error.message}`, 'error');
    }
  }

  // ====================================
  // FOH CHECKLIST SYSTEM - END
  // ====================================
</script>
</body>
</html>
