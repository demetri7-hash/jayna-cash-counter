<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, viewport-fit=cover">
  <title>Jayna Gyro Cash Counter</title>
  
  <link rel="apple-touch-icon" href="https://static.spotapps.co/website_images/ab_websites/229800_website_v1/logo.png">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#00A8E1">
  
  <style>
    /* Jayna Brand Design - Sky Blue & Grayscale */
    :root {
      --primary-blue: #00A8E1;
      --secondary-blue: #0094D6;
      --light-blue: #E3F4FC;
      --accent-blue: #0081C6;
      --gray-900: #212121;
      --gray-700: #424242;
      --gray-600: #616161;
      --gray-500: #757575;
      --gray-400: #BDBDBD;
      --gray-300: #E0E0E0;
      --gray-100: #F5F5F5;
      --success: #00C853;
      --warning: #FFB300;
      --error: #D32F2F;
      --white: #FFFFFF;
      --blue-bg: #dbeafe;
      --blue-text: #1e40af;
      --success-bg: #d1fae5;
      --success-text: #065f46;
      --success-border: #059669;
      --warning-bg: #fef3c7;
      --warning-text: #92400e;
      --warning-border: #f59e0b;
      --error-bg: #fee2e2;
      --error-text: #991b1b;
      --error-border: #dc2626;
    }

    /* Pen Icon Edit Button */
    .modal-edit-icon {
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s ease;
    }
    .modal-edit-icon:hover {
      background: var(--gray-200);
    }
    .modal-edit-icon svg {
      width: 18px;
      height: 18px;
      fill: var(--gray-700);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body {
      font-family: 'Aptos', 'Segoe UI Variable', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      background: var(--white); /* White background to blend with Google Sites header */
      min-height: 100vh;
      padding: 0;
      overflow-x: hidden;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
      background: var(--white);
      border-radius: 0;
      overflow: visible;
      box-shadow: none; /* Remove shadow for seamless Google Sites embed */
      min-height: auto;
      max-height: none;
    }
    .header {
      background: var(--white);
      color: var(--gray-900);
      text-align: center;
      padding: 12px;
      border-radius: 0;
      border-bottom: 1px solid var(--gray-300);
    }
    .header h1 { font-size: 18px; font-weight: 700; margin-bottom: 2px; letter-spacing: 1.5px; text-transform: uppercase; }
    .header p { opacity: 0.7; font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }
    /* Mobile-First Responsive Design */
    .content {
      padding: 12px;
      /* Google Sites full page embed optimization */
      max-height: none;
      overflow: visible;
    }
    .main-menu { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-bottom: 12px; }
    .secondary-links { display: flex; flex-wrap: wrap; gap: 12px; justify-content: center; margin-bottom: 20px; font-size: 11px; }
    .secondary-links a { color: var(--gray-700); text-decoration: underline; cursor: pointer; transition: color 0.15s ease; }
    .secondary-links a:hover { color: var(--gray-900); }
    .menu-btn {
      padding: 16px 12px !important;
      border: 2px solid var(--gray-700) !important;
      border-radius: 0 !important;
      background: var(--gray-700) !important;
      font-size: 11px !important;
      font-weight: 700 !important;
      color: white !important;
      cursor: pointer !important;
      transition: all 0.15s ease !important;
      text-align: center !important;
      min-height: 50px !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      text-transform: uppercase !important;
      letter-spacing: 1.2px !important;
      text-decoration: none !important;
    }
    .menu-btn:hover {
      background: var(--gray-600) !important;
      border-color: var(--gray-600) !important;
      transform: translateY(-1px);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
    }
    .menu-btn.active {
      border-color: var(--gray-600) !important;
      background: var(--gray-600) !important;
      transform: translateY(-1px);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
    }
    .menu-btn.primary {
      background: var(--gray-100) !important;
      color: var(--gray-900) !important;
      border: 2px solid var(--gray-300) !important;
    }
    .menu-btn.primary:hover {
      background: var(--gray-200) !important;
      border-color: var(--gray-400) !important;
    }
    .form-section { 
      display: none; 
      /* Ensure sections don't get cut off */
      min-height: auto;
      overflow: visible;
    }
    .form-section.active {
      display: block;
      /* Force visibility in Google Sites */
      position: relative;
      z-index: 1;
    }
    .form-group { margin-bottom: 12px; }
    .form-group label {
      display: block;
      margin-bottom: 4px;
      font-weight: 700;
      font-size: 10px;
      color: var(--gray-700);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    /* Enhanced Mobile-Friendly Inputs */
    .form-input, .form-select {
      width: 100%;
      padding: 12px 14px;
      border: 1px solid var(--gray-300);
      border-radius: 0;
      font-size: 14px;
      min-height: 44px;
      box-sizing: border-box;
      -webkit-appearance: none;
      appearance: none;
      transition: all 0.15s ease;
      background: var(--white);
      color: var(--gray-900);
    }
    .form-input:focus, .form-select:focus {
      outline: none;
      border-color: var(--primary-blue);
      box-shadow: 0 0 0 2px rgba(0, 217, 217, 0.15);
      background: var(--white);
    }
    
    /* Number inputs with mobile optimization */
    input[type="number"] {
      -webkit-appearance: none;
      -moz-appearance: textfield;
      appearance: none;
      /* Remove number input arrows */
    }
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    input, select, textarea, button {
      font-size: 16px !important;
    }

    .drawer-section {
      margin: 20px 0;
      border: 2px solid var(--gray-300);
      border-radius: 0;
      overflow: hidden;
    }
    .drawer-header {
      background: var(--light-blue);
      padding: 15px 20px;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 15px;
      color: var(--primary-blue);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .skip-toggle {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 16px;
      color: var(--gray-500);
    }
    .skip-toggle input[type="checkbox"] { width: 20px; height: 20px; }
    .drawer-content { padding: 20px; }
    .denom-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 0;
      border-bottom: 1px solid var(--gray-300);
    }
    .denom-row:last-child { border-bottom: none; }
    .denom-label { font-weight: 500; font-size: 18px; color: var(--gray-700); }
    .denom-value { font-size: 16px; color: var(--gray-500); margin-top: 4px; }

    /* Mobile-Optimized Quantity Inputs */
    .qty-input {
      width: 100px;
      height: 56px;
      text-align: center;
      border: 2px solid var(--gray-300);
      border-radius: 0;
      font-size: 20px;
      font-weight: 500;
      color: var(--gray-700);
      -webkit-appearance: none;
      -moz-appearance: textfield;
      appearance: none;
      transition: all 0.2s ease;
      background: var(--white);
    }
    .qty-input:focus {
      outline: none;
      border-color: var(--primary-blue);
      box-shadow: 0 0 0 3px rgba(44, 95, 141, 0.1);
    }
    /* Remove number arrows */
    .qty-input::-webkit-outer-spin-button,
    .qty-input::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    
    /* Disabled denomination inputs */
    .qty-input:disabled {
      background-color: var(--gray-300);
      color: var(--gray-500);
      border-color: var(--gray-300);
      cursor: not-allowed;
    }

    .denom-row.disabled {
      opacity: 0.5;
    }

    .drawer-total {
      margin-top: 15px;
      padding: 15px;
      background: var(--light-blue);
      border-radius: 0;
      text-align: center;
      font-size: 18px;
      font-weight: 600;
      color: var(--primary-blue);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .grand-total {
      background: linear-gradient(135deg, var(--primary-blue) 0%, var(--secondary-blue) 100%);
      color: var(--white);
      padding: 20px;
      border-radius: 0;
      text-align: center;
      margin: 20px 0;
      box-shadow: 0 4px 12px rgba(44, 95, 141, 0.2);
    }
    .grand-total h3 { font-size: 18px; margin-bottom: 8px; font-weight: 600; opacity: 0.9; text-transform: uppercase; letter-spacing: 0.5px; }
    .grand-total .amount { font-size: 36px; font-weight: 600; }
    .notes-area {
      width: 100%;
      min-height: 100px;
      padding: 18px;
      border: 2px solid var(--gray-300);
      border-radius: 0;
      font-size: 16px;
      resize: vertical;
      box-sizing: border-box;
      transition: all 0.2s ease;
    }
    .notes-area:focus {
      outline: none;
      border-color: var(--primary-blue);
      box-shadow: 0 0 0 3px rgba(44, 95, 141, 0.1);
    }
    .submit-btn {
      padding: 14px 20px;
      background: var(--gray-100);
      color: var(--gray-900);
      border: none;
      border-radius: 0;
      font-size: 12px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.15s ease;
      min-height: 48px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
      text-transform: uppercase;
      letter-spacing: 1.2px;
      border: 2px solid var(--gray-300);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      white-space: nowrap;
    }
    .submit-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.12);
      background: var(--gray-300);
    }
    .submit-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
      background: var(--gray-300);
      color: var(--gray-500);
    }
    .am-total-display {
      background: var(--light-blue);
      padding: 20px;
      border-radius: 0;
      margin: 20px 0;
      border: 2px solid rgba(44, 95, 141, 0.1);
    }
    .am-total-display h4 { margin-bottom: 8px; color: var(--primary-blue); font-size: 16px; font-weight: 500; }
    .am-total-display .amount { font-size: 28px; font-weight: 600; color: var(--primary-blue); }

    /* Enhanced Currency Inputs */
    .currency-input {
      width: 100%;
      padding: 20px;
      border: 2px solid var(--gray-300);
      border-radius: 0;
      font-size: 22px;
      text-align: center;
      min-height: 60px;
      box-sizing: border-box;
      -webkit-appearance: none;
      -moz-appearance: textfield;
      appearance: none;
      transition: all 0.2s ease;
      background: var(--white);
      color: var(--gray-700);
    }
    .currency-input:focus {
      outline: none;
      border-color: var(--primary-blue);
      box-shadow: 0 0 0 3px rgba(44, 95, 141, 0.1);
    }
    .currency-input::-webkit-outer-spin-button,
    .currency-input::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    .confirmation-screen { text-align: center; padding: 40px 20px; }
    .confirmation-screen h2 { color: var(--success); margin-bottom: 30px; font-size: 32px; font-weight: 600; }
    .deposit-instruction {
      background: linear-gradient(135deg, var(--success) 0%, #4A8C63 100%);
      color: var(--white);
      padding: 30px;
      border-radius: 0;
      margin: 25px 0;
      font-size: 24px;
      font-weight: 500;
      box-shadow: 0 4px 12px rgba(95, 167, 119, 0.2);
    }
    .return-instruction {
      background: linear-gradient(135deg, var(--warning) 0%, #C69563 100%);
      color: var(--white);
      padding: 30px;
      border-radius: 0;
      margin: 25px 0;
      font-size: 24px;
      font-weight: 500;
      box-shadow: 0 4px 12px rgba(212, 165, 116, 0.2);
    }
    .thank-you { font-size: 22px; color: var(--success); margin: 30px 0; font-weight: 500; }
    .confirm-btn {
      background: linear-gradient(135deg, var(--success) 0%, #4A8C63 100%);
      margin-top: 30px;
    }
    .loading { text-align: center; padding: 40px; }
    .loading-spinner {
      width: 60px;
      height: 60px;
      border: 6px solid var(--gray-300);
      border-top: 6px solid var(--primary-blue);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .message {
      padding: 18px;
      border-radius: 0;
      margin: 20px 0;
      text-align: center;
      font-size: 15px;
      font-weight: 500;
      letter-spacing: 0.3px;
    }
    .message.success {
      background: #E8F5EC;
      color: #2D5F3F;
      border: 2px solid var(--success);
    }
    .message.error {
      background: #F8E6E7;
      color: #6B3638;
      border: 2px solid var(--error);
    }
    .message.info {
      background: var(--light-blue);
      color: var(--primary-blue);
      border: 2px solid var(--secondary-blue);
    }

    /* Typography - Headers */
    h2, h3, h4, h5, h6 {
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 600;
    }
    h2 { font-size: 22px; }
    h3 { font-size: 19px; }
    h4 { font-size: 16px; }
    h5 { font-size: 14px; }
    h6 { font-size: 12px; }

    /* Tip Pool Calculator Styles */
    .cash-needed { color: var(--error); font-weight: 600; }
    .cash-surplus { color: var(--success); font-weight: 600; }
    .hidden { display: none; }
    .skip-content { padding: 25px; }
    .skip-reason {
      width: 100%;
      padding: 18px;
      border: 2px solid var(--gray-300);
      border-radius: 0;
      font-size: 16px;
      min-height: 56px;
      box-sizing: border-box;
      transition: all 0.2s ease;
    }
    .skip-reason:focus {
      outline: none;
      border-color: var(--primary-blue);
      box-shadow: 0 0 0 3px rgba(44, 95, 141, 0.1);
    }
    
    /* Mobile responsive adjustments */
    @media (max-width: 768px) {
      .container { margin: 0; border-radius: 0; }
      .header { padding: 20px; }
      .header h1 { font-size: 24px; }
      .content { padding: 15px; }
      .main-menu { gap: 12px; }
      .menu-btn { padding: 25px 15px; font-size: 16px; min-height: 70px; }
      .denom-row { flex-direction: column; align-items: flex-start; gap: 12px; padding: 20px 0; }
      .qty-input { width: 120px; margin-top: 8px; }
      .grand-total .amount { font-size: 32px; }
      .confirmation-screen h2 { font-size: 28px; }
      .deposit-instruction, .return-instruction { font-size: 20px; padding: 25px; }
    }
    
    @media (max-width: 768px) {
      .main-menu { grid-template-columns: 1fr 1fr; gap: 12px; }
    }

    @media (max-width: 480px) {
      .header h1 { font-size: 20px; }
      .main-menu { grid-template-columns: 1fr; gap: 10px; }
      .main-menu.show-report { grid-template-columns: 1fr; }
      .menu-btn { padding: 20px 15px; min-height: 60px; }
      .secondary-links { font-size: 10px; gap: 10px; }
      .denom-label { font-size: 16px; }
      .qty-input { width: 100px; height: 50px; font-size: 18px; }
      .grand-total .amount { font-size: 28px; }
      .deposit-instruction, .return-instruction { font-size: 18px; padding: 20px; }
    }
    
    /* Google Sites Full Page Embed Optimizations */
    @media screen {
      html {
        /* Force proper viewport handling in Google Sites */
        height: auto !important;
        min-height: 100% !important;
        overflow-y: auto !important;
      }
      
      body {
        /* Ensure body can scroll properly in Google Sites iframe */
        height: auto !important;
        min-height: 100% !important;
        position: relative !important;
        overflow-y: auto !important;
        padding-bottom: 50px !important; /* Extra space at bottom */
      }
      
      .container {
        /* Ensure container doesn't get viewport-locked */
        position: relative !important;
        height: auto !important;
        min-height: auto !important;
        max-height: none !important;
        overflow: visible !important;
        margin-bottom: 50px !important; /* Extra bottom margin */
      }
      
      .submit-btn {
        /* Ensure submit buttons are always accessible */
        position: relative !important;
        z-index: 10 !important;
        margin-bottom: 30px !important;
      }
      
      /* Force visibility of bottom elements in Google Sites */
      .form-section:last-child,
      .form-section .submit-btn:last-child {
        margin-bottom: 100px !important;
      }
    }
    
    /* Elegant Loading Overlay */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      z-index: 9999;
      display: flex;
      justify-content: center;
      align-items: center;
      transition: opacity 0.3s ease;
    }
    .loading-overlay.hidden {
      display: none;
    }
    .loading-content {
      text-align: center;
      padding: 40px;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 0;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    .loading-spinner-elegant {
      width: 60px;
      height: 60px;
      border: 4px solid rgba(102, 126, 234, 0.1);
      border-top: 4px solid #667eea;
      border-radius: 50%;
      animation: spin-elegant 1.2s linear infinite;
      margin: 0 auto 20px;
    }
    @keyframes spin-elegant {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .loading-content h3 {
      margin: 0 0 10px 0;
      font-size: 24px;
      color: #333;
      font-weight: 600;
    }
    .loading-content p {
      margin: 0;
      font-size: 16px;
      color: #666;
      opacity: 0.8;
    }
    
    /* Success Screens */
    .success-screen {
      text-align: center;
      padding: 40px 20px;
      max-width: 600px;
      margin: 0 auto;
    }
    .success-icon {
      font-size: 80px;
      margin-bottom: 20px;
      animation: success-bounce 0.6s ease;
    }
    @keyframes success-bounce {
      0% { transform: scale(0.3); opacity: 0; }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); opacity: 1; }
    }
    .success-screen h2 {
      color: #28a745;
      margin-bottom: 15px;
      font-size: 32px;
      font-weight: 700;
    }
    .success-message {
      font-size: 18px;
      color: #666;
      margin-bottom: 30px;
      line-height: 1.5;
    }
    .success-details {
      background: #f8f9fa;
      border-radius: 0;
      padding: 25px;
      margin: 25px 0;
      border-left: 4px solid #28a745;
    }
    .detail-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      font-size: 16px;
    }
    .detail-row:not(:last-child) {
      border-bottom: 1px solid #e9ecef;
    }
    .detail-row span:first-child {
      color: #666;
      font-weight: 500;
    }
    .detail-row span:last-child {
      color: #333;
      font-weight: 600;
    }
    .success-btn {
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
      margin-top: 30px;
      font-size: 18px;
      padding: 20px 40px;
      border-radius: 0;
      transition: all 0.3s ease;
    }
    .success-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(40, 167, 69, 0.3);
    }
  </style>
  
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
  <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
  <!-- Tip Pool Calculator Dependencies -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

  <!-- OCR Dependencies -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>
    // Configure PDF.js worker
    if (typeof pdfjsLib !== 'undefined') {
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    }
  </script>
</head>

  <style>
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <!-- Loading Overlay -->
  <div id="loadingOverlay" style="
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    z-index: 9999;
    justify-content: center;
    align-items: center;
  ">
    <div style="
      text-align: center;
      color: white;
    ">
      <div class="spinner" style="
        border: 8px solid #f3f3f3;
        border-top: 8px solid #4CAF50;
        border-radius: 50%;
        width: 60px;
        height: 60px;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
      "></div>
      <h3 id="loadingTitle" style="
        font-size: 18px;
        font-weight: bold;
        margin-bottom: 10px;
      ">Fetching Toast data...</h3>
      <p id="loadingMessage" style="
        font-size: 14px;
        opacity: 0.9;
      ">Please wait...</p>
    </div>
  </div>

  <!-- App Header (Injected by app-header.js) -->
  <div id="appHeader"></div>

  <div class="content">
    <div id="messageArea"></div>
    
      <div id="tipPoolForm" class="form-section">
        <h2 style="margin-bottom: 20px; color: #1e3c72;">Tip Pool Calculator</h2>
        
        <div style="background: #f8f9fa; padding: 15px; border-radius: 0; margin-bottom: 20px; border-left: 4px solid #007bff;">
          <h4 style="margin: 0 0 10px 0; color: #007bff;">Quick Start:</h4>
          <p style="margin: 5px 0; font-size: 14px;">1. Select date range → all data auto-fetches from database and Toast API</p>
          <p style="margin: 5px 0; font-size: 14px;">2. Select your name from "Tips Calculated By" dropdown</p>
          <p style="margin: 5px 0; font-size: 14px;">3. Review auto-fetched values in expandable sections</p>
          <p style="margin: 5px 0; font-size: 14px;">4. Click Calculate Tip Pool</p>
          <p style="margin: 5px 0; font-size: 12px; color: #666;"><em>All fields auto-populate but can be edited if needed</em></p>
        </div>
        
        <!-- Optional manual file uploads (data auto-fetches from Toast API) -->
        <details style="margin: 15px 0; padding: 10px; background: #f8f9fa; border-radius: 0;">
          <summary style="cursor: pointer; font-size: 13px; color: #666; font-weight: 600;">
            Manual File Upload (Optional - Click to expand)
          </summary>
          <div style="margin-top: 15px;">
            <div class="form-group" style="margin-bottom: 10px;">
              <label for="laborFile" style="font-size: 12px;">Labor Summary CSV File:</label>
              <input type="file" id="laborFile" class="form-input" accept=".csv" style="padding: 8px;">
            </div>

            <div class="form-group" style="margin-bottom: 0;">
              <label for="salesFile" style="font-size: 12px;">Sales Summary ZIP File:</label>
              <input type="file" id="salesFile" class="form-input" accept=".zip" style="padding: 8px;">
            </div>
          </div>
        </details>

        <div class="form-group">
          <label for="tipPoolDateRange">Date Range for Tip Pool:</label>
          <div style="display: flex; gap: 15px; margin: 10px 0;">
            <div style="flex: 1;">
              <label for="tipPoolStartDate" style="font-size: 12px; color: #666;">Start Date:</label>
              <input type="date" id="tipPoolStartDate" class="form-input" onchange="calculateCashTips()">
            </div>
            <div style="flex: 1;">
              <label for="tipPoolEndDate" style="font-size: 12px; color: #666;">End Date:</label>
              <input type="date" id="tipPoolEndDate" class="form-input" onchange="calculateCashTips(); autoFetchOnDateChange()">
            </div>
          </div>
          <div id="autoFetchStatus" style="font-size: 11px; color: #666; margin-top: 5px; min-height: 16px;">
            <!-- Auto-fetch status will appear here -->
          </div>
        </div>
        
        <!-- Tips Calculated By (always visible) -->
        <div class="form-group">
          <label for="calculatedByName">Tips Calculated By:</label>
          <select id="calculatedByName" class="form-input">
            <option value="">Select Name</option>
            <option value="Demetri Gregorakis">Demetri Gregorakis</option>
          </select>
        </div>

        <!-- Real Envelope Deposit (Expandable Section) -->
        <details style="margin: 15px 0; padding: 10px; background: #f8f9fa; border-radius: 0;" ontoggle="updateEnvelopeDepositSummary()">
          <summary style="cursor: pointer; font-size: 13px; color: #666; font-weight: 600;">
            Real Envelope Deposit <span id="envelopeDepositSummaryAmount" style="color: #007bff; font-weight: 700;">$0.00</span>
          </summary>
          <div style="margin-top: 15px;">
            <div class="form-group" style="margin-bottom: 0;">
              <label for="realEnvelopeDeposit">Real Envelope Deposit ($):</label>
              <input type="number" id="realEnvelopeDeposit" class="form-input" step="1" placeholder="e.g., 550" inputmode="numeric" pattern="[0-9]*" onchange="calculateCashTips(); updateEnvelopeDepositSummary();">
              <div style="font-size: 12px; color: #666; margin-top: 5px;">
                Auto-fetched from database (editable)
              </div>
            </div>
          </div>
        </details>

        <!-- All Tips (Expandable Section) -->
        <details style="margin: 15px 0; padding: 10px; background: #f8f9fa; border-radius: 0;" ontoggle="updateTipsSummary()">
          <summary style="cursor: pointer; font-size: 13px; color: #666; font-weight: 600;">
            All Tips <span id="tipsSummaryAmount" style="color: #007bff; font-weight: 700;">$0.00</span>
          </summary>
          <div style="margin-top: 15px;">
            <div class="form-group">
              <label for="calculatedCashTips">Cash Tips (Auto-Calculated):</label>
              <input type="number" id="calculatedCashTips" class="form-input" step="0.01" inputmode="decimal" readonly style="background: #f8f9fa; color: #666;" onchange="updateTipsSummary()">
              <div style="font-size: 12px; color: #666; margin-top: 5px;">
                Formula: Real Envelope Deposit - Toast Cash Sales
              </div>
            </div>

            <div class="form-group">
              <label for="tdsDriverTips">TDS Driver Tips ($):</label>
              <input type="number" id="tdsDriverTips" class="form-input" step="0.01" inputmode="decimal" readonly style="background: #f8f9fa; color: #666;" onchange="updateTipsSummary()">
              <div id="tdsAutoFetchStatus" style="font-size: 12px; color: #666; margin-top: 5px;">Auto-calculated from Toast API</div>
            </div>

            <div class="form-group" style="margin-bottom: 0;">
              <label for="ezcaterTips">EZCater Tips ($):</label>
              <input type="number" id="ezcaterTips" class="form-input" step="0.01" inputmode="decimal" onchange="updateTipsSummary()">
              <div id="ezcaterAutoFetchStatus" style="font-size: 12px; color: #666; margin-top: 5px;">Auto-fetched from database (editable)</div>
            </div>
          </div>
        </details>

        <!-- Sales & Labor (Expandable Section) -->
        <details style="margin: 15px 0; padding: 10px; background: #f8f9fa; border-radius: 0;" ontoggle="updateSalesLaborSummary()">
          <summary style="cursor: pointer; font-size: 13px; color: #666; font-weight: 600;">
            Sales & Labor <span id="salesLaborSummaryAmount" style="color: #007bff; font-weight: 700; font-size: 11px;">Sales: $0.00 | Labor: $0.00</span>
          </summary>
          <div style="margin-top: 15px;">
            <div class="form-group">
              <label for="ezcaterNetSales">EZCater Net Sales ($):</label>
              <input type="number" id="ezcaterNetSales" class="form-input" step="0.01" inputmode="decimal" onchange="updateSalesLaborSummary()">
              <div id="ezcaterNetSalesAutoFetchStatus" style="font-size: 12px; color: #666; margin-top: 5px;">Auto-fetched from database (editable)</div>
            </div>

            <div class="form-group">
              <label for="manualNetSales">Manual Net Sales (Optional):</label>
              <input type="number" id="manualNetSales" class="form-input" step="0.01" placeholder="e.g., 31250.45" inputmode="decimal" onchange="updateSalesLaborSummary()">
              <div style="font-size: 12px; color: #666; margin-top: 5px;">
                Enter if API data doesn't match Toast web reports
              </div>
            </div>

            <div class="form-group" style="margin-bottom: 0;">
              <label for="manualLaborCost">Total Labor Cost (Optional):</label>
              <input type="number" id="manualLaborCost" class="form-input" step="0.01" placeholder="e.g., 9637.82" inputmode="decimal" onchange="updateSalesLaborSummary()">
              <div style="font-size: 12px; color: #666; margin-top: 5px;">
                Enter "Total Cost" from Toast web for exact calculations
              </div>
            </div>
          </div>
        </details>

        <!-- Custom Notes (Expandable Section) -->
        <details style="margin: 15px 0; padding: 10px; background: #f8f9fa; border-radius: 0;">
          <summary style="cursor: pointer; font-size: 13px; color: #666; font-weight: 600;">
            + ADD NOTES
          </summary>
          <div style="margin-top: 15px;">
            <div class="form-group" style="margin-bottom: 0;">
              <label for="tipPoolNotes">Custom Notes (Optional):</label>
              <textarea id="tipPoolNotes" class="form-input" rows="3" placeholder="Enter any notes or adjustments for this tip pool calculation..."></textarea>
            </div>
          </div>
        </details>

        <!-- Hidden field for ezcaterSales (will be auto-calculated) -->
        <input type="hidden" id="ezcaterSales" value="0">

        <!-- Cashbox Count Section (Collapsible) -->
        <details style="margin: 15px 0; padding: 10px; background: #f8f9fa; border-radius: 0;">
          <summary style="cursor: pointer; font-size: 13px; color: #666; font-weight: 600;">
            Cashbox Count (Optional - Click to expand)
          </summary>
          <div style="margin-top: 15px;">
            <p style="color: #666; font-size: 12px; margin-bottom: 15px;">
              Count all cash and coins in the cashbox <strong>before</strong> generating the combined report. This enables weekly reconciliation tracking.
            </p>

            <!-- Counter Name Selection -->
            <div class="form-group">
              <label for="tipPoolCashboxCounter">Counted by:</label>
              <select id="tipPoolCashboxCounter" class="form-select" onchange="toggleTipPoolCashboxInputs()">
                <option value="">Choose Name (or skip if not counting today)</option>
                <option value="Demetri Gregorakis">Demetri Gregorakis</option>
                <option value="Ahmet Can Guler">Ahmet Can Guler</option>
                <option value="Kayla Mccullough">Kayla Mccullough</option>
                <option value="Dilan Uzum">Dilan Uzum</option>
                <option value="Other">Other</option>
              </select>
            </div>

            <div class="form-group" id="tipPoolCashboxOtherNameGroup" style="display: none;">
              <label for="tipPoolCashboxOtherName">Enter your name:</label>
              <input type="text" id="tipPoolCashboxOtherName" class="form-input" placeholder="Full Name">
            </div>

            <!-- Denomination Inputs -->
            <div id="tipPoolCashboxDenominationInputs" style="display: none; margin-top: 15px;">
              <h5 style="color: #666; margin-bottom: 15px;">Count by Denomination</h5>

              <!-- Bills Section -->
              <div style="background: #f8f9fa; padding: 15px; border-radius: 0; margin-bottom: 15px; border: 1px solid #ddd;">
                <h6 style="color: #666; margin-bottom: 10px; font-size: 13px;">Bills</h6>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px;">
                  <div class="denomination-group">
                    <label style="font-size: 12px;">$100 bills:</label>
                    <input type="number" id="tipPool_cashbox_hundreds" class="form-input" min="0" value="0" inputmode="numeric" onchange="calculateTipPoolCashboxTotal()">
                  </div>
                  <div class="denomination-group">
                    <label style="font-size: 12px;">$50 bills:</label>
                    <input type="number" id="tipPool_cashbox_fifties" class="form-input" min="0" value="0" inputmode="numeric" onchange="calculateTipPoolCashboxTotal()">
                  </div>
                  <div class="denomination-group">
                    <label style="font-size: 12px;">$20 bills:</label>
                    <input type="number" id="tipPool_cashbox_twenties" class="form-input" min="0" value="0" inputmode="numeric" onchange="calculateTipPoolCashboxTotal()">
                  </div>
                  <div class="denomination-group">
                    <label style="font-size: 12px;">$10 bills:</label>
                    <input type="number" id="tipPool_cashbox_tens" class="form-input" min="0" value="0" inputmode="numeric" onchange="calculateTipPoolCashboxTotal()">
                  </div>
                  <div class="denomination-group">
                    <label style="font-size: 12px;">$5 bills:</label>
                    <input type="number" id="tipPool_cashbox_fives" class="form-input" min="0" value="0" inputmode="numeric" onchange="calculateTipPoolCashboxTotal()">
                  </div>
                  <div class="denomination-group">
                    <label style="font-size: 12px;">$1 bills:</label>
                    <input type="number" id="tipPool_cashbox_ones" class="form-input" min="0" value="0" inputmode="numeric" onchange="calculateTipPoolCashboxTotal()">
                  </div>
                </div>
              </div>

              <!-- Coins Section -->
              <div style="background: #f8f9fa; padding: 15px; border-radius: 0; margin-bottom: 15px; border: 1px solid #ddd;">
                <h6 style="color: #666; margin-bottom: 10px; font-size: 13px;">Coins</h6>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px;">
                  <div class="denomination-group">
                    <label style="font-size: 12px;">Quarters:</label>
                    <input type="number" id="tipPool_cashbox_quarters" class="form-input" min="0" value="0" inputmode="numeric" onchange="calculateTipPoolCashboxTotal()">
                  </div>
                  <div class="denomination-group">
                    <label style="font-size: 12px;">Dimes:</label>
                    <input type="number" id="tipPool_cashbox_dimes" class="form-input" min="0" value="0" inputmode="numeric" onchange="calculateTipPoolCashboxTotal()">
                  </div>
                  <div class="denomination-group">
                    <label style="font-size: 12px;">Nickels:</label>
                    <input type="number" id="tipPool_cashbox_nickels" class="form-input" min="0" value="0" inputmode="numeric" onchange="calculateTipPoolCashboxTotal()">
                  </div>
                  <div class="denomination-group">
                    <label style="font-size: 12px;">Pennies:</label>
                    <input type="number" id="tipPool_cashbox_pennies" class="form-input" min="0" value="0" inputmode="numeric" onchange="calculateTipPoolCashboxTotal()">
                  </div>
                </div>
              </div>

              <!-- Total Display -->
              <div style="background: #fff; padding: 20px; border-radius: 0; text-align: center; border: 2px solid #ddd;">
                <h5 style="margin: 0 0 10px 0; color: #666; font-size: 14px; text-transform: uppercase;">Total Cashbox Amount</h5>
                <div id="tipPoolCashboxTotal" style="font-size: 28px; font-weight: bold; color: #333;">$0.00</div>
                <div style="font-size: 12px; color: #666; margin-top: 8px;">This will be used for weekly reconciliation on the combined report</div>
              </div>
            </div>
          </div>
        </details>

        <button class="submit-btn" onclick="calculateTipPool()">Calculate Tip Pool</button>
        <button class="submit-btn" onclick="downloadTipPoolPDF()" id="tipPoolPdfBtn" style="margin-left: 10px; display: none;">Download Tip Pool PDF</button>
        <button class="submit-btn" onclick="clearSavedData()" style="margin-left: 10px;" title="Clear all saved data and start fresh">Clear Saved Data</button>
        

        
        <!-- Tip Pool Results Display -->
        <div id="tipPoolResults" style="display: none; margin-top: 20px;">
          <div id="tipPoolSummary"></div>
          <div id="tipPoolTable"></div>
          
          <!-- Combined Report Section - Auto-populated -->
          <div id="combinedReportSection" style="display: none; margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 0; border: 2px solid #6f42c1;">
            <h4 style="margin: 0 0 15px 0; color: #6f42c1;">Weekly Combined Report</h4>
            <p style="margin: 0 0 15px 0; font-size: 14px; color: #666;">
              Generate a comprehensive weekly summary combining your tip pool calculations with cash count reports.
            </p>
            
            <!-- PDF Upload Options -->
            <div style="margin-bottom: 20px; padding: 15px; background: white; border-radius: 0; border: 1px solid #ddd;">
              <h5 style="margin: 0 0 10px 0; color: #333;">Attach Additional PDFs (Optional)</h5>
              
              <div style="display: flex; gap: 15px; margin-bottom: 10px;">
                <div style="flex: 1;">
                  <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #555;">Add Weekly Voids Log:</label>
                  <input type="file" id="voidsLogUpload" accept=".pdf" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 0;">
                </div>
                <div style="flex: 1;">
                  <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #555;">Add Extras:</label>
                  <input type="file" id="extrasUpload" accept=".pdf" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 0;">
                </div>
              </div>
              
              <p style="margin: 5px 0 0 0; font-size: 12px; color: #666;">
                Upload PDFs to include in your weekly report. Order: Generated Report → Voids Log → Extras
              </p>
            </div>
            
            <div style="display: flex; gap: 15px; align-items: center;">
              <button class="submit-btn" onclick="generateCombinedReport()" style="flex: 1;">Generate Combined Weekly Report</button>
            </div>
            
            <!-- Hidden inputs for auto-populated data -->
            <input type="hidden" id="combinedStartDate">
            <input type="hidden" id="combinedEndDate">
            <input type="hidden" id="combinedRealEnvelope">
          </div>
        </div>
        
        <!-- Hidden Tip Pool Report Display for PDF generation -->
        <div id="tipPoolReportDisplay" style="display: none; position: fixed; top: 0; left: 0; width: 800px; background: white; z-index: 9999; opacity: 0; pointer-events: none;">
          <div id="tipPoolReportContent"></div>
        </div>

        <button class="submit-btn" onclick="goHome()" style="margin-top: 10px;">Back to Menu</button>
      </div>
  </div>

<script>
  // ====================================
  // CONFIGURATION & INITIALIZATION
  // ====================================

  const SUPABASE_URL = 'https://gaawtbqpnnbbnsyswqwv.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdhYXd0YnFwbm5iYm5zeXN3cXd2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1MDE1NTAsImV4cCI6MjA3MjA3NzU1MH0.F-y7AIQTWaUe7DRT4OnIZVn94mhXxfhpBbng2aJ8nXg';
  const PACIFIC_TIMEZONE = 'America/Los_Angeles';
  const TDS_DRIVER_GUID = '5ffaae6f-4238-477d-979b-3da88d45b8e2';
  let supabase;
  function initializeSupabase() {
    if (SUPABASE_URL === 'YOUR_SUPABASE_URL_HERE' || SUPABASE_ANON_KEY === 'YOUR_SUPABASE_ANON_KEY_HERE') {
      showMessage('Please configure Supabase credentials', 'error');
      return;
    }
    try {
      supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      console.log('Supabase initialized');
    } catch (error) {
      console.error('Supabase init failed:', error);
      showMessage('Database connection failed', 'error');
    }
  }

  /**
   * Determine the offset (in minutes) for Pacific time at a specific moment.
   * We rely on Intl to hand us either PDT/PST or a GMT offset string.
   */
  function getPacificOffsetMinutes(date) {
    const parts = new Intl.DateTimeFormat('en-US', {
      timeZone: PACIFIC_TIMEZONE,
      timeZoneName: 'short'
    }).formatToParts(date);

    const tzName = parts.find(part => part.type === 'timeZoneName')?.value || 'PST';

    if (tzName.includes('PDT')) return 420; // UTC-7
    if (tzName.includes('PST')) return 480; // UTC-8

    const gmtMatch = tzName.match(/GMT([+-]\d{2})(\d{2})?/i);
    if (gmtMatch) {
      const hours = parseInt(gmtMatch[1], 10);
      const minutes = gmtMatch[2] ? parseInt(gmtMatch[2], 10) : 0;
      return Math.abs(hours) * 60 + minutes;
    }

    // Default to standard time if we hit an unexpected string.
    return 480;
  }

  /**
   * Create a Date that represents a Pacific-local wall clock time by
   * translating the supplied components into the correct UTC instant.
   * We default to 12:00 (noon) to avoid DST edge cases right at midnight.
   */
  function createPacificDate(year, month, day, hour = 12, minute = 0, second = 0) {
    const utcMillis = Date.UTC(year, month - 1, day, hour, minute, second);
    const tempUtcDate = new Date(utcMillis);
    const offsetMinutes = getPacificOffsetMinutes(tempUtcDate);
    return new Date(utcMillis + offsetMinutes * 60000);
  }

  /**
   * Convert any JS Date into a Pacific-local date (defaulting to midday).
   */
  function getPacificMidday(date = new Date()) {
    const parts = new Intl.DateTimeFormat('en-US', {
      timeZone: PACIFIC_TIMEZONE,
      year: 'numeric',
      month: '2-digit',
      day: '2-digit'
    }).formatToParts(date);

    const year = Number(parts.find(part => part.type === 'year')?.value);
    const month = Number(parts.find(part => part.type === 'month')?.value);
    const day = Number(parts.find(part => part.type === 'day')?.value);

    return createPacificDate(year, month, day, 12, 0, 0);
  }

  /**
   * Parse a YYYY-MM-DD string into a Pacific-local Date (midday).
   */
  function parsePacificDate(dateString) {
    if (!dateString) return null;
    const [year, month, day] = dateString.split('-').map(Number);
    if (!year || !month || !day) return null;
    return createPacificDate(year, month, day, 12, 0, 0);
  }

  /**
   * Format a Date as YYYY-MM-DD in Pacific time.
   */
  function formatPacificDate(date) {
    if (!date) return '';
    const parts = new Intl.DateTimeFormat('en-US', {
      timeZone: PACIFIC_TIMEZONE,
      year: 'numeric',
      month: '2-digit',
      day: '2-digit'
    }).formatToParts(date);

    const year = parts.find(part => part.type === 'year')?.value;
    const month = parts.find(part => part.type === 'month')?.value;
    const day = parts.find(part => part.type === 'day')?.value;

    return `${year}-${month}-${day}`;
  }

  /**
   * Format helper for display strings while forcing Pacific timezone.
   */
  function formatPacificDateDisplay(date, options = {}) {
    if (!date) return '';
    return new Intl.DateTimeFormat('en-US', {
      timeZone: PACIFIC_TIMEZONE,
      ...options
    }).format(date);
  }

  function formatPacificWeekday(date) {
    return formatPacificDateDisplay(date, { weekday: 'long' });
  }

  function getPacificHour(date) {
    if (!date) return null;
    const hourString = new Intl.DateTimeFormat('en-US', {
      timeZone: PACIFIC_TIMEZONE,
      hour: '2-digit',
      hour12: false
    }).format(date);
    return Number(hourString);
  }

  /**
   * Add days to a Pacific Date and return the normalized Pacific midday Date.
   */
  function addPacificDays(date, days) {
    if (!date) return null;
    const pacificMidday = getPacificMidday(date);
    const nextUtc = new Date(pacificMidday.getTime() + days * 86400000);
    return getPacificMidday(nextUtc);
  }

  /**
   * Return the current Pacific date as YYYY-MM-DD (optionally pass a Date).
   */
  function getPacificDate(date = new Date()) {
    return formatPacificDate(date);
  }
  function showLoading(title, message) {
    const overlay = document.getElementById('loadingOverlay');
    document.getElementById('loadingTitle').textContent = title;
    document.getElementById('loadingMessage').textContent = message;
    overlay.style.display = 'flex'; // Override inline style
    // Don't hide sections - loading overlay should appear on top, not replace content
  }

  function hideLoading() {
    document.getElementById('loadingOverlay').style.display = 'none';
  }
  function showMessage(text, type) {
    // Only show popups for important messages (errors), ignore info/success
    if (type === 'error') {
      showPopupMessage(text, type);
    }
    // Silently ignore info and success messages to prevent bouncing
  }
  
  function showPopupMessage(text, type) {
    const messageType = type === 'error' ? 'Error' : type === 'success' ? 'Success' : 'Notice';
    const backgroundColor = type === 'error' ? '#f44336' : '#4CAF50';
    const iconEmoji = '';
    
    const modalHTML = `
      <div id="messageModal" style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.7);
        z-index: 10000;
        display: flex;
        justify-content: center;
        align-items: center;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      ">
        <div style="
          background: white;
          padding: 30px;
          border-radius: 0;
          box-shadow: 0 10px 30px rgba(0,0,0,0.3);
          max-width: 400px;
          width: 90%;
          text-align: center;
        ">
          <h3 style="margin: 0 0 20px 0; color: ${backgroundColor};">${iconEmoji} ${messageType}</h3>
          <p style="margin: 0 0 25px 0; line-height: 1.4; font-size: 16px;">
            ${text}
          </p>
          <button onclick="closeMessageModal()" style="
            background: ${backgroundColor};
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 0;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
          ">OK</button>
        </div>
      </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
  }
  
  function closeMessageModal() {
    const modal = document.getElementById('messageModal');
    if (modal) {
      modal.remove();
    }
  }
  function hideAllSections() {
    // For tip-pool.html, we only have one section, so this is a no-op
    // But we need it defined because tip pool code might call it
  }

  function goHome() {
    // Reload current page to refresh data
    window.location.href = 'tip-pool.html';
  }
  // ===== TIP POOL CALCULATOR FUNCTIONS =====
  
  // Global state for tip pool calculations
  let tipPoolRecords = [];
  let tipPoolSummary = {};
  
  // Predefined equity mapping - can be extended as needed
  const defaultEquity = {
    'Dokcu, Huseyin': 0.5,
    'Morales, Emilio': 0.5
  };

  // Helper function to show error messages
  function showErrorMessage(message, targetSectionId = null) {
    const errorMsg = document.createElement('div');
    errorMsg.className = 'message error';
    errorMsg.innerHTML = `<strong>Error:</strong> ${message}`;
    
    let targetSection;
    
    if (targetSectionId) {
      // Use specified target section
      targetSection = document.getElementById(targetSectionId);
    } else {
      // Find the currently active section
      targetSection = document.querySelector('.form-section.active');
    }
    
    if (targetSection) {
      // Insert at the top of the target section
      const firstChild = targetSection.firstElementChild;
      targetSection.insertBefore(errorMsg, firstChild.nextSibling);
    } else {
      // Fallback to tip pool form if no target section found
      const tipPoolForm = document.getElementById('tipPoolForm');
      const firstChild = tipPoolForm.firstElementChild;
      tipPoolForm.insertBefore(errorMsg, firstChild.nextSibling);
    }
    
    // Remove message after 8 seconds (longer for historical report errors)
    setTimeout(() => {
      if (errorMsg.parentNode) {
        errorMsg.remove();
      }
    }, 8000);
  }

  // Helper function to show success messages
  function showSuccessMessage(message, targetSectionId = 'tipPoolForm') {
    console.log('showSuccessMessage called with:', message);
    const successMsg = document.createElement('div');
    successMsg.className = 'message success';
    successMsg.innerHTML = `<strong>Success:</strong> ${message}`;
    
    // Insert at the top of the specified form
    const targetForm = document.getElementById(targetSectionId);
    console.log(`${targetSectionId} form found:`, targetForm);
    const firstChild = targetForm.firstElementChild;
    targetForm.insertBefore(successMsg, firstChild.nextSibling);
    console.log('Success message inserted');
    
    // Remove message after 5 seconds
    setTimeout(() => {
      if (successMsg.parentNode) {
        successMsg.remove();
      }
    }, 5000);
    console.log('showSuccessMessage completed');
  }

  // ===== DATA PERSISTENCE FUNCTIONS =====
  
  // Save tip pool data to localStorage - DISABLED to reset fields every time
  function saveTipPoolData() {
    // No-op: Tip pool fields now reset every time instead of persisting
    console.log('Tip pool localStorage persistence disabled - fields will reset every time');
  }
  
  // Load tip pool data from localStorage - DISABLED to reset fields every time
  function loadTipPoolData() {
    // No-op: Tip pool fields now reset every time instead of loading from localStorage
    console.log('Tip pool localStorage loading disabled - fields start fresh every time');
    return false;
  }

  // ===== TIP POOL CASHBOX FUNCTIONS =====

  function toggleTipPoolCashboxInputs() {
    const counterSelect = document.getElementById('tipPoolCashboxCounter');
    const otherNameGroup = document.getElementById('tipPoolCashboxOtherNameGroup');
    const denominationInputs = document.getElementById('tipPoolCashboxDenominationInputs');

    if (counterSelect.value === 'Other') {
      otherNameGroup.style.display = 'block';
      denominationInputs.style.display = 'block';
    } else if (counterSelect.value) {
      otherNameGroup.style.display = 'none';
      denominationInputs.style.display = 'block';
    } else {
      otherNameGroup.style.display = 'none';
      denominationInputs.style.display = 'none';
    }
  }

  function calculateTipPoolCashboxTotal() {
    const denominations = [
      { id: 'tipPool_cashbox_hundreds', value: 100 },
      { id: 'tipPool_cashbox_fifties', value: 50 },
      { id: 'tipPool_cashbox_twenties', value: 20 },
      { id: 'tipPool_cashbox_tens', value: 10 },
      { id: 'tipPool_cashbox_fives', value: 5 },
      { id: 'tipPool_cashbox_ones', value: 1 },
      { id: 'tipPool_cashbox_quarters', value: 0.25 },
      { id: 'tipPool_cashbox_dimes', value: 0.10 },
      { id: 'tipPool_cashbox_nickels', value: 0.05 },
      { id: 'tipPool_cashbox_pennies', value: 0.01 }
    ];

    const total = denominations.reduce((sum, denom) => {
      const count = parseInt(document.getElementById(denom.id).value) || 0;
      return sum + (count * denom.value);
    }, 0);

    document.getElementById('tipPoolCashboxTotal').textContent = `$${total.toFixed(2)}`;
    return total;
  }

  function getTipPoolCashboxData() {
    // Get counter name
    const counterSelect = document.getElementById('tipPoolCashboxCounter');
    let counterName = counterSelect.value;

    if (counterName === 'Other') {
      counterName = document.getElementById('tipPoolCashboxOtherName').value;
    }

    // If no counter selected, return null (cashbox count is optional)
    if (!counterName) {
      return null;
    }

    // Get total
    const total = calculateTipPoolCashboxTotal();

    // If total is 0, return null
    if (total === 0) {
      return null;
    }

    // Get denominations
    const denominations = {
      hundreds: parseInt(document.getElementById('tipPool_cashbox_hundreds').value) || 0,
      fifties: parseInt(document.getElementById('tipPool_cashbox_fifties').value) || 0,
      twenties: parseInt(document.getElementById('tipPool_cashbox_twenties').value) || 0,
      tens: parseInt(document.getElementById('tipPool_cashbox_tens').value) || 0,
      fives: parseInt(document.getElementById('tipPool_cashbox_fives').value) || 0,
      ones: parseInt(document.getElementById('tipPool_cashbox_ones').value) || 0,
      quarters: parseInt(document.getElementById('tipPool_cashbox_quarters').value) || 0,
      dimes: parseInt(document.getElementById('tipPool_cashbox_dimes').value) || 0,
      nickels: parseInt(document.getElementById('tipPool_cashbox_nickels').value) || 0,
      pennies: parseInt(document.getElementById('tipPool_cashbox_pennies').value) || 0
    };

    return {
      date: new Date().toISOString().split('T')[0],
      counter: counterName,
      total: total,
      denominations: denominations
    };
  }

  async function saveCashboxCountFromTipPool(cashboxData) {
    try {
      console.log('💾 Saving cashbox count from tip pool:', cashboxData);

      // Save to database
      const { data, error } = await supabase
        .from('cashbox_counts')
        .insert([{
          date: cashboxData.date,
          counter: cashboxData.counter,
          total: cashboxData.total,
          denominations: cashboxData.denominations,
          notes: 'Entered from tip pool calculator'
        }]);

      if (error) {
        // Check if it's a duplicate date error
        if (error.code === '23505') {
          console.log('⚠️ Cashbox count already exists for this date, updating instead...');
          const { data: updateData, error: updateError } = await supabase
            .from('cashbox_counts')
            .update({
              counter: cashboxData.counter,
              total: cashboxData.total,
              denominations: cashboxData.denominations,
              notes: 'Updated from tip pool calculator'
            })
            .eq('date', cashboxData.date);

          if (updateError) throw updateError;
          console.log('✅ Cashbox count updated successfully');
        } else {
          throw error;
        }
      } else {
        console.log('✅ Cashbox count saved successfully');
      }

      return cashboxData.total;
    } catch (error) {
      console.error('❌ Error saving cashbox count:', error);
      throw error;
    }
  }

  // Save combined report data to localStorage
  function saveCombinedReportData() {
    try {
      const combinedData = {
        formData: {
          startDate: document.getElementById('combinedStartDate').value,
          endDate: document.getElementById('combinedEndDate').value,
          realEnvelope: document.getElementById('combinedRealEnvelope').value
        },
        lastCashData: window.lastCombinedCashData || null,
        timestamp: new Date().toISOString()
      };
      localStorage.setItem('jaynaGyroCashCounter_combinedReportData', JSON.stringify(combinedData));
      console.log('Combined report data saved to localStorage');
    } catch (error) {
      console.error('Error saving combined report data:', error);
    }
  }
  
  // Load combined report data from localStorage
  function loadCombinedReportData() {
    try {
      const saved = localStorage.getItem('jaynaGyroCashCounter_combinedReportData');
      if (!saved) return false;
      
      const combinedData = JSON.parse(saved);
      
      // Restore form data
      if (combinedData.formData) {
        const form = combinedData.formData;
        document.getElementById('combinedStartDate').value = form.startDate || '';
        document.getElementById('combinedEndDate').value = form.endDate || '';
        document.getElementById('combinedRealEnvelope').value = form.realEnvelope || '';
      }
      
      // Restore cash data for re-generation
      if (combinedData.lastCashData) {
        window.lastCombinedCashData = combinedData.lastCashData;
      }
      
      console.log('Combined report data loaded from localStorage');
      return true;
    } catch (error) {
      console.error('Error loading combined report data:', error);
      return false;
    }
  }
  
  // Clear all saved data
  function clearSavedData() {
    try {
      localStorage.removeItem('jaynaGyroCashCounter_tipPoolData');
      localStorage.removeItem('jaynaGyroCashCounter_combinedReportData');
      
      // Reset tip pool state
      tipPoolRecords = [];
      tipPoolSummary = {};

      // Note: tipPoolForm is a div, not a form element, so we manually clear inputs
      // Clear tip pool form inputs
      const tipPoolInputs = document.getElementById('tipPoolForm').querySelectorAll('input, select, textarea');
      tipPoolInputs.forEach(input => {
        if (input.type === 'checkbox' || input.type === 'radio') {
          input.checked = false;
        } else {
          input.value = '';
        }
      });
      
      // Hide results
      document.getElementById('tipPoolResults').style.display = 'none';
      document.getElementById('tipPoolPdfBtn').style.display = 'none';
      document.getElementById('combinedReportSection').style.display = 'none';
      document.getElementById('tipPoolForm').classList.remove('active');
      
      showSuccessMessage('All saved data cleared. You can start fresh.');
      console.log('All saved data cleared');
    } catch (error) {
      console.error('Error clearing saved data:', error);
      showErrorMessage('Error clearing saved data: ' + error.message);
    }
  }

  // Global variable to store TDS fetch status
  let tdsDataStatus = {
    isFetching: false,
    hasData: false,
    data: 0,
    error: null
  };

  async function calculateCashTips() {
    const startDate = document.getElementById('tipPoolStartDate').value;
    const endDate = document.getElementById('tipPoolEndDate').value;
    const realEnvelopeDeposit = parseFloat(document.getElementById('realEnvelopeDeposit').value) || 0;

    if (!startDate || !endDate) {
      document.getElementById('calculatedCashTips').value = '';
      // Reset TDS data when dates are cleared
      resetTdsData();
      updateCalculateButtonState();
      return;
    }

    if (!realEnvelopeDeposit) {
      document.getElementById('calculatedCashTips').value = '';
      return;
    }

    try {
      // PRIORITY 1: Use API-fetched cash sales if available
      let totalToastCashSales = 0;

      if (apiFetchedData.salesData && apiFetchedData.salesData.cashSales) {
        // Use API data (more accurate)
        totalToastCashSales = apiFetchedData.salesData.cashSales;
        console.log('calculateCashTips: Using API cash sales:', totalToastCashSales);
      } else {
        // PRIORITY 2: Fall back to database PM data if API data not available
        const { data: rangeData } = await supabase
          .from('cash_counts')
          .select('*')
          .gte('date', startDate)
          .lte('date', endDate)
          .not('pm_total', 'is', null)
          .order('date', { ascending: true });

        if (!rangeData || rangeData.length === 0) {
          document.getElementById('calculatedCashTips').value = '';
          return;
        }

        // Calculate total Toast cash sales using correct column name
        totalToastCashSales = rangeData.reduce((sum, day) => sum + (day.pm_toast_sales || 0), 0);
        console.log('calculateCashTips: Using PM database data:', totalToastCashSales);
      }

      // Calculate cash tips: Real Envelope Deposit - Toast Cash Sales
      const calculatedCashTips = realEnvelopeDeposit - totalToastCashSales;

      // Update the display
      document.getElementById('calculatedCashTips').value = calculatedCashTips.toFixed(2);

      // TDS Driver tips are now auto-fetched with other data when dates change (no delay!)

      // Update summary displays
      updateTipsSummary();
      updateEnvelopeDepositSummary();

    } catch (error) {
      console.error('Error calculating cash tips:', error);
      document.getElementById('calculatedCashTips').value = '';
    }
  }

  function resetTdsData() {
    tdsDataStatus = {
      isFetching: false,
      hasData: false,
      data: 0,
      error: null
    };
    
    // Reset UI
    document.getElementById('tdsAutoFetchStatus').innerHTML = '<span style="color: #666;">Auto-calculated from Toast API when you calculate tip pool</span>';
    document.getElementById('tdsDriverTips').value = '0';
  }

  function updateCalculateButtonState() {
    const calculateBtn = document.querySelector('button[onclick="calculateTipPool()"]');
    const startDate = document.getElementById('tipPoolStartDate').value;
    const endDate = document.getElementById('tipPoolEndDate').value;
    
    if (!startDate || !endDate) {
      calculateBtn.disabled = true;
      calculateBtn.textContent = 'Calculate Tip Pool';
      calculateBtn.style.background = '#6c757d';
    } else if (tdsDataStatus.isFetching) {
      calculateBtn.disabled = true;
      calculateBtn.textContent = 'Fetching TDS Data...';
      calculateBtn.style.background = '#ffc107';
    } else if (tdsDataStatus.hasData || tdsDataStatus.error) {
      calculateBtn.disabled = false;
      calculateBtn.textContent = 'Calculate Tip Pool';
      calculateBtn.style.background = '#28a745';
    } else {
      calculateBtn.disabled = true;
      calculateBtn.textContent = 'Calculate Tip Pool';
      calculateBtn.style.background = '#6c757d';
    }
  }

  async function autoFetchTdsDriverTips(startDate, endDate, retryCount = 0) {
    // Only fetch if not already fetching for these dates
    if (tdsDataStatus.isFetching) {
      return;
    }

    console.log('Auto-fetching TDS Driver tips for date range:', startDate, 'to', endDate);
    
    tdsDataStatus.isFetching = true;
    tdsDataStatus.hasData = false;
    tdsDataStatus.error = null;
    
    // Update UI to show fetching
    document.getElementById('tdsAutoFetchStatus').innerHTML = '<span style="color: #666;">Fetching TDS driver tips...</span>';
    updateCalculateButtonState();
    
    try {
      // First authenticate with Toast - same pattern as fetchToastCashSalesForDate
      const authResponse = await fetch('/api/toast-auth', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      });
      
      if (!authResponse.ok) {
        throw new Error('Failed to authenticate with Toast API');
      }
      
      const authData = await authResponse.json();
      if (!authData.success || !authData.data?.accessToken) {
        throw new Error('Toast authentication failed');
      }
      
      // Calculate total tips across the date range
      let totalNetTips = 0;
      let totalOrderCount = 0;
      
      // Use the TDS-specific API for the entire date range (single call)
      console.log('Processing TDS fetch for entire date range:', startDate, 'to', endDate);
      
      try {
          // Use the TDS-specific API that matches comprehensive analysis exactly
          console.log(`Making TDS API call for date range with accessToken:`, authData.data.accessToken.substring(0, 20) + '...');
          const deliveryResponse = await fetch('/api/toast-tds-driver-tips', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              accessToken: authData.data.accessToken,
              startDate: startDate,
              endDate: endDate
            })
          });
          
          if (!deliveryResponse.ok) {
            if (deliveryResponse.status === 405) {
              // For 405 errors, try once more after a short delay
              if (retryCount === 0) {
                console.log('405 error encountered, retrying in 2 seconds...');
                tdsDataStatus.isFetching = false;
                await new Promise(resolve => setTimeout(resolve, 2000));
                return await autoFetchTdsDriverTips(startDate, endDate, 1);
              }
              throw new Error('TDS Driver API temporarily unavailable (405 error)');
            }
            throw new Error(`Failed to fetch TDS Driver tips: ${deliveryResponse.status}`);
          }
          
          const deliveryData = await deliveryResponse.json();
          if (deliveryData.success && deliveryData.data) {
            // Extract tips from comprehensive analysis response (single call for all dates)
            const netTips = deliveryData.data.netTips || 0;
            const grossTips = deliveryData.data.grossTips || 0;
            const voidedTips = deliveryData.data.voidedTips || 0;
            const refundedTips = deliveryData.data.refundedTips || 0;
            const orderCount = deliveryData.data.tdsDriverOrders || 0;
            
            totalNetTips = netTips; // Use NET tips (after voids/refunds)
            totalOrderCount = orderCount;
            
            console.log('TDS Driver tips fetched successfully using comprehensive analysis method:');
            console.log(`- Gross Tips: $${grossTips.toFixed(2)}`);
            console.log(`- Voided Tips: $${voidedTips.toFixed(2)}`);
            console.log(`- Refunded Tips: $${refundedTips.toFixed(2)}`);
            console.log(`- Net Tips: $${netTips.toFixed(2)}`);
            console.log(`- Orders: ${orderCount}`);
            console.log(`- Expected: $481.83 (gross) or $478.36 (net)`);
            
            // Data retrieved successfully from single comprehensive call
          }
        } catch (dayError) {
          console.warn(`Failed to fetch TDS data:`, dayError.message);
          // Set defaults if API fails
          totalNetTips = 0;
          totalOrderCount = 0;
        }
      
      // Store successful data
      tdsDataStatus.isFetching = false;
      tdsDataStatus.hasData = true;
      tdsDataStatus.data = totalNetTips;
      
      // Update the field and UI
      document.getElementById('tdsDriverTips').value = totalNetTips.toFixed(2);
      document.getElementById('tdsAutoFetchStatus').innerHTML = `<span style="color: #28a745;">Loaded: $${totalNetTips.toFixed(2)} from ${totalOrderCount} TDS orders</span>`;

      // Update tips summary
      updateTipsSummary();

      console.log('TDS Driver tips auto-fetched successfully:', totalNetTips);
      
    } catch (tdsError) {
      console.error('TDS Driver auto-fetch error:', tdsError);
      
      tdsDataStatus.isFetching = false;
      tdsDataStatus.error = tdsError.message;
      
      // Update UI to show error but allow calculation to proceed with 0
      document.getElementById('tdsAutoFetchStatus').innerHTML = `<span style="color: #dc3545;">Failed to fetch TDS tips: ${tdsError.message}</span>`;

      // Use 0 for TDS tips if auto-fetch fails
      document.getElementById('tdsDriverTips').value = '0';
    }
    
    // Update button state regardless of success/failure
    updateCalculateButtonState();
  }

  /**
   * Auto-fetch ezCater tips from database for selected date range
   */
  async function autoFetchEzCaterTips(startDate, endDate) {
    console.log('Auto-fetching ezCater tips from database for date range:', startDate, 'to', endDate);

    // Update status to show loading
    const statusDiv = document.getElementById('ezcaterAutoFetchStatus');
    statusDiv.innerHTML = '<span style="color: #666;">Fetching ezCater tips from database...</span>';

    try {
      // Query catering_orders table for ezCater orders in date range
      const { data: ezCaterOrders, error } = await supabase
        .from('catering_orders')
        .select('tip, order_number, delivery_date, customer_name')
        .eq('source_system', 'EZCATER')
        .gte('delivery_date', startDate)
        .lte('delivery_date', endDate)
        .order('delivery_date', { ascending: true });

      if (error) {
        throw error;
      }

      // Calculate total tips
      const totalTips = ezCaterOrders.reduce((sum, order) => {
        const tip = parseFloat(order.tip) || 0;
        return sum + tip;
      }, 0);

      const orderCount = ezCaterOrders.length;

      // Auto-populate the ezCater tips field
      document.getElementById('ezcaterTips').value = totalTips.toFixed(2);

      // Update status div with success message
      if (orderCount > 0) {
        statusDiv.innerHTML = `<span style="color: #28a745;">✓ Loaded: $${totalTips.toFixed(2)} from ${orderCount} ezCater order${orderCount === 1 ? '' : 's'}</span>`;
      } else {
        statusDiv.innerHTML = '<span style="color: #666;">No ezCater orders found in this date range</span>';
      }

      // Show success message in console
      console.log(`✅ ezCater tips auto-fetched: $${totalTips.toFixed(2)} from ${orderCount} orders`);

      if (orderCount > 0) {
        console.log('ezCater orders found:');
        ezCaterOrders.forEach(order => {
          console.log(`  - Order #${order.order_number} (${order.delivery_date}): $${parseFloat(order.tip).toFixed(2)} tip`);
        });
      } else {
        console.log('No ezCater orders found in this date range');
      }

    } catch (error) {
      console.error('Error fetching ezCater tips:', error);
      // Don't block the flow - just set to 0 if fetch fails
      document.getElementById('ezcaterTips').value = '0.00';
      statusDiv.innerHTML = '<span style="color: #dc3545;">Failed to fetch ezCater tips from database</span>';
    }
  }

  async function autoFetchEzCaterNetSales(startDate, endDate) {
    console.log('Auto-fetching ezCater net sales from database for date range:', startDate, 'to', endDate);

    // Update status to show loading
    const statusDiv = document.getElementById('ezcaterNetSalesAutoFetchStatus');
    statusDiv.innerHTML = '<span style="color: #666;">Fetching ezCater net sales from database...</span>';

    try {
      // Query catering_orders table for ezCater orders in date range
      const { data: ezCaterOrders, error } = await supabase
        .from('catering_orders')
        .select('subtotal, order_number, delivery_date, customer_name')
        .eq('source_system', 'EZCATER')
        .gte('delivery_date', startDate)
        .lte('delivery_date', endDate)
        .order('delivery_date', { ascending: true });

      if (error) {
        throw error;
      }

      // Calculate total net sales (sum of subtotals, excluding tax and tips)
      const totalNetSales = ezCaterOrders.reduce((sum, order) => {
        const subtotal = parseFloat(order.subtotal) || 0;
        return sum + subtotal;
      }, 0);

      const orderCount = ezCaterOrders.length;

      // Auto-populate the ezCater net sales field
      document.getElementById('ezcaterNetSales').value = totalNetSales.toFixed(2);

      // Update status div with success message
      if (orderCount > 0) {
        statusDiv.innerHTML = `<span style="color: #28a745;">✓ Loaded: $${totalNetSales.toFixed(2)} from ${orderCount} ezCater order${orderCount === 1 ? '' : 's'}</span>`;
      } else {
        statusDiv.innerHTML = '<span style="color: #666;">No ezCater orders found in this date range</span>';
      }

      // Update the summary text in expandable section if it exists
      updateSalesLaborSummary();

      // Show success message in console
      console.log(`✅ ezCater net sales auto-fetched: $${totalNetSales.toFixed(2)} from ${orderCount} orders`);

      if (orderCount > 0) {
        console.log('ezCater orders found:');
        ezCaterOrders.forEach(order => {
          console.log(`  - Order #${order.order_number} (${order.delivery_date}): $${parseFloat(order.subtotal).toFixed(2)} subtotal`);
        });
      } else {
        console.log('No ezCater orders found in this date range');
      }

    } catch (error) {
      console.error('Error fetching ezCater net sales:', error);
      // Don't block the flow - just set to 0 if fetch fails
      document.getElementById('ezcaterNetSales').value = '0.00';
      statusDiv.innerHTML = '<span style="color: #dc3545;">Failed to fetch ezCater net sales from database</span>';
    }
  }

  async function autoFetchRealEnvelopeDeposit(startDate, endDate) {
    console.log('Auto-fetching real envelope deposit from database for date range:', startDate, 'to', endDate);

    try {
      // Query cash_counts table for envelope deposit amounts in date range
      const { data: cashCounts, error } = await supabase
        .from('cash_counts')
        .select('date, pm_deposit_amount')
        .gte('date', startDate)
        .lte('date', endDate)
        .not('pm_deposit_amount', 'is', null)
        .order('date', { ascending: true });

      if (error) {
        throw error;
      }

      // Calculate total envelope deposit
      const totalDeposit = cashCounts.reduce((sum, record) => {
        const deposit = parseFloat(record.pm_deposit_amount) || 0;
        return sum + deposit;
      }, 0);

      const recordCount = cashCounts.length;

      // Auto-populate the real envelope deposit field
      document.getElementById('realEnvelopeDeposit').value = totalDeposit.toFixed(2);

      // Update the summary text in expandable section if it exists
      updateEnvelopeDepositSummary();

      // Show success message in console
      console.log(`✅ Real envelope deposit auto-fetched: $${totalDeposit.toFixed(2)} from ${recordCount} days`);

      if (recordCount > 0) {
        console.log('Cash counts found:');
        cashCounts.forEach(record => {
          console.log(`  - ${record.date}: $${parseFloat(record.pm_deposit_amount).toFixed(2)} deposit`);
        });
      } else {
        console.log('No cash counts with envelope deposits found in this date range');
      }

    } catch (error) {
      console.error('Error fetching real envelope deposit:', error);
      // Don't block the flow - leave field empty if fetch fails
    }
  }

  // Helper functions to update summary text in expandable sections
  function updateTipsSummary() {
    const cashTips = parseFloat(document.getElementById('calculatedCashTips').value) || 0;
    const tdsTips = parseFloat(document.getElementById('tdsDriverTips').value) || 0;
    const ezCaterTips = parseFloat(document.getElementById('ezcaterTips').value) || 0;
    const total = cashTips + tdsTips + ezCaterTips;

    const summarySpan = document.getElementById('tipsSummaryAmount');
    if (summarySpan) {
      summarySpan.textContent = `$${total.toFixed(2)}`;
    }
  }

  function updateSalesLaborSummary() {
    const ezCaterNetSales = parseFloat(document.getElementById('ezcaterNetSales').value) || 0;
    const manualNetSales = parseFloat(document.getElementById('manualNetSales').value) || 0;
    const manualLaborCost = parseFloat(document.getElementById('manualLaborCost').value) || 0;

    // Auto-sync ezcaterSales with ezcaterNetSales (same value)
    document.getElementById('ezcaterSales').value = ezCaterNetSales.toFixed(2);

    const summarySpan = document.getElementById('salesLaborSummaryAmount');
    if (summarySpan) {
      // Show the sum of all values
      const display = `Sales: $${(ezCaterNetSales + manualNetSales).toFixed(2)} | Labor: $${manualLaborCost.toFixed(2)}`;
      summarySpan.textContent = display;
    }
  }

  function updateEnvelopeDepositSummary() {
    const deposit = parseFloat(document.getElementById('realEnvelopeDeposit').value) || 0;

    const summarySpan = document.getElementById('envelopeDepositSummaryAmount');
    if (summarySpan) {
      summarySpan.textContent = `$${deposit.toFixed(2)}`;
    }
  }

  // Handle file upload - show status and clear API data
  function handleFileUpload() {
    const laborFile = document.getElementById('laborFile').files[0];
    const salesFile = document.getElementById('salesFile').files[0];
    const statusDiv = document.getElementById('autoFetchStatus');

    if (laborFile && salesFile) {
      // Both files uploaded - clear any API data and show success message
      apiFetchedData.laborData = null;
      apiFetchedData.salesData = null;
      statusDiv.innerHTML = '<span style="color: #28a745;">Files uploaded - will use these instead of database/API</span>';
      console.log('Files uploaded, API data cleared');
    } else if (laborFile || salesFile) {
      // Only one file - show reminder
      statusDiv.innerHTML = '<span style="color: #ffc107;">Please upload both Labor Summary CSV and Sales Summary ZIP</span>';
    } else {
      // No files - clear message
      statusDiv.innerHTML = '';
    }
  }

  // Global storage for API-fetched data
  let apiFetchedData = {
    laborData: null,
    salesData: null
  };

  // Auto-fetch function called when end date changes
  async function autoFetchOnDateChange() {
    const startDate = document.getElementById('tipPoolStartDate').value;
    const endDate = document.getElementById('tipPoolEndDate').value;

    if (!startDate || !endDate) {
      return; // Silently skip if dates not set
    }

    // CRITICAL: Check if user uploaded files
    const laborFile = document.getElementById('laborFile').files[0];
    const salesFile = document.getElementById('salesFile').files[0];
    const hasFiles = laborFile && salesFile;

    if (hasFiles) {
      console.log('Files already uploaded - skipping sales/labor auto-fetch, but still fetching TDS driver tips and ezCater tips');
      const statusDiv = document.getElementById('autoFetchStatus');
      statusDiv.innerHTML = '<span style="color: #28a745;">Using uploaded files (will bypass database and API)</span>';

      // CRITICAL FIX: Still need to fetch TDS Driver tips (not in manual files!)
      await autoFetchTdsDriverTips(startDate, endDate);

      // Auto-fetch ezCater tips from database (not in manual files!)
      await autoFetchEzCaterTips(startDate, endDate);

      // Auto-fetch ezCater net sales from database (not in manual files!)
      await autoFetchEzCaterNetSales(startDate, endDate);

      // Auto-fetch real envelope deposit from database (not in manual files!)
      await autoFetchRealEnvelopeDeposit(startDate, endDate);
      return;
    }

    // Show loading overlay
    const loadingOverlay = document.getElementById('loadingOverlay');
    loadingOverlay.style.display = 'flex';

    // Update status indicator
    const statusDiv = document.getElementById('autoFetchStatus');
    statusDiv.innerHTML = '<span style="color: #666;">Fetching data from Toast API...</span>';

    try {
      // Authenticate with Toast API
      console.log('Fetching from Toast API...');
      document.getElementById('loadingTitle').textContent = 'Authenticating with Toast API...';
      document.getElementById('loadingMessage').textContent = 'Please wait...';

      const authResponse = await fetch('/api/toast-auth', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      });

      if (!authResponse.ok) throw new Error('Authentication failed');
      const authData = await authResponse.json();
      if (!authData.success || !authData.data?.accessToken) throw new Error('Failed to get access token');
      const token = authData.data.accessToken;

      // Fetch labor and sales data from API
      document.getElementById('loadingTitle').textContent = 'Fetching labor and payment data...';
      document.getElementById('loadingMessage').textContent = 'Processing hundreds of payments - this may take 2-3 minutes. Please be patient!';

      const [laborResponse, salesResponse] = await Promise.all([
        fetch(`/api/toast-labor-summary?startDate=${startDate}&endDate=${endDate}&token=${token}`),
        fetch(`/api/toast-sales-summary?startDate=${startDate}&endDate=${endDate}&token=${token}`)
      ]);

      console.log('Labor response:', laborResponse.status, laborResponse.statusText);
      console.log('Sales response:', salesResponse.status, salesResponse.statusText);

      if (!laborResponse.ok) {
        const laborError = await laborResponse.text();
        console.error('Labor API error response:', laborError);
        throw new Error(`Labor API failed: ${laborResponse.status} - ${laborError}`);
      }

      if (!salesResponse.ok) {
        const salesError = await salesResponse.text();
        console.error('Sales API error response:', salesError);
        throw new Error(`Sales API failed: ${salesResponse.status} - ${salesError}`);
      }

      const [laborResult, salesResult] = await Promise.all([
        laborResponse.json(),
        salesResponse.json()
      ]);

      // Store the fetched data globally
      apiFetchedData.laborData = laborResult.employees;
      apiFetchedData.laborData.totalLaborCost = laborResult.totalLaborCost;
      apiFetchedData.salesData = {
        creditTips: salesResult.creditTips,
        creditTipsGross: salesResult.creditTipsGross || salesResult.creditTips,
        voidedTips: salesResult.voidedTips || 0,
        discounts: salesResult.discounts || 0,
        tipsOnDiscountedChecks: salesResult.tipsOnDiscountedChecks || 0,
        cashSales: salesResult.cashSales,
        netSales: salesResult.netSales
      };

      // Show subtle success indicator
      statusDiv.innerHTML = `<span style="color: #28a745;">✓ Data loaded from Toast API: ${laborResult.employeesCount} employees, $${salesResult.creditTips.toFixed(2)} credit tips</span>`;

      console.log('Auto-fetch complete:', { laborResult, salesResult });

      // Display enhanced sales summary
      console.log(`\n=== SALES SUMMARY ===`);
      console.log(`Method: ${salesResult.method || 'ordersBulk endpoint'}`);
      console.log(`Version: ${salesResult.version || 'Unknown'}`);
      console.log(`Net Sales: $${salesResult.netSales.toFixed(2)}`);

      // Handle both ordersBulk and Payments endpoint formats
      if (salesResult.creditCount !== undefined) {
        // Payments endpoint format
        console.log(`Credit Payments: ${salesResult.creditCount}, Amount: $${salesResult.creditAmount.toFixed(2)}`);
      }
      console.log(`Credit Tips: $${salesResult.creditTips.toFixed(2)}`);

      if (salesResult.creditTipsGross && salesResult.creditTipsGross !== salesResult.creditTips) {
        console.log(`  - Gross: $${salesResult.creditTipsGross.toFixed(2)}`);
      }

      if (salesResult.cashSales && salesResult.cashSales > 0) {
        const cashTipsDisplay = salesResult.cashTips !== undefined ? `, Tips: $${salesResult.cashTips.toFixed(2)}` : '';
        console.log(`Cash Sales: $${salesResult.cashSales.toFixed(2)}${cashTipsDisplay}`);
      }

      if (salesResult.otherSales && salesResult.otherSales > 0) {
        console.log(`Other Sales: $${salesResult.otherSales.toFixed(2)}, Tips: $${salesResult.otherTips.toFixed(2)}`);
      }

      if (salesResult.voidedTips && salesResult.voidedTips > 0) {
        console.log(`Voided Tips: $${salesResult.voidedTips.toFixed(2)}`);
      }

      if (salesResult.deniedPayments && salesResult.deniedPayments > 0) {
        console.log(`DENIED Payments: ${salesResult.deniedPayments}`);
      }

      if (salesResult.tipsOnDiscountedChecks && salesResult.tipsOnDiscountedChecks > 0) {
        console.log(`Tips on Discounted Checks: $${salesResult.tipsOnDiscountedChecks.toFixed(2)}`);
      }

      if (salesResult.totalTips !== undefined) {
        console.log(`Total Tips: $${salesResult.totalTips.toFixed(2)}`);
      }
      console.log(`===================\n`);

      // Auto-fetch TDS Driver tips
      await autoFetchTdsDriverTips(startDate, endDate);

      // Auto-fetch ezCater tips from database
      await autoFetchEzCaterTips(startDate, endDate);

      // Auto-fetch ezCater net sales from database
      await autoFetchEzCaterNetSales(startDate, endDate);

      // Auto-fetch real envelope deposit from database
      await autoFetchRealEnvelopeDeposit(startDate, endDate);

      // Hide loading overlay on success
      loadingOverlay.style.display = 'none';

    } catch (error) {
      console.error('Auto-fetch error:', error);
      const statusDiv = document.getElementById('autoFetchStatus');
      statusDiv.innerHTML = '<span style="color: #dc3545;">Failed to fetch data. You can upload files manually instead.</span>';

      // Hide loading overlay on error
      loadingOverlay.style.display = 'none';
    }
  }

  // Legacy function kept for compatibility (if called elsewhere)
  async function fetchTipPoolDataFromAPI() {
    await autoFetchOnDateChange();
  }

  async function calculateTipPool() {
    const laborFile = document.getElementById('laborFile').files[0];
    const salesFile = document.getElementById('salesFile').files[0];
    const startDate = document.getElementById('tipPoolStartDate').value;
    const endDate = document.getElementById('tipPoolEndDate').value;
    const realEnvelopeDeposit = parseFloat(document.getElementById('realEnvelopeDeposit').value) || 0;
    const ezcaterTips = parseFloat(document.getElementById('ezcaterTips').value) || 0;
    const calculatedByName = document.getElementById('calculatedByName').value.trim();
    const customNotes = document.getElementById('tipPoolNotes').value.trim();

    // Fetch previous week's unpaid tip variance from database
    let previousVariance = 0;
    let carriedFromDate = null;

    console.log(`🔍 Checking for unpaid tip variance from weeks before ${endDate}...`);

    try {
      const { data: varianceData, error: varianceError } = await supabase
        .from('tip_variance')
        .select('*')
        .lt('week_ending_date', endDate)  // Only get weeks BEFORE current week
        .order('week_ending_date', { ascending: false })  // Most recent first
        .limit(1)
        .single();

      if (varianceError) {
        // No previous data found (expected on first run)
        console.log(`✅ No previous week variance data found. This is expected for the first week.`);
        console.log(`   Current week: ${startDate} to ${endDate}`);
        console.log(`   Previous variance: $0.00 (no carryover)`);
      } else if (varianceData) {
        previousVariance = parseFloat(varianceData.variance_amount) || 0;
        carriedFromDate = varianceData.week_ending_date;
        console.log(`✅ Found previous week variance!`);
        console.log(`   Current week: ${startDate} to ${endDate}`);
        console.log(`   Carrying over: $${previousVariance.toFixed(2)} from week ending ${carriedFromDate}`);
        console.log(`   This amount will be ADDED to this week's tip pool`);
      }
    } catch (err) {
      console.log(`✅ No previous variance data exists (table may not exist yet or this is the first week)`);
      console.log(`   Error: ${err.message}`);
      console.log(`   Previous variance: $0.00 (no carryover)`);
    }

    // Fetch previous week's cash surplus from database (ONLY if positive = surplus)
    // NOTE: Tip pool date ranges are ALWAYS Monday through Sunday (7 days)
    // week_end_date is stored as Sunday's date (e.g., "2025-10-05" for week 9/29-10/5)
    let previousCashSurplus = 0;
    let cashSurplusFromDate = null;

    console.log(`🔍 Checking for previous week cash surplus from weeks before ${endDate}...`);

    try {
      const { data: cashData, error: cashError } = await supabase
        .from('weekly_combined_reports')
        .select('cash_needed, week_end_date')
        .lt('week_end_date', endDate)  // Only get weeks BEFORE current week
        .order('week_end_date', { ascending: false })  // Most recent first
        .limit(1)
        .single();

      if (cashError) {
        // No previous data found (expected on first run)
        console.log(`✅ No previous week cash data found. This is expected for the first week.`);
        console.log(`   Current week: ${startDate} to ${endDate}`);
        console.log(`   Previous cash surplus: $0.00 (no carryover)`);
      } else if (cashData) {
        const cashNeededValue = parseFloat(cashData.cash_needed) || 0;
        // ONLY carry over if it's NEGATIVE (which means surplus in our calculation)
        // In the code, negative cashNeeded = surplus (excess cash)
        if (cashNeededValue < 0) {
          previousCashSurplus = Math.abs(cashNeededValue); // Store as positive number
          cashSurplusFromDate = cashData.week_end_date;
          console.log(`✅ Found previous week cash surplus!`);
          console.log(`   Current week: ${startDate} to ${endDate}`);
          console.log(`   Carrying over: $${previousCashSurplus.toFixed(2)} from week ending ${cashSurplusFromDate}`);
          console.log(`   This amount will REDUCE cash needed (or increase surplus)`);
        } else {
          console.log(`✅ Previous week needed cash (no surplus to carry over)`);
          console.log(`   Previous week cash needed: $${cashNeededValue.toFixed(2)}`);
        }
      }
    } catch (err) {
      console.log(`✅ No previous cash data exists (table may not exist yet or this is the first week)`);
      console.log(`   Error: ${err.message}`);
      console.log(`   Previous cash surplus: $0.00 (no carryover)`);
    }

    // Check if we have either files OR API-fetched data
    const hasFiles = laborFile && salesFile;
    const hasAPIData = apiFetchedData.laborData && apiFetchedData.salesData;

    if (!hasFiles && !hasAPIData) {
      showErrorMessage('Please select dates first (data will auto-fetch) OR upload files manually.');
      return;
    }

    if (!startDate || !endDate) {
      showErrorMessage('Please select both start and end dates for cash sales calculation.');
      return;
    }

    if (!realEnvelopeDeposit) {
      showErrorMessage('Please enter the Real Envelope Deposit amount.');
      return;
    }

    if (!calculatedByName) {
      showErrorMessage('Please enter your name in the "Tips Calculated By" field.');
      return;
    }

    try {
      showLoading('Calculating Tip Pool', 'Processing payroll and sales data...');

      // Use the already-fetched TDS Driver tips from global state
      const tdsDriverTips = tdsDataStatus.hasData ? tdsDataStatus.data : 0;
      
      console.log('Using TDS Driver tips from cache:', tdsDriverTips);

      // Get Toast Cash Sales from Supabase for the date range
      const start = new Date(startDate + 'T12:00:00');
      const end = new Date(endDate + 'T12:00:00');

      if (start > end) {
        throw new Error('Start date must be before end date');
      }

      const diffTime = Math.abs(end - start);
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      
      if (diffDays > 7) {
        throw new Error('Date range cannot exceed 7 days');
      }

      // Copy exact working query from generateDateRangePDF
      const { data: rangeData } = await supabase
        .from('cash_counts')
        .select('*')
        .gte('date', startDate)
        .lte('date', endDate)
        .not('pm_total', 'is', null)
        .order('date', { ascending: true });

      if (!rangeData || rangeData.length === 0) {
        throw new Error('No cash count data found for this date range');
      }

      // Get data from either files OR API
      let payrollData, creditTips, cashSales, netSales;

      if (hasFiles) {
        // Parse uploaded files
        console.log('Using uploaded files...');
        payrollData = await parsePayrollCSV(laborFile);
        const salesData = await parseSalesZip(salesFile);
        creditTips = salesData.creditTips;
        cashSales = salesData.cashSales;
        netSales = salesData.netSales;
      } else {
        // Use API-fetched data
        console.log('Using API-fetched data...');
        payrollData = apiFetchedData.laborData;
        creditTips = apiFetchedData.salesData.creditTips;
        cashSales = apiFetchedData.salesData.cashSales;
        netSales = apiFetchedData.salesData.netSales;
      }

      // Calculate total Toast cash sales
      // ALWAYS use API cashSales when using API data (never database)
      let totalToastCashSales = 0;
      if (!hasFiles) {
        // Using API data - ALWAYS use API value (even if 0)
        totalToastCashSales = cashSales || 0;
        console.log(`Using API cashSales: $${totalToastCashSales.toFixed(2)}`);
      } else {
        // Using files - sum from database
        totalToastCashSales = rangeData.reduce((sum, day) => sum + (day.pm_toast_sales || 0), 0);
        console.log(`Using database cashSales: $${totalToastCashSales.toFixed(2)}`);
      }

      // Calculate cash tips: Real Envelope Deposit - Toast Cash Sales
      const calculatedCashTips = realEnvelopeDeposit - totalToastCashSales;

      // Update the cash tips display
      document.getElementById('calculatedCashTips').value = calculatedCashTips.toFixed(2);

      // Calculate labor metrics
      const manualLaborCostInput = parseFloat(document.getElementById('manualLaborCost').value) || 0;
      const apiLaborCost = payrollData.totalLaborCost || 0;

      // Use manual labor cost if provided (includes CA double-time), otherwise use API
      const baseLaborCost = manualLaborCostInput > 0 ? manualLaborCostInput : apiLaborCost;

      // Log the difference for transparency
      if (manualLaborCostInput > 0 && apiLaborCost > 0) {
        const difference = manualLaborCostInput - apiLaborCost;
        console.log(`Labor Cost Comparison:`);
        console.log(`  Toast Web (manual): $${manualLaborCostInput.toFixed(2)}`);
        console.log(`  API (base wages): $${apiLaborCost.toFixed(2)}`);
        console.log(`  Difference (CA double-time): $${difference.toFixed(2)} (${(difference/apiLaborCost*100).toFixed(1)}%)`);
      }

      // Handle manual net sales override
      const manualNetSalesInput = parseFloat(document.getElementById('manualNetSales').value) || 0;
      const ezcaterSalesInput = parseFloat(document.getElementById('ezcaterSales').value) || 0;
      const apiNetSales = netSales; // Store original API value

      // Use manual net sales if provided, otherwise use API, then add EZCater sales
      const baseNetSales = manualNetSalesInput > 0 ? manualNetSalesInput : apiNetSales;
      const finalNetSales = baseNetSales + ezcaterSalesInput;

      // Log the breakdown for transparency
      console.log(`Net Sales Breakdown:`);
      console.log(`  API Net Sales: $${apiNetSales.toFixed(2)}`);
      if (manualNetSalesInput > 0) {
        const difference = manualNetSalesInput - apiNetSales;
        console.log(`  Manual Net Sales Override: $${manualNetSalesInput.toFixed(2)} (${difference >= 0 ? '+' : ''}$${difference.toFixed(2)})`);
      }
      if (ezcaterSalesInput > 0) {
        console.log(`  + EZCater Sales: $${ezcaterSalesInput.toFixed(2)}`);
      }
      console.log(`  Final Net Sales (for labor %): $${finalNetSales.toFixed(2)}`);

      const demetriSalary = 85000 / 52; // $85k annual salary / 52 weeks
      const subtotalLabor = baseLaborCost + demetriSalary;
      const payrollBurden = subtotalLabor * 0.33; // 33% for taxes, insurance, etc.
      const trueTotalLaborCost = subtotalLabor + payrollBurden;
      const laborPercentage = finalNetSales > 0 ? (trueTotalLaborCost / finalNetSales) * 100 : 0;
      const industryBenchmark = 30.0;
      const laborVariance = laborPercentage - industryBenchmark;

      // Compute tip pool using calculated cash tips + previous variance carryover + previous cash surplus
      const result = computeTipPool(
        payrollData,
        creditTips,
        calculatedCashTips,
        ezcaterTips,
        tdsDriverTips,
        cashSales,
        previousVariance,
        previousCashSurplus
      );

      // Store global state
      tipPoolRecords = result.records;

      // Parse date range from filename or use form dates
      let dateRange;
      if (hasFiles) {
        dateRange = parseDateRange(laborFile.name) || parseDateRange(salesFile.name);
      }
      if (!dateRange) {
        // Format: "09/29/2025 - 10/05/2025"
        const startFormatted = new Date(startDate).toLocaleDateString();
        const endFormatted = new Date(endDate).toLocaleDateString();
        dateRange = `${startFormatted} - ${endFormatted}`;
      }

      // Get voided tips info if using API
      const voidedTipsAmount = !hasFiles && apiFetchedData.salesData?.voidedTips
        ? apiFetchedData.salesData.voidedTips
        : 0;
      const creditTipsGross = !hasFiles && apiFetchedData.salesData?.creditTipsGross
        ? apiFetchedData.salesData.creditTipsGross
        : creditTips;

      tipPoolSummary = {
        creditTips: creditTips,
        creditTipsGross: creditTipsGross,
        voidedTipsTotal: voidedTipsAmount,
        cashSales: cashSales,
        cashTips: calculatedCashTips,
        realEnvelopeDeposit: realEnvelopeDeposit,
        toastCashSales: totalToastCashSales,
        ezcaterTips: ezcaterTips,
        tdsDriverTips: tdsDriverTips,
        totalTips: result.totalTips,
        pool: result.pool,
        totalWeightedHours: result.totalWeightedHours,
        hourlyRate: result.rate,
        cashNeeded: result.cashNeeded,
        dateRange: dateRange,
        calculatedByName: calculatedByName,
        customNotes: customNotes,
        generatedAt: new Date().toLocaleString(),
        // Variance tracking for compliance
        previousVariance: previousVariance,
        carriedFromDate: carriedFromDate,
        currentVariance: result.currentVariance,
        totalPaidOut: result.totalPaidOut,
        // Cash surplus tracking
        previousCashSurplus: previousCashSurplus,
        cashSurplusFromDate: cashSurplusFromDate,
        // Labor metrics for combined report
        laborData: {
          baseLaborCost: baseLaborCost,
          apiLaborCost: apiLaborCost,
          manualLaborCost: manualLaborCostInput,
          usingManualCost: manualLaborCostInput > 0,
          demetriSalary: demetriSalary,
          subtotalLabor: subtotalLabor,
          payrollBurden: payrollBurden,
          trueTotalLaborCost: trueTotalLaborCost,
          netSales: finalNetSales,
          baseNetSales: baseNetSales,
          apiNetSales: apiNetSales,
          manualNetSales: manualNetSalesInput,
          ezcaterSales: ezcaterSalesInput,
          usingManualNetSales: manualNetSalesInput > 0,
          usingEzcaterSales: ezcaterSalesInput > 0,
          laborPercentage: laborPercentage,
          industryBenchmark: industryBenchmark,
          laborVariance: laborVariance
        }
      };

      // Display results for user to review
      console.log('About to render tip pool summary and table...');
      renderTipPoolSummary();
      console.log('Tip pool summary rendered');
      renderTipPoolTable();
      console.log('Tip pool table rendered');
      
      console.log('About to show tip pool results div...');
      
      // NUCLEAR OPTION: Force all possible visibility settings
      const tipPoolResultsDiv = document.getElementById('tipPoolResults');
      tipPoolResultsDiv.style.display = 'block';
      tipPoolResultsDiv.style.visibility = 'visible';
      tipPoolResultsDiv.style.opacity = '1';
      tipPoolResultsDiv.style.height = 'auto';
      tipPoolResultsDiv.style.overflow = 'visible';
      tipPoolResultsDiv.style.position = 'static';
      tipPoolResultsDiv.style.zIndex = 'auto';
      tipPoolResultsDiv.style.transform = 'none';
      tipPoolResultsDiv.style.maxHeight = 'none';
      tipPoolResultsDiv.style.width = 'auto';
      
      console.log('FORCED all visibility properties on tipPoolResults');
      
      document.getElementById('tipPoolPdfBtn').style.display = 'inline-block';
      document.getElementById('combinedReportSection').style.display = 'block';
      
      // Auto-populate combined report data from tip pool inputs
      document.getElementById('combinedStartDate').value = startDate;
      document.getElementById('combinedEndDate').value = endDate;
      document.getElementById('combinedRealEnvelope').value = realEnvelopeDeposit.toString();
      console.log('Auto-populated combined report data:', { startDate, endDate, realEnvelopeDeposit });
      
      // Removed saveTipPoolData() - tip pool fields now reset every time
      
      // Ensure tip pool form stays active
      document.getElementById('tipPoolForm').classList.add('active');
      console.log('Tip pool results div should now be visible');

      hideLoading();

      // Show success message with instruction to review equity
      showSuccessMessage('Tip pool calculated successfully! Please review and adjust equity percentages if needed, then click "Download Tip Pool PDF".');
      
      // Debug: Check if elements are still visible after success message
      setTimeout(() => {
        const resultsDiv = document.getElementById('tipPoolResults');
        const formDiv = document.getElementById('tipPoolForm');
        console.log('FINAL CHECK - Results div display:', resultsDiv.style.display);
        console.log('FINAL CHECK - Results div innerHTML length:', resultsDiv.innerHTML.length);
        console.log('FINAL CHECK - Results div offsetHeight:', resultsDiv.offsetHeight);
        console.log('FINAL CHECK - Results div scrollHeight:', resultsDiv.scrollHeight);
        console.log('FINAL CHECK - Results div computed style:', window.getComputedStyle(resultsDiv).display);
        console.log('FINAL CHECK - Form div classes:', formDiv.className);
        console.log('FINAL CHECK - Form div active?', formDiv.classList.contains('active'));
        console.log('FINAL CHECK - Results div visible?', resultsDiv.offsetHeight > 0);
        console.log('FINAL CHECK - Form div visible?', formDiv.offsetHeight > 0);
        
        // If still not visible, try scrolling to it
        if (resultsDiv.offsetHeight === 0) {
          console.log('Results div still not visible - trying to force scroll and flash');
          resultsDiv.style.border = '5px solid red';
          resultsDiv.style.backgroundColor = 'yellow';
          resultsDiv.style.minHeight = '200px';
          resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      }, 100);
      
      console.log('calculateTipPool function completed successfully');
      
    } catch (error) {
      hideLoading();
      console.error('Tip pool calculation error:', error);
      showErrorMessage(`Error: ${error.message}`);
    }
  }

  async function downloadTipPoolPDF() {
    try {
      showLoading('Generating PDF', 'Creating tip pool distribution report...');

      // Recalculate variance based on FINAL tip distribution (after equity adjustments)
      const totalPaidOut = tipPoolRecords.reduce((sum, rec) => sum + rec.due, 0);
      const currentVariance = tipPoolSummary.pool - totalPaidOut;

      console.log(`Final Variance Calculation (after equity adjustments):
        - Pool: $${tipPoolSummary.pool.toFixed(2)}
        - Total Paid Out: $${totalPaidOut.toFixed(2)}
        - Variance to carry forward: $${currentVariance.toFixed(2)}
      `);

      // Update tipPoolSummary with recalculated values
      tipPoolSummary.totalPaidOut = totalPaidOut;
      tipPoolSummary.currentVariance = currentVariance;

      // Save variance record to database (AFTER final equity adjustments)
      try {
        const endDate = document.getElementById('tipPoolEndDate').value;
        const startDate = document.getElementById('tipPoolStartDate').value;
        const varianceRecord = {
          week_ending_date: endDate,
          calculated_total: tipPoolSummary.pool,
          actual_paid_total: totalPaidOut,
          variance_amount: currentVariance,
          previous_variance: tipPoolSummary.previousVariance || 0,
          carried_from_date: tipPoolSummary.carriedFromDate || null
        };

        console.log(`💾 Saving final variance record for week ${startDate} to ${endDate}:`);
        console.log(`   Pool Total: $${tipPoolSummary.pool.toFixed(2)}`);
        console.log(`   Paid Out: $${totalPaidOut.toFixed(2)}`);
        console.log(`   Variance to carry forward: $${currentVariance.toFixed(2)}`);
        console.log(`   Previous variance included: $${(tipPoolSummary.previousVariance || 0).toFixed(2)}`);

        const { data: savedVariance, error: saveError } = await supabase
          .from('tip_variance')
          .upsert(varianceRecord, { onConflict: 'week_ending_date' })
          .select()
          .single();

        if (saveError) {
          console.error('❌ Error saving variance record:', saveError);
          showErrorMessage('Warning: Variance record could not be saved. PDF will still be generated.');
          await new Promise(resolve => setTimeout(resolve, 2000)); // Give user time to see warning
        } else {
          console.log(`✅ Variance record saved successfully!`);
          console.log(`   Record ID: ${savedVariance.id}`);
          console.log(`   Week ending: ${savedVariance.week_ending_date}`);
          console.log(`   Variance amount: $${savedVariance.variance_amount.toFixed(2)}`);
          console.log(`   This variance will be added to next week's tip pool (week after ${endDate})`);
        }
      } catch (varianceErr) {
        console.error('❌ Exception saving variance:', varianceErr);
        showErrorMessage('Warning: Variance record could not be saved. PDF will still be generated.');
        await new Promise(resolve => setTimeout(resolve, 2000));
      }

      await generateTipPoolPDF();

      hideLoading();
      showTipPoolSuccessMessage();

    } catch (error) {
      hideLoading();
      console.error('PDF generation error:', error);
      showErrorMessage(`Error generating PDF: ${error.message}`);
    }
  }

  async function downloadCombinedReportPDF() {
    try {
      const startDate = document.getElementById('combinedStartDate').value;
      const endDate = document.getElementById('combinedEndDate').value;
      const realEnvelopeAmount = parseFloat(document.getElementById('combinedRealEnvelope').value) || null;

      if (!startDate || !endDate) {
        showErrorMessage('Please select both start and end dates for the cash report period.');
        return;
      }

      if (!tipPoolRecords || tipPoolRecords.length === 0) {
        showErrorMessage('Please calculate tip pool first before generating combined report.');
        return;
      }

      showLoading('Generating Combined PDF', 'Creating combined weekly report...');

      // Fetch cash count data for the date range
      const start = new Date(startDate + 'T12:00:00');
      const end = new Date(endDate + 'T12:00:00');

      if (start > end) {
        throw new Error('Start date must be before end date');
      }

      const diffTime = Math.abs(end - start);
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      
      if (diffDays > 7) {
        throw new Error('Date range cannot exceed 7 days');
      }

      // Get cash data
      const { data: rangeData } = await supabase
        .from('cash_counts')
        .select('*')
        .gte('date', startDate)
        .lte('date', endDate)
        .not('pm_total', 'is', null)
        .order('date', { ascending: true });

      if (!rangeData || rangeData.length === 0) {
        throw new Error('No cash count data found for this date range');
      }

      // Store cash data for potential re-generation
      window.lastCombinedCashData = rangeData;
      
      // Save combined report data for persistence
      saveCombinedReportData();

      // Generate clean PDF using jsPDF (like tip pool report)
      await generateCombinedReportPDF(startDate, endDate, rangeData, realEnvelopeAmount);
      
      hideLoading();
      showSuccessMessage('Combined weekly report generated successfully!');
      
    } catch (error) {
      hideLoading();
      console.error('Combined PDF generation error:', error);
      showErrorMessage(`Error generating combined report: ${error.message}`);
    }
  }

  function parseDateRange(filename) {
    const re = /(\d{4})[_-](\d{2})[_-](\d{2})[-_](\d{4})[_-](\d{2})[_-](\d{2})/;
    const match = filename.match(re);
    if (!match) return '';
    
    const [, y1, m1, d1, y2, m2, d2] = match;
    const startMonth = parseInt(m1, 10).toString();
    const startDay = parseInt(d1, 10).toString();
    const endMonth = parseInt(m2, 10).toString();
    const endDay = parseInt(d2, 10).toString();
    
    return `${startMonth}/${startDay}—${endMonth}/${endDay} ${y2}`;
  }

  function parsePayrollCSV(file) {
    return new Promise((resolve, reject) => {
      Papa.parse(file, {
        header: true,
        skipEmptyLines: true,
        complete: function(results) {
          const data = results.data;
          const employeeMap = {};
          let totalLaborCost = 0;

          data.forEach(row => {
            const emp = row['Employee'];
            if (!emp) return;

            const regHours = parseFloat(row['Regular Hours']) || 0;
            const otHours = parseFloat(row['Overtime Hours']) || 0;
            const total = regHours + otHours;
            const totalPay = parseFloat(row['Total Pay']?.replace(',', '')) || 0;

            // Accumulate total labor cost
            totalLaborCost += totalPay;

            if (!employeeMap[emp]) {
              employeeMap[emp] = { hours: 0, regularHours: 0, overtimeHours: 0 };
            }
            employeeMap[emp].hours += total;
            employeeMap[emp].regularHours += regHours;
            employeeMap[emp].overtimeHours += otHours;
          });

          const result = [];
          for (const emp in employeeMap) {
            const parts = emp.split(',');
            const last = parts[0].trim();
            const first = parts.slice(1).join(',').trim();
            result.push({
              employee: emp,
              first: first,
              last: last,
              hours: employeeMap[emp].hours,
              regularHours: employeeMap[emp].regularHours,
              overtimeHours: employeeMap[emp].overtimeHours
            });
          }

          // Add labor cost data to result
          result.totalLaborCost = totalLaborCost;

          resolve(result);
        },
        error: function(err) {
          reject(err);
        }
      });
    });
  }

  async function parseSalesZip(file) {
    const arrayBuffer = await file.arrayBuffer();
    const zip = await JSZip.loadAsync(arrayBuffer);

    // Find Payments summary CSV and Net sales summary CSV
    let paymentsFile = null;
    let netSalesFile = null;
    zip.forEach((relativePath, zipEntry) => {
      if (relativePath.endsWith('Payments summary.csv')) {
        paymentsFile = zipEntry;
      }
      if (relativePath.endsWith('Net sales summary.csv')) {
        netSalesFile = zipEntry;
      }
    });

    // Parse Net Sales
    let netSales = 0;
    if (netSalesFile) {
      const netSalesCsv = await netSalesFile.async('string');
      const netSalesParsed = Papa.parse(netSalesCsv, { header: true, skipEmptyLines: true });
      if (netSalesParsed.data && netSalesParsed.data[0]) {
        netSales = parseFloat(netSalesParsed.data[0]['Net sales']) || 0;
      }
    }

    if (!paymentsFile) {
      return { creditTips: 0, cashSales: 0, netSales: netSales };
    }

    const paymentsCsv = await paymentsFile.async('string');
    const parsed = Papa.parse(paymentsCsv, { header: true, skipEmptyLines: true });

    let creditTips = 0;
    let cashSales = 0;

    parsed.data.forEach(row => {
      const paymentType = row['Payment type'] ? row['Payment type'].trim() : '';
      const paymentSubType = row['Payment sub type'];

      // Credit tips from detailed card types only
      if (paymentType === 'Credit/debit' && paymentSubType && paymentSubType.trim() !== '') {
        creditTips += parseFloat(row['Tips']) || 0;
      }

      if (paymentType === 'Cash') {
        cashSales += parseFloat(row['Amount']) || 0;
      }
    });

    return { creditTips, cashSales, netSales };
  }

  function computeTipPool(payrollData, creditTips, cashTips, ezcaterTips, tdsDriverTips, cashSales, previousVariance = 0, previousCashSurplus = 0) {
    // Build equity mapping
    const equityMap = {};
    payrollData.forEach(rec => {
      equityMap[rec.employee] = defaultEquity.hasOwnProperty(rec.employee)
        ? defaultEquity[rec.employee]
        : 1.0;
    });

    // Compute weighted hours
    let totalWeightedHours = 0;
    const records = payrollData.map(rec => {
      const equity = equityMap[rec.employee];
      const weighted = rec.hours * equity;
      totalWeightedHours += weighted;

      return {
        employee: rec.employee,
        first: rec.first,
        last: rec.last,
        hours: rec.hours,
        regularHours: rec.regularHours || 0,
        overtimeHours: rec.overtimeHours || 0,
        equity: equity,
        weighted: weighted,
        due: 0
      };
    });

    // Calculate pool WITH previous variance carryover
    const totalTips = creditTips + cashTips + ezcaterTips;
    const rawPool = totalTips - tdsDriverTips + previousVariance; // Add unpaid variance from previous week
    const pool = Math.floor(rawPool); // Floor to whole dollar

    // Calculate hourly rate
    const rate = totalWeightedHours ? pool / totalWeightedHours : 0;

    // Calculate due amounts (floored to whole dollars)
    let totalPaidOut = 0;
    records.forEach(r => {
      const rawDue = r.weighted * rate;
      r.due = Math.floor(rawDue);
      totalPaidOut += r.due;
    });

    // Calculate current week's variance (will be carried to next week)
    // This is the difference between the floored pool and what was actually paid out
    const currentVariance = pool - totalPaidOut;

    console.log(`Tip Pool Variance Calculation:
      - Raw Pool (with carryover): $${rawPool.toFixed(2)}
      - Floored Pool: $${pool.toFixed(2)}
      - Total Paid Out: $${totalPaidOut.toFixed(2)}
      - Current Variance (carryover to next week): $${currentVariance.toFixed(2)}
    `);

    // Calculate cash needed (subtract previous surplus to reduce need or increase surplus)
    const rawCashNeeded = creditTips - tdsDriverTips + ezcaterTips - cashSales;
    const cashNeeded = rawCashNeeded - previousCashSurplus;

    console.log(`Cash Need Calculation:
      - Raw Cash Needed: $${rawCashNeeded.toFixed(2)}
      - Previous Week Surplus: $${previousCashSurplus.toFixed(2)}
      - Final Cash Needed: $${cashNeeded.toFixed(2)}
    `);

    return { records, rate, totalWeightedHours, totalTips, pool, cashNeeded, currentVariance, totalPaidOut };
  }

  function renderTipPoolSummary() {
    console.log('renderTipPoolSummary called, tipPoolSummary:', tipPoolSummary);
    const summaryDiv = document.getElementById('tipPoolSummary');
    const { cashNeeded } = tipPoolSummary;
    
    // COPY EXACT LOGIC FROM ORIGINAL TIP POOL CALCULATOR LINE 565 (CORRECT LOGIC)
    let cashStatusHtml = '';
    if (cashNeeded > 0) {
      // Need additional cash - show positive amount in red
      cashStatusHtml = `<p><strong>Cash needed to pay out tips:</strong> <span class="cash-needed">$${cashNeeded.toFixed(2)}</span></p>`;
    } else {
      // Have surplus - show positive amount in green
      cashStatusHtml = `<p><strong>Zero cash needed to pay out tips this week. Excess cash on hand:</strong> <span class="cash-surplus">$${Math.abs(cashNeeded).toFixed(2)}</span></p>`;
    }
    
    // Build variance carryover display
    let varianceCarryoverHtml = '';
    if (tipPoolSummary.previousVariance && tipPoolSummary.previousVariance > 0) {
      const carriedDate = new Date(tipPoolSummary.carriedFromDate + 'T12:00:00').toLocaleDateString();
      varianceCarryoverHtml = `
          <div style="background: white; padding: 15px; border-radius: 0; border: 2px solid #ff9800; grid-column: 1 / -1;">
            <h4 style="margin: 0 0 8px 0; color: #ff9800; font-size: 12px;">⚠️ UNPAID TIPS FROM PREVIOUS WEEK</h4>
            <p style="margin: 0; font-size: 18px; font-weight: bold; color: #ff9800;">$${tipPoolSummary.previousVariance.toFixed(2)}</p>
            <p style="margin: 5px 0 0 0; font-size: 11px; color: #666;">Carried from week ending: ${carriedDate}</p>
            <p style="margin: 5px 0 0 0; font-size: 11px; font-style: italic; color: #666;">This amount has been added to this week's tip pool</p>
          </div>`;
    }

    summaryDiv.innerHTML = `
      <div style="background: #f8f9fa; padding: 20px; border-radius: 0; margin: 20px 0;">
        <h3 style="margin: 0 0 15px 0; color: #1e3c72;">Tip Pool Summary</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">

          ${varianceCarryoverHtml}

          <div style="background: white; padding: 15px; border-radius: 0; border: 1px solid #ddd;">
            <h4 style="margin: 0 0 8px 0; color: #666; font-size: 12px;">CREDIT TIPS</h4>
            <p style="margin: 0; font-size: 18px; font-weight: bold; color: #007bff;">$${tipPoolSummary.creditTips.toFixed(2)}</p>
          </div>
          
          <div style="background: white; padding: 15px; border-radius: 0; border: 1px solid #ddd;">
            <h4 style="margin: 0 0 8px 0; color: #666; font-size: 12px;">REAL ENVELOPE DEPOSIT</h4>
            <p style="margin: 0; font-size: 18px; font-weight: bold; color: #28a745;">$${tipPoolSummary.realEnvelopeDeposit.toFixed(2)}</p>
          </div>
          
          <div style="background: white; padding: 15px; border-radius: 0; border: 1px solid #ddd;">
            <h4 style="margin: 0 0 8px 0; color: #666; font-size: 12px;">TOAST CASH SALES</h4>
            <p style="margin: 0; font-size: 18px; font-weight: bold; color: #dc3545;">$${tipPoolSummary.toastCashSales.toFixed(2)}</p>
          </div>
          
          <div style="background: white; padding: 15px; border-radius: 0; border: 1px solid #ddd;">
            <h4 style="margin: 0 0 8px 0; color: #666; font-size: 12px;">CASH TIPS (CALCULATED)</h4>
            <p style="margin: 0; font-size: 18px; font-weight: bold; color: #28a745;">$${tipPoolSummary.cashTips.toFixed(2)}</p>
            <p style="margin: 5px 0 0 0; font-size: 10px; color: #666;">($${tipPoolSummary.realEnvelopeDeposit.toFixed(2)} - $${tipPoolSummary.toastCashSales.toFixed(2)})</p>
          </div>
          
          <div style="background: white; padding: 15px; border-radius: 0; border: 1px solid #ddd;">
            <h4 style="margin: 0 0 8px 0; color: #666; font-size: 12px;">TOTAL POOL</h4>
            <p style="margin: 0; font-size: 18px; font-weight: bold; color: #1e3c72;">$${tipPoolSummary.pool.toFixed(2)}</p>
          </div>
          
          <div style="background: white; padding: 15px; border-radius: 0; border: 1px solid #ddd;">
            <h4 style="margin: 0 0 8px 0; color: #666; font-size: 12px;">HOURLY RATE</h4>
            <p style="margin: 0; font-size: 18px; font-weight: bold; color: #f57c00;">$${tipPoolSummary.hourlyRate.toFixed(2)}</p>
          </div>
          
        </div>
        
        <!-- Cash Status from Original Logic -->
        <div style="margin-top: 15px; padding: 15px; background: white; border-radius: 0; border: 1px solid #ddd; text-align: center;">
          ${cashStatusHtml}
        </div>
        
        <div style="margin-top: 15px; padding: 10px; background: #e3f2fd; border-radius: 0; border-left: 4px solid #2196f3;">
          <p style="margin: 0; font-size: 14px;"><strong>Period:</strong> ${tipPoolSummary.dateRange || 'Not specified'}</p>
          <p style="margin: 5px 0 0 0; font-size: 14px;"><strong>Calculated by:</strong> ${tipPoolSummary.calculatedByName}</p>
          ${tipPoolSummary.customNotes ? `<p style="margin: 10px 0 0 0; font-size: 13px; padding-top: 8px; border-top: 1px solid #90caf9;"><strong>Notes:</strong> ${tipPoolSummary.customNotes}</p>` : ''}
        </div>

        ${tipPoolSummary.laborData ? `
        <!-- Labor Summary Section -->
        <div style="margin-top: 20px; padding: 20px; background: white; border-radius: 0; border: 2px solid #1e3c72;">
          <h3 style="margin: 0 0 15px 0; color: #1e3c72; text-transform: uppercase;">Labor Cost Analysis</h3>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">

            <!-- Left Column -->
            <div>
              <div style="padding: 10px; background: #f8f9fa; border-left: 3px solid #1e3c72; margin-bottom: 8px;">
                <div style="font-size: 11px; color: #666;">BASE LABOR COST ${tipPoolSummary.laborData.usingManualCost ? '(TOAST WEB)' : '(API)'}</div>
                <div style="font-size: 18px; font-weight: bold; color: #1e3c72;">$${tipPoolSummary.laborData.baseLaborCost.toFixed(2)}</div>
                ${tipPoolSummary.laborData.usingManualCost ? `
                  <div style="font-size: 10px; color: #28a745; margin-top: 4px;">✓ Manual cost includes CA double-time</div>
                  <div style="font-size: 9px; color: #999;">API: $${tipPoolSummary.laborData.apiLaborCost.toFixed(2)} (+$${(tipPoolSummary.laborData.manualLaborCost - tipPoolSummary.laborData.apiLaborCost).toFixed(2)})</div>
                ` : `
                  <div style="font-size: 10px; color: #ffc107; margin-top: 4px;">⚠️ May be $100-150 low (CA double-time)</div>
                `}
              </div>
              <div style="padding: 10px; background: #f8f9fa; border-left: 3px solid #6c757d; margin-bottom: 8px;">
                <div style="font-size: 11px; color: #666;">MANAGER SALARY (WEEKLY)</div>
                <div style="font-size: 18px; font-weight: bold; color: #6c757d;">$${tipPoolSummary.laborData.demetriSalary.toFixed(2)}</div>
              </div>
              <div style="padding: 10px; background: #f8f9fa; border-left: 3px solid #17a2b8; margin-bottom: 8px;">
                <div style="font-size: 11px; color: #666;">SUBTOTAL LABOR</div>
                <div style="font-size: 18px; font-weight: bold; color: #17a2b8;">$${tipPoolSummary.laborData.subtotalLabor.toFixed(2)}</div>
              </div>
              <div style="padding: 10px; background: #f8f9fa; border-left: 3px solid #ffc107; margin-bottom: 8px;">
                <div style="font-size: 11px; color: #666;">PAYROLL BURDEN (33%)</div>
                <div style="font-size: 18px; font-weight: bold; color: #f57c00;">$${tipPoolSummary.laborData.payrollBurden.toFixed(2)}</div>
              </div>
            </div>

            <!-- Right Column -->
            <div>
              <div style="padding: 10px; background: #f8f9fa; border-left: 3px solid #28a745; margin-bottom: 8px;">
                <div style="font-size: 11px; color: #666;">TRUE TOTAL LABOR COST</div>
                <div style="font-size: 18px; font-weight: bold; color: #28a745;">$${tipPoolSummary.laborData.trueTotalLaborCost.toFixed(2)}</div>
              </div>
              <div style="padding: 10px; background: #f8f9fa; border-left: 3px solid #007bff; margin-bottom: 8px;">
                <div style="font-size: 11px; color: #666;">NET SALES${tipPoolSummary.laborData.usingEzcaterSales ? ' (includes EZCater)' : ''}</div>
                <div style="font-size: 18px; font-weight: bold; color: #007bff;">$${tipPoolSummary.laborData.netSales.toFixed(2)}</div>
                ${tipPoolSummary.laborData.usingEzcaterSales ? `
                  <div style="font-size: 9px; color: #999; margin-top: 4px;">Base: $${tipPoolSummary.laborData.baseNetSales.toFixed(2)} + EZCater: $${tipPoolSummary.laborData.ezcaterSales.toFixed(2)}</div>
                ` : ''}
              </div>
              <div style="padding: 15px; background: ${tipPoolSummary.laborData.laborVariance > 0 ? '#ffebee' : '#e8f5e9'}; border-left: 4px solid ${tipPoolSummary.laborData.laborVariance > 0 ? '#dc3545' : '#28a745'}; text-align: center;">
                <div style="font-size: 11px; color: #666; margin-bottom: 5px;">LABOR PERCENTAGE</div>
                <div style="font-size: 32px; font-weight: bold; color: ${tipPoolSummary.laborData.laborVariance > 0 ? '#dc3545' : '#28a745'};">
                  ${tipPoolSummary.laborData.laborPercentage.toFixed(2)}%
                </div>
                <div style="font-size: 10px; color: #666; margin-top: 5px;">
                  Industry Benchmark: ${tipPoolSummary.laborData.industryBenchmark.toFixed(1)}%
                  <br>
                  <span style="font-weight: bold; color: ${tipPoolSummary.laborData.laborVariance > 0 ? '#dc3545' : '#28a745'};">
                    ${tipPoolSummary.laborData.laborVariance > 0 ? '▲' : '▼'} ${Math.abs(tipPoolSummary.laborData.laborVariance).toFixed(2)}%
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>
        ` : ''}
      </div>
    `;
  }

  function renderTipPoolTable() {
    console.log('renderTipPoolTable called, tipPoolRecords:', tipPoolRecords);
    const tableDiv = document.getElementById('tipPoolTable');
    
    let tableHtml = `
      <div style="margin: 16px 0;">
        <h3 style="color: var(--gray-900); margin-bottom: 8px; font-size: 14px; font-weight: 700; text-transform: uppercase; letter-spacing: 1.5px;">Employee Tip Distribution</h3>
        <p style="color: var(--gray-500); margin-bottom: 12px; font-size: 11px;">Check boxes to mark paid. Adjust equity percentages - changes save automatically.</p>
        <div style="overflow-x: auto;">
          <table id="tipPoolRecordsTable" style="width: 100%; border-collapse: collapse; background: white; border-radius: 0; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <thead>
              <tr style="background: var(--primary-blue); color: var(--gray-900);">
                <th style="padding: 8px; text-align: center; font-size: 10px; width: 30px;"></th>
                <th style="padding: 8px; text-align: left; font-size: 10px; text-transform: uppercase; letter-spacing: 1px;">#</th>
                <th style="padding: 8px; text-align: left; font-size: 10px; text-transform: uppercase; letter-spacing: 1px;">First</th>
                <th style="padding: 8px; text-align: left; font-size: 10px; text-transform: uppercase; letter-spacing: 1px;">Last</th>
                <th style="padding: 8px; text-align: center; font-size: 10px; text-transform: uppercase; letter-spacing: 1px;">Reg Hrs</th>
                <th style="padding: 8px; text-align: center; font-size: 10px; text-transform: uppercase; letter-spacing: 1px;">OT Hrs</th>
                <th style="padding: 8px; text-align: center; font-size: 10px; text-transform: uppercase; letter-spacing: 1px;">Total Hrs</th>
                <th style="padding: 8px; text-align: center; font-size: 10px; text-transform: uppercase; letter-spacing: 1px;">Equity %</th>
                <th style="padding: 8px; text-align: center; font-size: 10px; text-transform: uppercase; letter-spacing: 1px;">Weighted</th>
                <th style="padding: 8px; text-align: center; font-size: 10px; text-transform: uppercase; letter-spacing: 1px;">Tips Due</th>
              </tr>
            </thead>
            <tbody>
    `;
    
    // Sort records by last name like original
    tipPoolRecords.sort((a, b) => a.last.localeCompare(b.last));
    
    tipPoolRecords.forEach((record, index) => {
      const rowBg = index % 2 === 0 ? '#f8f9fa' : 'white';
      const equityPercent = record.equity * 100;
      // Calculate OT hours (regularHours and overtimeHours come from API)
      const regularHours = record.regularHours || 0;
      const overtimeHours = record.overtimeHours || 0;
      const totalHours = record.hours;

      // Highlight OT hours in orange if > 0
      const otStyle = overtimeHours > 0
        ? 'color: #ff8c00; font-weight: bold;'
        : '';

      tableHtml += `
        <tr data-employee="${record.employee}" style="background: ${rowBg};">
          <td style="padding: 8px; text-align: center; border-bottom: 1px solid var(--gray-300);">
            <input type="checkbox" style="width: 18px; height: 18px; cursor: pointer; accent-color: var(--primary-blue);" />
          </td>
          <td style="padding: 8px; border-bottom: 1px solid var(--gray-300); font-size: 13px; color: var(--gray-700);">${index + 1}</td>
          <td style="padding: 8px; border-bottom: 1px solid var(--gray-300); font-size: 13px; color: var(--gray-900);">${record.first}</td>
          <td style="padding: 8px; border-bottom: 1px solid var(--gray-300); font-size: 13px; font-weight: 600; color: var(--gray-900);">${record.last}</td>
          <td style="padding: 8px; text-align: center; border-bottom: 1px solid var(--gray-300); font-size: 13px; color: var(--gray-700);">${regularHours.toFixed(2)}</td>
          <td style="padding: 8px; text-align: center; border-bottom: 1px solid var(--gray-300); ${otStyle}; font-size: 13px;">${overtimeHours.toFixed(2)}</td>
          <td style="padding: 8px; text-align: center; border-bottom: 1px solid var(--gray-300); font-weight: 600; font-size: 13px; color: var(--gray-900);">${totalHours.toFixed(2)}</td>
          <td style="padding: 8px; text-align: center; border-bottom: 1px solid var(--gray-300);">
            <input type="number" name="equity" step="1" min="1" max="100" value="${equityPercent.toFixed(0)}"
                   inputmode="numeric" pattern="[0-9]*"
                   style="width: 50px; text-align: center; border: 1px solid var(--gray-300); border-radius: 0; padding: 4px; font-size: 12px;" />
          </td>
          <td style="padding: 8px; text-align: center; border-bottom: 1px solid var(--gray-300); font-size: 12px; color: var(--gray-700);">${record.weighted.toFixed(3)}</td>
          <td style="padding: 8px; text-align: center; border-bottom: 1px solid var(--gray-300); font-weight: 700; font-size: 14px; color: var(--primary-blue);">$${record.due.toFixed(2)}</td>
        </tr>
      `;
    });
    
    tableHtml += `
            </tbody>
          </table>
        </div>
      </div>
    `;
    
    tableDiv.innerHTML = tableHtml;
    
    // Attach change listeners to equity inputs - use 'blur' to prevent cursor jumping
    const inputs = tableDiv.querySelectorAll('input[name="equity"]');
    inputs.forEach(inp => {
      inp.addEventListener('blur', () => {
        recomputeTipPoolFromTable();
      });
      // Also listen for Enter key to update immediately
      inp.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          inp.blur(); // Trigger blur event
        }
      });
    });
  }

  // Recompute the tip pool when equity values are changed in the table
  function recomputeTipPoolFromTable() {
    // Read equity inputs from DOM
    const rows = document.querySelectorAll('#tipPoolRecordsTable tbody tr');
    const updatedEquity = {};
    
    rows.forEach(row => {
      const emp = row.getAttribute('data-employee');
      const eqInput = row.querySelector('input[name="equity"]');
      // The equity input represents a whole percentage (1—100). Convert it
      // to a fractional equity by dividing by 100. Use 0 if parsing fails.
      const eqPercent = parseFloat(eqInput.value);
      const eqFraction = isNaN(eqPercent) ? 0 : eqPercent / 100.0;
      updatedEquity[emp] = eqFraction;
    });
    
    // Recalculate
    let totalWeightedHours = 0;
    tipPoolRecords.forEach(r => {
      r.equity = updatedEquity[r.employee];
      r.weighted = r.hours * r.equity;
      totalWeightedHours += r.weighted;
    });
    
    // Compute the raw pool and then floor it to meet business rules
    // IMPORTANT: Include previous variance carryover in the pool
    const rawPool = tipPoolSummary.totalTips - tipPoolSummary.tdsDriverTips + (tipPoolSummary.previousVariance || 0);
    const pool = Math.floor(rawPool);
    const rate = totalWeightedHours ? pool / totalWeightedHours : 0;
    
    tipPoolRecords.forEach(r => {
      const rawDue = r.weighted * rate;
      // Round each individual's due down to the nearest whole dollar
      r.due = Math.floor(rawDue);
    });
    
    // Update summary
    tipPoolSummary.pool = pool;
    tipPoolSummary.totalWeightedHours = totalWeightedHours;
    tipPoolSummary.hourlyRate = rate;
    tipPoolSummary.cashNeeded = tipPoolSummary.creditTips - tipPoolSummary.tdsDriverTips + tipPoolSummary.ezcaterTips - tipPoolSummary.cashSales;
    
    // Removed saveTipPoolData() - tip pool fields now reset every time
    
    // Rerender summary and table
    renderTipPoolSummary();
    renderTipPoolTable();
  }

  async function generateTipPoolPDF() {
    try {
      // Create jsPDF instance
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'letter' });
      
      const pageWidth = doc.internal.pageSize.getWidth();
      const pageHeight = doc.internal.pageSize.getHeight();
      const margin = 40;
      
      // Set default font to a modern sans-serif and black text
      doc.setFont('helvetica', 'normal');
      doc.setTextColor(0, 0, 0);
      
      let currentY = margin;
      
      // Header text
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(18);
      doc.text('JAYNA SAC WEEKLY TIP POOL REPORT', margin, currentY + 15);
      doc.setFontSize(10);
      doc.setFont('helvetica', 'normal');
      
      // Use uppercase labels and values for header metadata
      const dateRange = (tipPoolSummary.dateRange || '').toUpperCase();
      doc.text(`WEEK OF: ${dateRange}`, margin, currentY + 32);
      const reporter = (tipPoolSummary.calculatedByName || '').toUpperCase();
      doc.text(`RAN BY: ${reporter}`, margin, currentY + 44);
      const timestamp = (tipPoolSummary.generatedAt || '').toUpperCase();
      doc.text(`GENERATED: ${timestamp}`, margin, currentY + 56);
      
      // Draw a thin horizontal line below header for separation
      doc.setLineWidth(0.5);
      doc.line(margin, currentY + 70, pageWidth - margin, currentY + 70);
      
      // Summary section: arrange entries in two columns
      doc.setFontSize(10);
      doc.setFont('helvetica', 'normal');
      
      // Build an array of [label, value] pairs
      const entries = [];

      // Add previous variance carryover if it exists (compliance tracking)
      if (tipPoolSummary.previousVariance && tipPoolSummary.previousVariance > 0) {
        const carriedDate = new Date(tipPoolSummary.carriedFromDate + 'T12:00:00').toLocaleDateString();
        entries.push(
          ['⚠️ UNPAID TIPS FROM PREVIOUS WEEK', `$${tipPoolSummary.previousVariance.toFixed(2)}`],
          [`   Carried from week ending ${carriedDate}`, '(ADDED TO POOL)']
        );
      }

      // Standard tip pool entries
      entries.push(
        ['Cash tips', `$${tipPoolSummary.cashTips.toFixed(2)}`],
        ['EZCater tips', `$${tipPoolSummary.ezcaterTips.toFixed(2)}`],
        ['Credit tips', `$${tipPoolSummary.creditTips.toFixed(2)}`],
        ['TDS driver', `$${tipPoolSummary.tdsDriverTips.toFixed(2)}`],
        ['Cash sales', `$${tipPoolSummary.cashSales.toFixed(2)}`],
        ['Total tips', `$${tipPoolSummary.totalTips.toFixed(2)}`],
        ['Pool (minus TDS driver)', `$${tipPoolSummary.pool.toFixed(2)}`],
        ['Total weighted hours', `${tipPoolSummary.totalWeightedHours.toFixed(3)}`],
        ['Hourly rate', `$${tipPoolSummary.hourlyRate.toFixed(2)}`]
      );

      // Convert all to uppercase
      const formattedEntries = entries.map(([label, value]) => [label.toUpperCase(), value.toUpperCase()]);
      
      // Define fixed x offsets for values within each column
      const colValueOffset = 200; // points from the left edge of the column
      let summaryY = currentY + 86;
      const lineHeight = 14;
      const colSplitIndex = Math.ceil(formattedEntries.length / 2);
      const col2X = pageWidth / 2;

      // Render first column
      for (let i = 0; i < colSplitIndex; i++) {
        const [label, value] = formattedEntries[i];
        doc.setFont('helvetica', 'bold');
        doc.text(`${label}:`, margin, summaryY + i * lineHeight);
        doc.setFont('helvetica', 'normal');
        doc.text(value, margin + colValueOffset, summaryY + i * lineHeight);
      }

      // Render second column
      for (let i = colSplitIndex; i < formattedEntries.length; i++) {
        const [label, value] = formattedEntries[i];
        const rowIdx = i - colSplitIndex;
        doc.setFont('helvetica', 'bold');
        doc.text(`${label}:`, col2X, summaryY + rowIdx * lineHeight);
        doc.setFont('helvetica', 'normal');
        doc.text(value, col2X + colValueOffset, summaryY + rowIdx * lineHeight);
      }

      // Cash needed line with color coding
      const cashNeeded = tipPoolSummary.cashNeeded;
      let needLabel, needValue, textColor;

      if (cashNeeded > 0) {
        // Need additional cash - show positive number in red
        needLabel = 'CASH NEEDED TO PAY OUT TIPS';
        needValue = `$${cashNeeded.toFixed(2)}`;
        textColor = [220, 53, 69]; // Red color
      } else {
        // Have surplus - show positive number in green
        needLabel = 'ZERO CASH NEEDED TO PAY OUT TIPS THIS WEEK. EXCESS CASH ON HAND';
        needValue = `$${Math.abs(cashNeeded).toFixed(2)}`;
        textColor = [40, 167, 69]; // Green color
      }

      const summaryLines = Math.max(colSplitIndex, formattedEntries.length - colSplitIndex);
      const cashY = summaryY + summaryLines * lineHeight + 10;
      
      // Set label in bold black
      doc.setFont('helvetica', 'bold');
      doc.setTextColor(0, 0, 0);
      doc.text(`${needLabel}:`, margin, cashY);
      
      // Calculate proper positioning for the value
      let valueX = margin + colValueOffset;
      let valueY = cashY;
      
      if (needLabel.length > 35) { // Long label - put value on next line
        valueX = margin;
        valueY = cashY + lineHeight;
      }
      
      // Set value in colored italic
      doc.setFont('helvetica', 'italic');
      doc.setTextColor(textColor[0], textColor[1], textColor[2]);
      doc.text(needValue, valueX, valueY);
      
      // Reset text color back to black for the rest of the document
      doc.setTextColor(0, 0, 0);
      
      // Draw a horizontal separator before the table
      const tableStartY = cashY + 25;
      doc.setFont('helvetica', 'normal');
      doc.setLineWidth(0.5);
      doc.line(margin, tableStartY - 5, pageWidth - margin, tableStartY - 5);
      
      // Prepare table data (convert names to uppercase)
      const tableBody = tipPoolRecords.map(r => [
        r.first.toUpperCase(),
        r.last.toUpperCase(),
        r.hours.toFixed(2),
        (r.equity * 100).toFixed(0),
        r.weighted.toFixed(3),
        '$' + r.due.toFixed(2)
      ]);
      
      // Generate the table
      doc.autoTable({
        head: [['FIRST', 'LAST', 'HOURS', 'EQUITY (%)', 'WEIGHTED', 'DUE']],
        body: tableBody,
        startY: tableStartY,
        margin: { left: margin, right: margin },
        styles: { font: 'helvetica', fontSize: 8, textColor: [0, 0, 0], lineColor: [0, 0, 0], lineWidth: 0.1 },
        headStyles: { font: 'helvetica', fontStyle: 'bold', textColor: [0, 0, 0], fillColor: null },
        bodyStyles: { font: 'helvetica', textColor: [0, 0, 0], fillColor: null },
        tableWidth: 'auto'
      });
      
      // Generate filename and save
      const dateStr = tipPoolSummary.dateRange || new Date().toLocaleDateString().replace(/\//g, '-');
      const filename = `Tip_Pool_Distribution_${dateStr}.pdf`;
      doc.save(filename);
      
    } catch (error) {
      console.error('PDF generation error:', error);
      throw error;
    }
  }

  async function generateCombinedReportPDF(startDate, endDate, cashData, realEnvelopeAmount = null, cashboxTotal = null) {
    try {
      // Fetch cashbox reconciliation data
      let cashboxReconciliation = null;
      if (cashboxTotal !== null) {
        cashboxReconciliation = await getCashboxReconciliation(cashboxTotal);
      }
      
      // Create jsPDF instance
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'letter' });
      
      const pageWidth = doc.internal.pageSize.getWidth();
      const pageHeight = doc.internal.pageSize.getHeight();
      const margin = 40;
      
      // Set default font to a modern sans-serif and black text
      doc.setFont('helvetica', 'normal');
      doc.setTextColor(0, 0, 0);
      
      let currentY = margin;
      
      // Header text with tighter spacing
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(16);  // Reduced from 18
      doc.text('JAYNA GYRO COMBINED WEEKLY REPORT', margin, currentY + 12);
      doc.setFontSize(9);   // Reduced from 10
      doc.setFont('helvetica', 'normal');
      
      // Use uppercase labels and values for header metadata with tighter spacing
      const dateRange = `${startDate.toUpperCase()} TO ${endDate.toUpperCase()}`;
      doc.text(`WEEK OF: ${dateRange}`, margin, currentY + 26);  // Reduced spacing
      const reporter = (tipPoolSummary.calculatedByName || '').toUpperCase();
      doc.text(`RAN BY: ${reporter}`, margin, currentY + 36);     // Reduced spacing
      const timestamp = new Date().toLocaleString().toUpperCase();
      doc.text(`GENERATED: ${timestamp}`, margin, currentY + 46); // Reduced spacing
      
      // Draw a thin horizontal line below header for separation
      doc.setLineWidth(0.5);
      doc.line(margin, currentY + 56, pageWidth - margin, currentY + 56); // Reduced spacing
      
      // Calculate cash report totals using same logic
      let totalToastSalesReported = 0;
      let totalActualCashIn = 0;
      let totalDiscrepancy = 0;
      let totalEnvelopeDeposits = 0;
      let totalBackToCashbox = 0;

      cashData.forEach(day => {
        totalToastSalesReported += day.pm_toast_sales || 0;
        totalActualCashIn += (day.pm_total - day.am_total) || 0;
        totalDiscrepancy += day.pm_discrepancy || 0;
        totalEnvelopeDeposits += day.pm_deposit_amount || 0;
        totalBackToCashbox += (day.pm_amount_to_keep - day.am_total) || 0;
      });

      // Summary section: arrange entries in three columns with tighter spacing
      doc.setFontSize(7);   // Further reduced for better fit
      doc.setFont('helvetica', 'normal');

      // Column 1: Cash data
      const leftColumnEntries = [
        ['Toast Cash Sales Reported', `$${totalToastSalesReported.toFixed(2)}`],
        ['Actual Cash In', `$${totalActualCashIn.toFixed(2)}`],
        ['Total Discrepancy', `$${totalDiscrepancy.toFixed(2)}`]
      ];

      // Add cashbox reconciliation if available
      if (cashboxReconciliation) {
        leftColumnEntries.push(['Current Cashbox Total', `$${cashboxReconciliation.currentTotal.toFixed(2)}`]);

        if (!cashboxReconciliation.isFirstCount && cashboxReconciliation.expectedEnding !== undefined) {
          leftColumnEntries.push(['Expected', `$${cashboxReconciliation.expectedEnding.toFixed(2)}`]);
          leftColumnEntries.push(['Total Period Discrepancies', `$${cashboxReconciliation.totalDiscrepancies.toFixed(2)}`]);

          if (Math.abs(cashboxReconciliation.actualVariance) >= 0.01) {
            const varianceLabel = cashboxReconciliation.actualVariance >= 0 ? 'Unexplained Overage' : 'Unexplained Shortage';
            leftColumnEntries.push([varianceLabel, `$${Math.abs(cashboxReconciliation.actualVariance).toFixed(2)}`]);
          } else {
            leftColumnEntries.push(['Reconciliation Status', 'BALANCED']);
          }
        } else if (!cashboxReconciliation.isFirstCount) {
          // Fallback for old logic
          const varianceLabel = cashboxReconciliation.variance >= 0 ? 'Cashbox Increase' : 'Cashbox Decrease';
          leftColumnEntries.push([varianceLabel, `$${Math.abs(cashboxReconciliation.variance).toFixed(2)}`]);
        }
      } else {
        // Fallback when no cashbox data is available yet
        leftColumnEntries.push(['Cashbox Reconciliation', 'N/A']);
      }

      const leftColumnMapped = leftColumnEntries.map(([label, value]) => [label.toUpperCase(), value.toUpperCase()]);

      // Column 2: Tip sources
      const middleColumnEntries = [];

      // Add previous variance carryover if it exists (compliance tracking)
      if (tipPoolSummary.previousVariance && tipPoolSummary.previousVariance > 0) {
        const carriedDate = new Date(tipPoolSummary.carriedFromDate + 'T12:00:00').toLocaleDateString();
        middleColumnEntries.push(
          ['UNPAID TIPS', `$${tipPoolSummary.previousVariance.toFixed(2)}`],
          [`Carried from ${carriedDate}`, '']
        );
      }

      middleColumnEntries.push(
        ['Credit Tips', `$${tipPoolSummary.creditTips.toFixed(2)}`],
        ['Cash Tips', `$${tipPoolSummary.cashTips.toFixed(2)}`],
        ['EZCater Tips', `$${tipPoolSummary.ezcaterTips.toFixed(2)}`]
      );

      const middleColumnMapped = middleColumnEntries.map(([label, value]) => [label.toUpperCase(), value.toUpperCase()]);

      // Column 3: Tip distribution
      const rightColumnEntries = [
        ['Total Tips', `$${tipPoolSummary.totalTips.toFixed(2)}`],
        ['TDS Driver', `$${tipPoolSummary.tdsDriverTips.toFixed(2)}`],
        ['Tip Pool Total (Minus TDS)', `$${tipPoolSummary.pool.toFixed(2)}`],
        ['Hourly Rate', `$${tipPoolSummary.hourlyRate.toFixed(2)}`]
      ];

      const rightColumnMapped = rightColumnEntries.map(([label, value]) => [label.toUpperCase(), value.toUpperCase()]);

      // Define fixed x offsets for values within each column
      const colWidth = (pageWidth - (2 * margin)) / 3;
      const colValueOffset = colWidth - 55;  // Dynamic offset based on column width
      let summaryY = currentY + 66; // Reduced from 86
      const lineHeight = 9;         // Further reduced to 9 from 11
      const col2X = margin + colWidth;
      const col3X = margin + (colWidth * 2);

      // Draw column 1 (cash data)
      let col1Y = summaryY;
      for (const [label, value] of leftColumnMapped) {
        doc.setFont('helvetica', 'bold');
        doc.text(`${label}:`, margin, col1Y);
        doc.setFont('helvetica', 'normal');
        doc.text(value, margin + colValueOffset, col1Y);
        col1Y += lineHeight;
      }

      // Draw column 2 (tip sources)
      let col2Y = summaryY;
      for (const [label, value] of middleColumnMapped) {
        doc.setFont('helvetica', 'bold');
        doc.text(`${label}:`, col2X, col2Y);
        doc.setFont('helvetica', 'normal');
        doc.text(value, col2X + colValueOffset, col2Y);
        col2Y += lineHeight;
      }

      // Draw column 3 (tip distribution)
      let col3Y = summaryY;
      for (const [label, value] of rightColumnMapped) {
        doc.setFont('helvetica', 'bold');
        doc.text(`${label}:`, col3X, col3Y);
        doc.setFont('helvetica', 'normal');
        doc.text(value, col3X + colValueOffset, col3Y);
        col3Y += lineHeight;
      }
      
      // Add centered Cash Needed/Surplus line below all three columns with larger italic font
      const cashNeededY = Math.max(col1Y, col2Y, col3Y) + 8;
      const cashNeededLabel = tipPoolSummary.cashNeeded > 0 ? 'CASH NEEDED' : 'CASH SURPLUS';
      const cashNeededValue = `$${Math.abs(tipPoolSummary.cashNeeded).toFixed(2)}`;
      const cashNeededText = `${cashNeededLabel}: ${cashNeededValue}`;
      
      // Set color and font for cash needed line
      if (tipPoolSummary.cashNeeded > 0) {
        doc.setTextColor(220, 53, 69); // Red for cash needed
      } else {
        doc.setTextColor(40, 167, 69); // Green for surplus
      }
      
      doc.setFont('helvetica', 'italic');
      doc.setFontSize(10); // Slightly larger but not too big
      
      // Center the text between the margins
      const textWidth = doc.getTextWidth(cashNeededText);
      const centerX = (pageWidth / 2) - (textWidth / 2);
      doc.text(cashNeededText, centerX, cashNeededY);
      
      // Reset font and color
      doc.setTextColor(0, 0, 0);
      doc.setFont('helvetica', 'normal');
      doc.setFontSize(9);

      // Add previous week cash surplus note if applicable
      let cashSurplusNoteY = cashNeededY + 8;
      if (tipPoolSummary.previousCashSurplus && tipPoolSummary.previousCashSurplus > 0) {
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(7);
        doc.setTextColor(100, 100, 100); // Gray

        // Parse date without timezone shift (dates stored as YYYY-MM-DD for Sunday of the week)
        // Append 'T12:00:00' to force local time interpretation instead of UTC
        const surplusDate = new Date(tipPoolSummary.cashSurplusFromDate + 'T12:00:00').toLocaleDateString();
        const surplusText = `Includes $${tipPoolSummary.previousCashSurplus.toFixed(2)} surplus from week ending ${surplusDate}`;

        const surplusWidth = doc.getTextWidth(surplusText);
        const surplusCenterX = (pageWidth / 2) - (surplusWidth / 2);
        doc.text(surplusText, surplusCenterX, cashSurplusNoteY);

        // Reset for next section
        doc.setTextColor(0, 0, 0);
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(9);

        // Move Y position down for next note
        cashSurplusNoteY += 8;
      }

      // Add note about cashbox reconciliation if not available
      if (!cashboxReconciliation || cashboxReconciliation.isFirstCount) {
        const noteY = cashSurplusNoteY;
        doc.setFont('helvetica', 'italic');
        doc.setFontSize(7);
        doc.setTextColor(128, 128, 128); // Light gray
        
        const noteText = cashboxReconciliation ? 
          'Weekly cashbox reconciliation will be available after multiple counts are recorded.' :
          'Weekly cashbox reconciliation feature coming soon - track total cash on hand vs. daily discrepancies.';
        
        const noteWidth = doc.getTextWidth(noteText);
        const noteCenterX = (pageWidth / 2) - (noteWidth / 2);
        doc.text(noteText, noteCenterX, noteY);
        
        // Reset font and color
        doc.setTextColor(0, 0, 0);
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(9);
      }
      
      // Draw a horizontal line after summary with reduced spacing
      // Calculate spacing based on whether we have surplus note and/or cashbox note
      let extraSpacing = 12;
      if (tipPoolSummary.previousCashSurplus > 0) extraSpacing += 8; // Add space for surplus note
      if (!cashboxReconciliation || cashboxReconciliation.isFirstCount) extraSpacing += 8; // Add space for cashbox note
      const postSummaryY = cashNeededY + extraSpacing;
      doc.setLineWidth(0.5);
      doc.line(margin, postSummaryY, pageWidth - margin, postSummaryY);
      
      // Employee distribution table with reduced spacing
      if (tipPoolRecords && tipPoolRecords.length > 0) {
        currentY = postSummaryY + 12; // Reduced from 20
        
        const tableData = tipPoolRecords.map(record => [
          `${record.first.toUpperCase()} ${record.last.toUpperCase()}`,
          record.hours.toFixed(1),
          (record.equity * 100).toFixed(0),
          record.weighted.toFixed(1),
          `$${record.due.toFixed(2)}`
        ]);
        
        // Calculate totals for the employee table
        const totalHours = tipPoolRecords.reduce((sum, record) => sum + record.hours, 0);
        const totalWeighted = tipPoolRecords.reduce((sum, record) => sum + record.weighted, 0);
        const totalDue = tipPoolRecords.reduce((sum, record) => sum + record.due, 0);
        
        // Add totals row
        const totalsRow = [
          'TOTALS',
          totalHours.toFixed(1),
          '', // Skip equity column as it doesn't make sense to total percentages
          totalWeighted.toFixed(1),
          `$${totalDue.toFixed(2)}`
        ];
        
        const tableDataWithTotals = [...tableData, totalsRow];
        
        doc.autoTable({
          startY: currentY,
          head: [['EMPLOYEE', 'HOURS', 'EQUITY (%)', 'WEIGHTED', 'DUE']],
          body: tableDataWithTotals,
          margin: { left: margin, right: margin },
          theme: 'grid',
          headStyles: { 
            font: 'helvetica', 
            fontStyle: 'bold', 
            textColor: [0, 0, 0], 
            fillColor: [245, 245, 245],
            fontSize: 8,        // Reduced font size
            cellPadding: 3      // Reduced padding
          },
          bodyStyles: { 
            font: 'helvetica', 
            textColor: [0, 0, 0], 
            fillColor: null,
            fontSize: 8,        // Reduced font size
            cellPadding: 3      // Reduced padding
          },
          didParseCell: function(data) {
            // Apply bold styling to totals row (last row)
            if (data.row.index === tableDataWithTotals.length - 1) {
              data.cell.styles.fontStyle = 'bold';
              data.cell.styles.fillColor = [240, 240, 240]; // Light gray background for totals
            }
            
            // Color formatting for DISCREPANCY column (column index 4)
            if (data.column.index === 4 && data.row.index < tableDataWithTotals.length - 1) {
              const cellValue = data.cell.text[0];
              if (cellValue && cellValue.includes('-')) {
                // Negative discrepancy - dark pastel red and italic
                data.cell.styles.textColor = [139, 69, 19]; // Dark red
                data.cell.styles.fontStyle = 'italic';
              } else if (cellValue && cellValue.includes('+')) {
                // Positive discrepancy - dark pastel green
                data.cell.styles.textColor = [34, 139, 34]; // Dark green
              }
            }
          },
          tableWidth: 'auto'
        });
        
        currentY = doc.lastAutoTable.finalY + 10; // Reduced from 20
      }
      
      // Daily cash breakdown table - Clean left-to-right flow
      if (cashData && cashData.length > 0) {
        const dailyTableData = cashData.map(day => {
          const toast = day.pm_toast_sales || 0;
          const actual = (day.pm_total || 0) - (day.am_total || 0);

          // +/- (Over/Short): Actual - Toast
          const overShort = actual - toast;
          const overShortFormatted = overShort >= 0
            ? `+$${overShort.toFixed(2)}`
            : `-$${Math.abs(overShort).toFixed(2)}`;

          // ROUND: Adjustment needed to round Toast to whole dollar
          const rounded = Math.round(toast);
          const roundAdjust = rounded - toast;
          const roundFormatted = roundAdjust >= 0
            ? `+$${roundAdjust.toFixed(2)}`
            : `-$${Math.abs(roundAdjust).toFixed(2)}`;

          // TIPS $: Whole dollar taken from tips
          const originalTips = day.pm_cash_tips || 0;
          const adjustedTips = day.pm_adjusted_tips || originalTips;
          const tipsTaken = originalTips - adjustedTips;

          // CASHBOX: Total excess to cashbox
          const cashbox = (day.pm_amount_to_keep || 0) - (day.am_total || 0);

          return [
            new Date(day.date + 'T12:00:00').toLocaleDateString(),
            day.pm_counter || 'N/A',
            `$${toast.toFixed(2)}`,
            `$${actual.toFixed(2)}`,
            overShortFormatted,
            roundFormatted,
            `$${tipsTaken.toFixed(2)}`,
            `$${cashbox.toFixed(2)}`
          ];
        });

        // Calculate totals for numerical columns (skip DATE and COUNTER columns)
        const totalsRow = ['TOTALS', '', '', '', '', '', '', ''];

        // Calculate totals for columns 2-7 (TOAST, ACTUAL, +/-, ROUND, TIPS $, CASHBOX)
        for (let col = 2; col < 8; col++) {
          let total = 0;
          dailyTableData.forEach(row => {
            let value = row[col].replace('$', '').replace('+', '').replace('-', '').replace(',', '');
            const isNegative = row[col].includes('-');
            const numValue = parseFloat(value) || 0;
            total += isNegative ? -numValue : numValue;
          });

          // Add sign formatting for +/- and ROUND columns
          if (col === 4 || col === 5) { // +/- and ROUND columns
            const sign = total >= 0 ? '+' : '';
            totalsRow[col] = `${sign}$${Math.abs(total).toFixed(2)}`;
          } else {
            totalsRow[col] = `$${total.toFixed(2)}`;
          }
        }

        // Add totals row to table data
        const tableDataWithTotals = [...dailyTableData, totalsRow];

        doc.autoTable({
          startY: currentY,
          head: [['DATE', 'COUNTER', 'TOAST', 'ACTUAL', '+/-', 'ROUND', 'TIPS $', 'CASHBOX']],
          body: tableDataWithTotals,
          margin: { left: margin, right: margin },
          theme: 'plain', // No gridlines - clean look
          headStyles: {
            font: 'helvetica',
            fontStyle: 'bold',
            textColor: [0, 0, 0],
            fillColor: [220, 220, 220], // Darker gray header
            fontSize: 7,
            cellPadding: 3,
            halign: 'center'
          },
          bodyStyles: {
            font: 'helvetica',
            textColor: [0, 0, 0],
            fontSize: 7,
            cellPadding: 3
          },
          alternateRowStyles: {
            fillColor: [245, 245, 245] // Soft gray alternating rows
          },
          didParseCell: function(data) {
            // Totals row - slightly darker background and bold
            if (data.row.index === tableDataWithTotals.length - 1) {
              data.cell.styles.fontStyle = 'bold';
              data.cell.styles.fillColor = [230, 230, 230]; // Slightly darker gray for totals
            }

            // Color formatting for +/- column (column index 4)
            if (data.column.index === 4 && data.row.index < tableDataWithTotals.length - 1) {
              const cellValue = data.cell.text[0];
              if (cellValue && cellValue.includes('-')) {
                data.cell.styles.textColor = [200, 0, 0]; // Soft red for shortage
              } else if (cellValue && cellValue.includes('+')) {
                data.cell.styles.textColor = [0, 150, 0]; // Soft green for overage
              }
            }

            // Color formatting for ROUND column (column index 5)
            if (data.column.index === 5 && data.row.index < tableDataWithTotals.length - 1) {
              const cellValue = data.cell.text[0];
              if (cellValue && cellValue.includes('+')) {
                data.cell.styles.textColor = [100, 100, 100]; // Gray for round up
              } else if (cellValue && cellValue.includes('-')) {
                data.cell.styles.textColor = [100, 100, 100]; // Gray for round down
              }
            }
          },
          tableWidth: 'auto'
        });
      }

      // Add 2-column section: Daily Notes (left) and Labor Summary (right)
      currentY = doc.autoTable.previous.finalY + 10; // Reduced from 15

      // Always show labor summary boxes (they will fit on page with compressed layout)
      if (true) {
        // Draw two bordered boxes side by side
        const boxHeight = 95; // Increased to 95 to fit all labor summary content
        const boxWidth = (pageWidth - (2 * margin) - 10) / 2; // 10pt gap between boxes
        const leftBoxX = margin;
        const rightBoxX = margin + boxWidth + 10;

        // Left box border (Daily Notes)
        doc.setDrawColor(0, 0, 0);
        doc.setLineWidth(1);
        doc.rect(leftBoxX, currentY, boxWidth, boxHeight, 'S');

        // Right box border (Labor Summary)
        doc.rect(rightBoxX, currentY, boxWidth, boxHeight, 'S');

        // Left box header - NOTES
        doc.setFillColor(240, 240, 240);
        doc.rect(leftBoxX, currentY, boxWidth, 16, 'F'); // Reduced header height to 16
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(8); // Reduced from 9
        doc.setTextColor(0, 0, 0);
        const leftHeaderText = 'NOTES';
        const leftHeaderWidth = doc.getTextWidth(leftHeaderText);
        doc.text(leftHeaderText, leftBoxX + (boxWidth - leftHeaderWidth) / 2, currentY + 11);

        // Right box header - WEEKLY LABOR SUMMARY
        doc.setFillColor(240, 240, 240);
        doc.rect(rightBoxX, currentY, boxWidth, 16, 'F'); // Reduced header height to 16
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(8); // Reduced from 9
        const rightHeaderText = 'WEEKLY LABOR SUMMARY';
        const rightHeaderWidth = doc.getTextWidth(rightHeaderText);
        doc.text(rightHeaderText, rightBoxX + (boxWidth - rightHeaderWidth) / 2, currentY + 11);

        // Horizontal line below headers
        doc.setLineWidth(1);
        doc.line(leftBoxX, currentY + 16, leftBoxX + boxWidth, currentY + 16); // Adjusted to new header height
        doc.line(rightBoxX, currentY + 16, rightBoxX + boxWidth, currentY + 16);

        // Left box content - Tip Pool Notes Only
        let notesY = currentY + 26; // Adjusted from 35
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(6.5); // Reduced from 7
        doc.setTextColor(0, 0, 0);

        // Display custom tip pool notes if available
        if (tipPoolSummary && tipPoolSummary.customNotes && tipPoolSummary.customNotes.trim()) {
          // Custom notes content
          const noteLines = doc.splitTextToSize(tipPoolSummary.customNotes.trim(), boxWidth - 10);
          noteLines.forEach(line => {
            if (notesY < currentY + boxHeight - 5) {
              doc.text(line, leftBoxX + 5, notesY);
              notesY += 7; // Reduced from 8
            }
          });
        } else {
          // No notes message (centered)
          doc.setTextColor(150, 150, 150);
          doc.text('No additional notes added during tip pool calculation', leftBoxX + boxWidth / 2, currentY + 45, { align: 'center' });
        }

        // Right box content - Labor Summary (clean and simple)
        let laborY = currentY + 26; // Adjusted from 30
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(6.5); // Reduced from 7
        doc.setTextColor(0, 0, 0);

        if (tipPoolSummary.laborData) {
          const ld = tipPoolSummary.laborData;

          // Compact labor breakdown
          const laborEntries = [
            ['Base Labor Cost:', `$${ld.baseLaborCost.toFixed(2)}`],
            ['Manager Salary (prorated):', `$${ld.demetriSalary.toFixed(2)}`],
            ['Subtotal:', `$${ld.subtotalLabor.toFixed(2)}`],
            ['Payroll Burden (33%):', `$${ld.payrollBurden.toFixed(2)}`]
          ];

          laborEntries.forEach(([label, value]) => {
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(6.5);
            doc.setTextColor(0, 0, 0);
            doc.text(label, rightBoxX + 5, laborY);
            doc.setFont('helvetica', 'bold');
            doc.text(value, rightBoxX + boxWidth - 5, laborY, { align: 'right' });
            laborY += 8.5; // Increased spacing for better readability
          });

          // Line before total
          doc.setLineWidth(0.5);
          doc.setDrawColor(200, 200, 200);
          doc.line(rightBoxX + 5, laborY + 1, rightBoxX + boxWidth - 5, laborY + 1);
          laborY += 8; // Increased spacing

          // True Total Labor Cost
          doc.setFont('helvetica', 'bold');
          doc.setFontSize(7);
          doc.setTextColor(0, 0, 0);
          doc.text('True Total Labor Cost:', rightBoxX + 5, laborY);
          doc.text(`$${ld.trueTotalLaborCost.toFixed(2)}`, rightBoxX + boxWidth - 5, laborY, { align: 'right' });
          laborY += 11; // Increased spacing before Net Sales section

          // Net Sales and Labor %
          const isOverBudget = ld.laborVariance > 0;
          const textColor = isOverBudget ? [220, 53, 69] : [40, 167, 69];

          // Background bar
          doc.setFillColor(245, 245, 245);
          doc.rect(rightBoxX + 5, laborY, boxWidth - 10, 18, 'F'); // Reduced from 24

          doc.setFont('helvetica', 'normal');
          doc.setFontSize(6); // Reduced from 7
          doc.setTextColor(0, 0, 0);
          doc.text(`NET SALES${ld.usingEzcaterSales ? ' (incl. EZCater)' : ''}`, rightBoxX + 10, laborY + 5);
          doc.setFont('helvetica', 'bold');
          doc.text(`$${ld.netSales.toFixed(2)}`, rightBoxX + boxWidth - 10, laborY + 5, { align: 'right' });

          // Show EZCater breakdown if applicable
          if (ld.usingEzcaterSales) {
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(5);
            doc.setTextColor(100, 100, 100);
            doc.text(`Base: $${ld.baseNetSales.toFixed(2)} + EZCater: $${ld.ezcaterSales.toFixed(2)}`, rightBoxX + 10, laborY + 9);
          }

          doc.setFont('helvetica', 'normal');
          doc.setFontSize(6); // Reduced from 7
          doc.setTextColor(100, 100, 100);
          doc.text('LABOR PERCENTAGE', rightBoxX + 10, laborY + 11);

          doc.setFont('helvetica', 'bold');
          doc.setFontSize(7.5); // Reduced from 9
          doc.setTextColor(textColor[0], textColor[1], textColor[2]);
          doc.text(`${ld.laborPercentage.toFixed(2)}%`, rightBoxX + boxWidth - 10, laborY + 11, { align: 'right' });

          // Variance note (smaller)
          laborY += 20; // Reduced from 26
          doc.setFont('helvetica', 'normal');
          doc.setFontSize(5.5); // Reduced from 6
          doc.setTextColor(100, 100, 100);
          const varianceText = `Target: 30.00% | ${ld.laborVariance > 0 ? '+' : ''}${ld.laborVariance.toFixed(2)}% ${isOverBudget ? 'over' : 'under'}`;
          doc.text(varianceText, rightBoxX + boxWidth / 2, laborY, { align: 'center' });

        } else {
          doc.setTextColor(150, 150, 150);
          doc.text('Labor data not available', rightBoxX + boxWidth / 2, currentY + 40, { align: 'center' });
          doc.setFont('helvetica', 'normal');
          doc.setFontSize(5.5);
          doc.text('Calculate tip pool first', rightBoxX + boxWidth / 2, currentY + 48, { align: 'center' });
        }

        // Move currentY past the boxes
        currentY += boxHeight + 8; // Further reduced spacing to prevent page overflow
      }

      // Add developer credit - centered, bold, black, positioned near bottom of page
      const footerY = pageHeight - 18; // Position near bottom (18pt from edge to prevent cutoff)
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(8);
      doc.setTextColor(0, 0, 0); // Black
      const creditText = 'Report Generation App designed and coded by Demetri Gregorakis';
      const emailText = 'demetri_gregorakis@icloud.com for troubleshooting';

      const creditWidth = doc.getTextWidth(creditText);
      const emailWidth = doc.getTextWidth(emailText);
      const centerXCredit = (pageWidth - creditWidth) / 2;
      const centerXEmail = (pageWidth - emailWidth) / 2;

      doc.text(creditText, centerXCredit, footerY);
      doc.setFont('helvetica', 'normal');
      doc.setFontSize(7);
      doc.text(emailText, centerXEmail, footerY + 8); // Reduced spacing from 12 to 8
      
      // Add payday sign off sheet as page 2
      generatePaydaySignOffPage(doc, startDate, endDate);

      // Return PDF data for potential merging, or save directly if no attachments
      // Use actual form dates for filename (not CSV parsed dates which may be off by 1 day)
      const dateStr = `${startDate}_to_${endDate}`.replace(/-/g, '_');
      const filename = `Combined_Weekly_Report_${dateStr}.pdf`;
      
      return {
        doc: doc,
        filename: filename,
        pdfBytes: doc.output('arraybuffer')
      };
      
    } catch (error) {
      console.error('Combined PDF generation error:', error);
      throw error;
    }
  }

  // Save ALL Weekly Combined Report Data to Database
  async function saveWeeklyCombinedReportData(startDate, endDate, cashData, realEnvelopeAmount, cashboxTotal, cashReportHtml = null, tipPoolHtml = null) {
    try {
      if (!supabase) {
        console.log('Supabase not available - skipping data save');
        return;
      }

      // Prepare comprehensive report data
      const reportData = {
        // Report metadata
        week_start_date: startDate,
        week_end_date: endDate,
        generated_by: tipPoolSummary.calculatedByName || 'Unknown',
        generated_at: new Date().toISOString(),
        real_envelope_amount: realEnvelopeAmount,
        cashbox_total: cashboxTotal,
        
        // Tip Pool Summary Data
        total_toast_sales: tipPoolSummary.toastSalesReported || 0,
        actual_cash_in: tipPoolSummary.actualCashIn || 0,
        total_discrepancy: tipPoolSummary.totalDiscrepancy || 0,
        envelope_deposits: tipPoolSummary.envelopeDeposits || 0,
        credit_tips: tipPoolSummary.creditTips || 0,
        cash_tips: tipPoolSummary.cashTips || 0,
        ezcater_tips: tipPoolSummary.ezcaterTips || 0,
        total_tips: tipPoolSummary.totalTips || 0,
        tds_driver_tips: tipPoolSummary.tdsDriverTips || 0,
        tip_pool_total: tipPoolSummary.tipPoolTotal || 0,
        hourly_rate: tipPoolSummary.hourlyRate || 0,
        cash_needed: tipPoolSummary.cashNeeded || 0,
        
        // Additional tip pool fields
        calculated_cash_tips: tipPoolSummary.calculatedCashTips || 0,
        total_weighted_hours: tipPoolSummary.totalWeightedHours || 0,
        total_hours_worked: tipPoolSummary.totalHoursWorked || 0,
        
        // Employee data as JSON
        employee_tip_data: JSON.stringify(tipPoolRecords || []),
        
        // Daily cash breakdown as JSON
        daily_cash_breakdown: JSON.stringify(cashData || []),
        
        // System metadata
        report_version: '3.0',
        has_attachments: false, // Will be updated if attachments exist
        
        // Store the generated HTML content for easy retrieval
        generated_cash_report_html: cashReportHtml,
        generated_tip_pool_html: tipPoolHtml
      };

      // Save main report data
      const { data: savedReport, error: reportError } = await supabase
        .from('weekly_combined_reports')
        .insert([reportData])
        .select()
        .single();

      if (reportError) {
        console.error('Error saving weekly report:', reportError);
        throw reportError;
      }

      console.log('Weekly combined report data saved successfully:', savedReport.id);
      
      // Save individual employee records for easier querying
      if (tipPoolRecords && tipPoolRecords.length > 0) {
        const employeeRecords = tipPoolRecords.map(employee => ({
          weekly_report_id: savedReport.id,
          week_start_date: startDate,
          week_end_date: endDate,
          employee_first_name: employee.first,
          employee_last_name: employee.last,
          hours_worked: employee.hours,
          regular_hours: employee.regularHours || 0,
          overtime_hours: employee.overtimeHours || 0,
          equity_percentage: employee.equity,
          weighted_hours: employee.weighted,
          tips_due: employee.due,
          created_at: new Date().toISOString()
        }));

        const { error: employeeError } = await supabase
          .from('weekly_employee_tips')
          .insert(employeeRecords);

        if (employeeError) {
          console.error('Error saving employee tip records:', employeeError);
          // Don't throw here - main report is saved
        } else {
          console.log(`Saved ${employeeRecords.length} employee tip records`);
        }
      }

      // Save daily cash breakdown records
      if (cashData && cashData.length > 0) {
        console.log('Preparing daily breakdown records from cashData:', cashData);
        
        // Filter to only include days with meaningful PM data
        const validDays = cashData.filter(day => 
          day.pm_total && day.pm_total > 0 && 
          day.pm_toast_sales && day.pm_toast_sales > 0
        );
        
        console.log(`Filtered to ${validDays.length} days with valid PM data out of ${cashData.length} total days`);
        
        const dailyRecords = validDays.map(day => {
          console.log('Processing day:', day);
          return {
            weekly_report_id: savedReport.id,
            date: day.date,
            night_counter: day.pm_counter || day.night_counter_name || 'Unknown',
            toast_sales: parseFloat(day.pm_toast_sales) || 0,
            actual_cash_in: parseFloat(day.pm_total) || 0,
            discrepancy: parseFloat(day.pm_discrepancy) || 0,
            excess: parseFloat(day.pm_drawer_over_amount) || 0,
            created_at: new Date().toISOString()
          };
        });
        
        console.log('Final daily records to insert:', dailyRecords);

        const { error: dailyError } = await supabase
          .from('weekly_daily_breakdown')
          .insert(dailyRecords);

        if (dailyError) {
          console.error('Error saving daily breakdown records:', dailyError);
          // Don't throw here - main report is saved
        } else {
          console.log(`Saved ${dailyRecords.length} daily breakdown records`);
        }
      }

      return savedReport.id;

    } catch (error) {
      console.error('Error saving weekly combined report data:', error);
      throw error;
    }
  }

  // Generate Payday Sign Off Sheet as PDF page
  function generatePaydaySignOffPage(doc, startDate, endDate) {
    try {
      // Add new page for payday sign off
      doc.addPage();
      
      const pageWidth = doc.internal.pageSize.getWidth();
      const margin = 40;
      let currentY = margin;
      
      // Header
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(18);
      doc.setTextColor(0, 0, 0);
      doc.text('JAYNA GYRO EMPLOYEE TIP OUT ACKNOWLEDGEMENT', margin, currentY + 15);
      
      // Week of section
      currentY += 35;
      doc.setFontSize(13);
      doc.text('WEEK OF', margin, currentY);
      doc.setFont('helvetica', 'normal');
      const weekRange = `${startDate.toUpperCase()} - ${endDate.toUpperCase()}`;
      doc.text(weekRange, margin + 80, currentY);
      
      // Disclaimer text - compressed for space
      currentY += 20;
      doc.setFontSize(7);
      doc.setFont('helvetica', 'normal');
      const disclaimerLines = [
        'As an employee, ensure accuracy in your working hours, compensation, and breaks. Please review the following:',
        '',
        'I have reviewed my hours worked and have been provided with a copy if requested.',
        'The tip amount in cash I was given is accurate and complete.',
        'All details in the timekeeping system including tip amounts, breaks, meal periods, and overtime are correct.',
        '',
        'If any information is incorrect or if I have not been provided a meal or rest break, I will document it below.',
        'It is not mandatory to note missed meal breaks if I worked less than six hours or have signed a meal break waiver.',
        'I am not required to document missed breaks if they were made available but I chose not to take them.'
      ];

      disclaimerLines.forEach((line, index) => {
        if (line !== '') {
          doc.text(line, margin, currentY + (index * 8));
        }
      });
      
      // Employee signature table
      currentY += disclaimerLines.length * 8 + 15;

      // Table headers
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(11);
      doc.text('EMPLOYEE NAME', margin, currentY);
      doc.text('EMPLOYEE SIGNATURE', margin + 250, currentY);

      // Line under headers
      currentY += 5;
      doc.line(margin, currentY, pageWidth - margin, currentY);

      // Employee rows - get from tip pool records
      currentY += 12;
      doc.setFont('helvetica', 'normal');
      doc.setFontSize(9);

      // Create employee list from tip pool records
      const employees = tipPoolRecords.map(record => ({
        first: record.first,
        last: record.last
      }));

      // Sort alphabetically by first name
      employees.sort((a, b) => a.first.localeCompare(b.first));

      employees.forEach((employee, index) => {
        const rowHeight = 22; // Reduced from 25 to 22
        const yPos = currentY + (index * rowHeight);

        // Alternating row background - aligned with text baseline
        if (index % 2 === 1) {
          doc.setFillColor(232, 240, 254); // Light blue background
          doc.rect(margin - 5, yPos - 8, pageWidth - 2 * margin + 10, rowHeight, 'F');
        }

        // Employee name
        doc.setTextColor(0, 0, 0);
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(9);
        doc.text(`${employee.first} ${employee.last}`, margin, yPos);

        // Signature line - positioned at same baseline as employee name for signing on top
        doc.setDrawColor(0, 0, 0);
        doc.line(margin + 250, yPos, pageWidth - margin - 10, yPos);
      });
      
      return doc;
      
    } catch (error) {
      console.error('Error generating payday sign off sheet:', error);
      throw error;
    }
  }

  // PDF Merging Function
  async function mergePDFsWithAttachments(mainPdfData, voidsFile = null, extrasFile = null) {
    try {
      const { PDFDocument } = PDFLib;
      
      // Create new PDF document
      const mergedPdf = await PDFDocument.create();
      
      // Add main report pages
      const mainPdf = await PDFDocument.load(mainPdfData.pdfBytes);
      const mainPages = await mergedPdf.copyPages(mainPdf, mainPdf.getPageIndices());
      mainPages.forEach((page) => mergedPdf.addPage(page));
      
      // Add Voids Log if uploaded
      if (voidsFile) {
        const voidsArrayBuffer = await voidsFile.arrayBuffer();
        const voidsPdf = await PDFDocument.load(voidsArrayBuffer);
        const voidsPages = await mergedPdf.copyPages(voidsPdf, voidsPdf.getPageIndices());
        voidsPages.forEach((page) => mergedPdf.addPage(page));
      }
      
      // Add Extras if uploaded
      if (extrasFile) {
        const extrasArrayBuffer = await extrasFile.arrayBuffer();
        const extrasPdf = await PDFDocument.load(extrasArrayBuffer);
        const extrasPages = await mergedPdf.copyPages(extrasPdf, extrasPdf.getPageIndices());
        extrasPages.forEach((page) => mergedPdf.addPage(page));
      }
      
      // Save merged PDF
      const mergedPdfBytes = await mergedPdf.save();
      const blob = new Blob([mergedPdfBytes], { type: 'application/pdf' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = mainPdfData.filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      return true;
    } catch (error) {
      console.error('PDF merging error:', error);
      throw new Error(`Failed to merge PDFs: ${error.message}`);
    }
  }

  function generateTipPoolReportHtml() {
    const { cashNeeded } = tipPoolSummary;
    
    // COPY EXACT LOGIC FROM ORIGINAL TIP POOL CALCULATOR LINE 565 (CORRECT LOGIC)
    let cashStatusText = '';
    let cashStatusClass = '';
    if (cashNeeded > 0) {
      // Need additional cash - show positive amount in red
      cashStatusText = 'NEEDED';
      cashStatusClass = 'color: #dc3545';
    } else {
      // Have surplus - show positive amount in green
      cashStatusText = 'SURPLUS';
      cashStatusClass = 'color: #28a745';
    }
    
    return `
      <div style="font-family: Arial, sans-serif; padding: 20px; background: white;">
        <div style="text-align: center; margin-bottom: 30px; border-bottom: 3px solid #1e3c72; padding-bottom: 20px;">
          <h1 style="margin: 0; color: #1e3c72; font-size: 24px;">JAYNA GYRO TIP POOL DISTRIBUTION</h1>
          <h2 style="margin: 10px 0 0 0; color: #666; font-size: 14px; font-weight: normal;">
            Period: ${tipPoolSummary.dateRange || 'Not specified'}
          </h2>
        </div>
        
        <!-- Summary Section -->
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 30px;">
          <div style="background: #f8f9fa; padding: 15px; border: 2px solid #007bff; border-radius: 0; text-align: center;">
            <h4 style="margin: 0 0 8px 0; color: #007bff; font-size: 12px;">CREDIT TIPS</h4>
            <p style="font-size: 18px; font-weight: bold; margin: 0; color: #007bff;">$${tipPoolSummary.creditTips.toFixed(2)}</p>
          </div>
          
          <div style="background: #f8f9fa; padding: 15px; border: 2px solid #28a745; border-radius: 0; text-align: center;">
            <h4 style="margin: 0 0 8px 0; color: #28a745; font-size: 12px;">CASH TIPS</h4>
            <p style="font-size: 18px; font-weight: bold; margin: 0; color: #28a745;">$${tipPoolSummary.cashTips.toFixed(2)}</p>
          </div>
          
          <div style="background: #f8f9fa; padding: 15px; border: 2px solid #f57c00; border-radius: 0; text-align: center;">
            <h4 style="margin: 0 0 8px 0; color: #f57c00; font-size: 12px;">EZCATER TIPS</h4>
            <p style="font-size: 18px; font-weight: bold; margin: 0; color: #f57c00;">$${tipPoolSummary.ezcaterTips.toFixed(2)}</p>
          </div>
        </div>
        
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 30px;">
          <div style="background: #f8f9fa; padding: 15px; border: 2px solid #1e3c72; border-radius: 0; text-align: center;">
            <h4 style="margin: 0 0 8px 0; color: #1e3c72; font-size: 12px;">TOTAL POOL</h4>
            <p style="font-size: 20px; font-weight: bold; margin: 0; color: #1e3c72;">$${tipPoolSummary.pool.toFixed(2)}</p>
          </div>
          
          <div style="background: #f8f9fa; padding: 15px; border: 2px solid #6c757d; border-radius: 0; text-align: center;">
            <h4 style="margin: 0 0 8px 0; color: #6c757d; font-size: 12px;">HOURLY RATE</h4>
            <p style="font-size: 18px; font-weight: bold; margin: 0; color: #6c757d;">$${tipPoolSummary.hourlyRate.toFixed(2)}</p>
          </div>
          
          <div style="background: #f8f9fa; padding: 15px; border: 2px solid ${cashNeeded > 0 ? '#dc3545' : '#28a745'}; border-radius: 0; text-align: center;">
            <h4 style="margin: 0 0 8px 0; ${cashStatusClass}; font-size: 12px;">CASH ${cashStatusText}</h4>
            <p style="font-size: 18px; font-weight: bold; margin: 0; ${cashStatusClass};">$${Math.abs(cashNeeded).toFixed(2)}</p>
          </div>
        </div>
        
        <!-- Employee Distribution Table -->
        <div style="margin-bottom: 30px;">
          <h3 style="color: #1e3c72; margin-bottom: 15px; border-bottom: 2px solid #1e3c72; padding-bottom: 5px;">
            EMPLOYEE TIP DISTRIBUTION
          </h3>
          
          <table style="width: 100%; border-collapse: collapse; border: 2px solid #000;">
            <thead>
              <tr style="background: #1e3c72; color: white;">
                <th style="padding: 12px; text-align: left; border: 1px solid #000; font-size: 12px;">EMPLOYEE</th>
                <th style="padding: 12px; text-align: center; border: 1px solid #000; font-size: 12px;">HOURS</th>
                <th style="padding: 12px; text-align: center; border: 1px solid #000; font-size: 12px;">EQUITY</th>
                <th style="padding: 12px; text-align: center; border: 1px solid #000; font-size: 12px;">WEIGHTED HOURS</th>
                <th style="padding: 12px; text-align: center; border: 1px solid #000; font-size: 12px;">TIPS DUE</th>
              </tr>
            </thead>
            <tbody>
    `;
    
    tipPoolRecords.forEach((record, index) => {
      const rowBg = index % 2 === 0 ? '#f8f9fa' : 'white';
      return `
        <tr style="background: ${rowBg};">
          <td style="padding: 10px; border: 1px solid #000; font-weight: bold;">${record.first} ${record.last}</td>
          <td style="padding: 10px; text-align: center; border: 1px solid #000;">${record.hours.toFixed(1)}</td>
          <td style="padding: 10px; text-align: center; border: 1px solid #000;">${record.equity.toFixed(2)}</td>
          <td style="padding: 10px; text-align: center; border: 1px solid #000;">${record.weighted.toFixed(1)}</td>
          <td style="padding: 10px; text-align: center; border: 1px solid #000; font-weight: bold; color: #28a745; font-size: 16px;">$${record.due.toFixed(2)}</td>
        </tr>
      `;
    }).join('') + `
            </tbody>
          </table>
        </div>
        
        <!-- Footer -->
        <div style="text-align: center; margin-top: 30px; padding-top: 20px; border-top: 2px solid #ddd; color: #666; font-size: 12px;">
          <p style="margin: 0;">Tips calculated by: <strong>${tipPoolSummary.calculatedByName}</strong></p>
          <p style="margin: 5px 0 0 0;">Generated: ${tipPoolSummary.generatedAt}</p>
          <p style="margin: 5px 0 0 0;">Jayna Gyro Cash Counter & Tip Pool System v2.86</p>
        </div>
      </div>
    `;
  }

  async function generateCombinedReport() {
    const startDate = document.getElementById('combinedStartDate').value;
    const endDate = document.getElementById('combinedEndDate').value;
    const realEnvelopeAmount = parseFloat(document.getElementById('combinedRealEnvelope').value) || null;

    console.log('generateCombinedReport called with auto-populated data:', { startDate, endDate, realEnvelopeAmount });

    if (!startDate || !endDate) {
      showErrorMessage('Please select both start and end dates for the cash report period.');
      return;
    }

    if (!tipPoolRecords || tipPoolRecords.length === 0) {
      showErrorMessage('Please calculate tip pool first before generating combined report.');
      return;
    }

    // SMART CASHBOX DATA LOOKUP
    // Priority 1: Check if cashbox fields are filled in current flow
    let cashboxData = getTipPoolCashboxData();
    let cashboxTotal = cashboxData ? cashboxData.total : null;

    console.log('📦 Cashbox data from form:', cashboxData);

    try {
      showLoading('Generating Combined Report', 'Fetching cash count data and combining with tip pool...');

      // Priority 2: If no data in form, check database for cashbox count
      if (cashboxData === null) {
        console.log('⚠️ No cashbox data in form - checking database...');

        // Calculate the Monday AFTER the week ends (endDate + 1 day)
        // Week runs Monday-Sunday, cashbox counted on Monday after
        // Example: Week 10/20-10/26 (Mon-Sun) → Cashbox counted 10/27 (Monday)
        const weekEndDate = new Date(endDate + 'T12:00:00');
        const mondayAfter = new Date(weekEndDate);
        mondayAfter.setDate(mondayAfter.getDate() + 1); // Add 1 day to Sunday = Monday
        const cashboxCountDate = mondayAfter.toISOString().split('T')[0];

        console.log(`🔍 Looking for cashbox count from ${cashboxCountDate} (Monday after ${endDate})`);

        // Query database for cashbox count from that Monday
        const { data: dbCashboxData, error: dbCashboxError } = await supabase
          .from('cashbox_counts')
          .select('*')
          .eq('date', cashboxCountDate)
          .order('created_at', { ascending: false })
          .limit(1)
          .single();

        if (dbCashboxError) {
          if (dbCashboxError.code === 'PGRST116') {
            // No data found - this is OK
            console.log('ℹ️ No cashbox count found in database for', cashboxCountDate);
          } else {
            console.error('❌ Error querying cashbox data:', dbCashboxError);
          }
        } else if (dbCashboxData) {
          console.log('✅ Found cashbox count in database:', dbCashboxData);
          cashboxTotal = dbCashboxData.total;

          // Reconstruct cashboxData object for saving logic (even though it's already in DB)
          cashboxData = {
            counter: dbCashboxData.counter,
            total: dbCashboxData.total,
            denominations: dbCashboxData.denominations,
            date: dbCashboxData.date
          };

          console.log(`💰 Using database cashbox total: $${cashboxTotal.toFixed(2)}`);
        }
      }

      // Save cashbox count to database if provided from form (not from DB)
      if (cashboxData !== null && !cashboxData.fromDatabase) {
        console.log('💾 Saving NEW cashbox count to database...');
        await saveCashboxCountFromTipPool(cashboxData);
      } else if (cashboxData === null) {
        console.log('⚠️ No cashbox count available (not in form, not in database)');
      } else {
        console.log('ℹ️ Using existing cashbox count from database (not saving duplicate)');
      }

      // Fetch cash count data for the date range (reusing existing logic)
      const start = new Date(startDate + 'T12:00:00');
      const end = new Date(endDate + 'T12:00:00');

      if (start > end) {
        throw new Error('Start date must be before end date');
      }

      const diffTime = Math.abs(end - start);
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      
      if (diffDays > 7) {
        throw new Error('Date range cannot exceed 7 days');
      }

      // Copy exact working query from generateDateRangePDF
      const { data: rangeData } = await supabase
        .from('cash_counts')
        .select('*')
        .gte('date', startDate)
        .lte('date', endDate)
        .not('pm_total', 'is', null)
        .order('date', { ascending: true });

      if (!rangeData || rangeData.length === 0) {
        throw new Error('No cash count data found for this date range');
      }

      // Store cash data for potential re-generation
      window.lastCombinedCashData = rangeData;
      
      // Save combined report data for persistence
      saveCombinedReportData();

      // Generate the HTML content first
      const cashReportHtml = generateDateRangeReportHtml(startDate, endDate, rangeData, realEnvelopeAmount);
      
      // Get tip pool HTML and clean ONLY for saving (don't modify the original DOM)
      let tipPoolHtml = document.getElementById('tipPoolResults').innerHTML;
      
      // Create a clean copy for saving without affecting the live DOM
      let cleanTipPoolHtml = tipPoolHtml;
      cleanTipPoolHtml = cleanTipPoolHtml.replace(/<div[^>]*id="combinedReportSection"[^>]*>.*?<\/div>/gs, '');
      cleanTipPoolHtml = cleanTipPoolHtml.replace(/Weekly Combined Report[\s\S]*?Generate Combined Weekly Report/g, '');
      cleanTipPoolHtml = cleanTipPoolHtml.replace(/Download PDF Back to Menu/g, '');
      
      // SAVE TIP VARIANCE TO DATABASE (for compliance tracking)
      if (tipPoolRecords && tipPoolRecords.length > 0) {
        try {
          // Recalculate variance based on FINAL tip distribution (after any equity adjustments)
          const totalPaidOut = tipPoolRecords.reduce((sum, rec) => sum + rec.due, 0);
          const currentVariance = tipPoolSummary.pool - totalPaidOut;

          console.log(`💾 Saving final variance record for week ${startDate} to ${endDate}:`);
          console.log(`   Pool Total: $${tipPoolSummary.pool.toFixed(2)}`);
          console.log(`   Paid Out: $${totalPaidOut.toFixed(2)}`);
          console.log(`   Variance to carry forward: $${currentVariance.toFixed(2)}`);
          console.log(`   Previous variance included: $${(tipPoolSummary.previousVariance || 0).toFixed(2)}`);

          const varianceRecord = {
            week_ending_date: endDate,
            calculated_total: tipPoolSummary.pool,
            actual_paid_total: totalPaidOut,
            variance_amount: currentVariance,
            previous_variance: tipPoolSummary.previousVariance || 0,
            carried_from_date: tipPoolSummary.carriedFromDate || null
          };

          const { data: savedVariance, error: saveError } = await supabase
            .from('tip_variance')
            .upsert(varianceRecord, { onConflict: 'week_ending_date' })
            .select()
            .single();

          if (saveError) {
            console.error('❌ Error saving variance record:', saveError);
          } else {
            console.log(`✅ Variance record saved successfully!`);
            console.log(`   Record ID: ${savedVariance.id}`);
            console.log(`   Week ending: ${savedVariance.week_ending_date}`);
            console.log(`   Variance amount: $${savedVariance.variance_amount.toFixed(2)}`);
            console.log(`   This variance will be added to next week's tip pool (week after ${endDate})`);
          }
        } catch (varianceErr) {
          console.error('❌ Exception saving variance:', varianceErr);
        }
      }

      // SAVE ALL DATA TO DATABASE BEFORE PDF GENERATION
      console.log('Saving comprehensive weekly report data to database...');
      try {
        const savedReportId = await saveWeeklyCombinedReportData(startDate, endDate, rangeData, realEnvelopeAmount, cashboxTotal, cashReportHtml, cleanTipPoolHtml);
        console.log(`Weekly report data saved successfully with ID: ${savedReportId}`);
      } catch (saveError) {
        console.error('Warning: Failed to save report data to database:', saveError);
        // Don't stop PDF generation if database save fails
      }

      // Check for uploaded PDF attachments
      const voidsLogFile = document.getElementById('voidsLogUpload').files[0];
      const extrasFile = document.getElementById('extrasUpload').files[0];
      
      // Generate main PDF report
      const mainPdfData = await generateCombinedReportPDF(startDate, endDate, rangeData, realEnvelopeAmount, cashboxTotal);
      
      // If attachments exist, merge them; otherwise save main PDF directly
      if (voidsLogFile || extrasFile) {
        await mergePDFsWithAttachments(mainPdfData, voidsLogFile, extrasFile);
        
        let attachmentInfo = '';
        if (voidsLogFile && extrasFile) {
          attachmentInfo = ' (with Voids Log and Extras attached)';
        } else if (voidsLogFile) {
          attachmentInfo = ' (with Voids Log attached)';
        } else if (extrasFile) {
          attachmentInfo = ' (with Extras attached)';
        }
        
        showSuccessMessage(`Combined weekly report generated successfully${attachmentInfo}! You can modify data and generate again.`);
      } else {
        // No attachments, save main PDF directly
        mainPdfData.doc.save(mainPdfData.filename);
        showSuccessMessage('Combined weekly report generated successfully! You can modify data and generate again.');
      }
      
      hideLoading();
      
      // Return to tip pool section for easy re-editing
      showTipPool();
      
      // Return to tip pool section for easy re-editing
      showTipPool();
      
    } catch (error) {
      hideLoading();
      showErrorMessage('Error generating combined report: ' + error.message);
      console.error('Combined report generation error:', error);
    }
  }

  function generateCombinedReportHtml(startDate, endDate, cashData, realEnvelopeAmount = null) {
    // Calculate cash report totals using EXACT same logic as generateDateRangePDF
    let totalToastSalesReported = 0;
    let totalActualCashIn = 0;
    let totalDiscrepancy = 0;
    let totalEnvelopeDeposits = 0;
    let totalBackToCashbox = 0;

    cashData.forEach(day => {
      totalToastSalesReported += day.pm_toast_sales || 0;
      totalActualCashIn += (day.pm_total - day.am_total) || 0;  // Fixed: PM minus AM, not PM + AM
      totalDiscrepancy += day.pm_discrepancy || 0;              // Fixed: Use stored discrepancy
      totalEnvelopeDeposits += day.pm_deposit_amount || 0;      // Fixed: Use correct column name
      totalBackToCashbox += (day.pm_amount_to_keep - day.am_total) || 0;
    });

    const { cashNeeded } = tipPoolSummary;
    
    // COPY EXACT LOGIC FROM ORIGINAL TIP POOL CALCULATOR LINE 565 (CORRECT LOGIC)
    let cashStatusText = '';
    let cashStatusClass = '';
    if (cashNeeded > 0) {
      // Need additional cash - show positive amount in red
      cashStatusText = 'NEEDED';
      cashStatusClass = 'color: #dc3545';
    } else {
      // Have surplus - show positive amount in green
      cashStatusText = 'SURPLUS';
      cashStatusClass = 'color: #28a745';
    }

    return `
      <div style="font-family: Arial, sans-serif; padding: 20px; background: white;">
        <!-- Header matching tip pool calculator style -->
        <div style="text-align: center; margin-bottom: 30px; border-bottom: 3px solid #1e3c72; padding-bottom: 20px;">
          <h1 style="margin: 0; color: #1e3c72; font-size: 24px;">JAYNA GYRO COMBINED WEEKLY REPORT</h1>
          <h2 style="margin: 10px 0 0 0; color: #666; font-size: 16px; font-weight: normal;">CASH COUNT & TIP POOL DISTRIBUTION</h2>
          <h3 style="margin: 10px 0 0 0; color: #666; font-size: 14px; font-weight: normal;">PERIOD: ${startDate.toUpperCase()} TO ${endDate.toUpperCase()} | GENERATED: ${new Date().toLocaleString().toUpperCase()}</h3>
        </div>

        <!-- Cash Count Summary Section -->
        <div style="margin-bottom: 30px;">
          <h3 style="color: #1e3c72; margin-bottom: 15px; border-bottom: 2px solid #1e3c72; padding-bottom: 5px;">
            CASH COUNT SUMMARY
          </h3>
          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px;">
            <div style="background: #f8f9fa; padding: 15px; border: 2px solid #007bff; border-radius: 0; text-align: center;">
              <h4 style="margin: 0 0 8px 0; color: #007bff; font-size: 12px;">TOTAL TOAST SALES</h4>
              <p style="font-size: 18px; font-weight: bold; margin: 0; color: #007bff;">$${totalToastSalesReported.toFixed(2)}</p>
            </div>
            <div style="background: #f8f9fa; padding: 15px; border: 2px solid #28a745; border-radius: 0; text-align: center;">
              <h4 style="margin: 0 0 8px 0; color: #28a745; font-size: 12px;">ACTUAL CASH IN</h4>
              <p style="font-size: 18px; font-weight: bold; margin: 0; color: #28a745;">$${totalActualCashIn.toFixed(2)}</p>
            </div>
            <div style="background: #f8f9fa; padding: 15px; border: 2px solid #dc3545; border-radius: 0; text-align: center;">
              <h4 style="margin: 0 0 8px 0; color: #dc3545; font-size: 12px;">TOTAL DISCREPANCY</h4>
              <p style="font-size: 18px; font-weight: bold; margin: 0; color: #dc3545;">$${totalDiscrepancy.toFixed(2)}</p>
            </div>
          </div>
          <div style="display: grid; grid-template-columns: repeat(${realEnvelopeAmount !== null ? '3' : '2'}, 1fr); gap: 15px;">
            <div style="background: #f8f9fa; padding: 15px; border: 2px solid #6c757d; border-radius: 0; text-align: center;">
              <h4 style="margin: 0 0 8px 0; color: #6c757d; font-size: 12px;">ENVELOPE DEPOSITS</h4>
              <p style="font-size: 18px; font-weight: bold; margin: 0; color: #6c757d;">$${totalEnvelopeDeposits.toFixed(2)}</p>
            </div>
            <div style="background: #f8f9fa; padding: 15px; border: 2px solid #f57c00; border-radius: 0; text-align: center;">
              <h4 style="margin: 0 0 8px 0; color: #f57c00; font-size: 12px;">EXCESS BACK TO CASH BOX</h4>
              <p style="font-size: 18px; font-weight: bold; margin: 0; color: #f57c00;">$${totalBackToCashbox.toFixed(2)}</p>
            </div>
            ${realEnvelopeAmount !== null ? `
            <div style="background: #f8f9fa; padding: 15px; border: 2px solid #9c27b0; border-radius: 0; text-align: center;">
              <h4 style="margin: 0 0 8px 0; color: #9c27b0; font-size: 12px;">REAL ENVELOPE AMOUNT</h4>
              <p style="font-size: 18px; font-weight: bold; margin: 0; color: #9c27b0;">$${realEnvelopeAmount.toFixed(2)}</p>
            </div>
            ` : ''}
          </div>
        </div>

        <!-- Tip Pool Summary Section -->
        <div style="margin-bottom: 30px;">
          <h3 style="color: #1e3c72; margin-bottom: 15px; border-bottom: 2px solid #1e3c72; padding-bottom: 5px;">
            TIP POOL SUMMARY
          </h3>
          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px;">
            <div style="background: #f8f9fa; padding: 15px; border: 2px solid #007bff; border-radius: 0; text-align: center;">
              <h4 style="margin: 0 0 8px 0; color: #007bff; font-size: 12px;">CREDIT TIPS</h4>
              <p style="font-size: 18px; font-weight: bold; margin: 0; color: #007bff;">$${tipPoolSummary.creditTips.toFixed(2)}</p>
            </div>
            <div style="background: #f8f9fa; padding: 15px; border: 2px solid #28a745; border-radius: 0; text-align: center;">
              <h4 style="margin: 0 0 8px 0; color: #28a745; font-size: 12px;">CASH TIPS</h4>
              <p style="font-size: 18px; font-weight: bold; margin: 0; color: #28a745;">$${tipPoolSummary.cashTips.toFixed(2)}</p>
            </div>
            <div style="background: #f8f9fa; padding: 15px; border: 2px solid #f57c00; border-radius: 0; text-align: center;">
              <h4 style="margin: 0 0 8px 0; color: #f57c00; font-size: 12px;">EZCATER TIPS</h4>
              <p style="font-size: 18px; font-weight: bold; margin: 0; color: #f57c00;">$${tipPoolSummary.ezcaterTips.toFixed(2)}</p>
            </div>
          </div>
          <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px;">
            <div style="background: #f8f9fa; padding: 15px; border: 2px solid #e91e63; border-radius: 0; text-align: center;">
              <h4 style="margin: 0 0 8px 0; color: #e91e63; font-size: 12px;">TDS DRIVER</h4>
              <p style="font-size: 18px; font-weight: bold; margin: 0; color: #e91e63;">$${tipPoolSummary.tdsDriverTips.toFixed(2)}</p>
            </div>
            <div style="background: #f8f9fa; padding: 15px; border: 2px solid #17a2b8; border-radius: 0; text-align: center;">
              <h4 style="margin: 0 0 8px 0; color: #17a2b8; font-size: 12px;">CASH SALES</h4>
              <p style="font-size: 18px; font-weight: bold; margin: 0; color: #17a2b8;">$${tipPoolSummary.toastCashSales.toFixed(2)}</p>
            </div>
            <div style="background: #f8f9fa; padding: 15px; border: 2px solid #1e3c72; border-radius: 0; text-align: center;">
              <h4 style="margin: 0 0 8px 0; color: #1e3c72; font-size: 12px;">TOTAL POOL</h4>
              <p style="font-size: 20px; font-weight: bold; margin: 0; color: #1e3c72;">$${tipPoolSummary.pool.toFixed(2)}</p>
            </div>
            <div style="background: #f8f9fa; padding: 15px; border: 2px solid #6c757d; border-radius: 0; text-align: center;">
              <h4 style="margin: 0 0 8px 0; color: #6c757d; font-size: 12px;">HOURLY RATE</h4>
              <p style="font-size: 18px; font-weight: bold; margin: 0; color: #6c757d;">$${tipPoolSummary.hourlyRate.toFixed(2)}</p>
            </div>
          </div>
        </div>

        <!-- Cash Status Line (prominent display matching tip pool calculator) -->
        <div style="text-align: center; margin-bottom: 30px; background: #f8f9fa; padding: 15px; border: 2px solid ${cashNeeded > 0 ? '#dc3545' : '#28a745'}; border-radius: 0;">
          <h4 style="margin: 0 0 8px 0; ${cashStatusClass}; font-size: 14px; font-weight: bold;">
            ${cashNeeded > 0 ? 'CASH NEEDED TO PAY OUT TIPS' : 'ZERO CASH NEEDED TO PAY OUT TIPS THIS WEEK. EXCESS CASH ON HAND'}
          </h4>
          <p style="font-size: 24px; font-weight: bold; margin: 0; ${cashStatusClass};">$${Math.abs(cashNeeded).toFixed(2)}</p>
        </div>

        <!-- Employee Distribution Table -->
        <div style="margin-bottom: 30px;">
          <h3 style="color: #1e3c72; margin-bottom: 15px; border-bottom: 2px solid #1e3c72; padding-bottom: 5px;">
            EMPLOYEE TIP DISTRIBUTION
          </h3>
          <table style="width: 100%; border-collapse: collapse; border: 2px solid #000;">
            <thead>
              <tr style="background: #1e3c72; color: white;">
                <th style="padding: 12px; text-align: left; border: 1px solid #000; font-size: 12px;">EMPLOYEE</th>
                <th style="padding: 12px; text-align: center; border: 1px solid #000; font-size: 12px;">HOURS</th>
                <th style="padding: 12px; text-align: center; border: 1px solid #000; font-size: 12px;">EQUITY (%)</th>
                <th style="padding: 12px; text-align: center; border: 1px solid #000; font-size: 12px;">WEIGHTED</th>
                <th style="padding: 12px; text-align: center; border: 1px solid #000; font-size: 12px;">DUE</th>
              </tr>
            </thead>
            <tbody>
              ${tipPoolRecords.map((record, index) => {
                const rowBg = index % 2 === 0 ? '#f8f9fa' : 'white';
                return `
                  <tr style="background: ${rowBg};">
                    <td style="padding: 10px; border: 1px solid #000; font-weight: bold; font-size: 11px;">${record.first.toUpperCase()} ${record.last.toUpperCase()}</td>
                    <td style="padding: 10px; text-align: center; border: 1px solid #000; font-size: 11px;">${record.hours.toFixed(1)}</td>
                    <td style="padding: 10px; text-align: center; border: 1px solid #000; font-size: 11px;">${(record.equity * 100).toFixed(0)}</td>
                    <td style="padding: 10px; text-align: center; border: 1px solid #000; font-size: 11px;">${record.weighted.toFixed(1)}</td>
                    <td style="padding: 10px; text-align: center; border: 1px solid #000; font-weight: bold; font-size: 14px; color: #28a745;">$${record.due.toFixed(2)}</td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        </div>

        <!-- Daily Cash Breakdown -->
        <div style="border: 2px solid #000; margin: 30px 0; border-radius: 0; overflow: hidden;">
          <div style="background: #f0f0f0; padding: 10px; border-bottom: 2px solid #000;">
            <h4 style="margin: 0; text-align: center; font-size: 14px; color: #1e3c72;">DAILY CASH BREAKDOWN</h4>
          </div>
          
          <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
              <thead>
                <tr style="background: #f8f9fa;">
                  <th style="border: 1px solid #000; padding: 8px; text-align: left; font-weight: bold;">Date</th>
                  <th style="border: 1px solid #000; padding: 8px; text-align: center; font-weight: bold;">Counter</th>
                  <th style="border: 1px solid #000; padding: 8px; text-align: right; font-weight: bold;">Toast Sales</th>
                  <th style="border: 1px solid #000; padding: 8px; text-align: right; font-weight: bold;">Actual Cash In</th>
                  <th style="border: 1px solid #000; padding: 8px; text-align: right; font-weight: bold;">Discrepancy</th>
                  <th style="border: 1px solid #000; padding: 8px; text-align: right; font-weight: bold;">Envelope</th>
                  <th style="border: 1px solid #000; padding: 8px; text-align: right; font-weight: bold;">Cashbox</th>
                </tr>
              </thead>
              <tbody>
                ${cashData.map(day => {
                  const actualCashIn = day.pm_total - day.am_total;
                  const discrepancySign = day.pm_discrepancy >= 0 ? '+' : '';
                  return `
                    <tr>
                      <td style="border: 1px solid #000; padding: 6px; font-weight: bold;">
                        ${new Date(day.date + 'T12:00:00').toLocaleDateString()}
                      </td>
                      <td style="border: 1px solid #000; padding: 6px; text-align: center;">
                        ${day.pm_counter || 'N/A'}
                      </td>
                      <td style="border: 1px solid #000; padding: 6px; text-align: right;">
                        $${(day.pm_toast_sales || 0).toFixed(2)}
                      </td>
                      <td style="border: 1px solid #000; padding: 6px; text-align: right;">
                        $${actualCashIn.toFixed(2)}
                      </td>
                      <td style="border: 1px solid #000; padding: 6px; text-align: right; color: ${day.pm_discrepancy >= 0 ? '#28a745' : '#dc3545'};">
                        ${discrepancySign}$${Math.abs(day.pm_discrepancy || 0).toFixed(2)}
                      </td>
                      <td style="border: 1px solid #000; padding: 6px; text-align: right;">
                        $${day.pm_deposit_amount || 0}
                      </td>
                      <td style="border: 1px solid #000; padding: 6px; text-align: right;">
                        $${(day.pm_amount_to_keep || 0).toFixed(2)}
                      </td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          </div>
        </div>

        <!-- Footer -->
        <div style="text-align: center; margin-top: 30px; padding: 15px; border-top: 2px solid #1e3c72; font-size: 10px; background: #f8f9fa;">
          <div style="margin-bottom: 5px; font-weight: bold; color: #1e3c72;">Cash counts verified and tips calculated by: ${tipPoolSummary.ranBy || 'SYSTEM'}</div>
          <div style="margin-bottom: 5px; color: #666;">Generated: ${new Date().toLocaleString()}</div>
          <div style="color: #1e3c72; font-weight: bold;">Jayna Gyro Combined Weekly Report System v2.86</div>
        </div>
      </div>
    `;
  }


</script>

<script src="./app-header.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    // Initialize Supabase first
    initializeSupabase();

    // Render header with live stats
    renderAppHeader({ currentPage: 'tippool', showLiveStats: true });

    // CRITICAL: Make form visible by adding .active class
    document.getElementById('tipPoolForm').classList.add('active');
  });
</script>

</body>
</html>
