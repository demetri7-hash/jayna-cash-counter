<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, viewport-fit=cover">
  <title>Jayna Catering Management</title>

  <link rel="apple-touch-icon" href="https://static.spotapps.co/website_images/ab_websites/229800_website_v1/logo.png">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#00A8E1">

  <style>
    /* Jayna Brand Design - Sky Blue & Grayscale (Matching index.html) */
    :root {
      --primary-blue: #00A8E1;
      --secondary-blue: #0094D6;
      --light-blue: #E3F4FC;
      --accent-blue: #0081C6;
      --gray-900: #212121;
      --gray-700: #424242;
      --gray-600: #616161;
      --gray-500: #757575;
      --gray-400: #BDBDBD;
      --gray-300: #E0E0E0;
      --gray-100: #F5F5F5;
      --success: #00C853;
      --warning: #FFB300;
      --error: #D32F2F;
      --white: #FFFFFF;
      --blue-bg: #dbeafe;
      --blue-text: #1e40af;
      --success-bg: #d1fae5;
      --success-text: #065f46;
      --success-border: #059669;
      --warning-bg: #fef3c7;
      --warning-text: #92400e;
      --warning-border: #f59e0b;
      --error-bg: #fee2e2;
      --error-text: #991b1b;
      --error-border: #dc2626;
    }

    /* Pen Icon Edit Button */
    .modal-edit-icon {
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s ease;
    }
    .modal-edit-icon:hover {
      background: var(--gray-200);
    }
    .modal-edit-icon svg {
      width: 18px;
      height: 18px;
      fill: var(--gray-700);
    }

    /* Animations */
    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.1); opacity: 0.8; }
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body {
      font-family: 'Aptos', 'Segoe UI Variable', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      background: var(--white);
      min-height: 100vh;
      padding: 0;
      overflow-x: hidden;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
      background: var(--white);
      border-radius: 0;
      overflow: visible;
      box-shadow: none;
      min-height: auto;
      max-height: none;
    }
    .header {
      background: var(--white);
      color: var(--gray-900);
      text-align: center;
      padding: 12px;
      border-radius: 0;
      border-bottom: 1px solid var(--gray-300);
    }
    .header h1 { font-size: 18px; font-weight: 700; margin-bottom: 2px; letter-spacing: 1.5px; text-transform: uppercase; }
    .header p { opacity: 0.7; font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }

    .content {
      padding: 12px;
      max-height: none;
      overflow: visible;
    }

    /* Main Menu */
    .main-menu { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-bottom: 12px; }

    @media (max-width: 768px) {
      .main-menu { grid-template-columns: 1fr 1fr; gap: 12px; }
    }

    @media (max-width: 480px) {
      .main-menu { grid-template-columns: 1fr; gap: 10px; }
    }
    .menu-btn {
      padding: 16px 12px;
      border: 2px solid var(--gray-300);
      border-radius: 0;
      background: var(--gray-100);
      font-size: 11px;
      font-weight: 700;
      color: var(--gray-900);
      cursor: pointer;
      transition: all 0.15s ease;
      text-align: center;
      min-height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      text-transform: uppercase;
      letter-spacing: 1.2px;
      text-decoration: none;
    }
    .menu-btn:hover {
      background: var(--gray-300);
      color: var(--gray-900);
      border-color: var(--gray-400);
      transform: translateY(-1px);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
    }
    .menu-btn.primary {
      background: var(--white);
      color: var(--gray-700);
      border-color: var(--gray-300);
    }
    .menu-btn.primary:hover {
      background: var(--gray-100);
      border-color: var(--gray-400);
    }

    /* Navigation Links */
    .secondary-links {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: center;
      margin-bottom: 20px;
      font-size: 11px;
    }
    .secondary-links a {
      color: var(--gray-700);
      text-decoration: underline;
      cursor: pointer;
      transition: color 0.15s ease;
    }
    .secondary-links a:hover { color: var(--gray-900); }

    /* Tab Navigation */
    .tab-navigation {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      border-bottom: 2px solid var(--gray-300);
      padding-bottom: 0;
    }
    .tab-btn {
      padding: 12px 20px;
      background: var(--gray-100);
      color: var(--gray-700);
      border: none;
      border-bottom: 3px solid transparent;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1.2px;
      cursor: pointer;
      transition: all 0.15s ease;
      flex: 1;
    }
    .tab-btn:hover {
      background: var(--gray-200);
      color: var(--gray-900);
    }
    .tab-btn.active {
      background: var(--white);
      color: var(--gray-900);
      border-bottom-color: var(--primary-blue);
    }

    /* Tab Content */
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }

    /* Order Cards */
    .date-group {
      margin-bottom: 32px;
    }
    .date-group-header {
      font-size: 14px;
      font-weight: 700;
      color: var(--gray-900);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 2px solid var(--gray-300);
    }
    .date-group-header.today {
      color: var(--primary-blue);
      border-bottom-color: var(--primary-blue);
    }
    .date-group-header.tomorrow {
      color: var(--warning);
      border-bottom-color: var(--warning);
    }

    .order-card {
      background: var(--white);
      border: 2px solid var(--gray-300);
      padding: 16px;
      margin-bottom: 12px;
      cursor: pointer;
      transition: all 0.15s ease;
    }
    .order-card:hover {
      border-color: var(--gray-400);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
      transform: translateY(-1px);
    }
    .order-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
      gap: 12px;
    }
    .order-number {
      font-size: 16px;
      font-weight: 700;
      color: var(--gray-900);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .order-source {
      font-size: 9px;
      color: var(--gray-500);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-top: 4px;
    }
    .order-status {
      padding: 4px 10px;
      border-radius: 0;
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      white-space: nowrap;
    }
    .status-confirmed { background: var(--success-bg); color: var(--success-text); }
    .status-pending { background: var(--warning-bg); color: var(--warning-text); }
    .status-cancelled { background: var(--error-bg); color: var(--error-text); }
    .status-delivered { background: var(--blue-bg); color: var(--blue-text); }
    .status-completed { background: var(--blue-bg); color: var(--blue-text); }

    .order-details {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-bottom: 12px;
      font-size: 13px;
    }
    .detail-item {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .detail-label {
      font-size: 10px;
      font-weight: 700;
      color: var(--gray-600);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .detail-value {
      font-size: 13px;
      color: var(--gray-900);
      font-weight: 600;
    }

    .order-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-top: 12px;
      border-top: 1px solid var(--gray-200);
    }
    .order-total {
      font-size: 18px;
      font-weight: 700;
      color: var(--gray-900);
    }
    .order-time {
      font-size: 12px;
      color: var(--gray-600);
      font-weight: 600;
    }

    /* Loading & Empty States */
    .loading-spinner {
      text-align: center;
      padding: 60px 20px;
    }
    .spinner {
      border: 3px solid var(--gray-300);
      border-top: 3px solid var(--primary-blue);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .loading-text {
      font-size: 14px;
      color: var(--gray-600);
      font-weight: 600;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
    }
    .empty-icon {
      font-size: 64px;
      margin-bottom: 16px;
    }
    .empty-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--gray-900);
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .empty-message {
      font-size: 14px;
      color: var(--gray-600);
    }

    /* Error Display */
    .error-message {
      background: var(--error-bg);
      border: 2px solid var(--error-border);
      padding: 16px;
      margin-bottom: 20px;
      color: var(--error-text);
      font-size: 13px;
      font-weight: 600;
    }

    /* Refresh Button */
    .refresh-btn {
      padding: 12px 24px;
      background: var(--gray-900);
      color: white;
      border: 2px solid var(--gray-900);
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1.2px;
      cursor: pointer;
      transition: all 0.15s ease;
      margin-bottom: 20px;
    }
    .refresh-btn:hover {
      background: #000;
    }

    /* Mobile Responsive */
    @media (max-width: 600px) {
      .order-details {
        grid-template-columns: 1fr;
      }
      .tab-btn {
        padding: 10px 12px;
        font-size: 10px;
      }
    }

    /* Photo Gallery Styles */
    .photo-date-group {
      margin-bottom: 28px;
    }
    .photo-date-header {
      font-size: 13px;
      font-weight: 700;
      color: var(--gray-900);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 12px;
      padding: 10px 12px;
      background: var(--gray-100);
      border: 2px solid var(--gray-300);
    }
    .photo-thumbnails-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 12px;
    }
    .photo-item {
      position: relative;
      background: white;
      border: 2px solid var(--gray-300);
      padding: 8px;
      cursor: default;
      transition: all 0.2s ease;
    }
    .photo-item:hover {
      border-color: var(--gray-400);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }
    .photo-img {
      width: 100%;
      height: 200px;
      display: block;
      object-fit: cover;
      transition: filter 0.3s ease;
      cursor: pointer;
    }
    .photo-img:hover {
      opacity: 0.9;
    }
    .photo-metadata {
      padding: 8px 0 0 0;
      font-size: 11px;
      color: var(--gray-700);
      border-top: 1px solid var(--gray-200);
      margin-top: 8px;
    }
    .photo-metadata-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 4px;
    }
    .photo-metadata-label {
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--gray-600);
    }
    .photo-metadata-value {
      font-weight: 600;
      color: var(--gray-900);
    }
    .photo-overlay {
      position: absolute;
      top: 16px;
      right: 16px;
      background: rgba(220, 38, 38, 0.9);
      color: white;
      padding: 10px 14px;
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      cursor: pointer;
      border-radius: 4px;
      transition: all 0.15s ease;
      z-index: 10;
      display: none; /* Hidden by default */
      border: 2px solid white;
    }
    .photo-overlay.visible {
      display: block;
    }
    .photo-overlay:hover {
      background: rgba(185, 28, 28, 1);
      transform: scale(1.1);
      box-shadow: 0 4px 12px rgba(220, 38, 38, 0.5);
    }

    /* Completed Button */
    .completed-btn {
      position: absolute;
      bottom: 16px;
      right: 16px;
      background: rgba(0, 200, 83, 0.9);
      color: white;
      padding: 8px 12px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      cursor: pointer;
      border-radius: 4px;
      transition: all 0.15s ease;
      z-index: 10;
      border: 2px solid white;
    }
    .completed-btn:hover {
      background: rgba(0, 150, 63, 1);
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(0, 200, 83, 0.5);
    }

    /* Reorder Arrow Buttons */
    .reorder-controls {
      position: absolute;
      top: 16px;
      left: 16px;
      display: none;
      flex-direction: column;
      gap: 8px;
      z-index: 10;
    }
    .reorder-controls.visible {
      display: flex;
    }
    .reorder-btn {
      background: rgba(0, 168, 225, 0.95);
      color: white;
      border: 2px solid white;
      padding: 10px 14px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      border-radius: 4px;
      transition: all 0.15s ease;
      min-width: 44px;
      min-height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .reorder-btn:hover {
      background: rgba(0, 148, 214, 1);
      transform: scale(1.1);
      box-shadow: 0 4px 12px rgba(0, 168, 225, 0.5);
    }
    .reorder-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    /* Image Enhancement Controls */
    .enhancement-controls {
      background: var(--gray-100);
      border-top: 2px solid var(--gray-300);
      padding: 12px;
      margin-top: 8px;
      display: none;
    }
    .enhancement-controls.visible {
      display: block;
    }
    .enhancement-label {
      font-size: 10px;
      font-weight: 700;
      color: var(--gray-700);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 6px;
      display: block;
    }
    .enhancement-slider {
      width: 100%;
      margin-bottom: 12px;
    }
    .filter-preset-btn {
      padding: 8px 12px;
      background: var(--primary-blue);
      color: white;
      border: 2px solid var(--primary-blue);
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      cursor: pointer;
      transition: all 0.15s ease;
      margin-right: 8px;
      margin-bottom: 8px;
    }
    .filter-preset-btn:hover {
      background: var(--secondary-blue);
      border-color: var(--secondary-blue);
    }

    /* Image Lightbox Modal */
    .lightbox-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.95);
      z-index: 100000;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
      overflow: auto;
    }
    .lightbox-modal.active {
      display: flex;
    }
    .lightbox-close {
      position: fixed;
      top: 20px;
      right: 20px;
      width: 50px;
      height: 50px;
      background: var(--error-border);
      color: white;
      border: 3px solid white;
      font-size: 24px;
      font-weight: 700;
      cursor: pointer;
      z-index: 100001;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }
    .lightbox-close:hover {
      background: #b91c1c;
      transform: scale(1.1);
    }
    .lightbox-image {
      max-width: 100%;
      max-height: 100%;
      width: auto;
      height: auto;
      display: block;
      margin: auto;
      cursor: zoom-in;
    }
    .lightbox-image.zoomed {
      max-width: none;
      max-height: none;
      width: auto;
      height: auto;
      cursor: zoom-out;
    }
  </style>

  <!-- ExcelJS library for native Excel file generation -->
  <script src="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js"></script>

  <!-- Supabase client library for database access -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <!-- Loading Overlay -->
  <div id="loadingOverlay" style="
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(33, 33, 33, 0.85);
    z-index: 9999;
    justify-content: center;
    align-items: center;
  ">
    <div style="
      text-align: center;
      background: white;
      padding: 40px 50px;
      border-radius: 0;
      border: 3px solid var(--gray-700);
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    ">
      <div class="spinner" style="
        border: 4px solid var(--gray-300);
        border-top: 4px solid var(--gray-900);
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 0.8s linear infinite;
        margin: 0 auto 24px;
      "></div>
      <h3 id="loadingTitle" style="
        font-size: 14px;
        font-weight: 700;
        margin-bottom: 8px;
        color: var(--gray-900);
        text-transform: uppercase;
        letter-spacing: 1px;
      ">Loading...</h3>
      <p id="loadingMessage" style="
        font-size: 12px;
        color: var(--gray-600);
        margin: 0;
      ">Please wait</p>
    </div>
  </div>

  <div class="container">
    <!-- App Header (Injected by app-header.js) -->
    <div id="appHeader"></div>

    <div class="content">
      <!-- Tab Navigation -->
      <div class="tab-navigation">
        <button class="tab-btn active" onclick="showTab('photos')">ORDERS</button>
        <button class="tab-btn" onclick="showTab('beta')">BETA</button>
        <button class="tab-btn" onclick="showTab('past')">PAST</button>
        <button class="tab-btn" onclick="showTab('analytics')">ANALYTICS</button>
      </div>

      <!-- ORDERS Tab (DEFAULT) -->
      <div id="photosTab" class="tab-content active">
        <!-- Collapsible Upload Form & Edit Link -->
        <div style="margin-bottom: 20px;">
          <a href="javascript:void(0)" onclick="toggleUploadForm()" style="color: var(--primary-blue); font-size: 14px; font-weight: 600; text-decoration: underline; cursor: pointer; display: inline-block;">
            <span id="uploadFormToggleText">+ Add an Order</span>
          </a>
          <span style="color: var(--gray-400); font-size: 14px; margin: 0 8px;">|</span>
          <a id="editBtn" href="javascript:void(0)" onclick="promptEditMode()" style="color: var(--primary-blue); font-size: 14px; font-weight: 600; text-decoration: none; cursor: pointer; display: inline-flex; align-items: center; gap: 4px;">
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" style="width: 16px; height: 16px; fill: var(--primary-blue);">
              <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
            </svg>
            <span style="text-decoration: underline;">Edit</span>
          </a>
        </div>

        <!-- Sync Buttons -->
        <div style="display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap;">
          <button class="refresh-btn" onclick="syncFromToast()" style="background: var(--primary-blue); border-color: var(--primary-blue);">üîÑ SYNC FROM TOAST</button>
          <button class="refresh-btn" onclick="manualImportEZCaterOrder()" style="background: #10b981; border-color: #10b981; color: white;">üì• IMPORT EZCATER ORDER</button>
        </div>

        <div id="uploadFormContainer" style="display: none; background: var(--gray-100); border: 2px solid var(--gray-300); padding: 16px; margin-bottom: 20px;">
          <h3 style="font-size: 13px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 16px; color: var(--gray-900);">UPLOAD ORDER PHOTO</h3>

          <!-- Order Type -->
          <div style="margin-bottom: 16px;">
            <label style="display: block; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; color: var(--gray-700);">ORDER TYPE *</label>
            <div style="display: flex; gap: 16px;">
              <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 13px; font-weight: 600; color: var(--gray-900);">
                <input type="radio" name="orderType" value="PICKUP" id="orderTypePickup" onchange="toggleDeliveryField()" style="width: 18px; height: 18px; cursor: pointer;">
                PICK UP
              </label>
              <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 13px; font-weight: 600; color: var(--gray-900);">
                <input type="radio" name="orderType" value="DELIVERY" id="orderTypeDelivery" onchange="toggleDeliveryField()" style="width: 18px; height: 18px; cursor: pointer;">
                DELIVERY
              </label>
            </div>
          </div>

          <!-- Order Due Date -->
          <div style="margin-bottom: 16px;">
            <label for="orderDueDate" style="display: block; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; color: var(--gray-700);">ORDER DUE *</label>
            <input type="date" id="orderDueDate" style="width: 100%; padding: 12px; border: 2px solid var(--gray-300); font-size: 14px; box-sizing: border-box;">
          </div>

          <!-- Time Due -->
          <div style="margin-bottom: 16px;">
            <label for="timeDue" style="display: block; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; color: var(--gray-700);">TIME DUE *</label>
            <input type="time" id="timeDue" style="width: 100%; padding: 12px; border: 2px solid var(--gray-300); font-size: 14px; box-sizing: border-box;">
          </div>

          <!-- Leave Jayna At (Conditional - only for DELIVERY) -->
          <div id="leaveJaynaAtContainer" style="margin-bottom: 16px; display: none;">
            <label for="leaveJaynaAt" style="display: block; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; color: var(--gray-700);">LEAVE JAYNA AT *</label>
            <input type="time" id="leaveJaynaAt" style="width: 100%; padding: 12px; border: 2px solid var(--gray-300); font-size: 14px; box-sizing: border-box;">
          </div>

          <!-- Customer Information -->
          <div style="border-top: 2px solid var(--gray-300); padding-top: 16px; margin-top: 16px; margin-bottom: 16px;">
            <h4 style="font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 16px; color: var(--gray-900);">CUSTOMER INFORMATION</h4>

            <!-- Guest Name -->
            <div style="margin-bottom: 16px;">
              <label for="guestName" style="display: block; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; color: var(--gray-700);">GUEST NAME</label>
              <input type="text" id="guestName" placeholder="Customer name" style="width: 100%; padding: 12px; border: 2px solid var(--gray-300); font-size: 14px; box-sizing: border-box;">
            </div>

            <!-- Phone Number -->
            <div style="margin-bottom: 16px;">
              <label for="phoneNumber" style="display: block; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; color: var(--gray-700);">PHONE NUMBER</label>
              <input type="tel" id="phoneNumber" placeholder="(555) 555-5555" style="width: 100%; padding: 12px; border: 2px solid var(--gray-300); font-size: 14px; box-sizing: border-box;">
            </div>

            <!-- Email -->
            <div style="margin-bottom: 16px;">
              <label for="email" style="display: block; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; color: var(--gray-700);">EMAIL</label>
              <input type="email" id="email" placeholder="customer@example.com" style="width: 100%; padding: 12px; border: 2px solid var(--gray-300); font-size: 14px; box-sizing: border-box;">
            </div>

            <!-- Delivery Address (Conditional - only for DELIVERY) -->
            <div id="deliveryAddressContainer" style="margin-bottom: 16px; display: none;">
              <label for="deliveryAddress" style="display: block; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; color: var(--gray-700);">DELIVERY ADDRESS</label>
              <textarea id="deliveryAddress" placeholder="123 Main St, Sacramento, CA 95814" rows="3" style="width: 100%; padding: 12px; border: 2px solid var(--gray-300); font-size: 14px; box-sizing: border-box; resize: vertical;"></textarea>
            </div>

            <!-- Special Notes -->
            <div style="margin-bottom: 16px;">
              <label for="specialNotes" style="display: block; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; color: var(--gray-700);">SPECIAL NOTES</label>
              <textarea id="specialNotes" placeholder="Special instructions, dietary restrictions, etc." rows="3" style="width: 100%; padding: 12px; border: 2px solid var(--gray-300); font-size: 14px; box-sizing: border-box; resize: vertical;"></textarea>
            </div>

            <!-- Actual Order (Optional) -->
            <div style="margin-bottom: 16px;">
              <label for="actualOrder" style="display: block; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; color: var(--gray-700);">ACTUAL ORDER (OPTIONAL)</label>
              <textarea id="actualOrder" placeholder="Type the actual order details here..." rows="4" style="width: 100%; padding: 12px; border: 2px solid var(--gray-300); font-size: 14px; box-sizing: border-box; resize: vertical;"></textarea>
            </div>
          </div>

          <!-- Photo Selection -->
          <input type="file" id="photoInput" accept="image/*" style="display: none;" onchange="handlePhotoSelect(event)">
          <button onclick="document.getElementById('photoInput').click()" class="refresh-btn" style="margin: 0; background: var(--primary-blue); border-color: var(--primary-blue);">
            SELECT PHOTO
          </button>
        </div>  <!-- Close uploadFormContainer -->

        <!-- Save Button (Edit Mode) -->
        <div style="margin-bottom: 20px;">
          <button id="saveBtn" onclick="saveEditMode()" class="refresh-btn" style="margin: 0; background: var(--success); border-color: var(--success); display: none;">
            ‚úÖ SAVE
          </button>
        </div>

        <div id="photoGallery">
          <!-- Photos will be loaded here grouped by date -->
        </div>
      </div>

      <!-- BETA Tab (was UPCOMING) -->
      <div id="betaTab" class="tab-content">
        <!-- Action Buttons -->
        <div style="display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap;">
          <button class="refresh-btn" onclick="loadOrdersFromDatabase()">üîÑ RELOAD FROM DATABASE</button>
          <button class="refresh-btn" onclick="syncFromToast()" style="background: var(--primary-blue); border-color: var(--primary-blue);">üîÑ SYNC FROM TOAST</button>
          <button class="refresh-btn" onclick="syncFromEZCater()" style="background: #f59e0b; border-color: #f59e0b;">üîÑ SYNC FROM EZCATER</button>
          <button class="refresh-btn" onclick="activateEZCaterWebhooks()" style="background: #dc2626; border-color: #dc2626; color: white;">üîî ACTIVATE EZCATER WEBHOOKS</button>
          <button class="refresh-btn" onclick="checkEZCaterSubscriptions()" style="background: #6366f1; border-color: #6366f1; color: white;">üîç CHECK SUBSCRIPTIONS</button>
          <button class="refresh-btn" onclick="manualImportEZCaterOrder()" style="background: #10b981; border-color: #10b981; color: white;">üì• IMPORT ORDER BY NUMBER</button>
          <button class="refresh-btn" onclick="forceSyncEZCaterOrder()" style="background: #8b5cf6; border-color: #8b5cf6; color: white;">üîÑ SYNC MODIFIED ORDER</button>
        </div>

        <div id="syncStatus" style="display: none; padding: 12px; margin-bottom: 20px; border: 2px solid; font-size: 13px; font-weight: 600;"></div>

        <div id="upcomingContent">
          <!-- Orders will be loaded here -->
        </div>
      </div>

      <!-- PAST Tab (Future Implementation) -->
      <div id="pastTab" class="tab-content">
        <div class="empty-state">
          <div class="empty-icon">üì¶</div>
          <div class="empty-title">Past Orders</div>
          <div class="empty-message">Historical order view coming soon!</div>
        </div>
      </div>

      <!-- ANALYTICS Tab (Future Implementation) -->
      <div id="analyticsTab" class="tab-content">
        <div class="empty-state">
          <div class="empty-icon">üìä</div>
          <div class="empty-title">Analytics Dashboard</div>
          <div class="empty-message">Order analytics and insights coming soon!</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    /**
     * JAYNA CATERING MANAGEMENT SYSTEM
     * Connected to Toast POS API - Filters for Catering Orders
     *
     * Catering orders have source values:
     * - "Invoice"
     * - "Catering"
     * - "Catering Online Ordering"
     */

    // ============================================
    // PACIFIC TIMEZONE UTILITIES
    // ============================================
    // CRITICAL: Device timezone settings are unreliable (tablets may be set to wrong timezone)
    // These functions ALWAYS work in America/Los_Angeles timezone regardless of device settings

    /**
     * Get current date in Pacific timezone as YYYY-MM-DD string
     */
    function getPacificToday() {
      const now = new Date();
      const formatter = new Intl.DateTimeFormat('en-CA', {
        timeZone: 'America/Los_Angeles',
        year: 'numeric',
        month: '2-digit',
        day: '2-digit'
      });
      return formatter.format(now); // Returns "YYYY-MM-DD"
    }

    /**
     * Get Pacific date + N days as YYYY-MM-DD string
     * @param {number} daysToAdd - Number of days to add (can be negative)
     */
    function getPacificDatePlusDays(daysToAdd) {
      const now = new Date();
      // Add days in milliseconds
      const futureDate = new Date(now.getTime() + (daysToAdd * 24 * 60 * 60 * 1000));
      const formatter = new Intl.DateTimeFormat('en-CA', {
        timeZone: 'America/Los_Angeles',
        year: 'numeric',
        month: '2-digit',
        day: '2-digit'
      });
      return formatter.format(futureDate); // Returns "YYYY-MM-DD"
    }

    /**
     * Format date string (YYYY-MM-DD) as Pacific time display string
     * Does NOT rely on device timezone settings
     */
    function formatPacificDate(dateStr, includeYear = true) {
      if (!dateStr) return 'N/A';

      // Parse YYYY-MM-DD
      const [year, month, day] = dateStr.split('-').map(Number);

      // Create UTC date at noon (avoids DST edge cases)
      const utcDate = new Date(Date.UTC(year, month - 1, day, 12, 0, 0));

      // Format in Pacific timezone
      const options = includeYear
        ? { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric', timeZone: 'America/Los_Angeles' }
        : { weekday: 'long', month: 'long', day: 'numeric', timeZone: 'America/Los_Angeles' };

      return new Intl.DateTimeFormat('en-US', options).format(utcDate);
    }

    /**
     * Format date string (YYYY-MM-DD) as short Pacific time string (e.g., "Oct-25-2025")
     * Does NOT rely on device timezone settings
     */
    function formatPacificDateShort(dateStr) {
      if (!dateStr) return 'N/A';

      // Parse YYYY-MM-DD
      const [year, month, day] = dateStr.split('-').map(Number);

      // Create UTC date at noon (avoids DST edge cases)
      const utcDate = new Date(Date.UTC(year, month - 1, day, 12, 0, 0));

      // Format as "Oct 25 2025" then replace spaces with dashes
      const formatted = new Intl.DateTimeFormat('en-US', {
        month: 'short',
        day: '2-digit',
        year: 'numeric',
        timeZone: 'America/Los_Angeles'
      }).format(utcDate);

      return formatted.replace(/,/g, '').replace(/\s+/g, '-');
    }

    /**
     * Format ISO datetime string as Pacific time (HH:MM AM/PM)
     */
    function formatPacificTime(isoTimeStr) {
      if (!isoTimeStr) return 'TBD';

      try {
        const date = new Date(isoTimeStr);
        return new Intl.DateTimeFormat('en-US', {
          hour: '2-digit',
          minute: '2-digit',
          hour12: true,
          timeZone: 'America/Los_Angeles'
        }).format(date);
      } catch (e) {
        console.error('Error formatting time:', e);
        return 'Invalid Time';
      }
    }

    /**
     * Format ISO datetime string as Pacific time in 24-hour format (HH:MM)
     */
    function formatPacificTime24(isoTimeStr) {
      if (!isoTimeStr) return null;

      try {
        const date = new Date(isoTimeStr);
        return new Intl.DateTimeFormat('en-US', {
          hour: '2-digit',
          minute: '2-digit',
          hour12: false,
          timeZone: 'America/Los_Angeles'
        }).format(date);
      } catch (e) {
        console.error('Error formatting time:', e);
        return null;
      }
    }

    /**
     * Compare two date strings and return if first is TODAY/TOMORROW/FUTURE
     * Comparisons done in Pacific timezone
     */
    function getDateRelation(dateStr) {
      const todayPacific = getPacificToday();

      // Calculate tomorrow in Pacific time
      const [year, month, day] = todayPacific.split('-').map(Number);
      const tomorrowDate = new Date(Date.UTC(year, month - 1, day + 1, 12, 0, 0));
      const formatter = new Intl.DateTimeFormat('en-CA', {
        timeZone: 'America/Los_Angeles',
        year: 'numeric',
        month: '2-digit',
        day: '2-digit'
      });
      const tomorrowPacific = formatter.format(tomorrowDate);

      if (dateStr === todayPacific) return 'TODAY';
      if (dateStr === tomorrowPacific) return 'TOMORROW';
      return 'FUTURE';
    }

    // ============================================
    // SUPABASE INITIALIZATION
    // ============================================
    const SUPABASE_URL = 'https://gaawtbqpnnbbnsyswqwv.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdhYXd0YnFwbm5iYm5zeXN3cXd2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1MDE1NTAsImV4cCI6MjA3MjA3NzU1MH0.F-y7AIQTWaUe7DRT4OnIZVn94mhXxfhpBbng2aJ8nXg';

    let supabase;
    function initializeSupabase() {
      supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      console.log('‚úÖ Supabase initialized');
    }

    // Initialize Supabase when script loads
    if (window.supabase) {
      initializeSupabase();
    } else {
      console.error('‚ùå Supabase library not loaded');
    }

    // ============================================
    // TOAST AUTHENTICATION
    // ============================================
    let toastAccessToken = null;

    async function authenticateToast() {
      try {
        const response = await fetch('/api/toast-auth', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          }
        });

        const data = await response.json();

        if (data.success && data.data && data.data.accessToken) {
          toastAccessToken = data.data.accessToken;
          console.log('‚úÖ Toast API authenticated successfully');
          return true;
        } else {
          console.error('‚ùå Toast authentication failed:', data.error);
          throw new Error(data.error || 'Authentication failed');
        }
      } catch (error) {
        console.error('‚ùå Toast authentication error:', error);
        throw error;
      }
    }

    // ============================================
    // TAB NAVIGATION
    // ============================================
    function showTab(tabName) {
      // Hide all tabs
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
      });

      // Show selected tab
      document.getElementById(`${tabName}Tab`).classList.add('active');
      event.target.classList.add('active');
    }

    // ============================================
    // LOAD ORDERS FROM DATABASE (FAST - DEFAULT)
    // ============================================
    async function loadOrdersFromDatabase(showLoadingSpinner = true) {
      const container = document.getElementById('upcomingContent');

      try {
        if (showLoadingSpinner) {
          showLoading('LOADING ORDERS', 'Loading catering orders from database...');
        }

        // Calculate date range (today + 90 days) in Pacific timezone to show future orders
        const startDateStr = getPacificToday();
        const endDateStr = getPacificDatePlusDays(90);

        console.log(`üìã Fetching orders from database (Pacific time): ${startDateStr} to ${endDateStr}`);

        // Call database API (no authentication needed, very fast!)
        const response = await fetch(`/api/get-catering-orders?startDate=${startDateStr}&endDate=${endDateStr}`, {
          method: 'GET'
        });

        const data = await response.json();

        if (!data.success) {
          throw new Error(data.error || 'Failed to fetch orders from database');
        }

        console.log(`‚úÖ Found ${data.data.totalOrders} orders in database`);
        console.log(`üìÖ DEBUG - Date range requested: ${startDateStr} to ${endDateStr}`);
        console.log(`üì¶ DEBUG - Orders returned:`, data.data.orders);
        if (data.data.orders && data.data.orders.length > 0) {
          data.data.orders.forEach((order, idx) => {
            console.log(`   [${idx}] Order ${order.order_number}: ${order.customer_name} | Date: ${order.delivery_date} | Time: ${order.delivery_time}`);
          });
        } else {
          console.log(`‚ùå DEBUG - NO ORDERS RETURNED FROM DATABASE!`);
        }

        // Display orders (hideLoading called in displayUpcomingOrders after render)
        displayUpcomingOrders(data.data.orders || [], showLoadingSpinner);

      } catch (error) {
        console.error('Error loading orders:', error);
        if (showLoadingSpinner) {
          hideLoading();
        }
        container.innerHTML = `
          <div class="error-message">
            ‚ùå Error loading orders from database: ${error.message}
            <br><br>
            Try syncing from Toast to refresh your orders.
          </div>
          <button class="refresh-btn" onclick="syncFromToast()">üîÑ SYNC FROM TOAST</button>
        `;
      }
    }

    // ============================================
    // SYNC FROM TOAST API (FULL REFRESH)
    // ============================================
    async function syncFromToast() {
      const container = document.getElementById('upcomingContent');
      const statusDiv = document.getElementById('syncStatus');

      try {
        showLoading('SYNCING ORDERS', 'Syncing catering orders from Toast POS...');

        // Show sync status
        statusDiv.style.display = 'block';
        statusDiv.style.background = 'var(--blue-bg)';
        statusDiv.style.borderColor = 'var(--primary-blue)';
        statusDiv.style.color = 'var(--blue-text)';
        statusDiv.textContent = 'üîÑ Syncing from Toast POS...';

        // Authenticate if needed
        if (!toastAccessToken) {
          await authenticateToast();
        }

        // Calculate date range (today + 90 days) in Pacific timezone to sync future orders
        const startDateStr = getPacificToday();
        const endDateStr = getPacificDatePlusDays(90);

        console.log(`üîÑ Syncing from Toast (Pacific time): ${startDateStr} to ${endDateStr}`);

        // Call Toast catering orders API (will save to database)
        const response = await fetch('/api/toast-catering-orders', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            accessToken: toastAccessToken,
            startDate: startDateStr,
            endDate: endDateStr
          })
        });

        const data = await response.json();

        if (!data.success) {
          throw new Error(data.error || 'Failed to sync catering orders');
        }

        console.log(`‚úÖ Synced ${data.data.totalOrders} orders from Toast`);

        // Check if database save failed
        if (data.data.savedToDatabase === false) {
          // Show warning - database table doesn't exist
          statusDiv.style.background = 'var(--warning-bg)';
          statusDiv.style.borderColor = 'var(--warning-border)';
          statusDiv.style.color = 'var(--warning-text)';
          statusDiv.innerHTML = `‚ö†Ô∏è Orders fetched but NOT saved to database!<br><br><strong>Database Error:</strong> ${data.data.databaseError || 'Unknown error'}<br><br><strong>Fix:</strong> Run /sql/create_catering_orders_table.sql in Supabase SQL Editor`;

          // Don't auto-hide this error
        } else {
          // Show success status
          statusDiv.style.background = 'var(--success-bg)';
          statusDiv.style.borderColor = 'var(--success-border)';
          statusDiv.style.color = 'var(--success-text)';
          statusDiv.textContent = `‚úÖ Successfully synced ${data.data.totalOrders} orders from Toast POS to database!`;

          // Hide status after 5 seconds
          setTimeout(() => {
            statusDiv.style.display = 'none';
          }, 5000);
        }

        // Display orders
        displayUpcomingOrders(data.data.orders || []);

      } catch (error) {
        console.error('Error syncing from Toast:', error);
        hideLoading();

        // Show error status
        statusDiv.style.display = 'block';
        statusDiv.style.background = 'var(--error-bg)';
        statusDiv.style.borderColor = 'var(--error-border)';
        statusDiv.style.color = 'var(--error-text)';
        statusDiv.textContent = `‚ùå Sync failed: ${error.message}`;

        container.innerHTML = `
          <div class="error-message">
            ‚ùå Error syncing from Toast: ${error.message}
            <br><br>
            ${error.message.includes('Authentication') || error.message.includes('401') ?
              'Toast API authentication failed. Please check your credentials.' :
              'Please try again or load from database.'}
          </div>
          <button class="refresh-btn" onclick="syncFromToast()">üîÑ TRY AGAIN</button>
          <button class="refresh-btn" onclick="loadOrdersFromDatabase()" style="background: var(--gray-700);">üìÇ LOAD FROM DATABASE</button>
        `;
      }
    }

    // ============================================
    // SYNC FROM EZCATER API (MANUAL FETCH)
    // ============================================
    async function syncFromEZCater() {
      const container = document.getElementById('upcomingContent');
      const statusDiv = document.getElementById('syncStatus');

      try {
        showLoading('SYNCING FROM EZCATER', 'Fetching recent EZCater orders...');

        // Show sync status
        statusDiv.style.display = 'block';
        statusDiv.style.background = 'var(--blue-bg)';
        statusDiv.style.borderColor = 'var(--warning-border)';
        statusDiv.style.color = 'var(--warning-text)';
        statusDiv.textContent = 'üîÑ Syncing from EZCater...';

        // Calculate date range (last 30 days to cover recent orders) in Pacific timezone
        const startDateStr = getPacificDatePlusDays(-30);
        const endDateStr = getPacificDatePlusDays(90);

        console.log(`üîÑ Syncing from EZCater (Pacific time): ${startDateStr} to ${endDateStr}`);

        // Call EZCater sync API (will fetch recent orders and save to database)
        const response = await fetch('/api/ezcater-sync-orders', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            startDate: startDateStr,
            endDate: endDateStr
          })
        });

        const data = await response.json();

        if (!data.success) {
          throw new Error(data.error || 'Failed to sync EZCater orders');
        }

        console.log(`‚úÖ Synced ${data.data.totalOrders} orders from EZCater`);

        // Show success status
        statusDiv.style.background = 'var(--success-bg)';
        statusDiv.style.borderColor = 'var(--success-border)';
        statusDiv.style.color = 'var(--success-text)';
        statusDiv.textContent = `‚úÖ Successfully synced ${data.data.totalOrders} orders from EZCater!`;

        // Hide status after 5 seconds
        setTimeout(() => {
          statusDiv.style.display = 'none';
        }, 5000);

        // Reload from database to show orders
        loadOrdersFromDatabase();

      } catch (error) {
        console.error('Error syncing from EZCater:', error);
        hideLoading();

        // Show error status
        statusDiv.style.display = 'block';
        statusDiv.style.background = 'var(--error-bg)';
        statusDiv.style.borderColor = 'var(--error-border)';
        statusDiv.style.color = 'var(--error-text)';
        statusDiv.textContent = `‚ùå Sync failed: ${error.message}`;

        container.innerHTML = `
          <div class="error-message">
            ‚ùå Error syncing from EZCater: ${error.message}
            <br><br>
            ${error.message.includes('not implemented') || error.message.includes('404') ?
              'EZCater sync endpoint needs to be created. Using webhook-only for now.' :
              'Please try again or check Vercel logs for webhook errors.'}
          </div>
          <button class="refresh-btn" onclick="syncFromEZCater()">üîÑ TRY AGAIN</button>
          <button class="refresh-btn" onclick="loadOrdersFromDatabase()" style="background: var(--gray-700);">üìÇ LOAD FROM DATABASE</button>
        `;
      }
    }

    // ============================================
    // ACTIVATE EZCATER WEBHOOKS (ONE-TIME SETUP)
    // ============================================
    async function activateEZCaterWebhooks() {
      const statusDiv = document.getElementById('syncStatus');

      try {
        showLoading('ACTIVATING WEBHOOKS', 'Setting up EZCater webhook subscriptions...');

        // Show status
        statusDiv.style.display = 'block';
        statusDiv.style.background = 'var(--warning-bg)';
        statusDiv.style.borderColor = 'var(--warning-border)';
        statusDiv.style.color = 'var(--warning-text)';
        statusDiv.textContent = 'üîî Activating EZCater webhooks...';

        console.log('üîî Activating EZCater webhook subscriptions...');

        // Call subscription setup endpoint
        const response = await fetch('/api/ezcater-subscribe', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          }
        });

        const data = await response.json();

        if (!data.success) {
          throw new Error(data.error || 'Failed to activate webhooks');
        }

        console.log('‚úÖ Webhook subscriptions activated!', data);

        // Show success status
        statusDiv.style.background = 'var(--success-bg)';
        statusDiv.style.borderColor = 'var(--success-border)';
        statusDiv.style.color = 'var(--success-text)';

        // Build subscription summary
        const totalCreated = data.subscriptions?.length || 0;
        const totalSkipped = data.skipped?.length || 0;
        const totalErrors = data.errors?.length || 0;

        let summary = '';
        if (totalCreated > 0) {
          summary += `<strong>‚úÖ Created:</strong> ${totalCreated} subscriptions<br>`;
        }
        if (totalSkipped > 0) {
          summary += `<strong>‚ÑπÔ∏è Already Existed:</strong> ${totalSkipped} subscriptions<br>`;
        }
        if (totalErrors > 0) {
          summary += `<strong>‚ùå Failed:</strong> ${totalErrors} subscriptions<br>`;
        }

        // Show coverage
        const coverage = data.coverage;
        summary += `<br><strong>Event Coverage:</strong><br>`;
        summary += `‚Ä¢ order.submitted: ${coverage?.submitted ? '‚úÖ' : '‚ùå'}<br>`;
        summary += `‚Ä¢ order.accepted: ${coverage?.accepted ? '‚úÖ' : '‚ùå'}<br>`;
        summary += `‚Ä¢ order.rejected: ${coverage?.rejected ? '‚úÖ' : '‚ùå'}<br>`;
        summary += `‚Ä¢ order.cancelled: ${coverage?.cancelled ? '‚úÖ' : '‚ùå'}`;

        statusDiv.innerHTML = `${data.message}<br><br>
          <strong>Webhook URL:</strong> ${data.webhookUrl}<br><br>
          ${summary}<br><br>
          <small>New EZCater orders will now automatically appear in your catering page!</small>`;

        hideLoading();

        // Keep status visible (don't auto-hide)
        console.log('‚úÖ EZCater webhooks are now active!');

      } catch (error) {
        console.error('Error activating webhooks:', error);
        hideLoading();

        // Show error status
        statusDiv.style.display = 'block';
        statusDiv.style.background = 'var(--error-bg)';
        statusDiv.style.borderColor = 'var(--error-border)';
        statusDiv.style.color = 'var(--error-text)';
        statusDiv.innerHTML = `‚ùå Webhook activation failed: ${error.message}<br><br>
          ${error.message.includes('already exists') || error.message.includes('Subscriber') ?
            '<strong>Note:</strong> Webhooks may already be active. Check Vercel logs for incoming webhook POST requests.' :
            '<strong>Action:</strong> Check your EZCater API credentials in Vercel environment variables.'}`;
      }
    }

    // ============================================
    // CHECK EZCATER SUBSCRIPTIONS (DIAGNOSTIC)
    // ============================================
    async function checkEZCaterSubscriptions() {
      const statusDiv = document.getElementById('syncStatus');

      try {
        showLoading('CHECKING SUBSCRIPTIONS', 'Fetching EZCater webhook configuration...');

        // Show status
        statusDiv.style.display = 'block';
        statusDiv.style.background = 'var(--warning-bg)';
        statusDiv.style.borderColor = 'var(--warning-border)';
        statusDiv.style.color = 'var(--warning-text)';
        statusDiv.textContent = 'üîç Checking EZCater subscriptions...';

        console.log('üîç Checking EZCater webhook subscriptions...');

        // Call list subscriptions endpoint
        const response = await fetch('/api/ezcater-list-subscriptions', {
          method: 'GET'
        });

        const data = await response.json();

        if (!data.success) {
          throw new Error(data.error || 'Failed to fetch subscriptions');
        }

        console.log('‚úÖ Subscription data:', data);

        // Build coverage status HTML
        const coverageStatus = `
          <strong>Event Coverage:</strong><br>
          ‚Ä¢ order.submitted: ${data.coverage.submitted ? '‚úÖ Active' : '‚ùå Missing'}<br>
          ‚Ä¢ order.accepted: ${data.coverage.accepted ? '‚úÖ Active' : '‚ùå Missing'}<br>
          ‚Ä¢ order.rejected: ${data.coverage.rejected ? '‚úÖ Active' : '‚ùå Missing'}<br>
          ‚Ä¢ order.cancelled: ${data.coverage.cancelled ? '‚úÖ Active' : '‚ùå Missing'}
        `;

        // Determine overall status
        const allActive = data.coverage.submitted && data.coverage.accepted &&
                         data.coverage.rejected && data.coverage.cancelled;

        // Show status
        if (allActive) {
          statusDiv.style.background = 'var(--success-bg)';
          statusDiv.style.borderColor = 'var(--success-border)';
          statusDiv.style.color = 'var(--success-text)';
          statusDiv.innerHTML = `‚úÖ EZCater webhooks are ACTIVE!<br><br>
            <strong>Caterer:</strong> ${data.caterer?.name || 'Jayna Gyro Sacramento'}<br>
            <strong>Store #:</strong> ${data.caterer?.storeNumber || '332390'}<br>
            <strong>Webhook URL:</strong> ${data.webhookUrl}<br>
            <strong>Active Subscriptions:</strong> ${data.totalSubscriptions} for your caterer<br>
            <strong>Total Subscribers:</strong> ${data.ourSubscribers} (all using your webhook)<br><br>
            ${coverageStatus}<br><br>
            <small>‚úÖ All order events are configured. Orders should sync automatically!</small>`;
        } else {
          statusDiv.style.background = 'var(--warning-bg)';
          statusDiv.style.borderColor = 'var(--warning-border)';
          statusDiv.style.color = 'var(--warning-text)';
          statusDiv.innerHTML = `‚ö†Ô∏è EZCater webhooks PARTIALLY configured<br><br>
            <strong>Caterer:</strong> ${data.caterer?.name || 'Jayna Gyro Sacramento'}<br>
            <strong>Store #:</strong> ${data.caterer?.storeNumber || '332390'}<br>
            <strong>Webhook URL:</strong> ${data.webhookUrl}<br>
            <strong>Active Subscriptions:</strong> ${data.totalSubscriptions} for your caterer<br>
            <strong>Total Subscribers:</strong> ${data.ourSubscribers || 0}<br><br>
            ${coverageStatus}<br><br>
            <strong>Action:</strong> Click "ACTIVATE EZCATER WEBHOOKS" to complete setup.`;
        }

        hideLoading();

        // Keep status visible (don't auto-hide)
        console.log('‚úÖ Subscription check complete!');

      } catch (error) {
        console.error('Error checking subscriptions:', error);
        hideLoading();

        // Show error status
        statusDiv.style.display = 'block';
        statusDiv.style.background = 'var(--error-bg)';
        statusDiv.style.borderColor = 'var(--error-border)';
        statusDiv.style.color = 'var(--error-text)';
        statusDiv.innerHTML = `‚ùå Failed to check subscriptions: ${error.message}<br><br>
          <strong>Action:</strong> Check your EZCater API credentials in Vercel environment variables.`;
      }
    }

    // ============================================
    // MANUAL IMPORT EZCATER ORDER BY UUID
    // ============================================
    async function manualImportEZCaterOrder() {
      // Create modal input (no window.prompt - blocked in Google Sites sandbox)
      const modal = document.createElement('div');
      modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10000;';

      const modalContent = document.createElement('div');
      modalContent.style.cssText = 'background: white; padding: 24px; max-width: 500px; width: 90%;';

      const title = document.createElement('h3');
      title.textContent = 'IMPORT EZCATER ORDER';
      title.style.cssText = 'margin: 0 0 16px 0; font-size: 16px; font-weight: 700; text-transform: uppercase;';

      const label = document.createElement('label');
      label.textContent = 'Enter Order Number:';
      label.style.cssText = 'display: block; margin-bottom: 8px; font-size: 13px; font-weight: 600;';

      const input = document.createElement('input');
      input.type = 'text';
      input.placeholder = '284577019';
      input.style.cssText = 'width: 100%; padding: 12px; border: 2px solid var(--gray-300); font-size: 14px; margin-bottom: 8px; box-sizing: border-box;';

      const helpText = document.createElement('div');
      helpText.innerHTML = '<small style="color: var(--gray-600);">Enter the order number from the ezManage URL (e.g., ezmanage.ezcater.com/orders/<strong>284577019</strong>)</small>';
      helpText.style.cssText = 'margin-bottom: 16px;';

      const buttonGroup = document.createElement('div');
      buttonGroup.style.cssText = 'display: flex; gap: 12px; justify-content: flex-end;';

      const cancelBtn = document.createElement('button');
      cancelBtn.textContent = 'CANCEL';
      cancelBtn.style.cssText = 'padding: 12px 24px; background: var(--gray-100); border: 2px solid var(--gray-300); color: var(--gray-900); font-size: 13px; font-weight: 700; cursor: pointer; text-transform: uppercase;';
      cancelBtn.onclick = () => document.body.removeChild(modal);

      const importBtn = document.createElement('button');
      importBtn.textContent = 'IMPORT';
      importBtn.style.cssText = 'padding: 12px 24px; background: #10b981; border: 2px solid #10b981; color: white; font-size: 13px; font-weight: 700; cursor: pointer; text-transform: uppercase;';

      buttonGroup.appendChild(cancelBtn);
      buttonGroup.appendChild(importBtn);

      modalContent.appendChild(title);
      modalContent.appendChild(label);
      modalContent.appendChild(input);
      modalContent.appendChild(helpText);
      modalContent.appendChild(buttonGroup);
      modal.appendChild(modalContent);
      document.body.appendChild(modal);

      input.focus();

      // Wait for user to click import or cancel
      importBtn.onclick = async () => {
        const orderUuid = input.value.trim();
        document.body.removeChild(modal);

        if (!orderUuid) {
          return;
        }

        await processOrderImport(orderUuid);
      };

      input.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          importBtn.click();
        }
      });
    }

    async function processOrderImport(orderNumber) {
      const statusDiv = document.getElementById('syncStatus');

      try {
        showLoading('IMPORTING ORDER', 'Searching for order and fetching from EZCater...');

        statusDiv.style.display = 'block';
        statusDiv.style.background = 'var(--warning-bg)';
        statusDiv.style.borderColor = 'var(--warning-border)';
        statusDiv.style.color = 'var(--warning-text)';
        statusDiv.textContent = 'üì• Importing order...';

        console.log(`üì• Manual import by order number: ${orderNumber}`);

        const response = await fetch('/api/ezcater-import-by-number', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            orderNumber: orderNumber.trim()
          })
        });

        const data = await response.json();

        if (!data.success) {
          throw new Error(data.error || 'Failed to import order');
        }

        console.log('‚úÖ Order imported:', data);

        // Show success or "already exists" message
        if (data.alreadyExists) {
          statusDiv.style.background = 'var(--warning-bg)';
          statusDiv.style.borderColor = 'var(--warning-border)';
          statusDiv.style.color = 'var(--warning-text)';
          statusDiv.innerHTML = `‚ÑπÔ∏è  Order already exists in database!<br><br>
            <strong>Order #:</strong> ${data.order.order_number}<br>
            <strong>Customer:</strong> ${data.order.customer_name}<br><br>
            <small>This order was previously synced. No action taken.</small>`;
        } else {
          statusDiv.style.background = 'var(--success-bg)';
          statusDiv.style.borderColor = 'var(--success-border)';
          statusDiv.style.color = 'var(--success-text)';
          statusDiv.innerHTML = `‚úÖ Order imported successfully!<br><br>
            <strong>Order #:</strong> ${data.order.order_number}<br>
            <strong>Customer:</strong> ${data.order.customer_name}<br>
            <strong>Delivery Date:</strong> ${data.order.delivery_date}<br>
            <strong>Total:</strong> $${data.order.total_amount?.toFixed(2)}<br>
            <strong>Status:</strong> ${data.order.status}<br><br>
            <small>Order has been added to your database and will appear in the list below.</small>`;

          // Reload orders from database
          setTimeout(() => {
            loadOrdersFromDatabase();
          }, 2000);
        }

        hideLoading();

      } catch (error) {
        console.error('Error importing order:', error);
        hideLoading();

        statusDiv.style.display = 'block';
        statusDiv.style.background = 'var(--error-bg)';
        statusDiv.style.borderColor = 'var(--error-border)';
        statusDiv.style.color = 'var(--error-text)';
        statusDiv.innerHTML = `‚ùå Failed to import order: ${error.message}<br><br>
          <strong>Possible reasons:</strong><br>
          ‚Ä¢ Invalid order number (check the ezManage URL)<br>
          ‚Ä¢ Order not found in EZCater<br>
          ‚Ä¢ API credentials issue<br><br>
          <strong>Example:</strong> From ezmanage.ezcater.com/orders/<strong>284577019</strong>, enter just "284577019"`;
      }
    }

    // ============================================
    // FORCE SYNC MODIFIED EZCATER ORDER
    // ============================================
    async function forceSyncEZCaterOrder() {
      // Create modal input
      const modal = document.createElement('div');
      modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10000;';

      const modalContent = document.createElement('div');
      modalContent.style.cssText = 'background: white; padding: 24px; max-width: 500px; width: 90%;';

      const title = document.createElement('h3');
      title.textContent = 'SYNC MODIFIED ORDER';
      title.style.cssText = 'margin: 0 0 16px 0; font-size: 16px; font-weight: 700; text-transform: uppercase; color: #8b5cf6;';

      const label = document.createElement('label');
      label.textContent = 'Enter Order Number to Force Sync:';
      label.style.cssText = 'display: block; margin-bottom: 8px; font-size: 13px; font-weight: 600;';

      const input = document.createElement('input');
      input.type = 'text';
      input.placeholder = '284323829';
      input.style.cssText = 'width: 100%; padding: 12px; border: 2px solid var(--gray-300); font-size: 14px; margin-bottom: 8px; box-sizing: border-box;';

      const helpText = document.createElement('div');
      helpText.innerHTML = '<small style="color: var(--gray-600);">Use this when a customer <strong>modifies an existing order</strong> and you need to update it with the latest data from EZCater.</small>';
      helpText.style.cssText = 'margin-bottom: 16px;';

      const buttonGroup = document.createElement('div');
      buttonGroup.style.cssText = 'display: flex; gap: 12px; justify-content: flex-end;';

      const cancelBtn = document.createElement('button');
      cancelBtn.textContent = 'CANCEL';
      cancelBtn.style.cssText = 'padding: 12px 24px; background: var(--gray-100); border: 2px solid var(--gray-300); color: var(--gray-900); font-size: 13px; font-weight: 700; cursor: pointer; text-transform: uppercase;';
      cancelBtn.onclick = () => document.body.removeChild(modal);

      const syncBtn = document.createElement('button');
      syncBtn.textContent = 'SYNC NOW';
      syncBtn.style.cssText = 'padding: 12px 24px; background: #8b5cf6; border: 2px solid #8b5cf6; color: white; font-size: 13px; font-weight: 700; cursor: pointer; text-transform: uppercase;';

      buttonGroup.appendChild(cancelBtn);
      buttonGroup.appendChild(syncBtn);

      modalContent.appendChild(title);
      modalContent.appendChild(label);
      modalContent.appendChild(input);
      modalContent.appendChild(helpText);
      modalContent.appendChild(buttonGroup);
      modal.appendChild(modalContent);
      document.body.appendChild(modal);

      input.focus();

      // Wait for user to click sync or cancel
      syncBtn.onclick = async () => {
        const orderNumber = input.value.trim();
        document.body.removeChild(modal);

        if (!orderNumber) {
          return;
        }

        await processOrderForceSync(orderNumber);
      };

      input.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          syncBtn.click();
        }
      });
    }

    async function processOrderForceSync(orderNumber) {
      const statusDiv = document.getElementById('syncStatus');

      try {
        showLoading('SYNCING ORDER', 'Fetching latest data from EZCater...');

        statusDiv.style.display = 'block';
        statusDiv.style.background = 'var(--warning-bg)';
        statusDiv.style.borderColor = 'var(--warning-border)';
        statusDiv.style.color = 'var(--warning-text)';
        statusDiv.textContent = 'üîÑ Force syncing order with latest data...';

        console.log(`üîÑ Force sync order number: ${orderNumber}`);

        const response = await fetch('/api/ezcater-force-sync', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            orderNumber: orderNumber.trim()
          })
        });

        const data = await response.json();

        if (!data.success) {
          throw new Error(data.error || 'Failed to sync order');
        }

        console.log('‚úÖ Order synced:', data);

        // Show success message
        statusDiv.style.background = 'var(--success-bg)';
        statusDiv.style.borderColor = 'var(--success-border)';
        statusDiv.style.color = 'var(--success-text)';
        statusDiv.innerHTML = `‚úÖ Order synced successfully with latest data!<br><br>
          <strong>Order #:</strong> ${data.order.order_number}<br>
          <strong>Customer:</strong> ${data.order.customer_name}<br>
          <strong>Delivery Date:</strong> ${data.order.delivery_date}<br>
          <strong>Total:</strong> $${data.order.total_amount?.toFixed(2)}<br>
          <strong>Status:</strong> ${data.order.status}<br>
          <strong>Last Synced:</strong> ${new Date(data.order.last_synced_at).toLocaleString()}<br><br>
          <small>Order has been updated with the latest modifications from EZCater.</small>`;

        // Reload orders from database
        setTimeout(() => {
          loadOrdersFromDatabase();
        }, 2000);

        hideLoading();

      } catch (error) {
        console.error('Error syncing order:', error);
        hideLoading();

        statusDiv.style.display = 'block';
        statusDiv.style.background = 'var(--error-bg)';
        statusDiv.style.borderColor = 'var(--error-border)';
        statusDiv.style.color = 'var(--error-text)';
        statusDiv.innerHTML = `‚ùå Failed to sync order: ${error.message}<br><br>
          <strong>Possible reasons:</strong><br>
          ‚Ä¢ Invalid order number<br>
          ‚Ä¢ Order not found in EZCater<br>
          ‚Ä¢ API credentials issue<br><br>
          <strong>Tip:</strong> Make sure the order exists in EZCater and you have the correct order number.`;
      }
    }

    // ============================================
    // DISPLAY UPCOMING ORDERS
    // ============================================
    function displayUpcomingOrders(orders, showLoadingSpinner = true) {
      const container = document.getElementById('upcomingContent');

      // DEBUG: Log all orders being displayed
      console.log(`üìä Displaying ${orders ? orders.length : 0} orders:`);
      if (orders && orders.length > 0) {
        const toastOrders = orders.filter(o => o.source_system === 'TOAST');
        const ezcaterOrders = orders.filter(o => o.source_system === 'EZCATER');
        console.log(`  - Toast orders: ${toastOrders.length}`);
        console.log(`  - EZCater orders: ${ezcaterOrders.length}`);
        ezcaterOrders.forEach(order => {
          console.log(`    ‚Ä¢ EZCater: ${order.customer_name} | ${order.delivery_date} | Status: ${order.status}`);
        });
      }

      // FILTER: Remove orders that are more than 1 hour past their delivery time
      // TEMPORARILY DISABLED FOR DEBUGGING - WILL RE-ENABLE AFTER TESTING
      const filteredOrders = orders || [];

      console.log(`‚è∞ TIME FILTER DISABLED FOR DEBUGGING - Showing all ${filteredOrders.length} orders`);

      // Group orders by date
      const ordersByDate = {};
      if (filteredOrders && filteredOrders.length > 0) {
        filteredOrders.forEach(order => {
          const date = order.delivery_date;
          if (!ordersByDate[date]) {
            ordersByDate[date] = [];
          }
          ordersByDate[date].push(order);
        });
      }

      console.log(`üìÖ DEBUG - Orders grouped by date:`, ordersByDate);
      console.log(`üìÖ DEBUG - Order dates found:`, Object.keys(ordersByDate));

      // Generate next 7 days (including today) in Pacific timezone
      const next7Days = [];
      for (let i = 0; i < 7; i++) {
        const dateStr = getPacificDatePlusDays(i);
        next7Days.push(dateStr);
      }

      console.log(`üìÖ DEBUG - Next 7 days to display:`, next7Days);
      console.log(`üìÖ DEBUG - Today should be:`, getPacificToday());

      // Find orders beyond day 7 (sorted by date)
      const allOrderDates = Object.keys(ordersByDate).sort();
      const day7Date = next7Days[6]; // Last of the 7 days
      const ordersBeyond7Days = allOrderDates.filter(date => date > day7Date);

      console.log(`üìÖ DEBUG - Orders beyond day 7:`, ordersBeyond7Days);

      // Combine: first 7 days + any additional dates beyond day 7
      const datesToDisplay = [...next7Days, ...ordersBeyond7Days];

      console.log(`üìÖ DEBUG - Final dates to display:`, datesToDisplay);
      console.log(`üìÖ DEBUG - Number of orders per date:`);
      datesToDisplay.forEach(date => {
        const count = ordersByDate[date] ? ordersByDate[date].length : 0;
        console.log(`     ${date}: ${count} order(s)`);
      });

      // Build HTML
      let html = '';
      datesToDisplay.forEach(date => {
        const dateOrders = ordersByDate[date] || [];
        const dateLabel = formatDateLabel(date);
        const dateClass = getDateClass(date);

        html += `
          <div class="date-group">
            <div class="date-group-header ${dateClass}">
              ${dateLabel}${dateOrders.length > 0 ? ` (${dateOrders.length} order${dateOrders.length > 1 ? 's' : ''})` : ''}
            </div>
        `;

        if (dateOrders.length === 0) {
          // No orders for this day - show "NO ORDERS DUE"
          html += `
            <div style="padding: 20px; text-align: center; color: var(--gray-500); font-size: 13px; font-weight: 600; background: var(--gray-100); border: 2px dashed var(--gray-300);">
              NO ORDERS DUE
            </div>
          `;
        } else {
          // Show orders for this day
          dateOrders.forEach(order => {
            html += renderOrderCard(order);
          });
        }

        html += `</div>`;
      });

      container.innerHTML = html;
      if (showLoadingSpinner) {
        hideLoading();
      }
    }

    // ============================================
    // RENDER ORDER CARD
    // ============================================
    function renderOrderCard(order) {
      const statusClass = getStatusClass(order.status);
      const statusLabel = formatStatus(order.status);

      // Extract delivery notes from order data
      const deliveryNotes = order.order_data?.deliveryInfo?.notes || order.delivery_notes;

      // Source system badge (Toast vs EZCater)
      const sourceSystem = order.source_system || 'TOAST';
      const sourceSystemBadge = sourceSystem === 'TOAST'
        ? '<span style="background: var(--primary-blue); color: white; padding: 2px 6px; font-size: 9px; font-weight: 700; letter-spacing: 0.5px; margin-left: 8px;">TOAST</span>'
        : '<span style="background: var(--warning); color: white; padding: 2px 6px; font-size: 9px; font-weight: 700; letter-spacing: 0.5px; margin-left: 8px;">EZCATER</span>';

      // Determine real order number: Toast uses check_number, EZCater uses order_number
      const realOrderNumber = sourceSystem === 'TOAST'
        ? (order.check_number || order.order_number || 'N/A')
        : (order.order_number || 'N/A');

      // Random emoji for each order (persisted in database)
      const orderEmoji = order.order_emoji || 'üçΩÔ∏è'; // Default fork/knife/plate emoji

      return `
        <div class="order-card" onclick="viewOrderDetails('${order.toast_order_id || order.db_id}')">
          <div class="order-header">
            <div>
              <div class="order-number">${orderEmoji} ${realOrderNumber}${sourceSystemBadge}</div>
              <div class="order-source">${order.delivery_address ? 'DELIVERY' : 'PICK UP'}</div>
            </div>
            <div class="order-status ${statusClass}">${statusLabel}</div>
          </div>

          <div class="order-details">
            <div class="detail-item">
              <div class="detail-label">Customer</div>
              <div class="detail-value">${order.customer_name || 'N/A'}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Phone</div>
              <div class="detail-value">${formatPhoneNumber(order.customer_phone)}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Headcount</div>
              <div class="detail-value">${order.headcount ? order.headcount + ' people' : 'N/A'}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Delivery Time</div>
              <div class="detail-value">${formatTime(order.delivery_time)}</div>
            </div>
            ${deliveryNotes ? `
            <div class="detail-item" style="grid-column: 1 / -1;">
              <div class="detail-label">Delivery Notes</div>
              <div class="detail-value" style="font-size: 12px; font-weight: 400;">${deliveryNotes}</div>
            </div>
            ` : ''}
          </div>

          <div class="order-footer">
            <div class="order-total">$${(order.total || 0).toFixed(2)}</div>
            <div class="order-time">üìç ${order.delivery_address || 'Pickup'}</div>
          </div>
        </div>
      `;
    }

    // ============================================
    // HELPER FUNCTIONS
    // ============================================
    function formatDate(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    function formatDateLabel(dateStr) {
      // Use Pacific timezone utilities (device-independent)
      const relation = getDateRelation(dateStr);
      const formattedDate = formatPacificDate(dateStr, true);

      if (relation === 'TODAY') {
        return `TODAY - ${formattedDate}`;
      } else if (relation === 'TOMORROW') {
        return `TOMORROW - ${formattedDate}`;
      } else {
        return formattedDate;
      }
    }

    function getDateClass(dateStr) {
      // Use Pacific timezone utilities (device-independent)
      const relation = getDateRelation(dateStr);
      if (relation === 'TODAY') return 'today';
      if (relation === 'TOMORROW') return 'tomorrow';
      return '';
    }

    function getStatusClass(status) {
      const statusLower = (status || '').toLowerCase();
      if (statusLower.includes('confirm')) return 'status-confirmed';
      if (statusLower.includes('pending')) return 'status-pending';
      if (statusLower.includes('cancel')) return 'status-cancelled';
      if (statusLower.includes('deliver')) return 'status-delivered';
      if (statusLower.includes('complete')) return 'status-completed';
      return 'status-pending';
    }

    function formatStatus(status) {
      return (status || 'PENDING').toUpperCase();
    }

    function formatTime(timeStr) {
      // Use Pacific timezone utility (device-independent)
      return formatPacificTime(timeStr);
    }

    function formatPhoneNumber(phone) {
      if (!phone) return 'N/A';

      // Remove all non-digit characters
      const cleaned = phone.replace(/\D/g, '');

      // Handle 10-digit US phone numbers
      if (cleaned.length === 10) {
        return `(${cleaned.slice(0, 3)}) ${cleaned.slice(3, 6)}-${cleaned.slice(6)}`;
      }

      // Handle 11-digit numbers (with country code 1)
      if (cleaned.length === 11 && cleaned[0] === '1') {
        return `(${cleaned.slice(1, 4)}) ${cleaned.slice(4, 7)}-${cleaned.slice(7)}`;
      }

      // Return original if format doesn't match
      return phone;
    }

    function viewOrderDetails(orderId) {
      // TODO: Open modal with full order details for editing
      console.log('View order:', orderId);

      // Create info modal
      const overlay = document.createElement('div');
      overlay.style.cssText = `position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:100000;padding:20px;`;
      const box = document.createElement('div');
      box.style.cssText = `background:white;padding:24px;max-width:500px;width:100%;border:3px solid #2563eb;`;
      const title = document.createElement('div');
      title.textContent = 'Coming Soon';
      title.style.cssText = `font-size:18px;font-weight:700;color:#1e40af;margin-bottom:12px;text-transform:uppercase;letter-spacing:0.5px;`;
      const msg = document.createElement('div');
      msg.innerHTML = `Order editing modal coming soon!<br><br><strong>Order ID:</strong> ${orderId}<br><br>This will allow you to edit all fields.`;
      msg.style.cssText = `font-size:14px;color:#4a4a4a;margin-bottom:20px;line-height:1.5;`;
      const btn = document.createElement('button');
      btn.textContent = 'OK';
      btn.style.cssText = `width:100%;padding:12px;background:#1a1a1a;color:white;border:none;font-weight:700;cursor:pointer;text-transform:uppercase;letter-spacing:0.5px;`;
      btn.onclick = () => overlay.remove();
      box.appendChild(title);
      box.appendChild(msg);
      box.appendChild(btn);
      overlay.appendChild(box);
      document.body.appendChild(overlay);
    }

    // ============================================
    // BACKGROUND AUTO-SYNC WITH UPDATE CONFIRMATION
    // ============================================
    let backgroundSyncInterval = null;
    let pendingUpdates = [];

    async function backgroundSync() {
      try {
        console.log('üîÑ Background sync: Checking for new/updated orders...');

        // Authenticate if needed
        if (!toastAccessToken) {
          await authenticateToast();
        }

        // Calculate date range (today + 90 days) in Pacific timezone to sync future orders
        const startDateStr = getPacificToday();
        const endDateStr = getPacificDatePlusDays(90);

        // Fetch fresh orders from Toast API
        const toastResponse = await fetch('/api/toast-catering-orders', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            accessToken: toastAccessToken,
            startDate: startDateStr,
            endDate: endDateStr
          })
        });

        const toastData = await toastResponse.json();

        if (!toastData.success) {
          console.warn('‚ö†Ô∏è Background sync: Failed to fetch from Toast');
          return;
        }

        // Check for new/updated orders
        const checkResponse = await fetch('/api/check-order-updates', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            orders: toastData.data.orders || []
          })
        });

        const checkData = await checkResponse.json();

        if (!checkData.success) {
          console.warn('‚ö†Ô∏è Background sync: Failed to check for updates');
          return;
        }

        // Auto-save NEW orders silently
        if (checkData.data.newOrders && checkData.data.newOrders.length > 0) {
          console.log(`üÜï Found ${checkData.data.newOrders.length} new orders - auto-saving...`);

          const saveResponse = await fetch('/api/save-new-orders', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              orders: checkData.data.newOrders
            })
          });

          const saveData = await saveResponse.json();

          if (saveData.success) {
            console.log(`‚úÖ Auto-saved ${saveData.data.savedCount} new orders`);
            // Reload orders from database to show new orders
            loadOrdersFromDatabase();
          }
        }

        // Show confirmation for UPDATED orders (DISABLED - will re-enable later)
        if (checkData.data.updatedOrders && checkData.data.updatedOrders.length > 0) {
          console.log(`üìù Found ${checkData.data.updatedOrders.length} updated orders - confirmation popup disabled`);
          // pendingUpdates = checkData.data.updatedOrders;
          // showUpdateConfirmationModal(); // DISABLED FOR NOW
        }

        // ALWAYS reload orders from database to pick up webhook-imported EZCater orders
        // (even if no new Toast orders were found)
        console.log('üîÑ Refreshing order list from database (picks up webhook orders)...');
        loadOrdersFromDatabase(false);

      } catch (error) {
        console.error('‚ùå Background sync error:', error);
      }
    }

    function showUpdateConfirmationModal() {
      // Build modal HTML
      let changesHTML = '';

      pendingUpdates.forEach((update, index) => {
        changesHTML += `
          <div style="background: var(--gray-100); border: 2px solid var(--gray-300); padding: 12px; margin-bottom: 12px;">
            <div style="font-size: 14px; font-weight: 700; margin-bottom: 8px;">
              Order #${update.order.order_number}
            </div>
            <div style="font-size: 12px; margin-bottom: 8px;">
              ${update.changes.map(change => `
                <div style="width: 300px; height: 155px; margin-bottom: 4px;">
                  <strong>${change.field}:</strong> ${change.old || 'N/A'} ‚Üí ${change.new || 'N/A'}
                </div>
              `).join('')}
            </div>
          </div>
        `;
      });

      const modalHTML = `
        <div id="updateConfirmationModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10000; padding: 20px; overflow-y: auto;">
          <div style="background: white; padding: 24px; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto; border: 3px solid var(--gray-700);">
            <h2 style="font-size: 18px; font-weight: 700; margin-bottom: 16px; text-transform: uppercase; letter-spacing: 1px;">
              üìù ORDER UPDATES DETECTED
            </h2>
            <p style="font-size: 13px; margin-bottom: 16px; color: var(--gray-700);">
              ${pendingUpdates.length} order${pendingUpdates.length > 1 ? 's have' : ' has'} been updated in Toast POS. Review the changes below:
            </p>
            <div style="max-height: 400px; overflow-y: auto; margin-bottom: 20px;">
              ${changesHTML}
            </div>
            <div style="display: flex; gap: 12px; justify-content: flex-end;">
              <button onclick="dismissUpdates()" style="padding: 12px 24px; background: var(--gray-100); border: 2px solid var(--gray-300); color: var(--gray-900); font-size: 13px; font-weight: 700; cursor: pointer; text-transform: uppercase; letter-spacing: 0.5px;">
                DISMISS
              </button>
              <button onclick="applyUpdates()" style="padding: 12px 24px; background: var(--primary-blue); border: 2px solid var(--primary-blue); color: white; font-size: 13px; font-weight: 700; cursor: pointer; text-transform: uppercase; letter-spacing: 0.5px;">
                APPLY UPDATES
              </button>
            </div>
          </div>
        </div>
      `;

      // Add modal to page
      const modalContainer = document.createElement('div');
      modalContainer.innerHTML = modalHTML;
      document.body.appendChild(modalContainer);
    }

    function dismissUpdates() {
      // Remove modal
      const modal = document.getElementById('updateConfirmationModal');
      if (modal) {
        modal.parentElement.remove();
      }
      pendingUpdates = [];
      console.log('‚ùå User dismissed order updates');
    }

    async function applyUpdates() {
      try {
        console.log(`üìù Applying ${pendingUpdates.length} order updates...`);

        // Extract just the orders (not the change metadata)
        const ordersToUpdate = pendingUpdates.map(u => u.order);

        const response = await fetch('/api/apply-order-updates', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            orders: ordersToUpdate
          })
        });

        const data = await response.json();

        if (data.success) {
          console.log(`‚úÖ Successfully applied ${data.data.updatedCount} updates`);

          // Remove modal
          const modal = document.getElementById('updateConfirmationModal');
          if (modal) {
            modal.parentElement.remove();
          }

          pendingUpdates = [];

          // Reload orders from database to show updates
          loadOrdersFromDatabase();

          // Show success message
          const statusDiv = document.getElementById('syncStatus');
          statusDiv.style.display = 'block';
          statusDiv.style.background = 'var(--success-bg)';
          statusDiv.style.borderColor = 'var(--success-border)';
          statusDiv.style.color = 'var(--success-text)';
          statusDiv.textContent = `‚úÖ Successfully applied ${data.data.updatedCount} order updates!`;

          setTimeout(() => {
            statusDiv.style.display = 'none';
          }, 5000);
        } else {
          showError(`Error applying updates: ${data.error}`);
        }
      } catch (error) {
        console.error('‚ùå Error applying updates:', error);
        showError(`Error applying updates: ${error.message}`);
      }
    }

    // Start background sync every 5 minutes
    function startBackgroundSync() {
      // Initial sync after 30 seconds (syncs Toast API + shows EZCater webhook orders)
      setTimeout(() => {
        backgroundSync();
      }, 30000);

      // Then sync every 5 minutes (syncs Toast API + shows EZCater webhook orders)
      backgroundSyncInterval = setInterval(() => {
        backgroundSync();
      }, 5 * 60 * 1000); // 5 minutes

      console.log('‚úÖ Background auto-sync enabled (polls Toast API every 5 minutes, EZCater via webhook)');
    }

    // ============================================
    // PHOTO GALLERY FUNCTIONS
    // ============================================
    let allPhotos = [];
    let draggedElement = null;
    let isEditMode = false; // Track edit mode state

    async function loadPhotos() {
      try {
        console.log('üì∏ Loading catering orders and photos...');
        showLoading('LOADING ORDERS', 'Loading catering orders and photos...');

        // Calculate date range (today + 90 days) in Pacific timezone - MATCHES BETA TAB
        const startDateStr = getPacificToday();
        const endDateStr = getPacificDatePlusDays(90);

        console.log(`üìÖ ORDERS Tab - Fetching range: ${startDateStr} to ${endDateStr}`);

        // Fetch BOTH uploaded photos AND Toast synced orders
        const [photosResponse, ordersResponse] = await Promise.all([
          fetch('/api/catering-photos-get?archived=false'),
          fetch(`/api/get-catering-orders?startDate=${startDateStr}&endDate=${endDateStr}`) // Now fetches 90 days like BETA tab
        ]);

        const photosData = await photosResponse.json();
        const ordersData = await ordersResponse.json();

        if (!photosData.success) {
          throw new Error(photosData.error || 'Failed to load photos');
        }

        // Get uploaded photos (with images)
        const uploadedPhotos = (photosData.data || [])
          .filter(photo => !photo.archived)
          .map(photo => ({
            ...photo,
            source_type: 'UPLOADED', // Mark as uploaded photo
            has_image: true
          }));

        console.log(`‚úÖ Loaded ${uploadedPhotos.length} uploaded photos`);

        // Get Toast synced orders (without images)
        let toastOrders = [];
        if (ordersData.success && ordersData.data && ordersData.data.orders) {
          toastOrders = ordersData.data.orders.map(order => ({
            id: `toast_${order.db_id}`, // Unique ID for Toast orders
            db_id: order.db_id, // Database ID for fetching line items
            source_type: order.source || 'TOAST',
            order_due_date: order.delivery_date,
            time_due: order.delivery_time ? formatPacificTime24(order.delivery_time) : null,
            order_type: order.delivery_address ? 'DELIVERY' : 'PICKUP',
            leave_jayna_at: null,
            guest_name: order.customer_name,
            phone_number: order.customer_phone,
            email: order.customer_email,
            delivery_address: order.delivery_address,
            special_notes: order.delivery_notes,
            actual_order: null,
            brightness: 100,
            contrast: 100,
            has_image: false, // Toast orders don't have images
            toast_order_number: order.check_number || order.order_number, // Use real check number
            toast_headcount: order.headcount,
            toast_total: order.total,
            toast_status: order.status,
            order_emoji: order.order_emoji || 'üçΩÔ∏è' // Random persistent emoji
          }));

          console.log(`‚úÖ Loaded ${toastOrders.length} Toast orders`);
        }

        // Merge uploaded photos and Toast orders
        allPhotos = [...uploadedPhotos, ...toastOrders];

        // Sort by order_due_date
        allPhotos.sort((a, b) => {
          const dateA = a.order_due_date || '9999-12-31';
          const dateB = b.order_due_date || '9999-12-31';
          return dateA.localeCompare(dateB);
        });

        console.log(`üì¶ Total orders: ${allPhotos.length} (${uploadedPhotos.length} with photos, ${toastOrders.length} from Toast)`);

        renderPhotos();
      } catch (error) {
        console.error('Error loading photos:', error);
        hideLoading();
        document.getElementById('photoGallery').innerHTML = `
          <div class="error-message">
            ‚ùå Error loading orders: ${error.message}
          </div>
        `;
      }
    }

    function renderPhotos() {
      const gallery = document.getElementById('photoGallery');

      if (allPhotos.length === 0) {
        gallery.innerHTML = `
          <div class="empty-state">
            <div class="empty-title">NO PHOTOS YET</div>
            <div class="empty-message">Upload photos of upcoming catering orders to share with your team</div>
          </div>
        `;
        hideLoading();
        return;
      }

      // Group photos by order_due_date
      const photosByDate = {};
      allPhotos.forEach(photo => {
        const date = photo.order_due_date || 'NO DATE';
        if (!photosByDate[date]) {
          photosByDate[date] = [];
        }
        photosByDate[date].push(photo);
      });

      // Sort dates (earliest first)
      const sortedDates = Object.keys(photosByDate).sort((a, b) => {
        if (a === 'NO DATE') return 1;
        if (b === 'NO DATE') return -1;
        return new Date(a) - new Date(b);
      });

      // Show controls in edit mode
      const overlayVisibleClass = isEditMode ? 'visible' : '';
      const controlsVisibleClass = isEditMode ? 'visible' : '';

      // Build HTML grouped by date
      let html = '';
      sortedDates.forEach(date => {
        const photos = photosByDate[date];
        const dateLabel = formatPhotoDateLabel(date);

        html += `
          <div class="photo-date-group">
            <div class="photo-date-header">${dateLabel}</div>
            <div class="photo-thumbnails-grid">
        `;

        photos.forEach((photo, localIndex) => {
          const globalIndex = allPhotos.indexOf(photo);
          const brightness = photo.brightness || 100;
          const contrast = photo.contrast || 100;
          const filterStyle = `filter: brightness(${brightness}%) contrast(${contrast}%);`;

          const timeDue = formatTimeDisplay(photo.time_due);
          const leaveJaynaAt = photo.order_type === 'DELIVERY' ? formatTimeDisplay(photo.leave_jayna_at) : null;

          // Render differently based on whether it has an image or not
          if (photo.has_image) {
            // PHOTO CARD (with image)
            html += `
              <div class="photo-item" data-id="${photo.id}" data-index="${globalIndex}">
                <!-- Delete Button (top right) -->
                <div class="photo-overlay ${overlayVisibleClass}" onclick="promptDeletePhoto(${photo.id})">
                  DELETE
                </div>

                <!-- Reorder Buttons (top left) -->
                <div class="reorder-controls ${controlsVisibleClass}">
                  <button class="reorder-btn" onclick="movePhotoUp(${globalIndex})" ${globalIndex === 0 ? 'disabled' : ''}>
                    ‚ñ≤
                  </button>
                  <button class="reorder-btn" onclick="movePhotoDown(${globalIndex})" ${globalIndex === allPhotos.length - 1 ? 'disabled' : ''}>
                    ‚ñº
                  </button>
                </div>

                <!-- Image (click to expand) -->
                <img src="${photo.image_url}"
                     alt="Catering Order"
                     class="photo-img"
                     id="photo-img-${photo.id}"
                     loading="lazy"
                     width="400"
                     height="500"
                     style="${filterStyle} cursor: pointer;"
                     onclick="openLightbox('${photo.image_url}', ${brightness}, ${contrast})">

                <!-- Order Metadata -->
                <div class="photo-metadata">
                  <div class="photo-metadata-row">
                    <span class="photo-metadata-label">TYPE:</span>
                    <span class="photo-metadata-value">${photo.order_type || 'N/A'}</span>
                  </div>
                  <div class="photo-metadata-row">
                    <span class="photo-metadata-label">TIME DUE:</span>
                    <span class="photo-metadata-value">${timeDue}</span>
                  </div>
                  ${leaveJaynaAt ? `
                  <div class="photo-metadata-row">
                    <span class="photo-metadata-label">LEAVE AT:</span>
                    <span class="photo-metadata-value">${leaveJaynaAt}</span>
                  </div>
                  ` : ''}
                </div>

                <!-- Completed Button (bottom right) -->
                <button class="completed-btn" id="completeBtn_${photo.id}" onclick="archivePhoto(${photo.id}); event.stopPropagation();">
                  MARK AS COMPLETED
                </button>

                <!-- Enhancement Controls (bottom section) -->
                <div class="enhancement-controls ${controlsVisibleClass}">
                  <label class="enhancement-label">IMAGE ENHANCEMENT</label>
                  <button class="filter-preset-btn" onclick="applyScanMode(${photo.id}, ${globalIndex})">
                    SCAN MODE
                  </button>
                  <button class="filter-preset-btn" onclick="resetFilters(${photo.id}, ${globalIndex})" style="background: var(--gray-700); border-color: var(--gray-700);">
                    RESET
                  </button>
                </div>
              </div>
            `;
          } else {
            // TOAST ORDER CARD (no image)
            html += `
              <div class="photo-item" data-id="${photo.id}" data-index="${globalIndex}" style="background: var(--gray-100); border: 3px solid var(--primary-blue);">
                <!-- Toast Badge -->
                <div style="position: absolute; top: 12px; left: 12px; background: var(--primary-blue); color: white; padding: 6px 12px; font-size: 10px; font-weight: 700; letter-spacing: 0.8px; text-transform: uppercase; z-index: 5;">
                  ${photo.source_type}
                </div>

                <!-- No Image Placeholder (CLICKABLE to view order details) -->
                <div onclick="viewToastOrderDetails(${photo.db_id})" style="width: 100%; height: 300px; background: white; display: flex; align-items: center; justify-content: center; border-bottom: 2px solid var(--gray-300); cursor: pointer; transition: background 0.15s ease;">
                  <div style="text-align: center; padding: 20px;">
                    <div style="font-size: 48px; margin-bottom: 12px;">${photo.order_emoji || 'üçΩÔ∏è'}</div>
                    <div style="font-size: 13px; font-weight: 700; color: var(--gray-700); text-transform: uppercase; letter-spacing: 0.5px;">${photo.toast_order_number || 'N/A'}</div>
                    ${photo.toast_total ? `<div style="font-size: 18px; font-weight: 700; color: var(--primary-blue); margin-top: 8px;">$${photo.toast_total.toFixed(2)}</div>` : ''}
                    <div style="font-size: 11px; font-weight: 600; color: var(--primary-blue); margin-top: 12px; text-transform: uppercase; letter-spacing: 0.5px;">CLICK TO VIEW FULL ORDER</div>
                  </div>
                </div>

                <!-- Order Metadata -->
                <div class="photo-metadata">
                  ${photo.guest_name ? `
                  <div class="photo-metadata-row">
                    <span class="photo-metadata-label">CUSTOMER:</span>
                    <span class="photo-metadata-value">${photo.guest_name}</span>
                  </div>
                  ` : ''}
                  <div class="photo-metadata-row">
                    <span class="photo-metadata-label">TYPE:</span>
                    <span class="photo-metadata-value">${photo.order_type || 'N/A'}</span>
                  </div>
                  <div class="photo-metadata-row">
                    <span class="photo-metadata-label">TIME DUE:</span>
                    <span class="photo-metadata-value">${timeDue}</span>
                  </div>
                  ${photo.toast_headcount ? `
                  <div class="photo-metadata-row">
                    <span class="photo-metadata-label">HEADCOUNT:</span>
                    <span class="photo-metadata-value">${photo.toast_headcount} guests</span>
                  </div>
                  ` : ''}
                  ${photo.phone_number ? `
                  <div class="photo-metadata-row">
                    <span class="photo-metadata-label">PHONE:</span>
                    <span class="photo-metadata-value">${photo.phone_number}</span>
                  </div>
                  ` : ''}
                  ${photo.delivery_address ? `
                  <div class="photo-metadata-row">
                    <span class="photo-metadata-label">ADDRESS:</span>
                    <span class="photo-metadata-value">${photo.delivery_address}</span>
                  </div>
                  ` : ''}
                  ${photo.special_notes ? `
                  <div class="photo-metadata-row">
                    <span class="photo-metadata-label">NOTES:</span>
                    <span class="photo-metadata-value">${photo.special_notes}</span>
                  </div>
                  ` : ''}
                </div>

                <!-- Status Badge (bottom) -->
                <div style="padding: 12px; background: var(--success-bg); border-top: 2px solid var(--success-border); text-align: center;">
                  <span style="font-size: 11px; font-weight: 700; color: var(--success-text); text-transform: uppercase; letter-spacing: 0.8px;">
                    ${photo.toast_status || 'CONFIRMED'} FROM ${photo.source_type === 'ezCater' ? 'EZCATER' : 'TOAST'}
                  </span>
                </div>
              </div>
            `;
          }
        });

        html += `
            </div>
          </div>
        `;
      });

      gallery.innerHTML = html;
      hideLoading();
    }

    // Format date header for photo groups
    function formatPhotoDateLabel(dateStr) {
      if (dateStr === 'NO DATE') return 'NO DATE SPECIFIED';

      // Use Pacific timezone utilities (device-independent)
      const relation = getDateRelation(dateStr);

      // Parse and format in Pacific time
      const [year, month, day] = dateStr.split('-').map(Number);
      const utcDate = new Date(Date.UTC(year, month - 1, day, 12, 0, 0));

      const dayLabel = new Intl.DateTimeFormat('en-US', {
        weekday: 'long',
        timeZone: 'America/Los_Angeles'
      }).format(utcDate).toUpperCase();

      const dateLabel = new Intl.DateTimeFormat('en-US', {
        month: 'long',
        day: 'numeric',
        year: 'numeric',
        timeZone: 'America/Los_Angeles'
      }).format(utcDate).toUpperCase();

      if (relation === 'TODAY') {
        return `TODAY - ${dayLabel}, ${dateLabel}`;
      } else if (relation === 'TOMORROW') {
        return `TOMORROW - ${dayLabel}, ${dateLabel}`;
      } else {
        return `${dayLabel}, ${dateLabel}`;
      }
    }

    // Format time for display
    function formatTimeDisplay(timeStr) {
      if (!timeStr) return 'N/A';
      try {
        // Parse HH:MM format
        const [hours, minutes] = timeStr.split(':');
        const hour = parseInt(hours);
        const ampm = hour >= 12 ? 'PM' : 'AM';
        const hour12 = hour % 12 || 12;
        return `${hour12}:${minutes} ${ampm}`;
      } catch {
        return timeStr;
      }
    }

    // View full Toast order details (line items, modifiers, totals)
    async function viewToastOrderDetails(orderId) {
      try {
        console.log(`üìã Fetching order details for order ID: ${orderId}`);
        showLoading('LOADING ORDER', 'Fetching order details...');

        const response = await fetch(`/api/get-order-items?order_id=${orderId}`);
        const result = await response.json();

        hideLoading();

        if (!result.success) {
          showMessage(`Failed to load order details: ${result.error}`, 'error');
          return;
        }

        const { order, lineItems } = result.data;

        // Build modal HTML
        let modalHtml = `
          <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10000; overflow-y: auto; padding: 20px;" onclick="closeToastOrderModal(event)">
            <div style="background: white; padding: 24px; max-width: 800px; width: 100%; max-height: 90vh; overflow-y: auto; border: 3px solid var(--gray-700);" onclick="event.stopPropagation()">

              <!-- Header -->
              <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 3px solid var(--gray-300);">
                <div>
                  <h2 style="margin: 0 0 8px 0; font-size: 20px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: var(--gray-900);">
                    ${order.source_system === 'EZCATER' ? `EZCATER ORDER #${order.order_number || 'N/A'}` : `TOAST CHECK #${order.check_number || order.order_number || 'N/A'}`}
                  </h2>
                  <div style="font-size: 13px; color: var(--gray-600);">
                    ${order.delivery_address ? 'DELIVERY' : 'PICK UP'} ‚Ä¢ ${order.status?.toUpperCase() || 'CONFIRMED'}${order.payment_status ? ` ‚Ä¢ <span style="color: ${order.payment_status === 'PAID' ? '#059669' : '#f59e0b'}; font-weight: 700;">${order.payment_status}</span>` : ''}
                  </div>
                  ${order.headcount || order.utensils_required !== null ? `
                  <div style="font-size: 12px; color: var(--gray-600); margin-top: 8px;">
                    ${order.headcount ? `<span style="font-weight: 600;">Guest Count:</span> ${order.headcount}` : ''}${order.headcount && (order.utensils_required !== null) ? ' ‚Ä¢ ' : ''}${order.utensils_required === true ? `<span style="font-weight: 600;">Utensils:</span> ${order.utensils_quantity || order.headcount || 'Yes'} ${typeof (order.utensils_quantity || order.headcount) === 'number' ? 'sets' : ''}` : order.utensils_required === false ? '<span style="font-weight: 600;">Utensils:</span> <span style="color: #dc2626;">NO</span>' : ''}
                  </div>
                  ` : ''}
                </div>
                <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                  <!-- MARK AS COMPLETED button removed but code kept for future use -->
                  ${false && order.status !== 'completed' && order.status !== 'delivered' ? `
                  <button onclick="markOrderAsCompleted(event, ${order.id})" style="background: rgba(0,0,0,0.7); border: 2px solid rgba(0,0,0,0.7); color: white; padding: 8px 16px; font-size: 13px; font-weight: 700; cursor: pointer; text-transform: uppercase;">
                    MARK AS COMPLETED
                  </button>
                  ` : ''}
                  <button onclick="downloadToastOrderPDF(event, ${order.id})" style="background: rgba(0,0,0,0.7); border: 2px solid rgba(0,0,0,0.7); color: white; padding: 8px 16px; font-size: 13px; font-weight: 700; cursor: pointer; text-transform: uppercase;">
                    PDF
                  </button>
                  <button onclick="printToastOrder(event, ${order.id})" style="background: rgba(0,0,0,0.7); border: 2px solid rgba(0,0,0,0.7); color: white; padding: 8px 16px; font-size: 13px; font-weight: 700; cursor: pointer; text-transform: uppercase;">
                    PRINT ORDER
                  </button>
                  <button onclick="togglePrepList(${order.id})" style="background: rgba(0,0,0,0.7); border: 2px solid rgba(0,0,0,0.7); color: white; padding: 8px 16px; font-size: 13px; font-weight: 700; cursor: pointer; text-transform: uppercase;">
                    SEE PREP
                  </button>
                  <button onclick="closeToastOrderModal()" style="background: var(--gray-100); border: 2px solid var(--gray-300); color: var(--gray-900); padding: 8px 16px; font-size: 13px; font-weight: 700; cursor: pointer; text-transform: uppercase;">
                    CLOSE
                  </button>
                  <!-- DELETE ORDER button removed but code kept for future use -->
                  ${false ? `
                  <button onclick="deleteOrderWithPassword(event, ${order.id})" style="background: #dc2626; border: 2px solid #dc2626; color: white; padding: 8px 16px; font-size: 13px; font-weight: 700; cursor: pointer; text-transform: uppercase;">
                    DELETE ORDER
                  </button>
                  ` : ''}
                </div>
              </div>

              <!-- Customer Info -->
              ${order.customer_name || order.customer_phone || order.customer_email ? `
              <div style="margin-bottom: 24px; padding: 16px; background: var(--gray-100); border: 2px solid var(--gray-300);">
                <h3 style="margin: 0 0 12px 0; font-size: 14px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: var(--gray-900);">CUSTOMER INFORMATION</h3>
                ${order.customer_name ? `<div style="margin-bottom: 8px; font-size: 13px;"><strong>Name:</strong> ${order.customer_name}</div>` : ''}
                ${order.customer_phone ? `<div style="margin-bottom: 8px; font-size: 13px;"><strong>Phone:</strong> ${formatPhoneNumber(order.customer_phone)}</div>` : ''}
                ${order.customer_email ? `<div style="margin-bottom: 8px; font-size: 13px;"><strong>Email:</strong> ${order.customer_email}</div>` : ''}
                ${order.delivery_address ? `<div style="margin-bottom: 8px; font-size: 13px;"><strong>Address:</strong> ${order.delivery_address}</div>` : ''}
              </div>
              ` : ''}

              <!-- Delivery/Pickup Info -->
              ${order.delivery_date || order.delivery_time ? `
              <div style="margin-bottom: 24px; padding: 16px; background: var(--blue-bg); border: 2px solid var(--primary-blue);">
                <h3 style="margin: 0 0 12px 0; font-size: 14px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: var(--primary-blue);">${order.delivery_address ? 'DELIVERY DETAILS' : 'PICK UP DETAILS'}</h3>
                ${order.delivery_date ? `<div style="margin-bottom: 8px; font-size: 13px;"><strong>Date:</strong> ${formatPacificDate(order.delivery_date, true)}</div>` : ''}
                ${order.delivery_time ? `<div style="margin-bottom: 8px; font-size: 13px;"><strong>Time:</strong> ${formatPacificTime(order.delivery_time)}</div>` : ''}
                ${order.delivery_notes ? `<div style="margin-bottom: 8px; font-size: 13px;"><strong>Notes:</strong> ${order.delivery_notes}</div>` : ''}
              </div>
              ` : ''}

              <!-- PREP LIST SECTION (initially hidden) -->
              <div id="prepListSection" style="display: none; margin-bottom: 24px; padding: 20px; background: white; border: 2px solid var(--gray-300);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 2px solid var(--gray-300);">
                  <h3 style="margin: 0; font-size: 16px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: var(--gray-900);">PREP LIST</h3>
                  <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                    <button onclick="exportLabelsCSV(event, ${order.id})" style="display: none; background: var(--primary-blue); border: 2px solid var(--primary-blue); color: white; padding: 8px 16px; font-size: 13px; font-weight: 700; cursor: pointer; text-transform: uppercase;">
                      EXPORT LABELS
                    </button>
                    <button onclick="downloadPrepListPDF(event, ${order.id})" style="background: rgba(0,0,0,0.7); border: 2px solid rgba(0,0,0,0.7); color: white; padding: 8px 16px; font-size: 13px; font-weight: 700; cursor: pointer; text-transform: uppercase;">
                      PDF
                    </button>
                    <button onclick="printPrepList(event, ${order.id})" style="background: rgba(0,0,0,0.7); border: 2px solid rgba(0,0,0,0.7); color: white; padding: 8px 16px; font-size: 13px; font-weight: 700; cursor: pointer; text-transform: uppercase;">
                      PRINT SHEET
                    </button>
                    <button onclick="print3InchLabels(event, ${order.id})" style="background: rgba(0,0,0,0.7); border: 2px solid rgba(0,0,0,0.7); color: white; padding: 8px 16px; font-size: 13px; font-weight: 700; cursor: pointer; text-transform: uppercase;">
                      PRINT LABELS
                    </button>
                  </div>
                </div>
                <div id="prepListContent">
                  ${generatePrepListHTML(calculatePrepList(lineItems, order), order)}
                </div>
              </div>

              <!-- Order Items -->
              <div style="margin-bottom: 24px;">
                <h3 style="margin: 0 0 16px 0; font-size: 14px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: var(--gray-900);">ORDER ITEMS</h3>

                ${lineItems.length === 0 ? `
                  <div style="padding: 40px; text-align: center; background: var(--gray-100); border: 2px solid var(--gray-300);">
                    <div style="font-size: 13px; color: var(--gray-600);">No line items found. This order may not have been synced with item details yet.</div>
                  </div>
                ` : `
                  <div style="border: 2px solid var(--gray-300);">
                    ${lineItems.map((item, idx) => `
                      <div style="padding: 16px; border-bottom: ${idx === lineItems.length - 1 ? 'none' : '1px solid var(--gray-200)'}; ${idx % 2 === 0 ? 'background: white;' : 'background: var(--gray-50);'}">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                          <div>
                            <div style="font-size: 14px; font-weight: 700; color: var(--gray-900); margin-bottom: 4px;">
                              ${item.quantity}x ${item.item_name}
                            </div>
                            ${item.menu_group ? `<div style="font-size: 11px; color: var(--gray-600); text-transform: uppercase; letter-spacing: 0.5px;">${item.menu_group}</div>` : ''}
                          </div>
                          <div style="text-align: right;">
                            ${item.unit_price ? `<div style="font-size: 12px; color: var(--gray-600);">$${parseFloat(item.unit_price).toFixed(2)} each</div>` : ''}
                            <div style="font-size: 16px; font-weight: 700; color: var(--gray-900);">$${parseFloat(item.total_price).toFixed(2)}</div>
                          </div>
                        </div>

                        ${item.modifiers && item.modifiers.length > 0 ? `
                          <div style="margin-left: 16px; padding-left: 12px; border-left: 3px solid var(--gray-300);">
                            ${item.modifiers.map(mod => `
                              <div style="font-size: 12px; color: var(--gray-700); margin-bottom: 4px;">
                                + ${mod.name} ${mod.price ? `($${parseFloat(mod.price).toFixed(2)})` : ''}
                              </div>
                            `).join('')}
                          </div>
                        ` : ''}

                        ${item.special_requests ? `
                          <div style="margin-top: 8px; padding: 8px; background: var(--warning-bg); border-left: 3px solid var(--warning-border);">
                            <div style="font-size: 11px; font-weight: 700; color: var(--warning-text); margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px;">SPECIAL REQUEST</div>
                            <div style="font-size: 12px; color: var(--gray-900);">${item.special_requests}</div>
                          </div>
                        ` : ''}
                      </div>
                    `).join('')}
                  </div>
                `}
              </div>

              <!-- Financial Breakdown (BEO Format) -->
              ${order.subtotal !== null && order.subtotal !== undefined ? `
              <div style="margin-bottom: 24px; padding: 20px; background: white; border: 3px solid var(--gray-700);">
                <h3 style="margin: 0 0 16px 0; font-size: 14px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: var(--gray-900); padding-bottom: 12px; border-bottom: 2px solid var(--gray-300);">FINANCIAL BREAKDOWN</h3>

                <div style="display: flex; justify-content: space-between; padding: 8px 0; font-size: 14px;">
                  <span style="color: var(--gray-700);">Subtotal:</span>
                  <span style="font-weight: 600; color: var(--gray-900);">$${parseFloat(order.subtotal).toFixed(2)}</span>
                </div>

                ${order.delivery_fee && parseFloat(order.delivery_fee) > 0 ? `
                <div style="display: flex; justify-content: space-between; padding: 8px 0; font-size: 14px;">
                  <span style="color: var(--gray-700);">Delivery Fee:</span>
                  <span style="font-weight: 600; color: var(--gray-900);">$${parseFloat(order.delivery_fee).toFixed(2)}</span>
                </div>
                ` : ''}

                ${order.service_charge_amount && parseFloat(order.service_charge_amount) > 0 ? `
                <div style="display: flex; justify-content: space-between; padding: 8px 0; font-size: 14px;">
                  <span style="color: var(--gray-700);">Service Charge:</span>
                  <span style="font-weight: 600; color: var(--gray-900);">$${parseFloat(order.service_charge_amount).toFixed(2)}</span>
                </div>
                ` : ''}

                ${order.discount_amount && parseFloat(order.discount_amount) > 0 ? `
                <div style="display: flex; justify-content: space-between; padding: 8px 0; font-size: 14px;">
                  <span style="color: #dc2626;">Discount:</span>
                  <span style="font-weight: 600; color: #dc2626;">-$${parseFloat(order.discount_amount).toFixed(2)}</span>
                </div>
                ` : ''}

                <div style="display: flex; justify-content: space-between; padding: 8px 0; font-size: 14px;">
                  <span style="color: var(--gray-700);">Tax:</span>
                  <span style="font-weight: 600; color: var(--gray-900);">$${parseFloat(order.tax || 0).toFixed(2)}</span>
                </div>

                <div style="display: flex; justify-content: space-between; padding: 8px 0; font-size: 14px;">
                  <span style="color: var(--gray-700);">Tip:</span>
                  <span style="font-weight: 600; color: var(--gray-900);">$${parseFloat(order.tip || 0).toFixed(2)}</span>
                </div>

                <div style="border-top: 2px solid var(--gray-900); margin-top: 12px; padding-top: 12px;">
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-size: 16px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: var(--gray-900);">TOTAL:</span>
                    <span style="font-size: 24px; font-weight: 700; color: var(--gray-900);">$${parseFloat(order.total_amount || 0).toFixed(2)}</span>
                  </div>
                </div>
              </div>
              ` : `
              <!-- Simple Order Total (for orders without breakdown) -->
              <div style="padding: 16px; background: var(--success-bg); border: 2px solid var(--success-border);">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <div style="font-size: 14px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: var(--success-text);">ORDER TOTAL</div>
                  <div style="font-size: 24px; font-weight: 700; color: var(--success-text);">$${parseFloat(order.total_amount || 0).toFixed(2)}</div>
                </div>
              </div>
              `}

              <!-- Created Timestamp -->
              ${order.created_in_toast_at ? `
              <div style="text-align: center; padding-top: 16px; border-top: 1px solid var(--gray-300);">
                <div style="font-size: 11px; color: var(--gray-500); text-transform: uppercase; letter-spacing: 0.5px;">
                  Created: ${formatPacificDate(order.created_in_toast_at.split('T')[0].split(' ')[0], true)} at ${formatPacificTime(order.created_in_toast_at)}
                </div>
              </div>
              ` : ''}

            </div>
          </div>
        `;

        // Create modal element
        const modal = document.createElement('div');
        modal.id = 'toastOrderModal';
        modal.innerHTML = modalHtml;
        document.body.appendChild(modal);

      } catch (error) {
        hideLoading();
        console.error('Error loading order details:', error);
        // Can't use alert in sandboxed iframe (Google Sites)
        const errorDiv = document.createElement('div');
        errorDiv.style.cssText = 'position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #dc2626; color: white; padding: 16px 24px; border-radius: 8px; z-index: 99999; font-size: 14px; font-weight: 600;';
        errorDiv.textContent = `Failed to load order: ${error.message}`;
        document.body.appendChild(errorDiv);
        setTimeout(() => errorDiv.remove(), 5000);
      }
    }

    // Close Toast order details modal
    function closeToastOrderModal(event) {
      // Allow closing by clicking overlay OR close button
      if (!event || event.target === event.currentTarget || !event) {
        const modal = document.getElementById('toastOrderModal');
        if (modal) {
          modal.remove();
        }
      }
    }

    // Delete order with password protection (Google Sites friendly - no alerts/confirms!)
    async function deleteOrderWithPassword(event, orderId) {
      event.preventDefault();
      event.stopPropagation();

      // Create inline password prompt (Google Sites friendly)
      const promptOverlay = document.createElement('div');
      promptOverlay.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; z-index: 100001; padding: 20px;';

      const promptBox = document.createElement('div');
      promptBox.style.cssText = 'background: white; padding: 24px; max-width: 400px; width: 100%; border: 3px solid #dc2626;';

      const title = document.createElement('div');
      title.textContent = 'üóëÔ∏è DELETE ORDER';
      title.style.cssText = 'font-size: 18px; font-weight: 700; color: #dc2626; margin-bottom: 16px; text-transform: uppercase; letter-spacing: 1px;';

      const warning = document.createElement('div');
      warning.innerHTML = '‚ö†Ô∏è <strong>WARNING:</strong> This will permanently delete this order from the database!';
      warning.style.cssText = 'background: #fee2e2; border: 2px solid #dc2626; color: #991b1b; padding: 12px; margin-bottom: 16px; font-size: 13px;';

      const label = document.createElement('label');
      label.textContent = 'Enter password to confirm:';
      label.style.cssText = 'display: block; margin-bottom: 8px; font-size: 13px; font-weight: 700; color: #1a1a1a;';

      const input = document.createElement('input');
      input.type = 'password';
      input.placeholder = 'Enter password...';
      input.style.cssText = 'width: 100%; padding: 12px; border: 2px solid #d1d5db; font-size: 14px; margin-bottom: 20px; box-sizing: border-box;';

      const errorMsg = document.createElement('div');
      errorMsg.style.cssText = 'color: #dc2626; font-size: 13px; margin-bottom: 12px; display: none; font-weight: 600;';

      const buttonContainer = document.createElement('div');
      buttonContainer.style.cssText = 'display: flex; gap: 12px; justify-content: flex-end;';

      const cancelBtn = document.createElement('button');
      cancelBtn.textContent = 'CANCEL';
      cancelBtn.style.cssText = 'padding: 12px 24px; background: var(--gray-100); border: 2px solid var(--gray-300); color: var(--gray-900); font-size: 13px; font-weight: 700; cursor: pointer; text-transform: uppercase;';
      cancelBtn.onclick = () => promptOverlay.remove();

      const deleteBtn = document.createElement('button');
      deleteBtn.textContent = 'DELETE';
      deleteBtn.style.cssText = 'padding: 12px 24px; background: #dc2626; border: 2px solid #dc2626; color: white; font-size: 13px; font-weight: 700; cursor: pointer; text-transform: uppercase;';
      deleteBtn.onclick = async () => {
        const password = input.value.trim();

        // Check password
        if (password !== 'Alonissos325*') {
          errorMsg.textContent = '‚ùå Incorrect password!';
          errorMsg.style.display = 'block';
          input.value = '';
          input.focus();
          return;
        }

        // Password correct - proceed with deletion
        try {
          promptOverlay.remove();
          showLoading('DELETING ORDER', 'Removing order from database...');

          const response = await fetch('/api/delete-catering-order', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              order_id: orderId
            })
          });

          const result = await response.json();
          hideLoading();

          if (!result.success) {
            throw new Error(result.error || 'Failed to delete order');
          }

          console.log(`‚úÖ Order ${orderId} deleted successfully`);

          // Close modal and reload orders
          closeToastOrderModal();
          await loadOrdersFromDatabase();

          // Show success message
          const statusDiv = document.getElementById('syncStatus');
          if (statusDiv) {
            statusDiv.style.display = 'block';
            statusDiv.style.background = '#d1fae5';
            statusDiv.style.borderColor = '#059669';
            statusDiv.style.color = '#065f46';
            statusDiv.textContent = '‚úÖ Order deleted successfully!';
            setTimeout(() => {
              statusDiv.style.display = 'none';
            }, 3000);
          }

        } catch (error) {
          hideLoading();
          console.error('‚ùå Delete error:', error);

          const statusDiv = document.getElementById('syncStatus');
          if (statusDiv) {
            statusDiv.style.display = 'block';
            statusDiv.style.background = '#fee2e2';
            statusDiv.style.borderColor = '#dc2626';
            statusDiv.style.color = '#991b1b';
            statusDiv.textContent = `‚ùå Delete failed: ${error.message}`;
          }
        }
      };

      // Enter key submits
      input.onkeypress = (e) => {
        if (e.key === 'Enter') {
          deleteBtn.click();
        }
      };

      buttonContainer.appendChild(cancelBtn);
      buttonContainer.appendChild(deleteBtn);

      promptBox.appendChild(title);
      promptBox.appendChild(warning);
      promptBox.appendChild(label);
      promptBox.appendChild(input);
      promptBox.appendChild(errorMsg);
      promptBox.appendChild(buttonContainer);
      promptOverlay.appendChild(promptBox);
      document.body.appendChild(promptOverlay);

      // Auto-focus input
      setTimeout(() => input.focus(), 100);
    }

    // Mark order as completed
    async function markOrderAsCompleted(event, orderId) {
      try {
        console.log(`‚úÖ Marking order ${orderId} as completed...`);
        showLoading('UPDATING ORDER', 'Marking as completed...');

        const response = await fetch('/api/update-catering-order-status', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            order_id: orderId,
            status: 'completed'
          })
        });

        const result = await response.json();
        hideLoading();

        if (!result.success) {
          showMessage(`Failed to update order: ${result.error}`, 'error');
          return;
        }

        console.log('‚úÖ Order marked as completed');
        showMessage('‚úÖ Order marked as completed!', 'success');

        // Close modal and reload orders
        closeToastOrderModal();
        await loadOrdersFromDatabase();

      } catch (error) {
        hideLoading();
        console.error('‚ùå Error marking order as completed:', error);
        showMessage(`Error: ${error.message}`, 'error');
      }
    }

    // ============================================
    // PREP LIST CALCULATION & PRINTING
    // ============================================

    /**
     * Calculate prep requirements from line items
     */
    function calculatePrepList(lineItems, order) {
      const prep = {
        byoGyros: { total: 0, items: [] },
        salads: [],
        dips: [],
        greekFries: [],
        dolmas: [],
        spanakopita: [],
        sides: [],
        desserts: [],
        pinwheels: [],
        unmapped: [], // Items that don't fit into any category
        containers: { halfPans: 0, deliContainers: 0, brownBowls: 0, tongs: 0, spoons: 0 }
      };

      lineItems.forEach(item => {
        const itemName = (item.item_name || '').toUpperCase();
        const qty = parseFloat(item.quantity || 1);
        const modifiers = item.modifiers || [];

        // BYO GYRO PITAS (all protein options: Beef & Lamb, Chicken, Roasted Chickpeas, Falafel)
        // Matches BACKEND logic in /api/print-prep-list.js
        if (itemName.includes('MAKE YOUR OWN') || itemName.includes('BYO')) {
          prep.byoGyros.total += qty;
          // Aggregate items with the same name
          const existingItem = prep.byoGyros.items.find(i => i.name === item.item_name);
          if (existingItem) {
            existingItem.qty += qty;
          } else {
            prep.byoGyros.items.push({ name: item.item_name, qty });
          }
        }
        // SALADS (including House Salad)
        else if (itemName.includes('SALAD')) {
          prep.salads.push({ name: item.item_name, qty, modifiers });
        }
        // DIPS
        else if (itemName.includes('HUMMUS') || itemName.includes('BABA GHANOUSH') || itemName.includes('TZATZIKI')) {
          const dipMods = modifiers.map(m => {
            const modName = m.name.toUpperCase();
            // Parse GF pita quantity from dollar amount
            // Example: "+ Gluten Free Pita ($4.00)" ‚Üí $4.00 / $2.00 per pita = 2 pitas
            let gfPitaQty = null;
            if (modName.includes('GLUTEN FREE PITA')) {
              const priceMatch = m.name.match(/\$(\d+(?:\.\d+)?)/);
              if (priceMatch) {
                const totalPrice = parseFloat(priceMatch[1]);
                gfPitaQty = Math.round(totalPrice / 2); // GF pitas cost $2 each
              }
            }
            return { name: modName, gfPitaQty };
          });
          prep.dips.push({ name: item.item_name, qty, modifiers: dipMods });
        }
        // GREEK FRIES BAR
        else if (itemName.includes('GREEK FRIES BAR')) {
          prep.greekFries.push({ name: item.item_name, qty, modifiers });
        }
        // DOLMAS (separate because needs tzatziki + tong)
        else if (itemName.includes('DOLMAS')) {
          prep.dolmas.push({ name: item.item_name, qty, modifiers });
        }
        // SPANAKOPITA (separate because needs tzatziki + tong)
        else if (itemName.includes('SPANAKOPITA')) {
          prep.spanakopita.push({ name: item.item_name, qty, modifiers });
        }
        // SIDES (everything else)
        else if (itemName.includes('GREEK FRIES') || itemName.includes('CHICKPEA') || itemName.includes('GRILLED PITA') || itemName.includes('VEGETABLE STICKS') || itemName.includes('MARINATED OLIVES') || itemName.includes('RICE')) {
          prep.sides.push({ name: item.item_name, qty, modifiers });
        }
        // DESSERTS
        else if (itemName.includes('BAKLAVA') || itemName.includes('RICE PUDDING')) {
          prep.desserts.push({ name: item.item_name, qty, modifiers });
        }
        // PINWHEELS
        else if (itemName.includes('PINWHEEL')) {
          prep.pinwheels.push({ name: item.item_name, qty });
        }
        // UNMAPPED ITEMS (drinks, special items, etc. - anything not categorized above)
        else {
          prep.unmapped.push({ name: item.item_name, qty, modifiers });
        }
      });

      return prep;
    }

    /**
     * Generate prep list HTML for display in modal
     */
    /**
     * Helper: Extract and calculate protein pans from BYO items
     * Returns array of protein prep items with pan calculations
     */
    function calculateProteinPans(byoItems) {
      const proteins = {};

      // Parse BYO items and extract protein types
      byoItems.forEach(item => {
        const itemName = (item.name || '').toUpperCase();
        const qty = parseFloat(item.qty || 0);

        let proteinKey = null;
        let proteinName = null;
        let equipment = null;

        // Match protein types (catch all variations)
        if (itemName.includes('BEEF') && (itemName.includes('LAMB') || itemName.includes('&'))) {
          proteinKey = 'BEEF_LAMB';
          proteinName = 'BEEF & LAMB GYRO MEAT';
          equipment = '1 TONG';
        } else if (itemName.includes('CHICKEN')) {
          proteinKey = 'CHICKEN';
          proteinName = 'CHICKEN GYRO MEAT';
          equipment = '1 TONG';
        } else if (itemName.includes('FALAFEL')) {
          proteinKey = 'FALAFEL';
          proteinName = 'FALAFEL PORTIONS';
          equipment = '1 TONG';
        } else if (itemName.includes('ROASTED') && itemName.includes('CHICKPEA')) {
          proteinKey = 'ROASTED_CHICKPEAS';
          proteinName = 'ROASTED CHICKPEAS PORTIONS';
          equipment = '1 LARGE SERVING SPOON';
        }

        // Aggregate protein quantities
        if (proteinKey) {
          if (!proteins[proteinKey]) {
            proteins[proteinKey] = { name: proteinName, qty: 0, equipment };
          }
          proteins[proteinKey].qty += qty;
        }
      });

      // Calculate pans for each protein type
      const proteinPrep = [];
      Object.values(proteins).forEach(protein => {
        const qty = protein.qty;
        let containerType = '';
        let containerCount = 0;

        // Pan calculation logic:
        // <5 = brown bowls
        // 6-20 = 1 half pan
        // 21+ = calculate half pans, combine 2 half pans into full pans
        if (qty < 5) {
          containerType = 'BROWN BOWLS';
          containerCount = 0; // Individual portions, no container count
        } else if (qty <= 20) {
          containerType = '1 HALF PAN';
          containerCount = 0;
        } else {
          // Calculate half pans needed (10 portions per half pan for proteins)
          const halfPansNeeded = Math.ceil(qty / 10);
          const fullPans = Math.floor(halfPansNeeded / 2);
          const remainingHalfPans = halfPansNeeded % 2;

          if (fullPans > 0 && remainingHalfPans > 0) {
            containerType = `${fullPans} FULL PAN${fullPans > 1 ? 'S' : ''}, 1 HALF PAN`;
          } else if (fullPans > 0) {
            containerType = `${fullPans} FULL PAN${fullPans > 1 ? 'S' : ''}`;
          } else {
            containerType = '1 HALF PAN';
          }
          containerCount = halfPansNeeded;
        }

        proteinPrep.push({
          qty,
          name: protein.name,
          container: containerType,
          equipment: protein.equipment
        });
      });

      return proteinPrep;
    }

    /**
     * Helper: Convert 1/2 pan count to full pans + 1/2 pan format
     * Example: 9 half pans ‚Üí "4 full pans + 1 1/2 pan"
     * Example: 8 half pans ‚Üí "4 full pans"
     * Example: 1 half pan ‚Üí "1 1/2 pan"
     */
    function formatPanCount(halfPanCount) {
      const fullPans = Math.floor(halfPanCount / 2);
      const remainingHalfPans = halfPanCount % 2;

      if (fullPans > 0 && remainingHalfPans > 0) {
        return `${fullPans} full pan${fullPans > 1 ? 's' : ''} + 1 half pan`;
      } else if (fullPans > 0) {
        return `${fullPans} full pan${fullPans > 1 ? 's' : ''}`;
      } else {
        return `1 half pan`;
      }
    }

    function generatePrepListHTML(prep, order) {
      let html = '<div style="font-size: 13px; line-height: 1.6;">';

      // CONTAINERS SUMMARY
      let halfPans = 0, fullPans = 0, deliContainers = 0, deli32ozContainers = 0, brownBowls = 0, roundTrays = 0, bambooPicks = 0, tongs = 0;
      let largeServingSpoons = 0, smallSpoons = 0;

      // BYO Gyros
      if (prep.byoGyros.total > 0) {
        const sets = Math.ceil(prep.byoGyros.total / 10);
        const greensSets = Math.ceil(prep.byoGyros.total / 15); // UPDATED: 1 set per 15 portions
        deliContainers += sets * 3; // tzatziki, aioli, lemon vin
        halfPans += greensSets; // mixed greens - UPDATED to use greensSets
        smallSpoons += 3; // tzatziki (no dill), spicy aioli, lemon vinaigrette
        largeServingSpoons += 1; // diced tomatoes

        // Calculate tongs (1 each: greens, tomatoes, onions, pepperoncini, pitas)
        let byoTongs = 5;

        html += `<h4 style="margin: 16px 0 12px 0; font-size: 14px; font-weight: 700; text-transform: uppercase; color: var(--gray-900);">BYO GYRO PITAS (${prep.byoGyros.total} TOTAL PORTIONS)</h4>`;

        // Protein breakdown
        if (prep.byoGyros.items && prep.byoGyros.items.length > 0) {
          html += `<div style="margin-left: 16px; margin-bottom: 12px;">`;
          html += `<div style="font-weight: 700; margin-bottom: 8px;">PROTEIN BREAKDOWN:</div>`;
          prep.byoGyros.items.forEach(item => {
            html += `<div style="margin-left: 16px;">‚Ä¢ ${item.qty}x ${item.name}</div>`;
          });
          html += `</div>`;
        }

        html += `<div style="margin-left: 16px; font-weight: 700; margin-bottom: 8px;">PREP ITEMS:</div>`;
        html += `<div style="margin-left: 16px;">`;

        // === PROTEINS (ALWAYS AT TOP) ===
        const proteinPans = calculateProteinPans(prep.byoGyros.items || []);
        proteinPans.forEach(protein => {
          html += `<div>‚ñ° ${protein.qty}X <strong>${protein.name}</strong> (<strong>${protein.container}</strong>) - <strong>${protein.equipment}</strong></div>`;
        });

        // Add spacing after proteins if they exist
        if (proteinPans.length > 0) {
          html += `<div style="margin-top: 12px;"></div>`;
        }

        html += `<div>‚ñ° ${sets}x 16oz Tzatziki (no dill) ‚Äì 1 SMALL SPOON</div>`;
        html += `<div>‚ñ° ${sets}x 16oz Spicy Aioli ‚Äì 1 SMALL SPOON</div>`;
        html += `<div>‚ñ° ${sets}x 16oz Lemon Vinaigrette ‚Äì 1 SMALL SPOON</div>`;
        html += `<div>‚ñ° ${formatPanCount(greensSets)} Mixed Greens ‚Äì 1 TONG</div>`;

        // COORDINATED BROWN BOWL LOGIC FOR TOMATOES, ONIONS, PEPPERONCINI
        // If ANY of these 3 items naturally gets a brown bowl, ALL 3 get brown bowls
        let useBrownBowlForAll = false;

        // UPDATED THRESHOLDS:
        // Check if tomatoes would naturally use brown bowl (10-25 portions)
        const tomatoNaturallyUsesBrownBowl = (prep.byoGyros.total >= 10 && prep.byoGyros.total <= 25);

        // Check if onions would naturally use brown bowl (20-45 portions)
        const onionNaturallyUsesBrownBowl = (prep.byoGyros.total >= 20 && prep.byoGyros.total <= 45);

        // Check if pepperoncini would naturally use 32oz (which acts like brown bowl - 10-30 portions)
        const pepperonciniNaturallyUses32oz = (prep.byoGyros.total >= 10 && prep.byoGyros.total <= 30);

        // If any naturally gets brown bowl or 32oz, all three get brown bowls
        if (tomatoNaturallyUsesBrownBowl || onionNaturallyUsesBrownBowl || pepperonciniNaturallyUses32oz) {
          useBrownBowlForAll = true;
        }

        // DICED TOMATO LOGIC - UPDATED
        // 50 portions per half pan (was 30)
        // Below 10: 16oz deli container
        // 10-25: Brown Jayna bowl (was 10-20)
        // 26+: Calculate half pans (50 portions per half pan)
        let tomatoContainer = '';
        if (useBrownBowlForAll) {
          brownBowls += 1;
          tomatoContainer = 'brown Jayna bowl';
        } else if (prep.byoGyros.total < 10) {
          deliContainers += 1;
          tomatoContainer = '16oz deli container';
        } else if (prep.byoGyros.total <= 25) {
          brownBowls += 1;
          tomatoContainer = 'brown Jayna bowl';
        } else {
          const tomatoHalfPans = Math.ceil(prep.byoGyros.total / 50);
          halfPans += tomatoHalfPans;
          tomatoContainer = formatPanCount(tomatoHalfPans);
        }
        html += `<div>‚ñ° ${prep.byoGyros.total} portions Diced Tomatoes (${tomatoContainer}) ‚Äì 1 LARGE SERVING SPOON</div>`;

        // SLICED RED ONION LOGIC - UPDATED
        // 75 portions per half pan (was 50)
        // Below 20: 16oz deli container
        // 20-45: Brown Jayna bowl
        // 46+: Calculate half pans (75 portions per half pan)
        let onionContainer = '';
        if (useBrownBowlForAll) {
          brownBowls += 1;
          onionContainer = 'brown Jayna bowl';
        } else if (prep.byoGyros.total < 20) {
          deliContainers += 1;
          onionContainer = '16oz deli container';
        } else if (prep.byoGyros.total <= 45) {
          brownBowls += 1;
          onionContainer = 'brown Jayna bowl';
        } else {
          const onionHalfPans = Math.ceil(prep.byoGyros.total / 75);
          halfPans += onionHalfPans;
          onionContainer = formatPanCount(onionHalfPans);
        }
        html += `<div>‚ñ° ${prep.byoGyros.total} portions Sliced Red Onion (${onionContainer}) ‚Äì 1 TONG</div>`;

        // PEPPERONCINI LOGIC - UPDATED
        // Below 10: 16oz deli container
        // 10-30: 32oz deli container (was 10-20)
        // 31-99: Half pan (was 21-99)
        // 100+: Full pan(s) + half pan if remainder
        // COORDINATED LOGIC: If tomatoes OR onions use brown bowl, pepperoncini also uses brown bowl
        let pepperonciniContainer = '';
        if (useBrownBowlForAll) {
          brownBowls += 1;
          pepperonciniContainer = 'brown Jayna bowl';
        } else if (prep.byoGyros.total < 10) {
          deliContainers += 1;
          pepperonciniContainer = '16oz deli container';
        } else if (prep.byoGyros.total <= 30) {
          deli32ozContainers += 1;
          pepperonciniContainer = '32oz deli container';
        } else if (prep.byoGyros.total < 100) {
          halfPans += 1;
          pepperonciniContainer = '1 half pan';
        } else {
          const pepperFullPans = Math.floor(prep.byoGyros.total / 100);
          const pepperRemainder = prep.byoGyros.total % 100;
          fullPans += pepperFullPans;
          if (pepperRemainder > 0) {
            halfPans += 1;
            pepperonciniContainer = `${pepperFullPans} full pan${pepperFullPans > 1 ? 's' : ''} + 1 half pan`;
          } else {
            pepperonciniContainer = `${pepperFullPans} full pan${pepperFullPans > 1 ? 's' : ''}`;
          }
        }
        html += `<div>‚ñ° ${prep.byoGyros.total} Whole Pepperoncini (${pepperonciniContainer}) ‚Äì 1 TONG</div>`;

        // PITA LOGIC - UPDATED WITH NEW TIERED SYSTEM
        // 2-12: Half pan
        // 13-25: Full pan
        // 26+: Full pans, then half pan if remainder <12, or full pan if remainder 13-25
        const pitasNeeded = prep.byoGyros.total + Math.ceil(prep.byoGyros.total / 10);
        let pitaContainer = '';

        if (pitasNeeded >= 2 && pitasNeeded <= 12) {
          halfPans += 1;
          pitaContainer = '1 half pan';
        } else if (pitasNeeded >= 13 && pitasNeeded <= 25) {
          fullPans += 1;
          pitaContainer = '1 full pan';
        } else if (pitasNeeded >= 26) {
          const pitaFullPansNeeded = Math.floor(pitasNeeded / 25);
          const pitaRemainder = pitasNeeded % 25;

          fullPans += pitaFullPansNeeded;

          if (pitaRemainder >= 2 && pitaRemainder <= 12) {
            halfPans += 1;
            pitaContainer = `${pitaFullPansNeeded} full pan${pitaFullPansNeeded > 1 ? 's' : ''} + 1 half pan`;
          } else if (pitaRemainder >= 13 && pitaRemainder <= 25) {
            fullPans += 1;
            pitaContainer = `${pitaFullPansNeeded + 1} full pan${pitaFullPansNeeded + 1 > 1 ? 's' : ''}`;
          } else {
            pitaContainer = `${pitaFullPansNeeded} full pan${pitaFullPansNeeded > 1 ? 's' : ''}`;
          }
        } else {
          // Less than 2 pitas (edge case)
          pitaContainer = 'individual wrapping';
        }

        html += `<div>‚ñ° ${pitasNeeded} Whole Grilled Pita (${pitaContainer}) ‚Äì 1 TONG</div>`;
        html += `</div>`;

        tongs += byoTongs;
      }

      // SALADS - UPDATED: Combine 2 orders into 1 full pan
      if (prep.salads.length > 0) {
        html += `<h4 style="margin: 16px 0 12px 0; font-size: 14px; font-weight: 700; text-transform: uppercase; color: var(--gray-900);">SALADS</h4>`;
        html += `<div style="margin-left: 16px; font-style: italic; color: var(--gray-600); margin-bottom: 8px;">(2 LARGE SERVING SPOONS TOTAL FOR ALL SALADS)</div>`;
        html += `<div style="margin-left: 16px;">`;
        prep.salads.forEach(salad => {
          // NEW LOGIC:
          // < 2 orders ‚Üí 1 half pan each
          // 2+ orders ‚Üí Combine 2 orders into 1 full pan
          let panContainer = '';
          if (salad.qty < 2) {
            halfPans += salad.qty; // 1 half pan per order
            panContainer = salad.qty === 1 ? '1 half pan' : `${salad.qty} half pans`;
          } else {
            // Combine 2 orders per full pan
            const fullPansNeeded = Math.floor(salad.qty / 2);
            const remainderHalfPans = salad.qty % 2;

            fullPans += fullPansNeeded;
            halfPans += remainderHalfPans;

            if (fullPansNeeded > 0 && remainderHalfPans > 0) {
              panContainer = `${fullPansNeeded} full pan${fullPansNeeded > 1 ? 's' : ''} (combined 2 orders each) + ${remainderHalfPans} half pan`;
            } else if (fullPansNeeded > 0) {
              panContainer = `${fullPansNeeded} full pan${fullPansNeeded > 1 ? 's' : ''} (combined 2 orders each)`;
            } else {
              panContainer = `${remainderHalfPans} half pan${remainderHalfPans > 1 ? 's' : ''}`;
            }
          }

          deliContainers += salad.qty; // lemon vinaigrette
          html += `<div>‚ñ° ${salad.qty}x ${salad.name} (${panContainer}) ‚Äì 1 TONG</div>`;
          html += `<div style="margin-left: 16px;">‚Üí ${salad.qty}x 16oz Lemon Vinaigrette ‚Äì 1 SMALL SPOON</div>`;
        });
        html += `</div>`;
        tongs += prep.salads.length; // 1 tong per salad type
        smallSpoons += prep.salads.length; // 1 small spoon per salad type for lemon vinaigrette
        largeServingSpoons += 2; // 2 large serving spoons for all salads
      }

      // DIPS
      if (prep.dips.length > 0) {
        html += `<h4 style="margin: 16px 0 12px 0; font-size: 14px; font-weight: 700; text-transform: uppercase; color: var(--gray-900);">DIPS</h4>`;
        html += `<div style="margin-left: 16px;">`;

        let hasVeggiesInAnyDip = false;
        let hasPitaInAnyDip = false;

        prep.dips.forEach(dip => {
          deliContainers += dip.qty;

          const hasVeggies = dip.modifiers.some(m => m.name && (m.name.includes('VEGGIES') || m.name.includes('VEGGIE')));
          const hasPita = dip.modifiers.some(m => m.name && m.name.includes('PITA') && !m.name.includes('GLUTEN FREE'));
          const gfPitaMod = dip.modifiers.find(m => m.name && m.name.includes('GLUTEN FREE PITA'));
          const hasGFPita = !!gfPitaMod;

          html += `<div>‚ñ° ${dip.qty}x 16oz ${dip.name} (garnish) ‚Äì 1 SMALL SPOON</div>`;

          if (hasVeggies) {
            brownBowls += dip.qty * 2; // carrots + celery
            hasVeggiesInAnyDip = true;
            html += `<div style="margin-left: 16px;">‚Üí ${dip.qty * 24} Carrots + ${dip.qty * 24} Celery (brown bowls) ‚Äì 2 TONGS TOTAL</div>`;
          }
          if (hasPita) {
            const regularPitaHalfPans = dip.qty; // 1 half pan per dip (6 pitas sliced)
            halfPans += regularPitaHalfPans;
            hasPitaInAnyDip = true;
            html += `<div style="margin-left: 16px;">‚Üí ${dip.qty * 6} Pitas sliced 8 pieces (${formatPanCount(regularPitaHalfPans)}) ‚Äì 1 TONG</div>`;
          }
          if (hasGFPita && gfPitaMod) {
            const gfQty = gfPitaMod.gfPitaQty || (dip.qty * 6);
            // UPDATED: Use brown bowls - up to 6 GF pitas sliced per brown bowl
            const gfPitaBrownBowls = Math.ceil(gfQty / 6);
            brownBowls += gfPitaBrownBowls;
            hasPitaInAnyDip = true;
            const gfBowlLabel = gfPitaBrownBowls === 1 ? '1 brown bowl' : `${gfPitaBrownBowls} brown bowls`;
            html += `<div style="margin-left: 16px;">‚Üí ${gfQty} GF Pitas sliced 8 pieces (${gfBowlLabel}) ‚Äì 1 TONG</div>`;
          }
          if (!hasVeggies && !hasPita && !hasGFPita) {
            halfPans += dip.qty;
            html += `<div style="margin-left: 16px;">‚Üí ${dip.qty * 6} Pitas sliced 8 pieces OR ${dip.qty * 24} carrots + ${dip.qty * 24} celery</div>`;
          }
        });
        html += `</div>`;

        smallSpoons += prep.dips.length; // 1 small spoon per dip type
        if (hasVeggiesInAnyDip) tongs += 2; // 1 for carrots, 1 for celery
        if (hasPitaInAnyDip) tongs += 1; // 1 for pita
      }

      // GREEK FRIES (Regular & BYO Bar) - UPDATED
      if (prep.greekFries.length > 0) {
        html += `<h4 style="margin: 16px 0 12px 0; font-size: 14px; font-weight: 700; text-transform: uppercase; color: var(--gray-900);">GREEK FRIES</h4>`;
        html += `<div style="margin-left: 16px;">`;
        prep.greekFries.forEach(fries => {
          // Detect if this is Greek Fries BYO Bar (check for keywords BYO or BAR)
          const friesName = (fries.name || '').toUpperCase();
          const isByoBar = friesName.includes('BYO') || friesName.includes('BAR');

          // NEW PAN LOGIC:
          // < 2 orders ‚Üí 1 half pan per order
          // 2+ orders ‚Üí Combine 2 orders into 1 full pan
          let panContainer = '';
          if (fries.qty < 2) {
            halfPans += fries.qty;
            panContainer = fries.qty === 1 ? '1 half pan' : `${fries.qty} half pans`;
          } else {
            const fullPansNeeded = Math.floor(fries.qty / 2);
            const remainderHalfPans = fries.qty % 2;

            fullPans += fullPansNeeded;
            halfPans += remainderHalfPans;

            if (fullPansNeeded > 0 && remainderHalfPans > 0) {
              panContainer = `${fullPansNeeded} full pan${fullPansNeeded > 1 ? 's' : ''} (combined 2 orders each) + ${remainderHalfPans} half pan`;
            } else if (fullPansNeeded > 0) {
              panContainer = `${fullPansNeeded} full pan${fullPansNeeded > 1 ? 's' : ''} (combined 2 orders each)`;
            } else {
              panContainer = `${remainderHalfPans} half pan${remainderHalfPans > 1 ? 's' : ''}`;
            }
          }

          // Sauces: BYO Bar gets all 3, regular gets Aioli only
          if (isByoBar) {
            deliContainers += 3; // aioli, tzatziki, feta
            html += `<div>‚ñ° ${fries.qty}x ${fries.name} ‚Äì 1 TONG</div>`;
            html += `<div style="margin-left: 16px;">‚Üí ${panContainer} Greek Fries topped with protein</div>`;
            html += `<div style="margin-left: 16px;">‚Üí 16oz Spicy Aioli, 16oz Tzatziki, 16oz Crumbled Feta</div>`;
            html += `<div style="margin-left: 16px;">‚Üí 3 SMALL SPOONS (Aioli, Tzatziki, Feta)</div>`;
            smallSpoons += 3; // 3 sauces for BYO bar
          } else {
            deliContainers += 1; // aioli only
            html += `<div>‚ñ° ${fries.qty}x ${fries.name} ‚Äì 1 TONG</div>`;
            html += `<div style="margin-left: 16px;">‚Üí ${panContainer} Greek Fries topped with protein</div>`;
            html += `<div style="margin-left: 16px;">‚Üí 16oz Spicy Aioli</div>`;
            html += `<div style="margin-left: 16px;">‚Üí 1 SMALL SPOON (Aioli)</div>`;
            smallSpoons += 1; // 1 sauce for regular
          }
        });
        html += `</div>`;
        tongs += prep.greekFries.length; // 1 tong per greek fries type
      }

      // DOLMAS
      // 1 order = 12 dolmas
      // Tzatziki: 1x 16oz per 2 orders (round up)
      if (prep.dolmas.length > 0) {
        html += `<h4 style="margin: 16px 0 12px 0; font-size: 14px; font-weight: 700; text-transform: uppercase; color: var(--gray-900);">DOLMAS</h4>`;
        html += `<div style="margin-left: 16px;">`;

        prep.dolmas.forEach(dolma => {
          const totalOrders = dolma.qty;
          const totalPieces = totalOrders * 12;

          // UPDATED: Detect "cut in half" keywords in dolma name or modifiers
          const dolmaName = (dolma.name || '').toUpperCase();
          const modifiersText = (dolma.modifiers || []).map(m => (m.name || '').toUpperCase()).join(' ');
          const isCutInHalf = dolmaName.includes('CUT IN HALF') || dolmaName.includes('HALF') ||
                             modifiersText.includes('CUT IN HALF') || modifiersText.includes('HALF');

          // If cut in half, add bamboo picks (1 per half dolma piece = 24 per order)
          if (isCutInHalf) {
            bambooPicks += totalPieces * 2; // 12 dolmas cut in half = 24 pieces, need 24 picks
          }

          // Calculate tzatziki: 1x 16oz per 2 orders (round up)
          const tzatzikiCount = Math.ceil(totalOrders / 2);
          deliContainers += tzatzikiCount;

          // Container logic based on order quantity
          let containerInfo = '';
          let dolmaInstructions = '';

          if (totalOrders === 1) {
            // 1 order (12 pieces)
            brownBowls += 1;
            containerInfo = 'Brown Jayna bowl';
            dolmaInstructions = `
              <div style="margin-left: 16px; font-style: italic; color: var(--gray-600);">
                ‚Üí Bed of arugula + 6 lemon wedges
              </div>`;
            if (isCutInHalf) {
              dolmaInstructions += `
              <div style="margin-left: 16px; font-style: italic; color: var(--gray-600);">
                ‚Üí 24 bamboo picks (dolmas cut in half)
              </div>`;
            }
          } else if (totalOrders >= 2 && totalOrders <= 4) {
            // 2-4 orders (24-48 pieces)
            roundTrays += totalOrders; // estimate 1 tray per order for stacking
            containerInfo = `${totalOrders}x Round trays with dome lids (stack neatly)`;
            dolmaInstructions = `
              <div style="margin-left: 16px; font-style: italic; color: var(--gray-600);">
                ‚Üí Bed of arugula on each tray + 6 lemon wedges per tray (${totalOrders * 6} total)
              </div>`;
            if (isCutInHalf) {
              dolmaInstructions += `
              <div style="margin-left: 16px; font-style: italic; color: var(--gray-600);">
                ‚Üí ${totalPieces * 2} bamboo picks (dolmas cut in half)
              </div>`;
            }
          } else {
            // 5+ orders (60+ pieces)
            halfPans += 1;
            containerInfo = 'Half pan';
            dolmaInstructions = `
              <div style="margin-left: 16px; font-style: italic; color: var(--gray-600);">
                ‚Üí Bed of arugula + ${totalOrders * 6} lemon wedges (6 per order)
              </div>`;
            if (isCutInHalf) {
              dolmaInstructions += `
              <div style="margin-left: 16px; font-style: italic; color: var(--gray-600);">
                ‚Üí ${totalPieces * 2} bamboo picks (dolmas cut in half)
              </div>`;
            }
          }

          html += `<div>‚ñ° ${totalOrders}x ${dolma.name} (${totalPieces} pieces total) ‚Äì ${containerInfo} ‚Äì 1 TONG</div>`;
          html += dolmaInstructions;
          html += `<div style="margin-left: 16px;">‚Üí ${tzatzikiCount}x 16oz Tzatziki (with dill garnish) ‚Äì 1 SMALL SPOON</div>`;
        });

        html += `</div>`;
        tongs += prep.dolmas.length; // 1 tong per dolma type
        smallSpoons += prep.dolmas.length; // 1 small spoon per dolma type for tzatziki
      }

      // SPANAKOPITA - UPDATED: Specify black 18" catering tray
      if (prep.spanakopita.length > 0) {
        html += `<h4 style="margin: 16px 0 12px 0; font-size: 14px; font-weight: 700; text-transform: uppercase; color: var(--gray-900);">SPANAKOPITA</h4>`;
        html += `<div style="margin-left: 16px;">`;
        prep.spanakopita.forEach(span => {
          deliContainers += span.qty; // 16oz tzatziki per order
          html += `<div>‚ñ° ${span.qty}x ${span.name} (black round 18" catering tray with clear dome lid, on arugula OR ¬Ω/full pan) ‚Äì 1 TONG</div>`;
          html += `<div style="margin-left: 16px;">‚Üí ${span.qty}x 16oz Tzatziki (dill stripe) ‚Äì 1 SMALL SPOON</div>`;
        });
        html += `</div>`;
        tongs += prep.spanakopita.length; // 1 tong per spanakopita type
        smallSpoons += prep.spanakopita.length; // 1 small spoon per spanakopita type for tzatziki
      }

      // SIDES - UPDATED: Rice in half pan with SPOON only
      if (prep.sides.length > 0) {
        html += `<h4 style="margin: 16px 0 12px 0; font-size: 14px; font-weight: 700; text-transform: uppercase; color: var(--gray-900);">SIDES</h4>`;
        html += `<div style="margin-left: 16px;">`;
        prep.sides.forEach(side => {
          const sideName = (side.name || '').toUpperCase();
          const isRice = sideName.includes('RICE');
          if (isRice) {
            html += `<div>‚ñ° ${side.qty}x ${side.name} (Half Pan) ‚Äì 1 LARGE SERVING SPOON</div>`;
            largeServingSpoons += 1; // 1 large serving spoon for rice
          } else {
            html += `<div>‚ñ° ${side.qty}x ${side.name} ‚Äì <em>Packer must decide: 1 TONG or 1 SPOON</em></div>`;
            tongs += 1; // Default to tong for count, packer will decide
          }
        });
        html += `</div>`;
      }

      // DESSERTS - UPDATED: No tong for rice pudding
      if (prep.desserts.length > 0) {
        html += `<h4 style="margin: 16px 0 12px 0; font-size: 14px; font-weight: 700; text-transform: uppercase; color: var(--gray-900);">DESSERTS</h4>`;
        html += `<div style="margin-left: 16px;">`;
        prep.desserts.forEach(dessert => {
          const dessertName = (dessert.name || '').toUpperCase();
          const isRicePudding = dessertName.includes('RICE PUDDING');
          if (isRicePudding) {
            html += `<div>‚ñ° ${dessert.qty}x ${dessert.name}</div>`;
            // No tong for rice pudding
          } else {
            html += `<div>‚ñ° ${dessert.qty}x ${dessert.name} ‚Äì 1 TONG</div>`;
            tongs += 1; // 1 tong per non-rice-pudding dessert
          }
        });
        html += `</div>`;
      }

      // PINWHEELS - UPDATED: Specify black 18" tray on arugula
      if (prep.pinwheels.length > 0) {
        html += `<h4 style="margin: 16px 0 12px 0; font-size: 14px; font-weight: 700; text-transform: uppercase; color: var(--gray-900);">PINWHEELS</h4>`;
        html += `<div style="margin-left: 16px;">`;
        prep.pinwheels.forEach(pinwheel => {
          html += `<div>‚ñ° ${pinwheel.qty}x ${pinwheel.name} (black round 18" catering tray with clear dome lid, on bed of arugula) ‚Äì 1 TONG</div>`;
          tongs += 1; // 1 tong per pinwheel type
        });
        html += `</div>`;
      }

      // UNMAPPED ITEMS (items that don't fall into standard prep categories - e.g., drinks, special items)
      if (prep.unmapped && prep.unmapped.length > 0) {
        html += `<h4 style="margin: 16px 0 12px 0; font-size: 14px; font-weight: 700; text-transform: uppercase; color: var(--gray-900);">OTHER ITEMS (NOT IN STANDARD PREP)</h4>`;
        html += `<div style="margin-left: 16px; padding: 12px; background: var(--gray-100); border-left: 3px solid var(--gray-400);">`;
        html += `<div style="font-size: 12px; font-style: italic; color: var(--gray-700); margin-bottom: 8px;">The following items were ordered but don't fall into standard prep categories. Please prepare as specified:</div>`;
        prep.unmapped.forEach(item => {
          html += `<div style="margin-bottom: 4px;">‚ñ° ${item.qty}x ${item.name}`;
          if (item.modifiers && item.modifiers.length > 0) {
            item.modifiers.forEach(mod => {
              html += `<div style="margin-left: 20px; font-size: 11px; color: var(--gray-600);">+ ${mod.name || mod}</div>`;
            });
          }
          html += `</div>`;
        });
        html += `</div>`;
      }

      // SPECIAL NOTES
      if (order.delivery_notes) {
        html += `<h4 style="margin: 16px 0 12px 0; font-size: 14px; font-weight: 700; text-transform: uppercase; color: var(--gray-900);">SPECIAL NOTES</h4>`;
        html += `<div style="margin-left: 16px; padding: 12px; background: var(--gray-100); border-left: 3px solid var(--gray-400);">`;
        html += `${order.delivery_notes}`;
        html += `</div>`;
      }

      html += '</div>';

      // Add ORDER MUST BE READY AT (40 minutes before delivery)
      let readyBySection = '';
      if (order.delivery_time) {
        const deliveryTime = new Date(order.delivery_time);
        const readyByTime = new Date(deliveryTime.getTime() - 40 * 60000); // 40 minutes before
        const readyByStr = readyByTime.toLocaleTimeString('en-US', {
          hour: '2-digit',
          minute: '2-digit',
          hour12: true,
          timeZone: 'America/Los_Angeles'
        });
        readyBySection = `
          <div style="margin-bottom: 16px; padding: 16px; background: var(--gray-100); border: 3px solid var(--gray-700);">
            <h3 style="margin: 0; font-size: 16px; font-weight: 700; text-transform: uppercase; color: var(--gray-900);">ORDER MUST BE READY AT EXACTLY: ${readyByStr}</h3>
          </div>
        `;
      }

      // Add containers summary at the top
      // Combine full pans and half pans into a single formatted count
      const totalHalfPanEquivalent = (fullPans * 2) + halfPans;

      const containerSummary = `
        <div style="margin-bottom: 16px; padding: 16px; background: var(--gray-100); border: 2px solid var(--gray-300);">
          <h3 style="margin: 0 0 12px 0; font-size: 14px; font-weight: 700; text-transform: uppercase; color: var(--gray-900);">CONTAINERS NEEDED</h3>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 13px; color: var(--gray-700);">
            ${totalHalfPanEquivalent > 0 ? `<div>‚Ä¢ ${formatPanCount(totalHalfPanEquivalent)}</div>` : ''}
            ${roundTrays > 0 ? `<div>‚Ä¢ ${roundTrays}x Round Trays with Dome Lids</div>` : ''}
            ${deliContainers > 0 ? `<div>‚Ä¢ ${deliContainers}x 16oz Deli Containers</div>` : ''}
            ${deli32ozContainers > 0 ? `<div>‚Ä¢ ${deli32ozContainers}x 32oz Deli Containers</div>` : ''}
            ${brownBowls > 0 ? `<div>‚Ä¢ ${brownBowls}x Brown Jayna Bowls</div>` : ''}
            ${bambooPicks > 0 ? `<div>‚Ä¢ Bamboo picks (for dolmas)</div>` : ''}
          </div>
        </div>
      `;

      // Add utensils summary (separate section for packer)
      const utensilsSummary = `
        <div style="margin-bottom: 24px; padding: 16px; background: var(--gray-100); border: 2px solid var(--gray-300);">
          <h3 style="margin: 0 0 12px 0; font-size: 14px; font-weight: 700; text-transform: uppercase; color: var(--gray-900);">UTENSILS TO PACK</h3>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 13px; color: var(--gray-700);">
            ${tongs > 0 ? `<div>‚Ä¢ ${tongs}x Tongs</div>` : ''}
            ${largeServingSpoons > 0 ? `<div>‚Ä¢ ${largeServingSpoons}x Large Serving Spoons</div>` : ''}
            ${smallSpoons > 0 ? `<div>‚Ä¢ ${smallSpoons}x Small Spoons</div>` : ''}
          </div>
        </div>
      `;

      return readyBySection + containerSummary + utensilsSummary + html;
    }

    /**
     * Toggle prep list visibility in modal
     */
    function togglePrepList(orderId) {
      const prepListSection = document.getElementById('prepListSection');
      if (!prepListSection) return;

      if (prepListSection.style.display === 'none') {
        prepListSection.style.display = 'block';
      } else {
        prepListSection.style.display = 'none';
      }
    }

    // Print Toast order to Epson printer via Gmail
    async function printToastOrder(event, orderId) {
      try {
        console.log(`üñ®Ô∏è Printing Toast order ${orderId}...`);
        showLoading('PRINTING ORDER', 'Sending order to printer...');

        const response = await fetch('/api/print-toast-order', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ order_id: orderId })
        });

        const result = await response.json();

        hideLoading();

        if (!result.success) {
          console.error(`‚ùå Failed to print order: ${result.error}`);
          // Show error in modal by updating button text temporarily
          const printBtn = event.target;
          const originalText = printBtn.textContent;
          printBtn.textContent = 'PRINT FAILED - SEE CONSOLE';
          printBtn.style.background = '#dc2626';
          setTimeout(() => {
            printBtn.textContent = originalText;
            printBtn.style.background = 'var(--primary-blue)';
          }, 3000);
          return;
        }

        console.log(`‚úÖ Order sent to printer successfully:`, result.messageId);

        // Show success feedback in button
        const printBtn = event.target;
        const originalText = printBtn.textContent;
        printBtn.textContent = '‚úì SENT TO PRINTER';
        printBtn.style.background = '#059669';
        setTimeout(() => {
          printBtn.textContent = originalText;
          printBtn.style.background = 'var(--primary-blue)';
        }, 2000);

        // Show prominent success modal
        showSuccessMessage('‚úÖ ORDER SENT TO PRINTER!', 'The order has been emailed to the Epson printer successfully.');

      } catch (error) {
        hideLoading();
        console.error('‚ùå Error printing order:', error);
        const printBtn = event.target;
        const originalText = printBtn.textContent;
        printBtn.textContent = 'PRINT ERROR';
        printBtn.style.background = '#dc2626';
        setTimeout(() => {
          printBtn.textContent = originalText;
          printBtn.style.background = 'var(--primary-blue)';
        }, 3000);
      }
    }

    // Download Toast Order PDF (for testing/verification)
    async function downloadToastOrderPDF(event, orderId) {
      try {
        console.log(`üì• Downloading Toast order PDF for order ${orderId}...`);
        showLoading('GENERATING PDF', 'Creating order PDF...');

        const response = await fetch('/api/print-toast-order?download=true', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ order_id: orderId })
        });

        hideLoading();

        if (!response.ok) {
          const result = await response.json();
          console.error(`‚ùå Failed to generate order PDF: ${result.error}`);
          const downloadBtn = event.target;
          const originalText = downloadBtn.textContent;
          downloadBtn.textContent = 'DOWNLOAD FAILED';
          downloadBtn.style.background = '#dc2626';
          setTimeout(() => {
            downloadBtn.textContent = originalText;
            downloadBtn.style.background = '#047857';
          }, 3000);
          return;
        }

        // Get the PDF blob
        const blob = await response.blob();

        // Create download link
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `Toast_Order_${orderId}_${new Date().toISOString().split('T')[0]}.pdf`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);

        console.log(`‚úÖ Order PDF downloaded successfully`);

        // Show success feedback in button
        const downloadBtn = event.target;
        const originalText = downloadBtn.textContent;
        downloadBtn.textContent = '‚úì DOWNLOADED';
        downloadBtn.style.background = '#047857';
        setTimeout(() => {
          downloadBtn.textContent = originalText;
          downloadBtn.style.background = '#047857';
        }, 2000);

      } catch (error) {
        hideLoading();
        console.error('‚ùå Error downloading order PDF:', error);
        const downloadBtn = event.target;
        const originalText = downloadBtn.textContent;
        downloadBtn.textContent = 'DOWNLOAD ERROR';
        downloadBtn.style.background = '#dc2626';
        setTimeout(() => {
          downloadBtn.textContent = originalText;
          downloadBtn.style.background = '#047857';
        }, 3000);
      }
    }

    /**
     * Export container labels as CSV for Phomemo Print Master app
     * Generates one label per container with:
     * - Menu title (guest-facing name)
     * - Quantity/portions
     * - Pan numbers (1 of 2, 2 of 2, etc.)
     * - Jayna Gyro Catering header
     * - Pack date
     * - Customer name + phone
     */
    async function exportLabelsCSV(event, orderId) {
      try {
        event.preventDefault();
        console.log(`üè∑Ô∏è Generating labels for order ${orderId}...`);
        showLoading('GENERATING LABELS', 'Creating Excel files for batch printing...');

        // Fetch order and line items via API
        const response = await fetch(`/api/get-order-items?order_id=${orderId}`);
        const result = await response.json();

        if (!result.success) {
          hideLoading();
          console.error('Failed to load order:', result.error);
          return;
        }

        const { order, lineItems } = result.data;

        // Calculate prep list
        const prep = calculatePrepList(lineItems, order);

        // Generate labels
        const labels = generateLabelsFromPrep(prep, order);

        if (labels.length === 0) {
          hideLoading();
          console.log('No containers found to label for this order.');
          return;
        }

        // Format filenames
        const guestName = (order.customer_name || 'Customer').replace(/[^a-zA-Z0-9 ]/g, '').trim().replace(/\s+/g, '_');
        const orderDate = order.delivery_date ? formatPacificDateShort(order.delivery_date) : formatPacificDateShort(getPacificToday());

        // FILE 1: Generate main labels Excel (all items with 4 columns)
        const labelsBlob = await generateLabelsExcel(labels);
        const labelsFileName = `Labels_${guestName}_${orderDate}.xlsx`;

        // FILE 2: Generate ingredient labels Excel (sauces only with 2 columns)
        const ingredientLabels = generateIngredientLabels(labels);
        const ingredientsBlob = await generateIngredientsExcel(ingredientLabels);
        const ingredientsFileName = `Labels_Ingredients_${guestName}_${orderDate}.xlsx`;

        // Download FILE 1 (main labels)
        const link1 = document.createElement('a');
        link1.href = URL.createObjectURL(labelsBlob);
        link1.download = labelsFileName;
        link1.style.display = 'none';
        document.body.appendChild(link1);
        link1.click();

        // Download FILE 2 (ingredient labels) after 500ms delay
        setTimeout(() => {
          const link2 = document.createElement('a');
          link2.href = URL.createObjectURL(ingredientsBlob);
          link2.download = ingredientsFileName;
          link2.style.display = 'none';
          document.body.appendChild(link2);
          link2.click();

          // Cleanup both
          setTimeout(() => {
            document.body.removeChild(link1);
            document.body.removeChild(link2);
            URL.revokeObjectURL(link1.href);
            URL.revokeObjectURL(link2.href);
          }, 100);
        }, 500);

        hideLoading();

        console.log(`‚úÖ LABELS EXPORTED!`);
        console.log(`üìÑ File 1: ${labelsFileName} (${labels.length} labels)`);
        console.log(`üìÑ File 2: ${ingredientsFileName} (${ingredientLabels.length} ingredient labels)`);
        console.log(`üì± Next steps:
1. Find the 2 downloaded Excel files in your Downloads folder
2. Open Print Master app on your phone
3. Import File 1 for main labels (4-column template)
4. Import File 2 for ingredient labels (2-column template)
5. Print your batch labels!`);

      } catch (error) {
        console.error('‚ùå Label export error:', error);
        hideLoading();
      }
    }

    /**
     * Print 3-Inch Round Labels to Epson Printer
     * Generates PDF with 6 labels per page (2 columns x 3 rows)
     * Sends to printer via email (empty body, PDF attachment only)
     */
    async function print3InchLabels(event, orderId) {
      try {
        event.preventDefault();
        console.log(`üñ®Ô∏è Generating 3" labels for order ${orderId}...`);
        showLoading('CALCULATING LABELS', 'Preparing label count...');

        // First, generate PDF to get metadata (label count)
        const metadataResponse = await fetch(`/api/print-3inch-labels?download=true`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ order_id: orderId })
        });

        hideLoading();

        if (!metadataResponse.ok) {
          const result = await metadataResponse.json();
          console.error(`‚ùå Failed to generate 3" labels PDF: ${result.error}`);
          alert(`Failed to generate labels: ${result.error}`);
          return;
        }

        // Get the PDF blob
        const blob = await metadataResponse.blob();

        // Read page count from response headers
        const pageCount = parseInt(metadataResponse.headers.get('X-Page-Count') || '1');
        const totalLabels = parseInt(metadataResponse.headers.get('X-Total-Labels') || '0');
        const itemLabels = parseInt(metadataResponse.headers.get('X-Item-Labels') || '0');
        const ingredientLabels = parseInt(metadataResponse.headers.get('X-Ingredient-Labels') || '0');

        console.log(`üìä Label summary: ${totalLabels} total (${itemLabels} items + ${ingredientLabels} ingredients) = ${pageCount} pages`);

        // PRINT MODE ACTIVATED üñ®Ô∏è
        showPrintConfirmationPopup(orderId, pageCount);

      } catch (error) {
        console.error('‚ùå 3" labels error:', error);
        hideLoading();
        alert(`Error generating 3" labels: ${error.message}`);
      }
    }

    /**
     * Show print confirmation popup with page count
     * Google Sites friendly (pure DOM, no external dependencies)
     */
    function showPrintConfirmationPopup(orderId, pageCount) {
      // Create modal overlay
      const overlay = document.createElement('div');
      overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
      `;

      // Create modal content
      const modal = document.createElement('div');
      modal.style.cssText = `
        background: white;
        padding: 32px;
        max-width: 500px;
        width: 90%;
        border: 3px solid var(--gray-700);
      `;

      // Header
      const header = document.createElement('h2');
      header.textContent = 'PRINT 3" LABELS';
      header.style.cssText = `
        margin: 0 0 20px 0;
        font-size: 20px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: var(--gray-900);
      `;
      modal.appendChild(header);

      // Instructions
      const instructions = document.createElement('div');
      instructions.style.cssText = `
        background: var(--blue-bg);
        border: 2px solid #3b82f6;
        padding: 16px;
        margin-bottom: 24px;
      `;
      instructions.innerHTML = `
        <p style="margin: 0 0 12px 0; font-size: 14px; font-weight: 700; color: #1e40af;">
          LOAD LABEL SHEETS INTO PRINTER
        </p>
        <p style="margin: 0; font-size: 16px; font-weight: 700; color: #1e40af;">
          üìÑ ${pageCount} ${pageCount === 1 ? 'SHEET' : 'SHEETS'} REQUIRED
        </p>
      `;
      modal.appendChild(instructions);

      // Button group
      const buttonGroup = document.createElement('div');
      buttonGroup.style.cssText = 'display: flex; gap: 12px; justify-content: flex-end;';

      // Cancel button
      const cancelBtn = document.createElement('button');
      cancelBtn.textContent = 'CANCEL';
      cancelBtn.style.cssText = `
        padding: 14px 28px;
        background: var(--gray-100);
        border: 2px solid var(--gray-300);
        color: var(--gray-900);
        font-size: 13px;
        font-weight: 700;
        cursor: pointer;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      `;
      cancelBtn.onclick = () => {
        document.body.removeChild(overlay);
      };
      buttonGroup.appendChild(cancelBtn);

      // Download button
      const downloadBtn = document.createElement('button');
      downloadBtn.textContent = 'üì• DOWNLOAD';
      downloadBtn.style.cssText = `
        padding: 14px 28px;
        background: #3b82f6;
        border: 2px solid #3b82f6;
        color: white;
        font-size: 13px;
        font-weight: 700;
        cursor: pointer;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      `;
      downloadBtn.onclick = async () => {
        // Disable button and show loading state
        downloadBtn.disabled = true;
        downloadBtn.style.opacity = '0.6';
        downloadBtn.style.cursor = 'not-allowed';
        downloadBtn.textContent = 'DOWNLOADING...';

        try {
          // Call API in DOWNLOAD mode
          const response = await fetch(`/api/print-3inch-labels?download=true`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ order_id: orderId })
          });

          if (!response.ok) {
            throw new Error('Failed to download PDF');
          }

          // Get the PDF blob
          const blob = await response.blob();

          // Download the PDF
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `3Inch_Labels_Order_${orderId}_${new Date().toISOString().split('T')[0]}.pdf`;
          a.style.display = 'none';
          document.body.appendChild(a);
          a.click();

          // Cleanup
          setTimeout(() => {
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
          }, 100);

          // Success feedback - turn button green
          downloadBtn.style.background = '#059669';
          downloadBtn.style.borderColor = '#059669';
          downloadBtn.textContent = '‚úÖ DOWNLOADED!';

          // Close popup after 1.5 seconds
          setTimeout(() => {
            document.body.removeChild(overlay);
          }, 1500);

        } catch (error) {
          console.error('‚ùå Download error:', error);

          // Error feedback - turn button red
          downloadBtn.style.background = '#dc2626';
          downloadBtn.style.borderColor = '#dc2626';
          downloadBtn.textContent = '‚ùå FAILED';

          // Re-enable after 2 seconds
          setTimeout(() => {
            downloadBtn.disabled = false;
            downloadBtn.style.opacity = '1';
            downloadBtn.style.cursor = 'pointer';
            downloadBtn.style.background = '#3b82f6';
            downloadBtn.style.borderColor = '#3b82f6';
            downloadBtn.textContent = 'üì• DOWNLOAD';
          }, 2000);
        }
      };
      buttonGroup.appendChild(downloadBtn);

      // Print Now button
      const printBtn = document.createElement('button');
      printBtn.textContent = 'üñ®Ô∏è PRINT NOW';
      printBtn.style.cssText = `
        padding: 14px 28px;
        background: var(--gray-900);
        border: 2px solid var(--gray-900);
        color: white;
        font-size: 13px;
        font-weight: 700;
        cursor: pointer;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      `;
      printBtn.onclick = async () => {
        // Disable button and show loading state
        printBtn.disabled = true;
        printBtn.style.opacity = '0.6';
        printBtn.style.cursor = 'not-allowed';
        printBtn.textContent = 'SENDING TO PRINTER...';

        try {
          // Call API in PRINT mode (download=false)
          const response = await fetch(`/api/print-3inch-labels`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ order_id: orderId })
          });

          if (!response.ok) {
            throw new Error('Failed to send to printer');
          }

          // Success feedback - turn button green
          printBtn.style.background = '#059669';
          printBtn.style.borderColor = '#059669';
          printBtn.textContent = '‚úÖ SENT TO PRINTER!';

          // Close popup after 1.5 seconds
          setTimeout(() => {
            document.body.removeChild(overlay);
          }, 1500);

        } catch (error) {
          console.error('‚ùå Print error:', error);

          // Error feedback - turn button red
          printBtn.style.background = '#dc2626';
          printBtn.style.borderColor = '#dc2626';
          printBtn.textContent = '‚ùå FAILED';

          // Re-enable after 2 seconds
          setTimeout(() => {
            printBtn.disabled = false;
            printBtn.style.opacity = '1';
            printBtn.style.cursor = 'pointer';
            printBtn.style.background = 'var(--gray-900)';
            printBtn.style.borderColor = 'var(--gray-900)';
            printBtn.textContent = 'üñ®Ô∏è PRINT NOW';
          }, 2000);
        }
      };
      buttonGroup.appendChild(printBtn);

      modal.appendChild(buttonGroup);
      overlay.appendChild(modal);
      document.body.appendChild(overlay);

      // Close on overlay click
      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) {
          document.body.removeChild(overlay);
        }
      });
    }

    /**
     * Map old label names to new ALL CAPS names
     * Based on user-provided mapping in LABEL_NAME_MAPPING.xlsx
     */
    function getLabelName(currentName, context = {}) {
      // Name mapping dictionary
      const nameMap = {
        // BYO GYROS
        'Tzatziki Sauce': 'TZATZIKI',
        'Spicy Aioli Sauce': 'SPICY AIOLI',
        'Lemon Vinaigrette': 'LEMON VINAIGRETTE',
        'Mixed Greens': 'MIXED GREENS',
        'Diced Tomatoes': 'DICED TOMATOES',
        'Sliced Red Onion': 'RED ONIONS',
        'Whole Pepperoncini': 'PEPPERONCINI',
        'Grilled Pita Bread': 'GRILLED PITA',

        // SALADS
        'Jayna House Salad': 'JAYNA HOUSE SALAD',
        'Greek Salad': 'GREEK SALAD',
        'Mediterranean Chopped Salad': 'MEDITERRANEAN CHOPPED SALAD',

        // DIPS
        'Hummus': 'HUMMUS',
        'Tzatziki': 'TZATZIKI',
        'Baba Ganoush': 'BABA GANOUSH',

        // GREEK FRIES BAR
        'Greek Fries + Protein': 'GREEK FRIES + PROTEIN', // Will be replaced dynamically

        // SIDES
        'Greek Fries (side)': 'GREEK FRIES',
        'Rice Pilaf': 'RICE WITH CHICKPEAS',

        // DESSERTS
        'WALNUT Baklava': 'WALNUT BAKLAVA',
        'Walnut Baklava': 'WALNUT BAKLAVA',
        'PISTACHIO Baklava': 'PISTACHIO BAKLAVA',
        'Pistachio Baklava': 'PISTACHIO BAKLAVA',
        'BAKLAVA CHOCOLATE': 'CHOCOLATE BAKLAVA',
        'Chocolate Baklava': 'CHOCOLATE BAKLAVA',
        'Baklava': 'BAKLAVA', // Generic fallback

        // PINWHEELS
        'Chicken Pinwheels': 'CHICKEN GYRO PINWHEELS',
        'BEEF & LAMB PINWHEELS': 'BEEF & LAMB GYRO PINWHEELS',
        'Beef & Lamb Pinwheels': 'BEEF & LAMB GYRO PINWHEELS'
      };

      // Handle salad dressings: "Salad Name - Lemon Vinaigrette" ‚Üí "LEMON VINAIGRETTE (SALAD NAME)"
      if (currentName.includes(' - Lemon Vinaigrette')) {
        const saladName = currentName.replace(' - Lemon Vinaigrette', '');
        const mappedSaladName = getLabelName(saladName, context);

        // Shorten salad names for dressing labels
        const shortName = mappedSaladName
          .replace('JAYNA HOUSE SALAD', 'HOUSE SALAD')
          .replace('MEDITERRANEAN CHOPPED SALAD', 'MED CHOP SALAD');

        return `LEMON VINAIGRETTE (${shortName})`;
      }

      // Handle dip sides
      if (currentName.includes(' - Veggie Sticks (Carrots)')) {
        return 'VEGGIE STICKS (CARROTS)';
      }
      if (currentName.includes(' - Veggie Sticks (Celery)')) {
        return 'VEGGIE STICKS (CELERY)';
      }
      if (currentName.includes(' - Sliced Pita Bread')) {
        const dipName = currentName.split(' - ')[0];
        const mappedDipName = getLabelName(dipName, context);
        return `SLICED PITA - ${mappedDipName}`;
      }
      if (currentName.includes(' - GF Pita Bread')) {
        return 'SLICED GF PITA';
      }

      // Handle Greek Fries Bar toppings
      if (currentName === 'Greek Fries - Spicy Aioli') {
        return 'SPICY AIOLI (GREEK FRIES BAR)';
      }
      if (currentName === 'Greek Fries - Tzatziki') {
        return 'TZATZIKI (GREEK FRIES BAR)';
      }
      if (currentName === 'Greek Fries - Crumbled Feta') {
        return 'CRUMBLED FETA (GREEK FRIES BAR)';
      }

      // Handle Dolmas
      if (currentName.includes('Dolmas')) {
        if (currentName.includes('Tzatziki')) {
          return 'TZATZIKI (DOLMAS)';
        }
        return 'DOLMAS (1 DOZEN)';
      }

      // Handle Spanakopita
      if (currentName.includes('Spanakopita')) {
        if (currentName.includes('Tzatziki')) {
          return 'TZATZIKI (SPANAKOPITA)';
        }
        if (currentName.includes('CUT IN HALF')) {
          return 'SPANAKOPITA (CUT IN HALF)';
        }
        return 'SPANAKOPITA';
      }

      // Check name map
      if (nameMap[currentName]) {
        return nameMap[currentName];
      }

      // Fallback: Convert to uppercase
      return currentName.toUpperCase();
    }

    /**
     * Generate label data from prep list
     * Each label includes: company header, menu item, quantity, pan number, date, customer info
     */
    function generateLabelsFromPrep(prep, order) {
      const labels = [];
      const orderNum = order.order_number || order.id;
      const customerName = order.customer_name || 'Customer';
      const customerLastName = customerName.split(' ').pop(); // Get last name
      const phoneNumber = order.phone_number || '';

      // Format pack date in Pacific time (device-independent)
      let packDate;
      if (order.delivery_date) {
        const [year, month, day] = order.delivery_date.split('-').map(Number);
        const utcDate = new Date(Date.UTC(year, month - 1, day, 12, 0, 0));
        packDate = new Intl.DateTimeFormat('en-US', {
          month: 'short',
          day: 'numeric',
          year: 'numeric',
          timeZone: 'America/Los_Angeles'
        }).format(utcDate);
      } else {
        const now = new Date();
        packDate = new Intl.DateTimeFormat('en-US', {
          month: 'short',
          day: 'numeric',
          year: 'numeric',
          timeZone: 'America/Los_Angeles'
        }).format(now);
      }

      // BYO GYRO PITAS
      if (prep.byoGyros.total > 0) {
        const sets = Math.ceil(prep.byoGyros.total / 10);
        const greensSets = Math.ceil(prep.byoGyros.total / 15); // UPDATED: 1 set per 15 portions

        // === PROTEIN LABELS (ALWAYS FIRST) ===
        const proteinPans = calculateProteinPans(prep.byoGyros.items || []);
        proteinPans.forEach(protein => {
          // Extract container type for label
          let containerLabel = '';
          if (protein.container.includes('BROWN BOWLS')) {
            containerLabel = 'BROWN BOWLS';
          } else if (protein.container.includes('HALF PAN')) {
            // Parse "1 HALF PAN" or "3 FULL PANS, 1 HALF PAN"
            containerLabel = protein.container;
          } else if (protein.container.includes('FULL PAN')) {
            containerLabel = protein.container;
          }

          labels.push({
            item: protein.name,
            qty: containerLabel,
            pan: '',
            category: 'BYO Gyros - Proteins',
            orderNum,
            customerLastName,
            phoneNumber,
            packDate
          });
        });

        // Sauce containers (16oz deli, 3 per set)
        for (let i = 1; i <= sets; i++) {
          labels.push({ item: getLabelName('Tzatziki Sauce'), qty: sets > 1 ? `16OZ DELI - ${i} OF ${sets}` : `16OZ DELI - 1 OF 1`, pan: '', category: 'BYO Gyros', orderNum, customerLastName, phoneNumber, packDate });
          labels.push({ item: getLabelName('Spicy Aioli Sauce'), qty: sets > 1 ? `16OZ DELI - ${i} OF ${sets}` : `16OZ DELI - 1 OF 1`, pan: '', category: 'BYO Gyros', orderNum, customerLastName, phoneNumber, packDate });
          labels.push({ item: getLabelName('Lemon Vinaigrette'), qty: sets > 1 ? `16OZ DELI - ${i} OF ${sets}` : `16OZ DELI - 1 OF 1`, pan: '', category: 'BYO Gyros', orderNum, customerLastName, phoneNumber, packDate });
        }

        // Mixed Greens - UPDATED to use greensSets (1 per 15 portions)
        const greensHalfPans = greensSets;
        const greensFullPans = Math.ceil(greensSets / 2);
        for (let i = 1; i <= greensFullPans; i++) {
          labels.push({ item: getLabelName('Mixed Greens'), qty: greensFullPans > 1 ? `FULL PAN - ${i} OF ${greensFullPans}` : `FULL PAN - 1 OF 1`, pan: '', category: 'BYO Gyros', orderNum, customerLastName, phoneNumber, packDate });
        }

        // COORDINATED BROWN BOWL LOGIC FOR TOMATOES, ONIONS, PEPPERONCINI (PDF Labels)
        // If ANY of these 3 items naturally gets a brown bowl, ALL 3 get brown bowls
        let useBrownBowlForAllLabels = false;

        // UPDATED THRESHOLDS:
        // Check if tomatoes would naturally use brown bowl (10-25 portions)
        const tomatoNaturallyUsesBrownBowlLabels = (prep.byoGyros.total >= 10 && prep.byoGyros.total <= 25);

        // Check if onions would naturally use brown bowl (20-45 portions)
        const onionNaturallyUsesBrownBowlLabels = (prep.byoGyros.total >= 20 && prep.byoGyros.total <= 45);

        // Check if pepperoncini would naturally use 32oz (which acts like brown bowl - 10-30 portions)
        const pepperonciniNaturallyUses32ozLabels = (prep.byoGyros.total >= 10 && prep.byoGyros.total <= 30);

        // If any naturally gets brown bowl or 32oz, all three get brown bowls
        if (tomatoNaturallyUsesBrownBowlLabels || onionNaturallyUsesBrownBowlLabels || pepperonciniNaturallyUses32ozLabels) {
          useBrownBowlForAllLabels = true;
        }

        // DICED TOMATOES - UPDATED
        // 50 portions per half pan (was 30)
        // Below 10: 16oz deli container
        // 10-25: Brown Jayna bowl (was 10-20)
        // 26+: Calculate half pans (50 portions per half pan)
        let tomatoContainerType = '';
        let tomatoContainerCount = 0;

        if (useBrownBowlForAllLabels) {
          tomatoContainerType = 'brown bowl';
          tomatoContainerCount = 1;
        } else if (prep.byoGyros.total < 10) {
          tomatoContainerType = '16oz deli';
          tomatoContainerCount = 1;
        } else if (prep.byoGyros.total <= 25) {
          tomatoContainerType = 'brown bowl';
          tomatoContainerCount = 1;
        } else {
          tomatoContainerType = 'half pan';
          tomatoContainerCount = Math.ceil(prep.byoGyros.total / 50);
        }

        // Generate tomato labels (one per container)
        for (let i = 1; i <= tomatoContainerCount; i++) {
          const containerLabel = tomatoContainerType.toUpperCase();
          labels.push({
            item: getLabelName('Diced Tomatoes'),
            qty: tomatoContainerCount > 1 ? `${containerLabel} - ${i} OF ${tomatoContainerCount}` : `${containerLabel} - 1 OF 1`,
            pan: '',
            category: 'BYO Gyros',
            orderNum,
            customerLastName,
            phoneNumber,
            packDate
          });
        }

        // SLICED RED ONION - UPDATED
        // 75 portions per half pan (was 50)
        // Below 20: 16oz deli container
        // 20-45: Brown Jayna bowl
        // 46+: Calculate half pans (75 portions per half pan)
        let onionContainerType = '';
        let onionContainerCount = 0;

        if (useBrownBowlForAllLabels) {
          onionContainerType = 'brown bowl';
          onionContainerCount = 1;
        } else if (prep.byoGyros.total < 20) {
          onionContainerType = '16oz deli';
          onionContainerCount = 1;
        } else if (prep.byoGyros.total <= 45) {
          onionContainerType = 'brown bowl';
          onionContainerCount = 1;
        } else {
          onionContainerType = 'half pan';
          onionContainerCount = Math.ceil(prep.byoGyros.total / 75);
        }

        // Generate onion labels (one per container)
        for (let i = 1; i <= onionContainerCount; i++) {
          const containerLabel = onionContainerType.toUpperCase();
          labels.push({
            item: getLabelName('Sliced Red Onion'),
            qty: onionContainerCount > 1 ? `${containerLabel} - ${i} OF ${onionContainerCount}` : `${containerLabel} - 1 OF 1`,
            pan: '',
            category: 'BYO Gyros',
            orderNum,
            customerLastName,
            phoneNumber,
            packDate
          });
        }

        // WHOLE PEPPERONCINI - UPDATED
        // Below 10: 16oz deli container
        // 10-30: 32oz deli container (was 10-20)
        // 31-99: Half pan (was 21-99)
        // 100+: Full pan(s) + half pan if remainder
        // COORDINATED LOGIC: If tomatoes OR onions use brown bowl, pepperoncini also uses brown bowl
        let pepperonciniContainerType = '';
        let pepperonciniContainerCount = 0;

        if (useBrownBowlForAllLabels) {
          pepperonciniContainerType = 'brown bowl';
          pepperonciniContainerCount = 1;
        } else if (prep.byoGyros.total < 10) {
          pepperonciniContainerType = '16oz deli';
          pepperonciniContainerCount = 1;
        } else if (prep.byoGyros.total <= 30) {
          pepperonciniContainerType = '32oz deli';
          pepperonciniContainerCount = 1;
        } else if (prep.byoGyros.total < 100) {
          pepperonciniContainerType = 'half pan';
          pepperonciniContainerCount = 1;
        } else {
          const pepperFullPans = Math.floor(prep.byoGyros.total / 100);
          const pepperRemainder = prep.byoGyros.total % 100;

          // Generate full pan labels
          for (let i = 1; i <= pepperFullPans; i++) {
            labels.push({
              item: getLabelName('Whole Pepperoncini'),
              qty: pepperFullPans > 1 ? `FULL PAN - ${i} OF ${pepperFullPans}` : `FULL PAN - 1 OF 1`,
              pan: '',
              category: 'BYO Gyros',
              orderNum,
              customerLastName,
              phoneNumber,
              packDate
            });
          }

          // Generate half pan label if remainder
          if (pepperRemainder > 0) {
            labels.push({
              item: getLabelName('Whole Pepperoncini'),
              qty: `HALF PAN - 1 OF 1`,
              pan: '',
              category: 'BYO Gyros',
              orderNum,
              customerLastName,
              phoneNumber,
              packDate
            });
          }

          // Skip the normal label generation below since we handled it above
          pepperonciniContainerCount = 0;
        }

        // Generate pepperoncini labels (one per container) - only if not 100+
        for (let i = 1; i <= pepperonciniContainerCount; i++) {
          const containerLabel = pepperonciniContainerType.toUpperCase();
          labels.push({
            item: getLabelName('Whole Pepperoncini'),
            qty: pepperonciniContainerCount > 1 ? `${containerLabel} - ${i} OF ${pepperonciniContainerCount}` : `${containerLabel} - 1 OF 1`,
            pan: '',
            category: 'BYO Gyros',
            orderNum,
            customerLastName,
            phoneNumber,
            packDate
          });
        }

        // PITAS - UPDATED WITH NEW TIERED LOGIC
        // 2-12: Half pan
        // 13-25: Full pan
        // 26+: Full pans (25 per pan), then half pan if remainder <12, or full pan if remainder 13-25
        const pitasNeeded = prep.byoGyros.total + Math.ceil(prep.byoGyros.total / 10);

        if (pitasNeeded >= 2 && pitasNeeded <= 12) {
          labels.push({
            item: getLabelName('Grilled Pita Bread'),
            qty: 'HALF PAN - 1 OF 1',
            pan: '',
            category: 'BYO Gyros',
            orderNum,
            customerLastName,
            phoneNumber,
            packDate
          });
        } else if (pitasNeeded >= 13 && pitasNeeded <= 25) {
          labels.push({
            item: getLabelName('Grilled Pita Bread'),
            qty: 'FULL PAN - 1 OF 1',
            pan: '',
            category: 'BYO Gyros',
            orderNum,
            customerLastName,
            phoneNumber,
            packDate
          });
        } else if (pitasNeeded >= 26) {
          const pitaFullPansNeeded = Math.floor(pitasNeeded / 25);
          const pitaRemainder = pitasNeeded % 25;

          // Generate full pan labels
          for (let i = 1; i <= pitaFullPansNeeded; i++) {
            labels.push({
              item: getLabelName('Grilled Pita Bread'),
              qty: pitaFullPansNeeded > 1 ? `FULL PAN - ${i} OF ${pitaFullPansNeeded}` : `FULL PAN - 1 OF 1`,
              pan: '',
              category: 'BYO Gyros',
              orderNum,
              customerLastName,
              phoneNumber,
              packDate
            });
          }

          // Generate half pan label if remainder is 2-12
          if (pitaRemainder >= 2 && pitaRemainder <= 12) {
            labels.push({
              item: getLabelName('Grilled Pita Bread'),
              qty: 'HALF PAN - 1 OF 1',
              pan: '',
              category: 'BYO Gyros',
              orderNum,
              customerLastName,
              phoneNumber,
              packDate
            });
          } else if (pitaRemainder >= 13 && pitaRemainder <= 25) {
            // Generate additional full pan for remainder
            labels.push({
              item: getLabelName('Grilled Pita Bread'),
              qty: `FULL PAN - ${pitaFullPansNeeded + 1} OF ${pitaFullPansNeeded + 1}`,
              pan: '',
              category: 'BYO Gyros',
              orderNum,
              customerLastName,
              phoneNumber,
              packDate
            });
          }
        }
      }

      // SALADS - UPDATED: Combine 2 orders into 1 full pan
      prep.salads.forEach(salad => {
        // Combine 2 orders into 1 full pan
        if (salad.qty < 2) {
          // Less than 2 orders: use half pans
          for (let i = 1; i <= salad.qty; i++) {
            labels.push({
              item: getLabelName(salad.name),
              qty: salad.qty > 1 ? `HALF PAN - ${i} OF ${salad.qty}` : `HALF PAN - 1 OF 1`,
              pan: '',
              category: 'Salad',
              orderNum,
              customerLastName,
              phoneNumber,
              packDate
            });
          }
        } else {
          // 2 or more orders: combine 2 into 1 full pan
          const fullPansNeeded = Math.floor(salad.qty / 2);
          const remainderHalfPans = salad.qty % 2;

          // Generate full pan labels
          for (let i = 1; i <= fullPansNeeded; i++) {
            labels.push({
              item: getLabelName(salad.name),
              qty: fullPansNeeded > 1 ? `FULL PAN - ${i} OF ${fullPansNeeded}` : `FULL PAN - 1 OF 1`,
              pan: '',
              category: 'Salad',
              orderNum,
              customerLastName,
              phoneNumber,
              packDate
            });
          }

          // Generate half pan label if remainder
          if (remainderHalfPans > 0) {
            labels.push({
              item: getLabelName(salad.name),
              qty: 'HALF PAN - 1 OF 1',
              pan: '',
              category: 'Salad',
              orderNum,
              customerLastName,
              phoneNumber,
              packDate
            });
          }
        }

        // Dressing containers (16oz deli, 1 per portion)
        for (let i = 1; i <= salad.qty; i++) {
          labels.push({
            item: getLabelName(`${salad.name} - Lemon Vinaigrette`),
            qty: salad.qty > 1 ? `16OZ DELI - ${i} OF ${salad.qty}` : `16OZ DELI - 1 OF 1`,
            pan: '',
            category: 'Salad Dressing',
            orderNum,
            customerLastName,
            phoneNumber,
            packDate
          });
        }
      });

      // DIPS
      prep.dips.forEach(dip => {
        // Dip containers (16oz deli, one per order)
        for (let i = 1; i <= dip.qty; i++) {
          labels.push({
            item: getLabelName(dip.name),
            qty: dip.qty > 1 ? `16OZ DELI - ${i} OF ${dip.qty}` : `16OZ DELI - 1 OF 1`,
            pan: '',
            category: 'Dip',
            orderNum,
            customerLastName,
            phoneNumber,
            packDate
          });
        }

        // Veggie sides if ordered
        const hasVeggies = dip.modifiers.some(m => m.name && (m.name.includes('VEGGIES') || m.name.includes('VEGGIE')));
        if (hasVeggies) {
          for (let i = 1; i <= dip.qty; i++) {
            labels.push({
              item: getLabelName(`${dip.name} - Veggie Sticks (Carrots)`),
              qty: `${24 * dip.qty} pieces`,
              pan: '',
              category: 'Dip Side',
              orderNum,
              customerLastName,
              phoneNumber,
              packDate
            });
            labels.push({
              item: getLabelName(`${dip.name} - Veggie Sticks (Celery)`),
              qty: `${24 * dip.qty} pieces`,
              pan: '',
              category: 'Dip Side',
              orderNum,
              customerLastName,
              phoneNumber,
              packDate
            });
          }
        }

        // Pita sides if ordered
        const hasPita = dip.modifiers.some(m => m.name && m.name.includes('PITA') && !m.name.includes('GLUTEN FREE'));
        if (hasPita) {
          for (let i = 1; i <= dip.qty; i++) {
            labels.push({
              item: getLabelName(`${dip.name} - Sliced Pita Bread`),
              qty: `${6 * dip.qty} pitas`,
              pan: '',
              category: 'Dip Side',
              orderNum,
              customerLastName,
              phoneNumber,
              packDate
            });
          }
        }

        // GF Pita sides if ordered - UPDATED: Use brown bowls (up to 6 GF pitas per bowl)
        const gfPitaMod = dip.modifiers.find(m => m.name && m.name.includes('GLUTEN FREE PITA'));
        if (gfPitaMod) {
          const gfQty = gfPitaMod.gfPitaQty || (dip.qty * 6);
          const gfPitaBrownBowls = Math.ceil(gfQty / 6);

          // Generate brown bowl labels
          for (let i = 1; i <= gfPitaBrownBowls; i++) {
            labels.push({
              item: getLabelName(`${dip.name} - GF Pita Bread`),
              qty: gfPitaBrownBowls > 1 ? `BROWN BOWL - ${i} OF ${gfPitaBrownBowls}` : `BROWN BOWL - 1 OF 1`,
              pan: '',
              category: 'Dip Side',
              orderNum,
              customerLastName,
              phoneNumber,
              packDate
            });
          }
        }
      });

      // GREEK FRIES (Regular & BYO Bar) - UPDATED
      prep.greekFries.forEach(fries => {
        // Detect if this is Greek Fries BYO Bar (check for keywords BYO or BAR)
        const friesName = (fries.name || '').toUpperCase();
        const isByoBar = friesName.includes('BYO') || friesName.includes('BAR');

        // Detect protein type from fries.name (e.g., "Greek Fries + Chicken Gyro" ‚Üí "CHICKEN GYRO")
        let itemName = 'GREEK FRIES + PROTEIN';
        if (fries.name && fries.name.includes('+')) {
          const protein = fries.name.split('+')[1].trim().toUpperCase();
          itemName = `GREEK FRIES + ${protein}`;
        }

        // NEW PAN LOGIC: Combine 2 orders into 1 full pan
        if (fries.qty < 2) {
          // Less than 2 orders: use half pans
          for (let i = 1; i <= fries.qty; i++) {
            labels.push({
              item: itemName,
              qty: fries.qty > 1 ? `HALF PAN - ${i} OF ${fries.qty}` : `HALF PAN - 1 OF 1`,
              pan: '',
              category: 'Greek Fries',
              orderNum,
              customerLastName,
              phoneNumber,
              packDate
            });
          }
        } else {
          // 2 or more orders: combine 2 into 1 full pan
          const fullPansNeeded = Math.floor(fries.qty / 2);
          const remainderHalfPans = fries.qty % 2;

          // Generate full pan labels
          for (let i = 1; i <= fullPansNeeded; i++) {
            labels.push({
              item: itemName,
              qty: fullPansNeeded > 1 ? `FULL PAN - ${i} OF ${fullPansNeeded}` : `FULL PAN - 1 OF 1`,
              pan: '',
              category: 'Greek Fries',
              orderNum,
              customerLastName,
              phoneNumber,
              packDate
            });
          }

          // Generate half pan label if remainder
          if (remainderHalfPans > 0) {
            labels.push({
              item: itemName,
              qty: 'HALF PAN - 1 OF 1',
              pan: '',
              category: 'Greek Fries',
              orderNum,
              customerLastName,
              phoneNumber,
              packDate
            });
          }
        }

        // Sauces: BYO Bar gets all 3, regular gets Aioli only
        if (isByoBar) {
          labels.push({ item: getLabelName('Greek Fries - Spicy Aioli'), qty: '16OZ DELI - 1 OF 1', pan: '', category: 'Greek Fries', orderNum, customerLastName, phoneNumber, packDate });
          labels.push({ item: getLabelName('Greek Fries - Tzatziki'), qty: '16OZ DELI - 1 OF 1', pan: '', category: 'Greek Fries', orderNum, customerLastName, phoneNumber, packDate });
          labels.push({ item: getLabelName('Greek Fries - Crumbled Feta'), qty: '16OZ DELI - 1 OF 1', pan: '', category: 'Greek Fries', orderNum, customerLastName, phoneNumber, packDate });
        } else {
          labels.push({ item: getLabelName('Greek Fries - Spicy Aioli'), qty: '16OZ DELI - 1 OF 1', pan: '', category: 'Greek Fries', orderNum, customerLastName, phoneNumber, packDate });
        }
      });

      // DOLMAS
      prep.dolmas.forEach(dolma => {
        labels.push({ item: getLabelName(dolma.name), qty: `${dolma.qty} portions`, pan: '', category: 'Dolmas', orderNum, customerLastName, phoneNumber, packDate });
        labels.push({ item: getLabelName(`${dolma.name} - Tzatziki Sauce`), qty: `${dolma.qty} portions`, pan: '', category: 'Dolmas', orderNum, customerLastName, phoneNumber, packDate });
      });

      // SPANAKOPITA
      prep.spanakopita.forEach(span => {
        labels.push({ item: getLabelName(span.name), qty: `${span.qty} portions`, pan: '', category: 'Spanakopita', orderNum, customerLastName, phoneNumber, packDate });
        labels.push({ item: getLabelName(`${span.name} - Tzatziki Sauce`), qty: `${span.qty} portions`, pan: '', category: 'Spanakopita', orderNum, customerLastName, phoneNumber, packDate });
      });

      // SIDES
      prep.sides.forEach(side => {
        labels.push({ item: getLabelName(side.name), qty: `${side.qty} portions`, pan: '', category: 'Side', orderNum, customerLastName, phoneNumber, packDate });
      });

      // DESSERTS
      prep.desserts.forEach(dessert => {
        labels.push({ item: getLabelName(dessert.name), qty: `${dessert.qty} pieces`, pan: '', category: 'Dessert', orderNum, customerLastName, phoneNumber, packDate });
      });

      // PINWHEELS
      prep.pinwheels.forEach(pinwheel => {
        labels.push({ item: getLabelName(pinwheel.name), qty: `${pinwheel.qty} portions`, pan: '', category: 'Pinwheel', orderNum, customerLastName, phoneNumber, packDate });
      });

      // UNMAPPED ITEMS (drinks, special items, etc.)
      if (prep.unmapped && prep.unmapped.length > 0) {
        prep.unmapped.forEach(item => {
          labels.push({ item: getLabelName(item.name), qty: `${item.qty} portions`, pan: '', category: 'Other', orderNum, customerLastName, phoneNumber, packDate });
        });
      }

      // SORT LABELS ALPHABETICALLY BY ITEM NAME
      // This groups all labels for the same item together for batch printing
      labels.sort((a, b) => {
        const itemA = (a.item || '').toString().toUpperCase();
        const itemB = (b.item || '').toString().toUpperCase();
        return itemA.localeCompare(itemB);
      });

      return labels;
    }

    /**
     * Generate ultra-simple CSV (more compatible than Excel with Print Master)
     */
    function generateSimpleCSV(labels) {
      // Ultra-simple CSV - just plain text, no quotes unless absolutely necessary
      let csv = 'Company,Item,Quantity,Customer\n';

      labels.forEach(label => {
        const company = 'JAYNA GYRO CATERING';
        const item = String(label.item || '').replace(/,/g, ' '); // Remove commas
        const quantity = String(label.qty + ' - Pan ' + label.pan).replace(/,/g, ' ');
        const customer = String(label.packDate + ' ' + label.customerLastName).replace(/,/g, ' ');

        csv += `${company},${item},${quantity},${customer}\n`;
      });

      return csv;
    }

    /**
     * Generate Excel file using ExcelJS - Creates native Excel format
     */
    async function generateLabelsExcel(labels) {
      // Create new workbook using ExcelJS
      const workbook = new ExcelJS.Workbook();

      // Set workbook properties
      workbook.creator = 'Jayna Gyro';
      workbook.lastModifiedBy = 'Jayna Gyro';
      workbook.created = new Date();
      workbook.modified = new Date();

      // Add worksheet
      const worksheet = workbook.addWorksheet('Sheet1');

      // Set column widths
      worksheet.columns = [
        { header: 'CUSTOMER', key: 'customer', width: 35 },
        { header: 'ITEM', key: 'item', width: 30 },
        { header: 'TAGLINE', key: 'tagline', width: 55 },
        { header: 'QTY', key: 'qty', width: 25 }
      ];

      // Add data rows
      labels.forEach(label => {
        worksheet.addRow({
          customer: String((label.packDate || '') + ' ' + (label.customerLastName || '')),
          item: String(label.item || ''),
          tagline: 'Made with Love by your friends at Jayna Gyro üíô',
          qty: String(label.qty || '')
        });
      });

      // Generate Excel file buffer
      const buffer = await workbook.xlsx.writeBuffer();

      return new Blob([buffer], {
        type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
      });
    }

    /**
     * Generate ingredient labels for sauces (1:1 ratio with sauce labels)
     * Only creates ingredient labels for: Tzatziki, Spicy Aioli, Lemon Vinaigrette, Hummus, Baba Ganoush
     */
    function generateIngredientLabels(labels) {
      const ingredientMapping = {
        'TZATZIKI': 'Yogurt, kefir cheese, mint, garlic, cucumber, salt.',
        'SPICY AIOLI': 'Mayonnaise, crushed red pepper, garlic powder, cayenne, lemon, pepperoncini',
        'LEMON VINAIGRETTE': 'Whole grain mustard, shallots, lemon, black pepper, salt, olive oil.',
        'HUMMUS': 'Garbanzo beans, dill, garlic, lemon, salt, cumin, tahini, olive oil.',
        'BABA GANOUSH': 'Charred Eggplant, kefir cheese, tahini, lemon, garlic, olive oil, allepo pepper, parsley.'
      };

      const ingredientLabels = [];

      // For each label, check if it contains any of the sauce names
      labels.forEach(label => {
        const itemName = String(label.item || '').toUpperCase();

        // Check if this label contains any of the tracked sauces
        for (const [sauceName, ingredients] of Object.entries(ingredientMapping)) {
          if (itemName.includes(sauceName)) {
            ingredientLabels.push({
              item: sauceName,
              ingredients: ingredients
            });
            break; // Only create one ingredient label per label (avoid duplicates)
          }
        }
      });

      return ingredientLabels;
    }

    /**
     * Generate Excel file for ingredient labels (2-column format)
     * Headers: ITEM NAME, INGREDIENTS
     */
    async function generateIngredientsExcel(ingredientLabels) {
      // Create new workbook using ExcelJS
      const workbook = new ExcelJS.Workbook();

      // Set workbook properties
      workbook.creator = 'Jayna Gyro';
      workbook.lastModifiedBy = 'Jayna Gyro';
      workbook.created = new Date();
      workbook.modified = new Date();

      // Add worksheet
      const worksheet = workbook.addWorksheet('Sheet1');

      // Set column widths
      worksheet.columns = [
        { header: 'ITEM NAME', key: 'item', width: 30 },
        { header: 'INGREDIENTS', key: 'ingredients', width: 70 }
      ];

      // Add data rows
      ingredientLabels.forEach(label => {
        worksheet.addRow({
          item: String(label.item || ''),
          ingredients: String(label.ingredients || '')
        });
      });

      // Generate Excel file buffer
      const buffer = await workbook.xlsx.writeBuffer();

      return new Blob([buffer], {
        type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
      });
    }

    // Download Prep List PDF (for testing without printing)
    async function downloadPrepListPDF(event, orderId) {
      try {
        console.log(`üì• Downloading prep list PDF for order ${orderId}...`);
        showLoading('GENERATING PDF', 'Creating prep list...');

        const response = await fetch('/api/print-prep-list-new?download=true', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ order_id: orderId })
        });

        hideLoading();

        if (!response.ok) {
          const result = await response.json();
          console.error(`‚ùå Failed to generate prep list PDF: ${result.error}`);
          const downloadBtn = event.target;
          const originalText = downloadBtn.textContent;
          downloadBtn.textContent = 'DOWNLOAD FAILED';
          downloadBtn.style.background = '#dc2626';
          setTimeout(() => {
            downloadBtn.textContent = originalText;
            downloadBtn.style.background = '#059669';
          }, 3000);
          return;
        }

        // Get the PDF blob
        const blob = await response.blob();

        // Create download link
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `Prep_List_Order_${orderId}_${new Date().toISOString().split('T')[0]}.pdf`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);

        console.log(`‚úÖ Prep list PDF downloaded successfully`);

        // Show success feedback in button
        const downloadBtn = event.target;
        const originalText = downloadBtn.textContent;
        downloadBtn.textContent = '‚úì DOWNLOADED';
        downloadBtn.style.background = '#047857';
        setTimeout(() => {
          downloadBtn.textContent = originalText;
          downloadBtn.style.background = '#059669';
        }, 2000);

      } catch (error) {
        hideLoading();
        console.error('‚ùå Error downloading prep list PDF:', error);
        const downloadBtn = event.target;
        const originalText = downloadBtn.textContent;
        downloadBtn.textContent = 'DOWNLOAD ERROR';
        downloadBtn.style.background = '#dc2626';
        setTimeout(() => {
          downloadBtn.textContent = originalText;
          downloadBtn.style.background = '#059669';
        }, 3000);
      }
    }

    // Print Prep List to Epson printer via Gmail
    async function printPrepList(event, orderId) {
      try {
        console.log(`üñ®Ô∏è Printing prep list for order ${orderId}...`);
        showLoading('PRINTING PREP LIST', 'Generating and sending to printer...');

        const response = await fetch('/api/print-prep-list-new', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ order_id: orderId })
        });

        const result = await response.json();

        hideLoading();

        if (!result.success) {
          console.error(`‚ùå Failed to print prep list: ${result.error}`);
          // Show error in modal by updating button text temporarily
          const printBtn = event.target;
          const originalText = printBtn.textContent;
          printBtn.textContent = 'PRINT FAILED - SEE CONSOLE';
          printBtn.style.background = '#dc2626';
          setTimeout(() => {
            printBtn.textContent = originalText;
            printBtn.style.background = 'var(--gray-900)';
          }, 3000);
          return;
        }

        console.log(`‚úÖ Prep list sent to printer successfully:`, result.messageId);

        // Show success feedback in button
        const printBtn = event.target;
        const originalText = printBtn.textContent;
        printBtn.textContent = '‚úì SENT TO PRINTER';
        printBtn.style.background = '#059669';
        setTimeout(() => {
          printBtn.textContent = originalText;
          printBtn.style.background = 'var(--gray-900)';
        }, 2000);

        // Show prominent success modal
        showSuccessMessage('‚úÖ PREP LIST SENT TO PRINTER!', 'The prep list has been emailed to the Epson printer successfully.');

      } catch (error) {
        hideLoading();
        console.error('‚ùå Error printing prep list:', error);
        const printBtn = event.target;
        const originalText = printBtn.textContent;
        printBtn.textContent = 'PRINT ERROR';
        printBtn.style.background = '#dc2626';
        setTimeout(() => {
          printBtn.textContent = originalText;
          printBtn.style.background = 'var(--gray-900)';
        }, 3000);
      }
    }

    async function handlePhotoSelect(event) {
      const file = event.target.files[0];
      if (!file) return;

      // Convert to base64
      const reader = new FileReader();
      reader.onload = async (e) => {
        const base64 = e.target.result;
        await uploadPhoto(base64);
      };
      reader.readAsDataURL(file);

      // Clear input
      event.target.value = '';
    }

    // Toggle LEAVE JAYNA AT and DELIVERY ADDRESS fields based on order type
    function toggleDeliveryField() {
      const isDelivery = document.getElementById('orderTypeDelivery')?.checked;
      const leaveJaynaContainer = document.getElementById('leaveJaynaAtContainer');
      const deliveryAddressContainer = document.getElementById('deliveryAddressContainer');

      if (leaveJaynaContainer) {
        leaveJaynaContainer.style.display = isDelivery ? 'block' : 'none';
      }
      if (deliveryAddressContainer) {
        deliveryAddressContainer.style.display = isDelivery ? 'block' : 'none';
      }
    }

    async function uploadPhoto(base64Data) {
      const gallery = document.getElementById('photoGallery');

      try {
        // Get form values - Order Details
        const orderTypePickup = document.getElementById('orderTypePickup');
        const orderTypeDelivery = document.getElementById('orderTypeDelivery');
        const orderDueDate = document.getElementById('orderDueDate')?.value;
        const timeDue = document.getElementById('timeDue')?.value;
        const leaveJaynaAt = document.getElementById('leaveJaynaAt')?.value;

        // Get form values - Customer Information
        const guestName = document.getElementById('guestName')?.value || null;
        const phoneNumber = document.getElementById('phoneNumber')?.value || null;
        const email = document.getElementById('email')?.value || null;
        const deliveryAddress = document.getElementById('deliveryAddress')?.value || null;
        const specialNotes = document.getElementById('specialNotes')?.value || null;
        const actualOrder = document.getElementById('actualOrder')?.value || null;

        // Validate required fields
        if (!orderTypePickup?.checked && !orderTypeDelivery?.checked) {
          showError('Please select order type (PICK UP or DELIVERY)');
          return;
        }

        if (!orderDueDate) {
          showError('Please select ORDER DUE date');
          return;
        }

        if (!timeDue) {
          showError('Please enter TIME DUE');
          return;
        }

        const orderType = orderTypePickup?.checked ? 'PICKUP' : 'DELIVERY';

        if (orderType === 'DELIVERY' && !leaveJaynaAt) {
          showError('Please enter LEAVE JAYNA AT time for delivery orders');
          return;
        }

        // Show loading spinner
        gallery.innerHTML = `
          <div class="loading-spinner">
            <div class="spinner"></div>
            <div class="loading-text">UPLOADING PHOTO...</div>
          </div>
        `;

        console.log('UPLOADING PHOTO WITH ORDER METADATA...');

        const response = await fetch('/api/catering-photos-upload', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            imageData: base64Data,
            orderType,
            orderDueDate,
            timeDue,
            leaveJaynaAt: orderType === 'DELIVERY' ? leaveJaynaAt : null,
            guestName,
            phoneNumber,
            email,
            deliveryAddress: orderType === 'DELIVERY' ? deliveryAddress : null,
            specialNotes,
            actualOrder
          })
        });

        const data = await response.json();

        if (!data.success) {
          throw new Error(data.error || 'Failed to upload photo');
        }

        console.log('PHOTO UPLOADED SUCCESSFULLY');

        // Show success message briefly
        gallery.innerHTML = `
          <div style="text-align: center; padding: 40px 20px;">
            <div style="font-size: 16px; font-weight: 700; color: var(--success-text); background: var(--success-bg); padding: 16px; border: 2px solid var(--success-border); margin-bottom: 16px;">
              ‚úÖ ORDER SAVED SUCCESSFULLY!
            </div>
            <div style="font-size: 13px; color: var(--gray-600); font-weight: 600;">
              REFRESHING ORDER LIST...
            </div>
          </div>
        `;

        // Clear form
        if (orderTypePickup) orderTypePickup.checked = false;
        if (orderTypeDelivery) orderTypeDelivery.checked = false;
        document.getElementById('orderDueDate').value = '';
        document.getElementById('timeDue').value = '';
        document.getElementById('leaveJaynaAt').value = '';
        document.getElementById('guestName').value = '';
        document.getElementById('phoneNumber').value = '';
        document.getElementById('email').value = '';
        document.getElementById('deliveryAddress').value = '';
        document.getElementById('specialNotes').value = '';
        document.getElementById('actualOrder').value = '';
        toggleDeliveryField();

        // Close the upload form
        const formContainer = document.getElementById('uploadFormContainer');
        const toggleText = document.getElementById('uploadFormToggleText');
        if (formContainer) {
          formContainer.style.display = 'none';
          if (toggleText) toggleText.textContent = '+ Add an Order';
        }

        // Wait a moment for user to see success message, then reload photos
        setTimeout(async () => {
          await loadPhotos();
        }, 800);

      } catch (error) {
        console.error('Error uploading photo:', error);

        // Show error in gallery
        gallery.innerHTML = `
          <div class="error-message">
            ERROR UPLOADING PHOTO: ${error.message}
          </div>
        `;

        // Reload existing photos after 3 seconds
        setTimeout(async () => {
          await loadPhotos();
        }, 3000);
      }
    }

    // Mobile-Friendly Reordering Functions (Up/Down Arrows)
    function movePhotoUp(index) {
      if (index === 0) return; // Already at top

      // Swap with photo above
      const temp = allPhotos[index - 1];
      allPhotos[index - 1] = allPhotos[index];
      allPhotos[index] = temp;

      // Re-render immediately (no save until user clicks SAVE button)
      renderPhotos();
    }

    function movePhotoDown(index) {
      if (index === allPhotos.length - 1) return; // Already at bottom

      // Swap with photo below
      const temp = allPhotos[index + 1];
      allPhotos[index + 1] = allPhotos[index];
      allPhotos[index] = temp;

      // Re-render immediately (no save until user clicks SAVE button)
      renderPhotos();
    }

    // Image Enhancement Functions
    function applyScanMode(photoId, index) {
      // Scan mode: Boost brightness and contrast for clearer text
      allPhotos[index].brightness = 115; // 15% brighter
      allPhotos[index].contrast = 125;   // 25% more contrast

      // Update image element immediately
      const imgElement = document.getElementById(`photo-img-${photoId}`);
      if (imgElement) {
        imgElement.style.filter = 'brightness(115%) contrast(125%)';
      }

      console.log(`‚ú® Scan mode applied to photo ${photoId}`);
    }

    function resetFilters(photoId, index) {
      // Reset to normal (100%)
      allPhotos[index].brightness = 100;
      allPhotos[index].contrast = 100;

      // Update image element immediately
      const imgElement = document.getElementById(`photo-img-${photoId}`);
      if (imgElement) {
        imgElement.style.filter = 'brightness(100%) contrast(100%)';
      }

      console.log(`üîÑ Filters reset for photo ${photoId}`);
    }

    async function savePhotoOrder() {
      try {
        // Send full photo objects with brightness/contrast values
        const photosToSave = allPhotos.map(photo => ({
          id: photo.id,
          brightness: photo.brightness || 100,
          contrast: photo.contrast || 100
        }));

        const response = await fetch('/api/catering-photos-reorder', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            photos: photosToSave
          })
        });

        const data = await response.json();

        if (!data.success) {
          throw new Error(data.error || 'Failed to save order and filters');
        }

        console.log('‚úÖ Photo order and filters saved');
      } catch (error) {
        console.error('Error saving photo order:', error);
      }
    }

    // Edit Mode Functions
    function promptEditMode() {
      // Show password prompt modal
      const modalHTML = `
        <div id="editModeModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 10000; padding: 20px;">
          <div style="background: white; padding: 24px; max-width: 400px; width: 100%; border: 3px solid var(--warning-border);">
            <h2 style="font-size: 18px; font-weight: 700; margin-bottom: 16px; text-transform: uppercase; letter-spacing: 1px; color: var(--warning-text);">
              ‚úèÔ∏è EDIT MODE
            </h2>
            <p style="font-size: 13px; margin-bottom: 16px; color: var(--gray-700);">
              Enter password to enable photo editing and reordering.
            </p>
            <input type="password" id="editModePassword" placeholder="Password" style="width: 100%; padding: 12px; border: 2px solid var(--gray-300); margin-bottom: 16px; font-size: 14px; box-sizing: border-box;">
            <div style="display: flex; gap: 12px; justify-content: flex-end;">
              <button onclick="closeEditModeModal()" style="padding: 12px 24px; background: var(--gray-100); border: 2px solid var(--gray-300); color: var(--gray-900); font-size: 13px; font-weight: 700; cursor: pointer; text-transform: uppercase; letter-spacing: 0.5px;">
                CANCEL
              </button>
              <button onclick="activateEditMode()" style="padding: 12px 24px; background: var(--warning); border: 2px solid var(--warning); color: var(--gray-900); font-size: 13px; font-weight: 700; cursor: pointer; text-transform: uppercase; letter-spacing: 0.5px;">
                ACTIVATE
              </button>
            </div>
          </div>
        </div>
      `;

      const modalContainer = document.createElement('div');
      modalContainer.innerHTML = modalHTML;
      document.body.appendChild(modalContainer);

      // Focus password input
      setTimeout(() => {
        document.getElementById('editModePassword')?.focus();
      }, 100);
    }

    function closeEditModeModal() {
      const modal = document.getElementById('editModeModal');
      if (modal) {
        modal.parentElement.remove();
      }
    }

    function activateEditMode() {
      const password = document.getElementById('editModePassword')?.value;

      // Check password
      if (password !== 'reorder') {
        showError('‚ùå Incorrect password');
        return;
      }

      // Close modal
      closeEditModeModal();

      // Enable edit mode
      isEditMode = true;
      console.log('‚úèÔ∏è Edit mode activated');

      // Show SAVE button, update EDIT button text
      document.getElementById('saveBtn').style.display = 'block';

      // Re-render photos with edit mode enabled
      renderPhotos();
    }

    async function saveEditMode() {
      // Save the current photo order
      await savePhotoOrder();

      // Disable edit mode
      isEditMode = false;
      console.log('‚úÖ Edit mode saved and deactivated');

      // Hide SAVE button
      document.getElementById('saveBtn').style.display = 'none';

      // Re-render photos with edit mode disabled
      renderPhotos();
    }

    // Delete Photo with Confirmation
    function promptDeletePhoto(photoId) {
      // Only allow deletion in edit mode
      if (!isEditMode) {
        return; // Do nothing if not in edit mode
      }

      // Show confirmation modal (no password needed - already in edit mode)
      const modalHTML = `
        <div id="deletePhotoModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 10000; padding: 20px;">
          <div style="background: white; padding: 24px; max-width: 400px; width: 100%; border: 3px solid var(--error-border);">
            <h2 style="font-size: 18px; font-weight: 700; margin-bottom: 16px; text-transform: uppercase; letter-spacing: 1px; color: var(--error-text);">
              üóëÔ∏è DELETE PHOTO
            </h2>
            <p style="font-size: 13px; margin-bottom: 16px; color: var(--gray-700);">
              Are you sure you want to delete this photo permanently? This action cannot be undone.
            </p>
            <div style="display: flex; gap: 12px; justify-content: flex-end;">
              <button onclick="closeDeleteModal()" style="padding: 12px 24px; background: var(--gray-100); border: 2px solid var(--gray-300); color: var(--gray-900); font-size: 13px; font-weight: 700; cursor: pointer; text-transform: uppercase; letter-spacing: 0.5px;">
                CANCEL
              </button>
              <button onclick="confirmDeletePhoto(${photoId})" style="padding: 12px 24px; background: var(--error-border); border: 2px solid var(--error-border); color: white; font-size: 13px; font-weight: 700; cursor: pointer; text-transform: uppercase; letter-spacing: 0.5px;">
                DELETE
              </button>
            </div>
          </div>
        </div>
      `;

      const modalContainer = document.createElement('div');
      modalContainer.innerHTML = modalHTML;
      document.body.appendChild(modalContainer);
    }

    function closeDeleteModal() {
      const modal = document.getElementById('deletePhotoModal');
      if (modal) {
        modal.parentElement.remove();
      }
    }

    async function confirmDeletePhoto(photoId) {
      // No password check needed - already in edit mode which is password-protected

      try {
        console.log(`üóëÔ∏è Deleting photo ${photoId}...`);

        const response = await fetch('/api/catering-photos-delete', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            photoId
          })
        });

        const data = await response.json();

        if (!data.success) {
          throw new Error(data.error || 'Failed to delete photo');
        }

        console.log('‚úÖ Photo deleted');

        // Close modal
        closeDeleteModal();

        // Reload photos
        await loadPhotos();
      } catch (error) {
        console.error('Error deleting photo:', error);
        showError(`Error deleting photo: ${error.message}`);
      }
    }

    // ============================================
    // UPLOAD FORM TOGGLE
    // ============================================
    function toggleUploadForm() {
      const formContainer = document.getElementById('uploadFormContainer');
      const toggleText = document.getElementById('uploadFormToggleText');

      if (formContainer.style.display === 'none') {
        formContainer.style.display = 'block';
        toggleText.textContent = '- Hide Form';
      } else {
        formContainer.style.display = 'none';
        toggleText.textContent = '+ Add an Order';
      }
    }

    // ============================================
    // ARCHIVE PHOTO FUNCTIONS
    // ============================================
    async function archivePhoto(photoId) {
      try {
        console.log(`üì¶ Archiving photo ${photoId}...`);

        // Find and update the button immediately with visual feedback
        const btn = document.getElementById(`completeBtn_${photoId}`);
        if (btn) {
          btn.innerHTML = `
            <span style="display: flex; align-items: center; gap: 6px;">
              ‚úì COMPLETE!
              <span style="
                display: inline-block;
                width: 12px;
                height: 12px;
                border: 2px solid white;
                border-top-color: transparent;
                border-radius: 50%;
                animation: spin 0.8s linear infinite;
              "></span>
            </span>
          `;
          btn.style.background = 'rgba(0, 200, 83, 1)';
          btn.style.cursor = 'wait';
          btn.disabled = true;
        }

        const response = await fetch('/api/catering-photos-archive', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            photoId,
            archived: true
          })
        });

        const data = await response.json();

        if (!data.success) {
          throw new Error(data.error || 'Failed to archive photo');
        }

        console.log('‚úÖ Photo archived');

        // Reload photos to remove archived order from main view (photo will auto-disappear)
        await loadPhotos();
      } catch (error) {
        console.error('Error archiving photo:', error);

        // Reset button on error
        const btn = document.getElementById(`completeBtn_${photoId}`);
        if (btn) {
          btn.innerHTML = 'MARK AS COMPLETED';
          btn.style.cursor = 'pointer';
          btn.disabled = false;
        }

        showError(`Error archiving photo: ${error.message}`);
      }
    }

    // ============================================
    // LOADING OVERLAY FUNCTIONS
    // ============================================
    function showLoading(title, message) {
      const overlay = document.getElementById('loadingOverlay');
      const titleEl = document.getElementById('loadingTitle');
      const messageEl = document.getElementById('loadingMessage');

      if (!overlay || !titleEl || !messageEl) {
        console.error('Loading overlay elements not found in DOM');
        return;
      }

      titleEl.textContent = title;
      messageEl.textContent = message;
      overlay.style.display = 'flex';
    }

    function hideLoading() {
      const overlay = document.getElementById('loadingOverlay');
      if (overlay) {
        overlay.style.display = 'none';
      }
    }

    /**
     * Show success overlay (auto-hide after 1.5s)
     */
    function showSuccess(message) {
      hideLoading(); // Hide loading first if it's showing
      const overlay = document.getElementById('successOverlay');
      const messageEl = document.getElementById('successMessage');

      if (!overlay || !messageEl) {
        console.error('Success overlay elements not found in DOM');
        return;
      }

      messageEl.textContent = message;
      overlay.style.display = 'flex';

      // Auto-hide after 1.5 seconds
      setTimeout(() => {
        overlay.style.display = 'none';
      }, 1500);
    }

    /**
     * Show error overlay (user must click OK)
     */
    function showError(message) {
      hideLoading(); // Hide loading first if it's showing
      const overlay = document.getElementById('errorOverlay');
      const messageEl = document.getElementById('errorMessage');

      if (!overlay || !messageEl) {
        console.error('Error overlay elements not found in DOM');
        // Create dynamic inline modal instead of alert (Google Sites compatible)
        const dynamicOverlay = document.createElement('div');
        dynamicOverlay.style.cssText = `position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:100000;padding:20px;`;
        const box = document.createElement('div');
        box.style.cssText = `background:white;padding:24px;max-width:500px;width:100%;border:3px solid #dc2626;`;
        const msg = document.createElement('div');
        msg.textContent = message;
        msg.style.cssText = `font-size:14px;color:#991b1b;margin-bottom:20px;`;
        const btn = document.createElement('button');
        btn.textContent = 'OK';
        btn.style.cssText = `width:100%;padding:12px;background:#1a1a1a;color:white;border:none;font-weight:700;cursor:pointer;`;
        btn.onclick = () => dynamicOverlay.remove();
        box.appendChild(msg);
        box.appendChild(btn);
        dynamicOverlay.appendChild(box);
        document.body.appendChild(dynamicOverlay);
        return;
      }

      messageEl.textContent = message;
      overlay.style.display = 'flex';
    }

    /**
     * Hide error overlay
     */
    function hideError() {
      const overlay = document.getElementById('errorOverlay');
      if (overlay) {
        overlay.style.display = 'none';
      }
    }

    /**
     * Universal message function - redirects to appropriate overlay
     */
    function showMessage(text, type) {
      if (type === 'success') {
        showSuccess(text);
      } else if (type === 'error') {
        showError(text);
      } else {
        showSuccess(text); // Default to success for 'info' type
      }
    }

    /**
     * Show a prominent success message modal with auto-dismiss
     */
    function showSuccessMessage(title, message) {
      // Create modal overlay
      const overlay = document.createElement('div');
      overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10001;
        padding: 20px;
      `;

      // Create success message box
      const messageBox = document.createElement('div');
      messageBox.style.cssText = `
        background: white;
        padding: 32px;
        max-width: 500px;
        width: 100%;
        border: 3px solid #059669;
        text-align: center;
      `;

      messageBox.innerHTML = `
        <div style="font-size: 48px; margin-bottom: 16px;">‚úÖ</div>
        <h2 style="font-size: 20px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: #059669; margin: 0 0 16px 0;">
          ${title}
        </h2>
        <p style="font-size: 14px; color: var(--gray-700); margin: 0 0 24px 0; line-height: 1.6;">
          ${message}
        </p>
        <button onclick="this.closest('div[style*=fixed]').remove()" style="padding: 12px 32px; background: #059669; border: 2px solid #059669; color: white; font-size: 13px; font-weight: 700; cursor: pointer; text-transform: uppercase; letter-spacing: 0.5px;">
          OK
        </button>
      `;

      overlay.appendChild(messageBox);
      document.body.appendChild(overlay);

      // Auto-dismiss after 4 seconds
      setTimeout(() => {
        if (overlay.parentElement) {
          overlay.remove();
        }
      }, 4000);

      // Click overlay to dismiss
      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) {
          overlay.remove();
        }
      });
    }

    // ============================================
    // LOAD ARCHIVED PHOTOS FOR PAST TAB
    // ============================================
    async function loadArchivedPhotos() {
      const container = document.getElementById('pastTab');

      try {
        console.log('üì¶ Loading archived catering photos...');

        const response = await fetch('/api/catering-photos-get?archived=true');
        const data = await response.json();

        if (!data.success) {
          throw new Error(data.error || 'Failed to load archived photos');
        }

        const archivedPhotos = data.data || [];
        console.log(`‚úÖ Loaded ${archivedPhotos.length} archived photos`);

        if (archivedPhotos.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <div class="empty-icon">üì¶</div>
              <div class="empty-title">No Archived Orders</div>
              <div class="empty-message">Completed orders will appear here for historical records</div>
            </div>
          `;
          return;
        }

        // Group archived photos by date
        const photosByDate = {};
        archivedPhotos.forEach(photo => {
          const date = photo.order_due_date || 'NO DATE';
          if (!photosByDate[date]) {
            photosByDate[date] = [];
          }
          photosByDate[date].push(photo);
        });

        // Sort dates (most recent first for archived)
        const sortedDates = Object.keys(photosByDate).sort((a, b) => {
          if (a === 'NO DATE') return 1;
          if (b === 'NO DATE') return -1;
          return new Date(b) - new Date(a); // Reverse order for past
        });

        // Build HTML
        let html = '<div style="padding: 12px;">';
        sortedDates.forEach(date => {
          const photos = photosByDate[date];
          const dateLabel = formatPhotoDateLabel(date);

          html += `
            <div class="photo-date-group">
              <div class="photo-date-header">${dateLabel} (COMPLETED)</div>
              <div class="photo-thumbnails-grid">
          `;

          photos.forEach(photo => {
            const brightness = photo.brightness || 100;
            const contrast = photo.contrast || 100;
            const filterStyle = `filter: brightness(${brightness}%) contrast(${contrast}%);`;
            const timeDue = formatTimeDisplay(photo.time_due);
            const leaveJaynaAt = photo.order_type === 'DELIVERY' ? formatTimeDisplay(photo.leave_jayna_at) : null;

            html += `
              <div class="photo-item" data-id="${photo.id}">
                <img src="${photo.image_url}"
                     alt="Catering Order"
                     class="photo-img"
                     loading="lazy"
                     width="400"
                     height="500"
                     style="${filterStyle} cursor: pointer;"
                     onclick="openLightbox('${photo.image_url}', ${brightness}, ${contrast})">

                <div class="photo-metadata">
                  <div class="photo-metadata-row">
                    <span class="photo-metadata-label">TYPE:</span>
                    <span class="photo-metadata-value">${photo.order_type || 'N/A'}</span>
                  </div>
                  <div class="photo-metadata-row">
                    <span class="photo-metadata-label">TIME DUE:</span>
                    <span class="photo-metadata-value">${timeDue}</span>
                  </div>
                  ${leaveJaynaAt ? `
                  <div class="photo-metadata-row">
                    <span class="photo-metadata-label">LEAVE AT:</span>
                    <span class="photo-metadata-value">${leaveJaynaAt}</span>
                  </div>
                  ` : ''}
                </div>
              </div>
            `;
          });

          html += `
              </div>
            </div>
          `;
        });
        html += '</div>';

        container.innerHTML = html;
      } catch (error) {
        console.error('Error loading archived photos:', error);
        container.innerHTML = `
          <div class="error-message">
            ‚ùå Error loading archived photos: ${error.message}
          </div>
        `;
      }
    }

    // ============================================
    // INITIALIZATION
    // ============================================
    document.addEventListener('DOMContentLoaded', () => {
      console.log('üçΩÔ∏è Jayna Catering Management System loaded');

      // Load photos on Photos tab (shows loading spinner)
      loadPhotos();

      // Load orders for Beta tab in background (NO loading spinner - runs silently)
      console.log('üìÇ Pre-loading orders for Beta tab in background...');
      loadOrdersFromDatabase(false);

      // Load archived photos for Past tab
      loadArchivedPhotos();

      // Start background sync
      startBackgroundSync();
    });

    // ============================================
    // IMAGE LIGHTBOX / FULL-SIZE VIEWER
    // ============================================
    function openLightbox(imageUrl, brightness, contrast) {
      const modal = document.getElementById('lightboxModal');
      const img = document.getElementById('lightboxImage');

      img.src = imageUrl;
      img.style.filter = `brightness(${brightness || 100}%) contrast(${contrast || 100}%)`;
      img.classList.remove('zoomed');

      modal.classList.add('active');
      document.body.style.overflow = 'hidden'; // Prevent background scrolling
    }

    function closeLightbox() {
      const modal = document.getElementById('lightboxModal');
      modal.classList.remove('active');
      document.body.style.overflow = ''; // Restore scrolling
    }

    function toggleZoom(event) {
      const img = event.target;
      img.classList.toggle('zoomed');
    }

  // ==================== LIVE STATS (CLOCKED IN, TIPS/HR, LEADER, VOID TRACKING) ====================
  // NOTE: These functions are now provided by app-header.js and are loaded globally.
  // Previously, this file had duplicate definitions which caused "duplicate variable" errors.
  // All live stats initialization is handled by app-header.js.
  // ==================== END LIVE STATS ====================


    // ==================== BLUETOOTH THERMAL PRINTER SYSTEM ====================

    /**
     * Phomemo M110 Bluetooth Thermal Label Printer
     * Direct ESC/POS printing via Web Bluetooth API
     * Label Size: 40mm x 30mm (315 dots x 236 dots at 203 DPI)
     */

    let bluetoothDevice = null;
    let bluetoothCharacteristic = null;
    const LABEL_WIDTH_DOTS = 384;  // 48 bytes * 8 bits = 384 dots (Phomemo M110 width)
    const LABEL_HEIGHT_DOTS = 236; // 30mm at 203 DPI ‚âà 236 dots

    // Show Bluetooth status bar on page load
    window.addEventListener('DOMContentLoaded', () => {
      const statusBar = document.getElementById('bluetoothStatus');
      if (statusBar && 'bluetooth' in navigator) {
        statusBar.style.display = 'block';
      }
    });

    /**
     * Connect to Phomemo M110 via Web Bluetooth API
     */
    async function connectBluetoothPrinter() {
      try {
        console.log('üîµ Requesting Bluetooth device...');

        // Request Bluetooth device (Phomemo M110)
        bluetoothDevice = await navigator.bluetooth.requestDevice({
          filters: [
            { namePrefix: 'M110' },
            { namePrefix: 'Phomemo' }
          ],
          optionalServices: [
            '000018f0-0000-1000-8000-00805f9b34fb', // Phomemo service
            '0000ff00-0000-1000-8000-00805f9b34fb'  // Alternative service
          ]
        });

        console.log('‚úÖ Device selected:', bluetoothDevice.name);

        // Connect to GATT server
        const server = await bluetoothDevice.gatt.connect();
        console.log('‚úÖ Connected to GATT server');

        // Get primary service
        let service;
        try {
          service = await server.getPrimaryService('000018f0-0000-1000-8000-00805f9b34fb');
        } catch (e) {
          service = await server.getPrimaryService('0000ff00-0000-1000-8000-00805f9b34fb');
        }
        console.log('‚úÖ Service found');

        // Get write characteristic
        try {
          bluetoothCharacteristic = await service.getCharacteristic('00002af1-0000-1000-8000-00805f9b34fb');
        } catch (e) {
          bluetoothCharacteristic = await service.getCharacteristic('0000ff02-0000-1000-8000-00805f9b34fb');
        }
        console.log('‚úÖ Characteristic found');

        // Update UI
        const statusBar = document.getElementById('bluetoothStatus');
        statusBar.style.background = '#059669';
        statusBar.style.borderColor = '#059669';

        document.getElementById('bluetoothStatusText').textContent = `‚úÖ BLUETOOTH PRINTER: CONNECTED (${bluetoothDevice.name.toUpperCase()})`;
        document.getElementById('bluetoothConnectBtn').textContent = 'DISCONNECT';
        document.getElementById('bluetoothConnectBtn').style.background = '#DC2626';
        document.getElementById('bluetoothConnectBtn').style.borderColor = '#DC2626';
        document.getElementById('bluetoothConnectBtn').onclick = disconnectBluetoothPrinter;

        console.log('‚úÖ Printer ready for label printing!');

      } catch (error) {
        console.error('‚ùå Bluetooth connection error:', error);
        showMessage(`‚ùå Failed to connect: ${error.message}`, 'error');
      }
    }

    /**
     * Disconnect Bluetooth printer
     */
    function disconnectBluetoothPrinter() {
      if (bluetoothDevice && bluetoothDevice.gatt.connected) {
        bluetoothDevice.gatt.disconnect();
      }
      bluetoothDevice = null;
      bluetoothCharacteristic = null;

      const statusBar = document.getElementById('bluetoothStatus');
      statusBar.style.background = '#212121';
      statusBar.style.borderColor = '#00A8E1';

      document.getElementById('bluetoothStatusText').textContent = 'üîµ BLUETOOTH PRINTER: NOT CONNECTED';
      document.getElementById('bluetoothConnectBtn').textContent = 'CONNECT PRINTER';
      document.getElementById('bluetoothConnectBtn').style.background = '#00A8E1';
      document.getElementById('bluetoothConnectBtn').style.borderColor = '#00A8E1';
      document.getElementById('bluetoothConnectBtn').onclick = connectBluetoothPrinter;

      console.log('Printer disconnected');
    }

    /**
     * Send raw bytes to printer
     */
    async function sendToPrinter(data) {
      if (!bluetoothCharacteristic) {
        throw new Error('Printer not connected. Click "CONNECT PRINTER" first.');
      }

      // Split data into chunks (BLE has 20-byte limit per write)
      const chunkSize = 20;
      for (let i = 0; i < data.length; i += chunkSize) {
        const chunk = data.slice(i, i + chunkSize);
        await bluetoothCharacteristic.writeValue(chunk);
        await new Promise(resolve => setTimeout(resolve, 10)); // Small delay between chunks
      }
    }

    /**
     * ESC/POS Commands Generator
     */
    const ESC = 0x1B;
    const GS = 0x1D;

    function escPos_initialize() {
      return new Uint8Array([ESC, 0x40]); // ESC @
    }

    function escPos_setAlignment(align) {
      // 0 = left, 1 = center, 2 = right
      return new Uint8Array([ESC, 0x61, align]);
    }

    function escPos_setBold(enable) {
      return new Uint8Array([ESC, 0x45, enable ? 1 : 0]);
    }

    function escPos_setFontSize(width, height) {
      // 0 = normal, 1 = double
      const size = (width << 4) | height;
      return new Uint8Array([GS, 0x21, size]);
    }

    function escPos_feedLines(lines) {
      return new Uint8Array([ESC, 0x64, lines]); // ESC d n
    }

    function escPos_printText(text) {
      return new TextEncoder().encode(text + '\n');
    }

    function escPos_printRasterImage(imageData, width, height) {
      // GS v 0 m xL xH yL yH d1...dk
      const bytesPerLine = Math.ceil(width / 8);
      const cmd = new Uint8Array([
        GS, 0x76, 0x30, 0x00, // GS v 0 (normal mode)
        bytesPerLine & 0xFF, (bytesPerLine >> 8) & 0xFF, // xL xH (bytes per line)
        height & 0xFF, (height >> 8) & 0xFF // yL yH (number of lines)
      ]);

      // Concatenate command + image data
      const result = new Uint8Array(cmd.length + imageData.length);
      result.set(cmd);
      result.set(imageData, cmd.length);

      return result;
    }

    /**
     * Render label to 1-bit bitmap for thermal printing
     * @param {Object} label - Label data {orderNum, customer, date, container, item, qty, category}
     * @returns {Uint8Array} - Bitmap data
     */
    function renderLabelToBitmap(label) {
      // Create canvas for label (40mm x 30mm at 203 DPI)
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');

      canvas.width = LABEL_WIDTH_DOTS;
      canvas.height = LABEL_HEIGHT_DOTS;

      // White background
      ctx.fillStyle = 'white';
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      // Black text
      ctx.fillStyle = 'black';
      ctx.textAlign = 'center';

      let y = 20;

      // Order number (large, bold)
      ctx.font = 'bold 32px Arial';
      ctx.fillText(`ORDER #${label.orderNum}`, canvas.width / 2, y);
      y += 40;

      // Customer name
      ctx.font = '20px Arial';
      ctx.fillText(label.customer || 'Customer', canvas.width / 2, y);
      y += 30;

      // Date
      ctx.font = '16px Arial';
      ctx.fillText(label.date, canvas.width / 2, y);
      y += 30;

      // Horizontal line
      ctx.fillRect(20, y, canvas.width - 40, 2);
      y += 15;

      // Container type (bold, large)
      ctx.font = 'bold 26px Arial';
      ctx.fillText(label.container.toUpperCase(), canvas.width / 2, y);
      y += 35;

      // Item name
      ctx.font = 'bold 22px Arial';
      const itemText = label.item.toUpperCase();
      if (itemText.length > 20) {
        // Word wrap if too long
        const words = itemText.split(' ');
        let line = '';
        for (const word of words) {
          const testLine = line + word + ' ';
          if (ctx.measureText(testLine).width > canvas.width - 40) {
            ctx.fillText(line, canvas.width / 2, y);
            y += 28;
            line = word + ' ';
          } else {
            line = testLine;
          }
        }
        ctx.fillText(line, canvas.width / 2, y);
        y += 28;
      } else {
        ctx.fillText(itemText, canvas.width / 2, y);
        y += 28;
      }

      // Quantity
      ctx.font = 'bold 24px Arial';
      ctx.fillText(`QTY: ${label.qty}`, canvas.width / 2, y);
      y += 30;

      // Horizontal line
      ctx.fillRect(20, y, canvas.width - 40, 2);
      y += 15;

      // Category/Notes (smaller)
      if (label.category) {
        ctx.font = '16px Arial';
        ctx.fillText(label.category, canvas.width / 2, y);
      }

      // Convert canvas to 1-bit bitmap
      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const bytesPerLine = Math.ceil(canvas.width / 8);
      const bitmapData = new Uint8Array(bytesPerLine * canvas.height);

      for (let y = 0; y < canvas.height; y++) {
        for (let x = 0; x < canvas.width; x++) {
          const pixelIndex = (y * canvas.width + x) * 4;
          const r = imageData.data[pixelIndex];
          const g = imageData.data[pixelIndex + 1];
          const b = imageData.data[pixelIndex + 2];

          // Convert to grayscale and threshold
          const gray = (r + g + b) / 3;
          const bit = gray < 128 ? 1 : 0; // Black if below threshold

          if (bit) {
            const byteIndex = y * bytesPerLine + Math.floor(x / 8);
            const bitIndex = 7 - (x % 8);
            bitmapData[byteIndex] |= (1 << bitIndex);
          }
        }
      }

      return bitmapData;
    }

    /**
     * Print single label
     */
    async function printLabel(labelData) {
      // Initialize printer
      await sendToPrinter(escPos_initialize());

      // Center alignment
      await sendToPrinter(escPos_setAlignment(1));

      // Render label to bitmap
      const bitmap = renderLabelToBitmap(labelData);

      // Print image
      await sendToPrinter(escPos_printRasterImage(bitmap, LABEL_WIDTH_DOTS, LABEL_HEIGHT_DOTS));

      // Feed paper and cut
      await sendToPrinter(escPos_feedLines(5));

      // Small delay between labels
      await new Promise(resolve => setTimeout(resolve, 500));
    }

    /**
     * Generate label data from prep list
     */
    function generateLabelsFromPrepList(prep, order) {
      const orderNum = order.order_number || order.id;
      const customer = order.customer_name || 'Customer';

      // Format date in Pacific time (device-independent)
      let date = '';
      if (order.delivery_date) {
        const [year, month, day] = order.delivery_date.split('-').map(Number);
        const utcDate = new Date(Date.UTC(year, month - 1, day, 12, 0, 0));
        date = new Intl.DateTimeFormat('en-US', {
          month: 'short',
          day: 'numeric',
          timeZone: 'America/Los_Angeles'
        }).format(utcDate);
      }

      // Create separate arrays for each category group
      const byoGyroLabels = [];
      const saladLabels = [];
      const saladDressingLabels = [];
      const dipLabels = [];
      const dipSideLabels = [];
      const greekFriesLabels = [];
      const dolmaLabels = [];
      const spanakopitaLabels = [];
      const sideLabels = [];
      const dessertLabels = [];
      const pinwheelLabels = [];

      // BYO Gyros - Group sauces first, then veggies/greens, then pitas
      if (prep.byoGyros.total > 0) {
        const sets = Math.ceil(prep.byoGyros.total / 10);

        // All sauce labels
        for (let i = 0; i < sets; i++) {
          byoGyroLabels.push({ orderNum, customer, date, container: '16oz Deli', item: 'Tzatziki (no dill)', qty: 1, category: 'BYO Gyros - Sauces' });
          byoGyroLabels.push({ orderNum, customer, date, container: '16oz Deli', item: 'Spicy Aioli', qty: 1, category: 'BYO Gyros - Sauces' });
          byoGyroLabels.push({ orderNum, customer, date, container: '16oz Deli', item: 'Lemon Vinaigrette', qty: 1, category: 'BYO Gyros - Sauces' });
        }

        // All greens labels
        for (let i = 0; i < sets; i++) {
          byoGyroLabels.push({ orderNum, customer, date, container: '¬Ω Pan', item: 'Mixed Greens', qty: 1, category: 'BYO Gyros - Greens' });
        }

        // All veggie labels
        byoGyroLabels.push({ orderNum, customer, date, container: '¬Ω Pan', item: 'Diced Tomatoes', qty: prep.byoGyros.total, category: 'BYO Gyros - Veggies' });
        byoGyroLabels.push({ orderNum, customer, date, container: '¬Ω Pan', item: getLabelName('Sliced Red Onion'), qty: prep.byoGyros.total, category: 'BYO Gyros - Veggies' });
        byoGyroLabels.push({ orderNum, customer, date, container: '¬Ω Pan', item: 'Pepperoncini', qty: prep.byoGyros.total, category: 'BYO Gyros - Veggies' });

        // All pita labels
        byoGyroLabels.push({ orderNum, customer, date, container: '¬Ω Pan', item: 'Grilled Pita', qty: prep.byoGyros.total + sets, category: 'BYO Gyros - Pitas' });
      }

      // Salads - All salad labels first, then all dressing labels
      prep.salads.forEach(salad => {
        const panType = salad.qty < 4 ? '¬Ω Pan' : 'Full Pan';
        saladLabels.push({ orderNum, customer, date, container: panType, item: getLabelName(salad.name), qty: salad.qty, category: 'Salad' });
      });

      prep.salads.forEach(salad => {
        saladDressingLabels.push({ orderNum, customer, date, container: '16oz Deli', item: 'Lemon Vinaigrette', qty: salad.qty, category: 'Salad - Dressings' });
      });

      // Dips - All dip labels first, then all side labels (veggies/pitas)
      prep.dips.forEach(dip => {
        dipLabels.push({ orderNum, customer, date, container: '16oz Deli', item: getLabelName(dip.name), qty: dip.qty, category: 'Dip' });
      });

      prep.dips.forEach(dip => {
        const hasVeggies = dip.modifiers.some(m => m.name && (m.name.includes('VEGGIES') || m.name.includes('VEGGIE')));
        const hasPita = dip.modifiers.some(m => m.name && m.name.includes('PITA') && !m.name.includes('GLUTEN FREE'));
        const gfPitaMod = dip.modifiers.find(m => m.name && m.name.includes('GLUTEN FREE PITA'));

        if (hasVeggies) {
          dipSideLabels.push({ orderNum, customer, date, container: 'Brown Bowl', item: 'Carrots', qty: dip.qty * 24, category: 'Dip - Veggies' });
          dipSideLabels.push({ orderNum, customer, date, container: 'Brown Bowl', item: 'Celery', qty: dip.qty * 24, category: 'Dip - Veggies' });
        }
        if (hasPita) {
          dipSideLabels.push({ orderNum, customer, date, container: '¬Ω Pan', item: 'Sliced Pita', qty: dip.qty * 6, category: 'Dip - Pitas' });
        }
        if (gfPitaMod) {
          const gfQty = gfPitaMod.gfPitaQty || (dip.qty * 6);
          dipSideLabels.push({ orderNum, customer, date, container: '¬Ω Pan', item: 'GF Pita (Sliced)', qty: gfQty, category: 'Dip - Pitas' });
        }
      });

      // Greek Fries Bar
      prep.greekFries.forEach(fries => {
        greekFriesLabels.push({ orderNum, customer, date, container: '¬Ω Pan', item: 'Greek Fries + Protein', qty: fries.qty, category: 'Greek Fries Bar' });
        greekFriesLabels.push({ orderNum, customer, date, container: '16oz Deli', item: 'Spicy Aioli', qty: 1, category: 'Greek Fries Bar - Toppings' });
        greekFriesLabels.push({ orderNum, customer, date, container: '16oz Deli', item: 'Tzatziki', qty: 1, category: 'Greek Fries Bar - Toppings' });
        greekFriesLabels.push({ orderNum, customer, date, container: '16oz Deli', item: 'Crumbled Feta', qty: 1, category: 'Greek Fries Bar - Toppings' });
      });

      // Dolmas
      prep.dolmas.forEach(dolma => {
        dolmaLabels.push({ orderNum, customer, date, container: '¬Ω Pan', item: getLabelName(dolma.name), qty: dolma.qty, category: 'Dolmas' });
        dolmaLabels.push({ orderNum, customer, date, container: '16oz Deli', item: 'Tzatziki (dill stripe)', qty: dolma.qty, category: 'Dolmas - Sauce' });
      });

      // Spanakopita
      prep.spanakopita.forEach(span => {
        spanakopitaLabels.push({ orderNum, customer, date, container: '¬Ω Pan', item: getLabelName(span.name), qty: span.qty, category: 'Spanakopita' });
        spanakopitaLabels.push({ orderNum, customer, date, container: '16oz Deli', item: 'Tzatziki (dill stripe)', qty: span.qty, category: 'Spanakopita - Sauce' });
      });

      // Sides
      prep.sides.forEach(side => {
        sideLabels.push({ orderNum, customer, date, container: '¬Ω Pan', item: getLabelName(side.name), qty: side.qty, category: 'Side' });
      });

      // Desserts
      prep.desserts.forEach(dessert => {
        dessertLabels.push({ orderNum, customer, date, container: 'Container', item: getLabelName(dessert.name), qty: dessert.qty, category: 'Dessert' });
      });

      // Pinwheels
      prep.pinwheels.forEach(pinwheel => {
        pinwheelLabels.push({ orderNum, customer, date, container: 'Platter', item: getLabelName(pinwheel.name), qty: pinwheel.qty, category: 'Pinwheel' });
      });

      // Concatenate all labels in logical category order
      return [
        ...byoGyroLabels,
        ...saladLabels,
        ...saladDressingLabels,
        ...dipLabels,
        ...dipSideLabels,
        ...greekFriesLabels,
        ...dolmaLabels,
        ...spanakopitaLabels,
        ...sideLabels,
        ...dessertLabels,
        ...pinwheelLabels
      ];
    }

    /**
     * Main function: Print all labels for a catering order
     */
    async function printLabelsViaBluetooth(event, orderId) {
      event.preventDefault();

      if (!bluetoothCharacteristic) {
        // Flash status bar red
        const statusBar = document.getElementById('bluetoothStatus');
        const originalBg = statusBar.style.background;
        const originalBorder = statusBar.style.borderColor;

        statusBar.style.background = '#DC2626';
        statusBar.style.borderColor = '#DC2626';

        setTimeout(() => {
          statusBar.style.background = originalBg;
          statusBar.style.borderColor = originalBorder;
        }, 2000);

        showError('‚ùå PRINTER NOT CONNECTED!\n\nClick "CONNECT PRINTER" at the top first.');
        return;
      }

      try {
        showLoading('Printing Labels', 'Generating labels for all containers...');

        // Fetch order and line items
        const { data: order, error: orderError } = await supabase
          .from('catering_orders')
          .select('*')
          .eq('id', orderId)
          .single();

        if (orderError) throw orderError;

        const { data: lineItems, error: itemsError } = await supabase
          .from('catering_order_items')
          .select('*')
          .eq('order_id', orderId)
          .order('id', { ascending: true });

        if (itemsError) throw itemsError;

        // Calculate prep list
        const prep = calculatePrepList(lineItems || [], order);

        // Generate labels
        const labels = generateLabelsFromPrepList(prep, order);

        console.log(`üè∑Ô∏è Printing ${labels.length} labels...`);

        // Print each label
        for (let i = 0; i < labels.length; i++) {
          showLoading('Printing Labels', `Printing label ${i + 1} of ${labels.length}...`);
          await printLabel(labels[i]);
        }

        hideLoading();

        // Create success modal for printing
        const overlay = document.createElement('div');
        overlay.style.cssText = `position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:100000;padding:20px;`;
        const box = document.createElement('div');
        box.style.cssText = `background:white;padding:24px;max-width:500px;width:100%;border:3px solid #059669;`;
        const title = document.createElement('div');
        title.textContent = '‚úÖ SUCCESS!';
        title.style.cssText = `font-size:18px;font-weight:700;color:#065f46;margin-bottom:12px;text-transform:uppercase;letter-spacing:0.5px;`;
        const msg = document.createElement('div');
        msg.innerHTML = `Printed ${labels.length} labels in grouped order:<br><br>- BYO Gyros<br>- Salads + Dressings<br>- Dips + Sides<br>- Greek Fries<br>- Dolmas<br>- Spanakopita<br>- Sides<br>- Desserts<br>- Pinwheels`;
        msg.style.cssText = `font-size:14px;color:#4a4a4a;margin-bottom:20px;line-height:1.6;`;
        const btn = document.createElement('button');
        btn.textContent = 'OK';
        btn.style.cssText = `width:100%;padding:12px;background:#059669;color:white;border:none;font-weight:700;cursor:pointer;text-transform:uppercase;letter-spacing:0.5px;`;
        btn.onclick = () => overlay.remove();
        box.appendChild(title);
        box.appendChild(msg);
        box.appendChild(btn);
        overlay.appendChild(box);
        document.body.appendChild(overlay);

      } catch (error) {
        console.error('‚ùå Label printing error:', error);
        hideLoading();
        showError(`‚ùå PRINTING FAILED!\n\nError: ${error.message}\n\nCheck:\n1. Printer is still connected\n2. Printer has labels loaded\n3. Printer is turned on`);
      }
    }

    // ==================== END BLUETOOTH THERMAL PRINTER SYSTEM ====================

    // ==================== PASSWORD PROTECTION FOR MANAGER LOGS ====================
    const ADMIN_PASSWORD = 'JaynaGyro2025!';

    // Password-protected access to scheduling page - redirects with session persistence
    function accessScheduling() {
      window.location.href = 'scheduling.html';
    }

    function isManagerSessionValid() {
      const sessionExpiry = localStorage.getItem('managerSession');
      if (!sessionExpiry) return false;

      const now = new Date().getTime();
      const expiryTime = parseInt(sessionExpiry);

      if (now > expiryTime) {
        localStorage.removeItem('managerSession');
        return false;
      }

      return true;
    }

    function setManagerSession() {
      const now = new Date().getTime();
      const expiryTime = now + (60 * 60 * 1000); // 1 hour from now
      localStorage.setItem('managerSession', expiryTime.toString());
    }

    function accessManagerLogs() {
      window.location.href = 'managerlogs.html';
    }

    function requirePasswordFor(featureName, callback) {
      // Check if we have a valid session first
      if (isManagerSessionValid()) {
        callback();
        return;
      }

      // No valid session, show password modal
      showManagerPasswordModal(featureName, callback);
    }

    function showManagerPasswordModal(featureName, callback) {
      const modalHTML = `
        <div id="passwordModal" style="
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0,0,0,0.7);
          z-index: 10000;
          display: flex;
          justify-content: center;
          align-items: center;
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        ">
          <div style="
            background: white;
            padding: 30px;
            border-radius: 0;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            max-width: 400px;
            width: 90%;
            text-align: center;
          ">
            <h3 style="margin: 0 0 20px 0; color: #d32f2f;">Manager Access Required</h3>
            <p style="margin: 0 0 15px 0; line-height: 1.4;">
              <strong>${featureName}</strong> requires manager authorization.
            </p>
            <p style="margin: 0 0 20px 0; color: #666;">
              This feature contains sensitive information and management tools.
            </p>
            <p style="margin: 0 0 15px 0;">Enter manager password:</p>
            <input type="password" id="passwordInput" style="
              width: 80%;
              padding: 10px;
              border: 2px solid #ddd;
              border-radius: 0;
              font-size: 16px;
              text-align: center;
              margin-bottom: 20px;
            " placeholder="Manager Password">
            <div>
              <button onclick="submitManagerPassword()" style="
                background: #4a4a4a;
                color: white;
                border: none;
                padding: 10px 20px;
                border-radius: 0;
                margin: 0 10px;
                cursor: pointer;
                font-size: 16px;
              ">Access ${featureName}</button>
              <button onclick="cancelManagerPassword()" style="
                background: #D32F2F;
                color: white;
                border: none;
                padding: 10px 20px;
                border-radius: 0;
                margin: 0 10px;
                cursor: pointer;
                font-size: 16px;
              ">Cancel</button>
            </div>
          </div>
        </div>
      `;

      document.body.insertAdjacentHTML('beforeend', modalHTML);
      document.getElementById('passwordInput').focus();
      window.managerPasswordCallback = callback;

      document.getElementById('passwordInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          submitManagerPassword();
        }
      });
    }

    async function submitManagerPassword() {
      const password = document.getElementById('passwordInput').value;
      const modal = document.getElementById('passwordModal');

      // Get master password from Supabase (cloud-based, works across ALL devices)
      let masterPassword = ADMIN_PASSWORD;
      try {
        const { data: masterPwdData } = await supabase
          .from('manager_passwords')
          .select('*')
          .eq('username', 'SYSTEM_MASTER_PASSWORD')
          .eq('is_active', true)
          .limit(1)
          .single();

        if (masterPwdData && masterPwdData.full_name) {
          masterPassword = masterPwdData.full_name;
        }
      } catch (error) {
        // No custom master password set, use default
        console.log('Using default master password');
      }

      const customPasswords = JSON.parse(localStorage.getItem('customPasswords') || '[]');
      const validPasswords = [masterPassword, ...customPasswords];

      if (validPasswords.includes(password)) {
        setManagerSession();
        modal.remove();
        showMessage('Manager access granted for 1 hour', 'success');
        window.managerPasswordCallback();
      } else {
        showMessage('Incorrect manager password. Access denied.', 'error');
        modal.remove();
      }
    }

    function cancelManagerPassword() {
      const modal = document.getElementById('passwordModal');
      modal.remove();
    }
    // ==================== END PASSWORD PROTECTION ====================

    // ==================== LIVE STATS (TIPS/HR, TOP LEADER) ====================
    // NOTE: These functions are now provided by app-header.js.
    // Removed duplicate fetchTipsPerHour() and fetchTopLeader() functions.
    // ==================== END LIVE STATS ====================
  </script>

  <!-- Success Overlay (auto-hide after 1.5s) -->
  <div id="successOverlay" style="
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    z-index: 10000;
    justify-content: center;
    align-items: center;
  ">
    <div style="
      text-align: center;
      background: white;
      padding: 40px 50px;
      border-radius: 0;
      border: 3px solid #059669;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      min-width: 300px;
    ">
      <div style="font-size: 48px; margin-bottom: 16px;">‚úÖ</div>
      <div id="successMessage" style="
        font-size: 16px;
        font-weight: 700;
        color: #065f46;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      "></div>
    </div>
  </div>

  <!-- Error Overlay (user must click OK) -->
  <div id="errorOverlay" style="
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    z-index: 10000;
    justify-content: center;
    align-items: center;
  ">
    <div style="
      text-align: center;
      background: white;
      padding: 40px 50px;
      border-radius: 0;
      border: 3px solid #dc2626;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      min-width: 300px;
    ">
      <div style="font-size: 48px; margin-bottom: 16px;">‚ùå</div>
      <div id="errorMessage" style="
        font-size: 14px;
        font-weight: 600;
        color: #991b1b;
        margin-bottom: 24px;
        line-height: 1.5;
      "></div>
      <button onclick="hideError()" style="
        padding: 12px 24px;
        background: #dc2626;
        color: white;
        border: none;
        font-size: 13px;
        font-weight: 700;
        cursor: pointer;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      ">OK</button>
    </div>
  </div>

  <!-- Image Lightbox Modal -->
  <div id="lightboxModal" class="lightbox-modal" onclick="closeLightbox()">
    <button class="lightbox-close" onclick="closeLightbox()">‚úï</button>
    <img id="lightboxImage" class="lightbox-image" onclick="toggleZoom(event); event.stopPropagation();" alt="Full Size Photo">
  </div>

<script src="./app-header.js"></script>
</body>
</html>
