// API endpoint to get pre-processed training content
// Serves static JSON files generated by build script
// No runtime parsing = no errors!

import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

// Get __dirname equivalent in ES modules
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

export default async function handler(req, res) {
  // Handle CORS preflight
  if (req.method === 'OPTIONS') {
    return res.status(200).json({});
  }

  try {
    console.log('=== TRAINING API V2 START ===');
    console.log('Request body:', req.body);
    console.log('Current directory:', process.cwd());
    console.log('API directory:', __dirname);

    const { module_number, unit_number } = req.body;

    console.log(`Requested: Module ${module_number}, Unit ${unit_number}`);

    if (!module_number || !unit_number) {
      console.error('Missing parameters');
      return res.status(400).json({
        error: 'module_number and unit_number are required'
      });
    }

    // Try multiple possible paths
    const filename = `module_${module_number}_unit_${unit_number}.json`;
    const possiblePaths = [
      path.join(process.cwd(), 'training', 'processed', filename),
      path.join(__dirname, '..', 'training', 'processed', filename),
      path.join(process.cwd(), '..', 'training', 'processed', filename)
    ];

    console.log('Trying paths:');
    possiblePaths.forEach((p, i) => console.log(`  ${i + 1}. ${p}`));

    let filePath = null;
    let fileContent = null;

    for (const tryPath of possiblePaths) {
      try {
        if (fs.existsSync(tryPath)) {
          console.log(`✅ Found file at: ${tryPath}`);
          filePath = tryPath;
          fileContent = fs.readFileSync(tryPath, 'utf-8');
          break;
        } else {
          console.log(`❌ Not found: ${tryPath}`);
        }
      } catch (e) {
        console.log(`❌ Error checking ${tryPath}:`, e.message);
      }
    }

    if (!fileContent) {
      console.error(`File not found anywhere: ${filename}`);

      // List what files DO exist
      try {
        const processedDir = path.join(process.cwd(), 'training', 'processed');
        console.log('Checking processed directory:', processedDir);
        if (fs.existsSync(processedDir)) {
          const files = fs.readdirSync(processedDir);
          console.log('Files in processed directory:', files);
        } else {
          console.log('Processed directory does not exist');
        }
      } catch (e) {
        console.error('Error listing directory:', e.message);
      }

      return res.status(404).json({
        error: `Unit ${module_number}.${unit_number} not found`,
        details: `Checked ${possiblePaths.length} possible locations`
      });
    }

    // Parse JSON
    const jsonData = JSON.parse(fileContent);
    console.log(`✅ Successfully loaded and parsed ${filename}`);

    res.setHeader('Content-Type', 'application/json');
    return res.status(200).json(jsonData);

  } catch (error) {
    console.error('=== API ERROR ===');
    console.error('Error type:', error.constructor.name);
    console.error('Error message:', error.message);
    console.error('Error stack:', error.stack);
    return res.status(500).json({
      error: 'Failed to fetch training content',
      details: error.message,
      errorType: error.constructor.name
    });
  }
}
