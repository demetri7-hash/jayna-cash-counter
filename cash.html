<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cash Counter - Jayna Gyro</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    /* Jayna Brand Design - Sky Blue & Grayscale */
    :root {
      --primary-blue: #00A8E1;
      --secondary-blue: #0094D6;
      --light-blue: #E3F4FC;
      --accent-blue: #0081C6;
      --gray-900: #212121;
      --gray-700: #424242;
      --gray-600: #616161;
      --gray-500: #757575;
      --gray-400: #BDBDBD;
      --gray-300: #E0E0E0;
      --gray-100: #F5F5F5;
      --success: #00C853;
      --warning: #FFB300;
      --error: #D32F2F;
      --white: #FFFFFF;
      --blue-bg: #dbeafe;
      --blue-text: #1e40af;
      --success-bg: #d1fae5;
      --success-text: #065f46;
      --success-border: #059669;
      --warning-bg: #fef3c7;
      --warning-text: #92400e;
      --warning-border: #f59e0b;
      --error-bg: #fee2e2;
      --error-text: #991b1b;
      --error-border: #dc2626;
    }

    /* Pen Icon Edit Button */
    .modal-edit-icon {
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s ease;
    }
    .modal-edit-icon:hover {
      background: var(--gray-200);
    }
    .modal-edit-icon svg {
      width: 18px;
      height: 18px;
      fill: var(--gray-700);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body {
      font-family: 'Aptos', 'Segoe UI Variable', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      background: var(--white); /* White background to blend with Google Sites header */
      min-height: 100vh;
      padding: 0;
      overflow-x: hidden;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
      background: var(--white);
      border-radius: 0;
      overflow: visible;
      box-shadow: none; /* Remove shadow for seamless Google Sites embed */
      min-height: auto;
      max-height: none;
    }
    .header {
      background: var(--white);
      color: var(--gray-900);
      text-align: center;
      padding: 12px;
      border-radius: 0;
      border-bottom: 1px solid var(--gray-300);
    }
    .header h1 { font-size: 18px; font-weight: 700; margin-bottom: 2px; letter-spacing: 1.5px; text-transform: uppercase; }
    .header p { opacity: 0.7; font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }
    /* Mobile-First Responsive Design */
    .content {
      padding: 12px;
      /* Google Sites full page embed optimization */
      max-height: none;
      overflow: visible;
    }
    .main-menu { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-bottom: 12px; }
    .secondary-links { display: flex; flex-wrap: wrap; gap: 12px; justify-content: center; margin-bottom: 20px; font-size: 11px; }
    .secondary-links a { color: var(--gray-700); text-decoration: underline; cursor: pointer; transition: color 0.15s ease; }
    .secondary-links a:hover { color: var(--gray-900); }
    .menu-btn {
      padding: 16px 12px !important;
      border: 2px solid var(--gray-700) !important;
      border-radius: 0 !important;
      background: var(--gray-700) !important;
      font-size: 11px !important;
      font-weight: 700 !important;
      color: white !important;
      cursor: pointer !important;
      transition: all 0.15s ease !important;
      text-align: center !important;
      min-height: 50px !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      text-transform: uppercase !important;
      letter-spacing: 1.2px !important;
      text-decoration: none !important;
    }
    .menu-btn:hover {
      background: var(--gray-600) !important;
      border-color: var(--gray-600) !important;
      transform: translateY(-1px);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
    }
    .menu-btn.active {
      border-color: var(--gray-600) !important;
      background: var(--gray-600) !important;
      transform: translateY(-1px);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
    }
    .menu-btn.primary {
      background: var(--gray-100) !important;
      color: var(--gray-900) !important;
      border: 2px solid var(--gray-300) !important;
    }
    .menu-btn.primary:hover {
      background: var(--gray-200) !important;
      border-color: var(--gray-400) !important;
    }
    .form-section { 
      display: none; 
      /* Ensure sections don't get cut off */
      min-height: auto;
      overflow: visible;
    }
    .form-section.active {
      display: block;
      /* Force visibility in Google Sites */
      position: relative;
      z-index: 1;
    }
    .form-group { margin-bottom: 12px; }
    .form-group label {
      display: block;
      margin-bottom: 4px;
      font-weight: 700;
      font-size: 10px;
      color: var(--gray-700);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    /* Enhanced Mobile-Friendly Inputs */
    .form-input, .form-select {
      width: 100%;
      padding: 12px 14px;
      border: 1px solid var(--gray-300);
      border-radius: 0;
      font-size: 14px;
      min-height: 44px;
      box-sizing: border-box;
      -webkit-appearance: none;
      appearance: none;
      transition: all 0.15s ease;
      background: var(--white);
      color: var(--gray-900);
    }
    .form-input:focus, .form-select:focus {
      outline: none;
      border-color: var(--primary-blue);
      box-shadow: 0 0 0 2px rgba(0, 217, 217, 0.15);
      background: var(--white);
    }
    
    /* Number inputs with mobile optimization */
    input[type="number"] {
      -webkit-appearance: none;
      -moz-appearance: textfield;
      appearance: none;
      /* Remove number input arrows */
    }
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    input, select, textarea, button {
      font-size: 16px !important;
    }

    .drawer-section {
      margin: 20px 0;
      border: 2px solid var(--gray-300);
      border-radius: 0;
      overflow: hidden;
    }
    .drawer-header {
      background: var(--light-blue);
      padding: 15px 20px;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 15px;
      color: var(--primary-blue);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .skip-toggle {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 16px;
      color: var(--gray-500);
    }
    .skip-toggle input[type="checkbox"] { width: 20px; height: 20px; }
    .drawer-content { padding: 20px; }
    .denom-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 0;
      border-bottom: 1px solid var(--gray-300);
    }
    .denom-row:last-child { border-bottom: none; }
    .denom-label { font-weight: 500; font-size: 18px; color: var(--gray-700); }
    .denom-value { font-size: 16px; color: var(--gray-500); margin-top: 4px; }

    /* Mobile-Optimized Quantity Inputs */
    .qty-input {
      width: 100px;
      height: 56px;
      text-align: center;
      border: 2px solid var(--gray-300);
      border-radius: 0;
      font-size: 20px;
      font-weight: 500;
      color: var(--gray-700);
      -webkit-appearance: none;
      -moz-appearance: textfield;
      appearance: none;
      transition: all 0.2s ease;
      background: var(--white);
    }
    .qty-input:focus {
      outline: none;
      border-color: var(--primary-blue);
      box-shadow: 0 0 0 3px rgba(44, 95, 141, 0.1);
    }
    /* Remove number arrows */
    .qty-input::-webkit-outer-spin-button,
    .qty-input::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    
    /* Disabled denomination inputs */
    .qty-input:disabled {
      background-color: var(--gray-300);
      color: var(--gray-500);
      border-color: var(--gray-300);
      cursor: not-allowed;
    }

    .denom-row.disabled {
      opacity: 0.5;
    }

    .drawer-total {
      margin-top: 15px;
      padding: 15px;
      background: var(--light-blue);
      border-radius: 0;
      text-align: center;
      font-size: 18px;
      font-weight: 600;
      color: var(--primary-blue);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .grand-total {
      background: linear-gradient(135deg, var(--primary-blue) 0%, var(--secondary-blue) 100%);
      color: var(--white);
      padding: 20px;
      border-radius: 0;
      text-align: center;
      margin: 20px 0;
      box-shadow: 0 4px 12px rgba(44, 95, 141, 0.2);
    }
    .grand-total h3 { font-size: 18px; margin-bottom: 8px; font-weight: 600; opacity: 0.9; text-transform: uppercase; letter-spacing: 0.5px; }
    .grand-total .amount { font-size: 36px; font-weight: 600; }
    .notes-area {
      width: 100%;
      min-height: 100px;
      padding: 18px;
      border: 2px solid var(--gray-300);
      border-radius: 0;
      font-size: 16px;
      resize: vertical;
      box-sizing: border-box;
      transition: all 0.2s ease;
    }
    .notes-area:focus {
      outline: none;
      border-color: var(--primary-blue);
      box-shadow: 0 0 0 3px rgba(44, 95, 141, 0.1);
    }
    .submit-btn {
      padding: 14px 20px;
      background: var(--gray-100);
      color: var(--gray-900);
      border: none;
      border-radius: 0;
      font-size: 12px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.15s ease;
      min-height: 48px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
      text-transform: uppercase;
      letter-spacing: 1.2px;
      border: 2px solid var(--gray-300);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      white-space: nowrap;
    }
    .submit-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.12);
      background: var(--gray-300);
    }
    .submit-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
      background: var(--gray-300);
      color: var(--gray-500);
    }
    .am-total-display {
      background: var(--light-blue);
      padding: 20px;
      border-radius: 0;
      margin: 20px 0;
      border: 2px solid rgba(44, 95, 141, 0.1);
    }
    .am-total-display h4 { margin-bottom: 8px; color: var(--primary-blue); font-size: 16px; font-weight: 500; }
    .am-total-display .amount { font-size: 28px; font-weight: 600; color: var(--primary-blue); }

    /* Enhanced Currency Inputs */
    .currency-input {
      width: 100%;
      padding: 20px;
      border: 2px solid var(--gray-300);
      border-radius: 0;
      font-size: 22px;
      text-align: center;
      min-height: 60px;
      box-sizing: border-box;
      -webkit-appearance: none;
      -moz-appearance: textfield;
      appearance: none;
      transition: all 0.2s ease;
      background: var(--white);
      color: var(--gray-700);
    }
    .currency-input:focus {
      outline: none;
      border-color: var(--primary-blue);
      box-shadow: 0 0 0 3px rgba(44, 95, 141, 0.1);
    }
    .currency-input::-webkit-outer-spin-button,
    .currency-input::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    .confirmation-screen { text-align: center; padding: 40px 20px; }
    .confirmation-screen h2 { color: var(--success); margin-bottom: 30px; font-size: 32px; font-weight: 600; }
    .deposit-instruction {
      background: linear-gradient(135deg, var(--success) 0%, #4A8C63 100%);
      color: var(--white);
      padding: 30px;
      border-radius: 0;
      margin: 25px 0;
      font-size: 24px;
      font-weight: 500;
      box-shadow: 0 4px 12px rgba(95, 167, 119, 0.2);
    }
    .return-instruction {
      background: linear-gradient(135deg, var(--warning) 0%, #C69563 100%);
      color: var(--white);
      padding: 30px;
      border-radius: 0;
      margin: 25px 0;
      font-size: 24px;
      font-weight: 500;
      box-shadow: 0 4px 12px rgba(212, 165, 116, 0.2);
    }
    .thank-you { font-size: 22px; color: var(--success); margin: 30px 0; font-weight: 500; }
    .confirm-btn {
      background: linear-gradient(135deg, var(--success) 0%, #4A8C63 100%);
      margin-top: 30px;
    }
    .loading { text-align: center; padding: 40px; }
    .loading-spinner {
      width: 60px;
      height: 60px;
      border: 6px solid var(--gray-300);
      border-top: 6px solid var(--primary-blue);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .message {
      padding: 18px;
      border-radius: 0;
      margin: 20px 0;
      text-align: center;
      font-size: 15px;
      font-weight: 500;
      letter-spacing: 0.3px;
    }
    .message.success {
      background: #E8F5EC;
      color: #2D5F3F;
      border: 2px solid var(--success);
    }
    .message.error {
      background: #F8E6E7;
      color: #6B3638;
      border: 2px solid var(--error);
    }
    .message.info {
      background: var(--light-blue);
      color: var(--primary-blue);
      border: 2px solid var(--secondary-blue);
    }

    /* Typography - Headers */
    h2, h3, h4, h5, h6 {
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 600;
    }
    h2 { font-size: 22px; }
    h3 { font-size: 19px; }
    h4 { font-size: 16px; }
    h5 { font-size: 14px; }
    h6 { font-size: 12px; }

    /* Tip Pool Calculator Styles */
    .cash-needed { color: var(--error); font-weight: 600; }
    .cash-surplus { color: var(--success); font-weight: 600; }
    .hidden { display: none; }
    .skip-content { padding: 25px; }
    .skip-reason {
      width: 100%;
      padding: 18px;
      border: 2px solid var(--gray-300);
      border-radius: 0;
      font-size: 16px;
      min-height: 56px;
      box-sizing: border-box;
      transition: all 0.2s ease;
    }
    .skip-reason:focus {
      outline: none;
      border-color: var(--primary-blue);
      box-shadow: 0 0 0 3px rgba(44, 95, 141, 0.1);
    }
    
    /* Mobile responsive adjustments */
    @media (max-width: 768px) {
      .container { margin: 0; border-radius: 0; }
      .header { padding: 20px; }
      .header h1 { font-size: 24px; }
      .content { padding: 15px; }
      .main-menu { gap: 12px; }
      .menu-btn { padding: 25px 15px; font-size: 16px; min-height: 70px; }
      .denom-row { flex-direction: column; align-items: flex-start; gap: 12px; padding: 20px 0; }
      .qty-input { width: 120px; margin-top: 8px; }
      .grand-total .amount { font-size: 32px; }
      .confirmation-screen h2 { font-size: 28px; }
      .deposit-instruction, .return-instruction { font-size: 20px; padding: 25px; }
    }
    
    @media (max-width: 768px) {
      .main-menu { grid-template-columns: 1fr 1fr; gap: 12px; }
    }

    @media (max-width: 480px) {
      .header h1 { font-size: 20px; }
      .main-menu { grid-template-columns: 1fr; gap: 10px; }
      .main-menu.show-report { grid-template-columns: 1fr; }
      .menu-btn { padding: 20px 15px; min-height: 60px; }
      .secondary-links { font-size: 10px; gap: 10px; }
      .denom-label { font-size: 16px; }
      .qty-input { width: 100px; height: 50px; font-size: 18px; }
      .grand-total .amount { font-size: 28px; }
      .deposit-instruction, .return-instruction { font-size: 18px; padding: 20px; }
    }
    
    /* Google Sites Full Page Embed Optimizations */
    @media screen {
      html {
        /* Force proper viewport handling in Google Sites */
        height: auto !important;
        min-height: 100% !important;
        overflow-y: auto !important;
      }
      
      body {
        /* Ensure body can scroll properly in Google Sites iframe */
        height: auto !important;
        min-height: 100% !important;
        position: relative !important;
        overflow-y: auto !important;
        padding-bottom: 50px !important; /* Extra space at bottom */
      }
      
      .container {
        /* Ensure container doesn't get viewport-locked */
        position: relative !important;
        height: auto !important;
        min-height: auto !important;
        max-height: none !important;
        overflow: visible !important;
        margin-bottom: 50px !important; /* Extra bottom margin */
      }
      
      .submit-btn {
        /* Ensure submit buttons are always accessible */
        position: relative !important;
        z-index: 10 !important;
        margin-bottom: 30px !important;
      }
      
      /* Force visibility of bottom elements in Google Sites */
      .form-section:last-child,
      .form-section .submit-btn:last-child {
        margin-bottom: 100px !important;
      }
    }
    
    /* Elegant Loading Overlay */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      z-index: 9999;
      display: flex;
      justify-content: center;
      align-items: center;
      transition: opacity 0.3s ease;
    }
    .loading-overlay.hidden {
      display: none;
    }
    .loading-content {
      text-align: center;
      padding: 40px;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 0;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    .loading-spinner-elegant {
      width: 60px;
      height: 60px;
      border: 4px solid rgba(102, 126, 234, 0.1);
      border-top: 4px solid #667eea;
      border-radius: 50%;
      animation: spin-elegant 1.2s linear infinite;
      margin: 0 auto 20px;
    }
    @keyframes spin-elegant {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .loading-content h3 {
      margin: 0 0 10px 0;
      font-size: 24px;
      color: #333;
      font-weight: 600;
    }
    .loading-content p {
      margin: 0;
      font-size: 16px;
      color: #666;
      opacity: 0.8;
    }
    
    /* Success Screens */
    .success-screen {
      text-align: center;
      padding: 40px 20px;
      max-width: 600px;
      margin: 0 auto;
    }
    .success-icon {
      font-size: 80px;
      margin-bottom: 20px;
      animation: success-bounce 0.6s ease;
    }
    @keyframes success-bounce {
      0% { transform: scale(0.3); opacity: 0; }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); opacity: 1; }
    }
    .success-screen h2 {
      color: #28a745;
      margin-bottom: 15px;
      font-size: 32px;
      font-weight: 700;
    }
    .success-message {
      font-size: 18px;
      color: #666;
      margin-bottom: 30px;
      line-height: 1.5;
    }
    .success-details {
      background: #f8f9fa;
      border-radius: 0;
      padding: 25px;
      margin: 25px 0;
      border-left: 4px solid #28a745;
    }
    .detail-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      font-size: 16px;
    }
    .detail-row:not(:last-child) {
      border-bottom: 1px solid #e9ecef;
    }
    .detail-row span:first-child {
      color: #666;
      font-weight: 500;
    }
    .detail-row span:last-child {
      color: #333;
      font-weight: 600;
    }
    .success-btn {
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
      margin-top: 30px;
      font-size: 18px;
      padding: 20px 40px;
      border-radius: 0;
      transition: all 0.3s ease;
    }
    .success-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(40, 167, 69, 0.3);
    }
  </style>
  
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
  <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
  <!-- Tip Pool Calculator Dependencies -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

  <!-- OCR Dependencies -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>
    // Configure PDF.js worker
    if (typeof pdfjsLib !== 'undefined') {
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    }
  </script>
</head>
</head>
<body>

<div id="appHeader"></div>
<script src="./app-header.js"></script>

<div class="container">
  <div class="content">
    <div id="messageArea"></div>
      <div id="amForm" class="form-section">
        <h2 style="margin-bottom: 20px; color: #1e3c72;">Morning Cash Count</h2>
        
        <div class="form-group">
          <label for="amDate">Date:</label>
          <input type="date" id="amDate" class="form-input" required>
        </div>
        
        <div class="form-group">
          <label for="amCounter">Counted by:</label>
          <select id="amCounter" class="form-select" onchange="toggleDenominationInputs('am')" required>
            <option value="">Choose Name</option>
            <option value="Demetri Gregorakis">Demetri Gregorakis</option>
            <option value="Dilan Uzum">Dilan Uzum</option>
            <option value="Katerina Perakis">Katerina Perakis</option>
            <option value="Kayla Mccullough">Kayla Mccullough</option>
          </select>
        </div>
        
        <!-- Drawer 1 -->
        <div class="drawer-section">
          <div class="drawer-header">
            <span>Drawer 1</span>
            <label class="skip-toggle">
              <input type="checkbox" id="amDrawer1Skip" onchange="toggleSkip('am', 1)">
              Skip Drawer
            </label>
          </div>
          <div id="amDrawer1Content" class="drawer-content">
            <div id="amDrawer1Denoms"></div>
            <div class="drawer-total" id="amDrawer1Total">$0.00</div>
          </div>
          <div id="amDrawer1SkipContent" class="skip-content hidden">
            <input type="text" class="skip-reason" id="amDrawer1Reason" placeholder="Reason for skipping drawer 1">
          </div>
        </div>
        
        <!-- Drawer 2 -->
        <div class="drawer-section">
          <div class="drawer-header">
            <span>Drawer 2</span>
            <label class="skip-toggle">
              <input type="checkbox" id="amDrawer2Skip" onchange="toggleSkip('am', 2)">
              Skip Drawer
            </label>
          </div>
          <div id="amDrawer2Content" class="drawer-content">
            <div id="amDrawer2Denoms"></div>
            <div class="drawer-total" id="amDrawer2Total">$0.00</div>
          </div>
          <div id="amDrawer2SkipContent" class="skip-content hidden">
            <input type="text" class="skip-reason" id="amDrawer2Reason" placeholder="Reason for skipping drawer 2">
          </div>
        </div>
        
        <div class="grand-total">
          <h3>Total Cash Count</h3>
          <div class="amount" id="amGrandTotal">$0.00</div>
        </div>
        
        <div class="form-group">
          <label for="amNotes">Notes (Optional):</label>
          <textarea id="amNotes" class="notes-area" placeholder="Any notes for the PM shift..."></textarea>
        </div>
        
        <button class="submit-btn" onclick="submitAM()">Submit AM Count</button>
        <button class="submit-btn" onclick="goHome()" style="margin-top: 10px;">Back to Menu</button>
      </div>
      
      <!-- PM Count Form -->
      <div id="pmForm" class="form-section">
        <h2 style="margin-bottom: 20px; color: #1e3c72;">Evening Cash Close</h2>
        
        <div class="form-group">
          <label for="pmDate">Date:</label>
          <input type="date" id="pmDate" class="form-input" required>
        </div>
        
        <div class="form-group">
          <label for="pmCounter">Counted by:</label>
          <select id="pmCounter" class="form-select" onchange="toggleDenominationInputs('pm')" required>
            <option value="">Choose Name</option>
            <option value="Demetri Gregorakis">Demetri Gregorakis</option>
            <option value="Dilan Uzum">Dilan Uzum</option>
            <option value="Katerina Perakis">Katerina Perakis</option>
            <option value="Kayla Mccullough">Kayla Mccullough</option>
          </select>
        </div>
        
        <!-- AM Total Display -->
        <div id="amTotalDisplay" class="am-total-display">
          <h4>Morning Count Information:</h4>
          <div style="display: flex; justify-content: space-between; margin: 10px 0; font-size: 14px;">
            <span><strong>Counted by:</strong> <span id="amCounterName">Loading...</span></span>
            <span><strong>Time:</strong> <span id="amCountTime">Loading...</span></span>
          </div>
          <div style="text-align: center; margin: 15px 0;">
            <strong>Starting Amount:</strong>
            <div class="amount" id="pmAmTotal" style="font-size: 28px; margin: 5px 0;">Loading...</div>
          </div>
          <div id="amNotesDisplay" style="background: #fff3cd; padding: 12px; border-radius: 0; margin-top: 15px; border-left: 4px solid #ffc107; display: none;">
            <strong style="color: #856404;">Morning Notes:</strong>
            <div id="amNotes" style="margin-top: 5px; color: #856404;"></div>
          </div>
        </div>
        
        <!-- Drawer 1 -->
        <div class="drawer-section">
          <div class="drawer-header">
            <span>Drawer 1</span>
            <label class="skip-toggle">
              <input type="checkbox" id="pmDrawer1Skip" onchange="toggleSkip('pm', 1)">
              Skip Drawer
            </label>
          </div>
          <div id="pmDrawer1Content" class="drawer-content">
            <div id="pmDrawer1Denoms"></div>
            <div class="drawer-total" id="pmDrawer1Total">$0.00</div>
          </div>
          <div id="pmDrawer1SkipContent" class="skip-content hidden">
            <input type="text" class="skip-reason" id="pmDrawer1Reason" placeholder="Reason for skipping drawer 1">
          </div>
        </div>
        
        <!-- Drawer 2 -->
        <div class="drawer-section">
          <div class="drawer-header">
            <span>Drawer 2</span>
            <label class="skip-toggle">
              <input type="checkbox" id="pmDrawer2Skip" onchange="toggleSkip('pm', 2)">
              Skip Drawer
            </label>
          </div>
          <div id="pmDrawer2Content" class="drawer-content">
            <div id="pmDrawer2Denoms"></div>
            <div class="drawer-total" id="pmDrawer2Total">$0.00</div>
          </div>
          <div id="pmDrawer2SkipContent" class="skip-content hidden">
            <input type="text" class="skip-reason" id="pmDrawer2Reason" placeholder="Reason for skipping drawer 2">
          </div>
        </div>
        
        <div class="grand-total">
          <h3>Total Cash Count</h3>
          <div class="amount" id="pmGrandTotal">$0.00</div>
        </div>
        
        <div class="form-group">
          <label for="toastSales">Toast Cash Sales (Auto-Calculated):</label>
          
          <!-- Auto-calculated display section -->
          <div style="background: var(--gray-100); border: 2px solid var(--gray-300); border-radius: 0; padding: 20px; margin-bottom: 10px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
              <span style="font-weight: 700; color: var(--gray-900); font-size: 16px;">Auto-Fetched from Toast API</span>
              <span style="background: var(--gray-100); color: var(--gray-900); padding: 6px 12px; border-radius: 0; font-size: 12px; font-weight: 600; border: 2px solid var(--gray-300);">
                LIVE DATA
              </span>
            </div>

            <div style="text-align: center; margin: 15px 0;">
              <div style="font-size: 32px; font-weight: bold; color: var(--gray-900); margin-bottom: 8px;" id="autoToastAmount">Loading...</div>
              <div style="font-size: 14px; color: var(--gray-700); font-weight: 500;" id="autoToastDetails">Fetching today's cash sales automatically...</div>
            </div>

            <div style="background: var(--white); padding: 10px; border-radius: 0; font-size: 13px; color: var(--gray-700); border: 1px solid var(--gray-300);">
              <strong>Fully Automated:</strong> This amount is automatically calculated from today's Toast POS cash transactions. No manual entry required.
            </div>
          </div>
          
          <!-- Hidden field for form processing -->
          <input type="hidden" id="toastSales" value="0">
        </div>
        
        <!-- Discrepancy Validation Section -->
        <div id="discrepancySection" class="form-group" style="display: none;">
          <label>Cash Count vs Toast Sales Validation:</label>
          <div id="discrepancyDisplay" style="border-radius: 0; padding: 20px; margin-bottom: 10px;">
            <!-- Dynamic content will be inserted here -->
          </div>
        </div>
        
        <div class="form-group">
          <label for="cashTips">Cash Tips (whole number):</label>
          <input type="number" id="cashTips" class="currency-input" placeholder="0" step="1" min="0" inputmode="numeric" pattern="[0-9]*" onfocus="this.select()">
        </div>
        
        <div class="form-group">
          <label for="pmNotes">Notes (Optional):</label>
          <textarea id="pmNotes" class="notes-area" placeholder="Any notes about the day..."></textarea>
        </div>
        
        <button class="submit-btn" onclick="submitPM()">Submit PM Close</button>
        <button class="submit-btn" onclick="goHome()" style="margin-top: 10px;">Back to Menu</button>
      </div>

      <!-- AM Success Screen -->
      <div id="amSuccessScreen" class="form-section">
        <div class="success-screen">
          <div class="success-icon"></div>
          <h2>AM Count Submitted!</h2>
          <p class="success-message">Your morning cash count has been successfully recorded and stored.</p>
          <div class="success-details">
            <div class="detail-row">
              <span>Total Counted:</span>
              <span id="amSuccessTotal">$0.00</span>
            </div>
            <div class="detail-row">
              <span>Time Submitted:</span>
              <span id="amSuccessTime">--</span>
            </div>
          </div>
          <button class="submit-btn success-btn" onclick="goHome()">Return to Menu</button>
        </div>
      </div>

      <!-- PM Success Screen -->
      <div id="pmSuccessScreen" class="form-section">
        <div class="success-screen">
          <div class="success-icon"></div>
          <h2>PM Close Completed!</h2>
          <p class="success-message">Evening close successful! Report sent to management.</p>
          
          <div class="deposit-instruction">
            DEPOSIT <span id="depositAmount">$0</span> INTO ENVELOPE
          </div>
          
          <div class="return-instruction">
            RETURN <span id="returnAmount">$0.00</span> TO CASH BOX AND LOCK IN SAFE
          </div>
          
          <button class="submit-btn success-btn" onclick="goHome()">Confirm and Close</button>
        </div>
      </div>

  </div></div>
<script>
    localStorage.removeItem('cashSession');
  }
  
  let supabase = null;
  let currentAMData = null;
  
  // Initialize app
  document.addEventListener('DOMContentLoaded', function() {
    initializeSupabase();
    initializeEmailJS();
    setTodayDate();

    // Load custom vendor formats from database
    loadCustomVendorFormats();

    // Load saved data (removed loadTipPoolData to reset tip pool fields every time)
    loadCombinedReportData();

    // Initialize TDS data and button state
    resetTdsData();
    updateCalculateButtonState();

    // Add file upload listeners to show status when files are selected
    document.getElementById('laborFile').addEventListener('change', handleFileUpload);
    document.getElementById('salesFile').addEventListener('change', handleFileUpload);

    // Event delegation for delete buttons in inventory list
    document.addEventListener('click', function(event) {
      if (event.target.classList.contains('delete-item-btn')) {
        const itemId = parseInt(event.target.getAttribute('data-delete-item'));
        if (itemId) {
          deleteInventoryItem(itemId);
        }
      }
    });

    // Check auto-print status on initial page load (PREP tab is default)
    setTimeout(() => checkAutoPrintStatus(), 500);

    // Removed "App ready" message to prevent page bouncing
  });
  
  function initializeSupabase() {
    if (SUPABASE_URL === 'YOUR_SUPABASE_URL_HERE' || SUPABASE_ANON_KEY === 'YOUR_SUPABASE_ANON_KEY_HERE') {
      showMessage('Please configure Supabase credentials', 'error');
      return;
    }
    try {
      supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      console.log('Supabase initialized');
    } catch (error) {
      console.error('Supabase init failed:', error);
      showMessage('Database connection failed', 'error');
    }
  }
  
  function initializeEmailJS() {
    if (typeof emailjs !== 'undefined') {
      emailjs.init(EMAILJS_CONFIG.PUBLIC_KEY);
    }
  }
  
  function setTodayDate() {
    const today = getPacificDate();
    document.getElementById('amDate').value = today;
    document.getElementById('pmDate').value = today;
    document.getElementById('reportDate').value = today;
    
    // Add password protection to date inputs
    document.getElementById('amDate').addEventListener('change', function() {
      const result = validateDateChange(this);
      if (result instanceof Promise) {
        // Handle async validation - input value already reset if needed
        return;
      }
    });
    
    document.getElementById('pmDate').addEventListener('change', function() {
      const result = validateDateChange(this);
      if (result instanceof Promise) {
        result.then((success) => {
          if (success) {
            // Only load AM data if date change was authorized
            loadAMData();
            // Also reload Toast cash sales for the new date
            fetchToastCashSalesForDate(this.value);
          }
        });
      } else if (result) {
        // Synchronous case (current date selected)
        loadAMData();
        // Also reload Toast cash sales for the new date
        fetchToastCashSalesForDate(this.value);
      }
    });
    
    document.getElementById('reportDate').addEventListener('change', function() {
      const result = validateDateChange(this);
      if (result instanceof Promise) {
        // Handle async validation - input value already reset if needed
        return;
      }
    });
  }
  
  const PACIFIC_TIMEZONE = 'America/Los_Angeles';

  /**
   * Determine the offset (in minutes) for Pacific time at a specific moment.
   * We rely on Intl to hand us either PDT/PST or a GMT offset string.
   */
  function getPacificOffsetMinutes(date) {
    const parts = new Intl.DateTimeFormat('en-US', {
      timeZone: PACIFIC_TIMEZONE,
      timeZoneName: 'short'
    }).formatToParts(date);

    const tzName = parts.find(part => part.type === 'timeZoneName')?.value || 'PST';

    if (tzName.includes('PDT')) return 420; // UTC-7
    if (tzName.includes('PST')) return 480; // UTC-8

    const gmtMatch = tzName.match(/GMT([+-]\d{2})(\d{2})?/i);
    if (gmtMatch) {
      const hours = parseInt(gmtMatch[1], 10);
      const minutes = gmtMatch[2] ? parseInt(gmtMatch[2], 10) : 0;
      return Math.abs(hours) * 60 + minutes;
    }

    // Default to standard time if we hit an unexpected string.
    return 480;
  }

  /**
   * Create a Date that represents a Pacific-local wall clock time by
   * translating the supplied components into the correct UTC instant.
   * We default to 12:00 (noon) to avoid DST edge cases right at midnight.
   */
  function createPacificDate(year, month, day, hour = 12, minute = 0, second = 0) {
    const utcMillis = Date.UTC(year, month - 1, day, hour, minute, second);
    const tempUtcDate = new Date(utcMillis);
    const offsetMinutes = getPacificOffsetMinutes(tempUtcDate);
    return new Date(utcMillis + offsetMinutes * 60000);
  }

  /**
   * Convert any JS Date into a Pacific-local date (defaulting to midday).
   */
  function getPacificMidday(date = new Date()) {
    const parts = new Intl.DateTimeFormat('en-US', {
      timeZone: PACIFIC_TIMEZONE,
      year: 'numeric',
      month: '2-digit',
      day: '2-digit'
    }).formatToParts(date);

    const year = Number(parts.find(part => part.type === 'year')?.value);
    const month = Number(parts.find(part => part.type === 'month')?.value);
    const day = Number(parts.find(part => part.type === 'day')?.value);

    return createPacificDate(year, month, day, 12, 0, 0);
  }

  /**
   * Parse a YYYY-MM-DD string into a Pacific-local Date (midday).
   */
  function parsePacificDate(dateString) {
    if (!dateString) return null;
    const [year, month, day] = dateString.split('-').map(Number);
    if (!year || !month || !day) return null;
    return createPacificDate(year, month, day, 12, 0, 0);
  }

  /**
   * Format a Date as YYYY-MM-DD in Pacific time.
   */
  function formatPacificDate(date) {
    if (!date) return '';
    const parts = new Intl.DateTimeFormat('en-US', {
      timeZone: PACIFIC_TIMEZONE,
      year: 'numeric',
      month: '2-digit',
      day: '2-digit'
    }).formatToParts(date);

    const year = parts.find(part => part.type === 'year')?.value;
    const month = parts.find(part => part.type === 'month')?.value;
    const day = parts.find(part => part.type === 'day')?.value;

    return `${year}-${month}-${day}`;
  }

  /**
   * Format helper for display strings while forcing Pacific timezone.
   */
  function formatPacificDateDisplay(date, options = {}) {
    if (!date) return '';
    return new Intl.DateTimeFormat('en-US', {
      timeZone: PACIFIC_TIMEZONE,
      ...options
    }).format(date);
  }

  function formatPacificWeekday(date) {
    return formatPacificDateDisplay(date, { weekday: 'long' });
  }

  function getPacificHour(date) {
    if (!date) return null;
    const hourString = new Intl.DateTimeFormat('en-US', {
      timeZone: PACIFIC_TIMEZONE,
      hour: '2-digit',
      hour12: false
    }).format(date);
    return Number(hourString);
  }

  /**
   * Add days to a Pacific Date and return the normalized Pacific midday Date.
   */
  function addPacificDays(date, days) {
    if (!date) return null;
    const pacificMidday = getPacificMidday(date);
    const nextUtc = new Date(pacificMidday.getTime() + days * 86400000);
    return getPacificMidday(nextUtc);
  }

  /**
   * Return the current Pacific date as YYYY-MM-DD (optionally pass a Date).
   */
  function getPacificDate(date = new Date()) {
    return formatPacificDate(date);
  }
  
  function showMessage(text, type) {
    // Only show popups for important messages (errors), ignore info/success
    if (type === 'error') {
      showPopupMessage(text, type);
    }
    // Silently ignore info and success messages to prevent bouncing
  }
  
  function showPopupMessage(text, type) {
    const messageType = type === 'error' ? 'Error' : type === 'success' ? 'Success' : 'Notice';
    const backgroundColor = type === 'error' ? '#f44336' : '#4CAF50';
    const iconEmoji = '';
    
    const modalHTML = `
      <div id="messageModal" style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.7);
        z-index: 10000;
        display: flex;
        justify-content: center;
        align-items: center;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      ">
        <div style="
          background: white;
          padding: 30px;
          border-radius: 0;
          box-shadow: 0 10px 30px rgba(0,0,0,0.3);
          max-width: 400px;
          width: 90%;
          text-align: center;
        ">
          <h3 style="margin: 0 0 20px 0; color: ${backgroundColor};">${iconEmoji} ${messageType}</h3>
          <p style="margin: 0 0 25px 0; line-height: 1.4; font-size: 16px;">
            ${text}
          </p>
          <button onclick="closeMessageModal()" style="
            background: ${backgroundColor};
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 0;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
          ">OK</button>
        </div>
      </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
  }
  
  function closeMessageModal() {
    const modal = document.getElementById('messageModal');
    if (modal) {
      modal.remove();
    }
  }
  
  function validateDateChange(inputElement) {
    const selectedDate = inputElement.value;
    const currentDate = getPacificDate();
    
    // If user selects current date, allow it
    if (selectedDate === currentDate) {
      return true;
    }
    
    // If user selects different date, require password using custom modal
    return new Promise((resolve) => {
      showPasswordModal(selectedDate, currentDate, (success) => {
        if (!success) {
          inputElement.value = currentDate;
        }
        resolve(success);
      });
    });
  }
  
  function showPasswordModal(selectedDate, currentDate, callback) {
    // Create modal HTML
    const modalHTML = `
      <div id="passwordModal" style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.7);
        z-index: 10000;
        display: flex;
        justify-content: center;
        align-items: center;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      ">
        <div style="
          background: white;
          padding: 30px;
          border-radius: 0;
          box-shadow: 0 10px 30px rgba(0,0,0,0.3);
          max-width: 400px;
          width: 90%;
          text-align: center;
        ">
          <h3 style="margin: 0 0 20px 0; color: #d32f2f;">Date Change Warning</h3>
          <p style="margin: 0 0 15px 0; line-height: 1.4;">
            You are trying to change the date from<br>
            <strong>TODAY (${currentDate})</strong> to <strong>${selectedDate}</strong>
          </p>
          <p style="margin: 0 0 20px 0; color: #d32f2f; font-weight: bold;">
            This could overwrite existing data!
          </p>
          <p style="margin: 0 0 15px 0;">Enter admin password to continue:</p>
          <input type="password" id="passwordInput" style="
            width: 80%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 0;
            font-size: 16px;
            text-align: center;
            margin-bottom: 20px;
          " placeholder="Password">
          <div>
            <button onclick="submitPassword()" style="
              background: var(--gray-700);
              color: white;
              border: none;
              padding: 10px 20px;
              border-radius: 0;
              margin: 0 10px;
              cursor: pointer;
              font-size: 16px;
            ">Continue</button>
            <button onclick="cancelPassword()" style="
              background: var(--error);
              color: white;
              border: none;
              padding: 10px 20px;
              border-radius: 0;
              margin: 0 10px;
              cursor: pointer;
              font-size: 16px;
            ">Cancel</button>
          </div>
        </div>
      </div>
    `;
    
    // Add modal to page
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // Focus password input
    document.getElementById('passwordInput').focus();
    
    // Store callback for button handlers
    window.passwordModalCallback = callback;
    
    // Add enter key support
    document.getElementById('passwordInput').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        submitPassword();
      }
    });
  }
  
  function submitPassword() {
    const password = document.getElementById('passwordInput').value;
    const modal = document.getElementById('passwordModal');
    
    if (password === ADMIN_PASSWORD) {
      // Silent success - no bouncing message
      modal.remove();
      window.passwordModalCallback(true);
    } else {
      showMessage('Incorrect password. Date has been reset to today for safety.', 'error');
      modal.remove();
      window.passwordModalCallback(false);
    }
  }
  
  function cancelPassword() {
    const modal = document.getElementById('passwordModal');
    modal.remove();
    window.passwordModalCallback(false);
  }

  // General password protection function for manager features
  function requirePasswordFor(featureName, callback) {
    // Check if we have a valid session first
    if (isManagerSessionValid()) {
      // Session is valid, proceed directly
      callback();
      return;
    }

    // No valid session, show password modal
    showManagerPasswordModal(featureName, callback);
  }

  // Catering access function - redirects to catering.html with session persistence
  function accessCatering() {
    window.location.href = 'catering.html';
  }

  // Manager Logs access function - redirects to managerlogs.html with session persistence
  function accessManagerLogs() {
    window.location.href = 'managerlogs.html';
  }

  // Scheduling access function - redirects to scheduling.html with session persistence
  function accessScheduling() {
    window.location.href = 'scheduling.html';
  }

  function showManagerPasswordModal(featureName, callback) {
    // Create modal HTML for manager features
    const modalHTML = `
      <div id="passwordModal" style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.7);
        z-index: 10000;
        display: flex;
        justify-content: center;
        align-items: center;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      ">
        <div style="
          background: white;
          padding: 30px;
          border-radius: 0;
          box-shadow: 0 10px 30px rgba(0,0,0,0.3);
          max-width: 400px;
          width: 90%;
          text-align: center;
        ">
          <h3 style="margin: 0 0 20px 0; color: #d32f2f;">Manager Access Required</h3>
          <p style="margin: 0 0 15px 0; line-height: 1.4;">
            <strong>${featureName}</strong> requires manager authorization.
          </p>
          <p style="margin: 0 0 20px 0; color: #666;">
            This feature contains sensitive financial data and management tools.
          </p>
          <p style="margin: 0 0 15px 0;">Enter manager password:</p>
          <input type="password" id="passwordInput" style="
            width: 80%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 0;
            font-size: 16px;
            text-align: center;
            margin-bottom: 20px;
          " placeholder="Manager Password">
          <div>
            <button onclick="submitManagerPassword()" style="
              background: var(--gray-700);
              color: white;
              border: none;
              padding: 10px 20px;
              border-radius: 0;
              margin: 0 10px;
              cursor: pointer;
              font-size: 16px;
            ">Access ${featureName}</button>
            <button onclick="cancelManagerPassword()" style="
              background: var(--error);
              color: white;
              border: none;
              padding: 10px 20px;
              border-radius: 0;
              margin: 0 10px;
              cursor: pointer;
              font-size: 16px;
            ">Cancel</button>
          </div>
        </div>
      </div>
    `;
    
    // Add modal to page
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // Focus password input
    document.getElementById('passwordInput').focus();
    
    // Store callback for button handlers
    window.managerPasswordCallback = callback;
    
    // Add enter key support
    document.getElementById('passwordInput').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        submitManagerPassword();
      }
    });
  }

  async function submitManagerPassword() {
    const password = document.getElementById('passwordInput').value;
    const modal = document.getElementById('passwordModal');

    // Get master password from Supabase (cloud-based, works across ALL devices)
    let masterPassword = ADMIN_PASSWORD;
    try {
      const { data: masterPwdData } = await supabase
        .from('manager_passwords')
        .select('*')
        .eq('username', 'SYSTEM_MASTER_PASSWORD')
        .eq('is_active', true)
        .limit(1)
        .single();

      if (masterPwdData && masterPwdData.full_name) {
        masterPassword = masterPwdData.full_name;
      }
    } catch (error) {
      // No custom master password set, use default
      console.log('Using default master password');
    }

    const customPasswords = JSON.parse(localStorage.getItem('customPasswords') || '[]');
    const validPasswords = [masterPassword, ...customPasswords];

    if (validPasswords.includes(password)) {
      // Success - set manager session and execute the protected function
      setManagerSession();
      modal.remove();
      showMessage('Manager access granted for 1 hour', 'success');
      // Update the session status display immediately
      updateSessionStatus();
      window.managerPasswordCallback();
    } else {
      showMessage('Incorrect manager password. Access denied.', 'error');
      modal.remove();
    }
  }

  function cancelManagerPassword() {
    const modal = document.getElementById('passwordModal');
    modal.remove();
    // Don't call callback on cancel
  }
  
  function logoutManager() {
    clearManagerSession();
    updateSessionStatus();
    showMessage('Manager session ended', 'success');
  }
  
  function updateSessionStatus() {
    const statusElement = document.getElementById('sessionStatus');
    const logoutBtn = document.getElementById('logoutBtn');
    
    if (!statusElement || !logoutBtn) return; // Elements not ready yet
    
    if (isManagerSessionValid()) {
      const sessionExpiry = localStorage.getItem('managerSession');
      const expiryTime = parseInt(sessionExpiry);
      const now = new Date().getTime();
      const remainingMinutes = Math.ceil((expiryTime - now) / (60 * 1000));
      
      statusElement.textContent = `Manager access: ${remainingMinutes} min remaining`;
      statusElement.style.color = '#28a745';
      logoutBtn.style.display = 'inline-block';
    } else {
      statusElement.textContent = '';
      statusElement.style.color = '#666';
      logoutBtn.style.display = 'none';
    }
  }
  
  // Update session status every minute
  setInterval(updateSessionStatus, 60000);
  
  // Initialize session status when page loads
  window.addEventListener('load', function() {
    setTimeout(updateSessionStatus, 100); // Small delay to ensure DOM is ready
  });
  
  function logoutManager() {
    clearManagerSession();
    updateSessionStatus();
    showMessage('Manager session ended', 'success');
  }
  
  function updateSessionStatus() {
    const statusElement = document.getElementById('sessionStatus');
    const logoutBtn = document.getElementById('logoutBtn');
    
    if (isManagerSessionValid()) {
      const sessionExpiry = localStorage.getItem('managerSession');
      const expiryTime = parseInt(sessionExpiry);
      const now = new Date().getTime();
      const remainingMinutes = Math.ceil((expiryTime - now) / (60 * 1000));
      
      statusElement.textContent = `Manager access: ${remainingMinutes} min remaining`;
      statusElement.style.color = '#28a745';
      logoutBtn.style.display = 'inline-block';
    } else {
      statusElement.textContent = '';
      statusElement.style.color = '#666';
      logoutBtn.style.display = 'none';
    }
  }
  
  // Update session status every minute
  setInterval(updateSessionStatus, 60000);
  
  // Update session status on page load
  document.addEventListener('DOMContentLoaded', updateSessionStatus);

  // ==================== TOAST CLOCKED IN DISPLAY ====================

  async function fetchClockedInEmployees() {
    try {
      // Get TODAY in YYYY-MM-DD format (Pacific time)
      const todayPacific = new Date().toLocaleString('en-US', {
        timeZone: 'America/Los_Angeles',
        year: 'numeric',
        month: '2-digit',
        day: '2-digit'
      });

      const [month, day, year] = todayPacific.split(', ')[0].split('/');
      const today = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;

      console.log(' Fetching clocked-in employees from Toast for:', today);

      // STEP 1: Authenticate with Toast API (like fetchToastCashSalesForDate does)
      const authResponse = await fetch('/api/toast-auth', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      });

      if (!authResponse.ok) {
        console.error(' Failed to authenticate with Toast API');
        updateClockedInDisplay([]);
        return;
      }

      const authData = await authResponse.json();
      if (!authData.success || !authData.data?.accessToken) {
        console.error(' Toast authentication failed');
        updateClockedInDisplay([]);
        return;
      }

      const token = authData.data.accessToken;
      console.log(' Toast authenticated');

      // STEP 2: Fetch clocked-in employees via serverless function (avoids CORS)
      const clockedInUrl = `/api/toast-clocked-in?date=${today}&token=${encodeURIComponent(token)}`;

      console.log(' Fetching clocked-in employees from serverless function');

      const response = await fetch(clockedInUrl);

      if (!response.ok) {
        console.error(' Failed to fetch clocked-in employees:', response.status);
        updateClockedInDisplay([]);
        return;
      }

      const result = await response.json();

      if (!result.success) {
        console.error(' Clocked-in API error:', result.error);
        updateClockedInDisplay([]);
        return;
      }

      console.log(` Total time entries today: ${result.totalTimeEntries}`);
      console.log(` Currently clocked in: ${result.count} employees`);

      if (result.clockedIn.length > 0) {
        console.log(' Clocked in employees:', result.clockedIn);
      }

      // Extract employee names
      const employees = result.clockedIn.map(emp => emp.fullName);

      updateClockedInDisplay(employees);

    } catch (error) {
      console.error(' Error fetching clocked in employees:', error);
      updateClockedInDisplay([]);
    }
  }

  function updateClockedInDisplay(employees) {
    const listDiv = document.getElementById('clockedInList');

    if (!listDiv) return;

    if (employees.length === 0) {
      listDiv.innerHTML = '<span style="color: #999; font-size: 11px; font-style: italic;">No one clocked in</span>';
      return;
    }

    // Display names in green separated by pipes with "clocked in" caption at bottom
    const namesText = employees.join(' | ');
    listDiv.innerHTML = `
      <div style="color: #2e7d32; font-size: 12px; font-weight: 500;">
        ${namesText}
      </div>
      <div style="color: #666; font-size: 9px; margin-top: 3px; text-transform: uppercase; letter-spacing: 0.5px;">
        Clocked In
      </div>
    `;
  }

  // ==================== TIPS PER HOUR DISPLAY ====================

    let lastTipsUpdate = null;


  async function fetchTipsPerHour() {
    try {
      const response = await fetch('/api/toast-tips-per-hour-today', {
        method: 'POST'
      });

      if (!response.ok) {
        updateTipsPerHourDisplay(null);
        return;
      }

      const result = await response.json();

      if (result.success && result.data) {
          lastTipsUpdate = new Date();

        updateTipsPerHourDisplay(result.data);
          updateLastUpdatedTime();

      } else {
        updateTipsPerHourDisplay(null);
      }
    } catch (error) {
      console.error('Error fetching tips per hour:', error);
      updateTipsPerHourDisplay(null);
    }
  }

  function updateTipsPerHourDisplay(data) {
      const displayDiv = document.getElementById('tipsPerHourText');
      const cardDiv = document.getElementById('tipsPerHourCard');

      if (!displayDiv) return;

      if (!data) {
        displayDiv.innerHTML = '<div style="font-size: 14px;">-</div>';
        return;
      }

      // Dynamic card color based on trend
      const bgGradient = data.trendingUp
        ? 'linear-gradient(135deg, #059669 0%, #10b981 100%)'
        : 'linear-gradient(135deg, #dc2626 0%, #ef4444 100%)';
      const borderColor = data.trendingUp ? '#059669' : '#dc2626';

      if (cardDiv) {
        cardDiv.style.background = bgGradient;
        cardDiv.style.borderColor = borderColor;
      }

      const arrow = data.trendingUp ? '' : '';

      // Main number (large and bold)
      let html = `<div style="font-size: 28px; font-weight: 900; color: #fff; line-height: 1;">
        ${arrow} $${data.tipsPerHour.toFixed(2)}/hr
      </div>`;

      // Comparison stats (smaller, below main number)
      html += `<div style="margin-top: 6px; font-size: 10px; color: rgba(255,255,255,0.85); line-height: 1.4;">`;

      if (data.percentChangeFromLastHour !== null && data.percentChangeFromLastHour !== undefined) {
        const hourArrow = data.percentChangeFromLastHour >= 0 ? '' : '';
        html += `<div>${hourArrow} ${data.percentChangeFromLastHour > 0 ? '+' : ''}${data.percentChangeFromLastHour}% vs last hour</div>`;
      }

      if (data.percentChangeFromYesterday !== null) {
        const dayArrow = data.percentChangeFromYesterday >= 0 ? '' : '';
        html += `<div>${dayArrow} ${data.percentChangeFromYesterday > 0 ? '+' : ''}${data.percentChangeFromYesterday.toFixed(1)}% vs yesterday</div>`;
      }

      if (data.percentChangeFromLastWeek !== null) {
        const weekArrow = data.percentChangeFromLastWeek >= 0 ? '' : '';
        html += `<div>${weekArrow} ${data.percentChangeFromLastWeek > 0 ? '+' : ''}${data.percentChangeFromLastWeek.toFixed(1)}% vs last week</div>`;
      }

      html += `</div>`;

      displayDiv.innerHTML = html;
    }

  function updateLastUpdatedTime() {
    const lastUpdatedDiv = document.getElementById('tipsLastUpdated');
    if (!lastUpdatedDiv || !lastTipsUpdate) return;

    const now = new Date();
    const diffMs = now - lastTipsUpdate;
    const diffSec = Math.floor(diffMs / 1000);
    const diffMin = Math.floor(diffSec / 60);

    let timeAgo = '';
    if (diffMin < 1) {
      timeAgo = 'Just now';
    } else if (diffMin === 1) {
      timeAgo = '1 minute ago';
    } else if (diffMin < 60) {
      timeAgo = `${diffMin} minutes ago`;
    } else {
      const diffHour = Math.floor(diffMin / 60);
      timeAgo = diffHour === 1 ? '1 hour ago' : `${diffHour} hours ago`;
    }

    lastUpdatedDiv.textContent = `LAST UPDATED: ${timeAgo}`;
  }

  // ==================== TOP LEADER DISPLAY ====================

  async function fetchTopLeader() {
    try {
      // Get Pacific time start/end of today (STARTING AT 5AM, NOT MIDNIGHT)
      const nowPacific = new Date(new Date().toLocaleString('en-US', { timeZone: 'America/Los_Angeles' }));
      const currentHour = nowPacific.getHours();

      // If it's before 5 AM, we're still in "yesterday's" shift
      const todayStart = new Date(nowPacific);
      if (currentHour < 5) {
        // Use yesterday at 5 AM
        todayStart.setDate(todayStart.getDate() - 1);
        todayStart.setHours(5, 0, 0, 0);
      } else {
        // Use today at 5 AM
        todayStart.setHours(5, 0, 0, 0);
      }

      // End time is tomorrow at 4:59:59 AM (covers the full shift)
      const todayEnd = new Date(todayStart);
      todayEnd.setDate(todayEnd.getDate() + 1);
      todayEnd.setHours(4, 59, 59, 999);

      const startISO = todayStart.toISOString();
      const endISO = todayEnd.toISOString();

      console.log(' Fetching leaderboard data for range:', startISO, 'to', endISO);

      // Fetch FOH tasks
      const { data: tasks, error: tasksError } = await supabase
        .from('foh_checklist_tasks')
        .select('completed_by, completed_at, is_completed')
        .eq('is_completed', true)
        .gte('completed_at', startISO)
        .lte('completed_at', endISO);

      console.log(` Found ${tasks?.length || 0} completed FOH tasks`);

      // Fetch prep count actions
      const { data: prepCounts, error: prepError } = await supabase
        .from('prep_count_log')
        .select('counted_by, counted_at')
        .gte('counted_at', startISO)
        .lte('counted_at', endISO);

      console.log(` Found ${prepCounts?.length || 0} prep count actions`);

      // Log prep count names for debugging
      if (prepCounts && prepCounts.length > 0) {
        const prepNames = prepCounts.map(p => p.counted_by);
        console.log(' Prep count names:', prepNames);
      }

      // Combine counts
      const leaderboard = {};

      // Count FOH tasks
      if (tasks && tasks.length > 0) {
        tasks.forEach(task => {
          const name = task.completed_by || 'Unknown';
          if (!leaderboard[name]) {
            leaderboard[name] = { name, count: 0, lastActivity: null };
          }
          leaderboard[name].count++;
          const activityTime = new Date(task.completed_at);
          if (!leaderboard[name].lastActivity || activityTime > leaderboard[name].lastActivity) {
            leaderboard[name].lastActivity = activityTime;
          }
        });
      }

      // Count prep actions
      if (prepCounts && prepCounts.length > 0) {
        prepCounts.forEach(prep => {
          const name = prep.counted_by || 'Unknown';
          if (!leaderboard[name]) {
            leaderboard[name] = { name, count: 0, lastActivity: null };
          }
          leaderboard[name].count++;
          const activityTime = new Date(prep.counted_at);
          if (!leaderboard[name].lastActivity || activityTime > leaderboard[name].lastActivity) {
            leaderboard[name].lastActivity = activityTime;
          }
        });
      }

      // Check if we have any data
      if (Object.keys(leaderboard).length === 0) {
        updateTopLeaderDisplay(null);
        return;
      }

      // Sort and get top leader
      const sortedLeaderboard = Object.values(leaderboard)
        .sort((a, b) => {
          if (b.count !== a.count) return b.count - a.count;
          return b.lastActivity - a.lastActivity;
        });

      console.log(' Full leaderboard breakdown:');
      sortedLeaderboard.forEach((player, index) => {
        console.log(`  ${index + 1}. ${player.name}: ${player.count} points`);
      });
      console.log(' Top leader:', sortedLeaderboard[0].name, 'with', sortedLeaderboard[0].count, 'points');

      updateTopLeaderDisplay(sortedLeaderboard[0]);

    } catch (error) {
      console.error('Error fetching top leader:', error);
      updateTopLeaderDisplay(null);
    }
  }

  function updateTopLeaderDisplay(leader) {
    const displayDiv = document.getElementById('topLeaderText');
    if (!displayDiv) return;

    if (!leader) {
      displayDiv.textContent = 'No activity yet today! ';
      return;
    }

    displayDiv.textContent = `${leader.name} is crushing it with ${leader.count} action${leader.count !== 1 ? 's' : ''}! `;
  }

  // ==================== END TOP LEADER DISPLAY ====================

  // ==================== VOID & DISCOUNT TRACKING DISPLAY ====================

  async function fetchVoidDiscountTracking() {
    try {
      // Get TODAY in YYYY-MM-DD format (Pacific time)
      const todayPacific = new Date().toLocaleString('en-US', {
        timeZone: 'America/Los_Angeles',
        year: 'numeric',
        month: '2-digit',
        day: '2-digit'
      });

      const [month, day, year] = todayPacific.split(', ')[0].split('/');
      const today = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;

      // Authenticate with Toast API
      const authResponse = await fetch('/api/toast-auth', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      });

      if (!authResponse.ok) {
        updateVoidDiscountDisplay(null);
        return;
      }

      const authData = await authResponse.json();
      if (!authData.success || !authData.data?.accessToken) {
        updateVoidDiscountDisplay(null);
        return;
      }

      const token = authData.data.accessToken;

      // Fetch tracking data (using today as both start and end date)
      const trackingUrl = `/api/toast-void-discount-tracking?startDate=${today}&endDate=${today}&token=${encodeURIComponent(token)}`;
      const response = await fetch(trackingUrl);

      if (!response.ok) {
        updateVoidDiscountDisplay(null);
        return;
      }

      const trackingData = await response.json();

      if (trackingData.success) {
        updateVoidDiscountDisplay(trackingData);
      } else {
        updateVoidDiscountDisplay(null);
      }
    } catch (error) {
      console.error(' Error fetching void/discount tracking:', error);
      updateVoidDiscountDisplay(null);
    }
  }

  function updateVoidDiscountDisplay(data) {
    const displayDiv = document.getElementById('voidDiscountDisplay');
    if (!displayDiv) return;

    if (!data) {
      displayDiv.innerHTML = '<span style="color: var(--gray-500); font-style: italic;">Unable to load data</span>';
      return;
    }

    // Display counts with | separator
    const voidCount = data.voidedOrders?.count || 0;
    const discountCount = data.discounts?.count || 0;
    const refundCount = data.refunds?.count || 0;
    const voidedPaymentCount = data.voidedPayments?.count || 0;

    displayDiv.innerHTML = `VOIDED ORDERS: ${voidCount} | DISCOUNTS: ${discountCount} | REFUNDS: ${refundCount} | VOIDED PAYMENTS: ${voidedPaymentCount}`;
  }

  // ==================== END VOID & DISCOUNT TRACKING DISPLAY ====================

  // Fetch on page load
  document.addEventListener('DOMContentLoaded', function() {
    fetchClockedInEmployees();
    fetchTipsPerHour(); // Add tips/hr fetch
    fetchTopLeader(); // Add top leader fetch
    fetchVoidDiscountTracking(); // Add void/discount tracking

    // Auto-refresh every 5 minutes
    setInterval(fetchClockedInEmployees, 5 * 60 * 1000);
    setInterval(fetchTipsPerHour, 30 * 1000);
    setInterval(fetchTopLeader, 2 * 60 * 1000); // Refresh every 2 minutes
    setInterval(fetchVoidDiscountTracking, 5 * 60 * 1000); // Refresh every 5 minutes

    // Update "time ago" display every 30 seconds
    setInterval(updateLastUpdatedTime, 30 * 1000);
  });

  // ==================== END CLOCKED IN DISPLAY ====================

  function hideAllSections() {
    console.log('hideAllSections() called - this might be hiding tip pool results!');
    console.trace('hideAllSections call stack');
    document.querySelectorAll('.form-section').forEach(section => section.classList.remove('active'));
  }
  
  function goHome() {
    console.log('goHome() called - this will hide tip pool results!');
    console.trace('goHome call stack');
    hideAllSections();
    document.getElementById('mainMenu').style.display = 'grid';
    
    // Reset container width
    const container = document.querySelector('.container');
    if (container) {
      container.style.maxWidth = '600px';
    }
  }

  // Toast API Integration
  let autoCalculatedToastAmount = 0;
  
  async function fetchToastCashSales() {
    // Use today's date by default
    const today = new Date();
    const businessDate = formatDateForToast(today);
    await fetchToastCashSalesForDate(businessDate);
  }

  async function fetchToastCashSalesForDate(dateInput) {
    // Show loading state
    document.getElementById('autoToastAmount').textContent = 'Loading...';
    document.getElementById('autoToastDetails').textContent = 'Fetching live data from Toast API...';
    
    try {
      // Handle both date string (YYYY-MM-DD) and formatted date (YYYYMMDD)
      let businessDate;
      if (dateInput.includes('-')) {
        // Convert YYYY-MM-DD to YYYYMMDD
        const dateObj = new Date(dateInput + 'T12:00:00'); // Add time to avoid timezone issues
        businessDate = formatDateForToast(dateObj);
      } else {
        // Already in YYYYMMDD format
        businessDate = dateInput;
      }
      
      console.log('Auto-fetching Toast cash sales for:', businessDate);
      
      // First authenticate with Toast
      const authResponse = await fetch('/api/toast-auth', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      });
      
      if (!authResponse.ok) {
        throw new Error('Failed to authenticate with Toast API');
      }
      
      const authData = await authResponse.json();
      if (!authData.success || !authData.data?.accessToken) {
        throw new Error('Toast authentication failed');
      }
      
      // Fetch cash sales using payments API
      const paymentsUrl = `/api/toast-payments?businessDate=${businessDate}&token=${encodeURIComponent(authData.data.accessToken)}`;
      const paymentsResponse = await fetch(paymentsUrl);
      
      if (!paymentsResponse.ok) {
        throw new Error('Failed to fetch Toast payments data');
      }
      
      const paymentsData = await paymentsResponse.json();
      if (!paymentsData.success) {
        throw new Error(paymentsData.error || 'Toast payments API returned an error');
      }
      
      // Store the auto-calculated amount
      autoCalculatedToastAmount = paymentsData.totalCashAmount;
      
      // Update the hidden field for form processing
      document.getElementById('toastSales').value = autoCalculatedToastAmount.toFixed(2);
      
      // Show success result
      document.getElementById('autoToastAmount').textContent = `$${autoCalculatedToastAmount.toFixed(2)}`;
      document.getElementById('autoToastDetails').textContent = 
        `${paymentsData.totalCashPayments} cash payments  ${paymentsData.totalPaymentGuids} total transactions  Auto-synced`;
      
      console.log('Toast cash sales auto-fetched successfully:', autoCalculatedToastAmount);
      
      // Trigger discrepancy validation if we're in PM mode
      const pmGrandTotal = document.getElementById('pmGrandTotal');
      if (pmGrandTotal && pmGrandTotal.textContent !== '$0.00') {
        const pmTotal = parseFloat(pmGrandTotal.textContent.replace('$', '').replace(',', '')) || 0;
        validatePMDiscrepancy(pmTotal);
      }
      
    } catch (error) {
      console.error('Toast API auto-fetch error:', error);
      
      // Show error state but don't provide fallback
      document.getElementById('autoToastAmount').textContent = 'API Error';
      document.getElementById('autoToastDetails').textContent = 
        `Failed to fetch: ${error.message}  Please check internet connection and try again`;
      
      // Reset auto amount
      autoCalculatedToastAmount = 0;
      document.getElementById('toastSales').value = '0';
    }
  }

  function formatDateForToast(date) {
    // Convert to YYYYMMDD format for Toast API
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}${month}${day}`;
  }
  
  function startAMCount() {
    // Keep main menu visible at top
    hideAllSections();
    document.getElementById('amForm').classList.add('active');
    setupDenominations('am');
  }
  
  async function startPMCount() {
    // Keep main menu visible at top
    hideAllSections();
    document.getElementById('pmForm').classList.add('active');
    setupDenominations('pm');

    await loadAMData();

    // Automatically fetch Toast cash sales when PM section loads
    console.log('PM Count started - automatically fetching Toast cash sales...');
    try {
      await fetchToastCashSales();
    } catch (error) {
      console.error('Auto-fetch Toast sales failed:', error);
      // Don't block the UI - user can still proceed manually if needed
    }
  }

  /**
   * Smart Cash Button - Time-based AM/PM flow with password protection
   * 7AM-7PM PT: AM Count
   * 7PM-2AM PT: PM Close
   * 2AM-7AM PT: No flow available
   */
  function startSmartCashFlow() {
    // Check if session is valid
    if (isCashSessionValid()) {
      // Session valid, proceed directly
      loadCashFlowByTime();
      return;
    }

    // No valid session, show password modal
    showCashPasswordModal();
  }

  function showCashPasswordModal() {
    const modal = document.createElement('div');
    modal.id = 'cashPasswordModal'; // Add unique ID for safe removal
    modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10000;';

    modal.innerHTML = `
      <div style="background: white; padding: 40px; border-radius: 0; border: 3px solid var(--gray-700); max-width: 400px; width: 90%;">
        <h3 style="margin: 0 0 20px 0; font-size: 18px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;">Cash Flow Access</h3>
        <p style="margin-bottom: 20px; color: var(--gray-700); font-size: 13px;">Enter password to access cash counting:</p>
        <input type="password" id="cashPasswordInput" placeholder="Enter password" style="width: 100%; padding: 12px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 14px; margin-bottom: 20px; box-sizing: border-box;" />
        <div style="display: flex; gap: 12px;">
          <button onclick="closeCashPasswordModal()" style="flex: 1; padding: 12px 24px; background: var(--gray-100); border: 2px solid var(--gray-300); color: var(--gray-900); font-size: 13px; font-weight: 700; cursor: pointer; text-transform: uppercase; letter-spacing: 0.5px;">Cancel</button>
          <button onclick="verifyCashPassword()" style="flex: 1; padding: 12px 24px; background: var(--gray-900); border: 2px solid var(--gray-900); color: white; font-size: 13px; font-weight: 700; cursor: pointer; text-transform: uppercase; letter-spacing: 0.5px;">Submit</button>
        </div>
      </div>
    `;

    document.body.appendChild(modal);

    // Focus password input
    setTimeout(() => {
      document.getElementById('cashPasswordInput').focus();
    }, 100);

    // Add enter key support
    document.getElementById('cashPasswordInput').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        verifyCashPassword();
      }
    });
  }

  function closeCashPasswordModal() {
    const modal = document.getElementById('cashPasswordModal');
    if (modal && modal.parentNode) {
      modal.parentNode.removeChild(modal);
    }
  }

  function verifyCashPassword() {
    const input = document.getElementById('cashPasswordInput');
    if (!input) {
      console.error('Cash password input not found');
      return;
    }

    const password = input.value;

    if (password === CASH_PASSWORD) {
      // Set 30-minute session
      setCashSession();

      // Remove modal
      closeCashPasswordModal();

      // Load appropriate flow
      loadCashFlowByTime();
    } else {
      showMessage('Incorrect password. Access denied.', 'error');
      closeCashPasswordModal();
    }
  }

  function loadCashFlowByTime() {
    // Get Pacific time
    const now = new Date();
    const pacificTime = new Date(now.toLocaleString('en-US', { timeZone: 'America/Los_Angeles' }));
    const hour = pacificTime.getHours();

    console.log(`Smart Cash Flow: Pacific hour is ${hour}`);

    // 7AM-7PM (07:00-19:00): AM Count
    if (hour >= 7 && hour < 19) {
      console.log('Loading AM Count (7AM-7PM)');
      startAMCount();
    }
    // 7PM-2AM (19:00-02:00): PM Close
    else if (hour >= 19 || hour < 2) {
      console.log('Loading PM Close (7PM-2AM)');
      startPMCount();
    }
    // 2AM-7AM: No flow available
    else {
      console.log('No cash flow available (2AM-7AM)');
      showMessage('Cash counting is not available at this time. Please try between 7:00 AM and 2:00 AM Pacific Time.', 'error');
    }
  }

  // ===== MANUAL CASH FLOW NAVIGATION =====
  // Detect hash fragments from WATCHDOG manual buttons
  document.addEventListener('DOMContentLoaded', function() {
    const hash = window.location.hash;

    if (hash === '#am-count') {
      console.log('Manual AM Count triggered via hash');
      window.location.hash = ''; // Clear hash to prevent repeated triggers
      startSmartCashFlowManual('am');
    } else if (hash === '#pm-count') {
      console.log('Manual PM Count triggered via hash');
      window.location.hash = ''; // Clear hash to prevent repeated triggers
      startSmartCashFlowManual('pm');
    }
  });

  function startSmartCashFlowManual(flowType) {
    // Check if session is valid
    if (isCashSessionValid()) {
      // Session valid, proceed directly
      if (flowType === 'am') {
        startAMCount();
      } else {
        startPMCount();
      }
      return;
    }

    // No valid session, show password modal with manual flow type
    showCashPasswordModalManual(flowType);
  }

  function showCashPasswordModalManual(flowType) {
    const flowName = flowType === 'am' ? 'AM Count (Morning Baseline)' : 'PM Count (Evening Close)';
    const modal = document.createElement('div');
    modal.id = 'cashPasswordModal';
    modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10000;';

    modal.innerHTML = `
      <div style="background: white; padding: 40px; border-radius: 0; border: 3px solid var(--gray-700); max-width: 400px; width: 90%;">
        <h3 style="margin: 0 0 20px 0; font-size: 18px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;">Manual Cash Flow Access</h3>
        <p style="margin-bottom: 20px; color: var(--gray-700); font-size: 13px;">Enter password to access <strong>${flowName}</strong>:</p>
        <input type="password" id="cashPasswordInput" placeholder="Enter password" style="width: 100%; padding: 12px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 14px; margin-bottom: 20px; box-sizing: border-box;" />
        <div style="display: flex; gap: 12px;">
          <button onclick="closeCashPasswordModal()" style="flex: 1; padding: 12px 24px; background: var(--gray-100); border: 2px solid var(--gray-300); color: var(--gray-900); font-size: 13px; font-weight: 700; cursor: pointer; text-transform: uppercase; letter-spacing: 0.5px;">Cancel</button>
          <button onclick="verifyCashPasswordManual('${flowType}')" style="flex: 1; padding: 12px 24px; background: var(--gray-900); border: 2px solid var(--gray-900); color: white; font-size: 13px; font-weight: 700; cursor: pointer; text-transform: uppercase; letter-spacing: 0.5px;">Submit</button>
        </div>
      </div>
    `;

    document.body.appendChild(modal);

    setTimeout(() => {
      document.getElementById('cashPasswordInput').focus();
    }, 100);

    document.getElementById('cashPasswordInput').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        verifyCashPasswordManual(flowType);
      }
    });
  }

  function verifyCashPasswordManual(flowType) {
    const input = document.getElementById('cashPasswordInput');
    if (!input) {
      console.error('Cash password input not found');
      return;
    }

    const password = input.value;

    if (password === CASH_PASSWORD) {
      setCashSession();
      closeCashPasswordModal();

      // Load specified flow
      if (flowType === 'am') {
        startAMCount();
      } else {
        startPMCount();
      }
    } else {
      showMessage('Incorrect password. Access denied.', 'error');
      closeCashPasswordModal();
    }
  }

  function showReports() {
    // Keep main menu visible at top
    hideAllSections();
    document.getElementById('reportsForm').classList.add('active');
  }
  
  function showTipPool() {
    // Keep main menu visible at top
    hideAllSections();
    document.getElementById('tipPoolForm').classList.add('active');
    
    // Show results if we have loaded data
    if (tipPoolRecords.length > 0) {
      document.getElementById('tipPoolResults').style.display = 'block';
      document.getElementById('tipPoolPdfBtn').style.display = 'inline-block';
      document.getElementById('combinedReportSection').style.display = 'block';
    }
  }
  
  // ===== CASHBOX FUNCTIONS =====
  
  function showCashbox() {
    // Keep main menu visible at top
    hideAllSections();
    document.getElementById('cashboxSection').classList.add('active');
    loadPreviousCashboxData();
  }
  
  function toggleCashboxDenominationInputs() {
    const counterSelect = document.getElementById('cashboxCounter');
    const otherNameGroup = document.getElementById('cashboxOtherNameGroup');
    const denominationInputs = document.getElementById('cashboxDenominationInputs');
    
    if (counterSelect.value === 'Other') {
      otherNameGroup.style.display = 'block';
    } else {
      otherNameGroup.style.display = 'none';
    }
    
    if (counterSelect.value && counterSelect.value !== '') {
      denominationInputs.style.display = 'block';
    } else {
      denominationInputs.style.display = 'none';
    }
  }
  
  function calculateCashboxTotal() {
    const denominations = [
      { id: 'cashbox_hundreds', value: 100 },
      { id: 'cashbox_fifties', value: 50 },
      { id: 'cashbox_twenties', value: 20 },
      { id: 'cashbox_tens', value: 10 },
      { id: 'cashbox_fives', value: 5 },
      { id: 'cashbox_ones', value: 1 },
      { id: 'cashbox_quarters', value: 0.25 },
      { id: 'cashbox_dimes', value: 0.10 },
      { id: 'cashbox_nickels', value: 0.05 },
      { id: 'cashbox_pennies', value: 0.01 }
    ];
    
    let total = 0;
    denominations.forEach(denom => {
      const count = parseInt(document.getElementById(denom.id).value) || 0;
      total += count * denom.value;
    });
    
    document.getElementById('cashboxTotal').textContent = `$${total.toFixed(2)}`;
    return total;
  }
  
  async function loadPreviousCashboxData() {
    try {
      // Get the most recent cashbox count for reconciliation
      const { data, error } = await supabase
        .from('cashbox_counts')
        .select('*')
        .order('date', { ascending: false })
        .limit(1);
      
      if (error) throw error;
      
      if (data && data.length > 0) {
        const lastCount = data[0];
        showReconciliation(lastCount);
      }
    } catch (error) {
      console.error('Error loading previous cashbox data:', error);
    }
  }
  
  function showReconciliation(lastCount) {
    const reconciliationSection = document.getElementById('cashboxReconciliation');
    const reconciliationDetails = document.getElementById('reconciliationDetails');

    const lastDate = new Date(lastCount.date).toLocaleDateString();
    const lastAmount = lastCount.total;

    reconciliationDetails.innerHTML = `
      <div style="margin-bottom: 10px;">
        <strong>Previous Cashbox Count:</strong> ${lastDate} - $${lastAmount.toFixed(2)}
      </div>
      <div style="margin-bottom: 10px; font-size: 12px; color: #856404;">
        <strong>Reconciliation Logic:</strong><br>
        Expected This Week = Previous Week + Daily Discrepancies<br>
        <em>Note: AM register loading amounts do not affect total cashbox reconciliation</em>
      </div>
      <div style="font-size: 12px; color: #856404;">
        After entering your count, we'll calculate discrepancies and verify reconciliation.
      </div>
    `;

    reconciliationSection.style.display = 'block';
  }

  // Tip Pool Cashbox Functions (separate from main cashbox counting)
  function toggleTipPoolCashboxInputs() {
    const counterSelect = document.getElementById('tipPoolCashboxCounter');
    const otherNameGroup = document.getElementById('tipPoolCashboxOtherNameGroup');
    const denominationInputs = document.getElementById('tipPoolCashboxDenominationInputs');

    if (counterSelect.value === 'Other') {
      otherNameGroup.style.display = 'block';
    } else {
      otherNameGroup.style.display = 'none';
    }

    if (counterSelect.value && counterSelect.value !== '') {
      denominationInputs.style.display = 'block';
    } else {
      denominationInputs.style.display = 'none';
    }
  }

  function calculateTipPoolCashboxTotal() {
    const denominations = [
      { id: 'tipPool_cashbox_hundreds', value: 100 },
      { id: 'tipPool_cashbox_fifties', value: 50 },
      { id: 'tipPool_cashbox_twenties', value: 20 },
      { id: 'tipPool_cashbox_tens', value: 10 },
      { id: 'tipPool_cashbox_fives', value: 5 },
      { id: 'tipPool_cashbox_ones', value: 1 },
      { id: 'tipPool_cashbox_quarters', value: 0.25 },
      { id: 'tipPool_cashbox_dimes', value: 0.10 },
      { id: 'tipPool_cashbox_nickels', value: 0.05 },
      { id: 'tipPool_cashbox_pennies', value: 0.01 }
    ];

    let total = 0;
    denominations.forEach(denom => {
      const count = parseInt(document.getElementById(denom.id).value) || 0;
      total += count * denom.value;
    });

    document.getElementById('tipPoolCashboxTotal').textContent = `$${total.toFixed(2)}`;
    return total;
  }

  function getTipPoolCashboxData() {
    // Get counter name
    const counterSelect = document.getElementById('tipPoolCashboxCounter');
    let counterName = counterSelect.value;

    if (counterName === 'Other') {
      counterName = document.getElementById('tipPoolCashboxOtherName').value;
    }

    // If no counter selected, return null (optional feature)
    if (!counterName) {
      return null;
    }

    // Get total
    const total = calculateTipPoolCashboxTotal();

    // If total is 0, return null
    if (total === 0) {
      return null;
    }

    // Get denominations
    const denominations = {
      hundreds: parseInt(document.getElementById('tipPool_cashbox_hundreds').value) || 0,
      fifties: parseInt(document.getElementById('tipPool_cashbox_fifties').value) || 0,
      twenties: parseInt(document.getElementById('tipPool_cashbox_twenties').value) || 0,
      tens: parseInt(document.getElementById('tipPool_cashbox_tens').value) || 0,
      fives: parseInt(document.getElementById('tipPool_cashbox_fives').value) || 0,
      ones: parseInt(document.getElementById('tipPool_cashbox_ones').value) || 0,
      quarters: parseInt(document.getElementById('tipPool_cashbox_quarters').value) || 0,
      dimes: parseInt(document.getElementById('tipPool_cashbox_dimes').value) || 0,
      nickels: parseInt(document.getElementById('tipPool_cashbox_nickels').value) || 0,
      pennies: parseInt(document.getElementById('tipPool_cashbox_pennies').value) || 0
    };

    return {
      counter: counterName,
      total: total,
      denominations: denominations,
      date: getPacificDate()
    };
  }

  async function saveCashboxCountFromTipPool(cashboxData) {
    try {
      console.log(' Saving cashbox count from tip pool:', cashboxData);

      // Save to database
      const { data, error } = await supabase
        .from('cashbox_counts')
        .insert([{
          date: cashboxData.date,
          counter: cashboxData.counter,
          total: cashboxData.total,
          denominations: cashboxData.denominations,
          notes: 'Entered from tip pool calculator'
        }]);

      if (error) {
        // Check if it's a duplicate date error
        if (error.code === '23505') {
          console.log(' Cashbox count already exists for this date, updating instead...');
          const { data: updateData, error: updateError } = await supabase
            .from('cashbox_counts')
            .update({
              counter: cashboxData.counter,
              total: cashboxData.total,
              denominations: cashboxData.denominations,
              notes: 'Updated from tip pool calculator'
            })
            .eq('date', cashboxData.date);

          if (updateError) throw updateError;
          console.log(' Cashbox count updated successfully');
        } else {
          throw error;
        }
      } else {
        console.log(' Cashbox count saved successfully');
      }

      return cashboxData.total;
    } catch (error) {
      console.error(' Error saving cashbox count:', error);
      throw error;
    }
  }

  async function saveCashboxCount() {
    try {
      const counterSelect = document.getElementById('cashboxCounter');
      const otherName = document.getElementById('cashboxOtherName').value;
      
      let counterName = counterSelect.value;
      if (counterName === 'Other') {
        counterName = otherName;
      }
      
      if (!counterName) {
        throw new Error('Please select or enter a name');
      }
      
      const total = calculateCashboxTotal();
      if (total === 0) {
        throw new Error('Please enter denomination counts');
      }
      
      const denominations = {
        hundreds: parseInt(document.getElementById('cashbox_hundreds').value) || 0,
        fifties: parseInt(document.getElementById('cashbox_fifties').value) || 0,
        twenties: parseInt(document.getElementById('cashbox_twenties').value) || 0,
        tens: parseInt(document.getElementById('cashbox_tens').value) || 0,
        fives: parseInt(document.getElementById('cashbox_fives').value) || 0,
        ones: parseInt(document.getElementById('cashbox_ones').value) || 0,
        quarters: parseInt(document.getElementById('cashbox_quarters').value) || 0,
        dimes: parseInt(document.getElementById('cashbox_dimes').value) || 0,
        nickels: parseInt(document.getElementById('cashbox_nickels').value) || 0,
        pennies: parseInt(document.getElementById('cashbox_pennies').value) || 0
      };
      
      const { data, error } = await supabase
        .from('cashbox_counts')
        .insert([{
          date: getPacificDate(),
          counter: counterName,
          denominations: denominations,
          total: total,
          timestamp: new Date().toISOString()
        }]);
      
      if (error) throw error;
      
      showMessage(`Cashbox count saved successfully! Total: $${total.toFixed(2)}`, 'success');
      
      // Reset form
      document.getElementById('cashboxCounter').value = '';
      document.getElementById('cashboxOtherName').value = '';
      toggleCashboxDenominationInputs();
      
      // Reset all denomination inputs
      Object.keys(denominations).forEach(key => {
        document.getElementById(`cashbox_${key}`).value = '0';
      });
      calculateCashboxTotal();
      
    } catch (error) {
      showMessage(error.message, 'error');
    }
  }
  
  async function saveCashboxCountFromReport(total) {
    try {
      const counterName = tipPoolSummary.calculatedByName || 'Unknown';
      
      const { data, error } = await supabase
        .from('cashbox_counts')
        .insert([{
          date: getPacificDate(),
          counter: counterName,
          denominations: { manual_entry: true }, // Mark as manual entry from report
          total: total,
          timestamp: new Date().toISOString(),
          notes: 'Entered during combined report generation'
        }]);
      
      if (error) throw error;
      
      console.log('Cashbox count saved from report:', total);
      
    } catch (error) {
      console.error('Error saving cashbox count from report:', error);
    }
  }
  
  async function getCashboxReconciliation(currentTotal) {
    try {
      // Get the two most recent cashbox counts for comparison
      const { data, error } = await supabase
        .from('cashbox_counts')
        .select('*')
        .order('date', { ascending: false })
        .limit(2);
      
      if (error) throw error;
      
      if (!data || data.length === 0) {
        return {
          isFirstCount: true,
          currentTotal: currentTotal,
          message: 'First cashbox count recorded - baseline established'
        };
      }
      
      if (data.length === 1) {
        return {
          isFirstCount: true,
          currentTotal: currentTotal,
          previousTotal: null,
          message: 'Second cashbox count - reconciliation will begin next week'
        };
      }
      
      const current = data[0]; // Most recent (just saved)
      const previous = data[1]; // Previous week
      
      // Get date range for daily discrepancies between the two cashbox counts
      const startDate = new Date(previous.date);
      const endDate = new Date(current.date);
      
      // Fetch daily cash count data for the period (need more fields for Excess calculation)
      const { data: discrepancyData, error: discrepancyError } = await supabase
        .from('cash_counts')
        .select('pm_discrepancy, pm_amount_to_keep, am_total, date')
        .gte('date', previous.date)
        .lt('date', current.date) // Use < to exclude current date
        .not('pm_discrepancy', 'is', null)
        .order('date', { ascending: true });

      if (discrepancyError) throw discrepancyError;

      // Calculate total discrepancies for the period
      const totalDiscrepancies = discrepancyData ?
        discrepancyData.reduce((sum, day) => sum + (day.pm_discrepancy || 0), 0) : 0;

      // CRITICAL FIX: Calculate total Excess returned to cashbox
      // Excess = Net change to cashbox each day (what went back in minus what came out)
      // Formula: (pm_amount_to_keep) - (am_total)
      // Positive excess = cash returned to box, Negative excess = cash taken from box
      const totalExcessReturned = discrepancyData ?
        discrepancyData.reduce((sum, day) => {
          const pmKeep = day.pm_amount_to_keep || 0;
          const amTotal = day.am_total || 0;
          const dailyExcess = pmKeep - amTotal;
          return sum + dailyExcess;
        }, 0) : 0;

      console.log(' Cashbox Reconciliation Breakdown:');
      console.log(`   Previous Week Total: $${previous.total.toFixed(2)}`);
      console.log(`   Total Discrepancies: $${totalDiscrepancies.toFixed(2)}`);
      console.log(`   Total Excess Returned: $${totalExcessReturned.toFixed(2)}`);

      // CORRECT RECONCILIATION FORMULA (FIXED):
      // Week_N_Ending_Cashbox = Week_N_Starting_Cashbox + Sum(Daily_Discrepancies) + Sum(Daily_Excess)
      // This accounts for BOTH daily over/under AND actual cash flow in/out of cashbox
      const expectedEnding = previous.total + totalDiscrepancies + totalExcessReturned;
      const actualVariance = currentTotal - expectedEnding;

      console.log(`   Expected Ending: $${expectedEnding.toFixed(2)}`);
      console.log(`   Actual Ending: $${currentTotal.toFixed(2)}`);
      console.log(`   Variance: $${actualVariance.toFixed(2)}`);
      
      return {
        isFirstCount: false,
        currentTotal: currentTotal,
        currentDate: new Date(current.date).toLocaleDateString(),
        previousTotal: previous.total,
        previousDate: new Date(previous.date).toLocaleDateString(),
        totalDiscrepancies: totalDiscrepancies,
        totalExcessReturned: totalExcessReturned, // NEW: Include Excess in return object
        expectedEnding: expectedEnding,
        actualVariance: actualVariance,
        discrepancyDays: discrepancyData ? discrepancyData.length : 0,
        reconciliationStatus: Math.abs(actualVariance) < 0.01 ? 'BALANCED' :
                             actualVariance > 0 ? 'OVERAGE' : 'SHORTAGE',
        message: Math.abs(actualVariance) < 0.01 ?
                'Perfect reconciliation! Cashbox balances correctly.' :
                actualVariance > 0 ?
                `Unexplained overage of $${actualVariance.toFixed(2)}` :
                `Unexplained shortage of $${Math.abs(actualVariance).toFixed(2)}`
      };
      
    } catch (error) {
      console.error('Error getting cashbox reconciliation:', error);
      return null;
    }
  }
  
  function setupDenominations(shift) {
    [1, 2].forEach(drawer => {
      const container = document.getElementById(`${shift}Drawer${drawer}Denoms`);
      container.innerHTML = '';
      
      DENOMINATIONS.forEach((denom, index) => {
        const row = document.createElement('div');
        row.className = 'denom-row';
        row.innerHTML = `
          <div>
            <div class="denom-label">${denom.label}</div>
            <div class="denom-value" id="${shift}D${drawer}V${index}">0  $${denom.value.toFixed(2)} = $0.00</div>
          </div>
          <input type="number" class="qty-input" id="${shift}D${drawer}Q${index}" 
                 min="0" step="1" value="0" 
                 inputmode="numeric" pattern="[0-9]*"
                 oninput="updateCalculations('${shift}', ${drawer})" 
                 onfocus="this.select()">
        `;
        container.appendChild(row);
      });
    });
    
    // Apply disabled state based on current name selection
    toggleDenominationInputs(shift);
  }
  
  function toggleSkip(shift, drawer) {
    const skipBox = document.getElementById(`${shift}Drawer${drawer}Skip`);
    const content = document.getElementById(`${shift}Drawer${drawer}Content`);
    const skipContent = document.getElementById(`${shift}Drawer${drawer}SkipContent`);
    
    if (skipBox.checked) {
      content.classList.add('hidden');
      skipContent.classList.remove('hidden');
    } else {
      content.classList.remove('hidden');
      skipContent.classList.add('hidden');
    }
    updateCalculations(shift, drawer);
  }
  
  function toggleDenominationInputs(shift) {
    const counterSelect = document.getElementById(`${shift}Counter`);
    if (!counterSelect) return; // Safety check
    
    const hasName = counterSelect.value.trim() !== '';
    
    // Toggle denomination inputs for both drawers
    for (let drawer = 1; drawer <= 2; drawer++) {
      DENOMINATIONS.forEach((denom, index) => {
        const qtyInput = document.getElementById(`${shift}D${drawer}Q${index}`);
        if (!qtyInput) return; // Safety check
        
        const denomRow = qtyInput.closest('.denom-row');
        if (!denomRow) return; // Safety check
        
        if (hasName) {
          qtyInput.disabled = false;
          denomRow.classList.remove('disabled');
        } else {
          qtyInput.disabled = true;
          qtyInput.value = ''; // Clear any existing values
          denomRow.classList.add('disabled');
        }
      });
      
      // Update calculations after enabling/disabling
      updateCalculations(shift, drawer);
    }
  }
  
  function updateCalculations(shift, drawer) {
    const skipBox = document.getElementById(`${shift}Drawer${drawer}Skip`);
    let drawerTotal = 0;
    
    if (!skipBox.checked) {
      DENOMINATIONS.forEach((denom, index) => {
        const qtyInput = document.getElementById(`${shift}D${drawer}Q${index}`);
        const qty = parseInt(qtyInput.value) || 0;
        const value = qty * denom.value;
        
        document.getElementById(`${shift}D${drawer}V${index}`).textContent = 
          `${qty}  $${denom.value.toFixed(2)} = $${value.toFixed(2)}`;
        
        drawerTotal += value;
      });
    }
    
    document.getElementById(`${shift}Drawer${drawer}Total`).textContent = `$${drawerTotal.toFixed(2)}`;
    updateGrandTotal(shift);
  }
  
  function updateGrandTotal(shift) {
    const drawer1Skip = document.getElementById(`${shift}Drawer1Skip`).checked;
    const drawer2Skip = document.getElementById(`${shift}Drawer2Skip`).checked;
    
    const drawer1Total = drawer1Skip ? 0 : parseFloat(document.getElementById(`${shift}Drawer1Total`).textContent.replace('$', ''));
    const drawer2Total = drawer2Skip ? 0 : parseFloat(document.getElementById(`${shift}Drawer2Total`).textContent.replace('$', ''));
    
    const grandTotal = drawer1Total + drawer2Total;
    document.getElementById(`${shift}GrandTotal`).textContent = `$${grandTotal.toFixed(2)}`;
    
    // Add discrepancy validation for PM shift only
    if (shift === 'pm') {
      validatePMDiscrepancy(grandTotal);
    }
  }

  function validatePMDiscrepancy(pmTotal) {
    const discrepancySection = document.getElementById('discrepancySection');
    const discrepancyDisplay = document.getElementById('discrepancyDisplay');
    
    // Get AM total and Toast sales
    const amTotalText = document.getElementById('pmAmTotal').textContent;
    const toastSales = autoCalculatedToastAmount || 0;
    
    // Only validate if we have all necessary data
    if (!amTotalText || amTotalText === 'Loading...' || amTotalText === 'Please select a date' || toastSales === 0) {
      discrepancySection.style.display = 'none';
      return;
    }
    
    const amTotal = parseFloat(amTotalText.replace('$', '').replace(',', '')) || 0;
    const netCashChange = pmTotal - amTotal; // This should equal Toast sales
    const discrepancy = netCashChange - toastSales;
    const absDiscrepancy = Math.abs(discrepancy);
    
    // Show the section
    discrepancySection.style.display = 'block';
    
    // Determine warning level and styling
    let borderColor, backgroundColor, textColor, warningLevel, warningMessage, warningIcon;
    
    if (absDiscrepancy <= 3) {
      // Good - within $3
      borderColor = '#28a745';
      backgroundColor = '#d4edda';
      textColor = '#155724';
      warningLevel = 'GOOD';
      warningMessage = 'Cash count matches Toast sales within acceptable range.';
      warningIcon = '';
    } else if (absDiscrepancy <= 10) {
      // Warning - $3-$10
      borderColor = '#ffc107';
      backgroundColor = '#fff3cd';
      textColor = '#856404';
      warningLevel = 'SUGGESTION';
      warningMessage = 'Consider recounting your cash to ensure accuracy, but you may proceed if confident.';
      warningIcon = '';
    } else {
      // Severe - over $10
      borderColor = '#dc3545';
      backgroundColor = '#f8d7da';
      textColor = '#721c24';
      warningLevel = 'IMPORTANT';
      warningMessage = 'Significant discrepancy detected. Please recount everything carefully or confirm you want to proceed.';
      warningIcon = '';
    }
    
    // Add special message for negative discrepancies
    let negativeWarning = '';
    if (discrepancy < 0) {
      negativeWarning = `<div style="background: rgba(220, 53, 69, 0.1); padding: 8px; border-radius: 0; font-size: 13px; margin-top: 10px;">
        <strong>Cash Tips Impact:</strong> This ${Math.abs(discrepancy).toFixed(2)} shortage will be deducted from cash tips. Please verify your count is accurate.
      </div>`;
    }
    
    discrepancyDisplay.style.border = `2px solid ${borderColor}`;
    discrepancyDisplay.style.background = backgroundColor;
    discrepancyDisplay.style.color = textColor;
    
    discrepancyDisplay.innerHTML = `
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <span style="font-weight: 700; font-size: 16px;">${warningIcon} Cash vs Toast Validation</span>
        <span style="background: ${borderColor}; color: white; padding: 6px 12px; border-radius: 0; font-size: 12px; font-weight: 600;">
          ${warningLevel}
        </span>
      </div>
      
      <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin: 15px 0; text-align: center;">
        <div>
          <div style="font-size: 12px; opacity: 0.8;">Net Cash Change</div>
          <div style="font-size: 24px; font-weight: bold;">$${netCashChange.toFixed(2)}</div>
          <div style="font-size: 11px; opacity: 0.7;">PM Total - AM Total</div>
        </div>
        <div>
          <div style="font-size: 12px; opacity: 0.8;">Toast Sales</div>
          <div style="font-size: 24px; font-weight: bold;">$${toastSales.toFixed(2)}</div>
          <div style="font-size: 11px; opacity: 0.7;">Expected Amount</div>
        </div>
        <div>
          <div style="font-size: 12px; opacity: 0.8;">Discrepancy</div>
          <div style="font-size: 24px; font-weight: bold; color: ${discrepancy >= 0 ? borderColor : '#dc3545'};">
            ${discrepancy >= 0 ? '+' : ''}$${discrepancy.toFixed(2)}
          </div>
          <div style="font-size: 11px; opacity: 0.7;">${discrepancy >= 0 ? 'Overage' : 'Shortage'}</div>
        </div>
      </div>
      
      <div style="background: rgba(${borderColor === '#28a745' ? '40, 167, 69' : borderColor === '#ffc107' ? '255, 193, 7' : '220, 53, 69'}, 0.1); padding: 10px; border-radius: 0; font-size: 13px; text-align: center;">
        <strong>${warningMessage}</strong>
      </div>
      
      ${negativeWarning}
    `;
  }
  
  async function loadAMData() {
    const date = document.getElementById('pmDate').value;
    console.log('Loading AM data for date:', date);
    
    if (!date) {
      document.getElementById('pmAmTotal').textContent = 'Please select a date';
      document.getElementById('amCounterName').textContent = 'Please select a date';
      document.getElementById('amCountTime').textContent = 'Please select a date';
      return;
    }
    
    // Show loading state
    document.getElementById('pmAmTotal').textContent = 'Loading...';
    document.getElementById('amCounterName').textContent = 'Loading...';
    document.getElementById('amCountTime').textContent = 'Loading...';
    
    try {
      if (!supabase) {
        throw new Error('Database not connected');
      }
      
      console.log('Querying Supabase for AM data...');
      const amData = await getAMData(date);
      console.log('AM data result:', amData);
      
      if (amData && amData.total > 0) {
        currentAMData = amData;
        document.getElementById('pmAmTotal').textContent = `$${amData.total.toFixed(2)}`;
        
        // FIX: Set AM counter name and timestamp
        document.getElementById('amCounterName').textContent = amData.counter || 'N/A';
        document.getElementById('amCountTime').textContent = amData.timestamp ? new Date(amData.timestamp).toLocaleString() : 'N/A';
        
        // Handle AM notes display
        const amNotesDisplay = document.getElementById('amNotesDisplay');
        const amNotesEl = document.getElementById('amNotes');
        if (amData.notes && amData.notes.trim()) {
          amNotesEl.textContent = amData.notes;
          amNotesDisplay.style.display = 'block';
        } else {
          amNotesDisplay.style.display = 'none';
        }
        
        // Removed "AM data loaded successfully" message to prevent bouncing
      } else {
        currentAMData = null;
        document.getElementById('pmAmTotal').textContent = 'No AM data found';
        document.getElementById('amCounterName').textContent = 'No AM data found';
        document.getElementById('amCountTime').textContent = 'No AM data found';
        const amNotesDisplay = document.getElementById('amNotesDisplay');
        if (amNotesDisplay) amNotesDisplay.style.display = 'none';
        showMessage(`No AM count found for ${date}`, 'error');
      }
    } catch (error) {
      console.error('Error loading AM data:', error);
      document.getElementById('pmAmTotal').textContent = 'Error loading AM data';
      document.getElementById('amCounterName').textContent = 'Error loading AM data';
      document.getElementById('amCountTime').textContent = 'Error loading AM data';
      showMessage(`Error: ${error.message}`, 'error');
    }
  }
  
  function collectFormData(shift) {
    const counter = document.getElementById(`${shift}Counter`).value;
    const date = document.getElementById(`${shift}Date`).value;
    const notes = document.getElementById(`${shift}Notes`).value.trim();
    
    if (!counter) throw new Error('Please select a name');
    if (!date) throw new Error('Please select a date');
    
    const drawer1Skip = document.getElementById(`${shift}Drawer1Skip`).checked;
    const drawer2Skip = document.getElementById(`${shift}Drawer2Skip`).checked;
    
    const drawer1Data = collectDrawerData(shift, 1, drawer1Skip);
    const drawer2Data = collectDrawerData(shift, 2, drawer2Skip);
    
    const data = {
      shift: shift,
      counter: counter,
      date: date,
      timestamp: new Date().toISOString(),
      drawer1: drawer1Data,
      drawer2: drawer2Data,
      drawer1Total: drawer1Data.total, // Add individual drawer totals for email template
      drawer2Total: drawer2Data.total,
      notes: notes || null,
      total: drawer1Data.total + drawer2Data.total
    };
    
    if (shift === 'pm') {
      // Use auto-calculated Toast amount (no manual override)
      const toastSales = autoCalculatedToastAmount || 0;
      const cashTips = parseInt(document.getElementById('cashTips').value) || 0;
      
      data.toastSales = toastSales;
      data.cashTips = cashTips;
      data.amTotal = currentAMData ? currentAMData.total : 0;
      
      // Always indicate auto-calculated method
      data.toastSalesMethod = 'auto_calculated';
    }
    
    return data;
  }
  
  function collectDrawerData(shift, drawer, skipped) {
    if (skipped) {
      const reason = document.getElementById(`${shift}Drawer${drawer}Reason`).value.trim();
      return {
        skipped: true,
        skipReason: reason || 'No reason provided',
        counts: {},
        total: 0
      };
    }
    
    const counts = {};
    let total = 0;
    
    // Map denomination labels to email template keys
    const denominationKeys = [
      'hundreds',    // $100
      'fifties',     // $50
      'twenties',    // $20
      'tens',        // $10
      'fives',       // $5
      'ones',        // $1
      'quarters',    // $0.25
      'dimes',       // $0.10
      'nickels',     // $0.05
      'pennies'      // $0.01
    ];
    
    DENOMINATIONS.forEach((denom, index) => {
      const qty = parseInt(document.getElementById(`${shift}D${drawer}Q${index}`).value) || 0;
      // Store with both the original label and the email template key
      counts[denom.label] = qty;
      counts[denominationKeys[index]] = qty;
      total += qty * denom.value;
    });
    
    return {
      skipped: false,
      skipReason: null,
      counts: counts,
      total: Math.round(total * 100) / 100
    };
  }
  
  async function submitAM() {
    try {
      showLoading('Submitting AM Count', 'Recording your morning cash count...');
      
      const data = collectFormData('am');
      await storeAMData(data);
      
      // Show elegant success screen
      showAMSuccess(data.total);
      resetForm('am');
      
    } catch (error) {
      hideLoading();
      console.error('AM submission error:', error);
      showMessage(`Error: ${error.message}`, 'error');
    }
  }
  
  async function submitPM() {
    try {
      showLoading('Processing PM Close', 'Calculating totals and sending report to management...');
      
      const data = collectFormData('pm');
      const calculations = calculatePMAmounts(data);
      
      await storePMData(data, calculations);
      await sendEmailReport(data, calculations);
      
      // Show elegant success screen with deposit/return instructions
      showPMSuccess(calculations.depositAmount, calculations.returnAmount, calculations.discrepancy);
      
    } catch (error) {
      hideLoading();
      console.error('PM submission error:', error);
      
      // Check if it's a validation error (these shouldn't reset the form)
      const isValidationError = error.message.includes('Please select') || 
                               error.message.includes('required') ||
                               error.message.includes('name') ||
                               error.message.includes('date');
      
      showMessage(`Error: ${error.message}`, 'error');
      
      // Only redirect home for non-validation errors (like network issues)
      if (!isValidationError) {
        goHome();
      }
    }
  }
  
  function calculatePMAmounts(data) {
    const amTotal = data.amTotal;
    const pmTotal = data.total;
    const toastSales = data.toastSales;
    const cashTips = data.cashTips;
    
    // Drawer change = PM - AM
    const drawerChange = pmTotal - amTotal;
    
    // Actual cash in
    const actualCashIn = drawerChange;
    
    // Expected vs actual (Toast sales vs actual cash in)
    const discrepancy = actualCashIn - toastSales;
    
    // Step 1: Calculate raw deposit amount
    const rawDepositAmount = toastSales + cashTips;
    
    // Step 2: Round deposit to whole dollars (what staff actually deposits)
    const depositAmount = Math.round(rawDepositAmount);
    
    // Step 3: Calculate deposit rounding adjustment needed
    const depositRoundingAdjustment = depositAmount - rawDepositAmount;
    
    // Step 4: Handle deposit rounding with whole dollar tip adjustments
    let depositTipAdjustment = 0;
    let depositExcessToCashbox = 0;
    
    if (depositRoundingAdjustment > 0) {
      // Need extra money for rounding - take whole dollars from tips
      depositTipAdjustment = Math.ceil(depositRoundingAdjustment);
      depositExcessToCashbox = depositTipAdjustment - depositRoundingAdjustment;
    } else if (depositRoundingAdjustment < 0) {
      // Deposit rounded down - staff keeps the rounding benefit
      depositExcessToCashbox = Math.abs(depositRoundingAdjustment);
    }
    
    // Step 5: Handle shortage/overage adjustments with whole dollars
    let shortageTipAdjustment = 0;
    let shortageExcessToCashbox = 0;
    
    if (discrepancy < 0) {
      // SHORTAGE: Take whole dollars from tips to cover shortage
      const shortageAmount = Math.abs(discrepancy);
      shortageTipAdjustment = Math.ceil(shortageAmount);
      shortageExcessToCashbox = shortageTipAdjustment - shortageAmount;
    }
    
    // Step 6: Calculate final tip amounts
    const totalTipAdjustment = depositTipAdjustment + shortageTipAdjustment;

// Initialize
document.addEventListener('DOMContentLoaded', function() {
  renderAppHeader({ currentPage: 'cash', showLiveStats: true });
  startSmartCashFlow();
});
</script>
</body>
</html>
