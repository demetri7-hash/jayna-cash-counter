<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EZCater Setup - Jayna Restaurant</title>
  <style>
    :root {
      --white: #ffffff;
      --gray-900: #1a1a1a;
      --gray-700: #4a4a4a;
      --gray-600: #6b6b6b;
      --gray-500: #9ca3af;
      --gray-400: #d1d5db;
      --gray-300: #e5e7eb;
      --gray-200: #f3f4f6;
      --gray-100: #f9fafb;
      --success-bg: #d1fae5;
      --success-text: #065f46;
      --success-border: #059669;
      --warning-bg: #fef3c7;
      --warning-text: #92400e;
      --warning-border: #f59e0b;
      --error-bg: #fee2e2;
      --error-text: #991b1b;
      --error-border: #dc2626;
      --blue-bg: #dbeafe;
      --blue-text: #1e40af;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: var(--gray-100);
      color: var(--gray-700);
      font-size: 13px;
      line-height: 1.6;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    .header {
      background: var(--white);
      border: 2px solid var(--gray-300);
      padding: 20px;
      margin-bottom: 20px;
      text-align: center;
    }

    .header h1 {
      font-size: 20px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--gray-900);
      margin-bottom: 8px;
    }

    .header p {
      font-size: 13px;
      color: var(--gray-600);
    }

    .nav-links {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin-top: 16px;
    }

    .nav-btn {
      padding: 12px 24px;
      background: var(--gray-100);
      border: 2px solid var(--gray-300);
      color: var(--gray-900);
      font-size: 13px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
      transition: all 0.15s ease;
    }

    .nav-btn:hover {
      border-color: var(--gray-700);
      background: var(--gray-200);
    }

    .section {
      background: var(--white);
      border: 2px solid var(--gray-300);
      padding: 20px;
      margin-bottom: 20px;
    }

    .section h2 {
      font-size: 18px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--gray-900);
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 2px solid var(--gray-300);
    }

    .info-box {
      background: var(--blue-bg);
      border: 2px solid var(--blue-text);
      padding: 16px;
      margin-bottom: 20px;
    }

    .info-box h3 {
      font-size: 14px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--blue-text);
      margin-bottom: 12px;
    }

    .info-box p,
    .info-box li {
      font-size: 13px;
      color: var(--gray-700);
      margin-bottom: 8px;
    }

    .info-box ul {
      margin-left: 20px;
      margin-top: 8px;
    }

    .warning-box {
      background: var(--warning-bg);
      border: 2px solid var(--warning-border);
      padding: 16px;
      margin-bottom: 20px;
    }

    .warning-box h3 {
      font-size: 14px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--warning-text);
      margin-bottom: 12px;
    }

    .warning-box p {
      font-size: 13px;
      color: var(--gray-700);
      margin-bottom: 8px;
    }

    .success-box {
      background: var(--success-bg);
      border: 2px solid var(--success-border);
      padding: 16px;
      margin-bottom: 20px;
      display: none;
    }

    .success-box h3 {
      font-size: 14px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--success-text);
      margin-bottom: 12px;
    }

    .error-box {
      background: var(--error-bg);
      border: 2px solid var(--error-border);
      padding: 16px;
      margin-bottom: 20px;
      display: none;
    }

    .error-box h3 {
      font-size: 14px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--error-text);
      margin-bottom: 12px;
    }

    .setup-btn {
      padding: 16px 32px;
      background: var(--gray-900);
      border: 2px solid var(--gray-900);
      color: white;
      font-size: 14px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      cursor: pointer;
      transition: all 0.15s ease;
      width: 100%;
      max-width: 400px;
      display: block;
      margin: 20px auto;
    }

    .setup-btn:hover {
      background: var(--gray-700);
      border-color: var(--gray-700);
    }

    .setup-btn:disabled {
      background: var(--gray-300);
      border-color: var(--gray-300);
      color: var(--gray-500);
      cursor: not-allowed;
    }

    .code-block {
      background: var(--gray-100);
      border: 2px solid var(--gray-300);
      padding: 12px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      overflow-x: auto;
      margin: 12px 0;
    }

    .step {
      margin-bottom: 24px;
      padding-left: 32px;
      position: relative;
    }

    .step-number {
      position: absolute;
      left: 0;
      top: 0;
      width: 24px;
      height: 24px;
      background: var(--gray-900);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 12px;
    }

    .step h4 {
      font-size: 14px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--gray-900);
      margin-bottom: 8px;
    }

    .subscription-list {
      background: var(--gray-100);
      border: 2px solid var(--gray-300);
      padding: 16px;
      margin-top: 12px;
    }

    .subscription-item {
      padding: 12px;
      background: var(--white);
      border: 2px solid var(--gray-300);
      margin-bottom: 12px;
    }

    .subscription-item:last-child {
      margin-bottom: 0;
    }

    .subscription-item strong {
      color: var(--gray-900);
      font-weight: 700;
    }

    .loading {
      text-align: center;
      padding: 20px;
      font-weight: 700;
      color: var(--gray-600);
    }

    .spinner {
      border: 3px solid var(--gray-300);
      border-top: 3px solid var(--gray-500);
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
      margin: 0 auto 12px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @media (max-width: 600px) {
      .nav-links {
        flex-direction: column;
      }

      .nav-btn {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üîß EZCATER SUBSCRIPTION SETUP</h1>
      <p>One-time configuration to receive order notifications</p>
      <div class="nav-links">
        <a href="index.html" class="nav-btn">‚Üê CASH COUNTER</a>
        <a href="catering.html" class="nav-btn">üìã CATERING</a>
        <a href="foh-checklists.html" class="nav-btn">‚úì CHECKLISTS</a>
      </div>
    </div>

    <div class="section">
      <h2>üìã SETUP INSTRUCTIONS</h2>

      <div class="warning-box">
        <h3>‚ö†Ô∏è ONE-TIME SETUP REQUIRED</h3>
        <p>This setup only needs to be run ONCE to activate EZCater order notifications. After setup, orders will automatically sync to your catering page.</p>
      </div>

      <div class="info-box">
        <h3>‚ÑπÔ∏è WHAT THIS DOES</h3>
        <p>This setup will create event subscriptions in EZCater's system so that your catering page receives notifications when:</p>
        <ul>
          <li><strong>submitted</strong> - New orders are placed</li>
          <li><strong>accepted</strong> - You accept an order</li>
          <li><strong>rejected</strong> - You reject an order</li>
          <li><strong>cancelled</strong> - An order is cancelled</li>
        </ul>
      </div>

      <div class="step">
        <div class="step-number">1</div>
        <h4>VERIFY ENVIRONMENT VARIABLES</h4>
        <p>Make sure these are configured in your Vercel Dashboard:</p>
        <div class="code-block">
EZCATER_API_TOKEN=your_token_here
EZCATER_CATERER_ID=your_caterer_id_here
EZCATER_API_URL=https://api.ezcater.com/graphql
        </div>
        <p><strong>Finding your Caterer ID:</strong></p>
        <ul style="margin-left: 20px; margin-top: 8px;">
          <li>Login to <a href="https://manage.ezcater.com/" target="_blank">ezManage</a></li>
          <li>Navigate to Settings ‚Üí API or Integrations</li>
          <li>Look for "Caterer ID" or "Restaurant ID"</li>
          <li>OR contact: <a href="mailto:api_support@ezcater.com">api_support@ezcater.com</a></li>
        </ul>
      </div>

      <div class="step">
        <div class="step-number">2</div>
        <h4>RUN SETUP</h4>
        <p>Click the button below to create the event subscriptions. This will connect EZCater to your webhook endpoint:</p>
        <div class="code-block">
Webhook URL: https://jayna-cash-counter.vercel.app/api/ezcater-webhook
        </div>
        <button id="setupBtn" class="setup-btn" onclick="runSetup()">
          üöÄ CREATE EZCATER SUBSCRIPTIONS
        </button>
      </div>

      <div id="loadingBox" class="loading" style="display: none;">
        <div class="spinner"></div>
        <p>Creating subscriptions...</p>
      </div>

      <div id="successBox" class="success-box">
        <h3>‚úÖ SETUP COMPLETE!</h3>
        <p id="successMessage"></p>
        <div id="subscriptionsList" class="subscription-list"></div>
      </div>

      <div id="errorBox" class="error-box">
        <h3>‚ùå SETUP FAILED</h3>
        <p id="errorMessage"></p>
      </div>
    </div>

    <div class="section">
      <h2>üß™ TESTING</h2>

      <div class="info-box">
        <h3>HOW TO VERIFY IT WORKS</h3>
        <p><strong>After setup completion:</strong></p>
        <ul>
          <li>Create a test order in ezManage (or wait for a real order)</li>
          <li>Check Vercel Function Logs for: <code>üì¶ EZCater Webhook: Event received</code></li>
          <li>Visit <a href="catering.html">catering.html</a> and click "üîÑ REFRESH ORDERS"</li>
          <li>You should see the order appear in the UPCOMING section</li>
        </ul>
      </div>

      <div class="step">
        <div class="step-number">3</div>
        <h4>VERIFY DATABASE</h4>
        <p>Check that orders are being saved to Supabase:</p>
        <div class="code-block">
SELECT * FROM ezcater_orders ORDER BY created_at DESC LIMIT 5;
        </div>
      </div>

      <div class="step">
        <div class="step-number">4</div>
        <h4>MONITOR LOGS</h4>
        <p>Watch for webhook events in Vercel:</p>
        <ul style="margin-left: 20px; margin-top: 8px;">
          <li>Go to Vercel Dashboard ‚Üí Deployments ‚Üí Functions</li>
          <li>Click <code>/api/ezcater-webhook</code></li>
          <li>Look for successful order saves</li>
        </ul>
      </div>
    </div>

    <div class="section">
      <h2>üö® TROUBLESHOOTING</h2>

      <div class="warning-box">
        <h3>COMMON ERRORS</h3>
        <p><strong>"EZCATER_API_TOKEN not configured"</strong></p>
        <p>‚Üí Add environment variables in Vercel Dashboard ‚Üí Settings ‚Üí Environment Variables</p>
        <br>
        <p><strong>"EZCATER_CATERER_ID not configured"</strong></p>
        <p>‚Üí Find your caterer ID in ezManage or contact api_support@ezcater.com</p>
        <br>
        <p><strong>"GraphQL errors" or "Subscription creation failed"</strong></p>
        <p>‚Üí Check that your API token has correct permissions</p>
        <p>‚Üí Verify your caterer ID is correct</p>
        <br>
        <p><strong>Setup succeeds but no orders appearing</strong></p>
        <p>‚Üí Make sure you've run the SQL migration to create ezcater_orders table</p>
        <p>‚Üí Check webhook endpoint is deployed and accessible</p>
      </div>
    </div>
  </div>

  <script>
    async function runSetup() {
      const setupBtn = document.getElementById('setupBtn');
      const loadingBox = document.getElementById('loadingBox');
      const successBox = document.getElementById('successBox');
      const errorBox = document.getElementById('errorBox');
      const successMessage = document.getElementById('successMessage');
      const errorMessage = document.getElementById('errorMessage');
      const subscriptionsList = document.getElementById('subscriptionsList');

      // Reset UI
      setupBtn.disabled = true;
      loadingBox.style.display = 'block';
      successBox.style.display = 'none';
      errorBox.style.display = 'none';

      try {
        console.log('üöÄ Starting EZCater subscription setup...');

        const response = await fetch('/api/setup-ezcater-subscription', {
          method: 'GET'
        });

        const data = await response.json();

        if (!response.ok || data.error) {
          throw new Error(data.error || data.details || 'Setup failed');
        }

        console.log('‚úÖ Setup successful:', data);

        // Show success
        loadingBox.style.display = 'none';
        successBox.style.display = 'block';
        successMessage.textContent = data.message || 'Event subscriptions created successfully!';

        // Display subscriptions
        if (data.subscriptions && data.subscriptions.length > 0) {
          subscriptionsList.innerHTML = '<h4 style="font-size: 13px; font-weight: 700; text-transform: uppercase; margin-bottom: 12px;">Created Subscriptions:</h4>';

          data.subscriptions.forEach(sub => {
            const item = document.createElement('div');
            item.className = 'subscription-item';
            item.innerHTML = `
              <div><strong>Event:</strong> ${sub.eventKey || 'N/A'}</div>
              <div><strong>Subscription ID:</strong> ${sub.id || 'N/A'}</div>
              ${sub.url ? `<div><strong>Webhook URL:</strong> ${sub.url}</div>` : ''}
            `;
            subscriptionsList.appendChild(item);
          });
        }

        // Show note
        const noteDiv = document.createElement('div');
        noteDiv.style.cssText = 'margin-top: 16px; padding: 12px; background: var(--white); border: 2px solid var(--success-border);';
        noteDiv.innerHTML = '<strong>Next Steps:</strong><br>1. Visit <a href="catering.html">catering.html</a><br>2. Click "üîÑ REFRESH ORDERS"<br>3. Create a test order in ezManage to verify the webhook is working';
        successBox.appendChild(noteDiv);

      } catch (error) {
        console.error('‚ùå Setup error:', error);

        loadingBox.style.display = 'none';
        errorBox.style.display = 'block';
        errorMessage.textContent = error.message;

        // Add detailed error info
        const detailsDiv = document.createElement('div');
        detailsDiv.style.cssText = 'margin-top: 12px; font-size: 12px; font-family: monospace; background: var(--gray-100); padding: 12px; border: 1px solid var(--gray-300);';
        detailsDiv.textContent = JSON.stringify(error, null, 2);
        errorBox.appendChild(detailsDiv);

        setupBtn.disabled = false;
      }
    }

    // Show status on page load
    window.addEventListener('DOMContentLoaded', () => {
      console.log('üîß EZCater Setup Page Loaded');
      console.log('Ready to create event subscriptions');
    });
  </script>
</body>
</html>
