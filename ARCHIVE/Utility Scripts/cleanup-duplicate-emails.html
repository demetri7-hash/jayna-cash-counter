<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cleanup Duplicate Emails - Teacher's Feast Contest</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #46B0E4 0%, #176F9A 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            text-align: center;
        }

        h1 {
            font-size: 28px;
            color: #176F9A;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-bottom: 10px;
        }

        .warning {
            background: #fef3c7;
            border: 3px solid #f59e0b;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .warning h2 {
            color: #92400e;
            font-size: 20px;
            margin-bottom: 15px;
        }

        .warning p {
            color: #92400e;
            font-size: 14px;
            line-height: 1.6;
            margin-bottom: 10px;
        }

        .section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
        }

        .btn {
            background: linear-gradient(135deg, #46B0E4 0%, #176F9A 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(70, 176, 228, 0.4);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn-danger {
            background: #dc2626;
        }

        .btn-danger:hover {
            background: #991b1b;
            box-shadow: 0 4px 15px rgba(220, 38, 38, 0.4);
        }

        .results {
            background: #f0f9ff;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            font-size: 14px;
            line-height: 1.8;
            max-height: 500px;
            overflow-y: auto;
        }

        .duplicate-group {
            background: white;
            border: 2px solid #f59e0b;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .duplicate-group h3 {
            color: #92400e;
            font-size: 16px;
            margin-bottom: 10px;
        }

        .vote-item {
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            font-size: 13px;
        }

        .vote-item.keep {
            background: #d1fae5;
            border: 2px solid #059669;
            color: #065f46;
        }

        .vote-item.archive {
            background: #fee2e2;
            border: 2px solid #dc2626;
            color: #991b1b;
        }

        .success {
            background: #d1fae5;
            border: 2px solid #059669;
            color: #065f46;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            font-weight: 600;
        }

        .error {
            background: #fee2e2;
            border: 2px solid #dc2626;
            color: #991b1b;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            font-weight: 600;
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid #e0f2fe;
            border-top: 4px solid #46B0E4;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üßπ Cleanup Duplicate Emails</h1>
            <p style="color: #666; margin-top: 10px;">One-time script to remove duplicate email addresses from contest votes</p>
        </div>

        <div class="warning">
            <h2>‚ö†Ô∏è IMPORTANT - READ BEFORE RUNNING</h2>
            <p><strong>What this script does:</strong></p>
            <ul style="margin-left: 20px; margin-top: 10px; margin-bottom: 15px;">
                <li>Scans all form votes for duplicate email addresses</li>
                <li><strong>KEEPS</strong> the earliest vote for each email (by timestamp)</li>
                <li><strong>ARCHIVES</strong> all subsequent votes from the same email</li>
                <li>Adjusts school points by subtracting archived vote points</li>
                <li>Shows preview before making changes</li>
            </ul>
            <p><strong>Note:</strong> The form already rejects duplicate emails going forward. This script only cleans up existing duplicates.</p>
        </div>

        <div class="section">
            <h2 style="color: #176F9A; margin-bottom: 20px;">Step 1: Scan for Duplicates</h2>
            <p style="margin-bottom: 20px; color: #666;">Click the button below to scan the database for duplicate email addresses.</p>
            <button class="btn" onclick="scanDuplicates()" id="scanBtn">üîç Scan for Duplicate Emails</button>
            <div id="scanResults"></div>
        </div>

        <div class="section" id="cleanupSection" style="display: none;">
            <h2 style="color: #176F9A; margin-bottom: 20px;">Step 2: Clean Up Duplicates</h2>
            <p style="margin-bottom: 20px; color: #666;">Review the duplicates above, then click to archive all duplicates (keeping only the earliest vote per email).</p>
            <button class="btn btn-danger" onclick="cleanupDuplicates()" id="cleanupBtn">üóëÔ∏è Archive All Duplicates</button>
            <div id="cleanupResults"></div>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

        const supabase = createClient(
            'https://gaawtbqpnnbbnsyswqwv.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdhYXd0YnFwbm5iYm5zeXN3cXd2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1MDE1NTAsImV4cCI6MjA3MjA3NzU1MH0.F-y7AIQTWaUe7DRT4OnIZVn94mhXxfhpBbng2aJ8nXg'
        );

        let duplicateGroups = [];

        // Scan for duplicate emails
        window.scanDuplicates = async function() {
            const scanBtn = document.getElementById('scanBtn');
            const scanResults = document.getElementById('scanResults');

            scanBtn.disabled = true;
            scanBtn.textContent = 'üîç Scanning...';

            scanResults.innerHTML = '<div class="loading"><div class="spinner"></div><p>Scanning database for duplicate emails...</p></div>';

            try {
                // Get all form votes with emails
                const { data: votes, error } = await supabase
                    .from('teacher_feast_votes')
                    .select('*')
                    .eq('vote_type', 'form')
                    .not('email', 'is', null)
                    .order('voted_at', { ascending: true }); // Earliest first

                if (error) throw error;

                // Group by email (case-insensitive)
                const emailGroups = {};
                votes.forEach(vote => {
                    const emailKey = vote.email.toLowerCase().trim();
                    if (!emailGroups[emailKey]) {
                        emailGroups[emailKey] = [];
                    }
                    emailGroups[emailKey].push(vote);
                });

                // Find duplicates (more than 1 vote per email)
                duplicateGroups = [];
                for (const [email, group] of Object.entries(emailGroups)) {
                    if (group.length > 1) {
                        duplicateGroups.push({
                            email,
                            votes: group
                        });
                    }
                }

                // Display results
                if (duplicateGroups.length === 0) {
                    scanResults.innerHTML = '<div class="success">‚úÖ No duplicate emails found! Database is clean.</div>';
                    scanBtn.textContent = '‚úÖ Scan Complete - No Duplicates';
                    return;
                }

                // Show duplicates
                let html = `<div class="results">`;
                html += `<h3 style="color: #176F9A; margin-bottom: 15px;">Found ${duplicateGroups.length} Duplicate Email(s)</h3>`;
                html += `<p style="margin-bottom: 20px; color: #666;">Total duplicate votes to archive: <strong>${duplicateGroups.reduce((sum, g) => sum + g.votes.length - 1, 0)}</strong></p>`;

                duplicateGroups.forEach((group, index) => {
                    const totalPoints = group.votes.reduce((sum, v) => sum + v.points, 0);
                    const pointsToArchive = group.votes.slice(1).reduce((sum, v) => sum + v.points, 0);

                    html += `<div class="duplicate-group">`;
                    html += `<h3>Duplicate #${index + 1}: ${group.email} (${group.votes.length} votes, ${totalPoints} points total)</h3>`;

                    group.votes.forEach((vote, voteIndex) => {
                        const votedDate = new Date(vote.voted_at).toLocaleString('en-US');
                        const isKeep = voteIndex === 0;
                        const className = isKeep ? 'keep' : 'archive';
                        const label = isKeep ? '‚úÖ KEEP (earliest)' : 'üóëÔ∏è ARCHIVE';

                        html += `<div class="vote-item ${className}">`;
                        html += `${label} - ${vote.school_name} | ${vote.full_name} | ${vote.phone || 'no phone'} | ${votedDate} | ${vote.points} pts`;
                        html += `</div>`;
                    });

                    html += `<p style="margin-top: 10px; color: #92400e; font-weight: 600;">Action: Keep 1st vote (${group.votes[0].points} pts), archive ${group.votes.length - 1} vote(s) (${pointsToArchive} pts)</p>`;
                    html += `</div>`;
                });

                html += `</div>`;
                scanResults.innerHTML = html;

                // Show cleanup section
                document.getElementById('cleanupSection').style.display = 'block';
                scanBtn.textContent = `‚úÖ Scan Complete - Found ${duplicateGroups.length} Duplicate(s)`;

            } catch (error) {
                console.error('Scan error:', error);
                scanResults.innerHTML = `<div class="error">‚ùå Error scanning database: ${error.message}</div>`;
                scanBtn.disabled = false;
                scanBtn.textContent = 'üîç Scan for Duplicate Emails';
            }
        };

        // Clean up duplicates
        window.cleanupDuplicates = async function() {
            if (duplicateGroups.length === 0) {
                alert('No duplicates to clean up. Please scan first.');
                return;
            }

            const totalToArchive = duplicateGroups.reduce((sum, g) => sum + g.votes.length - 1, 0);

            if (!confirm(`‚ö†Ô∏è FINAL CONFIRMATION\n\nThis will ARCHIVE ${totalToArchive} duplicate vote(s) and adjust school points accordingly.\n\nFor each email, the EARLIEST vote will be kept and all others archived.\n\nThis action cannot be undone automatically (but archived votes can be manually unarchived if needed).\n\nProceed?`)) {
                return;
            }

            const cleanupBtn = document.getElementById('cleanupBtn');
            const cleanupResults = document.getElementById('cleanupResults');

            cleanupBtn.disabled = true;
            cleanupBtn.textContent = 'üóëÔ∏è Archiving...';

            cleanupResults.innerHTML = '<div class="loading"><div class="spinner"></div><p>Archiving duplicate votes and adjusting points...</p></div>';

            try {
                let archivedCount = 0;
                const schoolAdjustments = {};

                // Process each duplicate group
                for (const group of duplicateGroups) {
                    // Skip first vote (keep it), archive the rest
                    for (let i = 1; i < group.votes.length; i++) {
                        const vote = group.votes[i];

                        // Skip if already archived
                        if (vote.is_archived) continue;

                        // Archive vote
                        const { error: archiveError } = await supabase
                            .from('teacher_feast_votes')
                            .update({ is_archived: true })
                            .eq('id', vote.id);

                        if (archiveError) throw archiveError;

                        // Track school point adjustments
                        if (!schoolAdjustments[vote.school_name]) {
                            schoolAdjustments[vote.school_name] = 0;
                        }
                        schoolAdjustments[vote.school_name] += vote.points;

                        archivedCount++;
                    }
                }

                // Decrement school points
                for (const [school, totalPoints] of Object.entries(schoolAdjustments)) {
                    const { error: decrementError } = await supabase.rpc('increment_school_votes', {
                        school_name_param: school,
                        points_param: -totalPoints
                    });

                    if (decrementError) {
                        console.error(`Error decrementing points for ${school}:`, decrementError);
                    }
                }

                // Show success
                let html = `<div class="success">`;
                html += `‚úÖ <strong>Cleanup Complete!</strong><br><br>`;
                html += `‚Ä¢ Archived <strong>${archivedCount}</strong> duplicate vote(s)<br>`;
                html += `‚Ä¢ Kept <strong>${duplicateGroups.length}</strong> unique email(s)<br>`;
                html += `‚Ä¢ Adjusted points for <strong>${Object.keys(schoolAdjustments).length}</strong> school(s)<br><br>`;
                html += `<strong>School Point Adjustments:</strong><br>`;
                for (const [school, points] of Object.entries(schoolAdjustments)) {
                    html += `‚Ä¢ ${school}: -${points} points<br>`;
                }
                html += `</div>`;

                cleanupResults.innerHTML = html;
                cleanupBtn.textContent = '‚úÖ Cleanup Complete';

                // Clear duplicate groups
                duplicateGroups = [];

                // Offer to rescan
                setTimeout(() => {
                    if (confirm('Cleanup complete! Would you like to scan again to verify?')) {
                        window.scanDuplicates();
                    }
                }, 2000);

            } catch (error) {
                console.error('Cleanup error:', error);
                cleanupResults.innerHTML = `<div class="error">‚ùå Error during cleanup: ${error.message}</div>`;
                cleanupBtn.disabled = false;
                cleanupBtn.textContent = 'üóëÔ∏è Archive All Duplicates';
            }
        };
    </script>
</body>
</html>
