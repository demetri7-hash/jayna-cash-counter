<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, viewport-fit=cover">
  <title>Jayna Gyro Cash Counter</title>
  
  <link rel="apple-touch-icon" href="https://static.spotapps.co/website_images/ab_websites/229800_website_v1/logo.png">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#00A8E1">
  
  <style>
    /* Jayna Brand Design - Sky Blue & Grayscale */
    :root {
      --primary-blue: #00A8E1;
      --secondary-blue: #0094D6;
      --light-blue: #E3F4FC;
      --accent-blue: #0081C6;
      --gray-900: #212121;
      --gray-700: #424242;
      --gray-500: #757575;
      --gray-400: #BDBDBD;
      --gray-300: #E0E0E0;
      --gray-100: #F5F5F5;
      --success: #00C853;
      --warning: #FFB300;
      --error: #D32F2F;
      --white: #FFFFFF;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body {
      font-family: 'Aptos', 'Segoe UI Variable', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      background: var(--gray-100);
      min-height: 100vh;
      padding: 0;
      overflow-x: hidden;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
      background: var(--white);
      border-radius: 0;
      overflow: visible;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      min-height: auto;
      max-height: none;
    }
    .header {
      background: var(--white);
      color: var(--gray-900);
      text-align: center;
      padding: 12px;
      border-radius: 0;
      border-bottom: 1px solid var(--gray-300);
    }
    .header h1 { font-size: 18px; font-weight: 700; margin-bottom: 2px; letter-spacing: 1.5px; text-transform: uppercase; }
    .header p { opacity: 0.7; font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }
    /* Mobile-First Responsive Design */
    .content {
      padding: 12px;
      /* Google Sites full page embed optimization */
      max-height: none;
      overflow: visible;
    }
    .main-menu { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 16px; }
    .menu-btn {
      padding: 16px 12px;
      border: 2px solid var(--gray-300);
      border-radius: 0;
      background: var(--gray-100);
      font-size: 11px;
      font-weight: 700;
      color: var(--gray-900);
      cursor: pointer;
      transition: all 0.15s ease;
      text-align: center;
      min-height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      text-transform: uppercase;
      letter-spacing: 1.2px;
    }
    .menu-btn:hover {
      background: var(--gray-300);
      color: var(--gray-900);
      border-color: var(--gray-400);
      transform: translateY(-1px);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
    }
    .menu-btn.active {
      border-color: var(--gray-400);
      background: var(--gray-300);
      color: var(--gray-900);
      transform: translateY(-1px);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
    }
    .menu-btn.primary {
      background: var(--white);
      color: var(--gray-700);
      border-color: var(--gray-300);
    }
    .menu-btn.primary:hover {
      background: var(--gray-100);
      border-color: var(--gray-400);
    }
    .form-section { 
      display: none; 
      /* Ensure sections don't get cut off */
      min-height: auto;
      overflow: visible;
    }
    .form-section.active {
      display: block;
      /* Force visibility in Google Sites */
      position: relative;
      z-index: 1;
    }
    .form-group { margin-bottom: 12px; }
    .form-group label {
      display: block;
      margin-bottom: 4px;
      font-weight: 700;
      font-size: 10px;
      color: var(--gray-700);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    /* Enhanced Mobile-Friendly Inputs */
    .form-input, .form-select {
      width: 100%;
      padding: 12px 14px;
      border: 1px solid var(--gray-300);
      border-radius: 0;
      font-size: 14px;
      min-height: 44px;
      box-sizing: border-box;
      -webkit-appearance: none;
      appearance: none;
      transition: all 0.15s ease;
      background: var(--white);
      color: var(--gray-900);
    }
    .form-input:focus, .form-select:focus {
      outline: none;
      border-color: var(--primary-blue);
      box-shadow: 0 0 0 2px rgba(0, 217, 217, 0.15);
      background: var(--white);
    }
    
    /* Number inputs with mobile optimization */
    input[type="number"] {
      -webkit-appearance: none;
      -moz-appearance: textfield;
      appearance: none;
      /* Remove number input arrows */
    }
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    
    .drawer-section {
      margin: 20px 0;
      border: 2px solid var(--gray-300);
      border-radius: 0;
      overflow: hidden;
    }
    .drawer-header {
      background: var(--light-blue);
      padding: 15px 20px;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 15px;
      color: var(--primary-blue);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .skip-toggle {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 16px;
      color: var(--gray-500);
    }
    .skip-toggle input[type="checkbox"] { width: 20px; height: 20px; }
    .drawer-content { padding: 20px; }
    .denom-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 0;
      border-bottom: 1px solid var(--gray-300);
    }
    .denom-row:last-child { border-bottom: none; }
    .denom-label { font-weight: 500; font-size: 18px; color: var(--gray-700); }
    .denom-value { font-size: 16px; color: var(--gray-500); margin-top: 4px; }

    /* Mobile-Optimized Quantity Inputs */
    .qty-input {
      width: 100px;
      height: 56px;
      text-align: center;
      border: 2px solid var(--gray-300);
      border-radius: 0;
      font-size: 20px;
      font-weight: 500;
      color: var(--gray-700);
      -webkit-appearance: none;
      -moz-appearance: textfield;
      appearance: none;
      transition: all 0.2s ease;
      background: var(--white);
    }
    .qty-input:focus {
      outline: none;
      border-color: var(--primary-blue);
      box-shadow: 0 0 0 3px rgba(44, 95, 141, 0.1);
    }
    /* Remove number arrows */
    .qty-input::-webkit-outer-spin-button,
    .qty-input::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    
    /* Disabled denomination inputs */
    .qty-input:disabled {
      background-color: var(--gray-300);
      color: var(--gray-500);
      border-color: var(--gray-300);
      cursor: not-allowed;
    }

    .denom-row.disabled {
      opacity: 0.5;
    }

    .drawer-total {
      margin-top: 15px;
      padding: 15px;
      background: var(--light-blue);
      border-radius: 0;
      text-align: center;
      font-size: 18px;
      font-weight: 600;
      color: var(--primary-blue);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .grand-total {
      background: linear-gradient(135deg, var(--primary-blue) 0%, var(--secondary-blue) 100%);
      color: var(--white);
      padding: 20px;
      border-radius: 0;
      text-align: center;
      margin: 20px 0;
      box-shadow: 0 4px 12px rgba(44, 95, 141, 0.2);
    }
    .grand-total h3 { font-size: 18px; margin-bottom: 8px; font-weight: 600; opacity: 0.9; text-transform: uppercase; letter-spacing: 0.5px; }
    .grand-total .amount { font-size: 36px; font-weight: 600; }
    .notes-area {
      width: 100%;
      min-height: 100px;
      padding: 18px;
      border: 2px solid var(--gray-300);
      border-radius: 0;
      font-size: 16px;
      resize: vertical;
      box-sizing: border-box;
      transition: all 0.2s ease;
    }
    .notes-area:focus {
      outline: none;
      border-color: var(--primary-blue);
      box-shadow: 0 0 0 3px rgba(44, 95, 141, 0.1);
    }
    .submit-btn {
      width: 100%;
      padding: 14px;
      background: var(--gray-100);
      color: var(--gray-900);
      border: none;
      border-radius: 0;
      font-size: 12px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.15s ease;
      margin-top: 12px;
      min-height: 44px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
      text-transform: uppercase;
      letter-spacing: 1.2px;
      border: 2px solid var(--gray-300);
    }
    .submit-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.12);
      background: var(--gray-300);
    }
    .submit-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
      background: var(--gray-300);
      color: var(--gray-500);
    }
    .am-total-display {
      background: var(--light-blue);
      padding: 20px;
      border-radius: 0;
      margin: 20px 0;
      border: 2px solid rgba(44, 95, 141, 0.1);
    }
    .am-total-display h4 { margin-bottom: 8px; color: var(--primary-blue); font-size: 16px; font-weight: 500; }
    .am-total-display .amount { font-size: 28px; font-weight: 600; color: var(--primary-blue); }

    /* Enhanced Currency Inputs */
    .currency-input {
      width: 100%;
      padding: 20px;
      border: 2px solid var(--gray-300);
      border-radius: 0;
      font-size: 22px;
      text-align: center;
      min-height: 60px;
      box-sizing: border-box;
      -webkit-appearance: none;
      -moz-appearance: textfield;
      appearance: none;
      transition: all 0.2s ease;
      background: var(--white);
      color: var(--gray-700);
    }
    .currency-input:focus {
      outline: none;
      border-color: var(--primary-blue);
      box-shadow: 0 0 0 3px rgba(44, 95, 141, 0.1);
    }
    .currency-input::-webkit-outer-spin-button,
    .currency-input::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    .confirmation-screen { text-align: center; padding: 40px 20px; }
    .confirmation-screen h2 { color: var(--success); margin-bottom: 30px; font-size: 32px; font-weight: 600; }
    .deposit-instruction {
      background: linear-gradient(135deg, var(--success) 0%, #4A8C63 100%);
      color: var(--white);
      padding: 30px;
      border-radius: 0;
      margin: 25px 0;
      font-size: 24px;
      font-weight: 500;
      box-shadow: 0 4px 12px rgba(95, 167, 119, 0.2);
    }
    .return-instruction {
      background: linear-gradient(135deg, var(--warning) 0%, #C69563 100%);
      color: var(--white);
      padding: 30px;
      border-radius: 0;
      margin: 25px 0;
      font-size: 24px;
      font-weight: 500;
      box-shadow: 0 4px 12px rgba(212, 165, 116, 0.2);
    }
    .thank-you { font-size: 22px; color: var(--success); margin: 30px 0; font-weight: 500; }
    .confirm-btn {
      background: linear-gradient(135deg, var(--success) 0%, #4A8C63 100%);
      margin-top: 30px;
    }
    .loading { text-align: center; padding: 40px; }
    .loading-spinner {
      width: 60px;
      height: 60px;
      border: 6px solid var(--gray-300);
      border-top: 6px solid var(--primary-blue);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .message {
      padding: 18px;
      border-radius: 0;
      margin: 20px 0;
      text-align: center;
      font-size: 15px;
      font-weight: 500;
      letter-spacing: 0.3px;
    }
    .message.success {
      background: #E8F5EC;
      color: #2D5F3F;
      border: 2px solid var(--success);
    }
    .message.error {
      background: #F8E6E7;
      color: #6B3638;
      border: 2px solid var(--error);
    }
    .message.info {
      background: var(--light-blue);
      color: var(--primary-blue);
      border: 2px solid var(--secondary-blue);
    }

    /* Typography - Headers */
    h2, h3, h4, h5, h6 {
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 600;
    }
    h2 { font-size: 22px; }
    h3 { font-size: 19px; }
    h4 { font-size: 16px; }
    h5 { font-size: 14px; }
    h6 { font-size: 12px; }

    /* Tip Pool Calculator Styles */
    .cash-needed { color: var(--error); font-weight: 600; }
    .cash-surplus { color: var(--success); font-weight: 600; }
    .hidden { display: none; }
    .skip-content { padding: 25px; }
    .skip-reason {
      width: 100%;
      padding: 18px;
      border: 2px solid var(--gray-300);
      border-radius: 0;
      font-size: 16px;
      min-height: 56px;
      box-sizing: border-box;
      transition: all 0.2s ease;
    }
    .skip-reason:focus {
      outline: none;
      border-color: var(--primary-blue);
      box-shadow: 0 0 0 3px rgba(44, 95, 141, 0.1);
    }
    
    /* Mobile responsive adjustments */
    @media (max-width: 768px) {
      .container { margin: 0; border-radius: 0; }
      .header { padding: 20px; }
      .header h1 { font-size: 24px; }
      .content { padding: 15px; }
      .main-menu { gap: 12px; }
      .menu-btn { padding: 25px 15px; font-size: 16px; min-height: 70px; }
      .denom-row { flex-direction: column; align-items: flex-start; gap: 12px; padding: 20px 0; }
      .qty-input { width: 120px; margin-top: 8px; }
      .grand-total .amount { font-size: 32px; }
      .confirmation-screen h2 { font-size: 28px; }
      .deposit-instruction, .return-instruction { font-size: 20px; padding: 25px; }
    }
    
    @media (max-width: 480px) {
      .header h1 { font-size: 20px; }
      .main-menu { grid-template-columns: 1fr; }
      .main-menu.show-report { grid-template-columns: 1fr; }
      .menu-btn { padding: 20px 15px; min-height: 60px; }
      .denom-label { font-size: 16px; }
      .qty-input { width: 100px; height: 50px; font-size: 18px; }
      .grand-total .amount { font-size: 28px; }
      .deposit-instruction, .return-instruction { font-size: 18px; padding: 20px; }
    }
    
    /* Google Sites Full Page Embed Optimizations */
    @media screen {
      html {
        /* Force proper viewport handling in Google Sites */
        height: auto !important;
        min-height: 100% !important;
        overflow-y: auto !important;
      }
      
      body {
        /* Ensure body can scroll properly in Google Sites iframe */
        height: auto !important;
        min-height: 100% !important;
        position: relative !important;
        overflow-y: auto !important;
        padding-bottom: 50px !important; /* Extra space at bottom */
      }
      
      .container {
        /* Ensure container doesn't get viewport-locked */
        position: relative !important;
        height: auto !important;
        min-height: auto !important;
        max-height: none !important;
        overflow: visible !important;
        margin-bottom: 50px !important; /* Extra bottom margin */
      }
      
      .submit-btn {
        /* Ensure submit buttons are always accessible */
        position: relative !important;
        z-index: 10 !important;
        margin-bottom: 30px !important;
      }
      
      /* Force visibility of bottom elements in Google Sites */
      .form-section:last-child,
      .form-section .submit-btn:last-child {
        margin-bottom: 100px !important;
      }
    }
    
    /* Elegant Loading Overlay */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      z-index: 9999;
      display: flex;
      justify-content: center;
      align-items: center;
      transition: opacity 0.3s ease;
    }
    .loading-overlay.hidden {
      display: none;
    }
    .loading-content {
      text-align: center;
      padding: 40px;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 0;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    .loading-spinner-elegant {
      width: 60px;
      height: 60px;
      border: 4px solid rgba(102, 126, 234, 0.1);
      border-top: 4px solid #667eea;
      border-radius: 50%;
      animation: spin-elegant 1.2s linear infinite;
      margin: 0 auto 20px;
    }
    @keyframes spin-elegant {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .loading-content h3 {
      margin: 0 0 10px 0;
      font-size: 24px;
      color: #333;
      font-weight: 600;
    }
    .loading-content p {
      margin: 0;
      font-size: 16px;
      color: #666;
      opacity: 0.8;
    }
    
    /* Success Screens */
    .success-screen {
      text-align: center;
      padding: 40px 20px;
      max-width: 600px;
      margin: 0 auto;
    }
    .success-icon {
      font-size: 80px;
      margin-bottom: 20px;
      animation: success-bounce 0.6s ease;
    }
    @keyframes success-bounce {
      0% { transform: scale(0.3); opacity: 0; }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); opacity: 1; }
    }
    .success-screen h2 {
      color: #28a745;
      margin-bottom: 15px;
      font-size: 32px;
      font-weight: 700;
    }
    .success-message {
      font-size: 18px;
      color: #666;
      margin-bottom: 30px;
      line-height: 1.5;
    }
    .success-details {
      background: #f8f9fa;
      border-radius: 0;
      padding: 25px;
      margin: 25px 0;
      border-left: 4px solid #28a745;
    }
    .detail-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      font-size: 16px;
    }
    .detail-row:not(:last-child) {
      border-bottom: 1px solid #e9ecef;
    }
    .detail-row span:first-child {
      color: #666;
      font-weight: 500;
    }
    .detail-row span:last-child {
      color: #333;
      font-weight: 600;
    }
    .success-btn {
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
      margin-top: 30px;
      font-size: 18px;
      padding: 20px 40px;
      border-radius: 0;
      transition: all 0.3s ease;
    }
    .success-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(40, 167, 69, 0.3);
    }
  </style>
  
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
  <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
  <!-- Tip Pool Calculator Dependencies -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
</head>
<body>
  <!-- Loading Overlay (consolidated) -->
  <div id="loadingOverlay" style="
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    z-index: 9999;
    justify-content: center;
    align-items: center;
  ">
    <div style="
      text-align: center;
      color: white;
    ">
      <div class="spinner" style="
        border: 8px solid #f3f3f3;
        border-top: 8px solid #4CAF50;
        border-radius: 50%;
        width: 60px;
        height: 60px;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
      "></div>
      <h3 id="loadingTitle" style="
        font-size: 18px;
        font-weight: bold;
        margin-bottom: 10px;
      ">Fetching Toast data...</h3>
      <p id="loadingMessage" style="
        font-size: 14px;
        color: #ccc;
      ">This may take up to 2 minutes</p>
    </div>
  </div>

  <style>
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>

  <div class="container">
    <div class="header">
      <img src="jayna-logo.png" alt="Jayna Gyro Logo" style="width: 80px; height: 80px; margin-bottom: 12px;">
      <h1 style="margin-bottom: 4px;">JAYNA GYRO</h1>
      <h2 style="font-size: 18px; font-weight: 600; margin-bottom: 4px; letter-spacing: 1.5px;">INTERNAL FUNCTION APP</h2>
      <p style="font-size: 11px; font-weight: 500; letter-spacing: 1px; margin-bottom: 8px;">FOR AUTHORIZED USE ONLY</p>
      <p style="opacity: 0.7;">App created by Demetri Gregorakis</p>
      <div style="font-size: 12px; color: #666; margin-top: 5px;">
        <span id="sessionStatus"></span>
        <button id="logoutBtn" onclick="logoutManager()" style="
          background: #f44336; 
          color: white; 
          border: none; 
          padding: 2px 8px; 
          border-radius: 0; 
          font-size: 10px; 
          margin-left: 10px;
          cursor: pointer;
          display: none;
        ">Logout Manager</button>
      </div>
    </div>
    
    <div class="content">
      <div id="messageArea"></div>
      
      <!-- Main Menu -->
      <div id="mainMenu" class="main-menu">
        <button class="menu-btn primary" onclick="startAMCount()">AM Count</button>
        <button class="menu-btn primary" onclick="startPMCount()">PM Close</button>
        <button class="menu-btn" onclick="requirePasswordFor('Generate Reports', showReports)">Generate Report</button>
        <button class="menu-btn" onclick="requirePasswordFor('Tip Pool Calculator', showTipPool)">Tip Pool</button>
        <button class="menu-btn" onclick="requirePasswordFor('Weekly Cashbox Count', showCashbox)">Weekly Cashbox</button>
        <button class="menu-btn" onclick="requirePasswordFor('Manager Dashboard', () => window.location.href='manager.html')">Manager</button>
        <button class="menu-btn" onclick="requirePasswordFor('COGs Management', accessCOGs)" style="background: #616161; color: white; border-color: #616161;">COGs</button>
        <button class="menu-btn" onclick="requirePasswordFor('Ordering System', startOrderingSystem)" style="background: #2e7d32; color: white; border-color: #2e7d32;">Ordering System</button>
      </div>
      
      <!-- AM Count Form -->
      <div id="amForm" class="form-section">
        <h2 style="margin-bottom: 20px; color: #1e3c72;">Morning Cash Count</h2>
        
        <div class="form-group">
          <label for="amDate">Date:</label>
          <input type="date" id="amDate" class="form-input" required>
        </div>
        
        <div class="form-group">
          <label for="amCounter">Counted by:</label>
          <select id="amCounter" class="form-select" onchange="toggleDenominationInputs('am')" required>
            <option value="">Choose Name</option>
            <option value="Demetri Gregorakis">Demetri Gregorakis</option>
            <option value="Ahmet Can Guler">Ahmet Can Guler</option>
            <option value="Bryan Cox">Bryan Cox</option>
            <option value="Kayla Mccullough">Kayla Mccullough</option>
            <option value="Dilan Uzum">Dilan Uzum</option>
          </select>
        </div>
        
        <!-- Drawer 1 -->
        <div class="drawer-section">
          <div class="drawer-header">
            <span>Drawer 1</span>
            <label class="skip-toggle">
              <input type="checkbox" id="amDrawer1Skip" onchange="toggleSkip('am', 1)">
              Skip Drawer
            </label>
          </div>
          <div id="amDrawer1Content" class="drawer-content">
            <div id="amDrawer1Denoms"></div>
            <div class="drawer-total" id="amDrawer1Total">$0.00</div>
          </div>
          <div id="amDrawer1SkipContent" class="skip-content hidden">
            <input type="text" class="skip-reason" id="amDrawer1Reason" placeholder="Reason for skipping drawer 1">
          </div>
        </div>
        
        <!-- Drawer 2 -->
        <div class="drawer-section">
          <div class="drawer-header">
            <span>Drawer 2</span>
            <label class="skip-toggle">
              <input type="checkbox" id="amDrawer2Skip" onchange="toggleSkip('am', 2)">
              Skip Drawer
            </label>
          </div>
          <div id="amDrawer2Content" class="drawer-content">
            <div id="amDrawer2Denoms"></div>
            <div class="drawer-total" id="amDrawer2Total">$0.00</div>
          </div>
          <div id="amDrawer2SkipContent" class="skip-content hidden">
            <input type="text" class="skip-reason" id="amDrawer2Reason" placeholder="Reason for skipping drawer 2">
          </div>
        </div>
        
        <div class="grand-total">
          <h3>Total Cash Count</h3>
          <div class="amount" id="amGrandTotal">$0.00</div>
        </div>
        
        <div class="form-group">
          <label for="amNotes">Notes (Optional):</label>
          <textarea id="amNotes" class="notes-area" placeholder="Any notes for the PM shift..."></textarea>
        </div>
        
        <button class="submit-btn" onclick="submitAM()">Submit AM Count</button>
        <button class="submit-btn" onclick="goHome()" style="margin-top: 10px;">Back to Menu</button>
      </div>
      
      <!-- PM Count Form -->
      <div id="pmForm" class="form-section">
        <h2 style="margin-bottom: 20px; color: #1e3c72;">Evening Cash Close</h2>
        
        <div class="form-group">
          <label for="pmDate">Date:</label>
          <input type="date" id="pmDate" class="form-input" required>
        </div>
        
        <div class="form-group">
          <label for="pmCounter">Counted by:</label>
          <select id="pmCounter" class="form-select" onchange="toggleDenominationInputs('pm')" required>
            <option value="">Choose Name</option>
            <option value="Demetri Gregorakis">Demetri Gregorakis</option>
            <option value="Ahmet Can Guler">Ahmet Can Guler</option>
            <option value="Bryan Cox">Bryan Cox</option>
            <option value="Kayla Mccullough">Kayla Mccullough</option>
            <option value="Dilan Uzum">Dilan Uzum</option>
          </select>
        </div>
        
        <!-- AM Total Display -->
        <div id="amTotalDisplay" class="am-total-display">
          <h4>Morning Count Information:</h4>
          <div style="display: flex; justify-content: space-between; margin: 10px 0; font-size: 14px;">
            <span><strong>Counted by:</strong> <span id="amCounterName">Loading...</span></span>
            <span><strong>Time:</strong> <span id="amCountTime">Loading...</span></span>
          </div>
          <div style="text-align: center; margin: 15px 0;">
            <strong>Starting Amount:</strong>
            <div class="amount" id="pmAmTotal" style="font-size: 28px; margin: 5px 0;">Loading...</div>
          </div>
          <div id="amNotesDisplay" style="background: #fff3cd; padding: 12px; border-radius: 0; margin-top: 15px; border-left: 4px solid #ffc107; display: none;">
            <strong style="color: #856404;">Morning Notes:</strong>
            <div id="amNotes" style="margin-top: 5px; color: #856404;"></div>
          </div>
        </div>
        
        <!-- Drawer 1 -->
        <div class="drawer-section">
          <div class="drawer-header">
            <span>Drawer 1</span>
            <label class="skip-toggle">
              <input type="checkbox" id="pmDrawer1Skip" onchange="toggleSkip('pm', 1)">
              Skip Drawer
            </label>
          </div>
          <div id="pmDrawer1Content" class="drawer-content">
            <div id="pmDrawer1Denoms"></div>
            <div class="drawer-total" id="pmDrawer1Total">$0.00</div>
          </div>
          <div id="pmDrawer1SkipContent" class="skip-content hidden">
            <input type="text" class="skip-reason" id="pmDrawer1Reason" placeholder="Reason for skipping drawer 1">
          </div>
        </div>
        
        <!-- Drawer 2 -->
        <div class="drawer-section">
          <div class="drawer-header">
            <span>Drawer 2</span>
            <label class="skip-toggle">
              <input type="checkbox" id="pmDrawer2Skip" onchange="toggleSkip('pm', 2)">
              Skip Drawer
            </label>
          </div>
          <div id="pmDrawer2Content" class="drawer-content">
            <div id="pmDrawer2Denoms"></div>
            <div class="drawer-total" id="pmDrawer2Total">$0.00</div>
          </div>
          <div id="pmDrawer2SkipContent" class="skip-content hidden">
            <input type="text" class="skip-reason" id="pmDrawer2Reason" placeholder="Reason for skipping drawer 2">
          </div>
        </div>
        
        <div class="grand-total">
          <h3>Total Cash Count</h3>
          <div class="amount" id="pmGrandTotal">$0.00</div>
        </div>
        
        <div class="form-group">
          <label for="toastSales">Toast Cash Sales (Auto-Calculated):</label>
          
          <!-- Auto-calculated display section -->
          <div style="background: var(--gray-100); border: 2px solid var(--gray-300); border-radius: 0; padding: 20px; margin-bottom: 10px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
              <span style="font-weight: 700; color: var(--gray-900); font-size: 16px;">Auto-Fetched from Toast API</span>
              <span style="background: var(--gray-100); color: var(--gray-900); padding: 6px 12px; border-radius: 0; font-size: 12px; font-weight: 600; border: 2px solid var(--gray-300);">
                LIVE DATA
              </span>
            </div>

            <div style="text-align: center; margin: 15px 0;">
              <div style="font-size: 32px; font-weight: bold; color: var(--gray-900); margin-bottom: 8px;" id="autoToastAmount">Loading...</div>
              <div style="font-size: 14px; color: var(--gray-700); font-weight: 500;" id="autoToastDetails">Fetching today's cash sales automatically...</div>
            </div>

            <div style="background: var(--white); padding: 10px; border-radius: 0; font-size: 13px; color: var(--gray-700); border: 1px solid var(--gray-300);">
              <strong>Fully Automated:</strong> This amount is automatically calculated from today's Toast POS cash transactions. No manual entry required.
            </div>
          </div>
          
          <!-- Hidden field for form processing -->
          <input type="hidden" id="toastSales" value="0">
        </div>
        
        <!-- Discrepancy Validation Section -->
        <div id="discrepancySection" class="form-group" style="display: none;">
          <label>Cash Count vs Toast Sales Validation:</label>
          <div id="discrepancyDisplay" style="border-radius: 0; padding: 20px; margin-bottom: 10px;">
            <!-- Dynamic content will be inserted here -->
          </div>
        </div>
        
        <div class="form-group">
          <label for="cashTips">Cash Tips (whole number):</label>
          <input type="number" id="cashTips" class="currency-input" placeholder="0" step="1" min="0" inputmode="numeric" pattern="[0-9]*" onfocus="this.select()">
        </div>
        
        <div class="form-group">
          <label for="pmNotes">Notes (Optional):</label>
          <textarea id="pmNotes" class="notes-area" placeholder="Any notes about the day..."></textarea>
        </div>
        
        <button class="submit-btn" onclick="submitPM()">Submit PM Close</button>
        <button class="submit-btn" onclick="goHome()" style="margin-top: 10px;">Back to Menu</button>
      </div>

      <!-- AM Success Screen -->
      <div id="amSuccessScreen" class="form-section">
        <div class="success-screen">
          <div class="success-icon"></div>
          <h2>AM Count Submitted!</h2>
          <p class="success-message">Your morning cash count has been successfully recorded and stored.</p>
          <div class="success-details">
            <div class="detail-row">
              <span>Total Counted:</span>
              <span id="amSuccessTotal">$0.00</span>
            </div>
            <div class="detail-row">
              <span>Time Submitted:</span>
              <span id="amSuccessTime">--</span>
            </div>
          </div>
          <button class="submit-btn success-btn" onclick="goHome()">Return to Menu</button>
        </div>
      </div>

      <!-- PM Success Screen -->
      <div id="pmSuccessScreen" class="form-section">
        <div class="success-screen">
          <div class="success-icon"></div>
          <h2>PM Close Completed!</h2>
          <p class="success-message">Evening close successful! Report sent to management.</p>
          
          <div class="deposit-instruction">
            DEPOSIT <span id="depositAmount">$0</span> INTO ENVELOPE
          </div>
          
          <div class="return-instruction">
            RETURN <span id="returnAmount">$0.00</span> TO CASH BOX AND LOCK IN SAFE
          </div>
          
          <button class="submit-btn success-btn" onclick="goHome()">Confirm and Close</button>
        </div>
      </div>

      <!-- Report Success Screen -->
      <div id="reportSuccessScreen" class="form-section">
        <div class="success-screen">
          <div class="success-icon"></div>
          <h2>Report Sent Successfully!</h2>
          <p class="success-message">Daily cash report has been emailed to management.</p>
          <div class="success-details">
            <div class="detail-row">
              <span>Report Date:</span>
              <span id="reportSuccessDate">--</span>
            </div>
            <div class="detail-row">
              <span>Sent At:</span>
              <span id="reportSuccessTime">--</span>
            </div>
          </div>
          <button class="submit-btn success-btn" onclick="goHome()">Return to Menu</button>
        </div>
      </div>
      
      <!-- Reports Section -->
      <div id="reportsForm" class="form-section">
        <h2 style="margin-bottom: 20px; color: #1e3c72;">Historical Reports</h2>
        
        <div style="background: #f8f9fa; padding: 15px; border-radius: 0; margin-bottom: 20px; border-left: 4px solid #1e3c72;">
          <h4 style="margin: 0 0 10px 0; color: #1e3c72;">Business Intelligence Reports</h4>
          <p style="margin: 5px 0; font-size: 14px;">Generate comprehensive reports from your saved weekly data including tip pools, cash reconciliation, and employee performance.</p>
          <p style="margin: 5px 0; font-size: 12px; color: #666;"><strong>Note:</strong> Historical reports can only show data from dates that have been processed in weekly combined reports. Generate a weekly report first to save data to the database.</p>
        </div>
        
        <div class="form-group">
          <label>Report Type:</label>
          <div style="display: flex; gap: 15px; margin: 10px 0;">
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="radio" name="reportType" value="single" checked onchange="toggleReportType()">
              <span>Single Day Report</span>
            </label>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="radio" name="reportType" value="weekly" onchange="toggleReportType()">
              <span>Weekly Report (7 days)</span>
            </label>
          </div>
        </div>
        
        <div id="singleDateGroup" class="form-group">
          <label for="reportDate">Select Date:</label>
          <input type="date" id="reportDate" class="form-input" required>
          <div style="margin-top: 5px; font-size: 12px; color: #666;">
            Generate a detailed report for a specific day including cash reconciliation and employee data.
          </div>
        </div>
        
        <div id="weeklyRangeGroup" class="form-group" style="display: none;">
          <label for="savedWeeksDropdown">Select Saved Weekly Report:</label>
          <select id="savedWeeksDropdown" class="form-input" required>
            <option value="">Loading saved reports...</option>
          </select>
          <div style="margin-top: 10px; font-size: 14px; color: #666;">
            <strong>Saved Weekly Reports:</strong> Select from previously generated weekly reports to view the complete summary.
          </div>
        </div>
        
        <button type="button" class="submit-btn" onclick="generateHistoricalReport()" style="background: #1e3c72;">Generate Historical Report</button>
        
        <button class="submit-btn" onclick="goHome()" style="margin-top: 10px;">Back to Menu</button>
        
        <!-- Report Display Area -->
        <div id="reportDisplay" style="display: none; margin-top: 30px; padding: 20px; border: 2px solid #1e3c72; border-radius: 0; background: #f8f9fa;">
          <div id="reportContent"></div>
        </div>
      </div>
      
      <!-- Tip Pool Calculator Section -->
      <div id="tipPoolForm" class="form-section">
        <h2 style="margin-bottom: 20px; color: #1e3c72;">Tip Pool Calculator</h2>
        
        <div style="background: #f8f9fa; padding: 15px; border-radius: 0; margin-bottom: 20px; border-left: 4px solid #007bff;">
          <h4 style="margin: 0 0 10px 0; color: #007bff;">Quick Start:</h4>
          <p style="margin: 5px 0; font-size: 14px;">1. Select date range → data auto-fetches from Toast</p>
          <p style="margin: 5px 0; font-size: 14px;">2. Enter Real Envelope Deposit</p>
          <p style="margin: 5px 0; font-size: 14px;">3. Enter EZ Cater tips + your name</p>
          <p style="margin: 5px 0; font-size: 14px;">4. Click Calculate</p>
          <p style="margin: 5px 0; font-size: 12px; color: #666;"><em>TDS Driver tips auto-calculate from your saved PM data</em></p>
        </div>
        
        <!-- Optional manual file uploads (data auto-fetches from Toast API) -->
        <details style="margin: 15px 0; padding: 10px; background: #f8f9fa; border-radius: 0;">
          <summary style="cursor: pointer; font-size: 13px; color: #666; font-weight: 600;">
            Manual File Upload (Optional - Click to expand)
          </summary>
          <div style="margin-top: 15px;">
            <div class="form-group" style="margin-bottom: 10px;">
              <label for="laborFile" style="font-size: 12px;">Labor Summary CSV File:</label>
              <input type="file" id="laborFile" class="form-input" accept=".csv" style="padding: 8px;">
            </div>

            <div class="form-group" style="margin-bottom: 0;">
              <label for="salesFile" style="font-size: 12px;">Sales Summary ZIP File:</label>
              <input type="file" id="salesFile" class="form-input" accept=".zip" style="padding: 8px;">
            </div>
          </div>
        </details>

        <div class="form-group">
          <label for="tipPoolDateRange">Date Range for Tip Pool:</label>
          <div style="display: flex; gap: 15px; margin: 10px 0;">
            <div style="flex: 1;">
              <label for="tipPoolStartDate" style="font-size: 12px; color: #666;">Start Date:</label>
              <input type="date" id="tipPoolStartDate" class="form-input" onchange="calculateCashTips()">
            </div>
            <div style="flex: 1;">
              <label for="tipPoolEndDate" style="font-size: 12px; color: #666;">End Date:</label>
              <input type="date" id="tipPoolEndDate" class="form-input" onchange="calculateCashTips(); autoFetchOnDateChange()">
            </div>
          </div>
          <div id="autoFetchStatus" style="font-size: 11px; color: #666; margin-top: 5px; min-height: 16px;">
            <!-- Auto-fetch status will appear here -->
          </div>
        </div>
        
        <div class="form-group">
          <label for="realEnvelopeDeposit">Real Envelope Deposit ($):</label>
          <input type="number" id="realEnvelopeDeposit" class="form-input" step="1" placeholder="e.g., 550" inputmode="numeric" pattern="[0-9]*" onchange="calculateCashTips()">
          <div style="font-size: 12px; color: #666; margin-top: 5px;">
            Actual cash amount counted from envelopes
          </div>
        </div>
        
        <div class="form-group">
          <label for="calculatedCashTips">Cash Tips (Auto-Calculated):</label>
          <input type="number" id="calculatedCashTips" class="form-input" step="0.01" inputmode="decimal" readonly style="background: #f8f9fa; color: #666;">
          <div style="font-size: 12px; color: #007bff; margin-top: 5px;">
            <strong>Formula:</strong> Real Envelope Deposit - Toast Cash Sales (from saved PM data)
          </div>
        </div>
        
        <div class="form-group">
          <label for="ezcaterTips">EZ Cater Tips for the Week ($):</label>
          <input type="number" id="ezcaterTips" class="form-input" step="0.01" placeholder="e.g., 40.00" inputmode="decimal">
        </div>
        
        <div class="form-group">
          <label for="tdsDriverTips">TDS Driver Tips for the Week ($):</label>
          <input type="number" id="tdsDriverTips" class="form-input" step="0.01" inputmode="decimal" readonly style="background: #f8f9fa; color: #666;">
          <div id="tdsAutoFetchStatus" style="font-size: 14px; color: #666; margin-top: 5px;">Auto-calculated from Toast API when you calculate tip pool</div>
        </div>

        <div class="form-group">
          <label for="manualLaborCost">Total Labor Cost from Toast Web (Optional):</label>
          <input type="number" id="manualLaborCost" class="form-input" step="0.01" placeholder="e.g., 9637.82" inputmode="decimal">
          <div style="font-size: 12px; color: #666; margin-top: 5px;">
            <strong>Why?</strong> CA double-time rules make API labor cost inaccurate. Enter the "Total Cost" from Toast web labor report for exact calculations.
          </div>
          <div style="font-size: 11px; color: #999; margin-top: 3px;">
            If left blank, will use API data (may be $100-150 low due to double-time hours)
          </div>
        </div>

        <div class="form-group">
          <label for="calculatedByName">Tips Calculated By:</label>
          <input type="text" id="calculatedByName" class="form-input" placeholder="Your Full Name">
        </div>

        <div class="form-group">
          <label for="tipPoolNotes">Custom Notes (Optional):</label>
          <textarea id="tipPoolNotes" class="form-input" rows="3" placeholder="Enter any notes or adjustments for this tip pool calculation..."></textarea>
          <div style="font-size: 12px; color: #666; margin-top: 5px;">These notes will be displayed in the tip pool summary below.</div>
        </div>

        <button class="submit-btn" onclick="calculateTipPool()">Calculate Tip Pool</button>
        <button class="submit-btn" onclick="downloadTipPoolPDF()" id="tipPoolPdfBtn" style="margin-left: 10px; display: none;">Download Tip Pool PDF</button>
        <button class="submit-btn" onclick="clearSavedData()" style="margin-left: 10px;" title="Clear all saved data and start fresh">Clear Saved Data</button>
        

        
        <!-- Tip Pool Results Display -->
        <div id="tipPoolResults" style="display: none; margin-top: 20px;">
          <div id="tipPoolSummary"></div>
          <div id="tipPoolTable"></div>
          
          <!-- Combined Report Section - Auto-populated -->
          <div id="combinedReportSection" style="display: none; margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 0; border: 2px solid #6f42c1;">
            <h4 style="margin: 0 0 15px 0; color: #6f42c1;">Weekly Combined Report</h4>
            <p style="margin: 0 0 15px 0; font-size: 14px; color: #666;">
              Generate a comprehensive weekly summary combining your tip pool calculations with cash count reports.
            </p>
            
            <!-- PDF Upload Options -->
            <div style="margin-bottom: 20px; padding: 15px; background: white; border-radius: 0; border: 1px solid #ddd;">
              <h5 style="margin: 0 0 10px 0; color: #333;">Attach Additional PDFs (Optional)</h5>
              
              <div style="display: flex; gap: 15px; margin-bottom: 10px;">
                <div style="flex: 1;">
                  <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #555;">Add Weekly Voids Log:</label>
                  <input type="file" id="voidsLogUpload" accept=".pdf" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 0;">
                </div>
                <div style="flex: 1;">
                  <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #555;">Add Extras:</label>
                  <input type="file" id="extrasUpload" accept=".pdf" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 0;">
                </div>
              </div>
              
              <p style="margin: 5px 0 0 0; font-size: 12px; color: #666;">
                Upload PDFs to include in your weekly report. Order: Generated Report → Voids Log → Extras
              </p>
            </div>
            
            <div style="display: flex; gap: 15px; align-items: center;">
              <button class="submit-btn" onclick="generateCombinedReport()" style="flex: 1;">Generate Combined Weekly Report</button>
            </div>
            
            <!-- Hidden inputs for auto-populated data -->
            <input type="hidden" id="combinedStartDate">
            <input type="hidden" id="combinedEndDate">
            <input type="hidden" id="combinedRealEnvelope">
          </div>
        </div>
        
        <!-- Hidden Tip Pool Report Display for PDF generation -->
        <div id="tipPoolReportDisplay" style="display: none; position: fixed; top: 0; left: 0; width: 800px; background: white; z-index: 9999; opacity: 0; pointer-events: none;">
          <div id="tipPoolReportContent"></div>
        </div>

        <button class="submit-btn" onclick="goHome()" style="margin-top: 10px;">Back to Menu</button>
      </div>

      <!-- Ordering System Section -->
      <div id="orderingSystemForm" class="form-section">
        <h2 style="margin-bottom: 20px; color: #1e3c72;">Restaurant Ordering System</h2>

        <!-- Tab Navigation -->
        <div style="position: sticky; top: 0; z-index: 100; background: var(--white); margin-bottom: 20px;">
          <div class="tabs" style="display: flex; border-bottom: 2px solid var(--gray-300); overflow-x: auto; overflow-y: hidden; -webkit-overflow-scrolling: touch; gap: 2px;">
            <button class="tab-link active" onclick="openOrderTab(event, 'upcomingOrders')" style="
            flex: 0 0 auto;
            padding: 8px 6px;
            min-width: 70px;
            background: var(--gray-300);
            color: var(--gray-900);
            border: none;
            cursor: pointer;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.15s ease;
          ">ORDERS</button>
          <button class="tab-link" onclick="openOrderTab(event, 'manageInventory')" style="
            flex: 0 0 auto;
            padding: 8px 6px;
            min-width: 70px;
            background: var(--gray-100);
            color: var(--gray-700);
            border: none;
            cursor: pointer;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.15s ease;
          ">MANAGE</button>
          <button class="tab-link" onclick="openOrderTab(event, 'updateCounts')" style="
            flex: 0 0 auto;
            padding: 8px 6px;
            min-width: 70px;
            background: var(--gray-100);
            color: var(--gray-700);
            border: none;
            cursor: pointer;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.15s ease;
          ">COUNT</button>
          <button class="tab-link" onclick="openOrderTab(event, 'prepSheet')" style="
            flex: 0 0 auto;
            padding: 8px 6px;
            min-width: 70px;
            background: var(--gray-100);
            color: var(--gray-700);
            border: none;
            cursor: pointer;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.15s ease;
          ">PREP</button>
          <button class="tab-link" onclick="openOrderTab(event, 'checkInInvoice')" style="
            flex: 0 0 auto;
            padding: 8px 6px;
            min-width: 70px;
            background: var(--gray-100);
            color: var(--gray-700);
            border: none;
            cursor: pointer;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.15s ease;
          ">CHECK-IN</button>
          </div>
        </div>

        <!-- Tab Content: Upcoming Orders -->
        <div id="upcomingOrders" class="tab-content" style="display: block;">
          <div style="text-align: center; padding: 20px;">
            <p>Loading orders...</p>
          </div>
        </div>

        <!-- Tab Content: Manage Inventory -->
        <div id="manageInventory" class="tab-content" style="display: none;">
          <!-- Add New Item Form -->
          <div style="background: #f0f4f8; padding: 20px; border-radius: 4px; margin-bottom: 30px;">
            <h3 style="margin-bottom: 15px; color: #1e3c72;">Add New Inventory Item</h3>
            <form id="addItemForm" onsubmit="handleAddItem(event)" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
              <div class="form-group">
                <label for="newItemName">Item Name:</label>
                <input type="text" id="newItemName" class="form-input" placeholder="e.g., Wild Arugula 4#/CS" required>
              </div>
              <div class="form-group">
                <label for="newItemVendor">Vendor:</label>
                <select id="newItemVendor" class="form-select" required>
                  <option value="">Select Vendor</option>
                  <option value="Greenleaf">Greenleaf</option>
                  <option value="Performance">Performance</option>
                  <option value="Mani Imports">Mani Imports</option>
                  <option value="Eatopia">Eatopia</option>
                  <option value="Restaurant Depot">Restaurant Depot</option>
                  <option value="Alsco">Alsco</option>
                  <option value="SRC Pumping">SRC Pumping</option>
                  <option value="Southern Glazer's">Southern Glazer's</option>
                  <option value="Breakthru Beverage">Breakthru Beverage</option>
                  <option value="Ecolab">Ecolab</option>
                  <option value="OTHER">OTHER (Add New Vendor)</option>
                </select>
              </div>
              <div class="form-group">
                <label for="newItemUnit">Unit:</label>
                <input type="text" id="newItemUnit" class="form-input" placeholder="e.g., CS, EA, LB" required>
              </div>
              <div class="form-group">
                <label for="newItemPar">Par Level:</label>
                <input type="number" id="newItemPar" class="form-input" min="0" value="0" required>
              </div>
              <div style="grid-column: 1 / -1;">
                <button type="submit" class="submit-btn">Add Item</button>
              </div>
            </form>
          </div>

          <!-- Inventory List -->
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3 style="margin: 0; color: #1e3c72;">Inventory Items</h3>
            <button onclick="showVendorManagement()" style="
              background: #1e3c72;
              color: white;
              border: none;
              padding: 8px 16px;
              border-radius: 4px;
              cursor: pointer;
              font-size: 13px;
              font-weight: 600;
            ">Manage Vendors</button>
          </div>

          <!-- Search and Filter Controls -->
          <div style="display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap;">
            <input
              type="text"
              id="inventorySearchInput"
              placeholder="Search items..."
              oninput="filterInventoryList()"
              style="
                flex: 1;
                min-width: 200px;
                padding: 10px 14px;
                border: 2px solid #e0e0e0;
                border-radius: 6px;
                font-size: 14px;
                transition: border-color 0.2s;
              "
              onfocus="this.style.borderColor='#1e3c72'"
              onblur="this.style.borderColor='#e0e0e0'"
            />
            <select
              id="inventoryVendorFilter"
              onchange="filterInventoryList()"
              style="
                padding: 10px 14px;
                border: 2px solid #e0e0e0;
                border-radius: 6px;
                font-size: 14px;
                background: white;
                cursor: pointer;
              "
            >
              <option value="">All Vendors</option>
              <option value="Greenleaf">Greenleaf</option>
              <option value="Performance">Performance</option>
              <option value="Mani Imports">Mani Imports</option>
              <option value="Eatopia">Eatopia</option>
              <option value="Restaurant Depot">Restaurant Depot</option>
              <option value="Alsco">Alsco</option>
              <option value="SRC Pumping">SRC Pumping</option>
              <option value="Southern Glazer's">Southern Glazer's</option>
              <option value="Breakthru Beverage">Breakthru Beverage</option>
            </select>
          </div>

          <div id="inventoryList" style="max-height: 600px; overflow-y: auto;">
            <p style="text-align: center; padding: 20px;">Loading inventory...</p>
          </div>
        </div>

        <!-- Tab Content: Update Counts -->
        <div id="updateCounts" class="tab-content" style="display: none;">
          <!-- Mobile-optimized header controls -->
          <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; align-items: center;">
            <button class="submit-btn" onclick="saveAllStockCounts()" style="background: #2e7d32; flex: 1; min-width: 150px;">
              💾 Save All Changes
            </button>
            <button
              class="submit-btn"
              onclick="toggleCompactMode()"
              style="background: #1e3c72; flex: 0 0 auto; padding: 12px 20px;"
              title="Toggle compact view"
            >
              <span id="compactModeIcon">📋</span>
            </button>
          </div>

          <!-- Search and Filter Controls -->
          <div style="display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap;">
            <input
              type="text"
              id="stockCountSearchInput"
              placeholder="Search items..."
              oninput="filterStockCountList()"
              style="
                flex: 1;
                min-width: 200px;
                padding: 10px 14px;
                border: 2px solid #e0e0e0;
                border-radius: 6px;
                font-size: 14px;
                transition: border-color 0.2s;
              "
              onfocus="this.style.borderColor='#2e7d32'"
              onblur="this.style.borderColor='#e0e0e0'"
            />
            <select
              id="stockCountVendorFilter"
              onchange="filterStockCountList()"
              style="
                padding: 10px 14px;
                border: 2px solid #e0e0e0;
                border-radius: 6px;
                font-size: 14px;
                background: white;
                cursor: pointer;
              "
            >
              <option value="">All Vendors</option>
              <option value="Greenleaf">Greenleaf</option>
              <option value="Performance">Performance</option>
              <option value="Mani Imports">Mani Imports</option>
              <option value="Eatopia">Eatopia</option>
              <option value="Restaurant Depot">Restaurant Depot</option>
              <option value="Alsco">Alsco</option>
              <option value="SRC Pumping">SRC Pumping</option>
              <option value="Southern Glazer's">Southern Glazer's</option>
              <option value="Breakthru Beverage">Breakthru Beverage</option>
            </select>
          </div>

          <div id="stockCountList" style="max-height: 600px; overflow-y: auto;">
            <p style="text-align: center; padding: 20px;">Loading items...</p>
          </div>
        </div>

        <!-- Tab Content: Prep Sheet -->
        <div id="prepSheet" class="tab-content" style="display: none;">
          <!-- Add New Prep Item Form -->
          <div style="background: var(--gray-100); padding: 20px; border-radius: 0; margin-bottom: 30px; border: 2px solid var(--gray-300);">
            <h3 style="margin-bottom: 15px; color: var(--gray-900); font-size: 14px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;">Add New Prep Item</h3>
            <form id="addPrepItemForm" onsubmit="handleAddPrepItem(event)" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
              <div class="form-group">
                <label for="newPrepItemName" style="display: block; margin-bottom: 6px; color: var(--gray-700); font-size: 12px; font-weight: 700; text-transform: uppercase;">Item Name:</label>
                <input type="text" id="newPrepItemName" class="form-input" placeholder="e.g., Marinated Tomatoes" required style="width: 100%; padding: 10px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 13px;">
              </div>
              <div class="form-group">
                <label for="newPrepItemVendor" style="display: block; margin-bottom: 6px; color: var(--gray-700); font-size: 12px; font-weight: 700; text-transform: uppercase;">Vendor:</label>
                <select id="newPrepItemVendor" class="form-select" required style="width: 100%; padding: 10px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 13px; background: var(--white);">
                  <option value="">Select Vendor</option>
                  <option value="Greenleaf">Greenleaf</option>
                  <option value="Performance">Performance</option>
                  <option value="Mani Imports">Mani Imports</option>
                  <option value="Eatopia">Eatopia</option>
                  <option value="Restaurant Depot">Restaurant Depot</option>
                  <option value="Alsco">Alsco</option>
                  <option value="SRC Pumping">SRC Pumping</option>
                  <option value="Southern Glazer's">Southern Glazer's</option>
                  <option value="Breakthru Beverage">Breakthru Beverage</option>
                  <option value="PREP">PREP (House-made)</option>
                  <option value="OTHER">OTHER (Add New Vendor)</option>
                </select>
              </div>
              <div class="form-group">
                <label for="newPrepItemUnit" style="display: block; margin-bottom: 6px; color: var(--gray-700); font-size: 12px; font-weight: 700; text-transform: uppercase;">Unit:</label>
                <input type="text" id="newPrepItemUnit" class="form-input" placeholder="e.g., CS, EA, LB" required style="width: 100%; padding: 10px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 13px;">
              </div>
              <div class="form-group">
                <label for="newPrepItemPar" style="display: block; margin-bottom: 6px; color: var(--gray-700); font-size: 12px; font-weight: 700; text-transform: uppercase;">Par Level:</label>
                <input type="number" id="newPrepItemPar" class="form-input" min="0" step="0.25" value="0" required style="width: 100%; padding: 10px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 13px;">
              </div>
              <div class="form-group">
                <label for="newPrepItemLifespan" style="display: block; margin-bottom: 6px; color: var(--gray-700); font-size: 12px; font-weight: 700; text-transform: uppercase;">Batch Lifespan (hours):</label>
                <input type="number" id="newPrepItemLifespan" class="form-input" min="0" value="48" required style="width: 100%; padding: 10px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 13px;">
              </div>
              <div class="form-group">
                <label for="newPrepItemStorage" style="display: block; margin-bottom: 6px; color: var(--gray-700); font-size: 12px; font-weight: 700; text-transform: uppercase;">Storage Location:</label>
                <select id="newPrepItemStorage" class="form-select" style="width: 100%; padding: 10px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 13px; background: var(--white);">
                  <option value="">Select Location</option>
                  <option value="Walk-in Cooler">Walk-in Cooler</option>
                  <option value="Reach-in Fridge">Reach-in Fridge</option>
                  <option value="Freezer">Freezer</option>
                  <option value="Dry Storage">Dry Storage</option>
                  <option value="Line Station">Line Station</option>
                  <option value="Prep Station">Prep Station</option>
                </select>
              </div>
              <div style="grid-column: 1 / -1;">
                <button type="submit" class="submit-btn" style="background: var(--gray-700); color: var(--white); border: none; padding: 12px 24px; cursor: pointer; font-size: 13px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; width: 100%;">Add Prep Item</button>
              </div>
            </form>
          </div>

          <div style="margin-bottom: 20px;">
            <h3 style="color: var(--gray-900); margin-bottom: 10px; font-size: 14px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;">Today's Prep Recommendations</h3>
            <p style="color: var(--gray-500); font-size: 13px; margin-bottom: 20px;">
              Smart recommendations based on current stock levels, consumption patterns, and batch lifespans.
            </p>
          </div>

          <!-- Count Session Selector (for prep tracking) -->
          <div style="margin-bottom: 20px; padding: 16px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #ff6b35;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333; font-size: 14px;">
              📋 Count Session (for prep item tracking):
            </label>
            <select
              id="countSessionSelector"
              onchange="updateCountSession()"
              style="
                width: 100%;
                max-width: 400px;
                padding: 10px 14px;
                border: 2px solid #ff6b35;
                border-radius: 6px;
                font-size: 14px;
                background: white;
                cursor: pointer;
                font-weight: 500;
              "
            >
              <option value="morning_prep">🌅 Morning Prep (7:00 AM)</option>
              <option value="afternoon_prep">☀️ Afternoon Prep (3:00-4:00 PM)</option>
              <option value="closing_line">🌙 Closing Line (End of Day)</option>
            </select>
            <p style="margin-top: 8px; font-size: 12px; color: #666; font-style: italic;">
              Select which count session this is. System will track consumption patterns between sessions.
            </p>
          </div>

          <!-- PREP Item Counting Section -->
          <div style="margin-bottom: 30px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
              <h3 style="margin: 0; color: var(--gray-900); font-size: 14px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;">Update Prep Stock Counts</h3>
              <button class="submit-btn" onclick="saveAllStockCounts()" style="background: var(--gray-700); color: var(--white); padding: 10px 20px; font-size: 12px; border: none; cursor: pointer; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">
                💾 SAVE ALL
              </button>
            </div>
            <div id="prepCountList" style="max-height: 600px; overflow-y: auto;">
              <p style="text-align: center; padding: 20px; color: var(--gray-500);">Loading prep items...</p>
            </div>
          </div>

          <!-- Action Buttons -->
          <div style="display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap;">
            <button class="submit-btn" onclick="refreshPrepSheet()" style="background: #ff6b35;">
              🔄 Refresh Recommendations
            </button>
            <button class="submit-btn" onclick="generatePrepSheetPDF()" style="background: #1e3c72;">
              📄 Generate PDF
            </button>
            <button class="submit-btn" onclick="printPrepSheet()" style="background: #2e7d32;">
              🖨️ Print Sheet
            </button>
          </div>

          <!-- Prep Summary Stats -->
          <div id="prepSummaryStats" style="
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
          ">
            <!-- Will be populated by JavaScript -->
          </div>

          <!-- Prep Recommendations List -->
          <div id="prepRecommendationsList" style="max-height: 600px; overflow-y: auto;">
            <p style="text-align: center; padding: 20px;">Loading prep recommendations...</p>
          </div>
        </div>

        <!-- Tab Content: Check-In Invoice -->
        <div id="checkInInvoice" class="tab-content" style="display: none;">
          <div style="margin-bottom: 20px;">
            <h3 style="color: var(--gray-900); margin-bottom: 10px; font-size: 16px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;">Invoice Check-In</h3>
            <p style="color: var(--gray-500); font-size: 13px; margin-bottom: 20px;">
              Upload an invoice photo to scan and reconcile items with inventory.
            </p>
          </div>

          <!-- Upload Section -->
          <div style="background: var(--gray-100); padding: 24px; border-radius: 0; margin-bottom: 24px; border: 2px solid var(--gray-300);">
            <div style="text-align: center;">
              <h4 style="margin: 0 0 12px 0; color: var(--gray-900); font-size: 14px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;">Upload Invoice Image</h4>
              <p style="color: var(--gray-500); font-size: 12px; margin-bottom: 16px;">Take a photo or select an image from your device</p>

              <!-- File Input for Camera (Hidden) -->
              <input
                type="file"
                id="invoiceCameraInput"
                accept="image/*"
                capture="environment"
                style="display: none;"
                onchange="handleInvoiceUpload(event)"
              />

              <!-- File Input for Upload (Hidden) -->
              <input
                type="file"
                id="invoiceFileInput"
                accept="image/*,application/pdf"
                style="display: none;"
                onchange="handleInvoiceUpload(event)"
              />

              <!-- Upload Buttons (Side by Side) -->
              <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                <button
                  class="submit-btn"
                  onclick="document.getElementById('invoiceCameraInput').click()"
                  style="background: var(--gray-100); color: var(--gray-900); border: 2px solid var(--gray-300); flex: 1; max-width: 200px; padding: 14px;"
                >
                  TAKE PHOTO
                </button>
                <button
                  class="submit-btn"
                  onclick="document.getElementById('invoiceFileInput').click()"
                  style="background: var(--gray-100); color: var(--gray-900); border: 2px solid var(--gray-300); flex: 1; max-width: 200px; padding: 14px;"
                >
                  UPLOAD
                </button>
              </div>
            </div>
          </div>

          <!-- Preview Section (Hidden until image uploaded) -->
          <div id="invoicePreviewSection" style="display: none; margin-bottom: 24px;">
            <h4 style="color: var(--gray-900); margin-bottom: 12px; font-size: 14px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;">Uploaded Image</h4>
            <div style="background: var(--white); padding: 16px; border-radius: 0; border: 1px solid var(--gray-300); position: relative;">
              <img
                id="invoicePreviewImage"
                style="max-width: 100%; height: auto; border-radius: 0; display: block; margin: 0 auto;"
              />
              <div style="margin-top: 16px; display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                <button
                  class="submit-btn"
                  onclick="processInvoiceOCR()"
                  id="processOCRButton"
                  style="background: var(--gray-100); color: var(--gray-900); border: 2px solid var(--gray-300); flex: 1; max-width: 200px; padding: 14px;"
                >
                  SCAN & EXTRACT
                </button>
                <button
                  class="submit-btn"
                  onclick="clearInvoiceUpload()"
                  style="background: var(--gray-100); color: var(--gray-900); border: 2px solid var(--gray-300); flex: 1; max-width: 200px; padding: 14px;"
                >
                  CLEAR
                </button>
              </div>
            </div>
          </div>

          <!-- OCR Processing Status -->
          <div id="ocrProcessingStatus" style="display: none; margin-bottom: 24px;">
            <div style="background: var(--gray-100); padding: 16px; border-radius: 0; border: 2px solid var(--gray-300);">
              <div style="display: flex; align-items: center; gap: 12px;">
                <div class="spinner" style="
                  border: 3px solid var(--gray-300);
                  border-top: 3px solid var(--gray-500);
                  border-radius: 50%;
                  width: 24px;
                  height: 24px;
                  animation: spin 1s linear infinite;
                "></div>
                <div>
                  <strong style="color: var(--gray-900); font-size: 13px; text-transform: uppercase; letter-spacing: 1px;">Processing Invoice...</strong>
                  <p id="ocrProgressText" style="margin: 4px 0 0 0; color: var(--gray-500); font-size: 12px;">
                    Extracting text from image...
                  </p>
                </div>
              </div>
            </div>
          </div>

          <!-- Extracted Items Section (Hidden until OCR complete) -->
          <div id="extractedItemsSection" style="display: none;">
            <h4 style="color: var(--gray-900); margin-bottom: 16px; font-size: 14px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;">Extracted Items</h4>
            <div id="extractedItemsList" style="max-height: 600px; overflow-y: auto;">
              <!-- Will be populated by JavaScript including check-in button -->
            </div>
          </div>
        </div>

        <button class="submit-btn" onclick="goHome()" style="margin-top: 20px;">Back to Menu</button>
      </div>
    </div>
  </div>

  <!-- Historical Report Results Section - MOVED OUTSIDE tipPoolForm -->
  <div id="reportResults" style="display: none; margin-top: 20px;">
    <div id="reportContent"></div>
  </div>

  <!-- Cashbox Count Section -->
  <div id="cashboxSection" class="form-section main-section">
    <div class="container">
      <div class="form-container" style="max-width: 600px;">
        <h2 style="text-align: center; margin-bottom: 30px; color: #6f42c1;">
          Weekly Cashbox Count
        </h2>
        <p style="text-align: center; margin-bottom: 30px; color: #666; font-size: 14px;">
          Count all cash and coins in the cashbox. This will be used for weekly reconciliation.
        </p>

        <div class="form-group">
          <label for="cashboxCounter">Counted by:</label>
          <select id="cashboxCounter" class="form-select" onchange="toggleCashboxDenominationInputs()" required>
            <option value="">Choose Name</option>
            <option value="Demetri Gregorakis">Demetri Gregorakis</option>
            <option value="Ahmet Can Guler">Ahmet Can Guler</option>
            <option value="Bryan Cox">Bryan Cox</option>
            <option value="Kayla Mccullough">Kayla Mccullough</option>
            <option value="Dilan Uzum">Dilan Uzum</option>
            <option value="Other">Other</option>
          </select>
        </div>

        <div class="form-group" id="cashboxOtherNameGroup" style="display: none;">
          <label for="cashboxOtherName">Enter your name:</label>
          <input type="text" id="cashboxOtherName" class="form-input" placeholder="Full Name">
        </div>

        <!-- Denomination Input Section -->
        <div id="cashboxDenominationInputs" style="display: none; margin-top: 20px;">
          <h4 style="color: #6f42c1; margin-bottom: 15px;">Count by Denomination</h4>
          
          <!-- Bills Section -->
          <div style="background: #f8f9fa; padding: 15px; border-radius: 0; margin-bottom: 15px;">
            <h5 style="color: #495057; margin-bottom: 10px;">Bills</h5>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px;">
              <div class="denomination-group">
                <label>$100 bills:</label>
                <input type="number" id="cashbox_hundreds" class="form-input" min="0" value="0" inputmode="numeric" onchange="calculateCashboxTotal()">
              </div>
              <div class="denomination-group">
                <label>$50 bills:</label>
                <input type="number" id="cashbox_fifties" class="form-input" min="0" value="0" inputmode="numeric" onchange="calculateCashboxTotal()">
              </div>
              <div class="denomination-group">
                <label>$20 bills:</label>
                <input type="number" id="cashbox_twenties" class="form-input" min="0" value="0" inputmode="numeric" onchange="calculateCashboxTotal()">
              </div>
              <div class="denomination-group">
                <label>$10 bills:</label>
                <input type="number" id="cashbox_tens" class="form-input" min="0" value="0" inputmode="numeric" onchange="calculateCashboxTotal()">
              </div>
              <div class="denomination-group">
                <label>$5 bills:</label>
                <input type="number" id="cashbox_fives" class="form-input" min="0" value="0" inputmode="numeric" onchange="calculateCashboxTotal()">
              </div>
              <div class="denomination-group">
                <label>$1 bills:</label>
                <input type="number" id="cashbox_ones" class="form-input" min="0" value="0" inputmode="numeric" onchange="calculateCashboxTotal()">
              </div>
            </div>
          </div>

          <!-- Coins Section -->
          <div style="background: #f8f9fa; padding: 15px; border-radius: 0; margin-bottom: 15px;">
            <h5 style="color: #495057; margin-bottom: 10px;">Coins</h5>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px;">
              <div class="denomination-group">
                <label>Quarters:</label>
                <input type="number" id="cashbox_quarters" class="form-input" min="0" value="0" inputmode="numeric" onchange="calculateCashboxTotal()">
              </div>
              <div class="denomination-group">
                <label>Dimes:</label>
                <input type="number" id="cashbox_dimes" class="form-input" min="0" value="0" inputmode="numeric" onchange="calculateCashboxTotal()">
              </div>
              <div class="denomination-group">
                <label>Nickels:</label>
                <input type="number" id="cashbox_nickels" class="form-input" min="0" value="0" inputmode="numeric" onchange="calculateCashboxTotal()">
              </div>
              <div class="denomination-group">
                <label>Pennies:</label>
                <input type="number" id="cashbox_pennies" class="form-input" min="0" value="0" inputmode="numeric" onchange="calculateCashboxTotal()">
              </div>
            </div>
          </div>

          <!-- Total Display -->
          <div style="background: #e6f3ff; padding: 20px; border-radius: 0; text-align: center; border: 2px solid #007bff;">
            <h4 style="margin: 0 0 10px 0; color: #007bff;">Total Cashbox Amount</h4>
            <div id="cashboxTotal" style="font-size: 24px; font-weight: bold; color: #007bff;">$0.00</div>
          </div>

          <!-- Reconciliation Section -->
          <div id="cashboxReconciliation" style="margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 0; border: 2px solid #ffc107; display: none;">
            <h5 style="color: #856404; margin-bottom: 10px;">Weekly Reconciliation</h5>
            <div id="reconciliationDetails"></div>
          </div>

          <button class="submit-btn" onclick="saveCashboxCount()" style="margin-top: 20px;">Save Cashbox Count</button>
        </div>

        <button class="submit-btn" onclick="goHome()" style="margin-top: 20px;">Back to Menu</button>
      </div>
    </div>
  </div>

<script>
  // Configuration
   const SUPABASE_URL = 'https://gaawtbqpnnbbnsyswqwv.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdhYXd0YnFwbm5iYm5zeXN3cXd2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1MDE1NTAsImV4cCI6MjA3MjA3NzU1MH0.F-y7AIQTWaUe7DRT4OnIZVn94mhXxfhpBbng2aJ8nXg';  
  const EMAILJS_CONFIG = {
    PUBLIC_KEY: 'LHbq8j4mlt49O75eo',
    SERVICE_ID: 'service_xm62z73',
    TEMPLATE_ID: 'template_cash_report',
    MANAGER_EMAIL: 'smanager@jaynagyro.com, GSS4168CTJJA73@PRINT.EPSONCONNECT.COM'
  };

  // Elegant Loading and Success Functions
  function showLoading(title, message) {
    const overlay = document.getElementById('loadingOverlay');
    document.getElementById('loadingTitle').textContent = title;
    document.getElementById('loadingMessage').textContent = message;
    overlay.style.display = 'flex'; // Override inline style
    // Don't hide sections - loading overlay should appear on top, not replace content
  }

  function hideLoading() {
    document.getElementById('loadingOverlay').style.display = 'none';
  }

  function showAMSuccess(total) {
    hideLoading();
    hideAllSections();
    document.getElementById('amSuccessTotal').textContent = `$${total.toFixed(2)}`;
    document.getElementById('amSuccessTime').textContent = new Date().toLocaleString();
    document.getElementById('amSuccessScreen').classList.add('active');
  }

  function showPMSuccess(depositAmount, returnAmount, discrepancy) {
    hideLoading();
    hideAllSections();
    document.getElementById('depositAmount').textContent = `$${depositAmount}`;
    document.getElementById('returnAmount').textContent = `$${returnAmount.toFixed(2)}`;
    document.getElementById('pmSuccessScreen').classList.add('active');
  }

  function showReportSuccess(date) {
    hideLoading();
    hideAllSections();
    document.getElementById('reportSuccessDate').textContent = date;
    document.getElementById('reportSuccessTime').textContent = new Date().toLocaleString();
    document.getElementById('reportSuccessScreen').classList.add('active');
  }
  
  const DENOMINATIONS = [
    { label: '$100', value: 100.00 },
    { label: '$50', value: 50.00 },
    { label: '$20', value: 20.00 },
    { label: '$10', value: 10.00 },
    { label: '$5', value: 5.00 },
    { label: '$1', value: 1.00 },
    { label: '$0.25', value: 0.25 },
    { label: '$0.10', value: 0.10 },
    { label: '$0.05', value: 0.05 },
    { label: '$0.01', value: 0.01 }
  ];
  
  // Password protection for date changes (only Demetri knows this)
  const ADMIN_PASSWORD = 'JaynaGyro2025!';
  
  // Session management for manager access
  function setManagerSession() {
    const now = new Date().getTime();
    const expiryTime = now + (60 * 60 * 1000); // 1 hour from now
    localStorage.setItem('managerSession', expiryTime.toString());
  }
  
  function isManagerSessionValid() {
    const sessionExpiry = localStorage.getItem('managerSession');
    if (!sessionExpiry) return false;
    
    const now = new Date().getTime();
    const expiryTime = parseInt(sessionExpiry);
    
    if (now > expiryTime) {
      // Session expired, clean up
      localStorage.removeItem('managerSession');
      return false;
    }
    
    return true;
  }
  
  function clearManagerSession() {
    localStorage.removeItem('managerSession');
  }
  
  let supabase = null;
  let currentAMData = null;
  
  // Initialize app
  document.addEventListener('DOMContentLoaded', function() {
    initializeSupabase();
    initializeEmailJS();
    setTodayDate();

    // Load saved data (removed loadTipPoolData to reset tip pool fields every time)
    loadCombinedReportData();

    // Initialize TDS data and button state
    resetTdsData();
    updateCalculateButtonState();

    // Add file upload listeners to show status when files are selected
    document.getElementById('laborFile').addEventListener('change', handleFileUpload);
    document.getElementById('salesFile').addEventListener('change', handleFileUpload);

    // Removed "App ready" message to prevent page bouncing
  });
  
  function initializeSupabase() {
    if (SUPABASE_URL === 'YOUR_SUPABASE_URL_HERE' || SUPABASE_ANON_KEY === 'YOUR_SUPABASE_ANON_KEY_HERE') {
      showMessage('Please configure Supabase credentials', 'error');
      return;
    }
    try {
      supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      console.log('Supabase initialized');
    } catch (error) {
      console.error('Supabase init failed:', error);
      showMessage('Database connection failed', 'error');
    }
  }
  
  function initializeEmailJS() {
    if (typeof emailjs !== 'undefined') {
      emailjs.init(EMAILJS_CONFIG.PUBLIC_KEY);
    }
  }
  
  function setTodayDate() {
    const today = getPacificDate();
    document.getElementById('amDate').value = today;
    document.getElementById('pmDate').value = today;
    document.getElementById('reportDate').value = today;
    
    // Add password protection to date inputs
    document.getElementById('amDate').addEventListener('change', function() {
      const result = validateDateChange(this);
      if (result instanceof Promise) {
        // Handle async validation - input value already reset if needed
        return;
      }
    });
    
    document.getElementById('pmDate').addEventListener('change', function() {
      const result = validateDateChange(this);
      if (result instanceof Promise) {
        result.then((success) => {
          if (success) {
            // Only load AM data if date change was authorized
            loadAMData();
            // Also reload Toast cash sales for the new date
            fetchToastCashSalesForDate(this.value);
          }
        });
      } else if (result) {
        // Synchronous case (current date selected)
        loadAMData();
        // Also reload Toast cash sales for the new date
        fetchToastCashSalesForDate(this.value);
      }
    });
    
    document.getElementById('reportDate').addEventListener('change', function() {
      const result = validateDateChange(this);
      if (result instanceof Promise) {
        // Handle async validation - input value already reset if needed
        return;
      }
    });
  }
  
  function getPacificDate() {
    const now = new Date();
    const pacific = new Date(now.toLocaleString("en-US", {timeZone: "America/Los_Angeles"}));
    const year = pacific.getFullYear();
    const month = String(pacific.getMonth() + 1).padStart(2, '0');
    const day = String(pacific.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
  }
  
  function showMessage(text, type) {
    // Only show popups for important messages (errors), ignore info/success
    if (type === 'error') {
      showPopupMessage(text, type);
    }
    // Silently ignore info and success messages to prevent bouncing
  }
  
  function showPopupMessage(text, type) {
    const messageType = type === 'error' ? 'Error' : type === 'success' ? 'Success' : 'Notice';
    const backgroundColor = type === 'error' ? '#f44336' : '#4CAF50';
    const iconEmoji = '';
    
    const modalHTML = `
      <div id="messageModal" style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.7);
        z-index: 10000;
        display: flex;
        justify-content: center;
        align-items: center;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      ">
        <div style="
          background: white;
          padding: 30px;
          border-radius: 0;
          box-shadow: 0 10px 30px rgba(0,0,0,0.3);
          max-width: 400px;
          width: 90%;
          text-align: center;
        ">
          <h3 style="margin: 0 0 20px 0; color: ${backgroundColor};">${iconEmoji} ${messageType}</h3>
          <p style="margin: 0 0 25px 0; line-height: 1.4; font-size: 16px;">
            ${text}
          </p>
          <button onclick="closeMessageModal()" style="
            background: ${backgroundColor};
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 0;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
          ">OK</button>
        </div>
      </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
  }
  
  function closeMessageModal() {
    const modal = document.getElementById('messageModal');
    if (modal) {
      modal.remove();
    }
  }
  
  function validateDateChange(inputElement) {
    const selectedDate = inputElement.value;
    const currentDate = getPacificDate();
    
    // If user selects current date, allow it
    if (selectedDate === currentDate) {
      return true;
    }
    
    // If user selects different date, require password using custom modal
    return new Promise((resolve) => {
      showPasswordModal(selectedDate, currentDate, (success) => {
        if (!success) {
          inputElement.value = currentDate;
        }
        resolve(success);
      });
    });
  }
  
  function showPasswordModal(selectedDate, currentDate, callback) {
    // Create modal HTML
    const modalHTML = `
      <div id="passwordModal" style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.7);
        z-index: 10000;
        display: flex;
        justify-content: center;
        align-items: center;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      ">
        <div style="
          background: white;
          padding: 30px;
          border-radius: 0;
          box-shadow: 0 10px 30px rgba(0,0,0,0.3);
          max-width: 400px;
          width: 90%;
          text-align: center;
        ">
          <h3 style="margin: 0 0 20px 0; color: #d32f2f;">Date Change Warning</h3>
          <p style="margin: 0 0 15px 0; line-height: 1.4;">
            You are trying to change the date from<br>
            <strong>TODAY (${currentDate})</strong> to <strong>${selectedDate}</strong>
          </p>
          <p style="margin: 0 0 20px 0; color: #d32f2f; font-weight: bold;">
            This could overwrite existing data!
          </p>
          <p style="margin: 0 0 15px 0;">Enter admin password to continue:</p>
          <input type="password" id="passwordInput" style="
            width: 80%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 0;
            font-size: 16px;
            text-align: center;
            margin-bottom: 20px;
          " placeholder="Password">
          <div>
            <button onclick="submitPassword()" style="
              background: #4CAF50;
              color: white;
              border: none;
              padding: 10px 20px;
              border-radius: 0;
              margin: 0 10px;
              cursor: pointer;
              font-size: 16px;
            ">Continue</button>
            <button onclick="cancelPassword()" style="
              background: #f44336;
              color: white;
              border: none;
              padding: 10px 20px;
              border-radius: 0;
              margin: 0 10px;
              cursor: pointer;
              font-size: 16px;
            ">Cancel</button>
          </div>
        </div>
      </div>
    `;
    
    // Add modal to page
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // Focus password input
    document.getElementById('passwordInput').focus();
    
    // Store callback for button handlers
    window.passwordModalCallback = callback;
    
    // Add enter key support
    document.getElementById('passwordInput').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        submitPassword();
      }
    });
  }
  
  function submitPassword() {
    const password = document.getElementById('passwordInput').value;
    const modal = document.getElementById('passwordModal');
    
    if (password === ADMIN_PASSWORD) {
      // Silent success - no bouncing message
      modal.remove();
      window.passwordModalCallback(true);
    } else {
      showMessage('Incorrect password. Date has been reset to today for safety.', 'error');
      modal.remove();
      window.passwordModalCallback(false);
    }
  }
  
  function cancelPassword() {
    const modal = document.getElementById('passwordModal');
    modal.remove();
    window.passwordModalCallback(false);
  }

  // General password protection function for manager features
  function requirePasswordFor(featureName, callback) {
    // Check if we have a valid session first
    if (isManagerSessionValid()) {
      // Session is valid, proceed directly
      callback();
      return;
    }

    // No valid session, show password modal
    showManagerPasswordModal(featureName, callback);
  }

  // COGs access function - redirects to cogs.html with session persistence
  function accessCOGs() {
    window.location.href = 'cogs.html';
  }

  function showManagerPasswordModal(featureName, callback) {
    // Create modal HTML for manager features
    const modalHTML = `
      <div id="passwordModal" style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.7);
        z-index: 10000;
        display: flex;
        justify-content: center;
        align-items: center;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      ">
        <div style="
          background: white;
          padding: 30px;
          border-radius: 0;
          box-shadow: 0 10px 30px rgba(0,0,0,0.3);
          max-width: 400px;
          width: 90%;
          text-align: center;
        ">
          <h3 style="margin: 0 0 20px 0; color: #d32f2f;">Manager Access Required</h3>
          <p style="margin: 0 0 15px 0; line-height: 1.4;">
            <strong>${featureName}</strong> requires manager authorization.
          </p>
          <p style="margin: 0 0 20px 0; color: #666;">
            This feature contains sensitive financial data and management tools.
          </p>
          <p style="margin: 0 0 15px 0;">Enter manager password:</p>
          <input type="password" id="passwordInput" style="
            width: 80%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 0;
            font-size: 16px;
            text-align: center;
            margin-bottom: 20px;
          " placeholder="Manager Password">
          <div>
            <button onclick="submitManagerPassword()" style="
              background: #4CAF50;
              color: white;
              border: none;
              padding: 10px 20px;
              border-radius: 0;
              margin: 0 10px;
              cursor: pointer;
              font-size: 16px;
            ">Access ${featureName}</button>
            <button onclick="cancelManagerPassword()" style="
              background: #f44336;
              color: white;
              border: none;
              padding: 10px 20px;
              border-radius: 0;
              margin: 0 10px;
              cursor: pointer;
              font-size: 16px;
            ">Cancel</button>
          </div>
        </div>
      </div>
    `;
    
    // Add modal to page
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // Focus password input
    document.getElementById('passwordInput').focus();
    
    // Store callback for button handlers
    window.managerPasswordCallback = callback;
    
    // Add enter key support
    document.getElementById('passwordInput').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        submitManagerPassword();
      }
    });
  }

  function submitManagerPassword() {
    const password = document.getElementById('passwordInput').value;
    const modal = document.getElementById('passwordModal');
    
    if (password === ADMIN_PASSWORD) {
      // Success - set manager session and execute the protected function
      setManagerSession();
      modal.remove();
      showMessage('Manager access granted for 1 hour', 'success');
      // Update the session status display immediately
      updateSessionStatus();
      window.managerPasswordCallback();
    } else {
      showMessage('Incorrect manager password. Access denied.', 'error');
      modal.remove();
    }
  }

  function cancelManagerPassword() {
    const modal = document.getElementById('passwordModal');
    modal.remove();
    // Don't call callback on cancel
  }
  
  function logoutManager() {
    clearManagerSession();
    updateSessionStatus();
    showMessage('Manager session ended', 'success');
  }
  
  function updateSessionStatus() {
    const statusElement = document.getElementById('sessionStatus');
    const logoutBtn = document.getElementById('logoutBtn');
    
    if (!statusElement || !logoutBtn) return; // Elements not ready yet
    
    if (isManagerSessionValid()) {
      const sessionExpiry = localStorage.getItem('managerSession');
      const expiryTime = parseInt(sessionExpiry);
      const now = new Date().getTime();
      const remainingMinutes = Math.ceil((expiryTime - now) / (60 * 1000));
      
      statusElement.textContent = `Manager access: ${remainingMinutes} min remaining`;
      statusElement.style.color = '#28a745';
      logoutBtn.style.display = 'inline-block';
    } else {
      statusElement.textContent = 'Staff access mode';
      statusElement.style.color = '#666';
      logoutBtn.style.display = 'none';
    }
  }
  
  // Update session status every minute
  setInterval(updateSessionStatus, 60000);
  
  // Initialize session status when page loads
  window.addEventListener('load', function() {
    setTimeout(updateSessionStatus, 100); // Small delay to ensure DOM is ready
  });
  
  function logoutManager() {
    clearManagerSession();
    updateSessionStatus();
    showMessage('Manager session ended', 'success');
  }
  
  function updateSessionStatus() {
    const statusElement = document.getElementById('sessionStatus');
    const logoutBtn = document.getElementById('logoutBtn');
    
    if (isManagerSessionValid()) {
      const sessionExpiry = localStorage.getItem('managerSession');
      const expiryTime = parseInt(sessionExpiry);
      const now = new Date().getTime();
      const remainingMinutes = Math.ceil((expiryTime - now) / (60 * 1000));
      
      statusElement.textContent = `Manager access: ${remainingMinutes} min remaining`;
      statusElement.style.color = '#28a745';
      logoutBtn.style.display = 'inline-block';
    } else {
      statusElement.textContent = 'Staff access mode';
      statusElement.style.color = '#666';
      logoutBtn.style.display = 'none';
    }
  }
  
  // Update session status every minute
  setInterval(updateSessionStatus, 60000);
  
  // Update session status on page load
  document.addEventListener('DOMContentLoaded', updateSessionStatus);

  function hideAllSections() {
    console.log('hideAllSections() called - this might be hiding tip pool results!');
    console.trace('hideAllSections call stack');
    document.querySelectorAll('.form-section').forEach(section => section.classList.remove('active'));
  }
  
  function goHome() {
    console.log('goHome() called - this will hide tip pool results!');
    console.trace('goHome call stack');
    hideAllSections();
    document.getElementById('mainMenu').style.display = 'grid';
    
    // Reset container width
    const container = document.querySelector('.container');
    if (container) {
      container.style.maxWidth = '600px';
    }
  }

  // Toast API Integration
  let autoCalculatedToastAmount = 0;
  
  async function fetchToastCashSales() {
    // Use today's date by default
    const today = new Date();
    const businessDate = formatDateForToast(today);
    await fetchToastCashSalesForDate(businessDate);
  }

  async function fetchToastCashSalesForDate(dateInput) {
    // Show loading state
    document.getElementById('autoToastAmount').textContent = 'Loading...';
    document.getElementById('autoToastDetails').textContent = 'Fetching live data from Toast API...';
    
    try {
      // Handle both date string (YYYY-MM-DD) and formatted date (YYYYMMDD)
      let businessDate;
      if (dateInput.includes('-')) {
        // Convert YYYY-MM-DD to YYYYMMDD
        const dateObj = new Date(dateInput + 'T12:00:00'); // Add time to avoid timezone issues
        businessDate = formatDateForToast(dateObj);
      } else {
        // Already in YYYYMMDD format
        businessDate = dateInput;
      }
      
      console.log('Auto-fetching Toast cash sales for:', businessDate);
      
      // First authenticate with Toast
      const authResponse = await fetch('/api/toast-auth', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      });
      
      if (!authResponse.ok) {
        throw new Error('Failed to authenticate with Toast API');
      }
      
      const authData = await authResponse.json();
      if (!authData.success || !authData.data?.accessToken) {
        throw new Error('Toast authentication failed');
      }
      
      // Fetch cash sales using payments API
      const paymentsUrl = `/api/toast-payments?businessDate=${businessDate}&token=${encodeURIComponent(authData.data.accessToken)}`;
      const paymentsResponse = await fetch(paymentsUrl);
      
      if (!paymentsResponse.ok) {
        throw new Error('Failed to fetch Toast payments data');
      }
      
      const paymentsData = await paymentsResponse.json();
      if (!paymentsData.success) {
        throw new Error(paymentsData.error || 'Toast payments API returned an error');
      }
      
      // Store the auto-calculated amount
      autoCalculatedToastAmount = paymentsData.totalCashAmount;
      
      // Update the hidden field for form processing
      document.getElementById('toastSales').value = autoCalculatedToastAmount.toFixed(2);
      
      // Show success result
      document.getElementById('autoToastAmount').textContent = `$${autoCalculatedToastAmount.toFixed(2)}`;
      document.getElementById('autoToastDetails').textContent = 
        `${paymentsData.totalCashPayments} cash payments • ${paymentsData.totalPaymentGuids} total transactions • Auto-synced`;
      
      console.log('Toast cash sales auto-fetched successfully:', autoCalculatedToastAmount);
      
      // Trigger discrepancy validation if we're in PM mode
      const pmGrandTotal = document.getElementById('pmGrandTotal');
      if (pmGrandTotal && pmGrandTotal.textContent !== '$0.00') {
        const pmTotal = parseFloat(pmGrandTotal.textContent.replace('$', '').replace(',', '')) || 0;
        validatePMDiscrepancy(pmTotal);
      }
      
    } catch (error) {
      console.error('Toast API auto-fetch error:', error);
      
      // Show error state but don't provide fallback
      document.getElementById('autoToastAmount').textContent = 'API Error';
      document.getElementById('autoToastDetails').textContent = 
        `Failed to fetch: ${error.message} • Please check internet connection and try again`;
      
      // Reset auto amount
      autoCalculatedToastAmount = 0;
      document.getElementById('toastSales').value = '0';
    }
  }

  function formatDateForToast(date) {
    // Convert to YYYYMMDD format for Toast API
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}${month}${day}`;
  }
  
  function startAMCount() {
    // Keep main menu visible at top
    hideAllSections();
    document.getElementById('amForm').classList.add('active');
    setupDenominations('am');
  }
  
  async function startPMCount() {
    // Keep main menu visible at top
    hideAllSections();
    document.getElementById('pmForm').classList.add('active');
    setupDenominations('pm');
    
    await loadAMData();
    
    // Automatically fetch Toast cash sales when PM section loads
    console.log('PM Count started - automatically fetching Toast cash sales...');
    try {
      await fetchToastCashSales();
    } catch (error) {
      console.error('Auto-fetch Toast sales failed:', error);
      // Don't block the UI - user can still proceed manually if needed
    }
  }
  
  function showReports() {
    // Keep main menu visible at top
    hideAllSections();
    document.getElementById('reportsForm').classList.add('active');
  }
  
  function showTipPool() {
    // Keep main menu visible at top
    hideAllSections();
    document.getElementById('tipPoolForm').classList.add('active');
    
    // Show results if we have loaded data
    if (tipPoolRecords.length > 0) {
      document.getElementById('tipPoolResults').style.display = 'block';
      document.getElementById('tipPoolPdfBtn').style.display = 'inline-block';
      document.getElementById('combinedReportSection').style.display = 'block';
    }
  }
  
  // ===== CASHBOX FUNCTIONS =====
  
  function showCashbox() {
    // Keep main menu visible at top
    hideAllSections();
    document.getElementById('cashboxSection').classList.add('active');
    loadPreviousCashboxData();
  }
  
  function toggleCashboxDenominationInputs() {
    const counterSelect = document.getElementById('cashboxCounter');
    const otherNameGroup = document.getElementById('cashboxOtherNameGroup');
    const denominationInputs = document.getElementById('cashboxDenominationInputs');
    
    if (counterSelect.value === 'Other') {
      otherNameGroup.style.display = 'block';
    } else {
      otherNameGroup.style.display = 'none';
    }
    
    if (counterSelect.value && counterSelect.value !== '') {
      denominationInputs.style.display = 'block';
    } else {
      denominationInputs.style.display = 'none';
    }
  }
  
  function calculateCashboxTotal() {
    const denominations = [
      { id: 'cashbox_hundreds', value: 100 },
      { id: 'cashbox_fifties', value: 50 },
      { id: 'cashbox_twenties', value: 20 },
      { id: 'cashbox_tens', value: 10 },
      { id: 'cashbox_fives', value: 5 },
      { id: 'cashbox_ones', value: 1 },
      { id: 'cashbox_quarters', value: 0.25 },
      { id: 'cashbox_dimes', value: 0.10 },
      { id: 'cashbox_nickels', value: 0.05 },
      { id: 'cashbox_pennies', value: 0.01 }
    ];
    
    let total = 0;
    denominations.forEach(denom => {
      const count = parseInt(document.getElementById(denom.id).value) || 0;
      total += count * denom.value;
    });
    
    document.getElementById('cashboxTotal').textContent = `$${total.toFixed(2)}`;
    return total;
  }
  
  async function loadPreviousCashboxData() {
    try {
      // Get the most recent cashbox count for reconciliation
      const { data, error } = await supabase
        .from('cashbox_counts')
        .select('*')
        .order('date', { ascending: false })
        .limit(1);
      
      if (error) throw error;
      
      if (data && data.length > 0) {
        const lastCount = data[0];
        showReconciliation(lastCount);
      }
    } catch (error) {
      console.error('Error loading previous cashbox data:', error);
    }
  }
  
  function showReconciliation(lastCount) {
    const reconciliationSection = document.getElementById('cashboxReconciliation');
    const reconciliationDetails = document.getElementById('reconciliationDetails');
    
    const lastDate = new Date(lastCount.date).toLocaleDateString();
    const lastAmount = lastCount.total;
    
    reconciliationDetails.innerHTML = `
      <div style="margin-bottom: 10px;">
        <strong>Previous Cashbox Count:</strong> ${lastDate} - $${lastAmount.toFixed(2)}
      </div>
      <div style="margin-bottom: 10px; font-size: 12px; color: #856404;">
        <strong>Reconciliation Logic:</strong><br>
        Expected This Week = Previous Week + Daily Discrepancies<br>
        <em>Note: AM register loading amounts do not affect total cashbox reconciliation</em>
      </div>
      <div style="font-size: 12px; color: #856404;">
        After entering your count, we'll calculate discrepancies and verify reconciliation.
      </div>
    `;
    
    reconciliationSection.style.display = 'block';
  }
  
  async function saveCashboxCount() {
    try {
      const counterSelect = document.getElementById('cashboxCounter');
      const otherName = document.getElementById('cashboxOtherName').value;
      
      let counterName = counterSelect.value;
      if (counterName === 'Other') {
        counterName = otherName;
      }
      
      if (!counterName) {
        throw new Error('Please select or enter a name');
      }
      
      const total = calculateCashboxTotal();
      if (total === 0) {
        throw new Error('Please enter denomination counts');
      }
      
      const denominations = {
        hundreds: parseInt(document.getElementById('cashbox_hundreds').value) || 0,
        fifties: parseInt(document.getElementById('cashbox_fifties').value) || 0,
        twenties: parseInt(document.getElementById('cashbox_twenties').value) || 0,
        tens: parseInt(document.getElementById('cashbox_tens').value) || 0,
        fives: parseInt(document.getElementById('cashbox_fives').value) || 0,
        ones: parseInt(document.getElementById('cashbox_ones').value) || 0,
        quarters: parseInt(document.getElementById('cashbox_quarters').value) || 0,
        dimes: parseInt(document.getElementById('cashbox_dimes').value) || 0,
        nickels: parseInt(document.getElementById('cashbox_nickels').value) || 0,
        pennies: parseInt(document.getElementById('cashbox_pennies').value) || 0
      };
      
      const { data, error } = await supabase
        .from('cashbox_counts')
        .insert([{
          date: new Date().toISOString().split('T')[0],
          counter: counterName,
          denominations: denominations,
          total: total,
          timestamp: new Date().toISOString()
        }]);
      
      if (error) throw error;
      
      showMessage(`Cashbox count saved successfully! Total: $${total.toFixed(2)}`, 'success');
      
      // Reset form
      document.getElementById('cashboxCounter').value = '';
      document.getElementById('cashboxOtherName').value = '';
      toggleCashboxDenominationInputs();
      
      // Reset all denomination inputs
      Object.keys(denominations).forEach(key => {
        document.getElementById(`cashbox_${key}`).value = '0';
      });
      calculateCashboxTotal();
      
    } catch (error) {
      showMessage(error.message, 'error');
    }
  }
  
  async function saveCashboxCountFromReport(total) {
    try {
      const counterName = tipPoolSummary.calculatedByName || 'Unknown';
      
      const { data, error } = await supabase
        .from('cashbox_counts')
        .insert([{
          date: new Date().toISOString().split('T')[0],
          counter: counterName,
          denominations: { manual_entry: true }, // Mark as manual entry from report
          total: total,
          timestamp: new Date().toISOString(),
          notes: 'Entered during combined report generation'
        }]);
      
      if (error) throw error;
      
      console.log('Cashbox count saved from report:', total);
      
    } catch (error) {
      console.error('Error saving cashbox count from report:', error);
    }
  }
  
  async function getCashboxReconciliation(currentTotal) {
    try {
      // Get the two most recent cashbox counts for comparison
      const { data, error } = await supabase
        .from('cashbox_counts')
        .select('*')
        .order('date', { ascending: false })
        .limit(2);
      
      if (error) throw error;
      
      if (!data || data.length === 0) {
        return {
          isFirstCount: true,
          currentTotal: currentTotal,
          message: 'First cashbox count recorded - baseline established'
        };
      }
      
      if (data.length === 1) {
        return {
          isFirstCount: true,
          currentTotal: currentTotal,
          previousTotal: null,
          message: 'Second cashbox count - reconciliation will begin next week'
        };
      }
      
      const current = data[0]; // Most recent (just saved)
      const previous = data[1]; // Previous week
      
      // Get date range for daily discrepancies between the two cashbox counts
      const startDate = new Date(previous.date);
      const endDate = new Date(current.date);
      
      // Fetch daily discrepancies for the period
      const { data: discrepancyData, error: discrepancyError } = await supabase
        .from('cash_counts')
        .select('pm_discrepancy, date')
        .gte('date', previous.date)
        .lt('date', current.date) // Use < to exclude current date
        .not('pm_discrepancy', 'is', null)
        .order('date', { ascending: true });
      
      if (discrepancyError) throw discrepancyError;
      
      // Calculate total discrepancies for the period
      const totalDiscrepancies = discrepancyData ? 
        discrepancyData.reduce((sum, day) => sum + (day.pm_discrepancy || 0), 0) : 0;
      
      // CORRECT RECONCILIATION FORMULA:
      // Week_N_Ending_Cashbox = Week_N_Starting_Cashbox + Sum(Daily_Discrepancies)
      const expectedEnding = previous.total + totalDiscrepancies;
      const actualVariance = currentTotal - expectedEnding;
      
      return {
        isFirstCount: false,
        currentTotal: currentTotal,
        currentDate: new Date(current.date).toLocaleDateString(),
        previousTotal: previous.total,
        previousDate: new Date(previous.date).toLocaleDateString(),
        totalDiscrepancies: totalDiscrepancies,
        expectedEnding: expectedEnding,
        actualVariance: actualVariance,
        discrepancyDays: discrepancyData ? discrepancyData.length : 0,
        reconciliationStatus: Math.abs(actualVariance) < 0.01 ? 'BALANCED' : 
                             actualVariance > 0 ? 'OVERAGE' : 'SHORTAGE',
        message: Math.abs(actualVariance) < 0.01 ? 
                'Perfect reconciliation! Cashbox balances correctly.' :
                actualVariance > 0 ? 
                `Unexplained overage of $${actualVariance.toFixed(2)}` :
                `Unexplained shortage of $${Math.abs(actualVariance).toFixed(2)}`
      };
      
    } catch (error) {
      console.error('Error getting cashbox reconciliation:', error);
      return null;
    }
  }
  
  function setupDenominations(shift) {
    [1, 2].forEach(drawer => {
      const container = document.getElementById(`${shift}Drawer${drawer}Denoms`);
      container.innerHTML = '';
      
      DENOMINATIONS.forEach((denom, index) => {
        const row = document.createElement('div');
        row.className = 'denom-row';
        row.innerHTML = `
          <div>
            <div class="denom-label">${denom.label}</div>
            <div class="denom-value" id="${shift}D${drawer}V${index}">0 × $${denom.value.toFixed(2)} = $0.00</div>
          </div>
          <input type="number" class="qty-input" id="${shift}D${drawer}Q${index}" 
                 min="0" step="1" value="0" 
                 inputmode="numeric" pattern="[0-9]*"
                 oninput="updateCalculations('${shift}', ${drawer})" 
                 onfocus="this.select()">
        `;
        container.appendChild(row);
      });
    });
    
    // Apply disabled state based on current name selection
    toggleDenominationInputs(shift);
  }
  
  function toggleSkip(shift, drawer) {
    const skipBox = document.getElementById(`${shift}Drawer${drawer}Skip`);
    const content = document.getElementById(`${shift}Drawer${drawer}Content`);
    const skipContent = document.getElementById(`${shift}Drawer${drawer}SkipContent`);
    
    if (skipBox.checked) {
      content.classList.add('hidden');
      skipContent.classList.remove('hidden');
    } else {
      content.classList.remove('hidden');
      skipContent.classList.add('hidden');
    }
    updateCalculations(shift, drawer);
  }
  
  function toggleDenominationInputs(shift) {
    const counterSelect = document.getElementById(`${shift}Counter`);
    if (!counterSelect) return; // Safety check
    
    const hasName = counterSelect.value.trim() !== '';
    
    // Toggle denomination inputs for both drawers
    for (let drawer = 1; drawer <= 2; drawer++) {
      DENOMINATIONS.forEach((denom, index) => {
        const qtyInput = document.getElementById(`${shift}D${drawer}Q${index}`);
        if (!qtyInput) return; // Safety check
        
        const denomRow = qtyInput.closest('.denom-row');
        if (!denomRow) return; // Safety check
        
        if (hasName) {
          qtyInput.disabled = false;
          denomRow.classList.remove('disabled');
        } else {
          qtyInput.disabled = true;
          qtyInput.value = ''; // Clear any existing values
          denomRow.classList.add('disabled');
        }
      });
      
      // Update calculations after enabling/disabling
      updateCalculations(shift, drawer);
    }
  }
  
  function updateCalculations(shift, drawer) {
    const skipBox = document.getElementById(`${shift}Drawer${drawer}Skip`);
    let drawerTotal = 0;
    
    if (!skipBox.checked) {
      DENOMINATIONS.forEach((denom, index) => {
        const qtyInput = document.getElementById(`${shift}D${drawer}Q${index}`);
        const qty = parseInt(qtyInput.value) || 0;
        const value = qty * denom.value;
        
        document.getElementById(`${shift}D${drawer}V${index}`).textContent = 
          `${qty} × $${denom.value.toFixed(2)} = $${value.toFixed(2)}`;
        
        drawerTotal += value;
      });
    }
    
    document.getElementById(`${shift}Drawer${drawer}Total`).textContent = `$${drawerTotal.toFixed(2)}`;
    updateGrandTotal(shift);
  }
  
  function updateGrandTotal(shift) {
    const drawer1Skip = document.getElementById(`${shift}Drawer1Skip`).checked;
    const drawer2Skip = document.getElementById(`${shift}Drawer2Skip`).checked;
    
    const drawer1Total = drawer1Skip ? 0 : parseFloat(document.getElementById(`${shift}Drawer1Total`).textContent.replace('$', ''));
    const drawer2Total = drawer2Skip ? 0 : parseFloat(document.getElementById(`${shift}Drawer2Total`).textContent.replace('$', ''));
    
    const grandTotal = drawer1Total + drawer2Total;
    document.getElementById(`${shift}GrandTotal`).textContent = `$${grandTotal.toFixed(2)}`;
    
    // Add discrepancy validation for PM shift only
    if (shift === 'pm') {
      validatePMDiscrepancy(grandTotal);
    }
  }

  function validatePMDiscrepancy(pmTotal) {
    const discrepancySection = document.getElementById('discrepancySection');
    const discrepancyDisplay = document.getElementById('discrepancyDisplay');
    
    // Get AM total and Toast sales
    const amTotalText = document.getElementById('pmAmTotal').textContent;
    const toastSales = autoCalculatedToastAmount || 0;
    
    // Only validate if we have all necessary data
    if (!amTotalText || amTotalText === 'Loading...' || amTotalText === 'Please select a date' || toastSales === 0) {
      discrepancySection.style.display = 'none';
      return;
    }
    
    const amTotal = parseFloat(amTotalText.replace('$', '').replace(',', '')) || 0;
    const netCashChange = pmTotal - amTotal; // This should equal Toast sales
    const discrepancy = netCashChange - toastSales;
    const absDiscrepancy = Math.abs(discrepancy);
    
    // Show the section
    discrepancySection.style.display = 'block';
    
    // Determine warning level and styling
    let borderColor, backgroundColor, textColor, warningLevel, warningMessage, warningIcon;
    
    if (absDiscrepancy <= 3) {
      // Good - within $3
      borderColor = '#28a745';
      backgroundColor = '#d4edda';
      textColor = '#155724';
      warningLevel = 'GOOD';
      warningMessage = 'Cash count matches Toast sales within acceptable range.';
      warningIcon = '';
    } else if (absDiscrepancy <= 10) {
      // Warning - $3-$10
      borderColor = '#ffc107';
      backgroundColor = '#fff3cd';
      textColor = '#856404';
      warningLevel = 'SUGGESTION';
      warningMessage = 'Consider recounting your cash to ensure accuracy, but you may proceed if confident.';
      warningIcon = '';
    } else {
      // Severe - over $10
      borderColor = '#dc3545';
      backgroundColor = '#f8d7da';
      textColor = '#721c24';
      warningLevel = 'IMPORTANT';
      warningMessage = 'Significant discrepancy detected. Please recount everything carefully or confirm you want to proceed.';
      warningIcon = '';
    }
    
    // Add special message for negative discrepancies
    let negativeWarning = '';
    if (discrepancy < 0) {
      negativeWarning = `<div style="background: rgba(220, 53, 69, 0.1); padding: 8px; border-radius: 0; font-size: 13px; margin-top: 10px;">
        <strong>Cash Tips Impact:</strong> This ${Math.abs(discrepancy).toFixed(2)} shortage will be deducted from cash tips. Please verify your count is accurate.
      </div>`;
    }
    
    discrepancyDisplay.style.border = `2px solid ${borderColor}`;
    discrepancyDisplay.style.background = backgroundColor;
    discrepancyDisplay.style.color = textColor;
    
    discrepancyDisplay.innerHTML = `
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <span style="font-weight: 700; font-size: 16px;">${warningIcon} Cash vs Toast Validation</span>
        <span style="background: ${borderColor}; color: white; padding: 6px 12px; border-radius: 0; font-size: 12px; font-weight: 600;">
          ${warningLevel}
        </span>
      </div>
      
      <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin: 15px 0; text-align: center;">
        <div>
          <div style="font-size: 12px; opacity: 0.8;">Net Cash Change</div>
          <div style="font-size: 24px; font-weight: bold;">$${netCashChange.toFixed(2)}</div>
          <div style="font-size: 11px; opacity: 0.7;">PM Total - AM Total</div>
        </div>
        <div>
          <div style="font-size: 12px; opacity: 0.8;">Toast Sales</div>
          <div style="font-size: 24px; font-weight: bold;">$${toastSales.toFixed(2)}</div>
          <div style="font-size: 11px; opacity: 0.7;">Expected Amount</div>
        </div>
        <div>
          <div style="font-size: 12px; opacity: 0.8;">Discrepancy</div>
          <div style="font-size: 24px; font-weight: bold; color: ${discrepancy >= 0 ? borderColor : '#dc3545'};">
            ${discrepancy >= 0 ? '+' : ''}$${discrepancy.toFixed(2)}
          </div>
          <div style="font-size: 11px; opacity: 0.7;">${discrepancy >= 0 ? 'Overage' : 'Shortage'}</div>
        </div>
      </div>
      
      <div style="background: rgba(${borderColor === '#28a745' ? '40, 167, 69' : borderColor === '#ffc107' ? '255, 193, 7' : '220, 53, 69'}, 0.1); padding: 10px; border-radius: 0; font-size: 13px; text-align: center;">
        <strong>${warningMessage}</strong>
      </div>
      
      ${negativeWarning}
    `;
  }
  
  async function loadAMData() {
    const date = document.getElementById('pmDate').value;
    console.log('Loading AM data for date:', date);
    
    if (!date) {
      document.getElementById('pmAmTotal').textContent = 'Please select a date';
      document.getElementById('amCounterName').textContent = 'Please select a date';
      document.getElementById('amCountTime').textContent = 'Please select a date';
      return;
    }
    
    // Show loading state
    document.getElementById('pmAmTotal').textContent = 'Loading...';
    document.getElementById('amCounterName').textContent = 'Loading...';
    document.getElementById('amCountTime').textContent = 'Loading...';
    
    try {
      if (!supabase) {
        throw new Error('Database not connected');
      }
      
      console.log('Querying Supabase for AM data...');
      const amData = await getAMData(date);
      console.log('AM data result:', amData);
      
      if (amData && amData.total > 0) {
        currentAMData = amData;
        document.getElementById('pmAmTotal').textContent = `$${amData.total.toFixed(2)}`;
        
        // FIX: Set AM counter name and timestamp
        document.getElementById('amCounterName').textContent = amData.counter || 'N/A';
        document.getElementById('amCountTime').textContent = amData.timestamp ? new Date(amData.timestamp).toLocaleString() : 'N/A';
        
        // Handle AM notes display
        const amNotesDisplay = document.getElementById('amNotesDisplay');
        const amNotesEl = document.getElementById('amNotes');
        if (amData.notes && amData.notes.trim()) {
          amNotesEl.textContent = amData.notes;
          amNotesDisplay.style.display = 'block';
        } else {
          amNotesDisplay.style.display = 'none';
        }
        
        // Removed "AM data loaded successfully" message to prevent bouncing
      } else {
        currentAMData = null;
        document.getElementById('pmAmTotal').textContent = 'No AM data found';
        document.getElementById('amCounterName').textContent = 'No AM data found';
        document.getElementById('amCountTime').textContent = 'No AM data found';
        const amNotesDisplay = document.getElementById('amNotesDisplay');
        if (amNotesDisplay) amNotesDisplay.style.display = 'none';
        showMessage(`No AM count found for ${date}`, 'error');
      }
    } catch (error) {
      console.error('Error loading AM data:', error);
      document.getElementById('pmAmTotal').textContent = 'Error loading AM data';
      document.getElementById('amCounterName').textContent = 'Error loading AM data';
      document.getElementById('amCountTime').textContent = 'Error loading AM data';
      showMessage(`Error: ${error.message}`, 'error');
    }
  }
  
  function collectFormData(shift) {
    const counter = document.getElementById(`${shift}Counter`).value;
    const date = document.getElementById(`${shift}Date`).value;
    const notes = document.getElementById(`${shift}Notes`).value.trim();
    
    if (!counter) throw new Error('Please select a name');
    if (!date) throw new Error('Please select a date');
    
    const drawer1Skip = document.getElementById(`${shift}Drawer1Skip`).checked;
    const drawer2Skip = document.getElementById(`${shift}Drawer2Skip`).checked;
    
    const drawer1Data = collectDrawerData(shift, 1, drawer1Skip);
    const drawer2Data = collectDrawerData(shift, 2, drawer2Skip);
    
    const data = {
      shift: shift,
      counter: counter,
      date: date,
      timestamp: new Date().toISOString(),
      drawer1: drawer1Data,
      drawer2: drawer2Data,
      drawer1Total: drawer1Data.total, // Add individual drawer totals for email template
      drawer2Total: drawer2Data.total,
      notes: notes || null,
      total: drawer1Data.total + drawer2Data.total
    };
    
    if (shift === 'pm') {
      // Use auto-calculated Toast amount (no manual override)
      const toastSales = autoCalculatedToastAmount || 0;
      const cashTips = parseInt(document.getElementById('cashTips').value) || 0;
      
      data.toastSales = toastSales;
      data.cashTips = cashTips;
      data.amTotal = currentAMData ? currentAMData.total : 0;
      
      // Always indicate auto-calculated method
      data.toastSalesMethod = 'auto_calculated';
    }
    
    return data;
  }
  
  function collectDrawerData(shift, drawer, skipped) {
    if (skipped) {
      const reason = document.getElementById(`${shift}Drawer${drawer}Reason`).value.trim();
      return {
        skipped: true,
        skipReason: reason || 'No reason provided',
        counts: {},
        total: 0
      };
    }
    
    const counts = {};
    let total = 0;
    
    // Map denomination labels to email template keys
    const denominationKeys = [
      'hundreds',    // $100
      'fifties',     // $50
      'twenties',    // $20
      'tens',        // $10
      'fives',       // $5
      'ones',        // $1
      'quarters',    // $0.25
      'dimes',       // $0.10
      'nickels',     // $0.05
      'pennies'      // $0.01
    ];
    
    DENOMINATIONS.forEach((denom, index) => {
      const qty = parseInt(document.getElementById(`${shift}D${drawer}Q${index}`).value) || 0;
      // Store with both the original label and the email template key
      counts[denom.label] = qty;
      counts[denominationKeys[index]] = qty;
      total += qty * denom.value;
    });
    
    return {
      skipped: false,
      skipReason: null,
      counts: counts,
      total: Math.round(total * 100) / 100
    };
  }
  
  async function submitAM() {
    try {
      showLoading('Submitting AM Count', 'Recording your morning cash count...');
      
      const data = collectFormData('am');
      await storeAMData(data);
      
      // Show elegant success screen
      showAMSuccess(data.total);
      resetForm('am');
      
    } catch (error) {
      hideLoading();
      console.error('AM submission error:', error);
      showMessage(`Error: ${error.message}`, 'error');
    }
  }
  
  async function submitPM() {
    try {
      showLoading('Processing PM Close', 'Calculating totals and sending report to management...');
      
      const data = collectFormData('pm');
      const calculations = calculatePMAmounts(data);
      
      await storePMData(data, calculations);
      await sendEmailReport(data, calculations);
      
      // Show elegant success screen with deposit/return instructions
      showPMSuccess(calculations.depositAmount, calculations.returnAmount, calculations.discrepancy);
      
    } catch (error) {
      hideLoading();
      console.error('PM submission error:', error);
      
      // Check if it's a validation error (these shouldn't reset the form)
      const isValidationError = error.message.includes('Please select') || 
                               error.message.includes('required') ||
                               error.message.includes('name') ||
                               error.message.includes('date');
      
      showMessage(`Error: ${error.message}`, 'error');
      
      // Only redirect home for non-validation errors (like network issues)
      if (!isValidationError) {
        goHome();
      }
    }
  }
  
  function calculatePMAmounts(data) {
    const amTotal = data.amTotal;
    const pmTotal = data.total;
    const toastSales = data.toastSales;
    const cashTips = data.cashTips;
    
    // Drawer change = PM - AM
    const drawerChange = pmTotal - amTotal;
    
    // Actual cash in
    const actualCashIn = drawerChange;
    
    // Expected vs actual (Toast sales vs actual cash in)
    const discrepancy = actualCashIn - toastSales;
    
    // Step 1: Calculate raw deposit amount
    const rawDepositAmount = toastSales + cashTips;
    
    // Step 2: Round deposit to whole dollars (what staff actually deposits)
    const depositAmount = Math.round(rawDepositAmount);
    
    // Step 3: Calculate deposit rounding adjustment needed
    const depositRoundingAdjustment = depositAmount - rawDepositAmount;
    
    // Step 4: Handle deposit rounding with whole dollar tip adjustments
    let depositTipAdjustment = 0;
    let depositExcessToCashbox = 0;
    
    if (depositRoundingAdjustment > 0) {
      // Need extra money for rounding - take whole dollars from tips
      depositTipAdjustment = Math.ceil(depositRoundingAdjustment);
      depositExcessToCashbox = depositTipAdjustment - depositRoundingAdjustment;
    } else if (depositRoundingAdjustment < 0) {
      // Deposit rounded down - staff keeps the rounding benefit
      depositExcessToCashbox = Math.abs(depositRoundingAdjustment);
    }
    
    // Step 5: Handle shortage/overage adjustments with whole dollars
    let shortageTipAdjustment = 0;
    let shortageExcessToCashbox = 0;
    
    if (discrepancy < 0) {
      // SHORTAGE: Take whole dollars from tips to cover shortage
      const shortageAmount = Math.abs(discrepancy);
      shortageTipAdjustment = Math.ceil(shortageAmount);
      shortageExcessToCashbox = shortageTipAdjustment - shortageAmount;
    }
    
    // Step 6: Calculate final tip amounts
    const totalTipAdjustment = depositTipAdjustment + shortageTipAdjustment;
    let finalCashTips = cashTips - totalTipAdjustment;
    
    // Ensure tips don't go negative
    if (finalCashTips < 0) {
      const shortfall = Math.abs(finalCashTips);
      finalCashTips = 0;
      // Add shortfall to what business owes staff (tracked but not paid)
    }
    
    // Final tips are always whole dollars (floor any remaining decimals)
    const adjustedTips = Math.floor(finalCashTips);
    const tipDecimalRemainder = finalCashTips - adjustedTips;
    
    // Step 7: Calculate return amount to cashbox
    let returnAmount = amTotal;
    
    // Add overage to cashbox
    if (discrepancy > 0) {
      returnAmount += discrepancy;
    }
    
    // Add all excess amounts to cashbox
    returnAmount += depositExcessToCashbox + shortageExcessToCashbox + tipDecimalRemainder;
    
    return {
      amTotal,
      pmTotal,
      drawerChange,
      actualCashIn,
      toastSales,
      cashTips, // Original tips reported
      discrepancy,
      tipAdjustment: totalTipAdjustment, // Total amount taken from tips
      adjustedTips, // Final whole dollar tips
      depositAmount, // Rounded deposit amount (what staff deposits)
      returnAmount, // What goes back to cashbox
      drawerOver: discrepancy > 0 ? discrepancy : 0,
      drawerShort: discrepancy < 0 ? Math.abs(discrepancy) : 0,
      restaurantOwed: toastSales, // Exact Toast sales amount
      staffOwed: adjustedTips, // Final tips after adjustment
      // New fields for tracking the logic
      rawDepositAmount, // Original exact deposit amount
      depositRoundingAdjustment, // How much rounding was needed
      depositTipAdjustment, // Whole dollars taken from tips for rounding
      depositExcessToCashbox, // Excess from deposit rounding adjustments
      shortageTipAdjustment, // Whole dollars taken from tips for shortage
      shortageExcessToCashbox, // Excess from shortage adjustments
      tipDecimalRemainder // Decimal remainder from final tip flooring
    };
  }
  
  async function storeAMData(data) {
    if (!supabase) throw new Error('Database not connected');

    const { error } = await supabase
      .from('cash_counts')
      .upsert({
        date: data.date,
        am_counter: data.counter,
        am_timestamp: data.timestamp,
        am_total: data.total,
        am_drawer1_total: data.drawer1.total,
        am_drawer1_skip: data.drawer1.skipped,
        am_drawer1_skip_reason: data.drawer1.skipReason,
        am_drawer1_data: data.drawer1.counts,
        am_drawer2_total: data.drawer2.total,
        am_drawer2_skip: data.drawer2.skipped,
        am_drawer2_skip_reason: data.drawer2.skipReason,
        am_drawer2_data: data.drawer2.counts,
        am_notes: data.notes
      }, {
        onConflict: 'date',
        ignoreDuplicates: false
      });

    if (error) throw new Error(`Database error: ${error.message}`);
  }
  
  async function storePMData(data, calculations) {
    if (!supabase) throw new Error('Database not connected');
    
    const { error } = await supabase
      .from('cash_counts')
      .update({
        pm_counter: data.counter,
        pm_timestamp: data.timestamp,
        pm_total: data.total,
        pm_cash_tips: data.cashTips,
        pm_toast_sales: data.toastSales,
        pm_drawer1_total: data.drawer1.total,
        pm_drawer1_skip: data.drawer1.skipped,
        pm_drawer1_skip_reason: data.drawer1.skipReason,
        pm_drawer1_data: data.drawer1.counts,
        pm_drawer2_total: data.drawer2.total,
        pm_drawer2_skip: data.drawer2.skipped,
        pm_drawer2_skip_reason: data.drawer2.skipReason,
        pm_drawer2_data: data.drawer2.counts,
        pm_notes: data.notes,
        pm_discrepancy: calculations.discrepancy,
        pm_adjusted_tips: calculations.adjustedTips,
        pm_drawer_over_amount: calculations.drawerOver,
        pm_deposit_amount: calculations.depositAmount,
        pm_amount_to_keep: calculations.returnAmount
      })
      .eq('date', data.date);
    
    if (error) throw new Error(`Database error: ${error.message}`);
  }
  
  async function getAMData(date) {
    if (!supabase) return null;
    
    const { data, error } = await supabase
      .from('cash_counts')
      .select('*')
      .eq('date', date)
      .single();
    
    if (error || !data || !data.am_total) return null;
    
    return {
      date: data.date,
      counter: data.am_counter,
      timestamp: data.am_timestamp,
      total: data.am_total,
      drawer1: {
        total: data.am_drawer1_total,
        skipped: data.am_drawer1_skip,
        skipReason: data.am_drawer1_skip_reason,
        counts: data.am_drawer1_data
      },
      drawer2: {
        total: data.am_drawer2_total,
        skipped: data.am_drawer2_skip,
        skipReason: data.am_drawer2_skip_reason,
        counts: data.am_drawer2_data
      },
      notes: data.am_notes
    };
  }
  
  async function sendEmailReport(data, calculations) {
    // Format date with day of the week
    const dateObj = new Date(data.date + 'T00:00:00');
    const dayOfWeek = dateObj.toLocaleDateString('en-US', { weekday: 'long' }).toUpperCase();
    const formattedDate = dateObj.toLocaleDateString('en-US', { 
      year: 'numeric', 
      month: 'long', 
      day: 'numeric' 
    }).toUpperCase();
    
    const templateParams = {
      to_email: EMAILJS_CONFIG.MANAGER_EMAIL,
      date: data.date,
      day_of_week: dayOfWeek,
      formatted_date: formattedDate,
      am_counter: currentAMData ? currentAMData.counter : 'N/A',
      counter: data.counter, // PM counter (was pm_counter)
      am_timestamp: currentAMData ? new Date(currentAMData.timestamp).toLocaleString() : 'N/A',
      pm_timestamp: new Date(data.timestamp).toLocaleString(),
      am_total: calculations.amTotal.toFixed(2),
      pm_total: calculations.pmTotal.toFixed(2),
      total_cash: calculations.pmTotal.toFixed(2), // Template expects total_cash
      drawer_change: calculations.drawerChange.toFixed(2),
      actual_cash_in: calculations.actualCashIn.toFixed(2),
      toast_sales: calculations.toastSales.toFixed(2),
      original_tips: calculations.cashTips.toFixed(2),
      discrepancy: Math.abs(calculations.discrepancy).toFixed(2),
      discrepancy_direction: calculations.discrepancy >= 0 ? 'Over' : 'Short',
      discrepancy_sign: calculations.discrepancy >= 0 ? '+' : '-',
      large_discrepancy_flag: Math.abs(calculations.discrepancy) > 10 ? ' LARGE DISCREPANCY!' : '',
      tip_adjustment: (calculations.shortageTipAdjustment || 0) > 0 ? (calculations.shortageTipAdjustment || 0).toFixed(2) : null,
      adjusted_tips: calculations.adjustedTips.toString(), // Whole dollars only
      deposit_amount: calculations.depositAmount.toString(), // Already rounded to whole dollar
      amount_to_keep: calculations.returnAmount.toFixed(2), // Template expects amount_to_keep
      return_breakdown: (calculations.returnAmount - calculations.amTotal).toFixed(2),
      drawer_over: calculations.drawerOver.toFixed(2),
      drawer_short: calculations.drawerShort.toFixed(2),
      am_notes: currentAMData ? (currentAMData.notes || '') : '',
      notes: data.notes || '', // Template expects notes (not pm_notes)
      has_discrepancy: calculations.discrepancy !== 0 ? 'true' : 'false',
      // Add drawer breakdown for comparison table
      has_am_comparison: currentAMData ? 'true' : 'false',
      am_drawer1_total: currentAMData ? currentAMData.drawer1.total.toFixed(2) : '0.00',
      am_drawer2_total: currentAMData ? currentAMData.drawer2.total.toFixed(2) : '0.00',
      pm_drawer1_total: data.drawer1Total.toFixed(2),
      pm_drawer2_total: data.drawer2Total.toFixed(2),
      am_grand_total: calculations.amTotal.toFixed(2),
      pm_grand_total: calculations.pmTotal.toFixed(2),
      // Manager breakdown fields
      restaurant_owed: calculations.toastSales.toFixed(2),
      staff_owed: calculations.adjustedTips.toString(), // Whole dollars only
      total_accounted: (calculations.toastSales + calculations.adjustedTips).toFixed(2),
      
      // Deposit rounding breakdown fields
      raw_deposit_amount: calculations.rawDepositAmount ? calculations.rawDepositAmount.toFixed(2) : null,
      deposit_rounding_adjustment: calculations.depositRoundingAdjustment ? calculations.depositRoundingAdjustment.toFixed(2) : null,
      deposit_tip_adjustment: calculations.depositTipAdjustment ? calculations.depositTipAdjustment.toFixed(2) : null,
      deposit_excess_to_cashbox: calculations.depositExcessToCashbox ? calculations.depositExcessToCashbox.toFixed(2) : null,
      has_deposit_rounding: (calculations.depositRoundingAdjustment && Math.abs(calculations.depositRoundingAdjustment) > 0) ? 'true' : 'false',
      
      // AM Drawer 1 denomination breakdown
      am_drawer1_100: currentAMData ? (currentAMData.drawer1.counts.hundreds || 0) : 0,
      am_drawer1_100_total: currentAMData ? ((currentAMData.drawer1.counts.hundreds || 0) * 100).toFixed(2) : '0.00',
      am_drawer1_50: currentAMData ? (currentAMData.drawer1.counts.fifties || 0) : 0,
      am_drawer1_50_total: currentAMData ? ((currentAMData.drawer1.counts.fifties || 0) * 50).toFixed(2) : '0.00',
      am_drawer1_20: currentAMData ? (currentAMData.drawer1.counts.twenties || 0) : 0,
      am_drawer1_20_total: currentAMData ? ((currentAMData.drawer1.counts.twenties || 0) * 20).toFixed(2) : '0.00',
      am_drawer1_10: currentAMData ? (currentAMData.drawer1.counts.tens || 0) : 0,
      am_drawer1_10_total: currentAMData ? ((currentAMData.drawer1.counts.tens || 0) * 10).toFixed(2) : '0.00',
      am_drawer1_5: currentAMData ? (currentAMData.drawer1.counts.fives || 0) : 0,
      am_drawer1_5_total: currentAMData ? ((currentAMData.drawer1.counts.fives || 0) * 5).toFixed(2) : '0.00',
      am_drawer1_1: currentAMData ? (currentAMData.drawer1.counts.ones || 0) : 0,
      am_drawer1_1_total: currentAMData ? ((currentAMData.drawer1.counts.ones || 0) * 1).toFixed(2) : '0.00',
      am_drawer1_quarter: currentAMData ? (currentAMData.drawer1.counts.quarters || 0) : 0,
      am_drawer1_quarter_total: currentAMData ? ((currentAMData.drawer1.counts.quarters || 0) * 0.25).toFixed(2) : '0.00',
      am_drawer1_dime: currentAMData ? (currentAMData.drawer1.counts.dimes || 0) : 0,
      am_drawer1_dime_total: currentAMData ? ((currentAMData.drawer1.counts.dimes || 0) * 0.10).toFixed(2) : '0.00',
      am_drawer1_nickel: currentAMData ? (currentAMData.drawer1.counts.nickels || 0) : 0,
      am_drawer1_nickel_total: currentAMData ? ((currentAMData.drawer1.counts.nickels || 0) * 0.05).toFixed(2) : '0.00',
      am_drawer1_penny: currentAMData ? (currentAMData.drawer1.counts.pennies || 0) : 0,
      am_drawer1_penny_total: currentAMData ? ((currentAMData.drawer1.counts.pennies || 0) * 0.01).toFixed(2) : '0.00',
      
      // AM Drawer 2 denomination breakdown
      am_drawer2_100: currentAMData ? (currentAMData.drawer2.counts.hundreds || 0) : 0,
      am_drawer2_100_total: currentAMData ? ((currentAMData.drawer2.counts.hundreds || 0) * 100).toFixed(2) : '0.00',
      am_drawer2_50: currentAMData ? (currentAMData.drawer2.counts.fifties || 0) : 0,
      am_drawer2_50_total: currentAMData ? ((currentAMData.drawer2.counts.fifties || 0) * 50).toFixed(2) : '0.00',
      am_drawer2_20: currentAMData ? (currentAMData.drawer2.counts.twenties || 0) : 0,
      am_drawer2_20_total: currentAMData ? ((currentAMData.drawer2.counts.twenties || 0) * 20).toFixed(2) : '0.00',
      am_drawer2_10: currentAMData ? (currentAMData.drawer2.counts.tens || 0) : 0,
      am_drawer2_10_total: currentAMData ? ((currentAMData.drawer2.counts.tens || 0) * 10).toFixed(2) : '0.00',
      am_drawer2_5: currentAMData ? (currentAMData.drawer2.counts.fives || 0) : 0,
      am_drawer2_5_total: currentAMData ? ((currentAMData.drawer2.counts.fives || 0) * 5).toFixed(2) : '0.00',
      am_drawer2_1: currentAMData ? (currentAMData.drawer2.counts.ones || 0) : 0,
      am_drawer2_1_total: currentAMData ? ((currentAMData.drawer2.counts.ones || 0) * 1).toFixed(2) : '0.00',
      am_drawer2_quarter: currentAMData ? (currentAMData.drawer2.counts.quarters || 0) : 0,
      am_drawer2_quarter_total: currentAMData ? ((currentAMData.drawer2.counts.quarters || 0) * 0.25).toFixed(2) : '0.00',
      am_drawer2_dime: currentAMData ? (currentAMData.drawer2.counts.dimes || 0) : 0,
      am_drawer2_dime_total: currentAMData ? ((currentAMData.drawer2.counts.dimes || 0) * 0.10).toFixed(2) : '0.00',
      am_drawer2_nickel: currentAMData ? (currentAMData.drawer2.counts.nickels || 0) : 0,
      am_drawer2_nickel_total: currentAMData ? ((currentAMData.drawer2.counts.nickels || 0) * 0.05).toFixed(2) : '0.00',
      am_drawer2_penny: currentAMData ? (currentAMData.drawer2.counts.pennies || 0) : 0,
      am_drawer2_penny_total: currentAMData ? ((currentAMData.drawer2.counts.pennies || 0) * 0.01).toFixed(2) : '0.00',
      
      // PM Drawer 1 denomination breakdown
      pm_drawer1_100: data.drawer1.counts.hundreds || 0,
      pm_drawer1_100_total: ((data.drawer1.counts.hundreds || 0) * 100).toFixed(2),
      pm_drawer1_50: data.drawer1.counts.fifties || 0,
      pm_drawer1_50_total: ((data.drawer1.counts.fifties || 0) * 50).toFixed(2),
      pm_drawer1_20: data.drawer1.counts.twenties || 0,
      pm_drawer1_20_total: ((data.drawer1.counts.twenties || 0) * 20).toFixed(2),
      pm_drawer1_10: data.drawer1.counts.tens || 0,
      pm_drawer1_10_total: ((data.drawer1.counts.tens || 0) * 10).toFixed(2),
      pm_drawer1_5: data.drawer1.counts.fives || 0,
      pm_drawer1_5_total: ((data.drawer1.counts.fives || 0) * 5).toFixed(2),
      pm_drawer1_1: data.drawer1.counts.ones || 0,
      pm_drawer1_1_total: ((data.drawer1.counts.ones || 0) * 1).toFixed(2),
      pm_drawer1_quarter: data.drawer1.counts.quarters || 0,
      pm_drawer1_quarter_total: ((data.drawer1.counts.quarters || 0) * 0.25).toFixed(2),
      pm_drawer1_dime: data.drawer1.counts.dimes || 0,
      pm_drawer1_dime_total: ((data.drawer1.counts.dimes || 0) * 0.10).toFixed(2),
      pm_drawer1_nickel: data.drawer1.counts.nickels || 0,
      pm_drawer1_nickel_total: ((data.drawer1.counts.nickels || 0) * 0.05).toFixed(2),
      pm_drawer1_penny: data.drawer1.counts.pennies || 0,
      pm_drawer1_penny_total: ((data.drawer1.counts.pennies || 0) * 0.01).toFixed(2),
      
      // PM Drawer 2 denomination breakdown
      pm_drawer2_100: data.drawer2.counts.hundreds || 0,
      pm_drawer2_100_total: ((data.drawer2.counts.hundreds || 0) * 100).toFixed(2),
      pm_drawer2_50: data.drawer2.counts.fifties || 0,
      pm_drawer2_50_total: ((data.drawer2.counts.fifties || 0) * 50).toFixed(2),
      pm_drawer2_20: data.drawer2.counts.twenties || 0,
      pm_drawer2_20_total: ((data.drawer2.counts.twenties || 0) * 20).toFixed(2),
      pm_drawer2_10: data.drawer2.counts.tens || 0,
      pm_drawer2_10_total: ((data.drawer2.counts.tens || 0) * 10).toFixed(2),
      pm_drawer2_5: data.drawer2.counts.fives || 0,
      pm_drawer2_5_total: ((data.drawer2.counts.fives || 0) * 5).toFixed(2),
      pm_drawer2_1: data.drawer2.counts.ones || 0,
      pm_drawer2_1_total: ((data.drawer2.counts.ones || 0) * 1).toFixed(2),
      pm_drawer2_quarter: data.drawer2.counts.quarters || 0,
      pm_drawer2_quarter_total: ((data.drawer2.counts.quarters || 0) * 0.25).toFixed(2),
      pm_drawer2_dime: data.drawer2.counts.dimes || 0,
      pm_drawer2_dime_total: ((data.drawer2.counts.dimes || 0) * 0.10).toFixed(2),
      pm_drawer2_nickel: data.drawer2.counts.nickels || 0,
      pm_drawer2_nickel_total: ((data.drawer2.counts.nickels || 0) * 0.05).toFixed(2),
      pm_drawer2_penny: data.drawer2.counts.pennies || 0,
      pm_drawer2_penny_total: ((data.drawer2.counts.pennies || 0) * 0.01).toFixed(2)
    };
    
    const response = await emailjs.send(
      EMAILJS_CONFIG.SERVICE_ID,
      EMAILJS_CONFIG.TEMPLATE_ID,
      templateParams
    );
    
    if (!response.status === 200) {
      throw new Error('Email send failed');
    }
  }
  
  async function generateReport() {
    const date = document.getElementById('reportDate').value;
    if (!date) {
      showMessage('Please select a date', 'error');
      return;
    }

    try {
      showLoading('Generating Report', 'Creating email report for management...');
      
      const amData = await getAMData(date);
      if (!amData) {
        throw new Error('No data found for this date');
      }
      
      // For report generation, we'll use stored PM data or create a basic report
      const { data: fullData } = await supabase
        .from('cash_counts')
        .select('*')
        .eq('date', date)
        .single();
      
      if (fullData && fullData.pm_total) {
        // Full day report - recalculate using the same logic as PM flow
        const reportData = {
          date: date,
          counter: fullData.pm_counter,
          total: fullData.pm_total,
          toastSales: fullData.pm_toast_sales,
          cashTips: fullData.pm_cash_tips,
          amTotal: fullData.am_total,
          notes: fullData.pm_notes
        };
        
        // Use same calculation function as PM flow for consistency
        const calculations = calculatePMAmounts({
          amTotal: fullData.am_total,
          total: fullData.pm_total,
          toastSales: fullData.pm_toast_sales,
          cashTips: fullData.pm_cash_tips
        });
        
        currentAMData = amData;
        await sendEmailReport(reportData, calculations);
      } else {
        throw new Error('Incomplete data for this date');
      }
      
      // Show elegant success screen
      showReportSuccess(date);
      
    } catch (error) {
      hideLoading();
      console.error('Report generation error:', error);
      showMessage(`Error: ${error.message}`, 'error');
    }
  }
  
  // New Report Functions
  function toggleReportType() {
    const reportType = document.querySelector('input[name="reportType"]:checked').value;
    const singleGroup = document.getElementById('singleDateGroup');
    const weeklyGroup = document.getElementById('weeklyRangeGroup');
    
    if (reportType === 'single') {
      singleGroup.style.display = 'block';
      weeklyGroup.style.display = 'none';
    } else {
      singleGroup.style.display = 'none';
      weeklyGroup.style.display = 'block';
      // Load saved weeks when weekly report is selected
      loadSavedWeeks();
    }
  }

  // Load Saved Weekly Reports for Dropdown
  async function loadSavedWeeks() {
    const dropdown = document.getElementById('savedWeeksDropdown');
    
    try {
      dropdown.innerHTML = '<option value="">Loading saved reports...</option>';
      
      if (!supabase) {
        dropdown.innerHTML = '<option value="">Database connection not available</option>';
        return;
      }

      const { data: savedReports, error } = await supabase
        .from('weekly_combined_reports')
        .select('id, week_start_date, week_end_date, generated_by, generated_at')
        .order('week_start_date', { ascending: false });

      if (error) {
        console.error('Error loading saved reports:', error);
        dropdown.innerHTML = '<option value="">Error loading reports</option>';
        return;
      }

      if (!savedReports || savedReports.length === 0) {
        dropdown.innerHTML = '<option value="">No saved weekly reports found. Generate a weekly combined report first.</option>';
        return;
      }

      // Populate dropdown with saved reports
      dropdown.innerHTML = '<option value="">Select a saved weekly report...</option>';
      
      savedReports.forEach(report => {
        const startDate = new Date(report.week_start_date).toLocaleDateString();
        const endDate = new Date(report.week_end_date).toLocaleDateString();
        const generatedDate = new Date(report.generated_at).toLocaleDateString();
        
        const option = document.createElement('option');
        option.value = report.id;
        option.textContent = `Week of ${startDate} - ${endDate} (Generated: ${generatedDate})`;
        dropdown.appendChild(option);
      });

    } catch (error) {
      console.error('Error in loadSavedWeeks:', error);
      dropdown.innerHTML = '<option value="">Error loading reports</option>';
    }
  }

  // Generate Historical Report from Database
  async function generateHistoricalReport() {
    const reportTypeElement = document.querySelector('input[name="reportType"]:checked');
    
    if (!reportTypeElement) {
      alert('Please select a report type (Daily or Weekly)');
      return;
    }
    
    const reportType = reportTypeElement.value;
    console.log('Generate Historical Report - Report type:', reportType);
    
    try {
      showLoading('Generating Historical Report', 'Retrieving data from database...');
      
      if (reportType === 'single') {
        await generateSingleDayHistoricalReport();
      } else {
        await generateWeeklyHistoricalReport();
      }
      
      hideLoading();
      showSuccessMessage('Historical report generated successfully!', 'reportsForm');
      
    } catch (error) {
      hideLoading();
      showErrorMessage('Error generating historical report: ' + error.message, 'reportsForm');
      console.error('Historical report error:', error);
    }
  }

  // Generate Single Day Historical Report
  async function generateSingleDayHistoricalReport() {
    const reportDate = document.getElementById('reportDate').value;
    
    if (!reportDate) {
      throw new Error('Please select a date for the report');
    }
    
    if (!supabase) {
      throw new Error('Database connection not available');
    }
    
    // Query for complete daily cash count data
    const { data: fullData, error: dataError } = await supabase
      .from('cash_counts')
      .select('*')
      .eq('date', reportDate)
      .single();
    
    if (dataError) {
      console.error('Database error details:', dataError);
      throw new Error(`Database query failed: ${dataError.message}`);
    }
    
    if (!fullData) {
      throw new Error(`No cash count data found for ${reportDate}. This date may not have been processed yet.`);
    }
    
    // Check if we have both AM and PM data
    if (!fullData.am_total && !fullData.pm_total) {
      throw new Error(`No AM or PM data found for ${reportDate}. This date may not have been processed yet.`);
    }
    
    // Display single day report in modal using PM flow format
    displayPMFlowSingleDayReportModal(fullData, reportDate);
  }
  
  // Display Single Day Report in Modal using PM Flow Format
  function displayPMFlowSingleDayReportModal(fullData, reportDate) {
    console.log('=== PM FLOW SINGLE DAY REPORT MODAL ===');
    
    // Generate comprehensive HTML content using PM flow format
    const reportHtml = generatePMFlowSingleDayReportHtml(fullData, reportDate);
    
    // Create modal overlay
    const overlay = document.createElement('div');
    overlay.id = 'singleDayReportOverlay';
    overlay.style.cssText = `
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      width: 100vw !important;
      height: 100vh !important;
      background: rgba(0, 0, 0, 0.8) !important;
      z-index: 99999 !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      overflow: auto !important;
    `;
    
    const contentBox = document.createElement('div');
    contentBox.style.cssText = `
      background: white !important;
      margin: 20px !important;
      padding: 0 !important;
      border-radius: 12px !important;
      max-width: 95vw !important;
      max-height: 95vh !important;
      overflow: hidden !important;
      position: relative !important;
      box-shadow: 0 8px 32px rgba(0,0,0,0.4) !important;
      display: flex !important;
      flex-direction: column !important;
    `;
    
    // Add header with controls
    const headerDiv = document.createElement('div');
    headerDiv.style.cssText = `
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%) !important;
      padding: 20px 30px !important;
      color: white !important;
      display: flex !important;
      justify-content: space-between !important;
      align-items: center !important;
      flex-shrink: 0 !important;
    `;
    
    const titleDiv = document.createElement('div');
    titleDiv.innerHTML = `
      <h2 style="margin: 0; font-size: 24px; font-weight: 600;">Daily Cash Report</h2>
      <p style="margin: 5px 0 0 0; opacity: 0.9; font-size: 16px;">${new Date(reportDate).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
    `;
    
    const controlsDiv = document.createElement('div');
    controlsDiv.style.cssText = `
      display: flex !important;
      gap: 15px !important;
      align-items: center !important;
    `;
    
    // PDF Download button
    const pdfBtn = document.createElement('button');
    pdfBtn.innerHTML = 'Download PDF';
    pdfBtn.style.cssText = `
      background: rgba(255,255,255,0.2) !important;
      color: white !important;
      border: 2px solid rgba(255,255,255,0.4) !important;
      padding: 10px 20px !important;
      border-radius: 8px !important;
      cursor: pointer !important;
      font-size: 14px !important;
      font-weight: 500 !important;
      transition: all 0.3s ease !important;
    `;
    pdfBtn.onmouseover = () => pdfBtn.style.background = 'rgba(255,255,255,0.3)';
    pdfBtn.onmouseout = () => pdfBtn.style.background = 'rgba(255,255,255,0.2)';
    pdfBtn.onclick = () => generatePMFlowSingleDayPDF(fullData, reportDate);
    
    // Close button
    const closeBtn = document.createElement('button');
    closeBtn.innerHTML = 'X';
    closeBtn.style.cssText = `
      background: rgba(255,255,255,0.2) !important;
      color: white !important;
      border: 2px solid rgba(255,255,255,0.4) !important;
      padding: 8px 12px !important;
      border-radius: 50% !important;
      cursor: pointer !important;
      font-size: 18px !important;
      font-weight: bold !important;
      width: 40px !important;
      height: 40px !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      transition: all 0.3s ease !important;
    `;
    closeBtn.onmouseover = () => closeBtn.style.background = 'rgba(255,80,80,0.8)';
    closeBtn.onmouseout = () => closeBtn.style.background = 'rgba(255,255,255,0.2)';
    closeBtn.onclick = () => document.body.removeChild(overlay);
    
    controlsDiv.appendChild(pdfBtn);
    controlsDiv.appendChild(closeBtn);
    headerDiv.appendChild(titleDiv);
    headerDiv.appendChild(controlsDiv);
    
    // Add content area
    const contentDiv = document.createElement('div');
    contentDiv.style.cssText = `
      padding: 30px !important;
      overflow: auto !important;
      flex: 1 !important;
      background: #f8f9fa !important;
    `;
    contentDiv.innerHTML = reportHtml;
    
    contentBox.appendChild(headerDiv);
    contentBox.appendChild(contentDiv);
    overlay.appendChild(contentBox);
    document.body.appendChild(overlay);
    
    console.log('PM Flow single day report modal created and displayed');
  }
  
  // Generate Enhanced Single Day Report HTML
  function generateEnhancedSingleDayReportHtml(dayData, reportDate) {
    const formattedDate = new Date(reportDate).toLocaleDateString('en-US', { 
      weekday: 'long', 
      year: 'numeric', 
      month: 'long', 
      day: 'numeric' 
    });
    
    const weekStart = new Date(dayData.weekly_combined_reports.week_start_date).toLocaleDateString();
    const weekEnd = new Date(dayData.weekly_combined_reports.week_end_date).toLocaleDateString();
    
    return `
      <div style="max-width: 1200px; margin: 0 auto; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
        
        <!-- Header Summary Cards -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px;">
          
          <!-- Date & Staff Info Card -->
          <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 0; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
            <div style="display: flex; align-items: center; margin-bottom: 15px;">
              <span style="font-size: 24px; margin-right: 10px;"></span>
              <h3 style="margin: 0; font-size: 18px; font-weight: 600;">Date & Staff</h3>
            </div>
            <div style="space-y: 8px;">
              <p style="margin: 8px 0; font-size: 16px;"><strong>Date:</strong> ${formattedDate}</p>
              <p style="margin: 8px 0; font-size: 14px;"><strong>Report Week:</strong> ${weekStart} - ${weekEnd}</p>
              <p style="margin: 8px 0; font-size: 14px;"><strong>Night Counter:</strong> ${dayData.night_counter || 'N/A'}</p>
              <p style="margin: 8px 0; font-size: 12px; opacity: 0.9;"><strong>Generated:</strong> ${new Date().toLocaleString()}</p>
            </div>
          </div>

          <!-- Cash Flow Summary Card -->
          <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 25px; border-radius: 0; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
            <div style="display: flex; align-items: center; margin-bottom: 15px;">
              <span style="font-size: 24px; margin-right: 10px;"></span>
              <h3 style="margin: 0; font-size: 18px; font-weight: 600;">Cash Flow</h3>
            </div>
            <div style="space-y: 8px;">
              <p style="margin: 8px 0; font-size: 16px;"><strong>Toast Sales:</strong> $${dayData.toast_sales?.toFixed(2) || '0.00'}</p>
              <p style="margin: 8px 0; font-size: 14px;"><strong>Actual Cash In:</strong> $${dayData.actual_cash_in?.toFixed(2) || '0.00'}</p>
              <p style="margin: 8px 0; font-size: 14px;"><strong>Discrepancy:</strong> ${dayData.discrepancy >= 0 ? '+' : ''}$${Math.abs(dayData.discrepancy || 0).toFixed(2)}</p>
              <p style="margin: 8px 0; font-size: 14px;"><strong>Excess:</strong> $${dayData.excess?.toFixed(2) || '0.00'}</p>
            </div>
          </div>

          <!-- Performance Indicators Card -->
          <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 25px; border-radius: 0; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
            <div style="display: flex; align-items: center; margin-bottom: 15px;">
              <span style="font-size: 24px; margin-right: 10px;"></span>
              <h3 style="margin: 0; font-size: 18px; font-weight: 600;">Performance</h3>
            </div>
            <div style="space-y: 8px;">
              <p style="margin: 8px 0; font-size: 14px;"><strong>Accuracy:</strong> ${Math.abs(dayData.discrepancy || 0) < 5 ? 'Excellent' : Math.abs(dayData.discrepancy || 0) < 20 ? 'Good' : 'Needs Review'}</p>
              <p style="margin: 8px 0; font-size: 14px;"><strong>Variance:</strong> ${((Math.abs(dayData.discrepancy || 0) / (dayData.toast_sales || 1)) * 100).toFixed(1)}%</p>
              <p style="margin: 8px 0; font-size: 14px;"><strong>Week Generated By:</strong> ${dayData.weekly_combined_reports.generated_by || 'N/A'}</p>
            </div>
          </div>
        </div>

        <!-- Detailed Analysis Section -->
        <div style="background: white; border-radius: 0; box-shadow: 0 4px 20px rgba(0,0,0,0.08); overflow: hidden; margin-bottom: 30px;">
          <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px;">
            <h3 style="margin: 0; font-size: 20px; font-weight: 600; display: flex; align-items: center;">
              <span style="margin-right: 10px;"></span>
              Detailed Cash Analysis
            </h3>
          </div>
          
          <div style="padding: 30px;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px;">
              
              <!-- Revenue Breakdown -->
              <div>
                <h4 style="color: #333; margin-bottom: 20px; font-size: 16px; font-weight: 600; border-bottom: 2px solid #667eea; padding-bottom: 8px;">Revenue Breakdown</h4>
                <div style="space-y: 12px;">
                  <div style="display: flex; justify-content: space-between; padding: 12px; background: #f8f9fa; border-radius: 0; border-left: 4px solid #28a745;">
                    <span style="font-weight: 500;">Toast Sales Reported</span>
                    <span style="font-weight: 600; color: #28a745;">$${dayData.toast_sales?.toFixed(2) || '0.00'}</span>
                  </div>
                  <div style="display: flex; justify-content: space-between; padding: 12px; background: #f8f9fa; border-radius: 0; border-left: 4px solid #17a2b8;">
                    <span style="font-weight: 500;">Actual Cash Collected</span>
                    <span style="font-weight: 600; color: #17a2b8;">$${dayData.actual_cash_in?.toFixed(2) || '0.00'}</span>
                  </div>
                  <div style="display: flex; justify-content: space-between; padding: 12px; background: #f8f9fa; border-radius: 0; border-left: 4px solid ${dayData.discrepancy >= 0 ? '#28a745' : '#dc3545'};">
                    <span style="font-weight: 500;">Cash Variance</span>
                    <span style="font-weight: 600; color: ${dayData.discrepancy >= 0 ? '#28a745' : '#dc3545'};">${dayData.discrepancy >= 0 ? '+' : ''}$${Math.abs(dayData.discrepancy || 0).toFixed(2)}</span>
                  </div>
                </div>
              </div>

              <!-- Operational Metrics -->
              <div>
                <h4 style="color: #333; margin-bottom: 20px; font-size: 16px; font-weight: 600; border-bottom: 2px solid #f093fb; padding-bottom: 8px;">Operational Metrics</h4>
                <div style="space-y: 12px;">
                  <div style="display: flex; justify-content: space-between; padding: 12px; background: #f8f9fa; border-radius: 0; border-left: 4px solid #6f42c1;">
                    <span style="font-weight: 500;">Cash Excess to Tips</span>
                    <span style="font-weight: 600; color: #6f42c1;">$${dayData.excess?.toFixed(2) || '0.00'}</span>
                  </div>
                  <div style="display: flex; justify-content: space-between; padding: 12px; background: #f8f9fa; border-radius: 0; border-left: 4px solid #fd7e14;">
                    <span style="font-weight: 500;">Accuracy Rate</span>
                    <span style="font-weight: 600; color: #fd7e14;">${Math.abs(dayData.discrepancy || 0) < 5 ? '98%+' : Math.abs(dayData.discrepancy || 0) < 20 ? '95%+' : '90%-'}</span>
                  </div>
                  <div style="display: flex; justify-content: space-between; padding: 12px; background: #f8f9fa; border-radius: 0; border-left: 4px solid #20c997;">
                    <span style="font-weight: 500;">Status</span>
                    <span style="font-weight: 600; color: #20c997;">${Math.abs(dayData.discrepancy || 0) < 10 ? 'Balanced' : 'Review Needed'}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Raw Data Section -->
        <div style="background: white; border-radius: 0; box-shadow: 0 4px 20px rgba(0,0,0,0.08); overflow: hidden; margin-bottom: 30px;">
          <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 20px;">
            <h3 style="margin: 0; font-size: 20px; font-weight: 600; display: flex; align-items: center;">
              <span style="margin-right: 10px;"></span>
              Complete Data Summary
            </h3>
          </div>
          
          <div style="padding: 30px;">
            <div style="overflow-x: auto;">
              <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                <thead>
                  <tr style="background: #f8f9fa;">
                    <th style="padding: 15px; text-align: left; border-bottom: 2px solid #dee2e6; font-weight: 600; color: #495057;">Field</th>
                    <th style="padding: 15px; text-align: right; border-bottom: 2px solid #dee2e6; font-weight: 600; color: #495057;">Value</th>
                    <th style="padding: 15px; text-align: left; border-bottom: 2px solid #dee2e6; font-weight: 600; color: #495057;">Description</th>
                  </tr>
                </thead>
                <tbody>
                  <tr style="border-bottom: 1px solid #dee2e6;">
                    <td style="padding: 12px; font-weight: 500;">Date</td>
                    <td style="padding: 12px; text-align: right;">${formattedDate}</td>
                    <td style="padding: 12px; color: #6c757d;">Business day for this report</td>
                  </tr>
                  <tr style="border-bottom: 1px solid #dee2e6; background: #f8f9fa;">
                    <td style="padding: 12px; font-weight: 500;">Night Counter</td>
                    <td style="padding: 12px; text-align: right;">${dayData.night_counter || 'N/A'}</td>
                    <td style="padding: 12px; color: #6c757d;">Staff member who completed closing count</td>
                  </tr>
                  <tr style="border-bottom: 1px solid #dee2e6;">
                    <td style="padding: 12px; font-weight: 500;">Toast Sales</td>
                    <td style="padding: 12px; text-align: right; color: #28a745; font-weight: 600;">$${dayData.toast_sales?.toFixed(2) || '0.00'}</td>
                    <td style="padding: 12px; color: #6c757d;">Total sales reported by POS system</td>
                  </tr>
                  <tr style="border-bottom: 1px solid #dee2e6; background: #f8f9fa;">
                    <td style="padding: 12px; font-weight: 500;">Actual Cash In</td>
                    <td style="padding: 12px; text-align: right; color: #17a2b8; font-weight: 600;">$${dayData.actual_cash_in?.toFixed(2) || '0.00'}</td>
                    <td style="padding: 12px; color: #6c757d;">Physical cash counted in registers</td>
                  </tr>
                  <tr style="border-bottom: 1px solid #dee2e6;">
                    <td style="padding: 12px; font-weight: 500;">Discrepancy</td>
                    <td style="padding: 12px; text-align: right; color: ${dayData.discrepancy >= 0 ? '#28a745' : '#dc3545'}; font-weight: 600;">${dayData.discrepancy >= 0 ? '+' : ''}$${Math.abs(dayData.discrepancy || 0).toFixed(2)}</td>
                    <td style="padding: 12px; color: #6c757d;">Difference between expected and actual cash</td>
                  </tr>
                  <tr style="border-bottom: 1px solid #dee2e6; background: #f8f9fa;">
                    <td style="padding: 12px; font-weight: 500;">Excess</td>
                    <td style="padding: 12px; text-align: right; color: #6f42c1; font-weight: 600;">$${dayData.excess?.toFixed(2) || '0.00'}</td>
                    <td style="padding: 12px; color: #6c757d;">Amount moved from tips to balance operations</td>
                  </tr>
                  <tr style="border-bottom: 1px solid #dee2e6;">
                    <td style="padding: 12px; font-weight: 500;">Week Start</td>
                    <td style="padding: 12px; text-align: right;">${weekStart}</td>
                    <td style="padding: 12px; color: #6c757d;">Start of report week containing this day</td>
                  </tr>
                  <tr style="border-bottom: 1px solid #dee2e6; background: #f8f9fa;">
                    <td style="padding: 12px; font-weight: 500;">Week End</td>
                    <td style="padding: 12px; text-align: right;">${weekEnd}</td>
                    <td style="padding: 12px; color: #6c757d;">End of report week containing this day</td>
                  </tr>
                  <tr style="border-bottom: 1px solid #dee2e6;">
                    <td style="padding: 12px; font-weight: 500;">Weekly Report By</td>
                    <td style="padding: 12px; text-align: right;">${dayData.weekly_combined_reports.generated_by || 'N/A'}</td>
                    <td style="padding: 12px; color: #6c757d;">Manager who generated the weekly report</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Notes Section -->
        <div style="background: white; border-radius: 0; box-shadow: 0 4px 20px rgba(0,0,0,0.08); overflow: hidden; margin-bottom: 20px;">
          <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 20px;">
            <h3 style="margin: 0; font-size: 20px; font-weight: 600; display: flex; align-items: center;">
              <span style="margin-right: 10px;"></span>
              Important Notes
            </h3>
          </div>
          
          <div style="padding: 30px;">
            <div style="background: #e3f2fd; border-left: 4px solid #2196f3; padding: 20px; border-radius: 0; margin-bottom: 20px;">
              <h4 style="margin: 0 0 10px 0; color: #1976d2; font-size: 16px;">Understanding the Data</h4>
              <ul style="margin: 10px 0 0 20px; color: #424242; line-height: 1.6;">
                <li><strong>Discrepancy:</strong> Shows cash over/under compared to expected sales (negative = short, positive = over)</li>
                <li><strong>Excess:</strong> Amount taken from tips to balance daily operations</li>
                <li><strong>Accuracy Rate:</strong> Calculated based on variance from expected cash amounts</li>
              </ul>
            </div>
            
            <div style="background: #f3e5f5; border-left: 4px solid #9c27b0; padding: 20px; border-radius: 0;">
              <h4 style="margin: 0 0 10px 0; color: #7b1fa2; font-size: 16px;">Performance Benchmarks</h4>
              <ul style="margin: 10px 0 0 20px; color: #424242; line-height: 1.6;">
                <li><strong>Excellent:</strong> Discrepancy under $5 (98%+ accuracy)</li>
                <li><strong>Good:</strong> Discrepancy $5-$20 (95%+ accuracy)</li>
                <li><strong>Review Needed:</strong> Discrepancy over $20 (requires attention)</li>
              </ul>
            </div>
          </div>
        </div>

        <!-- Footer -->
        <div style="text-align: center; padding: 20px; color: #6c757d; font-size: 12px; border-top: 1px solid #dee2e6;">
          <p style="margin: 0;">Report generated by Jayna Gyro Cash Counter v3.0+ | ${new Date().toLocaleString()}</p>
          <p style="margin: 5px 0 0 0;">Designed and coded by Demetri Gregorakis | demetri_gregorakis@icloud.com</p>
        </div>
      </div>
    `;
  }

  // Generate Weekly Historical Report
  async function generateWeeklyHistoricalReport() {
    const reportId = document.getElementById('savedWeeksDropdown').value;
    
    console.log('Selected report ID:', reportId);
    
    if (!reportId) {
      throw new Error('Please select a saved weekly report from the dropdown');
    }
    
    if (!supabase) {
      throw new Error('Database connection not available');
    }
    
    // Get the saved report data including the generated HTML content
    const { data: reportData, error: reportError } = await supabase
      .from('weekly_combined_reports')
      .select('*')
      .eq('id', reportId)
      .single();
    
    if (reportError) {
      console.error('Report query error:', reportError);
      throw new Error(`Failed to load report: ${reportError.message}`);
    }
    
    if (!reportData) {
      throw new Error('Report not found');
    }
    
    console.log('Retrieved report data:', reportData);
    console.log('Has cash HTML:', !!reportData.generated_cash_report_html);
    console.log('Has tip pool HTML:', !!reportData.generated_tip_pool_html);
    
    // Display the saved HTML content directly
    const reportContent = document.getElementById('reportContent');
    
    console.log('About to set report content...');
    console.log('Report data keys:', Object.keys(reportData));
    console.log('Cash HTML length:', reportData.generated_cash_report_html?.length || 0);
    console.log('Tip pool HTML length:', reportData.generated_tip_pool_html?.length || 0);
    
    if (reportData.generated_cash_report_html && reportData.generated_tip_pool_html) {
      // We have saved HTML content - display it in the main content area like tip pool results!
      const mainContentHtml = `
        <div style="max-width: 1200px; margin: 0 auto; padding: 20px;">
          <div style="background: #f8f9fa; padding: 20px; border-radius: 0; margin-bottom: 20px; border-left: 4px solid #28a745;">
            <h3 style="margin: 0 0 10px 0; color: #28a745;">Historical Report Retrieved</h3>
            <p style="margin: 0; font-size: 14px;">Report for: ${new Date(reportData.week_start_date).toLocaleDateString()} - ${new Date(reportData.week_end_date).toLocaleDateString()}</p>
            <p style="margin: 0; font-size: 14px;">Generated by: ${reportData.generated_by} on ${new Date(reportData.generated_at).toLocaleDateString()}</p>
            <div style="text-align: center; margin-top: 15px;">
              <button class="submit-btn" onclick="downloadHistoricalReportPDF('${reportData.week_start_date}', '${reportData.week_end_date}')" style="margin-right: 10px;">Download PDF</button>
              <button class="submit-btn" onclick="goHome()">Back to Menu</button>
            </div>
          </div>
          
          <div style="margin-bottom: 30px;">
            <h3 style="color: #1e3c72; margin-bottom: 15px; border-bottom: 2px solid #1e3c72; padding-bottom: 5px;">WEEKLY CASH REPORT</h3>
            ${reportData.generated_cash_report_html}
          </div>
          
          <div>
            <h3 style="color: #1e3c72; margin-bottom: 15px; border-bottom: 2px solid #1e3c72; padding-bottom: 5px;">TIP POOL DISTRIBUTION</h3>
            ${reportData.generated_tip_pool_html}
          </div>
          
          <div style="text-align: center; margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 0;">
            <button class="submit-btn" onclick="downloadHistoricalReportPDF('${reportData.week_start_date}', '${reportData.week_end_date}')" style="margin-right: 10px;">Download PDF</button>
            <button class="submit-btn" onclick="goHome()">Back to Menu</button>
          </div>
        </div>
      `;
      
      console.log('Setting main content HTML...');
      console.log('HTML length:', mainContentHtml.length);
      
      // Use the proven working method - set content and show like tip pool results
      reportContent.innerHTML = mainContentHtml;
      
      // Store the report data globally for PDF generation
      window.currentHistoricalReport = reportData;
      
      // Hide all sections and show the results (copy exact pattern from tip pool)
      hideAllSections();
      
      console.log('Looking for reportResults element...');
      const reportResultsElement = document.getElementById('reportResults');
      console.log('reportResults element found:', !!reportResultsElement);
      console.log('reportResults element:', reportResultsElement);
      
      if (reportResultsElement) {
        console.log('=== ALTERNATIVE DISPLAY METHOD ===');
        
        // NUCLEAR OPTION: Create a completely new modal-style overlay
        const overlay = document.createElement('div');
        overlay.id = 'reportOverlay';
        overlay.style.cssText = `
          position: fixed !important;
          top: 0 !important;
          left: 0 !important;
          width: 100vw !important;
          height: 100vh !important;
          background: rgba(0, 0, 0, 0.8) !important;
          z-index: 99999 !important;
          display: flex !important;
          align-items: center !important;
          justify-content: center !important;
          overflow: auto !important;
        `;
        
        const contentBox = document.createElement('div');
        contentBox.style.cssText = `
          background: white !important;
          margin: 20px !important;
          padding: 30px !important;
          border-radius: 8px !important;
          max-width: 90vw !important;
          max-height: 90vh !important;
          overflow: auto !important;
          position: relative !important;
          box-shadow: 0 4px 20px rgba(0,0,0,0.3) !important;
        `;
        
        // Add close button
        const closeBtn = document.createElement('button');
        closeBtn.innerHTML = 'X Close Report';
        closeBtn.style.cssText = `
          position: sticky !important;
          top: 0 !important;
          right: 0 !important;
          float: right !important;
          background: #dc3545 !important;
          color: white !important;
          border: none !important;
          padding: 10px 15px !important;
          border-radius: 4px !important;
          cursor: pointer !important;
          margin-bottom: 20px !important;
          font-size: 14px !important;
        `;
        closeBtn.onclick = () => document.body.removeChild(overlay);
        
        // Add PDF download button
        const downloadBtn = document.createElement('button');
        downloadBtn.innerHTML = 'Download PDF';
        downloadBtn.style.cssText = `
          position: sticky !important;
          top: 0 !important;
          right: 120px !important;
          float: right !important;
          background: #28a745 !important;
          color: white !important;
          border: none !important;
          padding: 10px 15px !important;
          border-radius: 4px !important;
          cursor: pointer !important;
          margin-bottom: 20px !important;
          margin-right: 10px !important;
          font-size: 14px !important;
        `;
        downloadBtn.onclick = () => {
          if (window.currentHistoricalReport) {
            downloadHistoricalReportPDF(window.currentHistoricalReport.week_start_date, window.currentHistoricalReport.week_end_date);
          } else {
            alert('Report data not available for PDF download');
          }
        };
        
        // Copy the content (clean it up to remove duplicate forms)
        contentBox.appendChild(closeBtn);
        contentBox.appendChild(downloadBtn);
        const contentDiv = document.createElement('div');
        
        // Clean the content - remove any tip pool forms that shouldn't be there
        let cleanContent = reportContent.innerHTML;
        
        // Remove the Weekly Combined Report section and all form elements
        cleanContent = cleanContent.replace(/<div[^>]*id="combinedReportSection"[^>]*>.*?<\/div>/gs, '');
        cleanContent = cleanContent.replace(/<div[^>]*id="tipPoolForm"[^>]*>.*?<\/div>/gs, '');
        cleanContent = cleanContent.replace(/<form[^>]*>.*?<\/form>/gs, '');
        cleanContent = cleanContent.replace(/<button[^>]*onclick="goHome\(\)"[^>]*>.*?<\/button>/gs, '');
        cleanContent = cleanContent.replace(/Weekly Combined Report[\s\S]*?Generate Combined Weekly Report/g, '');
        cleanContent = cleanContent.replace(/Download PDF Back to Menu/g, '');
        
        contentDiv.innerHTML = cleanContent;
        contentBox.appendChild(contentDiv);
        
        overlay.appendChild(contentBox);
        document.body.appendChild(overlay);
        
        console.log('Created modal overlay for report display');
        console.log('Report should be visible as modal overlay!');
        
      } else {
        console.error('reportResults element not found!');
      }
      
      console.log('Historical report content should now be visible');
      
    } else {
      // Fallback: no HTML content saved, show basic info
      const legacyContentHtml = `
        <div style="max-width: 800px; margin: 0 auto; padding: 20px;">
          <div style="background: #fff3cd; padding: 20px; border-radius: 0; border-left: 4px solid #ffc107;">
            <h3 style="margin: 0 0 10px 0; color: #856404;">Legacy Report Format</h3>
            <p style="margin: 0 0 10px 0; font-size: 14px;">This report was generated before HTML content saving was implemented.</p>
            <p style="margin: 0; font-size: 14px;"><strong>Report Details:</strong></p>
            <ul style="margin: 10px 0 0 20px;">
              <li>Week: ${new Date(reportData.week_start_date).toLocaleDateString()} - ${new Date(reportData.week_end_date).toLocaleDateString()}</li>
              <li>Generated by: ${reportData.generated_by}</li>
              <li>Generated on: ${new Date(reportData.generated_at).toLocaleDateString()}</li>
              <li>Total Tips: $${reportData.total_tips || 0}</li>
              <li>Tip Pool Total: $${reportData.tip_pool_total || 0}</li>
            </ul>
            <div style="text-align: center; margin-top: 20px;">
              <button class="submit-btn" onclick="goHome()">Back to Menu</button>
            </div>
          </div>
        </div>
      `;
      
      console.log('Setting legacy content HTML...');
      reportContent.innerHTML = legacyContentHtml;
      
      hideAllSections();
      
      console.log('Looking for reportResults element (legacy)...');
      const reportResultsElement = document.getElementById('reportResults');
      console.log('reportResults element found (legacy):', !!reportResultsElement);
      
      if (reportResultsElement) {
        console.log('=== ALTERNATIVE DISPLAY METHOD (LEGACY) ===');
        
        // NUCLEAR OPTION: Create a completely new modal-style overlay
        const overlay = document.createElement('div');
        overlay.id = 'reportOverlayLegacy';
        overlay.style.cssText = `
          position: fixed !important;
          top: 0 !important;
          left: 0 !important;
          width: 100vw !important;
          height: 100vh !important;
          background: rgba(0, 0, 0, 0.8) !important;
          z-index: 99999 !important;
          display: flex !important;
          align-items: center !important;
          justify-content: center !important;
          overflow: auto !important;
        `;
        
        const contentBox = document.createElement('div');
        contentBox.style.cssText = `
          background: white !important;
          margin: 20px !important;
          padding: 30px !important;
          border-radius: 8px !important;
          max-width: 90vw !important;
          max-height: 90vh !important;
          overflow: auto !important;
          position: relative !important;
          box-shadow: 0 4px 20px rgba(0,0,0,0.3) !important;
        `;
        
        // Add close button
        const closeBtn = document.createElement('button');
        closeBtn.innerHTML = 'X Close Report (Legacy)';
        closeBtn.style.cssText = `
          position: sticky !important;
          top: 0 !important;
          right: 0 !important;
          float: right !important;
          background: #dc3545 !important;
          color: white !important;
          border: none !important;
          padding: 10px 15px !important;
          border-radius: 4px !important;
          cursor: pointer !important;
          margin-bottom: 20px !important;
          font-size: 14px !important;
        `;
        closeBtn.onclick = () => document.body.removeChild(overlay);
        
        // Set fallback content
        contentBox.appendChild(closeBtn);
        const contentDiv = document.createElement('div');
        contentDiv.innerHTML = '<h2>Legacy Report Content</h2><p>This is the legacy path display.</p>';
        contentBox.appendChild(contentDiv);
        
        overlay.appendChild(contentBox);
        document.body.appendChild(overlay);
        
        console.log('Created modal overlay for report display (legacy)');
        
      } else {
        console.error('reportResults element not found (legacy)!');
      }
    }
  }

  // Generate PM Flow Single Day Report HTML
  function generatePMFlowSingleDayReportHtml(fullData, reportDate) {
    // Format date with day of the week
    const dateObj = new Date(reportDate + 'T00:00:00');
    const dayOfWeek = dateObj.toLocaleDateString('en-US', { weekday: 'long' }).toUpperCase();
    const formattedDate = dateObj.toLocaleDateString('en-US', { 
      year: 'numeric', 
      month: 'long', 
      day: 'numeric' 
    }).toUpperCase();
    
    // Calculate amounts using PM flow logic
    const amTotal = fullData.am_total || 0;
    const pmTotal = fullData.pm_total || 0;
    const toastSales = fullData.pm_toast_sales || 0;
    const originalTips = fullData.pm_cash_tips || 0;
    const actualCashIn = pmTotal - amTotal;
    const discrepancy = actualCashIn - toastSales;
    const discrepancySign = discrepancy >= 0 ? '+' : '-';
    const largeDiscrepancyFlag = Math.abs(discrepancy) > 10 ? ' LARGE DISCREPANCY!' : '';
    
    // Additional PM flow calculations
    const tipAdjustment = (originalTips - (fullData.pm_adjusted_tips || originalTips));
    const rawDepositAmount = fullData.pm_deposit_amount ? (toastSales + originalTips) : 0;
    const roundedDepositAmount = fullData.pm_deposit_amount || 0;
    const depositRoundingAdjustment = rawDepositAmount - roundedDepositAmount;
    const depositTipAdjustment = fullData.pm_adjusted_tips ? (originalTips - fullData.pm_adjusted_tips) : 0;
    const depositExcessToCashbox = Math.abs(depositRoundingAdjustment);
    const returnBreakdown = fullData.pm_amount_to_keep ? (fullData.pm_amount_to_keep - amTotal) : 0;
    
    // Helper function to get denomination breakdown
    function getDenominationBreakdown(drawerData, prefix) {
      if (!drawerData) return `<div style="color: #999; font-style: italic;">No data available</div>`;
      
      const counts = drawerData.counts || drawerData;
      
      return `
        <div>$100: ${counts.hundreds || 0} = $${((counts.hundreds || 0) * 100).toFixed(2)}</div>
        <div>$50: ${counts.fifties || 0} = $${((counts.fifties || 0) * 50).toFixed(2)}</div>
        <div>$20: ${counts.twenties || 0} = $${((counts.twenties || 0) * 20).toFixed(2)}</div>
        <div>$10: ${counts.tens || 0} = $${((counts.tens || 0) * 10).toFixed(2)}</div>
        <div>$5: ${counts.fives || 0} = $${((counts.fives || 0) * 5).toFixed(2)}</div>
        <div>$1: ${counts.ones || 0} = $${((counts.ones || 0) * 1).toFixed(2)}</div>
        <div>¢25: ${counts.quarters || 0} = $${((counts.quarters || 0) * 0.25).toFixed(2)}</div>
        <div>¢10: ${counts.dimes || 0} = $${((counts.dimes || 0) * 0.10).toFixed(2)}</div>
        <div>¢5: ${counts.nickels || 0} = $${((counts.nickels || 0) * 0.05).toFixed(2)}</div>
        <div>¢1: ${counts.pennies || 0} = $${((counts.pennies || 0) * 0.01).toFixed(2)}</div>
      `;
    }
    
    return `
      <div style="font-family: Arial, sans-serif; margin: 0; padding: 8px; font-size: 12px; line-height: 1.3; max-width: 800px;">
        
        <div style="text-align: center; font-weight: bold; font-size: 18px; margin-bottom: 4px; border-bottom: 2px solid #000; padding-bottom: 6px;">
          JAYNA GYRO DAILY CASH REPORT
        </div>
        
        <div style="text-align: center; font-weight: bold; font-size: 16px; margin-bottom: 12px; padding-bottom: 6px;">
          ${dayOfWeek} ${formattedDate}
        </div>

        <!-- Staff and Timing Info -->
        <div style="border: 1px solid #000; margin: 6px 0; padding: 8px;">
          <div style="display: table; width: 100%;">
            <div style="display: table-cell; width: 50%; vertical-align: top; padding: 0 6px; border-right: 1px solid #ccc;">
              <div style="display: flex; justify-content: space-between; margin: 2px 0; max-width: 180px;">
                <span style="font-weight: bold; text-align: right; padding-right: 10px;">AM Counter:</span>
                <span style="text-align: left; font-weight: bold;">${fullData.am_counter || 'N/A'}</span>
              </div>
              <div style="display: flex; justify-content: space-between; margin: 2px 0; max-width: 180px;">
                <span style="font-weight: bold; text-align: right; padding-right: 10px;">AM Time:</span>
                <span style="text-align: left; font-weight: bold;">${fullData.am_timestamp ? new Date(fullData.am_timestamp).toLocaleString() : 'N/A'}</span>
              </div>
            </div>
            <div style="display: table-cell; width: 50%; vertical-align: top; padding: 0 6px;">
              <div style="display: flex; justify-content: space-between; margin: 2px 0; max-width: 180px;">
                <span style="font-weight: bold; text-align: right; padding-right: 10px;">PM Counter:</span>
                <span style="text-align: left; font-weight: bold;">${fullData.pm_counter || 'N/A'}</span>
              </div>
              <div style="display: flex; justify-content: space-between; margin: 2px 0; max-width: 180px;">
                <span style="font-weight: bold; text-align: right; padding-right: 10px;">PM Time:</span>
                <span style="text-align: left; font-weight: bold;">${fullData.pm_timestamp ? new Date(fullData.pm_timestamp).toLocaleString() : 'N/A'}</span>
              </div>
            </div>
          </div>
        </div>

        ${amTotal > 0 ? `
        <!-- Cash Summary -->
        <div style="border: 1px solid #000; margin: 6px 0; padding: 8px;">
          <div style="font-weight: bold; font-size: 14px; text-align: center; margin-bottom: 6px; border-bottom: 1px solid #000; padding-bottom: 3px;">CASH FLOW SUMMARY</div>
          <div style="display: table; width: 100%;">
            <div style="display: table-cell; width: 50%; vertical-align: top; padding: 0 6px; border-right: 1px solid #ccc;">
              <div style="display: flex; justify-content: space-between; margin: 2px 0; max-width: 180px;">
                <span style="font-weight: bold; text-align: right; padding-right: 10px;">Starting Cash (AM):</span>
                <span style="text-align: left; font-weight: bold;">$${amTotal.toFixed(2)}</span>
              </div>
              <div style="display: flex; justify-content: space-between; margin: 2px 0; max-width: 180px;">
                <span style="font-weight: bold; text-align: right; padding-right: 10px;">Ending Cash (PM):</span>
                <span style="text-align: left; font-weight: bold;">$${pmTotal.toFixed(2)}</span>
              </div>
              <div style="display: flex; justify-content: space-between; margin: 2px 0; max-width: 180px;">
                <span style="font-weight: bold; text-align: right; padding-right: 10px;">Actual Cash In:</span>
                <span style="text-align: left; font-weight: bold;">$${actualCashIn.toFixed(2)}</span>
              </div>
            </div>
            <div style="display: table-cell; width: 50%; vertical-align: top; padding: 0 6px;">
              <div style="display: flex; justify-content: space-between; margin: 2px 0; max-width: 180px;">
                <span style="font-weight: bold; text-align: right; padding-right: 10px;">Toast Sales:</span>
                <span style="text-align: left; font-weight: bold;">$${toastSales.toFixed(2)}</span>
              </div>
              <div style="display: flex; justify-content: space-between; margin: 2px 0; max-width: 180px;">
                <span style="font-weight: bold; text-align: right; padding-right: 10px;">Original Tips:</span>
                <span style="text-align: left; font-weight: bold;">$${originalTips.toFixed(2)}</span>
              </div>
              <div style="display: flex; justify-content: space-between; margin: 2px 0; max-width: 180px;">
                <span style="font-weight: bold; text-align: right; padding-right: 10px;">Discrepancy:</span>
                <span style="text-align: left; font-weight: bold;">${discrepancySign}$${Math.abs(discrepancy).toFixed(2)}${largeDiscrepancyFlag}</span>
              </div>
            </div>
          </div>
        </div>
        ` : ''}

        ${fullData.pm_deposit_amount ? `
        <!-- Deposit Instructions -->
        <div style="background-color: #e6ffe6; border: 2px solid #000; padding: 8px; text-align: center; font-weight: bold; font-size: 13px; margin: 6px 0;">
          DEPOSIT IN ENVELOPE: $${fullData.pm_deposit_amount}
          <div style="font-size: 10px;">(Toast Sales $${toastSales.toFixed(2)} + Original Tips $${originalTips.toFixed(2)})</div>
        </div>
        <div style="background-color: #fff0e6; border: 2px solid #000; padding: 8px; text-align: center; font-weight: bold; font-size: 13px; margin: 6px 0;">
          RETURN TO CASHBOX/SAFE: $${fullData.pm_amount_to_keep ? fullData.pm_amount_to_keep.toFixed(2) : '0.00'}
        </div>
        ` : ''}

        <!-- Notes Section -->
        <div style="display: table; width: 100%; margin: 6px 0;">
          <div style="display: table-cell; width: 50%; padding: 6px; border: 1px solid #000; vertical-align: top; text-align: center; font-weight: bold; background-color: #e6f3ff;">
            <div style="font-weight: bold; text-align: center; margin-bottom: 4px;">AM NOTES</div>
            <div style="text-align: center; font-weight: bold;">
              ${fullData.am_notes || 'No AM Notes'}
            </div>
          </div>
          <div style="display: table-cell; width: 50%; padding: 6px; border: 1px solid #000; border-left: none; vertical-align: top; text-align: center; font-weight: bold; background-color: #fff8f0;">
            <div style="font-weight: bold; text-align: center; margin-bottom: 4px;">PM NOTES</div>
            <div style="text-align: center; font-weight: bold;">
              ${fullData.pm_notes || 'No PM Notes'}
            </div>
          </div>
        </div>

        <!-- Manager Breakdown -->
        <div style="border: 1px solid #000; margin: 6px 0; padding: 8px;">
          <div style="font-weight: bold; font-size: 14px; text-align: center; margin-bottom: 6px; border-bottom: 1px solid #000; padding-bottom: 3px;">MANAGER BREAKDOWN</div>
          <div style="display: table; width: 100%;">
            <div style="display: table-row;"><div style="display: table-cell; padding: 3px 6px; border-bottom: 1px dotted #ccc; font-weight: bold; width: 50%; text-align: right; padding-right: 10px;">Starting Cash Total:</div><div style="display: table-cell; padding: 3px 6px; border-bottom: 1px dotted #ccc; text-align: left; font-weight: bold; width: 50%; padding-left: 10px;">$${amTotal.toFixed(2)}</div></div>
            <div style="display: table-row;"><div style="display: table-cell; padding: 3px 6px; border-bottom: 1px dotted #ccc; font-weight: bold; width: 50%; text-align: right; padding-right: 10px;">Ending Cash Total:</div><div style="display: table-cell; padding: 3px 6px; border-bottom: 1px dotted #ccc; text-align: left; font-weight: bold; width: 50%; padding-left: 10px;">$${pmTotal.toFixed(2)}</div></div>
            <div style="display: table-row;"><div style="display: table-cell; padding: 3px 6px; border-bottom: 1px dotted #ccc; font-weight: bold; width: 50%; text-align: right; padding-right: 10px;">Actual Cash In:</div><div style="display: table-cell; padding: 3px 6px; border-bottom: 1px dotted #ccc; text-align: left; font-weight: bold; width: 50%; padding-left: 10px;">$${actualCashIn.toFixed(2)}</div></div>
            <div style="display: table-row;"><div style="display: table-cell; padding: 3px 6px; border-bottom: 1px dotted #ccc; font-weight: bold; width: 50%; text-align: right; padding-right: 10px;">Toast Sales Reported:</div><div style="display: table-cell; padding: 3px 6px; border-bottom: 1px dotted #ccc; text-align: left; font-weight: bold; width: 50%; padding-left: 10px;">$${toastSales.toFixed(2)}</div></div>
            <div style="display: table-row;"><div style="display: table-cell; padding: 3px 6px; border-bottom: 1px dotted #ccc; font-weight: bold; width: 50%; text-align: right; padding-right: 10px;">Tips Reported by Staff:</div><div style="display: table-cell; padding: 3px 6px; border-bottom: 1px dotted #ccc; text-align: left; font-weight: bold; width: 50%; padding-left: 10px;">$${originalTips.toFixed(2)}</div></div>
            <div style="display: table-row;"><div style="display: table-cell; padding: 3px 6px; border-bottom: 1px dotted #ccc; font-weight: bold; width: 50%; text-align: right; padding-right: 10px;">Discrepancy (Drawers vs Toast):</div><div style="display: table-cell; padding: 3px 6px; border-bottom: 1px dotted #ccc; text-align: left; font-weight: bold; width: 50%; padding-left: 10px;">${discrepancySign}$${Math.abs(discrepancy).toFixed(2)}</div></div>
            ${tipAdjustment > 0 ? `
            <div style="display: table-row;"><div style="display: table-cell; padding: 3px 6px; border-bottom: 1px dotted #ccc; font-weight: bold; width: 50%; text-align: right; padding-right: 10px;">Cash Tip Adjustment:</div><div style="display: table-cell; padding: 3px 6px; border-bottom: 1px dotted #ccc; text-align: left; font-weight: bold; width: 50%; padding-left: 10px;">-$${tipAdjustment.toFixed(2)}</div></div>
            ` : ''}
            ${Math.abs(depositRoundingAdjustment) > 0.001 ? `
            <div style="display: table-row; background-color: #fff3cd;"><div style="display: table-cell; padding: 3px 6px; border-bottom: 1px dotted #ccc; font-weight: bold; width: 50%; text-align: right; padding-right: 10px;">Raw Deposit Amount:</div><div style="display: table-cell; padding: 3px 6px; border-bottom: 1px dotted #ccc; text-align: left; font-weight: bold; width: 50%; padding-left: 10px;">$${rawDepositAmount.toFixed(2)}</div></div>
            <div style="display: table-row; background-color: #fff3cd;"><div style="display: table-cell; padding: 3px 6px; border-bottom: 1px dotted #ccc; font-weight: bold; width: 50%; text-align: right; padding-right: 10px;">Rounded Deposit Amount:</div><div style="display: table-cell; padding: 3px 6px; border-bottom: 1px dotted #ccc; text-align: left; font-weight: bold; width: 50%; padding-left: 10px;">$${roundedDepositAmount}</div></div>
            <div style="display: table-row; background-color: #fff3cd;"><div style="display: table-cell; padding: 3px 6px; border-bottom: 1px dotted #ccc; font-weight: bold; width: 50%; text-align: right; padding-right: 10px;">Rounding Adjustment Needed:</div><div style="display: table-cell; padding: 3px 6px; border-bottom: 1px dotted #ccc; text-align: left; font-weight: bold; width: 50%; padding-left: 10px;">$${depositRoundingAdjustment.toFixed(2)}</div></div>
            <div style="display: table-row; background-color: #fff3cd;"><div style="display: table-cell; padding: 3px 6px; border-bottom: 1px dotted #ccc; font-weight: bold; width: 50%; text-align: right; padding-right: 10px;">Taken from Tips (Whole $):</div><div style="display: table-cell; padding: 3px 6px; border-bottom: 1px dotted #ccc; text-align: left; font-weight: bold; width: 50%; padding-left: 10px;">${depositTipAdjustment > 0 ? `-$${depositTipAdjustment.toFixed(2)}` : '-$'}</div></div>
            <div style="display: table-row; background-color: #fff3cd;"><div style="display: table-cell; padding: 3px 6px; border-bottom: 1px dotted #ccc; font-weight: bold; width: 50%; text-align: right; padding-right: 10px;">Excess to Cashbox:</div><div style="display: table-cell; padding: 3px 6px; border-bottom: 1px dotted #ccc; text-align: left; font-weight: bold; width: 50%; padding-left: 10px;">+$${depositExcessToCashbox.toFixed(2)}</div></div>
            ` : ''}
            ${fullData.pm_deposit_amount ? `
            <div style="display: table-row;"><div style="display: table-cell; padding: 3px 6px; border-bottom: 1px dotted #ccc; font-weight: bold; width: 50%; text-align: right; padding-right: 10px;">Owed to Restaurant:</div><div style="display: table-cell; padding: 3px 6px; border-bottom: 1px dotted #ccc; text-align: left; font-weight: bold; width: 50%; padding-left: 10px;">$${toastSales.toFixed(2)}</div></div>
            <div style="display: table-row;"><div style="display: table-cell; padding: 3px 6px; border-bottom: 1px dotted #ccc; font-weight: bold; width: 50%; text-align: right; padding-right: 10px;">Cash Tips Owed to Staff:</div><div style="display: table-cell; padding: 3px 6px; border-bottom: 1px dotted #ccc; text-align: left; font-weight: bold; width: 50%; padding-left: 10px;">$${fullData.pm_adjusted_tips || originalTips}</div></div>
            <div style="display: table-row;"><div style="display: table-cell; padding: 3px 6px; border-bottom: 1px dotted #ccc; font-weight: bold; width: 50%; text-align: right; padding-right: 10px;">Returned to Cashbox:</div><div style="display: table-cell; padding: 3px 6px; border-bottom: 1px dotted #ccc; text-align: left; font-weight: bold; width: 50%; padding-left: 10px;">$${returnBreakdown.toFixed(2)} + AM Total</div></div>
            ` : ''}
          </div>
        </div>

        <!-- Complete Cash Count Breakdown -->
        <div style="border: 1px solid #000; margin: 6px 0; padding: 8px;">
          <div style="font-weight: bold; font-size: 14px; text-align: center; margin-bottom: 6px; border-bottom: 1px solid #000; padding-bottom: 3px;">COMPLETE CASH COUNT BREAKDOWN</div>
          <div style="display: table; width: 100%;">
            <!-- AM Counts -->
            <div style="display: table-cell; width: 50%; vertical-align: top; padding: 0 6px; border-right: 1px solid #ccc;">
              <div style="text-align: center; font-weight: bold; font-size: 10px; margin-bottom: 4px; background-color: #e6f3ff; padding: 3px;">AM COUNTS</div>
              
              <div style="font-size: 10px; line-height: 1.2;">
                <div style="font-weight: bold; text-decoration: underline; margin-bottom: 3px;">DRAWER A</div>
                ${getDenominationBreakdown(fullData.am_drawer1_data, 'am_drawer1')}
                <div style="font-weight: bold; border-top: 1px solid #000; margin-top: 3px; padding-top: 3px;">TOTAL: $${fullData.am_drawer1_total ? fullData.am_drawer1_total.toFixed(2) : '0.00'}</div>
              </div>
              
              <div style="font-size: 10px; line-height: 1.2; margin-top: 6px;">
                <div style="font-weight: bold; text-decoration: underline; margin-bottom: 3px;">DRAWER B</div>
                ${getDenominationBreakdown(fullData.am_drawer2_data, 'am_drawer2')}
                <div style="font-weight: bold; border-top: 1px solid #000; margin-top: 3px; padding-top: 3px;">TOTAL: $${fullData.am_drawer2_total ? fullData.am_drawer2_total.toFixed(2) : '0.00'}</div>
              </div>
              
              <div style="font-weight: bold; text-align: center; padding: 4px; border: 2px solid #000; margin-top: 6px; font-size: 10px; background-color: #e6f3ff;">TOTAL AM: $${amTotal.toFixed(2)}</div>
            </div>
            
            <!-- PM Counts -->
            <div style="display: table-cell; width: 50%; vertical-align: top; padding: 0 6px;">
              <div style="text-align: center; font-weight: bold; font-size: 10px; margin-bottom: 4px; background-color: #fff8f0; padding: 3px;">PM COUNTS</div>
              
              <div style="font-size: 10px; line-height: 1.2;">
                <div style="font-weight: bold; text-decoration: underline; margin-bottom: 3px;">DRAWER A</div>
                ${getDenominationBreakdown(fullData.pm_drawer1_data, 'pm_drawer1')}
                <div style="font-weight: bold; border-top: 1px solid #000; margin-top: 3px; padding-top: 3px;">TOTAL: $${fullData.pm_drawer1_total ? fullData.pm_drawer1_total.toFixed(2) : '0.00'}</div>
              </div>
              
              <div style="font-size: 10px; line-height: 1.2; margin-top: 6px;">
                <div style="font-weight: bold; text-decoration: underline; margin-bottom: 3px;">DRAWER B</div>
                ${getDenominationBreakdown(fullData.pm_drawer2_data, 'pm_drawer2')}
                <div style="font-weight: bold; border-top: 1px solid #000; margin-top: 3px; padding-top: 3px;">TOTAL: $${fullData.pm_drawer2_total ? fullData.pm_drawer2_total.toFixed(2) : '0.00'}</div>
              </div>
              
              <div style="font-weight: bold; text-align: center; padding: 4px; border: 2px solid #000; margin-top: 6px; font-size: 10px; background-color: #fff8f0;">TOTAL PM: $${pmTotal.toFixed(2)}</div>
            </div>
          </div>
        </div>
      </div>
    `;
  }

  // Generate PM Flow Single Day PDF Report
  async function generatePMFlowSingleDayPDF(fullData, reportDate) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'letter' });
    
    const pageWidth = doc.internal.pageSize.getWidth();
    const pageHeight = doc.internal.pageSize.getHeight();
    const margin = 20; // Tight margins like screenshot
    let currentY = margin + 10;
    
    // Helper function to draw bordered sections like screenshot
    function drawBorderedSection(x, y, width, height, fillColor = null) {
      doc.setDrawColor(0, 0, 0);
      doc.setLineWidth(0.5);
      if (fillColor) {
        doc.setFillColor(fillColor[0], fillColor[1], fillColor[2]);
        doc.rect(x, y, width, height, 'FD');
      } else {
        doc.rect(x, y, width, height, 'S');
      }
    }
    
    // Helper function for denomination breakdown in tight format
    function drawDenominationBreakdown(drawerData, startX, startY, width, title) {
      let y = startY + 10;
      
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(8);
      doc.text(title, startX + 3, y);
      y += 12;
      
      if (!drawerData) {
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(7);
        doc.text('(Detailed counts not available)', startX + 3, y);
        return y + 15;
      }
      
      // Handle JSON string data from database
      let counts = drawerData;
      if (typeof drawerData === 'string') {
        try {
          counts = JSON.parse(drawerData);
        } catch (e) {
          doc.setFont('helvetica', 'normal');
          doc.setFontSize(7);
          doc.text('(Detailed counts not available)', startX + 3, y);
          return y + 15;
        }
      }
      
      // Access counts property if it exists, otherwise use the object directly
      if (counts && counts.counts) {
        counts = counts.counts;
      }
      
      if (!counts || typeof counts !== 'object') {
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(7);
        doc.text('(Detailed counts not available)', startX + 3, y);
        return y + 15;
      }
      
      doc.setFont('helvetica', 'normal');
      doc.setFontSize(7);
      
      // All denominations in tight format
      const denominations = [
        { name: '$100', field: 'hundreds', value: 100 },
        { name: '$50', field: 'fifties', value: 50 },
        { name: '$20', field: 'twenties', value: 20 },
        { name: '$10', field: 'tens', value: 10 },
        { name: '$5', field: 'fives', value: 5 },
        { name: '$1', field: 'ones', value: 1 },
        { name: '¢25', field: 'quarters', value: 0.25 },
        { name: '¢10', field: 'dimes', value: 0.10 },
        { name: '¢5', field: 'nickels', value: 0.05 },
        { name: '¢1', field: 'pennies', value: 0.01 }
      ];
      
      let hasAnyData = false;
      denominations.forEach(denom => {
        const count = counts[denom.field] || 0;
        if (count > 0) {
          hasAnyData = true;
          const total = (count * denom.value).toFixed(2);
          doc.text(`${denom.name}: ${count} = $${total}`, startX + 3, y);
          y += 9;
        }
      });
      
      // If no denomination data, show fallback message
      if (!hasAnyData) {
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(7);
        doc.text('(Detailed counts not available)', startX + 3, y);
        y += 12;
      }
      
      return y;
    }
    
    // Format date
    const dateObj = new Date(reportDate + 'T00:00:00');
    const dayOfWeek = dateObj.toLocaleDateString('en-US', { weekday: 'long' }).toUpperCase();
    const formattedDate = dateObj.toLocaleDateString('en-US', { 
      year: 'numeric', 
      month: 'long', 
      day: 'numeric' 
    }).toUpperCase();
    
    // Calculate amounts
    const amTotal = fullData.am_total || 0;
    const pmTotal = fullData.pm_total || 0;
    const toastSales = fullData.pm_toast_sales || 0;
    const originalTips = fullData.pm_cash_tips || 0;
    const actualCashIn = pmTotal - amTotal;
    const discrepancy = actualCashIn - toastSales;
    const discrepancySign = discrepancy >= 0 ? '+' : '-';
    
    // Debug: Log the drawer data structure
    console.log('PDF Generation - Drawer Data Debug:');
    console.log('AM Drawer 1:', fullData.am_drawer1_data);
    console.log('AM Drawer 2:', fullData.am_drawer2_data); 
    console.log('PM Drawer 1:', fullData.pm_drawer1_data);
    console.log('PM Drawer 2:', fullData.pm_drawer2_data);
    
    const tipAdjustment = (originalTips - (fullData.pm_adjusted_tips || originalTips));
    const rawDepositAmount = fullData.pm_deposit_amount ? (toastSales + originalTips) : 0;
    const roundedDepositAmount = fullData.pm_deposit_amount || 0;
    const depositRoundingAdjustment = rawDepositAmount - roundedDepositAmount;
    const depositTipAdjustment = fullData.pm_adjusted_tips ? (originalTips - fullData.pm_adjusted_tips) : 0;
    const depositExcessToCashbox = Math.abs(depositRoundingAdjustment);
    const returnBreakdown = fullData.pm_amount_to_keep ? (fullData.pm_amount_to_keep - amTotal) : 0;
    
    // Header - exactly like screenshot
    drawBorderedSection(margin, currentY, pageWidth - 2 * margin, 25);
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(14);
    doc.text('JAYNA GYRO DAILY CASH REPORT', pageWidth / 2, currentY + 17, { align: 'center' });
    currentY += 25;
    
    // Date header - tight
    drawBorderedSection(margin, currentY, pageWidth - 2 * margin, 20);
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(12);
    doc.text(`${dayOfWeek} ${formattedDate}`, pageWidth / 2, currentY + 14, { align: 'center' });
    currentY += 20;
    
    // Staff info - tight like screenshot
    drawBorderedSection(margin, currentY, pageWidth - 2 * margin, 35);
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(8);
    
    const amTime = fullData.am_timestamp ? new Date(fullData.am_timestamp).toLocaleString() : 'N/A';
    const pmTime = fullData.pm_timestamp ? new Date(fullData.pm_timestamp).toLocaleString() : 'N/A';
    
    doc.text(`AM Counter: ${fullData.am_counter || 'N/A'}`, margin + 5, currentY + 12);
    doc.text(`AM Time: ${amTime}`, margin + 5, currentY + 24);
    doc.text(`PM Counter: ${fullData.pm_counter || 'N/A'}`, pageWidth / 2 + 5, currentY + 12);
    doc.text(`PM Time: ${pmTime}`, pageWidth / 2 + 5, currentY + 24);
    currentY += 35;
    
    // Cash Flow Summary header
    drawBorderedSection(margin, currentY, pageWidth - 2 * margin, 15);
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(10);
    doc.text('CASH FLOW SUMMARY', pageWidth / 2, currentY + 11, { align: 'center' });
    currentY += 15;
    
    // Cash flow content
    drawBorderedSection(margin, currentY, pageWidth - 2 * margin, 50);
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(8);
    
    // Left column - right aligned
    doc.text(`Starting Cash (AM): $${amTotal.toFixed(2)}`, pageWidth / 2 - 5, currentY + 12, { align: 'right' });
    doc.text(`Ending Cash (PM): $${pmTotal.toFixed(2)}`, pageWidth / 2 - 5, currentY + 24, { align: 'right' });
    doc.text(`Actual Cash In: $${actualCashIn.toFixed(2)}`, pageWidth / 2 - 5, currentY + 36, { align: 'right' });
    
    // Right column - left aligned
    doc.text(`Toast Sales: $${toastSales.toFixed(2)}`, pageWidth / 2 + 5, currentY + 12);
    doc.text(`Original Tips: $${originalTips.toFixed(2)}`, pageWidth / 2 + 5, currentY + 24);
    doc.text(`Discrepancy: ${discrepancySign}$${Math.abs(discrepancy).toFixed(2)}`, pageWidth / 2 + 5, currentY + 36);
    currentY += 50;
    
    // Deposit sections - highlighted like screenshot
    if (fullData.pm_deposit_amount) {
      drawBorderedSection(margin, currentY, pageWidth - 2 * margin, 20, [230, 255, 230]);
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(10);
      doc.text(`DEPOSIT IN ENVELOPE: $${fullData.pm_deposit_amount}`, pageWidth / 2, currentY + 14, { align: 'center' });
      currentY += 20;
      
      drawBorderedSection(margin, currentY, pageWidth - 2 * margin, 15, [255, 240, 230]);
      const returnAmount = fullData.pm_amount_to_keep ? fullData.pm_amount_to_keep.toFixed(2) : '0.00';
      doc.text(`RETURN TO CASHBOX/SAFE: $${returnAmount}`, pageWidth / 2, currentY + 11, { align: 'center' });
      currentY += 15;
    }
    
    // Notes header
    drawBorderedSection(margin, currentY, pageWidth - 2 * margin, 15);
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(8);
    doc.text('AM NOTES', margin + (pageWidth - 2 * margin) / 4, currentY + 11, { align: 'center' });
    doc.text('PM NOTES', margin + 3 * (pageWidth - 2 * margin) / 4, currentY + 11, { align: 'center' });
    currentY += 15;
    
    // Notes content
    drawBorderedSection(margin, currentY, pageWidth - 2 * margin, 25);
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(8);
    const amNotes = fullData.am_notes || 'No AM Notes';
    const pmNotes = fullData.pm_notes || 'No PM Notes';
    // Center-align notes content
    doc.text(amNotes, margin + (pageWidth - 2 * margin) / 4, currentY + 15, { align: 'center', maxWidth: (pageWidth - 2 * margin) / 2 - 10 });
    doc.text(pmNotes, margin + 3 * (pageWidth - 2 * margin) / 4, currentY + 15, { align: 'center', maxWidth: (pageWidth - 2 * margin) / 2 - 10 });
    currentY += 25;
    
    // Manager Breakdown header
    drawBorderedSection(margin, currentY, pageWidth - 2 * margin, 15);
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(10);
    doc.text('MANAGER BREAKDOWN', pageWidth / 2, currentY + 11, { align: 'center' });
    currentY += 15;
    
    // Manager breakdown items
    const managerItems = [
      ['Starting Cash Total:', `$${amTotal.toFixed(2)}`],
      ['Ending Cash Total:', `$${pmTotal.toFixed(2)}`],
      ['Actual Cash In:', `$${actualCashIn.toFixed(2)}`],
      ['Toast Sales Reported:', `$${toastSales.toFixed(2)}`],
      ['Tips Reported by Staff:', `$${originalTips.toFixed(2)}`],
      ['Discrepancy (Drawers vs Toast):', `${discrepancySign}$${Math.abs(discrepancy).toFixed(2)}`]
    ];
    
    if (tipAdjustment > 0) {
      managerItems.push(['Cash Tip Adjustment:', `-$${tipAdjustment.toFixed(2)}`]);
    }
    
    if (Math.abs(depositRoundingAdjustment) > 0.001) {
      managerItems.push(
        ['Raw Deposit Amount:', `$${rawDepositAmount.toFixed(2)}`],
        ['Rounded Deposit Amount:', `$${roundedDepositAmount}`],
        ['Rounding Adjustment Needed:', `$${depositRoundingAdjustment.toFixed(2)}`],
        ['Taken from Tips (Whole $):', depositTipAdjustment > 0 ? `-$${depositTipAdjustment.toFixed(2)}` : '-$'],
        ['Excess to Cashbox:', `+$${depositExcessToCashbox.toFixed(2)}`]
      );
    }
    
    if (fullData.pm_deposit_amount) {
      managerItems.push(
        ['Owed to Restaurant:', `$${toastSales.toFixed(2)}`],
        ['Cash Tips Owed to Staff:', `$${fullData.pm_adjusted_tips || originalTips}`],
        ['Returned to Cashbox:', `$${returnBreakdown.toFixed(2)} + AM Total`]
      );
    }
    
    const managerHeight = managerItems.length * 10 + 15;
    drawBorderedSection(margin, currentY, pageWidth - 2 * margin, managerHeight);
    
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(8);
    let managerY = currentY + 12;
    
    // Calculate center point with small gap
    const centerPoint = pageWidth / 2;
    const gapSize = 5; // Small gap between label and value
    
    managerItems.forEach(([label, value]) => {
      // Right-align labels to center minus gap
      doc.text(label, centerPoint - gapSize, managerY, { align: 'right' });
      // Left-align values from center plus gap
      doc.text(value, centerPoint + gapSize, managerY);
      managerY += 10;
    });
    
    currentY += managerHeight;
    
    // Complete Cash Count Breakdown header
    drawBorderedSection(margin, currentY, pageWidth - 2 * margin, 15);
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(10);
    doc.text('COMPLETE CASH COUNT BREAKDOWN', pageWidth / 2, currentY + 11, { align: 'center' });
    currentY += 15;
    
    // AM/PM headers
    drawBorderedSection(margin, currentY, pageWidth - 2 * margin, 15);
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(9);
    doc.text('AM COUNTS', margin + (pageWidth - 2 * margin) / 4, currentY + 11, { align: 'center' });
    doc.text('PM COUNTS', margin + 3 * (pageWidth - 2 * margin) / 4, currentY + 11, { align: 'center' });
    currentY += 15;
    
    // Calculate dynamic breakdown section height
    const halfWidth = (pageWidth - 2 * margin) / 2;
    
    // First, calculate the content without drawing to get the height
    let tempY = currentY + 10;
    let amY1 = tempY + 25; // Estimate for Drawer 1 start
    let pmY1 = tempY + 25;
    
    // Estimate heights based on data availability
    const estimateDrawerHeight = (drawerData) => {
      if (!drawerData) return 25;
      let count = 0;
      
      // Parse and count denominations
      let counts = drawerData;
      if (typeof drawerData === 'string') {
        try { counts = JSON.parse(drawerData); } catch (e) { return 25; }
      }
      if (counts && counts.counts) counts = counts.counts;
      if (!counts) return 25;
      
      const denominations = ['hundreds', 'fifties', 'twenties', 'tens', 'fives', 'ones', 'quarters', 'dimes', 'nickels', 'pennies'];
      denominations.forEach(field => { if ((counts[field] || 0) > 0) count++; });
      
      return Math.max(25, count * 9 + 20); // 9px per line + header
    };
    
    const am1Height = estimateDrawerHeight(fullData.am_drawer1_data);
    const pm1Height = estimateDrawerHeight(fullData.pm_drawer1_data);
    const am2Height = estimateDrawerHeight(fullData.am_drawer2_data);
    const pm2Height = estimateDrawerHeight(fullData.pm_drawer2_data);
    
    const drawer1MaxHeight = Math.max(am1Height, pm1Height);
    const drawer2MaxHeight = Math.max(am2Height, pm2Height);
    const breakdownHeight = drawer1MaxHeight + drawer2MaxHeight + 40; // Extra padding
    
    // Now draw the actual section
    drawBorderedSection(margin, currentY, pageWidth - 2 * margin, breakdownHeight);
    
    // Draw vertical divider
    doc.setDrawColor(0, 0, 0);
    doc.setLineWidth(0.5);
    doc.line(margin + halfWidth, currentY, margin + halfWidth, currentY + breakdownHeight);
    
    // Drawer 1 breakdowns
    let amY1Actual = drawDenominationBreakdown(fullData.am_drawer1_data, margin, currentY, halfWidth, 'DRAWER 1');
    let pmY1Actual = drawDenominationBreakdown(fullData.pm_drawer1_data, margin + halfWidth, currentY, halfWidth, 'DRAWER 1');
    
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(8);
    doc.text(`TOTAL: $${fullData.am_drawer1_total ? fullData.am_drawer1_total.toFixed(2) : '0.00'}`, margin + 3, amY1Actual + 8);
    doc.text(`TOTAL: $${fullData.pm_drawer1_total ? fullData.pm_drawer1_total.toFixed(2) : '0.00'}`, margin + halfWidth + 3, pmY1Actual + 8);
    
    let drawerMidY = Math.max(amY1Actual, pmY1Actual) + 18;
    
    // Drawer 2 breakdowns
    let amY2Actual = drawDenominationBreakdown(fullData.am_drawer2_data, margin, drawerMidY, halfWidth, 'DRAWER 2');
    let pmY2Actual = drawDenominationBreakdown(fullData.pm_drawer2_data, margin + halfWidth, drawerMidY, halfWidth, 'DRAWER 2');
    
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(8);
    doc.text(`TOTAL: $${fullData.am_drawer2_total ? fullData.am_drawer2_total.toFixed(2) : '0.00'}`, margin + 3, amY2Actual + 8);
    doc.text(`TOTAL: $${fullData.pm_drawer2_total ? fullData.pm_drawer2_total.toFixed(2) : '0.00'}`, margin + halfWidth + 3, pmY2Actual + 8);
    
    currentY += breakdownHeight;
    
    // Final totals - highlighted like screenshot
    drawBorderedSection(margin, currentY, halfWidth, 20, [230, 243, 255]);
    drawBorderedSection(margin + halfWidth, currentY, halfWidth, 20, [255, 248, 240]);
    
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(10);
    doc.text(`TOTAL AM: $${amTotal.toFixed(2)}`, margin + halfWidth / 2, currentY + 14, { align: 'center' });
    doc.text(`TOTAL PM: $${pmTotal.toFixed(2)}`, margin + halfWidth + halfWidth / 2, currentY + 14, { align: 'center' });
    
    // Save PDF
    const fileName = `Jayna_Gyro_Daily_Report_${reportDate}.pdf`;
    doc.save(fileName);
  }

  // Generate Single Day PDF Report
  async function generateSingleDayPDF(dayData, reportDate) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'letter' });
    
    const pageWidth = doc.internal.pageSize.getWidth();
    const pageHeight = doc.internal.pageSize.getHeight();
    const margin = 40;
    let currentY = margin;
    
    // Helper function to check for page break and add new page if needed
    function checkPageBreak(requiredSpace) {
      if (currentY + requiredSpace > pageHeight - margin) {
        doc.addPage();
        currentY = margin;
        return true;
      }
      return false;
    }
    
    // Helper function to add a colored section header
    function addSectionHeader(title, color = [102, 126, 234]) {
      checkPageBreak(35);
      doc.setFillColor(color[0], color[1], color[2]);
      doc.rect(margin, currentY, pageWidth - 2 * margin, 25, 'F');
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(12);
      doc.setTextColor(255, 255, 255);
      doc.text(title, margin + 10, currentY + 16);
      currentY += 35;
      doc.setTextColor(0, 0, 0); // Reset text color
    }
    
    // Header with enhanced styling
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(20);
    doc.setTextColor(50, 50, 50);
    doc.text('JAYNA GYRO DAILY REPORT', margin, currentY);
    
    currentY += 30;
    const formattedDate = new Date(reportDate).toLocaleDateString('en-US', { 
      weekday: 'long', 
      year: 'numeric', 
      month: 'long', 
      day: 'numeric' 
    });
    
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(14);
    doc.setTextColor(102, 126, 234);
    doc.text(`${formattedDate.toUpperCase()}`, margin, currentY);
    
    currentY += 20;
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(9);
    doc.setTextColor(100, 100, 100);
    doc.text(`Generated: ${new Date().toLocaleString().toUpperCase()}`, margin, currentY);
    doc.text(`Night Counter: ${(dayData.night_counter || 'N/A').toUpperCase()}`, margin, currentY + 12);
    
    currentY += 35;
    
    // Summary Cards Section
    addSectionHeader('FINANCIAL SUMMARY', [102, 126, 234]);
    
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(10);
    
    const summaryData = [
      ['TOAST SALES REPORTED:', `$${dayData.toast_sales?.toFixed(2) || '0.00'}`, [40, 167, 69]],
      ['ACTUAL CASH COLLECTED:', `$${dayData.actual_cash_in?.toFixed(2) || '0.00'}`, [23, 162, 184]],
      ['CASH DISCREPANCY:', `${dayData.discrepancy >= 0 ? '+' : ''}$${Math.abs(dayData.discrepancy || 0).toFixed(2)}`, dayData.discrepancy >= 0 ? [40, 167, 69] : [220, 53, 69]],
      ['EXCESS TO TIPS:', `$${dayData.excess?.toFixed(2) || '0.00'}`, [111, 66, 193]]
    ];
    
    summaryData.forEach((row, index) => {
      checkPageBreak(20);
      
      // Background color for alternating rows
      if (index % 2 === 0) {
        doc.setFillColor(248, 249, 250);
        doc.rect(margin, currentY - 5, pageWidth - 2 * margin, 18, 'F');
      }
      
      doc.setFont('helvetica', 'bold');
      doc.setTextColor(73, 80, 87);
      doc.text(row[0], margin + 10, currentY + 8);
      
      doc.setFont('helvetica', 'bold');
      doc.setTextColor(row[2][0], row[2][1], row[2][2]);
      const valueWidth = doc.getTextWidth(row[1]);
      doc.text(row[1], pageWidth - margin - valueWidth - 10, currentY + 8);
      
      currentY += 18;
    });
    
    currentY += 20;
    
    // Performance Analysis Section
    addSectionHeader('PERFORMANCE ANALYSIS', [240, 147, 251]);
    
    const variance = ((Math.abs(dayData.discrepancy || 0) / (dayData.toast_sales || 1)) * 100);
    const accuracyStatus = Math.abs(dayData.discrepancy || 0) < 5 ? 'EXCELLENT (98%+)' : 
                          Math.abs(dayData.discrepancy || 0) < 20 ? 'GOOD (95%+)' : 
                          'NEEDS REVIEW (90%-)';
    const statusColor = Math.abs(dayData.discrepancy || 0) < 5 ? [40, 167, 69] : 
                       Math.abs(dayData.discrepancy || 0) < 20 ? [255, 193, 7] : 
                       [220, 53, 69];
    
    const performanceData = [
      ['ACCURACY RATING:', accuracyStatus, statusColor],
      ['VARIANCE PERCENTAGE:', `${variance.toFixed(2)}%`, [108, 117, 125]],
      ['OPERATIONAL STATUS:', Math.abs(dayData.discrepancy || 0) < 10 ? 'BALANCED' : 'REVIEW NEEDED', Math.abs(dayData.discrepancy || 0) < 10 ? [40, 167, 69] : [255, 193, 7]]
    ];
    
    performanceData.forEach((row, index) => {
      checkPageBreak(20);
      
      if (index % 2 === 0) {
        doc.setFillColor(248, 249, 250);
        doc.rect(margin, currentY - 5, pageWidth - 2 * margin, 18, 'F');
      }
      
      doc.setFont('helvetica', 'bold');
      doc.setTextColor(73, 80, 87);
      doc.text(row[0], margin + 10, currentY + 8);
      
      doc.setFont('helvetica', 'bold');
      doc.setTextColor(row[2][0], row[2][1], row[2][2]);
      const valueWidth = doc.getTextWidth(row[1]);
      doc.text(row[1], pageWidth - margin - valueWidth - 10, currentY + 8);
      
      currentY += 18;
    });
    
    currentY += 20;
    
    // Detailed Data Table Section
    addSectionHeader('COMPLETE DATA SUMMARY', [79, 172, 254]);
    
    const weekStart = new Date(dayData.weekly_combined_reports.week_start_date).toLocaleDateString();
    const weekEnd = new Date(dayData.weekly_combined_reports.week_end_date).toLocaleDateString();
    
    const detailedData = [
      ['Report Date:', formattedDate],
      ['Night Counter:', dayData.night_counter || 'N/A'],
      ['Toast Sales:', `$${dayData.toast_sales?.toFixed(2) || '0.00'}`],
      ['Actual Cash In:', `$${dayData.actual_cash_in?.toFixed(2) || '0.00'}`],
      ['Discrepancy:', `${dayData.discrepancy >= 0 ? '+' : ''}$${Math.abs(dayData.discrepancy || 0).toFixed(2)}`],
      ['Excess Amount:', `$${dayData.excess?.toFixed(2) || '0.00'}`],
      ['Report Week:', `${weekStart} - ${weekEnd}`],
      ['Weekly Report By:', dayData.weekly_combined_reports.generated_by || 'N/A']
    ];
    
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(9);
    doc.setTextColor(80, 80, 80);
    
    // Table headers
    checkPageBreak(25);
    doc.setFillColor(52, 58, 64);
    doc.rect(margin, currentY, (pageWidth - 2 * margin) * 0.6, 20, 'F');
    doc.rect(margin + (pageWidth - 2 * margin) * 0.6, currentY, (pageWidth - 2 * margin) * 0.4, 20, 'F');
    
    doc.setTextColor(255, 255, 255);
    doc.text('FIELD', margin + 10, currentY + 13);
    doc.text('VALUE', margin + (pageWidth - 2 * margin) * 0.6 + 10, currentY + 13);
    currentY += 20;
    
    // Table data
    detailedData.forEach((row, index) => {
      checkPageBreak(18);
      
      // Alternating row colors
      const bgColor = index % 2 === 0 ? [248, 249, 250] : [255, 255, 255];
      doc.setFillColor(bgColor[0], bgColor[1], bgColor[2]);
      doc.rect(margin, currentY, pageWidth - 2 * margin, 18, 'F');
      
      // Border lines
      doc.setDrawColor(222, 226, 230);
      doc.setLineWidth(0.5);
      doc.line(margin, currentY + 18, pageWidth - margin, currentY + 18);
      doc.line(margin + (pageWidth - 2 * margin) * 0.6, currentY, margin + (pageWidth - 2 * margin) * 0.6, currentY + 18);
      
      doc.setFont('helvetica', 'bold');
      doc.setTextColor(73, 80, 87);
      doc.text(row[0], margin + 10, currentY + 12);
      
      doc.setFont('helvetica', 'normal');
      doc.setTextColor(33, 37, 41);
      doc.text(row[1], margin + (pageWidth - 2 * margin) * 0.6 + 10, currentY + 12);
      
      currentY += 18;
    });
    
    currentY += 30;
    
    // Performance Benchmarks Section
    addSectionHeader('PERFORMANCE BENCHMARKS', [255, 112, 67]);
    
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(9);
    doc.setTextColor(73, 80, 87);
    
    const benchmarks = [
      '• EXCELLENT: Discrepancy under $5.00 (98%+ accuracy)',
      '• GOOD: Discrepancy $5.00-$20.00 (95%+ accuracy)', 
      '• REVIEW NEEDED: Discrepancy over $20.00 (requires management attention)',
      '',
      '• DISCREPANCY: Difference between expected and actual cash (negative = short, positive = over)',
      '• EXCESS: Amount taken from tips to balance daily operations and account for variances'
    ];
    
    benchmarks.forEach(benchmark => {
      checkPageBreak(15);
      doc.text(benchmark, margin + 10, currentY);
      currentY += 15;
    });
    
    // Footer
    if (currentY < pageHeight - 100) {
      currentY = pageHeight - 80;
    } else {
      checkPageBreak(80);
    }
    
    doc.setDrawColor(222, 226, 230);
    doc.setLineWidth(1);
    doc.line(margin, currentY, pageWidth - margin, currentY);
    currentY += 15;
    
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(8);
    doc.setTextColor(73, 80, 87);
    const creditText = 'Jayna Gyro Cash Counter v3.0+ | Report Generation App';
    const emailText = 'Designed and coded by Demetri Gregorakis | demetri_gregorakis@icloud.com';
    
    const creditWidth = doc.getTextWidth(creditText);
    const emailWidth = doc.getTextWidth(emailText);
    const centerXCredit = (pageWidth - creditWidth) / 2;
    const centerXEmail = (pageWidth - emailWidth) / 2;
    
    doc.text(creditText, centerXCredit, currentY);
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(7);
    doc.setTextColor(108, 117, 125);
    doc.text(emailText, centerXEmail, currentY + 12);
    
    // Save PDF with enhanced filename
    const filename = `Jayna_Daily_Report_${reportDate.replace(/-/g, '_')}_Enhanced.pdf`;
    doc.save(filename);
  }

  // Generate Weekly Historical PDF Report
  async function generateWeeklyHistoricalPDF(weeklyData, startDate, endDate) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'letter' });
    
    const pageWidth = doc.internal.pageSize.getWidth();
    const margin = 40;
    let currentY = margin;
    
    // Header
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(16);
    doc.setTextColor(0, 0, 0);
    doc.text('JAYNA GYRO HISTORICAL WEEKLY REPORT', margin, currentY + 12);
    
    currentY += 30;
    doc.setFontSize(9);
    doc.setFont('helvetica', 'normal');
    const dateRange = `${startDate.toUpperCase()} TO ${endDate.toUpperCase()}`;
    doc.text(`WEEK OF: ${dateRange}`, margin, currentY);
    doc.text(`GENERATED BY: ${(weeklyData.generated_by || 'N/A').toUpperCase()}`, margin, currentY + 12);
    doc.text(`GENERATED: ${new Date().toLocaleString().toUpperCase()}`, margin, currentY + 24);
    
    // Summary section
    currentY += 50;
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(12);
    doc.text('WEEKLY SUMMARY', margin, currentY);
    
    currentY += 20;
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(9);
    
    // Build summary lines with voided tips breakdown if applicable
    const summaryLines = [
      `TOAST CASH SALES REPORTED: $${weeklyData.total_toast_sales.toFixed(2)}`,
      `ACTUAL CASH IN: $${weeklyData.actual_cash_in.toFixed(2)}`,
      `TOTAL DISCREPANCY: $${weeklyData.total_discrepancy.toFixed(2)}`,
      `ENVELOPE DEPOSITS: $${weeklyData.envelope_deposits.toFixed(2)}`
    ];

    // Add credit tips breakdown if voided tips exist
    if (tipPoolSummary.voidedTipsTotal && tipPoolSummary.voidedTipsTotal > 0) {
      summaryLines.push(`CREDIT TIPS (GROSS): $${tipPoolSummary.creditTipsGross.toFixed(2)}`);
      summaryLines.push(`  - VOIDED TIPS: -$${tipPoolSummary.voidedTipsTotal.toFixed(2)}`);
      summaryLines.push(`CREDIT TIPS (NET): $${weeklyData.credit_tips.toFixed(2)}`);
    } else {
      summaryLines.push(`CREDIT TIPS: $${weeklyData.credit_tips.toFixed(2)}`);
    }

    summaryLines.push(
      `CASH TIPS: $${weeklyData.cash_tips.toFixed(2)}`,
      `EZCATER TIPS: $${weeklyData.ezcater_tips.toFixed(2)}`,
      `TOTAL TIPS: $${weeklyData.total_tips.toFixed(2)}`,
      `TDS DRIVER: $${weeklyData.tds_driver_tips.toFixed(2)}`,
      `TIP POOL TOTAL (MINUS TDS): $${weeklyData.tip_pool_total.toFixed(2)}`,
      `HOURLY RATE: $${weeklyData.hourly_rate.toFixed(2)}`,
      `CASH NEEDED: $${weeklyData.cash_needed.toFixed(2)}`
    );
    
    summaryLines.forEach((line, index) => {
      if (index % 2 === 0) {
        doc.text(line, margin, currentY + Math.floor(index / 2) * 15);
      } else {
        doc.text(line, margin + 280, currentY + Math.floor(index / 2) * 15);
      }
    });
    
    // Employee tips table
    if (weeklyData.weekly_employee_tips && weeklyData.weekly_employee_tips.length > 0) {
      currentY += Math.ceil(summaryLines.length / 2) * 15 + 30;
      
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(12);
      doc.text('EMPLOYEE TIP DISTRIBUTION', margin, currentY);
      
      currentY += 20;
      
      const employeeTableData = weeklyData.weekly_employee_tips.map(emp => [
        `${emp.employee_first_name} ${emp.employee_last_name}`,
        emp.hours_worked.toFixed(1),
        emp.equity_percentage.toFixed(0),
        emp.weighted_hours.toFixed(1),
        `$${emp.tips_due.toFixed(2)}`
      ]);
      
      doc.autoTable({
        head: [['EMPLOYEE', 'HOURS', 'EQUITY (%)', 'WEIGHTED', 'DUE']],
        body: employeeTableData,
        startY: currentY,
        margin: { left: margin, right: margin },
        styles: { font: 'helvetica', fontSize: 8, textColor: [0, 0, 0] },
        headStyles: { font: 'helvetica', fontStyle: 'bold', fillColor: [245, 245, 245] }
      });
      
      currentY = doc.autoTable.previous.finalY + 20;
    }
    
    // Daily breakdown table
    if (weeklyData.weekly_daily_breakdown && weeklyData.weekly_daily_breakdown.length > 0) {
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(12);
      doc.text('DAILY CASH BREAKDOWN', margin, currentY);
      
      currentY += 15;
      doc.setFont('helvetica', 'normal');
      doc.setFontSize(8);
      doc.text(`* Only showing ${weeklyData.weekly_daily_breakdown.length} days with PM cash count data`, margin, currentY);
      
      currentY += 15;
      
      // Filter and format the data better
      const dailyTableData = weeklyData.weekly_daily_breakdown
        .filter(day => day.toast_sales > 0 || day.actual_cash_in > 0) // Only show days with actual data
        .map(day => [
          day.date,
          day.night_counter || 'N/A',
          day.toast_sales > 0 ? `$${day.toast_sales.toFixed(2)}` : 'No Data',
          day.actual_cash_in > 0 ? `$${day.actual_cash_in.toFixed(2)}` : 'No Data', 
          Math.abs(day.discrepancy) > 0.01 ? `${day.discrepancy >= 0 ? '+' : ''}$${day.discrepancy.toFixed(2)}` : '$0.00',
          day.excess > 0 ? `$${day.excess.toFixed(2)}` : '$0.00'
        ]);
      
      doc.autoTable({
        head: [['DATE', 'NIGHT COUNTER', 'TOAST SALES', 'ACTUAL CASH IN', 'DISCREPANCY', 'EXCESS']],
        body: dailyTableData,
        startY: currentY,
        margin: { left: margin, right: margin },
        styles: { font: 'helvetica', fontSize: 7, textColor: [0, 0, 0] },
        headStyles: { font: 'helvetica', fontStyle: 'bold', fillColor: [245, 245, 245] },
        didParseCell: function(data) {
          // Color discrepancy column
          if (data.column.index === 4 && data.row.index < dailyTableData.length) {
            const cellValue = data.cell.text[0];
            if (cellValue && cellValue.includes('-')) {
              data.cell.styles.textColor = [139, 69, 19]; // Dark red
              data.cell.styles.fontStyle = 'italic';
            } else if (cellValue && cellValue.includes('+')) {
              data.cell.styles.textColor = [34, 139, 34]; // Dark green
            }
          }
        }
      });
    }
    
    // Save PDF
    const filename = `Historical_Weekly_Report_${startDate.replace(/-/g, '_')}_to_${endDate.replace(/-/g, '_')}.pdf`;
    doc.save(filename);
  }
  
  async function generateAndDownloadReport() {
    const reportType = document.querySelector('input[name="reportType"]:checked').value;
    
    try {
      showLoading('Generating PDF Report', 'Creating your report...');
      
      if (reportType === 'single') {
        await generateSingleDayPDF();
      } else {
        await generateDateRangePDF();
      }
      
      hideLoading();
      showPDFSuccessMessage();
      
    } catch (error) {
      hideLoading();
      console.error('Report generation error:', error);
      showMessage(`Error: ${error.message}`, 'error');
    }
  }
  
  function showPDFSuccessMessage() {
    const modalHTML = `
      <div id="pdfSuccessModal" style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.7);
        z-index: 10000;
        display: flex;
        justify-content: center;
        align-items: center;
      ">
        <div style="
          background: white;
          padding: 40px;
          border-radius: 0;
          text-align: center;
          max-width: 400px;
          width: 90%;
          box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        ">
          <div style="font-size: 48px; margin-bottom: 20px;"></div>
          <h2 style="color: #28a745; margin-bottom: 15px; font-size: 24px;">PDF Downloaded Successfully!</h2>
          <p style="color: #666; margin-bottom: 30px; font-size: 16px;">Your cash report has been generated and downloaded.</p>
          <button onclick="closePDFSuccessModal(); goHome();" style="
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 16px;
            border-radius: 0;
            cursor: pointer;
            margin-right: 10px;
          ">Return to Menu</button>
          <button onclick="closePDFSuccessModal();" style="
            background: #6c757d;
            color: white;
            border: none;
            padding: 12px 20px;
            font-size: 16px;
            border-radius: 0;
            cursor: pointer;
          ">Stay Here</button>
        </div>
      </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
  }
  
  function closePDFSuccessModal() {
    const modal = document.getElementById('pdfSuccessModal');
    if (modal) {
      modal.remove();
    }
  }

  function showTipPoolSuccessMessage() {
    const modalHTML = `
      <div id="tipPoolSuccessModal" style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.7);
        z-index: 10000;
        display: flex;
        justify-content: center;
        align-items: center;
      ">
        <div style="
          background: white;
          padding: 40px;
          border-radius: 0;
          text-align: center;
          max-width: 400px;
          width: 90%;
          box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        ">
          <div style="font-size: 48px; margin-bottom: 20px;"></div>
          <h2 style="color: #28a745; margin-bottom: 15px; font-size: 24px;">Tip Pool PDF Downloaded Successfully!</h2>
          <p style="color: #666; margin-bottom: 30px; font-size: 16px;">Your tip pool distribution report has been generated and downloaded.</p>
          <button onclick="closeTipPoolSuccessModal(); goHome();" style="
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 16px;
            border-radius: 0;
            cursor: pointer;
            margin-right: 10px;
          ">Return to Menu</button>
          <button onclick="closeTipPoolSuccessModal();" style="
            background: #6c757d;
            color: white;
            border: none;
            padding: 12px 20px;
            font-size: 16px;
            border-radius: 0;
            cursor: pointer;
          ">Stay Here</button>
        </div>
      </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
  }
  
  function closeTipPoolSuccessModal() {
    const modal = document.getElementById('tipPoolSuccessModal');
    if (modal) {
      modal.remove();
    }
  }
  
  async function generateSingleDayPDF() {
    const date = document.getElementById('reportDate').value;
    console.log('generateSingleDayPDF called with date:', date);
    
    if (!date) {
      throw new Error('Please select a date');
    }
    
    console.log('Getting AM data for date:', date);
    const amData = await getAMData(date);
    console.log('AM data retrieved:', amData);
    
    if (!amData) {
      throw new Error('No AM data found for this date');
    }
    
    console.log('Getting PM data for date:', date);
    const { data: fullData, error } = await supabase
      .from('cash_counts')
      .select('*')
      .eq('date', date)
      .single();
    
    console.log('PM data retrieved:', fullData, 'Error:', error);
    
    if (!fullData || !fullData.pm_total) {
      throw new Error('No PM data found for this date');
    }
    
    console.log('Generating report HTML...');
    
    // Calculate PM amounts using same logic as PM flow for consistency
    const calculations = calculatePMAmounts({
      amTotal: amData.total,
      total: fullData.pm_total,
      toastSales: fullData.pm_toast_sales,
      cashTips: fullData.pm_cash_tips
    });
    
    console.log('Calculations for report:', calculations);
    
    // Create enhanced pmData with calculation results
    const enhancedPmData = {
      ...fullData,
      // Add calculated fields for deposit rounding breakdown
      raw_deposit_amount: calculations.rawDepositAmount ? calculations.rawDepositAmount.toFixed(2) : null,
      deposit_rounding_adjustment: calculations.depositRoundingAdjustment ? calculations.depositRoundingAdjustment.toFixed(2) : null,
      deposit_tip_adjustment: calculations.depositTipAdjustment ? calculations.depositTipAdjustment.toFixed(2) : null,
      deposit_excess_to_cashbox: calculations.depositExcessToCashbox ? calculations.depositExcessToCashbox.toFixed(2) : null,
      // Only show deposit rounding breakdown if:
      // 1. There's actually a meaningful rounding adjustment (> 0.001)
      // 2. This data was processed with the new logic (stored amount matches rounded amount)
      has_deposit_rounding: (
        calculations.depositRoundingAdjustment && 
        Math.abs(calculations.depositRoundingAdjustment) > 0.001 &&
        Math.abs(fullData.pm_deposit_amount - calculations.depositAmount) < 0.001
      ) ? 'true' : 'false',
      deposit_amount: calculations.depositAmount.toString()
    };
    
    console.log('Enhanced PM Data:', enhancedPmData);
    
    // Generate full single day report (same format as email)
    const reportHtml = generateSingleDayReportHtml(date, amData, enhancedPmData);
    console.log('Report HTML generated, creating PDF...');
    
    // Set the content in the hidden div
    const reportContent = document.getElementById('reportContent');
    if (reportContent) {
      reportContent.innerHTML = reportHtml;
      
      // Generate PDF
      const filename = `jayna-gyro-daily-report-${date}.pdf`;
      await generatePDF(reportContent, filename);
      
    } else {
      throw new Error('Report content element not found');
    }
  }
  
  async function generateDateRangePDF() {
    const startDate = document.getElementById('reportStartDate').value;
    const endDate = document.getElementById('reportEndDate').value;
    const realEnvelopeAmount = parseFloat(document.getElementById('realEnvelopeAmount').value) || null;
    
    if (!startDate || !endDate) {
      throw new Error('Please select both start and end dates');
    }
    
    // Handle dates properly with timezone-safe parsing (like AM/PM flows)
    const start = new Date(startDate + 'T12:00:00');
    const end = new Date(endDate + 'T12:00:00');
    
    if (start > end) {
      throw new Error('Start date must be before end date');
    }
    
    // Check if date range exceeds 7 days
    const daysDiff = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
    if (daysDiff > 7) {
      throw new Error('Date range cannot exceed 7 days');
    }
    
    console.log('Date range query:', { startDate, endDate, daysDiff });
    
    const { data: rangeData } = await supabase
      .from('cash_counts')
      .select('*')
      .gte('date', startDate)
      .lte('date', endDate)
      .not('pm_total', 'is', null)
      .order('date', { ascending: true });
    
    if (!rangeData || rangeData.length === 0) {
      throw new Error('No data found for this date range');
    }
    
    // Generate date range summary report
    const reportHtml = generateDateRangeReportHtml(startDate, endDate, rangeData, realEnvelopeAmount);
    
    // Set the content in the hidden div
    const reportContent = document.getElementById('reportContent');
    if (reportContent) {
      reportContent.innerHTML = reportHtml;
      
      // Generate PDF
      const filename = `jayna-gyro-range-report-${startDate}-to-${endDate}.pdf`;
      await generatePDF(reportContent, filename);
      
    } else {
      throw new Error('Report content element not found');
    }
  }
  
  async function generatePDF(element, filename) {
    console.log('Generating PDF with filename:', filename);
    
    // Extract only the body content, skipping the CSS
    const fullHTML = element.innerHTML;
    
    // Find the start of the actual content (after </style> tag)
    const contentStart = fullHTML.indexOf('</style>') + 8;
    const contentEnd = fullHTML.lastIndexOf('</html>');
    
    let bodyContent = '';
    if (contentStart > 7 && contentEnd > contentStart) {
      // Extract content between </style> and </html>
      bodyContent = fullHTML.substring(contentStart, contentEnd);
      // Remove any remaining head/body tags and just keep the content
      bodyContent = bodyContent.replace(/<\/head>|<body>|<\/body>/g, '').trim();
    } else {
      // Fallback: try to find content starting with "JAYNA GYRO"
      const jaynaStart = fullHTML.indexOf('JAYNA GYRO DAILY CASH REPORT');
      if (jaynaStart > 0) {
        bodyContent = fullHTML.substring(jaynaStart);
        bodyContent = bodyContent.replace(/<\/html>|<\/body>/g, '').trim();
      } else {
        bodyContent = element.innerHTML;
      }
    }
    
    // Create a temporary element with just the clean content and basic styling
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = `
      <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 8px; font-size: 9px; line-height: 1.1; }
        .header { text-align: center; font-weight: bold; font-size: 16px; margin-bottom: 2px; border-bottom: 2px solid #000; padding-bottom: 4px; }
        .date-header { text-align: center; font-weight: bold; font-size: 14px; margin-bottom: 8px; padding-bottom: 4px; text-transform: uppercase; letter-spacing: 0.3px; }
        .section { border: 1px solid #000; margin: 4px 0; padding: 6px; }
        .section-title { font-weight: bold; font-size: 12px; text-align: center; margin-bottom: 4px; border-bottom: 1px solid #000; padding-bottom: 2px; text-transform: uppercase; letter-spacing: 0.3px; }
        .two-column { display: table; width: 100%; }
        .column { display: table-cell; width: 50%; vertical-align: top; padding: 0 4px; }
        .column:first-child { border-right: 1px solid #ccc; }
        .data-row { display: flex; justify-content: space-between; margin: 1px 0; max-width: 150px; }
        .label { font-weight: bold; text-align: right; padding-right: 8px; }
        .value { text-align: left; font-weight: bold; }
        .deposit-box { background-color: #e6ffe6; border: 2px solid #000; padding: 6px; text-align: center; font-weight: bold; font-size: 11px; margin: 4px 0; }
        .keep-box { background-color: #fff0e6; border: 2px solid #000; padding: 6px; text-align: center; font-weight: bold; font-size: 11px; margin: 4px 0; }
        .notes-section { display: table; width: 100%; margin: 4px 0; }
        .notes-column { display: table-cell; width: 50%; padding: 4px; border: 1px solid #000; vertical-align: top; text-align: center; font-weight: bold; }
        .notes-column:first-child { border-right: none; }
        .breakdown-grid { display: table; width: 100%; }
        .breakdown-row { display: table-row; }
        .breakdown-cell { display: table-cell; padding: 2px 4px; border-bottom: 1px dotted #ccc; }
        .breakdown-label { font-weight: bold; width: 50%; text-align: right; padding-right: 8px; }
        .breakdown-value { text-align: left; font-weight: bold; width: 50%; padding-left: 8px; }
        .cash-count { font-size: 7px; line-height: 1.0; }
        .drawer-total { font-weight: bold; border-top: 1px solid #000; margin-top: 2px; padding-top: 2px; }
        .shift-total { font-weight: bold; text-align: center; padding: 3px; border: 2px solid #000; margin-top: 4px; font-size: 8px; }
        .am-bg { background-color: #e6f3ff; }
        .pm-bg { background-color: #fff8f0; }
      </style>
      ${bodyContent}
    `;
    
    // Hide the original element and show the temp one
    const originalParent = element.parentNode;
    const originalDisplay = element.style.display;
    
    // Insert temp div and hide original
    document.body.appendChild(tempDiv);
    element.style.display = 'none';
    
    // Configure PDF options for better output
    const opt = {
      margin: 0.5,
      filename: filename,
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { 
        scale: 2,
        useCORS: true,
        backgroundColor: '#ffffff',
        width: 800,
        height: tempDiv.scrollHeight,
        logging: false
      },
      jsPDF: { 
        unit: 'in', 
        format: 'letter', 
        orientation: 'portrait' 
      }
    };
    
    try {
      // Generate PDF from the clean temp element
      await html2pdf().set(opt).from(tempDiv).save();
      console.log('PDF generated and downloaded successfully');
    } catch (pdfError) {
      console.error('PDF generation error:', pdfError);
      throw pdfError;
    } finally {
      // Clean up: remove temp div and restore original
      try {
        if (tempDiv && tempDiv.parentNode) {
          document.body.removeChild(tempDiv);
        }
        if (element) {
          element.style.display = originalDisplay;
        }
      } catch (cleanupError) {
        console.error('Cleanup error:', cleanupError);
      }
    }
  }
  
  // Download Historical Report as PDF
  async function downloadHistoricalReportPDF(startDate, endDate) {
    try {
      console.log('Downloading historical report PDF...');
      
      if (!window.currentHistoricalReport) {
        throw new Error('No historical report data available');
      }
      
      const reportData = window.currentHistoricalReport;
      const reportContent = document.getElementById('reportContent');
      
      if (!reportContent) {
        throw new Error('Report content not found');
      }
      
      // Generate PDF from the displayed content
      const filename = `jayna-gyro-historical-report-${startDate}-to-${endDate}.pdf`;
      await generatePDF(reportContent, filename);
      
      console.log('Historical report PDF downloaded successfully');
      
    } catch (error) {
      console.error('Error downloading historical report PDF:', error);
      showErrorMessage('Failed to download PDF: ' + error.message, 'reportResults');
    }
  }
  
  function generateSingleDayReportHtml(date, amData, pmData) {
    console.log('generateSingleDayReportHtml called with:');
    console.log('date:', date);
    console.log('amData:', amData);
    console.log('pmData:', pmData);
    
    // Validate data exists
    if (!amData || !pmData) {
      console.error('Missing data - amData:', !!amData, 'pmData:', !!pmData);
      return '<div style="padding: 20px; color: red; font-size: 18px;">Error: Missing report data</div>';
    }
    
    const dayOfWeek = new Date(date + 'T12:00:00').toLocaleDateString('en-US', { weekday: 'long' }).toUpperCase();
    const formattedDate = new Date(date + 'T12:00:00').toLocaleDateString('en-US', { 
      year: 'numeric', 
      month: 'long', 
      day: 'numeric' 
    }).toUpperCase();
    
    const actualCashIn = pmData.pm_total - amData.total;
    const discrepancySign = pmData.pm_discrepancy >= 0 ? '+' : '';
    const tipAdjustment = pmData.pm_discrepancy < 0 ? Math.abs(pmData.pm_discrepancy) : 0;
    
    // Helper function to get denomination counts and totals
    function getDenomData(drawerData, denomKey) {
      if (!drawerData || !drawerData) return { count: 0, total: 0 };
      
      // Map display format to stored format
      const denomMapping = {
        '$100': 'hundreds',
        '$50': 'fifties', 
        '$20': 'twenties',
        '$10': 'tens',
        '$5': 'fives',
        '$1': 'ones',
        '¢25': 'quarters',
        '¢10': 'dimes', 
        '¢5': 'nickels',
        '¢1': 'pennies'
      };
      
      const dataKey = denomMapping[denomKey];
      if (!dataKey) return { count: 0, total: 0 };
      
      const count = parseInt(drawerData[dataKey]) || 0;
      const denomValues = {
        '$100': 100, '$50': 50, '$20': 20, '$10': 10, '$5': 5, '$1': 1,
        '¢25': 0.25, '¢10': 0.10, '¢5': 0.05, '¢1': 0.01
      };
      const value = denomValues[denomKey] || 0;
      return { count, total: (count * value).toFixed(2) };
    }
    
    const htmlContent = `
    <!DOCTYPE html>
    <html>
    <head>
        <style>
            body {
                font-family: Arial, sans-serif;
                margin: 0;
                padding: 8px;
                font-size: 9px;
                line-height: 1.1;
            }
            .header {
                text-align: center;
                font-weight: bold;
                font-size: 16px;
                margin-bottom: 2px;
                border-bottom: 2px solid #000;
                padding-bottom: 4px;
            }
            .date-header {
                text-align: center;
                font-weight: bold;
                font-size: 14px;
                margin-bottom: 8px;
                padding-bottom: 4px;
            }
            .section {
                border: 1px solid #000;
                margin: 4px 0;
                padding: 6px;
            }
            .section-title {
                font-weight: bold;
                font-size: 12px;
                text-align: center;
                margin-bottom: 4px;
                border-bottom: 1px solid #000;
                padding-bottom: 2px;
            }
            .two-column {
                display: table;
                width: 100%;
            }
            .column {
                display: table-cell;
                width: 50%;
                vertical-align: top;
                padding: 0 4px;
            }
            .column:first-child {
                border-right: 1px solid #ccc;
            }
            .data-row {
                display: flex;
                justify-content: space-between;
                margin: 1px 0;
                max-width: 150px;
            }
            .label {
                font-weight: bold;
                text-align: right;
                padding-right: 8px;
            }
            .value {
                text-align: left;
                font-weight: bold;
            }
            .deposit-box {
                background-color: #e6ffe6;
                border: 2px solid #000;
                padding: 6px;
                text-align: center;
                font-weight: bold;
                font-size: 11px;
                margin: 4px 0;
            }
            .keep-box {
                background-color: #fff0e6;
                border: 2px solid #000;
                padding: 6px;
                text-align: center;
                font-weight: bold;
                font-size: 11px;
                margin: 4px 0;
            }
            .notes-section {
                display: table;
                width: 100%;
                margin: 4px 0;
            }
            .notes-column {
                display: table-cell;
                width: 50%;
                padding: 4px;
                border: 1px solid #000;
                vertical-align: top;
                text-align: center;
                font-weight: bold;
            }
            .notes-column:first-child {
                border-right: none;
            }
            .breakdown-grid {
                display: table;
                width: 100%;
            }
            .breakdown-row {
                display: table-row;
            }
            .breakdown-cell {
                display: table-cell;
                padding: 2px 4px;
                border-bottom: 1px dotted #ccc;
            }
            .breakdown-label {
                font-weight: bold;
                width: 50%;
                text-align: right;
                padding-right: 8px;
            }
            .breakdown-value {
                text-align: left;
                font-weight: bold;
                width: 50%;
                padding-left: 8px;
            }
            .cash-count {
                font-size: 7px;
                line-height: 1.0;
            }
            .drawer-total {
                font-weight: bold;
                border-top: 1px solid #000;
                margin-top: 2px;
                padding-top: 2px;
            }
            .shift-total {
                font-weight: bold;
                text-align: center;
                padding: 3px;
                border: 2px solid #000;
                margin-top: 4px;
                font-size: 8px;
            }
            .am-bg { background-color: #e6f3ff; }
            .pm-bg { background-color: #fff8f0; }
        </style>
    </head>
    <body>
        <div class="header">
            JAYNA GYRO DAILY CASH REPORT
        </div>
        <div class="date-header">
            ${dayOfWeek} ${formattedDate}
        </div>
        <div style="text-align: center; font-size: 8px; color: #666; margin-bottom: 8px; border-bottom: 1px dotted #ccc; padding-bottom: 4px;">
            Report Generated: ${new Date().toLocaleString()}
        </div>

        <!-- Staff and Timing Info -->
        <div class="section">
            <div class="two-column">
                <div class="column">
                    <div class="data-row">
                        <span class="label">AM Counter:</span>
                        <span class="value">${amData.counter}</span>
                    </div>
                    <div class="data-row">
                        <span class="label">AM Time:</span>
                        <span class="value">${new Date(amData.timestamp).toLocaleTimeString()}</span>
                    </div>
                </div>
                <div class="column">
                    <div class="data-row">
                        <span class="label">PM Counter:</span>
                        <span class="value">${pmData.pm_counter}</span>
                    </div>
                    <div class="data-row">
                        <span class="label">PM Time:</span>
                        <span class="value">${new Date(pmData.pm_timestamp).toLocaleTimeString()}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Cash Summary -->
        <div class="section">
            <div class="section-title">CASH FLOW SUMMARY</div>
            <div class="two-column">
                <div class="column">
                    <div class="data-row">
                        <span class="label">Starting Cash (AM):</span>
                        <span class="value">$${amData.total.toFixed(2)}</span>
                    </div>
                    <div class="data-row">
                        <span class="label">Ending Cash (PM):</span>
                        <span class="value">$${pmData.pm_total.toFixed(2)}</span>
                    </div>
                    <div class="data-row">
                        <span class="label">Actual Cash In:</span>
                        <span class="value">$${actualCashIn.toFixed(2)}</span>
                    </div>
                </div>
                <div class="column">
                    <div class="data-row">
                        <span class="label">Toast Sales:</span>
                        <span class="value">$${pmData.pm_toast_sales.toFixed(2)}</span>
                    </div>
                    <div class="data-row">
                        <span class="label">Original Tips:</span>
                        <span class="value">$${pmData.pm_cash_tips.toFixed(2)}</span>
                    </div>
                    <div class="data-row">
                        <span class="label">Discrepancy:</span>
                        <span class="value">${discrepancySign}$${Math.abs(pmData.pm_discrepancy).toFixed(2)}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Deposit Instructions -->
        <div class="deposit-box">
            DEPOSIT IN ENVELOPE: $${pmData.pm_deposit_amount}
            <div style="font-size: 8px;">(Toast Sales $${pmData.pm_toast_sales.toFixed(2)} + Original Tips $${pmData.pm_cash_tips.toFixed(2)})</div>
        </div>
        <div class="keep-box">
            RETURN TO CASHBOX/SAFE: $${pmData.pm_amount_to_keep.toFixed(2)}
        </div>

        <!-- Notes Section -->
        <div class="notes-section">
            <div class="notes-column am-bg">
                <div style="font-weight: bold; text-align: center; margin-bottom: 3px;">AM NOTES</div>
                <div style="text-align: center; font-weight: bold;">
                    ${amData.notes || 'No AM Notes'}
                </div>
            </div>
            <div class="notes-column pm-bg">
                <div style="font-weight: bold; text-align: center; margin-bottom: 3px;">PM NOTES</div>
                <div style="text-align: center; font-weight: bold;">
                    ${pmData.pm_notes || 'No PM Notes'}
                </div>
            </div>
        </div>

        <!-- Manager Breakdown -->
        <div class="section">
            <div class="section-title">MANAGER BREAKDOWN</div>
            <div class="breakdown-grid">
                <div class="breakdown-row">
                    <div class="breakdown-cell breakdown-label">Starting Cash Total:</div>
                    <div class="breakdown-cell breakdown-value">$${amData.total.toFixed(2)}</div>
                </div>
                <div class="breakdown-row">
                    <div class="breakdown-cell breakdown-label">Ending Cash Total:</div>
                    <div class="breakdown-cell breakdown-value">$${pmData.pm_total.toFixed(2)}</div>
                </div>
                <div class="breakdown-row">
                    <div class="breakdown-cell breakdown-label">Actual Cash In:</div>
                    <div class="breakdown-cell breakdown-value">$${actualCashIn.toFixed(2)}</div>
                </div>
                <div class="breakdown-row">
                    <div class="breakdown-cell breakdown-label">Toast Sales Reported:</div>
                    <div class="breakdown-cell breakdown-value">$${pmData.pm_toast_sales.toFixed(2)}</div>
                </div>
                <div class="breakdown-row">
                    <div class="breakdown-cell breakdown-label">Tips Reported by Staff:</div>
                    <div class="breakdown-cell breakdown-value">$${pmData.pm_cash_tips.toFixed(2)}</div>
                </div>
                <div class="breakdown-row">
                    <div class="breakdown-cell breakdown-label">Discrepancy (Drawers vs Toast):</div>
                    <div class="breakdown-cell breakdown-value">${discrepancySign}$${Math.abs(pmData.pm_discrepancy).toFixed(2)}</div>
                </div>
                ${tipAdjustment > 0 ? `
                <div class="breakdown-row">
                    <div class="breakdown-cell breakdown-label">Cash Tip Adjustment:</div>
                    <div class="breakdown-cell breakdown-value">-$${tipAdjustment.toFixed(2)}</div>
                </div>` : ''}
                ${pmData.has_deposit_rounding === 'true' ? `
                <div class="breakdown-row" style="background-color: #fff3cd;">
                    <div class="breakdown-cell breakdown-label">Raw Deposit Amount:</div>
                    <div class="breakdown-cell breakdown-value">$${pmData.raw_deposit_amount}</div>
                </div>
                <div class="breakdown-row" style="background-color: #fff3cd;">
                    <div class="breakdown-cell breakdown-label">Rounded Deposit Amount:</div>
                    <div class="breakdown-cell breakdown-value">$${pmData.deposit_amount}</div>
                </div>
                <div class="breakdown-row" style="background-color: #fff3cd;">
                    <div class="breakdown-cell breakdown-label">Rounding Adjustment Needed:</div>
                    <div class="breakdown-cell breakdown-value">$${pmData.deposit_rounding_adjustment}</div>
                </div>
                <div class="breakdown-row" style="background-color: #fff3cd;">
                    <div class="breakdown-cell breakdown-label">Taken from Tips (Whole $):</div>
                    <div class="breakdown-cell breakdown-value">-$${pmData.deposit_tip_adjustment}</div>
                </div>
                <div class="breakdown-row" style="background-color: #fff3cd;">
                    <div class="breakdown-cell breakdown-label">Excess to Cashbox:</div>
                    <div class="breakdown-cell breakdown-value">+$${pmData.deposit_excess_to_cashbox}</div>
                </div>` : ''}
                <div class="breakdown-row">
                    <div class="breakdown-cell breakdown-label">Owed to Restaurant:</div>
                    <div class="breakdown-cell breakdown-value">$${pmData.pm_toast_sales.toFixed(2)}</div>
                </div>
                <div class="breakdown-row">
                    <div class="breakdown-cell breakdown-label">Cash Tips Owed to Staff:</div>
                    <div class="breakdown-cell breakdown-value">$${pmData.pm_adjusted_tips.toFixed(2)}</div>
                </div>
                <div class="breakdown-row">
                    <div class="breakdown-cell breakdown-label">Returned to Cashbox:</div>
                    <div class="breakdown-cell breakdown-value">$${(pmData.pm_amount_to_keep - amData.total).toFixed(2)} + AM Total</div>
                </div>
            </div>
        </div>

        <!-- Complete Cash Count Breakdown -->
        <div class="section">
            <div class="section-title">COMPLETE CASH COUNT BREAKDOWN</div>
            <div class="two-column">
                <!-- AM Counts -->
                <div class="column">
                    <div style="text-align: center; font-weight: bold; font-size: 8px; margin-bottom: 3px; background-color: #e6f3ff; padding: 2px;">AM COUNTS</div>
                    
                    <div class="cash-count">
                        <div style="font-weight: bold; text-decoration: underline; margin-bottom: 2px;">DRAWER 1</div>
                        ${['$100', '$50', '$20', '$10', '$5', '$1', '¢25', '¢10', '¢5', '¢1'].map(denom => {
                          const data = getDenomData(amData.drawer1.counts, denom);
                          return `<div>${denom}: ${data.count} = $${data.total}</div>`;
                        }).join('')}
                        <div class="drawer-total">TOTAL: $${amData.drawer1.total.toFixed(2)}</div>
                    </div>
                    
                    <div class="cash-count" style="margin-top: 4px;">
                        <div style="font-weight: bold; text-decoration: underline; margin-bottom: 2px;">DRAWER 2</div>
                        ${['$100', '$50', '$20', '$10', '$5', '$1', '¢25', '¢10', '¢5', '¢1'].map(denom => {
                          const data = getDenomData(amData.drawer2.counts, denom);
                          return `<div>${denom}: ${data.count} = $${data.total}</div>`;
                        }).join('')}
                        <div class="drawer-total">TOTAL: $${amData.drawer2.total.toFixed(2)}</div>
                    </div>
                    
                    <div class="shift-total am-bg">TOTAL AM: $${amData.total.toFixed(2)}</div>
                </div>
                
                <!-- PM Counts -->
                <div class="column">
                    <div style="text-align: center; font-weight: bold; font-size: 8px; margin-bottom: 3px; background-color: #fff8f0; padding: 2px;">PM COUNTS</div>
                    
                    <div class="cash-count">
                        <div style="font-weight: bold; text-decoration: underline; margin-bottom: 2px;">DRAWER 1</div>
                        ${['$100', '$50', '$20', '$10', '$5', '$1', '¢25', '¢10', '¢5', '¢1'].map(denom => {
                          const data = getDenomData(pmData.pm_drawer1_data, denom);
                          return `<div>${denom}: ${data.count} = $${data.total}</div>`;
                        }).join('')}
                        <div class="drawer-total">TOTAL: $${pmData.pm_drawer1_total.toFixed(2)}</div>
                    </div>
                    
                    <div class="cash-count" style="margin-top: 4px;">
                        <div style="font-weight: bold; text-decoration: underline; margin-bottom: 2px;">DRAWER 2</div>
                        ${['$100', '$50', '$20', '$10', '$5', '$1', '¢25', '¢10', '¢5', '¢1'].map(denom => {
                          const data = getDenomData(pmData.pm_drawer2_data, denom);
                          return `<div>${denom}: ${data.count} = $${data.total}</div>`;
                        }).join('')}
                        <div class="drawer-total">TOTAL: $${pmData.pm_drawer2_total.toFixed(2)}</div>
                    </div>
                    
                    <div class="shift-total pm-bg">TOTAL PM: $${pmData.pm_total.toFixed(2)}</div>
                </div>
            </div>
            
            <!-- Overall Drawer Totals Summary -->
            <div style="margin-top: 8px; padding-top: 8px; border-top: 2px solid #000;">
                <div style="text-align: center; font-weight: bold; font-size: 10px; margin-bottom: 6px;">DRAWER TOTALS SUMMARY</div>
                <div class="two-column">
                    <div class="column">
                        <div style="font-size: 8px; font-weight: bold; text-align: center; margin-bottom: 3px;">DRAWER 1 TOTALS</div>
                        <div style="font-size: 8px;">
                            <div style="display: flex; justify-content: space-between; margin: 1px 0;">
                                <span>AM:</span>
                                <span>$${amData.drawer1.total.toFixed(2)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin: 1px 0;">
                                <span>PM:</span>
                                <span>$${pmData.pm_drawer1_total.toFixed(2)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin: 1px 0; border-top: 1px solid #000; padding-top: 1px; font-weight: bold;">
                                <span>Change:</span>
                                <span>$${(pmData.pm_drawer1_total - amData.drawer1.total).toFixed(2)}</span>
                            </div>
                        </div>
                    </div>
                    <div class="column">
                        <div style="font-size: 8px; font-weight: bold; text-align: center; margin-bottom: 3px;">DRAWER 2 TOTALS</div>
                        <div style="font-size: 8px;">
                            <div style="display: flex; justify-content: space-between; margin: 1px 0;">
                                <span>AM:</span>
                                <span>$${amData.drawer2.total.toFixed(2)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin: 1px 0;">
                                <span>PM:</span>
                                <span>$${pmData.pm_drawer2_total.toFixed(2)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin: 1px 0; border-top: 1px solid #000; padding-top: 1px; font-weight: bold;">
                                <span>Change:</span>
                                <span>$${(pmData.pm_drawer2_total - amData.drawer2.total).toFixed(2)}</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div style="text-align: center; font-weight: bold; font-size: 9px; margin-top: 6px; padding: 4px; border: 2px solid #000; background-color: #f0f0f0;">
                    COMBINED DRAWER CHANGE: $${(actualCashIn).toFixed(2)}
                </div>
            </div>
        </div>
    </body>
    </html>
    `;
    
    console.log('Generated HTML length:', htmlContent.length);
    return htmlContent;
  }
  
  function generateDateRangeReportHtml(startDate, endDate, data, realEnvelopeAmount = null) {
    // Calculate totals according to requirements
    let totalToastSalesReported = 0;
    let totalActualCashIn = 0;
    let totalDiscrepancy = 0;
    let totalOriginalCashTips = 0;
    let totalAdjustedCashTips = 0;
    let totalEnvelopeDeposits = 0;
    let totalBackToCashbox = 0;
    
    data.forEach(day => {
      totalToastSalesReported += day.pm_toast_sales || 0;
      totalActualCashIn += (day.pm_total - day.am_total) || 0;
      totalDiscrepancy += day.pm_discrepancy || 0;
      totalOriginalCashTips += day.pm_cash_tips || 0;
      totalAdjustedCashTips += day.pm_adjusted_tips || 0;
      totalEnvelopeDeposits += day.pm_deposit_amount || 0;
      // Fix: Calculate actual excess returned to cashbox (not total amount)
      totalBackToCashbox += (day.pm_amount_to_keep - day.am_total) || 0;
    });
    
    return `
      <div style="font-family: Arial, sans-serif; max-width: 900px; margin: 0 auto; font-size: 14px; line-height: 1.3;">
        <!-- Title with Confidential -->
        <div style="text-align: center; margin-bottom: 25px; padding: 15px; background: #f0f0f0; border-radius: 0; border: 2px solid #000;">
          <h2 style="margin: 0; color: #333; font-size: 18px; font-weight: bold;">**CONFIDENTIAL**</h2>
          <h2 style="margin: 5px 0; color: #333; font-size: 16px;">JAYNA GYRO MULTI-DAY CASH REPORT</h2>
          <p style="margin: 5px 0; font-size: 14px; color: #666; font-weight: bold;">
            ${new Date(startDate + 'T12:00:00').toLocaleDateString()} - ${new Date(endDate + 'T12:00:00').toLocaleDateString()}
          </p>
          <p style="margin: 5px 0; font-size: 12px; color: #888;">${data.length} days included</p>
        </div>
        
        <!-- Key Totals Grid -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px;">
          
          <div style="background: #e6f3ff; padding: 15px; border: 2px solid #000; border-radius: 0; text-align: center;">
            <h4 style="margin: 0 0 8px 0; color: #1e3c72; font-size: 12px;">TOTAL TOAST CASH SALES REPORTED</h4>
            <p style="font-size: 20px; font-weight: bold; margin: 0; color: #1e3c72;">$${totalToastSalesReported.toFixed(2)}</p>
          </div>
          
          <div style="background: #f0f8ff; padding: 15px; border: 2px solid #000; border-radius: 0; text-align: center;">
            <h4 style="margin: 0 0 8px 0; color: #28a745; font-size: 12px;">TOTAL ACTUAL CASH IN</h4>
            <p style="font-size: 20px; font-weight: bold; margin: 0; color: #28a745;">$${totalActualCashIn.toFixed(2)}</p>
            <p style="font-size: 10px; margin: 5px 0 0 0; color: #666;">(Based on PM-AM counts for each day)</p>
          </div>
          
          <div style="background: #ffe6e6; padding: 15px; border: 2px solid #000; border-radius: 0; text-align: center;">
            <h4 style="margin: 0 0 8px 0; color: #dc3545; font-size: 12px;">TOTAL DISCREPANCY</h4>
            <p style="font-size: 20px; font-weight: bold; margin: 0; color: #dc3545;">
              ${totalDiscrepancy >= 0 ? '+' : ''}$${totalDiscrepancy.toFixed(2)}
            </p>
            <p style="font-size: 10px; margin: 5px 0 0 0; color: #666;">(Between Toast and Count)</p>
          </div>
          
          <div style="background: #fff3e0; padding: 15px; border: 2px solid #000; border-radius: 0; text-align: center;">
            <h4 style="margin: 0 0 8px 0; color: #ff9800; font-size: 12px;">TOTAL CASH TIPS ORIGINALLY REPORTED</h4>
            <p style="font-size: 20px; font-weight: bold; margin: 0; color: #ff9800;">$${totalOriginalCashTips.toFixed(2)}</p>
          </div>
          
          <div style="background: #f3e5f5; padding: 15px; border: 2px solid #000; border-radius: 0; text-align: center;">
            <h4 style="margin: 0 0 8px 0; color: #9c27b0; font-size: 12px;">TOTAL ADJUSTED CASH TIPS</h4>
            <p style="font-size: 20px; font-weight: bold; margin: 0; color: #9c27b0;">$${totalAdjustedCashTips.toFixed(2)}</p>
            <p style="font-size: 10px; margin: 5px 0 0 0; color: #666;">(Adjusted to make up for discrepancies)</p>
          </div>
          
          <div style="background: #e8f5e8; padding: 15px; border: 2px solid #000; border-radius: 0; text-align: center;">
            <h4 style="margin: 0 0 8px 0; color: #2e7d32; font-size: 12px;">TOTAL ENVELOPE DEPOSITS</h4>
            <p style="font-size: 20px; font-weight: bold; margin: 0; color: #2e7d32;">$${totalEnvelopeDeposits}</p>
          </div>
          
          <div style="background: #fff8e1; padding: 15px; border: 2px solid #000; border-radius: 0; text-align: center;">
            <h4 style="margin: 0 0 8px 0; color: #f57c00; font-size: 12px;">TOTAL "BACK TO CASHBOX"</h4>
            <p style="font-size: 20px; font-weight: bold; margin: 0; color: #f57c00;">$${totalBackToCashbox.toFixed(2)}</p>
          </div>
          
          ${realEnvelopeAmount !== null ? `
          <div style="background: #f3e5f5; padding: 15px; border: 2px solid #000; border-radius: 0; text-align: center;">
            <h4 style="margin: 0 0 8px 0; color: #7b1fa2; font-size: 12px;">REAL ENVELOPE AMOUNT</h4>
            <p style="font-size: 20px; font-weight: bold; margin: 0; color: #7b1fa2;">$${realEnvelopeAmount.toFixed(2)}</p>
          </div>
          
          <div style="background: #e8f5e8; padding: 15px; border: 2px solid #000; border-radius: 0; text-align: center;">
            <h4 style="margin: 0 0 8px 0; color: #2e7d32; font-size: 12px;">ENVELOPE DIFFERENCE</h4>
            <p style="font-size: 20px; font-weight: bold; margin: 0; color: ${(realEnvelopeAmount - totalEnvelopeDeposits) >= 0 ? '#2e7d32' : '#d32f2f'};">
              $${(realEnvelopeAmount - totalEnvelopeDeposits).toFixed(2)}
            </p>
          </div>
          ` : ''}
          
        </div>
        
        <!-- Daily Breakdown Table -->
        <div style="border: 2px solid #000; margin: 20px 0; border-radius: 0; overflow: hidden;">
          <div style="background: #f0f0f0; padding: 10px; border-bottom: 2px solid #000;">
            <h4 style="margin: 0; text-align: center; font-size: 14px;">DAILY BREAKDOWN</h4>
          </div>
          
          <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
              <thead>
                <tr style="background: #f8f9fa;">
                  <th style="border: 1px solid #000; padding: 8px; text-align: left;">Date</th>
                  <th style="border: 1px solid #000; padding: 8px; text-align: center;">Counter</th>
                  <th style="border: 1px solid #000; padding: 8px; text-align: right;">Toast Sales</th>
                  <th style="border: 1px solid #000; padding: 8px; text-align: right;">Actual Cash In</th>
                  <th style="border: 1px solid #000; padding: 8px; text-align: right;">Discrepancy</th>
                  <th style="border: 1px solid #000; padding: 8px; text-align: right;">Envelope</th>
                  <th style="border: 1px solid #000; padding: 8px; text-align: right;">Cashbox</th>
                </tr>
              </thead>
              <tbody>
                ${data.map(day => {
                  const actualCashIn = day.pm_total - day.am_total;
                  const discrepancySign = day.pm_discrepancy >= 0 ? '+' : '';
                  return `
                    <tr>
                      <td style="border: 1px solid #000; padding: 6px; font-weight: bold;">
                        ${new Date(day.date + 'T12:00:00').toLocaleDateString()}
                      </td>
                      <td style="border: 1px solid #000; padding: 6px; text-align: center;">
                        ${day.pm_counter || 'N/A'}
                      </td>
                      <td style="border: 1px solid #000; padding: 6px; text-align: right;">
                        $${(day.pm_toast_sales || 0).toFixed(2)}
                      </td>
                      <td style="border: 1px solid #000; padding: 6px; text-align: right;">
                        $${actualCashIn.toFixed(2)}
                      </td>
                      <td style="border: 1px solid #000; padding: 6px; text-align: right; color: ${day.pm_discrepancy >= 0 ? '#28a745' : '#dc3545'};">
                        ${discrepancySign}$${Math.abs(day.pm_discrepancy || 0).toFixed(2)}
                      </td>
                      <td style="border: 1px solid #000; padding: 6px; text-align: right;">
                        $${day.pm_deposit_amount || 0}
                      </td>
                      <td style="border: 1px solid #000; padding: 6px; text-align: right;">
                        $${(day.pm_amount_to_keep || 0).toFixed(2)}
                      </td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          </div>
        </div>

        <!-- Notes and Labor Summary Section (2 columns) -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 0;">

          <!-- Left Column: Daily Notes -->
          <div style="border: 2px solid #000; border-radius: 0; overflow: hidden;">
            <div style="background: #f0f0f0; padding: 10px; border-bottom: 2px solid #000;">
              <h4 style="margin: 0; text-align: center; font-size: 14px;">DAILY NOTES</h4>
            </div>
            <div style="padding: 12px; max-height: 300px; overflow-y: auto;">
              ${data.map(day => {
                const hasNotes = (day.am_notes && day.am_notes.trim()) || (day.pm_notes && day.pm_notes.trim());
                if (!hasNotes) return '';
                return `
                  <div style="margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-left: 4px solid #667eea; border-radius: 0;">
                    <div style="font-weight: bold; color: #1e3c72; margin-bottom: 5px;">
                      ${new Date(day.date + 'T12:00:00').toLocaleDateString()}
                    </div>
                    ${day.am_notes && day.am_notes.trim() ? `
                      <div style="margin: 5px 0; font-size: 12px;">
                        <span style="font-weight: bold; color: #666;">AM:</span> ${day.am_notes}
                      </div>
                    ` : ''}
                    ${day.pm_notes && day.pm_notes.trim() ? `
                      <div style="margin: 5px 0; font-size: 12px;">
                        <span style="font-weight: bold; color: #666;">PM:</span> ${day.pm_notes}
                      </div>
                    ` : ''}
                  </div>
                `;
              }).join('') || '<p style="text-align: center; color: #999; padding: 20px;">No notes for this period</p>'}
            </div>
          </div>

          <!-- Right Column: Labor Summary -->
          <div style="border: 2px solid #000; border-radius: 0; overflow: hidden;">
            <div style="background: #f0f0f0; padding: 10px; border-bottom: 2px solid #000;">
              <h4 style="margin: 0; text-align: center; font-size: 14px;">WEEKLY LABOR SUMMARY</h4>
            </div>
            <div style="padding: 12px;">
              ${typeof tipPoolSummary !== 'undefined' && tipPoolSummary.laborData ? `
                <!-- Labor Breakdown -->
                <div style="margin-bottom: 12px;">
                  <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #ddd; font-size: 12px;">
                    <span>Base Labor Cost:</span>
                    <span style="font-weight: bold;">$${tipPoolSummary.laborData.baseLaborCost.toFixed(2)}</span>
                  </div>
                  <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #ddd; font-size: 12px;">
                    <span>Manager Salary (prorated):</span>
                    <span style="font-weight: bold;">$${tipPoolSummary.laborData.demetriSalary.toFixed(2)}</span>
                  </div>
                  <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #ddd; font-size: 12px;">
                    <span>Subtotal:</span>
                    <span style="font-weight: bold;">$${tipPoolSummary.laborData.subtotalLabor.toFixed(2)}</span>
                  </div>
                  <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 2px solid #000; font-size: 12px;">
                    <span>Payroll Burden (33%):</span>
                    <span style="font-weight: bold;">$${tipPoolSummary.laborData.payrollBurden.toFixed(2)}</span>
                  </div>
                  <div style="display: flex; justify-content: space-between; padding: 8px 0; font-size: 13px;">
                    <span style="font-weight: bold;">True Total Labor Cost:</span>
                    <span style="font-weight: bold; color: #1e3c72;">$${tipPoolSummary.laborData.trueTotalLaborCost.toFixed(2)}</span>
                  </div>
                </div>

                <!-- Labor Percentage Analysis -->
                <div style="background: ${tipPoolSummary.laborData.laborVariance > 0 ? '#ffe6e6' : '#e8f5e8'}; padding: 12px; border-radius: 0; border: 2px solid ${tipPoolSummary.laborData.laborVariance > 0 ? '#dc3545' : '#28a745'}; margin-top: 12px;">
                  <div style="text-align: center; margin-bottom: 8px;">
                    <div style="font-size: 11px; color: #666; margin-bottom: 4px;">NET SALES</div>
                    <div style="font-size: 16px; font-weight: bold;">$${tipPoolSummary.laborData.netSales.toFixed(2)}</div>
                  </div>
                  <div style="text-align: center; margin-bottom: 8px;">
                    <div style="font-size: 11px; color: #666; margin-bottom: 4px;">LABOR PERCENTAGE</div>
                    <div style="font-size: 24px; font-weight: bold; color: ${tipPoolSummary.laborData.laborVariance > 0 ? '#dc3545' : '#28a745'};">
                      ${tipPoolSummary.laborData.laborPercentage.toFixed(2)}%
                    </div>
                  </div>
                  <div style="display: flex; justify-content: space-between; padding: 6px 0; border-top: 1px solid #ddd; font-size: 11px;">
                    <span>Industry Benchmark:</span>
                    <span style="font-weight: bold;">${tipPoolSummary.laborData.industryBenchmark.toFixed(1)}%</span>
                  </div>
                  <div style="display: flex; justify-content: space-between; padding: 6px 0; font-size: 11px;">
                    <span>Variance:</span>
                    <span style="font-weight: bold; color: ${tipPoolSummary.laborData.laborVariance > 0 ? '#dc3545' : '#28a745'};">
                      ${tipPoolSummary.laborData.laborVariance > 0 ? '+' : ''}${tipPoolSummary.laborData.laborVariance.toFixed(2)}%
                      ${tipPoolSummary.laborData.laborVariance > 0 ? 'OVER' : 'UNDER'}
                    </span>
                  </div>
                </div>

                <div style="margin-top: 10px; padding: 8px; background: #f8f9fa; border-radius: 0; font-size: 10px; text-align: center; color: #666;">
                  <strong>Note:</strong> Includes $85k annual manager salary ($1,634.62/week) + 33% payroll burden
                </div>
              ` : `
                <p style="text-align: center; color: #999; padding: 20px; font-size: 12px;">
                  Labor data not available.<br>
                  Calculate tip pool first to see labor summary.
                </p>
              `}
            </div>
          </div>

        </div>
      </div>
    `;
  }
  
  function resetForm(shift) {
    document.getElementById(`${shift}Counter`).value = '';
    document.getElementById(`${shift}Notes`).value = '';
    
    // Reset drawer skips
    document.getElementById(`${shift}Drawer1Skip`).checked = false;
    document.getElementById(`${shift}Drawer2Skip`).checked = false;
    toggleSkip(shift, 1);
    toggleSkip(shift, 2);
    
    // Reset all denomination inputs
    DENOMINATIONS.forEach((denom, index) => {
      document.getElementById(`${shift}D1Q${index}`).value = '0';
      document.getElementById(`${shift}D2Q${index}`).value = '0';
    });
    
    if (shift === 'pm') {
      document.getElementById('toastSales').value = '';
      document.getElementById('cashTips').value = '';
    }
    
    updateCalculations(shift, 1);
    updateCalculations(shift, 2);
  }

  // ===== TIP POOL CALCULATOR FUNCTIONS =====
  
  // Global state for tip pool calculations
  let tipPoolRecords = [];
  let tipPoolSummary = {};
  
  // Predefined equity mapping - can be extended as needed
  const defaultEquity = {
    'Dokcu, Huseyin': 0.5,
    'Morales, Emilio': 0.5
  };

  // Helper function to show error messages
  function showErrorMessage(message, targetSectionId = null) {
    const errorMsg = document.createElement('div');
    errorMsg.className = 'message error';
    errorMsg.innerHTML = `<strong>Error:</strong> ${message}`;
    
    let targetSection;
    
    if (targetSectionId) {
      // Use specified target section
      targetSection = document.getElementById(targetSectionId);
    } else {
      // Find the currently active section
      targetSection = document.querySelector('.form-section.active');
    }
    
    if (targetSection) {
      // Insert at the top of the target section
      const firstChild = targetSection.firstElementChild;
      targetSection.insertBefore(errorMsg, firstChild.nextSibling);
    } else {
      // Fallback to tip pool form if no target section found
      const tipPoolForm = document.getElementById('tipPoolForm');
      const firstChild = tipPoolForm.firstElementChild;
      tipPoolForm.insertBefore(errorMsg, firstChild.nextSibling);
    }
    
    // Remove message after 8 seconds (longer for historical report errors)
    setTimeout(() => {
      if (errorMsg.parentNode) {
        errorMsg.remove();
      }
    }, 8000);
  }

  // Helper function to show success messages
  function showSuccessMessage(message, targetSectionId = 'tipPoolForm') {
    console.log('showSuccessMessage called with:', message);
    const successMsg = document.createElement('div');
    successMsg.className = 'message success';
    successMsg.innerHTML = `<strong>Success:</strong> ${message}`;
    
    // Insert at the top of the specified form
    const targetForm = document.getElementById(targetSectionId);
    console.log(`${targetSectionId} form found:`, targetForm);
    const firstChild = targetForm.firstElementChild;
    targetForm.insertBefore(successMsg, firstChild.nextSibling);
    console.log('Success message inserted');
    
    // Remove message after 5 seconds
    setTimeout(() => {
      if (successMsg.parentNode) {
        successMsg.remove();
      }
    }, 5000);
    console.log('showSuccessMessage completed');
  }

  // ===== DATA PERSISTENCE FUNCTIONS =====
  
  // Save tip pool data to localStorage - DISABLED to reset fields every time
  function saveTipPoolData() {
    // No-op: Tip pool fields now reset every time instead of persisting
    console.log('Tip pool localStorage persistence disabled - fields will reset every time');
  }
  
  // Load tip pool data from localStorage - DISABLED to reset fields every time
  function loadTipPoolData() {
    // No-op: Tip pool fields now reset every time instead of loading from localStorage
    console.log('Tip pool localStorage loading disabled - fields start fresh every time');
    return false;
  }
  
  // Save combined report data to localStorage
  function saveCombinedReportData() {
    try {
      const combinedData = {
        formData: {
          startDate: document.getElementById('combinedStartDate').value,
          endDate: document.getElementById('combinedEndDate').value,
          realEnvelope: document.getElementById('combinedRealEnvelope').value
        },
        lastCashData: window.lastCombinedCashData || null,
        timestamp: new Date().toISOString()
      };
      localStorage.setItem('jaynaGyroCashCounter_combinedReportData', JSON.stringify(combinedData));
      console.log('Combined report data saved to localStorage');
    } catch (error) {
      console.error('Error saving combined report data:', error);
    }
  }
  
  // Load combined report data from localStorage
  function loadCombinedReportData() {
    try {
      const saved = localStorage.getItem('jaynaGyroCashCounter_combinedReportData');
      if (!saved) return false;
      
      const combinedData = JSON.parse(saved);
      
      // Restore form data
      if (combinedData.formData) {
        const form = combinedData.formData;
        document.getElementById('combinedStartDate').value = form.startDate || '';
        document.getElementById('combinedEndDate').value = form.endDate || '';
        document.getElementById('combinedRealEnvelope').value = form.realEnvelope || '';
      }
      
      // Restore cash data for re-generation
      if (combinedData.lastCashData) {
        window.lastCombinedCashData = combinedData.lastCashData;
      }
      
      console.log('Combined report data loaded from localStorage');
      return true;
    } catch (error) {
      console.error('Error loading combined report data:', error);
      return false;
    }
  }
  
  // Clear all saved data
  function clearSavedData() {
    try {
      localStorage.removeItem('jaynaGyroCashCounter_tipPoolData');
      localStorage.removeItem('jaynaGyroCashCounter_combinedReportData');
      
      // Reset tip pool state
      tipPoolRecords = [];
      tipPoolSummary = {};
      
      // Reset forms
      document.getElementById('tipPoolForm').reset();
      document.getElementById('combinedReportForm').reset();
      
      // Hide results
      document.getElementById('tipPoolResults').style.display = 'none';
      document.getElementById('tipPoolPdfBtn').style.display = 'none';
      document.getElementById('combinedReportSection').style.display = 'none';
      document.getElementById('tipPoolForm').classList.remove('active');
      
      showSuccessMessage('All saved data cleared. You can start fresh.');
      console.log('All saved data cleared');
    } catch (error) {
      console.error('Error clearing saved data:', error);
      showErrorMessage('Error clearing saved data: ' + error.message);
    }
  }

  // Global variable to store TDS fetch status
  let tdsDataStatus = {
    isFetching: false,
    hasData: false,
    data: 0,
    error: null
  };

  async function calculateCashTips() {
    const startDate = document.getElementById('tipPoolStartDate').value;
    const endDate = document.getElementById('tipPoolEndDate').value;
    const realEnvelopeDeposit = parseFloat(document.getElementById('realEnvelopeDeposit').value) || 0;

    if (!startDate || !endDate) {
      document.getElementById('calculatedCashTips').value = '';
      // Reset TDS data when dates are cleared
      resetTdsData();
      updateCalculateButtonState();
      return;
    }

    if (!realEnvelopeDeposit) {
      document.getElementById('calculatedCashTips').value = '';
      return;
    }

    try {
      // PRIORITY 1: Use API-fetched cash sales if available
      let totalToastCashSales = 0;

      if (apiFetchedData.salesData && apiFetchedData.salesData.cashSales) {
        // Use API data (more accurate)
        totalToastCashSales = apiFetchedData.salesData.cashSales;
        console.log('calculateCashTips: Using API cash sales:', totalToastCashSales);
      } else {
        // PRIORITY 2: Fall back to database PM data if API data not available
        const { data: rangeData } = await supabase
          .from('cash_counts')
          .select('*')
          .gte('date', startDate)
          .lte('date', endDate)
          .not('pm_total', 'is', null)
          .order('date', { ascending: true });

        if (!rangeData || rangeData.length === 0) {
          document.getElementById('calculatedCashTips').value = '';
          return;
        }

        // Calculate total Toast cash sales using correct column name
        totalToastCashSales = rangeData.reduce((sum, day) => sum + (day.pm_toast_sales || 0), 0);
        console.log('calculateCashTips: Using PM database data:', totalToastCashSales);
      }

      // Calculate cash tips: Real Envelope Deposit - Toast Cash Sales
      const calculatedCashTips = realEnvelopeDeposit - totalToastCashSales;

      // Update the display
      document.getElementById('calculatedCashTips').value = calculatedCashTips.toFixed(2);

      // TDS Driver tips are now auto-fetched with other data when dates change (no delay!)

    } catch (error) {
      console.error('Error calculating cash tips:', error);
      document.getElementById('calculatedCashTips').value = '';
    }
  }

  function resetTdsData() {
    tdsDataStatus = {
      isFetching: false,
      hasData: false,
      data: 0,
      error: null
    };
    
    // Reset UI
    document.getElementById('tdsAutoFetchStatus').innerHTML = '<span style="color: #666;">Auto-calculated from Toast API when you calculate tip pool</span>';
    document.getElementById('tdsDriverTips').value = '0';
  }

  function updateCalculateButtonState() {
    const calculateBtn = document.querySelector('button[onclick="calculateTipPool()"]');
    const startDate = document.getElementById('tipPoolStartDate').value;
    const endDate = document.getElementById('tipPoolEndDate').value;
    
    if (!startDate || !endDate) {
      calculateBtn.disabled = true;
      calculateBtn.textContent = 'Calculate Tip Pool';
      calculateBtn.style.background = '#6c757d';
    } else if (tdsDataStatus.isFetching) {
      calculateBtn.disabled = true;
      calculateBtn.textContent = 'Fetching TDS Data...';
      calculateBtn.style.background = '#ffc107';
    } else if (tdsDataStatus.hasData || tdsDataStatus.error) {
      calculateBtn.disabled = false;
      calculateBtn.textContent = 'Calculate Tip Pool';
      calculateBtn.style.background = '#28a745';
    } else {
      calculateBtn.disabled = true;
      calculateBtn.textContent = 'Calculate Tip Pool';
      calculateBtn.style.background = '#6c757d';
    }
  }

  async function autoFetchTdsDriverTips(startDate, endDate, retryCount = 0) {
    // Only fetch if not already fetching for these dates
    if (tdsDataStatus.isFetching) {
      return;
    }

    console.log('Auto-fetching TDS Driver tips for date range:', startDate, 'to', endDate);
    
    tdsDataStatus.isFetching = true;
    tdsDataStatus.hasData = false;
    tdsDataStatus.error = null;
    
    // Update UI to show fetching
    document.getElementById('tdsAutoFetchStatus').innerHTML = '<span style="color: #666;">Fetching TDS driver tips...</span>';
    updateCalculateButtonState();
    
    try {
      // First authenticate with Toast - same pattern as fetchToastCashSalesForDate
      const authResponse = await fetch('/api/toast-auth', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      });
      
      if (!authResponse.ok) {
        throw new Error('Failed to authenticate with Toast API');
      }
      
      const authData = await authResponse.json();
      if (!authData.success || !authData.data?.accessToken) {
        throw new Error('Toast authentication failed');
      }
      
      // Calculate total tips across the date range
      let totalNetTips = 0;
      let totalOrderCount = 0;
      
      // Use the TDS-specific API for the entire date range (single call)
      console.log('Processing TDS fetch for entire date range:', startDate, 'to', endDate);
      
      try {
          // Use the TDS-specific API that matches comprehensive analysis exactly
          console.log(`Making TDS API call for date range with accessToken:`, authData.data.accessToken.substring(0, 20) + '...');
          const deliveryResponse = await fetch('/api/toast-tds-driver-tips', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              accessToken: authData.data.accessToken,
              startDate: startDate,
              endDate: endDate
            })
          });
          
          if (!deliveryResponse.ok) {
            if (deliveryResponse.status === 405) {
              // For 405 errors, try once more after a short delay
              if (retryCount === 0) {
                console.log('405 error encountered, retrying in 2 seconds...');
                tdsDataStatus.isFetching = false;
                await new Promise(resolve => setTimeout(resolve, 2000));
                return await autoFetchTdsDriverTips(startDate, endDate, 1);
              }
              throw new Error('TDS Driver API temporarily unavailable (405 error)');
            }
            throw new Error(`Failed to fetch TDS Driver tips: ${deliveryResponse.status}`);
          }
          
          const deliveryData = await deliveryResponse.json();
          if (deliveryData.success && deliveryData.data) {
            // Extract tips from comprehensive analysis response (single call for all dates)
            const netTips = deliveryData.data.netTips || 0;
            const grossTips = deliveryData.data.grossTips || 0;
            const voidedTips = deliveryData.data.voidedTips || 0;
            const refundedTips = deliveryData.data.refundedTips || 0;
            const orderCount = deliveryData.data.tdsDriverOrders || 0;
            
            totalNetTips = netTips; // Use NET tips (after voids/refunds)
            totalOrderCount = orderCount;
            
            console.log('TDS Driver tips fetched successfully using comprehensive analysis method:');
            console.log(`- Gross Tips: $${grossTips.toFixed(2)}`);
            console.log(`- Voided Tips: $${voidedTips.toFixed(2)}`);
            console.log(`- Refunded Tips: $${refundedTips.toFixed(2)}`);
            console.log(`- Net Tips: $${netTips.toFixed(2)}`);
            console.log(`- Orders: ${orderCount}`);
            console.log(`- Expected: $481.83 (gross) or $478.36 (net)`);
            
            // Data retrieved successfully from single comprehensive call
          }
        } catch (dayError) {
          console.warn(`Failed to fetch TDS data:`, dayError.message);
          // Set defaults if API fails
          totalNetTips = 0;
          totalOrderCount = 0;
        }
      
      // Store successful data
      tdsDataStatus.isFetching = false;
      tdsDataStatus.hasData = true;
      tdsDataStatus.data = totalNetTips;
      
      // Update the field and UI
      document.getElementById('tdsDriverTips').value = totalNetTips.toFixed(2);
      document.getElementById('tdsAutoFetchStatus').innerHTML = `<span style="color: #28a745;">Loaded: $${totalNetTips.toFixed(2)} from ${totalOrderCount} TDS orders</span>`;
      
      console.log('TDS Driver tips auto-fetched successfully:', totalNetTips);
      
    } catch (tdsError) {
      console.error('TDS Driver auto-fetch error:', tdsError);
      
      tdsDataStatus.isFetching = false;
      tdsDataStatus.error = tdsError.message;
      
      // Update UI to show error but allow calculation to proceed with 0
      document.getElementById('tdsAutoFetchStatus').innerHTML = `<span style="color: #dc3545;">Failed to fetch TDS tips: ${tdsError.message}</span>`;

      // Use 0 for TDS tips if auto-fetch fails
      document.getElementById('tdsDriverTips').value = '0';
    }
    
    // Update button state regardless of success/failure
    updateCalculateButtonState();
  }

  // Handle file upload - show status and clear API data
  function handleFileUpload() {
    const laborFile = document.getElementById('laborFile').files[0];
    const salesFile = document.getElementById('salesFile').files[0];
    const statusDiv = document.getElementById('autoFetchStatus');

    if (laborFile && salesFile) {
      // Both files uploaded - clear any API data and show success message
      apiFetchedData.laborData = null;
      apiFetchedData.salesData = null;
      statusDiv.innerHTML = '<span style="color: #28a745;">Files uploaded - will use these instead of database/API</span>';
      console.log('Files uploaded, API data cleared');
    } else if (laborFile || salesFile) {
      // Only one file - show reminder
      statusDiv.innerHTML = '<span style="color: #ffc107;">Please upload both Labor Summary CSV and Sales Summary ZIP</span>';
    } else {
      // No files - clear message
      statusDiv.innerHTML = '';
    }
  }

  // Global storage for API-fetched data
  let apiFetchedData = {
    laborData: null,
    salesData: null
  };

  // Auto-fetch function called when end date changes
  async function autoFetchOnDateChange() {
    const startDate = document.getElementById('tipPoolStartDate').value;
    const endDate = document.getElementById('tipPoolEndDate').value;

    if (!startDate || !endDate) {
      return; // Silently skip if dates not set
    }

    // CRITICAL: Skip auto-fetch if user has already uploaded files
    const laborFile = document.getElementById('laborFile').files[0];
    const salesFile = document.getElementById('salesFile').files[0];
    const hasFiles = laborFile && salesFile;

    if (hasFiles) {
      console.log('Files already uploaded - skipping auto-fetch');
      const statusDiv = document.getElementById('autoFetchStatus');
      statusDiv.innerHTML = '<span style="color: #28a745;">Using uploaded files (will bypass database and API)</span>';
      return; // User wants to use uploaded files, don't fetch!
    }

    // Show loading overlay
    const loadingOverlay = document.getElementById('loadingOverlay');
    loadingOverlay.style.display = 'flex';

    // Update status indicator
    const statusDiv = document.getElementById('autoFetchStatus');
    statusDiv.innerHTML = '<span style="color: #666;">Checking for data...</span>';

    try {
      // STEP 1: Try database first (instant if data exists)
      console.log('Checking database for sales data...');
      document.getElementById('loadingText').textContent = 'Checking database...';
      document.getElementById('loadingSubtext').textContent = 'Looking for automatically imported Toast data';

      const dbResponse = await fetch(`/api/get-daily-sales?startDate=${startDate}&endDate=${endDate}`);
      const dbResult = await dbResponse.json();

      if (dbResult.success && dbResult.hasData) {
        // Found data in database! Use it.
        console.log('Found data in database:', dbResult);
        statusDiv.innerHTML = `<span style="color: #28a745;">Data loaded from database (${dbResult.daysFound} days, automated import)</span>`;

        // Still need labor data from API
        document.getElementById('loadingText').textContent = 'Fetching labor data from Toast...';
        document.getElementById('loadingSubtext').textContent = 'Getting employee hours...';

        const authResponse = await fetch('/api/toast-auth', { method: 'POST', headers: { 'Content-Type': 'application/json' } });
        const authData = await authResponse.json();
        const token = authData.data.accessToken;

        const laborResponse = await fetch(`/api/toast-labor-summary?startDate=${startDate}&endDate=${endDate}&token=${token}`);
        const laborResult = await laborResponse.json();

        // Store data globally
        apiFetchedData.laborData = laborResult.employees;
        apiFetchedData.laborData.totalLaborCost = laborResult.totalLaborCost;
        apiFetchedData.salesData = {
          creditTips: dbResult.data.creditTips,
          creditTipsGross: dbResult.data.creditTips,
          voidedTips: 0,
          discounts: 0,
          tipsOnDiscountedChecks: 0,
          cashSales: dbResult.data.cashSales,
          netSales: dbResult.data.netSales
        };

        // Auto-fetch TDS Driver tips
        await autoFetchTdsDriverTips(startDate, endDate);

        console.log('Auto-fetch complete (database + API labor):', { laborResult, salesData: dbResult.data });
        loadingOverlay.style.display = 'none';
        return;
      }

      // STEP 2: No database data - fall back to Toast API
      console.log('No database data found, fetching from Toast API...');
      statusDiv.innerHTML = '<span style="color: #ffc107;">No database data - fetching from Toast API (slower)...</span>';

      document.getElementById('loadingText').textContent = 'Authenticating with Toast API...';
      document.getElementById('loadingSubtext').textContent = 'No automated data available for this date range';

      const authResponse = await fetch('/api/toast-auth', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      });

      if (!authResponse.ok) throw new Error('Authentication failed');
      const authData = await authResponse.json();
      if (!authData.success || !authData.data?.accessToken) throw new Error('Failed to get access token');
      const token = authData.data.accessToken;

      // Fetch labor and sales data from API
      document.getElementById('loadingText').textContent = 'Fetching labor and payment data...';
      document.getElementById('loadingSubtext').textContent = 'Processing hundreds of payments - this takes 1-2 minutes';

      const [laborResponse, salesResponse] = await Promise.all([
        fetch(`/api/toast-labor-summary?startDate=${startDate}&endDate=${endDate}&token=${token}`),
        fetch(`/api/toast-sales-summary?startDate=${startDate}&endDate=${endDate}&token=${token}`)
      ]);

      if (!laborResponse.ok || !salesResponse.ok) throw new Error('Failed to fetch data');

      const [laborResult, salesResult] = await Promise.all([
        laborResponse.json(),
        salesResponse.json()
      ]);

      // Store the fetched data globally
      apiFetchedData.laborData = laborResult.employees;
      apiFetchedData.laborData.totalLaborCost = laborResult.totalLaborCost;
      apiFetchedData.salesData = {
        creditTips: salesResult.creditTips,
        creditTipsGross: salesResult.creditTipsGross || salesResult.creditTips,
        voidedTips: salesResult.voidedTips || 0,
        discounts: salesResult.discounts || 0,
        tipsOnDiscountedChecks: salesResult.tipsOnDiscountedChecks || 0,
        cashSales: salesResult.cashSales,
        netSales: salesResult.netSales
      };

      // Show subtle success indicator
      statusDiv.innerHTML = `<span style="color: #28a745;">Data loaded from API: ${laborResult.employeesCount} employees, $${salesResult.creditTips.toFixed(2)} credit tips</span>`;

      console.log('Auto-fetch complete (API fallback):', { laborResult, salesResult });

      // Display enhanced sales summary
      console.log(`\n=== SALES SUMMARY ===`);
      console.log(`Method: ${salesResult.method || 'ordersBulk endpoint'}`);
      console.log(`Version: ${salesResult.version || 'Unknown'}`);
      console.log(`Net Sales: $${salesResult.netSales.toFixed(2)}`);

      // Handle both ordersBulk and Payments endpoint formats
      if (salesResult.creditCount !== undefined) {
        // Payments endpoint format
        console.log(`Credit Payments: ${salesResult.creditCount}, Amount: $${salesResult.creditAmount.toFixed(2)}`);
      }
      console.log(`Credit Tips: $${salesResult.creditTips.toFixed(2)}`);

      if (salesResult.creditTipsGross && salesResult.creditTipsGross !== salesResult.creditTips) {
        console.log(`  - Gross: $${salesResult.creditTipsGross.toFixed(2)}`);
      }

      if (salesResult.cashSales && salesResult.cashSales > 0) {
        const cashTipsDisplay = salesResult.cashTips !== undefined ? `, Tips: $${salesResult.cashTips.toFixed(2)}` : '';
        console.log(`Cash Sales: $${salesResult.cashSales.toFixed(2)}${cashTipsDisplay}`);
      }

      if (salesResult.otherSales && salesResult.otherSales > 0) {
        console.log(`Other Sales: $${salesResult.otherSales.toFixed(2)}, Tips: $${salesResult.otherTips.toFixed(2)}`);
      }

      if (salesResult.voidedTips && salesResult.voidedTips > 0) {
        console.log(`Voided Tips: $${salesResult.voidedTips.toFixed(2)}`);
      }

      if (salesResult.deniedPayments && salesResult.deniedPayments > 0) {
        console.log(`DENIED Payments: ${salesResult.deniedPayments}`);
      }

      if (salesResult.tipsOnDiscountedChecks && salesResult.tipsOnDiscountedChecks > 0) {
        console.log(`Tips on Discounted Checks: $${salesResult.tipsOnDiscountedChecks.toFixed(2)}`);
      }

      if (salesResult.totalTips !== undefined) {
        console.log(`Total Tips: $${salesResult.totalTips.toFixed(2)}`);
      }
      console.log(`===================\n`);

      // Auto-fetch TDS Driver tips
      await autoFetchTdsDriverTips(startDate, endDate);

      // Hide loading overlay on success
      loadingOverlay.style.display = 'none';

    } catch (error) {
      console.error('Auto-fetch error:', error);
      const statusDiv = document.getElementById('autoFetchStatus');
      statusDiv.innerHTML = '<span style="color: #dc3545;">Failed to fetch data. You can upload files manually instead.</span>';

      // Hide loading overlay on error
      loadingOverlay.style.display = 'none';
    }
  }

  // Legacy function kept for compatibility (if called elsewhere)
  async function fetchTipPoolDataFromAPI() {
    await autoFetchOnDateChange();
  }

  async function calculateTipPool() {
    const laborFile = document.getElementById('laborFile').files[0];
    const salesFile = document.getElementById('salesFile').files[0];
    const startDate = document.getElementById('tipPoolStartDate').value;
    const endDate = document.getElementById('tipPoolEndDate').value;
    const realEnvelopeDeposit = parseFloat(document.getElementById('realEnvelopeDeposit').value) || 0;
    const ezcaterTips = parseFloat(document.getElementById('ezcaterTips').value) || 0;
    const calculatedByName = document.getElementById('calculatedByName').value.trim();
    const customNotes = document.getElementById('tipPoolNotes').value.trim();

    // Fetch previous week's unpaid tip variance from database
    let previousVariance = 0;
    let carriedFromDate = null;

    console.log(`🔍 Checking for unpaid tip variance from weeks before ${endDate}...`);

    try {
      const { data: varianceData, error: varianceError } = await supabase
        .from('tip_variance')
        .select('*')
        .lt('week_ending_date', endDate)  // Only get weeks BEFORE current week
        .order('week_ending_date', { ascending: false })  // Most recent first
        .limit(1)
        .single();

      if (varianceError) {
        // No previous data found (expected on first run)
        console.log(`✅ No previous week variance data found. This is expected for the first week.`);
        console.log(`   Current week: ${startDate} to ${endDate}`);
        console.log(`   Previous variance: $0.00 (no carryover)`);
      } else if (varianceData) {
        previousVariance = parseFloat(varianceData.variance_amount) || 0;
        carriedFromDate = varianceData.week_ending_date;
        console.log(`✅ Found previous week variance!`);
        console.log(`   Current week: ${startDate} to ${endDate}`);
        console.log(`   Carrying over: $${previousVariance.toFixed(2)} from week ending ${carriedFromDate}`);
        console.log(`   This amount will be ADDED to this week's tip pool`);
      }
    } catch (err) {
      console.log(`✅ No previous variance data exists (table may not exist yet or this is the first week)`);
      console.log(`   Error: ${err.message}`);
      console.log(`   Previous variance: $0.00 (no carryover)`);
    }

    // Check if we have either files OR API-fetched data
    const hasFiles = laborFile && salesFile;
    const hasAPIData = apiFetchedData.laborData && apiFetchedData.salesData;

    if (!hasFiles && !hasAPIData) {
      showErrorMessage('Please select dates first (data will auto-fetch) OR upload files manually.');
      return;
    }

    if (!startDate || !endDate) {
      showErrorMessage('Please select both start and end dates for cash sales calculation.');
      return;
    }

    if (!realEnvelopeDeposit) {
      showErrorMessage('Please enter the Real Envelope Deposit amount.');
      return;
    }

    if (!calculatedByName) {
      showErrorMessage('Please enter your name in the "Tips Calculated By" field.');
      return;
    }

    try {
      showLoading('Calculating Tip Pool', 'Processing payroll and sales data...');

      // Use the already-fetched TDS Driver tips from global state
      const tdsDriverTips = tdsDataStatus.hasData ? tdsDataStatus.data : 0;
      
      console.log('Using TDS Driver tips from cache:', tdsDriverTips);

      // Get Toast Cash Sales from Supabase for the date range
      const start = new Date(startDate + 'T12:00:00');
      const end = new Date(endDate + 'T12:00:00');

      if (start > end) {
        throw new Error('Start date must be before end date');
      }

      const diffTime = Math.abs(end - start);
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      
      if (diffDays > 7) {
        throw new Error('Date range cannot exceed 7 days');
      }

      // Copy exact working query from generateDateRangePDF
      const { data: rangeData } = await supabase
        .from('cash_counts')
        .select('*')
        .gte('date', startDate)
        .lte('date', endDate)
        .not('pm_total', 'is', null)
        .order('date', { ascending: true });

      if (!rangeData || rangeData.length === 0) {
        throw new Error('No cash count data found for this date range');
      }

      // Get data from either files OR API
      let payrollData, creditTips, cashSales, netSales;

      if (hasFiles) {
        // Parse uploaded files
        console.log('Using uploaded files...');
        payrollData = await parsePayrollCSV(laborFile);
        const salesData = await parseSalesZip(salesFile);
        creditTips = salesData.creditTips;
        cashSales = salesData.cashSales;
        netSales = salesData.netSales;
      } else {
        // Use API-fetched data
        console.log('Using API-fetched data...');
        payrollData = apiFetchedData.laborData;
        creditTips = apiFetchedData.salesData.creditTips;
        cashSales = apiFetchedData.salesData.cashSales;
        netSales = apiFetchedData.salesData.netSales;
      }

      // Calculate total Toast cash sales
      // Use API cashSales if available, otherwise sum from daily PM data
      let totalToastCashSales = 0;
      if (!hasFiles && cashSales) {
        // Using API data - use the cashSales from API
        totalToastCashSales = cashSales;
      } else {
        // Using files or have daily data - sum from database
        totalToastCashSales = rangeData.reduce((sum, day) => sum + (day.pm_toast_sales || 0), 0);
      }

      // Calculate cash tips: Real Envelope Deposit - Toast Cash Sales
      const calculatedCashTips = realEnvelopeDeposit - totalToastCashSales;

      // Update the cash tips display
      document.getElementById('calculatedCashTips').value = calculatedCashTips.toFixed(2);

      // Calculate labor metrics
      const manualLaborCostInput = parseFloat(document.getElementById('manualLaborCost').value) || 0;
      const apiLaborCost = payrollData.totalLaborCost || 0;

      // Use manual labor cost if provided (includes CA double-time), otherwise use API
      const baseLaborCost = manualLaborCostInput > 0 ? manualLaborCostInput : apiLaborCost;

      // Log the difference for transparency
      if (manualLaborCostInput > 0 && apiLaborCost > 0) {
        const difference = manualLaborCostInput - apiLaborCost;
        console.log(`Labor Cost Comparison:`);
        console.log(`  Toast Web (manual): $${manualLaborCostInput.toFixed(2)}`);
        console.log(`  API (base wages): $${apiLaborCost.toFixed(2)}`);
        console.log(`  Difference (CA double-time): $${difference.toFixed(2)} (${(difference/apiLaborCost*100).toFixed(1)}%)`);
      }

      const demetriSalary = 85000 / 52; // $85k annual salary / 52 weeks
      const subtotalLabor = baseLaborCost + demetriSalary;
      const payrollBurden = subtotalLabor * 0.33; // 33% for taxes, insurance, etc.
      const trueTotalLaborCost = subtotalLabor + payrollBurden;
      const laborPercentage = netSales > 0 ? (trueTotalLaborCost / netSales) * 100 : 0;
      const industryBenchmark = 30.0;
      const laborVariance = laborPercentage - industryBenchmark;

      // Compute tip pool using calculated cash tips + previous variance carryover
      const result = computeTipPool(
        payrollData,
        creditTips,
        calculatedCashTips,
        ezcaterTips,
        tdsDriverTips,
        cashSales,
        previousVariance
      );

      // Store global state
      tipPoolRecords = result.records;

      // Parse date range from filename or use form dates
      let dateRange;
      if (hasFiles) {
        dateRange = parseDateRange(laborFile.name) || parseDateRange(salesFile.name);
      }
      if (!dateRange) {
        // Format: "09/29/2025 - 10/05/2025"
        const startFormatted = new Date(startDate).toLocaleDateString();
        const endFormatted = new Date(endDate).toLocaleDateString();
        dateRange = `${startFormatted} - ${endFormatted}`;
      }

      // Get voided tips info if using API
      const voidedTipsAmount = !hasFiles && apiFetchedData.salesData?.voidedTips
        ? apiFetchedData.salesData.voidedTips
        : 0;
      const creditTipsGross = !hasFiles && apiFetchedData.salesData?.creditTipsGross
        ? apiFetchedData.salesData.creditTipsGross
        : creditTips;

      tipPoolSummary = {
        creditTips: creditTips,
        creditTipsGross: creditTipsGross,
        voidedTipsTotal: voidedTipsAmount,
        cashSales: cashSales,
        cashTips: calculatedCashTips,
        realEnvelopeDeposit: realEnvelopeDeposit,
        toastCashSales: totalToastCashSales,
        ezcaterTips: ezcaterTips,
        tdsDriverTips: tdsDriverTips,
        totalTips: result.totalTips,
        pool: result.pool,
        totalWeightedHours: result.totalWeightedHours,
        hourlyRate: result.rate,
        cashNeeded: result.cashNeeded,
        dateRange: dateRange,
        calculatedByName: calculatedByName,
        customNotes: customNotes,
        generatedAt: new Date().toLocaleString(),
        // Variance tracking for compliance
        previousVariance: previousVariance,
        carriedFromDate: carriedFromDate,
        currentVariance: result.currentVariance,
        totalPaidOut: result.totalPaidOut,
        // Labor metrics for combined report
        laborData: {
          baseLaborCost: baseLaborCost,
          apiLaborCost: apiLaborCost,
          manualLaborCost: manualLaborCostInput,
          usingManualCost: manualLaborCostInput > 0,
          demetriSalary: demetriSalary,
          subtotalLabor: subtotalLabor,
          payrollBurden: payrollBurden,
          trueTotalLaborCost: trueTotalLaborCost,
          netSales: netSales,
          laborPercentage: laborPercentage,
          industryBenchmark: industryBenchmark,
          laborVariance: laborVariance
        }
      };

      // Display results for user to review
      console.log('About to render tip pool summary and table...');
      renderTipPoolSummary();
      console.log('Tip pool summary rendered');
      renderTipPoolTable();
      console.log('Tip pool table rendered');
      
      console.log('About to show tip pool results div...');
      
      // NUCLEAR OPTION: Force all possible visibility settings
      const tipPoolResultsDiv = document.getElementById('tipPoolResults');
      tipPoolResultsDiv.style.display = 'block';
      tipPoolResultsDiv.style.visibility = 'visible';
      tipPoolResultsDiv.style.opacity = '1';
      tipPoolResultsDiv.style.height = 'auto';
      tipPoolResultsDiv.style.overflow = 'visible';
      tipPoolResultsDiv.style.position = 'static';
      tipPoolResultsDiv.style.zIndex = 'auto';
      tipPoolResultsDiv.style.transform = 'none';
      tipPoolResultsDiv.style.maxHeight = 'none';
      tipPoolResultsDiv.style.width = 'auto';
      
      console.log('FORCED all visibility properties on tipPoolResults');
      
      document.getElementById('tipPoolPdfBtn').style.display = 'inline-block';
      document.getElementById('combinedReportSection').style.display = 'block';
      
      // Auto-populate combined report data from tip pool inputs
      document.getElementById('combinedStartDate').value = startDate;
      document.getElementById('combinedEndDate').value = endDate;
      document.getElementById('combinedRealEnvelope').value = realEnvelopeDeposit.toString();
      console.log('Auto-populated combined report data:', { startDate, endDate, realEnvelopeDeposit });
      
      // Removed saveTipPoolData() - tip pool fields now reset every time
      
      // Ensure tip pool form stays active
      document.getElementById('tipPoolForm').classList.add('active');
      console.log('Tip pool results div should now be visible');

      hideLoading();

      // Show success message with instruction to review equity
      showSuccessMessage('Tip pool calculated successfully! Please review and adjust equity percentages if needed, then click "Download Tip Pool PDF".');
      
      // Debug: Check if elements are still visible after success message
      setTimeout(() => {
        const resultsDiv = document.getElementById('tipPoolResults');
        const formDiv = document.getElementById('tipPoolForm');
        console.log('FINAL CHECK - Results div display:', resultsDiv.style.display);
        console.log('FINAL CHECK - Results div innerHTML length:', resultsDiv.innerHTML.length);
        console.log('FINAL CHECK - Results div offsetHeight:', resultsDiv.offsetHeight);
        console.log('FINAL CHECK - Results div scrollHeight:', resultsDiv.scrollHeight);
        console.log('FINAL CHECK - Results div computed style:', window.getComputedStyle(resultsDiv).display);
        console.log('FINAL CHECK - Form div classes:', formDiv.className);
        console.log('FINAL CHECK - Form div active?', formDiv.classList.contains('active'));
        console.log('FINAL CHECK - Results div visible?', resultsDiv.offsetHeight > 0);
        console.log('FINAL CHECK - Form div visible?', formDiv.offsetHeight > 0);
        
        // If still not visible, try scrolling to it
        if (resultsDiv.offsetHeight === 0) {
          console.log('Results div still not visible - trying to force scroll and flash');
          resultsDiv.style.border = '5px solid red';
          resultsDiv.style.backgroundColor = 'yellow';
          resultsDiv.style.minHeight = '200px';
          resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      }, 100);
      
      console.log('calculateTipPool function completed successfully');
      
    } catch (error) {
      hideLoading();
      console.error('Tip pool calculation error:', error);
      showErrorMessage(`Error: ${error.message}`);
    }
  }

  async function downloadTipPoolPDF() {
    try {
      showLoading('Generating PDF', 'Creating tip pool distribution report...');

      // Recalculate variance based on FINAL tip distribution (after equity adjustments)
      const totalPaidOut = tipPoolRecords.reduce((sum, rec) => sum + rec.due, 0);
      const currentVariance = tipPoolSummary.pool - totalPaidOut;

      console.log(`Final Variance Calculation (after equity adjustments):
        - Pool: $${tipPoolSummary.pool.toFixed(2)}
        - Total Paid Out: $${totalPaidOut.toFixed(2)}
        - Variance to carry forward: $${currentVariance.toFixed(2)}
      `);

      // Update tipPoolSummary with recalculated values
      tipPoolSummary.totalPaidOut = totalPaidOut;
      tipPoolSummary.currentVariance = currentVariance;

      // Save variance record to database (AFTER final equity adjustments)
      try {
        const endDate = document.getElementById('tipPoolEndDate').value;
        const startDate = document.getElementById('tipPoolStartDate').value;
        const varianceRecord = {
          week_ending_date: endDate,
          calculated_total: tipPoolSummary.pool,
          actual_paid_total: totalPaidOut,
          variance_amount: currentVariance,
          previous_variance: tipPoolSummary.previousVariance || 0,
          carried_from_date: tipPoolSummary.carriedFromDate || null
        };

        console.log(`💾 Saving final variance record for week ${startDate} to ${endDate}:`);
        console.log(`   Pool Total: $${tipPoolSummary.pool.toFixed(2)}`);
        console.log(`   Paid Out: $${totalPaidOut.toFixed(2)}`);
        console.log(`   Variance to carry forward: $${currentVariance.toFixed(2)}`);
        console.log(`   Previous variance included: $${(tipPoolSummary.previousVariance || 0).toFixed(2)}`);

        const { data: savedVariance, error: saveError } = await supabase
          .from('tip_variance')
          .upsert(varianceRecord, { onConflict: 'week_ending_date' })
          .select()
          .single();

        if (saveError) {
          console.error('❌ Error saving variance record:', saveError);
          showErrorMessage('Warning: Variance record could not be saved. PDF will still be generated.');
          await new Promise(resolve => setTimeout(resolve, 2000)); // Give user time to see warning
        } else {
          console.log(`✅ Variance record saved successfully!`);
          console.log(`   Record ID: ${savedVariance.id}`);
          console.log(`   Week ending: ${savedVariance.week_ending_date}`);
          console.log(`   Variance amount: $${savedVariance.variance_amount.toFixed(2)}`);
          console.log(`   This variance will be added to next week's tip pool (week after ${endDate})`);
        }
      } catch (varianceErr) {
        console.error('❌ Exception saving variance:', varianceErr);
        showErrorMessage('Warning: Variance record could not be saved. PDF will still be generated.');
        await new Promise(resolve => setTimeout(resolve, 2000));
      }

      await generateTipPoolPDF();

      hideLoading();
      showTipPoolSuccessMessage();

    } catch (error) {
      hideLoading();
      console.error('PDF generation error:', error);
      showErrorMessage(`Error generating PDF: ${error.message}`);
    }
  }

  async function downloadCombinedReportPDF() {
    try {
      const startDate = document.getElementById('combinedStartDate').value;
      const endDate = document.getElementById('combinedEndDate').value;
      const realEnvelopeAmount = parseFloat(document.getElementById('combinedRealEnvelope').value) || null;

      if (!startDate || !endDate) {
        showErrorMessage('Please select both start and end dates for the cash report period.');
        return;
      }

      if (!tipPoolRecords || tipPoolRecords.length === 0) {
        showErrorMessage('Please calculate tip pool first before generating combined report.');
        return;
      }

      showLoading('Generating Combined PDF', 'Creating combined weekly report...');

      // Fetch cash count data for the date range
      const start = new Date(startDate + 'T12:00:00');
      const end = new Date(endDate + 'T12:00:00');

      if (start > end) {
        throw new Error('Start date must be before end date');
      }

      const diffTime = Math.abs(end - start);
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      
      if (diffDays > 7) {
        throw new Error('Date range cannot exceed 7 days');
      }

      // Get cash data
      const { data: rangeData } = await supabase
        .from('cash_counts')
        .select('*')
        .gte('date', startDate)
        .lte('date', endDate)
        .not('pm_total', 'is', null)
        .order('date', { ascending: true });

      if (!rangeData || rangeData.length === 0) {
        throw new Error('No cash count data found for this date range');
      }

      // Store cash data for potential re-generation
      window.lastCombinedCashData = rangeData;
      
      // Save combined report data for persistence
      saveCombinedReportData();

      // Generate clean PDF using jsPDF (like tip pool report)
      await generateCombinedReportPDF(startDate, endDate, rangeData, realEnvelopeAmount);
      
      hideLoading();
      showSuccessMessage('Combined weekly report generated successfully!');
      
    } catch (error) {
      hideLoading();
      console.error('Combined PDF generation error:', error);
      showErrorMessage(`Error generating combined report: ${error.message}`);
    }
  }

  function parseDateRange(filename) {
    const re = /(\d{4})[_-](\d{2})[_-](\d{2})[-_](\d{4})[_-](\d{2})[_-](\d{2})/;
    const match = filename.match(re);
    if (!match) return '';
    
    const [, y1, m1, d1, y2, m2, d2] = match;
    const startMonth = parseInt(m1, 10).toString();
    const startDay = parseInt(d1, 10).toString();
    const endMonth = parseInt(m2, 10).toString();
    const endDay = parseInt(d2, 10).toString();
    
    return `${startMonth}/${startDay}—${endMonth}/${endDay} ${y2}`;
  }

  function parsePayrollCSV(file) {
    return new Promise((resolve, reject) => {
      Papa.parse(file, {
        header: true,
        skipEmptyLines: true,
        complete: function(results) {
          const data = results.data;
          const employeeMap = {};
          let totalLaborCost = 0;

          data.forEach(row => {
            const emp = row['Employee'];
            if (!emp) return;

            const regHours = parseFloat(row['Regular Hours']) || 0;
            const otHours = parseFloat(row['Overtime Hours']) || 0;
            const total = regHours + otHours;
            const totalPay = parseFloat(row['Total Pay']?.replace(',', '')) || 0;

            // Accumulate total labor cost
            totalLaborCost += totalPay;

            if (!employeeMap[emp]) {
              employeeMap[emp] = { hours: 0, regularHours: 0, overtimeHours: 0 };
            }
            employeeMap[emp].hours += total;
            employeeMap[emp].regularHours += regHours;
            employeeMap[emp].overtimeHours += otHours;
          });

          const result = [];
          for (const emp in employeeMap) {
            const parts = emp.split(',');
            const last = parts[0].trim();
            const first = parts.slice(1).join(',').trim();
            result.push({
              employee: emp,
              first: first,
              last: last,
              hours: employeeMap[emp].hours,
              regularHours: employeeMap[emp].regularHours,
              overtimeHours: employeeMap[emp].overtimeHours
            });
          }

          // Add labor cost data to result
          result.totalLaborCost = totalLaborCost;

          resolve(result);
        },
        error: function(err) {
          reject(err);
        }
      });
    });
  }

  async function parseSalesZip(file) {
    const arrayBuffer = await file.arrayBuffer();
    const zip = await JSZip.loadAsync(arrayBuffer);

    // Find Payments summary CSV and Net sales summary CSV
    let paymentsFile = null;
    let netSalesFile = null;
    zip.forEach((relativePath, zipEntry) => {
      if (relativePath.endsWith('Payments summary.csv')) {
        paymentsFile = zipEntry;
      }
      if (relativePath.endsWith('Net sales summary.csv')) {
        netSalesFile = zipEntry;
      }
    });

    // Parse Net Sales
    let netSales = 0;
    if (netSalesFile) {
      const netSalesCsv = await netSalesFile.async('string');
      const netSalesParsed = Papa.parse(netSalesCsv, { header: true, skipEmptyLines: true });
      if (netSalesParsed.data && netSalesParsed.data[0]) {
        netSales = parseFloat(netSalesParsed.data[0]['Net sales']) || 0;
      }
    }

    if (!paymentsFile) {
      return { creditTips: 0, cashSales: 0, netSales: netSales };
    }

    const paymentsCsv = await paymentsFile.async('string');
    const parsed = Papa.parse(paymentsCsv, { header: true, skipEmptyLines: true });

    let creditTips = 0;
    let cashSales = 0;

    parsed.data.forEach(row => {
      const paymentType = row['Payment type'] ? row['Payment type'].trim() : '';
      const paymentSubType = row['Payment sub type'];

      // Credit tips from detailed card types only
      if (paymentType === 'Credit/debit' && paymentSubType && paymentSubType.trim() !== '') {
        creditTips += parseFloat(row['Tips']) || 0;
      }

      if (paymentType === 'Cash') {
        cashSales += parseFloat(row['Amount']) || 0;
      }
    });

    return { creditTips, cashSales, netSales };
  }

  function computeTipPool(payrollData, creditTips, cashTips, ezcaterTips, tdsDriverTips, cashSales, previousVariance = 0) {
    // Build equity mapping
    const equityMap = {};
    payrollData.forEach(rec => {
      equityMap[rec.employee] = defaultEquity.hasOwnProperty(rec.employee)
        ? defaultEquity[rec.employee]
        : 1.0;
    });

    // Compute weighted hours
    let totalWeightedHours = 0;
    const records = payrollData.map(rec => {
      const equity = equityMap[rec.employee];
      const weighted = rec.hours * equity;
      totalWeightedHours += weighted;

      return {
        employee: rec.employee,
        first: rec.first,
        last: rec.last,
        hours: rec.hours,
        regularHours: rec.regularHours || 0,
        overtimeHours: rec.overtimeHours || 0,
        equity: equity,
        weighted: weighted,
        due: 0
      };
    });

    // Calculate pool WITH previous variance carryover
    const totalTips = creditTips + cashTips + ezcaterTips;
    const rawPool = totalTips - tdsDriverTips + previousVariance; // Add unpaid variance from previous week
    const pool = Math.floor(rawPool); // Floor to whole dollar

    // Calculate hourly rate
    const rate = totalWeightedHours ? pool / totalWeightedHours : 0;

    // Calculate due amounts (floored to whole dollars)
    let totalPaidOut = 0;
    records.forEach(r => {
      const rawDue = r.weighted * rate;
      r.due = Math.floor(rawDue);
      totalPaidOut += r.due;
    });

    // Calculate current week's variance (will be carried to next week)
    // This is the difference between the floored pool and what was actually paid out
    const currentVariance = pool - totalPaidOut;

    console.log(`Tip Pool Variance Calculation:
      - Raw Pool (with carryover): $${rawPool.toFixed(2)}
      - Floored Pool: $${pool.toFixed(2)}
      - Total Paid Out: $${totalPaidOut.toFixed(2)}
      - Current Variance (carryover to next week): $${currentVariance.toFixed(2)}
    `);

    // Calculate cash needed
    const cashNeeded = creditTips - tdsDriverTips + ezcaterTips - cashSales;

    return { records, rate, totalWeightedHours, totalTips, pool, cashNeeded, currentVariance, totalPaidOut };
  }

  function renderTipPoolSummary() {
    console.log('renderTipPoolSummary called, tipPoolSummary:', tipPoolSummary);
    const summaryDiv = document.getElementById('tipPoolSummary');
    const { cashNeeded } = tipPoolSummary;
    
    // COPY EXACT LOGIC FROM ORIGINAL TIP POOL CALCULATOR LINE 565 (CORRECT LOGIC)
    let cashStatusHtml = '';
    if (cashNeeded > 0) {
      // Need additional cash - show positive amount in red
      cashStatusHtml = `<p><strong>Cash needed to pay out tips:</strong> <span class="cash-needed">$${cashNeeded.toFixed(2)}</span></p>`;
    } else {
      // Have surplus - show positive amount in green
      cashStatusHtml = `<p><strong>Zero cash needed to pay out tips this week. Excess cash on hand:</strong> <span class="cash-surplus">$${Math.abs(cashNeeded).toFixed(2)}</span></p>`;
    }
    
    // Build variance carryover display
    let varianceCarryoverHtml = '';
    if (tipPoolSummary.previousVariance && tipPoolSummary.previousVariance > 0) {
      const carriedDate = new Date(tipPoolSummary.carriedFromDate).toLocaleDateString();
      varianceCarryoverHtml = `
          <div style="background: white; padding: 15px; border-radius: 0; border: 2px solid #ff9800; grid-column: 1 / -1;">
            <h4 style="margin: 0 0 8px 0; color: #ff9800; font-size: 12px;">⚠️ UNPAID TIPS FROM PREVIOUS WEEK</h4>
            <p style="margin: 0; font-size: 18px; font-weight: bold; color: #ff9800;">$${tipPoolSummary.previousVariance.toFixed(2)}</p>
            <p style="margin: 5px 0 0 0; font-size: 11px; color: #666;">Carried from week ending: ${carriedDate}</p>
            <p style="margin: 5px 0 0 0; font-size: 11px; font-style: italic; color: #666;">This amount has been added to this week's tip pool</p>
          </div>`;
    }

    summaryDiv.innerHTML = `
      <div style="background: #f8f9fa; padding: 20px; border-radius: 0; margin: 20px 0;">
        <h3 style="margin: 0 0 15px 0; color: #1e3c72;">Tip Pool Summary</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">

          ${varianceCarryoverHtml}

          <div style="background: white; padding: 15px; border-radius: 0; border: 1px solid #ddd;">
            <h4 style="margin: 0 0 8px 0; color: #666; font-size: 12px;">CREDIT TIPS</h4>
            <p style="margin: 0; font-size: 18px; font-weight: bold; color: #007bff;">$${tipPoolSummary.creditTips.toFixed(2)}</p>
          </div>
          
          <div style="background: white; padding: 15px; border-radius: 0; border: 1px solid #ddd;">
            <h4 style="margin: 0 0 8px 0; color: #666; font-size: 12px;">REAL ENVELOPE DEPOSIT</h4>
            <p style="margin: 0; font-size: 18px; font-weight: bold; color: #28a745;">$${tipPoolSummary.realEnvelopeDeposit.toFixed(2)}</p>
          </div>
          
          <div style="background: white; padding: 15px; border-radius: 0; border: 1px solid #ddd;">
            <h4 style="margin: 0 0 8px 0; color: #666; font-size: 12px;">TOAST CASH SALES</h4>
            <p style="margin: 0; font-size: 18px; font-weight: bold; color: #dc3545;">$${tipPoolSummary.toastCashSales.toFixed(2)}</p>
          </div>
          
          <div style="background: white; padding: 15px; border-radius: 0; border: 1px solid #ddd;">
            <h4 style="margin: 0 0 8px 0; color: #666; font-size: 12px;">CASH TIPS (CALCULATED)</h4>
            <p style="margin: 0; font-size: 18px; font-weight: bold; color: #28a745;">$${tipPoolSummary.cashTips.toFixed(2)}</p>
            <p style="margin: 5px 0 0 0; font-size: 10px; color: #666;">($${tipPoolSummary.realEnvelopeDeposit.toFixed(2)} - $${tipPoolSummary.toastCashSales.toFixed(2)})</p>
          </div>
          
          <div style="background: white; padding: 15px; border-radius: 0; border: 1px solid #ddd;">
            <h4 style="margin: 0 0 8px 0; color: #666; font-size: 12px;">TOTAL POOL</h4>
            <p style="margin: 0; font-size: 18px; font-weight: bold; color: #1e3c72;">$${tipPoolSummary.pool.toFixed(2)}</p>
          </div>
          
          <div style="background: white; padding: 15px; border-radius: 0; border: 1px solid #ddd;">
            <h4 style="margin: 0 0 8px 0; color: #666; font-size: 12px;">HOURLY RATE</h4>
            <p style="margin: 0; font-size: 18px; font-weight: bold; color: #f57c00;">$${tipPoolSummary.hourlyRate.toFixed(2)}</p>
          </div>
          
        </div>
        
        <!-- Cash Status from Original Logic -->
        <div style="margin-top: 15px; padding: 15px; background: white; border-radius: 0; border: 1px solid #ddd; text-align: center;">
          ${cashStatusHtml}
        </div>
        
        <div style="margin-top: 15px; padding: 10px; background: #e3f2fd; border-radius: 0; border-left: 4px solid #2196f3;">
          <p style="margin: 0; font-size: 14px;"><strong>Period:</strong> ${tipPoolSummary.dateRange || 'Not specified'}</p>
          <p style="margin: 5px 0 0 0; font-size: 14px;"><strong>Calculated by:</strong> ${tipPoolSummary.calculatedByName}</p>
          ${tipPoolSummary.customNotes ? `<p style="margin: 10px 0 0 0; font-size: 13px; padding-top: 8px; border-top: 1px solid #90caf9;"><strong>Notes:</strong> ${tipPoolSummary.customNotes}</p>` : ''}
        </div>

        ${tipPoolSummary.laborData ? `
        <!-- Labor Summary Section -->
        <div style="margin-top: 20px; padding: 20px; background: white; border-radius: 0; border: 2px solid #1e3c72;">
          <h3 style="margin: 0 0 15px 0; color: #1e3c72; text-transform: uppercase;">Labor Cost Analysis</h3>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">

            <!-- Left Column -->
            <div>
              <div style="padding: 10px; background: #f8f9fa; border-left: 3px solid #1e3c72; margin-bottom: 8px;">
                <div style="font-size: 11px; color: #666;">BASE LABOR COST ${tipPoolSummary.laborData.usingManualCost ? '(TOAST WEB)' : '(API)'}</div>
                <div style="font-size: 18px; font-weight: bold; color: #1e3c72;">$${tipPoolSummary.laborData.baseLaborCost.toFixed(2)}</div>
                ${tipPoolSummary.laborData.usingManualCost ? `
                  <div style="font-size: 10px; color: #28a745; margin-top: 4px;">✓ Manual cost includes CA double-time</div>
                  <div style="font-size: 9px; color: #999;">API: $${tipPoolSummary.laborData.apiLaborCost.toFixed(2)} (+$${(tipPoolSummary.laborData.manualLaborCost - tipPoolSummary.laborData.apiLaborCost).toFixed(2)})</div>
                ` : `
                  <div style="font-size: 10px; color: #ffc107; margin-top: 4px;">⚠️ May be $100-150 low (CA double-time)</div>
                `}
              </div>
              <div style="padding: 10px; background: #f8f9fa; border-left: 3px solid #6c757d; margin-bottom: 8px;">
                <div style="font-size: 11px; color: #666;">MANAGER SALARY (WEEKLY)</div>
                <div style="font-size: 18px; font-weight: bold; color: #6c757d;">$${tipPoolSummary.laborData.demetriSalary.toFixed(2)}</div>
              </div>
              <div style="padding: 10px; background: #f8f9fa; border-left: 3px solid #17a2b8; margin-bottom: 8px;">
                <div style="font-size: 11px; color: #666;">SUBTOTAL LABOR</div>
                <div style="font-size: 18px; font-weight: bold; color: #17a2b8;">$${tipPoolSummary.laborData.subtotalLabor.toFixed(2)}</div>
              </div>
              <div style="padding: 10px; background: #f8f9fa; border-left: 3px solid #ffc107; margin-bottom: 8px;">
                <div style="font-size: 11px; color: #666;">PAYROLL BURDEN (33%)</div>
                <div style="font-size: 18px; font-weight: bold; color: #f57c00;">$${tipPoolSummary.laborData.payrollBurden.toFixed(2)}</div>
              </div>
            </div>

            <!-- Right Column -->
            <div>
              <div style="padding: 10px; background: #f8f9fa; border-left: 3px solid #28a745; margin-bottom: 8px;">
                <div style="font-size: 11px; color: #666;">TRUE TOTAL LABOR COST</div>
                <div style="font-size: 18px; font-weight: bold; color: #28a745;">$${tipPoolSummary.laborData.trueTotalLaborCost.toFixed(2)}</div>
              </div>
              <div style="padding: 10px; background: #f8f9fa; border-left: 3px solid #007bff; margin-bottom: 8px;">
                <div style="font-size: 11px; color: #666;">NET SALES</div>
                <div style="font-size: 18px; font-weight: bold; color: #007bff;">$${tipPoolSummary.laborData.netSales.toFixed(2)}</div>
              </div>
              <div style="padding: 15px; background: ${tipPoolSummary.laborData.laborVariance > 0 ? '#ffebee' : '#e8f5e9'}; border-left: 4px solid ${tipPoolSummary.laborData.laborVariance > 0 ? '#dc3545' : '#28a745'}; text-align: center;">
                <div style="font-size: 11px; color: #666; margin-bottom: 5px;">LABOR PERCENTAGE</div>
                <div style="font-size: 32px; font-weight: bold; color: ${tipPoolSummary.laborData.laborVariance > 0 ? '#dc3545' : '#28a745'};">
                  ${tipPoolSummary.laborData.laborPercentage.toFixed(2)}%
                </div>
                <div style="font-size: 10px; color: #666; margin-top: 5px;">
                  Industry Benchmark: ${tipPoolSummary.laborData.industryBenchmark.toFixed(1)}%
                  <br>
                  <span style="font-weight: bold; color: ${tipPoolSummary.laborData.laborVariance > 0 ? '#dc3545' : '#28a745'};">
                    ${tipPoolSummary.laborData.laborVariance > 0 ? '▲' : '▼'} ${Math.abs(tipPoolSummary.laborData.laborVariance).toFixed(2)}%
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>
        ` : ''}
      </div>
    `;
  }

  function renderTipPoolTable() {
    console.log('renderTipPoolTable called, tipPoolRecords:', tipPoolRecords);
    const tableDiv = document.getElementById('tipPoolTable');
    
    let tableHtml = `
      <div style="margin: 16px 0;">
        <h3 style="color: var(--gray-900); margin-bottom: 8px; font-size: 14px; font-weight: 700; text-transform: uppercase; letter-spacing: 1.5px;">Employee Tip Distribution</h3>
        <p style="color: var(--gray-500); margin-bottom: 12px; font-size: 11px;">Check boxes to mark paid. Adjust equity percentages - changes save automatically.</p>
        <div style="overflow-x: auto;">
          <table id="tipPoolRecordsTable" style="width: 100%; border-collapse: collapse; background: white; border-radius: 0; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <thead>
              <tr style="background: var(--primary-blue); color: var(--gray-900);">
                <th style="padding: 8px; text-align: center; font-size: 10px; width: 30px;"></th>
                <th style="padding: 8px; text-align: left; font-size: 10px; text-transform: uppercase; letter-spacing: 1px;">#</th>
                <th style="padding: 8px; text-align: left; font-size: 10px; text-transform: uppercase; letter-spacing: 1px;">First</th>
                <th style="padding: 8px; text-align: left; font-size: 10px; text-transform: uppercase; letter-spacing: 1px;">Last</th>
                <th style="padding: 8px; text-align: center; font-size: 10px; text-transform: uppercase; letter-spacing: 1px;">Reg Hrs</th>
                <th style="padding: 8px; text-align: center; font-size: 10px; text-transform: uppercase; letter-spacing: 1px;">OT Hrs</th>
                <th style="padding: 8px; text-align: center; font-size: 10px; text-transform: uppercase; letter-spacing: 1px;">Total Hrs</th>
                <th style="padding: 8px; text-align: center; font-size: 10px; text-transform: uppercase; letter-spacing: 1px;">Equity %</th>
                <th style="padding: 8px; text-align: center; font-size: 10px; text-transform: uppercase; letter-spacing: 1px;">Weighted</th>
                <th style="padding: 8px; text-align: center; font-size: 10px; text-transform: uppercase; letter-spacing: 1px;">Tips Due</th>
              </tr>
            </thead>
            <tbody>
    `;
    
    // Sort records by last name like original
    tipPoolRecords.sort((a, b) => a.last.localeCompare(b.last));
    
    tipPoolRecords.forEach((record, index) => {
      const rowBg = index % 2 === 0 ? '#f8f9fa' : 'white';
      const equityPercent = record.equity * 100;
      // Calculate OT hours (regularHours and overtimeHours come from API)
      const regularHours = record.regularHours || 0;
      const overtimeHours = record.overtimeHours || 0;
      const totalHours = record.hours;

      // Highlight OT hours in orange if > 0
      const otStyle = overtimeHours > 0
        ? 'color: #ff8c00; font-weight: bold;'
        : '';

      tableHtml += `
        <tr data-employee="${record.employee}" style="background: ${rowBg};">
          <td style="padding: 8px; text-align: center; border-bottom: 1px solid var(--gray-300);">
            <input type="checkbox" style="width: 18px; height: 18px; cursor: pointer; accent-color: var(--primary-blue);" />
          </td>
          <td style="padding: 8px; border-bottom: 1px solid var(--gray-300); font-size: 13px; color: var(--gray-700);">${index + 1}</td>
          <td style="padding: 8px; border-bottom: 1px solid var(--gray-300); font-size: 13px; color: var(--gray-900);">${record.first}</td>
          <td style="padding: 8px; border-bottom: 1px solid var(--gray-300); font-size: 13px; font-weight: 600; color: var(--gray-900);">${record.last}</td>
          <td style="padding: 8px; text-align: center; border-bottom: 1px solid var(--gray-300); font-size: 13px; color: var(--gray-700);">${regularHours.toFixed(2)}</td>
          <td style="padding: 8px; text-align: center; border-bottom: 1px solid var(--gray-300); ${otStyle}; font-size: 13px;">${overtimeHours.toFixed(2)}</td>
          <td style="padding: 8px; text-align: center; border-bottom: 1px solid var(--gray-300); font-weight: 600; font-size: 13px; color: var(--gray-900);">${totalHours.toFixed(2)}</td>
          <td style="padding: 8px; text-align: center; border-bottom: 1px solid var(--gray-300);">
            <input type="number" name="equity" step="1" min="1" max="100" value="${equityPercent.toFixed(0)}"
                   inputmode="numeric" pattern="[0-9]*"
                   style="width: 50px; text-align: center; border: 1px solid var(--gray-300); border-radius: 0; padding: 4px; font-size: 12px;" />
          </td>
          <td style="padding: 8px; text-align: center; border-bottom: 1px solid var(--gray-300); font-size: 12px; color: var(--gray-700);">${record.weighted.toFixed(3)}</td>
          <td style="padding: 8px; text-align: center; border-bottom: 1px solid var(--gray-300); font-weight: 700; font-size: 14px; color: var(--primary-blue);">$${record.due.toFixed(2)}</td>
        </tr>
      `;
    });
    
    tableHtml += `
            </tbody>
          </table>
        </div>
      </div>
    `;
    
    tableDiv.innerHTML = tableHtml;
    
    // Attach change listeners to equity inputs - use 'blur' to prevent cursor jumping
    const inputs = tableDiv.querySelectorAll('input[name="equity"]');
    inputs.forEach(inp => {
      inp.addEventListener('blur', () => {
        recomputeTipPoolFromTable();
      });
      // Also listen for Enter key to update immediately
      inp.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          inp.blur(); // Trigger blur event
        }
      });
    });
  }

  // Recompute the tip pool when equity values are changed in the table
  function recomputeTipPoolFromTable() {
    // Read equity inputs from DOM
    const rows = document.querySelectorAll('#tipPoolRecordsTable tbody tr');
    const updatedEquity = {};
    
    rows.forEach(row => {
      const emp = row.getAttribute('data-employee');
      const eqInput = row.querySelector('input[name="equity"]');
      // The equity input represents a whole percentage (1—100). Convert it
      // to a fractional equity by dividing by 100. Use 0 if parsing fails.
      const eqPercent = parseFloat(eqInput.value);
      const eqFraction = isNaN(eqPercent) ? 0 : eqPercent / 100.0;
      updatedEquity[emp] = eqFraction;
    });
    
    // Recalculate
    let totalWeightedHours = 0;
    tipPoolRecords.forEach(r => {
      r.equity = updatedEquity[r.employee];
      r.weighted = r.hours * r.equity;
      totalWeightedHours += r.weighted;
    });
    
    // Compute the raw pool and then floor it to meet business rules
    // IMPORTANT: Include previous variance carryover in the pool
    const rawPool = tipPoolSummary.totalTips - tipPoolSummary.tdsDriverTips + (tipPoolSummary.previousVariance || 0);
    const pool = Math.floor(rawPool);
    const rate = totalWeightedHours ? pool / totalWeightedHours : 0;
    
    tipPoolRecords.forEach(r => {
      const rawDue = r.weighted * rate;
      // Round each individual's due down to the nearest whole dollar
      r.due = Math.floor(rawDue);
    });
    
    // Update summary
    tipPoolSummary.pool = pool;
    tipPoolSummary.totalWeightedHours = totalWeightedHours;
    tipPoolSummary.hourlyRate = rate;
    tipPoolSummary.cashNeeded = tipPoolSummary.creditTips - tipPoolSummary.tdsDriverTips + tipPoolSummary.ezcaterTips - tipPoolSummary.cashSales;
    
    // Removed saveTipPoolData() - tip pool fields now reset every time
    
    // Rerender summary and table
    renderTipPoolSummary();
    renderTipPoolTable();
  }

  async function generateTipPoolPDF() {
    try {
      // Create jsPDF instance
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'letter' });
      
      const pageWidth = doc.internal.pageSize.getWidth();
      const pageHeight = doc.internal.pageSize.getHeight();
      const margin = 40;
      
      // Set default font to a modern sans-serif and black text
      doc.setFont('helvetica', 'normal');
      doc.setTextColor(0, 0, 0);
      
      let currentY = margin;
      
      // Header text
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(18);
      doc.text('JAYNA SAC WEEKLY TIP POOL REPORT', margin, currentY + 15);
      doc.setFontSize(10);
      doc.setFont('helvetica', 'normal');
      
      // Use uppercase labels and values for header metadata
      const dateRange = (tipPoolSummary.dateRange || '').toUpperCase();
      doc.text(`WEEK OF: ${dateRange}`, margin, currentY + 32);
      const reporter = (tipPoolSummary.calculatedByName || '').toUpperCase();
      doc.text(`RAN BY: ${reporter}`, margin, currentY + 44);
      const timestamp = (tipPoolSummary.generatedAt || '').toUpperCase();
      doc.text(`GENERATED: ${timestamp}`, margin, currentY + 56);
      
      // Draw a thin horizontal line below header for separation
      doc.setLineWidth(0.5);
      doc.line(margin, currentY + 70, pageWidth - margin, currentY + 70);
      
      // Summary section: arrange entries in two columns
      doc.setFontSize(10);
      doc.setFont('helvetica', 'normal');
      
      // Build an array of [label, value] pairs
      const entries = [];

      // Add previous variance carryover if it exists (compliance tracking)
      if (tipPoolSummary.previousVariance && tipPoolSummary.previousVariance > 0) {
        const carriedDate = new Date(tipPoolSummary.carriedFromDate).toLocaleDateString();
        entries.push(
          ['⚠️ UNPAID TIPS FROM PREVIOUS WEEK', `$${tipPoolSummary.previousVariance.toFixed(2)}`],
          [`   Carried from week ending ${carriedDate}`, '(ADDED TO POOL)']
        );
      }

      // Standard tip pool entries
      entries.push(
        ['Cash tips', `$${tipPoolSummary.cashTips.toFixed(2)}`],
        ['EZCater tips', `$${tipPoolSummary.ezcaterTips.toFixed(2)}`],
        ['Credit tips', `$${tipPoolSummary.creditTips.toFixed(2)}`],
        ['TDS driver', `$${tipPoolSummary.tdsDriverTips.toFixed(2)}`],
        ['Cash sales', `$${tipPoolSummary.cashSales.toFixed(2)}`],
        ['Total tips', `$${tipPoolSummary.totalTips.toFixed(2)}`],
        ['Pool (minus TDS driver)', `$${tipPoolSummary.pool.toFixed(2)}`],
        ['Total weighted hours', `${tipPoolSummary.totalWeightedHours.toFixed(3)}`],
        ['Hourly rate', `$${tipPoolSummary.hourlyRate.toFixed(2)}`]
      );

      // Convert all to uppercase
      const formattedEntries = entries.map(([label, value]) => [label.toUpperCase(), value.toUpperCase()]);
      
      // Define fixed x offsets for values within each column
      const colValueOffset = 200; // points from the left edge of the column
      let summaryY = currentY + 86;
      const lineHeight = 14;
      const colSplitIndex = Math.ceil(formattedEntries.length / 2);
      const col2X = pageWidth / 2;

      // Render first column
      for (let i = 0; i < colSplitIndex; i++) {
        const [label, value] = formattedEntries[i];
        doc.setFont('helvetica', 'bold');
        doc.text(`${label}:`, margin, summaryY + i * lineHeight);
        doc.setFont('helvetica', 'normal');
        doc.text(value, margin + colValueOffset, summaryY + i * lineHeight);
      }

      // Render second column
      for (let i = colSplitIndex; i < formattedEntries.length; i++) {
        const [label, value] = formattedEntries[i];
        const rowIdx = i - colSplitIndex;
        doc.setFont('helvetica', 'bold');
        doc.text(`${label}:`, col2X, summaryY + rowIdx * lineHeight);
        doc.setFont('helvetica', 'normal');
        doc.text(value, col2X + colValueOffset, summaryY + rowIdx * lineHeight);
      }

      // Cash needed line with color coding
      const cashNeeded = tipPoolSummary.cashNeeded;
      let needLabel, needValue, textColor;

      if (cashNeeded > 0) {
        // Need additional cash - show positive number in red
        needLabel = 'CASH NEEDED TO PAY OUT TIPS';
        needValue = `$${cashNeeded.toFixed(2)}`;
        textColor = [220, 53, 69]; // Red color
      } else {
        // Have surplus - show positive number in green
        needLabel = 'ZERO CASH NEEDED TO PAY OUT TIPS THIS WEEK. EXCESS CASH ON HAND';
        needValue = `$${Math.abs(cashNeeded).toFixed(2)}`;
        textColor = [40, 167, 69]; // Green color
      }

      const summaryLines = Math.max(colSplitIndex, formattedEntries.length - colSplitIndex);
      const cashY = summaryY + summaryLines * lineHeight + 10;
      
      // Set label in bold black
      doc.setFont('helvetica', 'bold');
      doc.setTextColor(0, 0, 0);
      doc.text(`${needLabel}:`, margin, cashY);
      
      // Calculate proper positioning for the value
      let valueX = margin + colValueOffset;
      let valueY = cashY;
      
      if (needLabel.length > 35) { // Long label - put value on next line
        valueX = margin;
        valueY = cashY + lineHeight;
      }
      
      // Set value in colored italic
      doc.setFont('helvetica', 'italic');
      doc.setTextColor(textColor[0], textColor[1], textColor[2]);
      doc.text(needValue, valueX, valueY);
      
      // Reset text color back to black for the rest of the document
      doc.setTextColor(0, 0, 0);
      
      // Draw a horizontal separator before the table
      const tableStartY = cashY + 25;
      doc.setFont('helvetica', 'normal');
      doc.setLineWidth(0.5);
      doc.line(margin, tableStartY - 5, pageWidth - margin, tableStartY - 5);
      
      // Prepare table data (convert names to uppercase)
      const tableBody = tipPoolRecords.map(r => [
        r.first.toUpperCase(),
        r.last.toUpperCase(),
        r.hours.toFixed(2),
        (r.equity * 100).toFixed(0),
        r.weighted.toFixed(3),
        '$' + r.due.toFixed(2)
      ]);
      
      // Generate the table
      doc.autoTable({
        head: [['FIRST', 'LAST', 'HOURS', 'EQUITY (%)', 'WEIGHTED', 'DUE']],
        body: tableBody,
        startY: tableStartY,
        margin: { left: margin, right: margin },
        styles: { font: 'helvetica', fontSize: 8, textColor: [0, 0, 0], lineColor: [0, 0, 0], lineWidth: 0.1 },
        headStyles: { font: 'helvetica', fontStyle: 'bold', textColor: [0, 0, 0], fillColor: null },
        bodyStyles: { font: 'helvetica', textColor: [0, 0, 0], fillColor: null },
        tableWidth: 'auto'
      });
      
      // Generate filename and save
      const dateStr = tipPoolSummary.dateRange || new Date().toLocaleDateString().replace(/\//g, '-');
      const filename = `Tip_Pool_Distribution_${dateStr}.pdf`;
      doc.save(filename);
      
    } catch (error) {
      console.error('PDF generation error:', error);
      throw error;
    }
  }

  async function generateCombinedReportPDF(startDate, endDate, cashData, realEnvelopeAmount = null, cashboxTotal = null) {
    try {
      // Fetch cashbox reconciliation data
      let cashboxReconciliation = null;
      if (cashboxTotal !== null) {
        cashboxReconciliation = await getCashboxReconciliation(cashboxTotal);
      }
      
      // Create jsPDF instance
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'letter' });
      
      const pageWidth = doc.internal.pageSize.getWidth();
      const pageHeight = doc.internal.pageSize.getHeight();
      const margin = 40;
      
      // Set default font to a modern sans-serif and black text
      doc.setFont('helvetica', 'normal');
      doc.setTextColor(0, 0, 0);
      
      let currentY = margin;
      
      // Header text with tighter spacing
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(16);  // Reduced from 18
      doc.text('JAYNA GYRO COMBINED WEEKLY REPORT', margin, currentY + 12);
      doc.setFontSize(9);   // Reduced from 10
      doc.setFont('helvetica', 'normal');
      
      // Use uppercase labels and values for header metadata with tighter spacing
      const dateRange = `${startDate.toUpperCase()} TO ${endDate.toUpperCase()}`;
      doc.text(`WEEK OF: ${dateRange}`, margin, currentY + 26);  // Reduced spacing
      const reporter = (tipPoolSummary.calculatedByName || '').toUpperCase();
      doc.text(`RAN BY: ${reporter}`, margin, currentY + 36);     // Reduced spacing
      const timestamp = new Date().toLocaleString().toUpperCase();
      doc.text(`GENERATED: ${timestamp}`, margin, currentY + 46); // Reduced spacing
      
      // Draw a thin horizontal line below header for separation
      doc.setLineWidth(0.5);
      doc.line(margin, currentY + 56, pageWidth - margin, currentY + 56); // Reduced spacing
      
      // Calculate cash report totals using same logic
      let totalToastSalesReported = 0;
      let totalActualCashIn = 0;
      let totalDiscrepancy = 0;
      let totalEnvelopeDeposits = 0;
      let totalBackToCashbox = 0;

      cashData.forEach(day => {
        totalToastSalesReported += day.pm_toast_sales || 0;
        totalActualCashIn += (day.pm_total - day.am_total) || 0;
        totalDiscrepancy += day.pm_discrepancy || 0;
        totalEnvelopeDeposits += day.pm_deposit_amount || 0;
        totalBackToCashbox += (day.pm_amount_to_keep - day.am_total) || 0;
      });

      // Summary section: arrange entries in two columns with tighter spacing
      doc.setFontSize(9);   // Reduced from 10
      doc.setFont('helvetica', 'normal');
      
      // Create separate left and right column entries
      const leftColumnEntries = [
        ['Toast Cash Sales Reported', `$${totalToastSalesReported.toFixed(2)}`],
        ['Actual Cash In', `$${totalActualCashIn.toFixed(2)}`],
        ['Total Discrepancy', `$${totalDiscrepancy.toFixed(2)}`]
      ];
      
      // Add cashbox reconciliation if available
      if (cashboxReconciliation) {
        leftColumnEntries.push(['Current Cashbox Total', `$${cashboxReconciliation.currentTotal.toFixed(2)}`]);
        
        if (!cashboxReconciliation.isFirstCount && cashboxReconciliation.expectedEnding !== undefined) {
          leftColumnEntries.push(['Expected Based on Discrepancies', `$${cashboxReconciliation.expectedEnding.toFixed(2)}`]);
          leftColumnEntries.push(['Total Period Discrepancies', `$${cashboxReconciliation.totalDiscrepancies.toFixed(2)}`]);
          
          if (Math.abs(cashboxReconciliation.actualVariance) >= 0.01) {
            const varianceLabel = cashboxReconciliation.actualVariance >= 0 ? 'Unexplained Overage' : 'Unexplained Shortage';
            leftColumnEntries.push([varianceLabel, `$${Math.abs(cashboxReconciliation.actualVariance).toFixed(2)}`]);
          } else {
            leftColumnEntries.push(['Reconciliation Status', 'BALANCED']);
          }
        } else if (!cashboxReconciliation.isFirstCount) {
          // Fallback for old logic
          const varianceLabel = cashboxReconciliation.variance >= 0 ? 'Cashbox Increase' : 'Cashbox Decrease';
          leftColumnEntries.push([varianceLabel, `$${Math.abs(cashboxReconciliation.variance).toFixed(2)}`]);
        }
      } else {
        // Fallback when no cashbox data is available yet
        leftColumnEntries.push(['Cashbox Reconciliation', 'N/A - New Feature']);
      }
      
      const leftColumnMapped = leftColumnEntries.map(([label, value]) => [label.toUpperCase(), value.toUpperCase()]);

      // Build right column entries (tip pool data)
      const rightColumnEntries = [];

      // Add previous variance carryover if it exists (compliance tracking)
      if (tipPoolSummary.previousVariance && tipPoolSummary.previousVariance > 0) {
        const carriedDate = new Date(tipPoolSummary.carriedFromDate).toLocaleDateString();
        rightColumnEntries.push(
          ['⚠️ UNPAID TIPS FROM PREVIOUS WEEK', `$${tipPoolSummary.previousVariance.toFixed(2)}`],
          [`   Carried from ${carriedDate}`, '(ADDED TO POOL)']
        );
      }

      // Standard tip pool entries
      rightColumnEntries.push(
        ['Credit Tips', `$${tipPoolSummary.creditTips.toFixed(2)}`],
        ['Cash Tips', `$${tipPoolSummary.cashTips.toFixed(2)}`],
        ['EZCater Tips', `$${tipPoolSummary.ezcaterTips.toFixed(2)}`],
        ['Total Tips', `$${tipPoolSummary.totalTips.toFixed(2)}`],
        ['TDS Driver', `$${tipPoolSummary.tdsDriverTips.toFixed(2)}`],
        ['Tip Pool Total (Minus TDS)', `$${tipPoolSummary.pool.toFixed(2)}`],
        ['Hourly Rate', `$${tipPoolSummary.hourlyRate.toFixed(2)}`]
      );

      const rightColumnMapped = rightColumnEntries.map(([label, value]) => [label.toUpperCase(), value.toUpperCase()]);
      
      // Define fixed x offsets for values within each column
      const colValueOffset = 170;  // Reduced from 200
      let summaryY = currentY + 66; // Reduced from 86
      const lineHeight = 11;        // Reduced from 14
      const col2X = pageWidth / 2;
      
      // Draw left column (cash data)
      let leftColumnY = summaryY;
      for (const [label, value] of leftColumnMapped) {
        doc.setFont('helvetica', 'bold');
        doc.text(`${label}:`, margin, leftColumnY);
        doc.setFont('helvetica', 'normal');
        doc.text(value, margin + colValueOffset, leftColumnY);
        leftColumnY += lineHeight;
      }
      
      // Draw right column (tip data)
      let rightColumnY = summaryY;
      for (const [label, value] of rightColumnMapped) {
        doc.setFont('helvetica', 'bold');
        doc.text(`${label}:`, col2X + 6, rightColumnY);
        doc.setFont('helvetica', 'normal');
        doc.text(value, col2X + 6 + colValueOffset, rightColumnY);
        rightColumnY += lineHeight;
      }
      
      // Add centered Cash Needed/Surplus line below both columns with larger italic font
      const cashNeededY = Math.max(leftColumnY, rightColumnY) + 8;
      const cashNeededLabel = tipPoolSummary.cashNeeded > 0 ? 'CASH NEEDED' : 'CASH SURPLUS';
      const cashNeededValue = `$${Math.abs(tipPoolSummary.cashNeeded).toFixed(2)}`;
      const cashNeededText = `${cashNeededLabel}: ${cashNeededValue}`;
      
      // Set color and font for cash needed line
      if (tipPoolSummary.cashNeeded > 0) {
        doc.setTextColor(220, 53, 69); // Red for cash needed
      } else {
        doc.setTextColor(40, 167, 69); // Green for surplus
      }
      
      doc.setFont('helvetica', 'italic');
      doc.setFontSize(12); // 2pts bigger than normal 10pt text
      
      // Center the text between the margins
      const textWidth = doc.getTextWidth(cashNeededText);
      const centerX = (pageWidth / 2) - (textWidth / 2);
      doc.text(cashNeededText, centerX, cashNeededY);
      
      // Reset font and color
      doc.setTextColor(0, 0, 0);
      doc.setFont('helvetica', 'normal');
      doc.setFontSize(9);
      
      // Add note about cashbox reconciliation if not available
      if (!cashboxReconciliation || cashboxReconciliation.isFirstCount) {
        const noteY = cashNeededY + 8;
        doc.setFont('helvetica', 'italic');
        doc.setFontSize(7);
        doc.setTextColor(128, 128, 128); // Light gray
        
        const noteText = cashboxReconciliation ? 
          'Weekly cashbox reconciliation will be available after multiple counts are recorded.' :
          'Weekly cashbox reconciliation feature coming soon - track total cash on hand vs. daily discrepancies.';
        
        const noteWidth = doc.getTextWidth(noteText);
        const noteCenterX = (pageWidth / 2) - (noteWidth / 2);
        doc.text(noteText, noteCenterX, noteY);
        
        // Reset font and color
        doc.setTextColor(0, 0, 0);
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(9);
      }
      
      // Draw a horizontal line after summary with reduced spacing
      const postSummaryY = cashNeededY + ((!cashboxReconciliation || cashboxReconciliation.isFirstCount) ? 20 : 12); // Account for note if present
      doc.setLineWidth(0.5);
      doc.line(margin, postSummaryY, pageWidth - margin, postSummaryY);
      
      // Employee distribution table with reduced spacing
      if (tipPoolRecords && tipPoolRecords.length > 0) {
        currentY = postSummaryY + 12; // Reduced from 20
        
        const tableData = tipPoolRecords.map(record => [
          `${record.first.toUpperCase()} ${record.last.toUpperCase()}`,
          record.hours.toFixed(1),
          (record.equity * 100).toFixed(0),
          record.weighted.toFixed(1),
          `$${record.due.toFixed(2)}`
        ]);
        
        // Calculate totals for the employee table
        const totalHours = tipPoolRecords.reduce((sum, record) => sum + record.hours, 0);
        const totalWeighted = tipPoolRecords.reduce((sum, record) => sum + record.weighted, 0);
        const totalDue = tipPoolRecords.reduce((sum, record) => sum + record.due, 0);
        
        // Add totals row
        const totalsRow = [
          'TOTALS',
          totalHours.toFixed(1),
          '', // Skip equity column as it doesn't make sense to total percentages
          totalWeighted.toFixed(1),
          `$${totalDue.toFixed(2)}`
        ];
        
        const tableDataWithTotals = [...tableData, totalsRow];
        
        doc.autoTable({
          startY: currentY,
          head: [['EMPLOYEE', 'HOURS', 'EQUITY (%)', 'WEIGHTED', 'DUE']],
          body: tableDataWithTotals,
          margin: { left: margin, right: margin },
          theme: 'grid',
          headStyles: { 
            font: 'helvetica', 
            fontStyle: 'bold', 
            textColor: [0, 0, 0], 
            fillColor: [245, 245, 245],
            fontSize: 8,        // Reduced font size
            cellPadding: 3      // Reduced padding
          },
          bodyStyles: { 
            font: 'helvetica', 
            textColor: [0, 0, 0], 
            fillColor: null,
            fontSize: 8,        // Reduced font size
            cellPadding: 3      // Reduced padding
          },
          didParseCell: function(data) {
            // Apply bold styling to totals row (last row)
            if (data.row.index === tableDataWithTotals.length - 1) {
              data.cell.styles.fontStyle = 'bold';
              data.cell.styles.fillColor = [240, 240, 240]; // Light gray background for totals
            }
            
            // Color formatting for DISCREPANCY column (column index 4)
            if (data.column.index === 4 && data.row.index < tableDataWithTotals.length - 1) {
              const cellValue = data.cell.text[0];
              if (cellValue && cellValue.includes('-')) {
                // Negative discrepancy - dark pastel red and italic
                data.cell.styles.textColor = [139, 69, 19]; // Dark red
                data.cell.styles.fontStyle = 'italic';
              } else if (cellValue && cellValue.includes('+')) {
                // Positive discrepancy - dark pastel green
                data.cell.styles.textColor = [34, 139, 34]; // Dark green
              }
            }
          },
          tableWidth: 'auto'
        });
        
        currentY = doc.lastAutoTable.finalY + 10; // Reduced from 20
      }
      
      // Daily cash breakdown table
      if (cashData && cashData.length > 0) {
        const dailyTableData = cashData.map(day => {
          const actualCashIn = day.pm_total - day.am_total;
          const discrepancy = day.pm_discrepancy || 0;
          const discrepancyFormatted = discrepancy >= 0 ? `+$${discrepancy.toFixed(2)}` : `-$${Math.abs(discrepancy).toFixed(2)}`;
          const actualExcess = (day.pm_amount_to_keep || 0) - (day.am_total || 0); // Actual excess returned to cashbox
          return [
            new Date(day.date + 'T12:00:00').toLocaleDateString(),
            day.pm_counter || 'N/A',
            `$${(day.pm_toast_sales || 0).toFixed(2)}`,
            `$${actualCashIn.toFixed(2)}`,
            discrepancyFormatted,
            `$${actualExcess.toFixed(2)}`
          ];
        });
        
        // Calculate totals for numerical columns (skip DATE and NIGHT COUNTER columns)
        const totalsRow = ['TOTALS', '', '', '', '', ''];
        
        // Calculate totals for columns 2-5 (TOAST SALES, ACTUAL CASH IN, DISCREPANCY, EXCESS)
        for (let col = 2; col < 6; col++) {
          let total = 0;
          dailyTableData.forEach(row => {
            let value = row[col].replace('$', '').replace('+', '').replace('-', '').replace(',', '');
            const isNegative = row[col].includes('-');
            const numValue = parseFloat(value) || 0;
            total += isNegative ? -numValue : numValue;
          });
          
          if (col === 4) { // DISCREPANCY column - show sign and format
            const sign = total >= 0 ? '+' : '-';
            totalsRow[col] = `${sign}$${Math.abs(total).toFixed(2)}`;
          } else {
            totalsRow[col] = `$${total.toFixed(2)}`;
          }
        }
        
        // Add totals row to table data
        const tableDataWithTotals = [...dailyTableData, totalsRow];
        
        doc.autoTable({
          startY: currentY,
          head: [['DATE', 'NIGHT COUNTER', 'TOAST SALES', 'ACTUAL CASH IN', 'DISCREPANCY', 'EXCESS']],
          body: tableDataWithTotals,
          margin: { left: margin, right: margin },
          theme: 'grid',
          headStyles: { 
            font: 'helvetica', 
            fontStyle: 'bold', 
            textColor: [0, 0, 0], 
            fillColor: [245, 245, 245],
            fontSize: 7,        // Smaller font for daily table
            cellPadding: 2      // Smaller padding for daily table
          },
          bodyStyles: { 
            font: 'helvetica', 
            textColor: [0, 0, 0], 
            fillColor: null,
            fontSize: 7,        // Smaller font for daily table
            cellPadding: 2      // Smaller padding for daily table
          },
          didParseCell: function(data) {
            // Apply bold italic styling to totals row
            if (data.row.index === tableDataWithTotals.length - 1) {
              data.cell.styles.fontStyle = 'bolditalic';
              data.cell.styles.fillColor = [240, 240, 240]; // Light gray background for totals
            }
            
            // Color formatting for DISCREPANCY column (column index 4)
            if (data.column.index === 4 && data.row.index < tableDataWithTotals.length - 1) {
              const cellValue = data.cell.text[0];
              if (cellValue && cellValue.includes('-')) {
                // Negative discrepancy - dark red and italic
                data.cell.styles.textColor = [139, 69, 19]; // Dark red
                data.cell.styles.fontStyle = 'italic';
              } else if (cellValue && cellValue.includes('+')) {
                // Positive discrepancy - dark green
                data.cell.styles.textColor = [34, 139, 34]; // Dark green
              }
            }
          },
          tableWidth: 'auto'
        });
      }

      // Add 2-column section: Daily Notes (left) and Labor Summary (right)
      currentY = doc.autoTable.previous.finalY + 15;

      // Always show labor summary boxes (they will fit on page with compressed layout)
      if (true) {
        // Draw two bordered boxes side by side
        const boxHeight = 120; // Reduced from 140 to fit better
        const boxWidth = (pageWidth - (2 * margin) - 10) / 2; // 10pt gap between boxes
        const leftBoxX = margin;
        const rightBoxX = margin + boxWidth + 10;

        // Left box border (Daily Notes)
        doc.setDrawColor(0, 0, 0);
        doc.setLineWidth(1);
        doc.rect(leftBoxX, currentY, boxWidth, boxHeight, 'S');

        // Right box border (Labor Summary)
        doc.rect(rightBoxX, currentY, boxWidth, boxHeight, 'S');

        // Left box header - DAILY NOTES
        doc.setFillColor(240, 240, 240);
        doc.rect(leftBoxX, currentY, boxWidth, 20, 'F');
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(9);
        doc.setTextColor(0, 0, 0);
        const leftHeaderText = 'DAILY NOTES';
        const leftHeaderWidth = doc.getTextWidth(leftHeaderText);
        doc.text(leftHeaderText, leftBoxX + (boxWidth - leftHeaderWidth) / 2, currentY + 13);

        // Right box header - WEEKLY LABOR SUMMARY
        doc.setFillColor(240, 240, 240);
        doc.rect(rightBoxX, currentY, boxWidth, 20, 'F');
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(9);
        const rightHeaderText = 'WEEKLY LABOR SUMMARY';
        const rightHeaderWidth = doc.getTextWidth(rightHeaderText);
        doc.text(rightHeaderText, rightBoxX + (boxWidth - rightHeaderWidth) / 2, currentY + 13);

        // Horizontal line below headers
        doc.setLineWidth(1);
        doc.line(leftBoxX, currentY + 20, leftBoxX + boxWidth, currentY + 20);
        doc.line(rightBoxX, currentY + 20, rightBoxX + boxWidth, currentY + 20);

        // Left box content - Daily Notes
        let notesY = currentY + 30;
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(7);
        doc.setTextColor(0, 0, 0);

        if (cashData && cashData.length > 0) {
          let hasNotes = false;
          cashData.forEach(day => {
            const dayNotes = [];
            if (day.am_notes && day.am_notes.trim()) dayNotes.push(`AM: ${day.am_notes.trim()}`);
            if (day.pm_notes && day.pm_notes.trim()) dayNotes.push(`PM: ${day.pm_notes.trim()}`);

            if (dayNotes.length > 0) {
              hasNotes = true;
              const dateStr = new Date(day.date + 'T12:00:00').toLocaleDateString();
              doc.setFont('helvetica', 'bold');
              doc.text(dateStr, leftBoxX + 5, notesY);
              notesY += 9;
              doc.setFont('helvetica', 'normal');

              dayNotes.forEach(note => {
                const lines = doc.splitTextToSize(note, boxWidth - 10);
                lines.forEach(line => {
                  if (notesY < currentY + boxHeight - 5) {
                    doc.text(line, leftBoxX + 5, notesY);
                    notesY += 8;
                  }
                });
              });
              notesY += 3; // Space between days
            }
          });

          if (!hasNotes) {
            doc.setTextColor(150, 150, 150);
            doc.text('No notes for this period', leftBoxX + boxWidth / 2, currentY + 70, { align: 'center' });
            notesY = currentY + 80; // Position for custom notes
          }
        } else {
          doc.setTextColor(150, 150, 150);
          doc.text('No notes available', leftBoxX + boxWidth / 2, currentY + 70, { align: 'center' });
          notesY = currentY + 80; // Position for custom notes
        }

        // Add custom tip pool notes if available
        if (tipPoolSummary && tipPoolSummary.customNotes && tipPoolSummary.customNotes.trim()) {
          // Add separator line if there were daily notes
          if (notesY > currentY + 30) {
            doc.setDrawColor(200, 200, 200);
            doc.setLineWidth(0.5);
            doc.line(leftBoxX + 10, notesY - 5, leftBoxX + boxWidth - 10, notesY - 5);
          }

          // Custom notes header
          doc.setFont('helvetica', 'bold');
          doc.setFontSize(7);
          doc.setTextColor(0, 0, 0);
          doc.text('TIP POOL NOTES:', leftBoxX + 5, notesY + 5);
          notesY += 12;

          // Custom notes content
          doc.setFont('helvetica', 'normal');
          doc.setFontSize(7);
          const noteLines = doc.splitTextToSize(tipPoolSummary.customNotes.trim(), boxWidth - 10);
          noteLines.forEach(line => {
            if (notesY < currentY + boxHeight - 5) {
              doc.text(line, leftBoxX + 5, notesY);
              notesY += 8;
            }
          });
        }

        // Right box content - Labor Summary (clean and simple)
        let laborY = currentY + 30;
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(7);
        doc.setTextColor(0, 0, 0);

        if (tipPoolSummary.laborData) {
          const ld = tipPoolSummary.laborData;

          // Compact labor breakdown
          const laborEntries = [
            ['Base Labor Cost:', `$${ld.baseLaborCost.toFixed(2)}`],
            ['Manager Salary (prorated):', `$${ld.demetriSalary.toFixed(2)}`],
            ['Subtotal:', `$${ld.subtotalLabor.toFixed(2)}`],
            ['Payroll Burden (33%):', `$${ld.payrollBurden.toFixed(2)}`]
          ];

          laborEntries.forEach(([label, value]) => {
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(7);
            doc.setTextColor(0, 0, 0);
            doc.text(label, rightBoxX + 5, laborY);
            doc.setFont('helvetica', 'bold');
            doc.text(value, rightBoxX + boxWidth - 5, laborY, { align: 'right' });
            laborY += 8;
          });

          // Line before total
          doc.setLineWidth(0.5);
          doc.setDrawColor(200, 200, 200);
          doc.line(rightBoxX + 5, laborY + 2, rightBoxX + boxWidth - 5, laborY + 2);
          laborY += 8;

          // True Total Labor Cost
          doc.setFont('helvetica', 'bold');
          doc.setFontSize(8);
          doc.setTextColor(0, 0, 0);
          doc.text('True Total Labor Cost:', rightBoxX + 5, laborY);
          doc.text(`$${ld.trueTotalLaborCost.toFixed(2)}`, rightBoxX + boxWidth - 5, laborY, { align: 'right' });
          laborY += 12;

          // Net Sales and Labor %
          const isOverBudget = ld.laborVariance > 0;
          const textColor = isOverBudget ? [220, 53, 69] : [40, 167, 69];

          // Background bar
          doc.setFillColor(245, 245, 245);
          doc.rect(rightBoxX + 5, laborY, boxWidth - 10, 24, 'F');

          doc.setFont('helvetica', 'normal');
          doc.setFontSize(7);
          doc.setTextColor(0, 0, 0);
          doc.text('NET SALES', rightBoxX + 10, laborY + 7);
          doc.setFont('helvetica', 'bold');
          doc.text(`$${ld.netSales.toFixed(2)}`, rightBoxX + boxWidth - 10, laborY + 7, { align: 'right' });

          doc.setFont('helvetica', 'normal');
          doc.setFontSize(7);
          doc.setTextColor(100, 100, 100);
          doc.text('LABOR PERCENTAGE', rightBoxX + 10, laborY + 15);

          doc.setFont('helvetica', 'bold');
          doc.setFontSize(9);
          doc.setTextColor(textColor[0], textColor[1], textColor[2]);
          doc.text(`${ld.laborPercentage.toFixed(2)}%`, rightBoxX + boxWidth - 10, laborY + 15, { align: 'right' });

          // Variance note (smaller)
          laborY += 26;
          doc.setFont('helvetica', 'normal');
          doc.setFontSize(6);
          doc.setTextColor(100, 100, 100);
          const varianceText = `Target: 30.00% | ${ld.laborVariance > 0 ? '+' : ''}${ld.laborVariance.toFixed(2)}% ${isOverBudget ? 'over' : 'under'}`;
          doc.text(varianceText, rightBoxX + boxWidth / 2, laborY, { align: 'center' });

        } else {
          doc.setTextColor(150, 150, 150);
          doc.text('Labor data not available', rightBoxX + boxWidth / 2, currentY + 70, { align: 'center' });
          doc.setFont('helvetica', 'normal');
          doc.setFontSize(6);
          doc.text('Calculate tip pool first', rightBoxX + boxWidth / 2, currentY + 80, { align: 'center' });
        }

        // Move currentY past the boxes
        currentY += boxHeight + 20;
      }

      // Add developer credit - centered, bold, black
      if (currentY < pageHeight - 30) {
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(8);
        doc.setTextColor(0, 0, 0); // Black
        const creditText = 'Report Generation App designed and coded by Demetri Gregorakis';
        const emailText = 'demetri_gregorakis@icloud.com for troubleshooting';

        const creditWidth = doc.getTextWidth(creditText);
        const emailWidth = doc.getTextWidth(emailText);
        const centerXCredit = (pageWidth - creditWidth) / 2;
        const centerXEmail = (pageWidth - emailWidth) / 2;

        doc.text(creditText, centerXCredit, currentY);
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(7);
        doc.text(emailText, centerXEmail, currentY + 12);
      }
      
      // Add payday sign off sheet as page 2
      generatePaydaySignOffPage(doc, startDate, endDate);

      // Return PDF data for potential merging, or save directly if no attachments
      // Use actual form dates for filename (not CSV parsed dates which may be off by 1 day)
      const dateStr = `${startDate}_to_${endDate}`.replace(/-/g, '_');
      const filename = `Combined_Weekly_Report_${dateStr}.pdf`;
      
      return {
        doc: doc,
        filename: filename,
        pdfBytes: doc.output('arraybuffer')
      };
      
    } catch (error) {
      console.error('Combined PDF generation error:', error);
      throw error;
    }
  }

  // Save ALL Weekly Combined Report Data to Database
  async function saveWeeklyCombinedReportData(startDate, endDate, cashData, realEnvelopeAmount, cashboxTotal, cashReportHtml = null, tipPoolHtml = null) {
    try {
      if (!supabase) {
        console.log('Supabase not available - skipping data save');
        return;
      }

      // Prepare comprehensive report data
      const reportData = {
        // Report metadata
        week_start_date: startDate,
        week_end_date: endDate,
        generated_by: tipPoolSummary.calculatedByName || 'Unknown',
        generated_at: new Date().toISOString(),
        real_envelope_amount: realEnvelopeAmount,
        cashbox_total: cashboxTotal,
        
        // Tip Pool Summary Data
        total_toast_sales: tipPoolSummary.toastSalesReported || 0,
        actual_cash_in: tipPoolSummary.actualCashIn || 0,
        total_discrepancy: tipPoolSummary.totalDiscrepancy || 0,
        envelope_deposits: tipPoolSummary.envelopeDeposits || 0,
        credit_tips: tipPoolSummary.creditTips || 0,
        cash_tips: tipPoolSummary.cashTips || 0,
        ezcater_tips: tipPoolSummary.ezcaterTips || 0,
        total_tips: tipPoolSummary.totalTips || 0,
        tds_driver_tips: tipPoolSummary.tdsDriverTips || 0,
        tip_pool_total: tipPoolSummary.tipPoolTotal || 0,
        hourly_rate: tipPoolSummary.hourlyRate || 0,
        cash_needed: tipPoolSummary.cashNeeded || 0,
        
        // Additional tip pool fields
        calculated_cash_tips: tipPoolSummary.calculatedCashTips || 0,
        total_weighted_hours: tipPoolSummary.totalWeightedHours || 0,
        total_hours_worked: tipPoolSummary.totalHoursWorked || 0,
        
        // Employee data as JSON
        employee_tip_data: JSON.stringify(tipPoolRecords || []),
        
        // Daily cash breakdown as JSON
        daily_cash_breakdown: JSON.stringify(cashData || []),
        
        // System metadata
        report_version: '3.0',
        has_attachments: false, // Will be updated if attachments exist
        
        // Store the generated HTML content for easy retrieval
        generated_cash_report_html: cashReportHtml,
        generated_tip_pool_html: tipPoolHtml
      };

      // Save main report data
      const { data: savedReport, error: reportError } = await supabase
        .from('weekly_combined_reports')
        .insert([reportData])
        .select()
        .single();

      if (reportError) {
        console.error('Error saving weekly report:', reportError);
        throw reportError;
      }

      console.log('Weekly combined report data saved successfully:', savedReport.id);
      
      // Save individual employee records for easier querying
      if (tipPoolRecords && tipPoolRecords.length > 0) {
        const employeeRecords = tipPoolRecords.map(employee => ({
          weekly_report_id: savedReport.id,
          week_start_date: startDate,
          week_end_date: endDate,
          employee_first_name: employee.first,
          employee_last_name: employee.last,
          hours_worked: employee.hours,
          regular_hours: employee.regularHours || 0,
          overtime_hours: employee.overtimeHours || 0,
          equity_percentage: employee.equity,
          weighted_hours: employee.weighted,
          tips_due: employee.due,
          created_at: new Date().toISOString()
        }));

        const { error: employeeError } = await supabase
          .from('weekly_employee_tips')
          .insert(employeeRecords);

        if (employeeError) {
          console.error('Error saving employee tip records:', employeeError);
          // Don't throw here - main report is saved
        } else {
          console.log(`Saved ${employeeRecords.length} employee tip records`);
        }
      }

      // Save daily cash breakdown records
      if (cashData && cashData.length > 0) {
        console.log('Preparing daily breakdown records from cashData:', cashData);
        
        // Filter to only include days with meaningful PM data
        const validDays = cashData.filter(day => 
          day.pm_total && day.pm_total > 0 && 
          day.pm_toast_sales && day.pm_toast_sales > 0
        );
        
        console.log(`Filtered to ${validDays.length} days with valid PM data out of ${cashData.length} total days`);
        
        const dailyRecords = validDays.map(day => {
          console.log('Processing day:', day);
          return {
            weekly_report_id: savedReport.id,
            date: day.date,
            night_counter: day.pm_counter || day.night_counter_name || 'Unknown',
            toast_sales: parseFloat(day.pm_toast_sales) || 0,
            actual_cash_in: parseFloat(day.pm_total) || 0,
            discrepancy: parseFloat(day.pm_discrepancy) || 0,
            excess: parseFloat(day.pm_drawer_over_amount) || 0,
            created_at: new Date().toISOString()
          };
        });
        
        console.log('Final daily records to insert:', dailyRecords);

        const { error: dailyError } = await supabase
          .from('weekly_daily_breakdown')
          .insert(dailyRecords);

        if (dailyError) {
          console.error('Error saving daily breakdown records:', dailyError);
          // Don't throw here - main report is saved
        } else {
          console.log(`Saved ${dailyRecords.length} daily breakdown records`);
        }
      }

      return savedReport.id;

    } catch (error) {
      console.error('Error saving weekly combined report data:', error);
      throw error;
    }
  }

  // Generate Payday Sign Off Sheet as PDF page
  function generatePaydaySignOffPage(doc, startDate, endDate) {
    try {
      // Add new page for payday sign off
      doc.addPage();
      
      const pageWidth = doc.internal.pageSize.getWidth();
      const margin = 40;
      let currentY = margin;
      
      // Header
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(18);
      doc.setTextColor(0, 0, 0);
      doc.text('JAYNA GYRO EMPLOYEE TIP OUT ACKNOWLEDGEMENT', margin, currentY + 15);
      
      // Week of section
      currentY += 35;
      doc.setFontSize(13);
      doc.text('WEEK OF', margin, currentY);
      doc.setFont('helvetica', 'normal');
      const weekRange = `${startDate.toUpperCase()} - ${endDate.toUpperCase()}`;
      doc.text(weekRange, margin + 80, currentY);
      
      // Disclaimer text - compressed for space
      currentY += 20;
      doc.setFontSize(7);
      doc.setFont('helvetica', 'normal');
      const disclaimerLines = [
        'As an employee, ensure accuracy in your working hours, compensation, and breaks. Please review the following:',
        '',
        'I have reviewed my hours worked and have been provided with a copy if requested.',
        'The tip amount in cash I was given is accurate and complete.',
        'All details in the timekeeping system including tip amounts, breaks, meal periods, and overtime are correct.',
        '',
        'If any information is incorrect or if I have not been provided a meal or rest break, I will document it below.',
        'It is not mandatory to note missed meal breaks if I worked less than six hours or have signed a meal break waiver.',
        'I am not required to document missed breaks if they were made available but I chose not to take them.'
      ];

      disclaimerLines.forEach((line, index) => {
        if (line !== '') {
          doc.text(line, margin, currentY + (index * 8));
        }
      });
      
      // Employee signature table
      currentY += disclaimerLines.length * 8 + 15;

      // Table headers
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(11);
      doc.text('EMPLOYEE NAME', margin, currentY);
      doc.text('EMPLOYEE SIGNATURE', margin + 250, currentY);

      // Line under headers
      currentY += 5;
      doc.line(margin, currentY, pageWidth - margin, currentY);

      // Employee rows - get from tip pool records
      currentY += 12;
      doc.setFont('helvetica', 'normal');
      doc.setFontSize(9);

      // Create employee list from tip pool records
      const employees = tipPoolRecords.map(record => ({
        first: record.first,
        last: record.last
      }));

      // Sort alphabetically by first name
      employees.sort((a, b) => a.first.localeCompare(b.first));

      employees.forEach((employee, index) => {
        const rowHeight = 22; // Reduced from 25 to 22
        const yPos = currentY + (index * rowHeight);

        // Alternating row background - aligned with text baseline
        if (index % 2 === 1) {
          doc.setFillColor(232, 240, 254); // Light blue background
          doc.rect(margin - 5, yPos - 8, pageWidth - 2 * margin + 10, rowHeight, 'F');
        }

        // Employee name
        doc.setTextColor(0, 0, 0);
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(9);
        doc.text(`${employee.first} ${employee.last}`, margin, yPos);

        // Signature line - positioned at same baseline as employee name for signing on top
        doc.setDrawColor(0, 0, 0);
        doc.line(margin + 250, yPos, pageWidth - margin - 10, yPos);
      });
      
      return doc;
      
    } catch (error) {
      console.error('Error generating payday sign off sheet:', error);
      throw error;
    }
  }

  // PDF Merging Function
  async function mergePDFsWithAttachments(mainPdfData, voidsFile = null, extrasFile = null) {
    try {
      const { PDFDocument } = PDFLib;
      
      // Create new PDF document
      const mergedPdf = await PDFDocument.create();
      
      // Add main report pages
      const mainPdf = await PDFDocument.load(mainPdfData.pdfBytes);
      const mainPages = await mergedPdf.copyPages(mainPdf, mainPdf.getPageIndices());
      mainPages.forEach((page) => mergedPdf.addPage(page));
      
      // Add Voids Log if uploaded
      if (voidsFile) {
        const voidsArrayBuffer = await voidsFile.arrayBuffer();
        const voidsPdf = await PDFDocument.load(voidsArrayBuffer);
        const voidsPages = await mergedPdf.copyPages(voidsPdf, voidsPdf.getPageIndices());
        voidsPages.forEach((page) => mergedPdf.addPage(page));
      }
      
      // Add Extras if uploaded
      if (extrasFile) {
        const extrasArrayBuffer = await extrasFile.arrayBuffer();
        const extrasPdf = await PDFDocument.load(extrasArrayBuffer);
        const extrasPages = await mergedPdf.copyPages(extrasPdf, extrasPdf.getPageIndices());
        extrasPages.forEach((page) => mergedPdf.addPage(page));
      }
      
      // Save merged PDF
      const mergedPdfBytes = await mergedPdf.save();
      const blob = new Blob([mergedPdfBytes], { type: 'application/pdf' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = mainPdfData.filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      return true;
    } catch (error) {
      console.error('PDF merging error:', error);
      throw new Error(`Failed to merge PDFs: ${error.message}`);
    }
  }

  function generateTipPoolReportHtml() {
    const { cashNeeded } = tipPoolSummary;
    
    // COPY EXACT LOGIC FROM ORIGINAL TIP POOL CALCULATOR LINE 565 (CORRECT LOGIC)
    let cashStatusText = '';
    let cashStatusClass = '';
    if (cashNeeded > 0) {
      // Need additional cash - show positive amount in red
      cashStatusText = 'NEEDED';
      cashStatusClass = 'color: #dc3545';
    } else {
      // Have surplus - show positive amount in green
      cashStatusText = 'SURPLUS';
      cashStatusClass = 'color: #28a745';
    }
    
    return `
      <div style="font-family: Arial, sans-serif; padding: 20px; background: white;">
        <div style="text-align: center; margin-bottom: 30px; border-bottom: 3px solid #1e3c72; padding-bottom: 20px;">
          <h1 style="margin: 0; color: #1e3c72; font-size: 24px;">JAYNA GYRO TIP POOL DISTRIBUTION</h1>
          <h2 style="margin: 10px 0 0 0; color: #666; font-size: 14px; font-weight: normal;">
            Period: ${tipPoolSummary.dateRange || 'Not specified'}
          </h2>
        </div>
        
        <!-- Summary Section -->
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 30px;">
          <div style="background: #f8f9fa; padding: 15px; border: 2px solid #007bff; border-radius: 0; text-align: center;">
            <h4 style="margin: 0 0 8px 0; color: #007bff; font-size: 12px;">CREDIT TIPS</h4>
            <p style="font-size: 18px; font-weight: bold; margin: 0; color: #007bff;">$${tipPoolSummary.creditTips.toFixed(2)}</p>
          </div>
          
          <div style="background: #f8f9fa; padding: 15px; border: 2px solid #28a745; border-radius: 0; text-align: center;">
            <h4 style="margin: 0 0 8px 0; color: #28a745; font-size: 12px;">CASH TIPS</h4>
            <p style="font-size: 18px; font-weight: bold; margin: 0; color: #28a745;">$${tipPoolSummary.cashTips.toFixed(2)}</p>
          </div>
          
          <div style="background: #f8f9fa; padding: 15px; border: 2px solid #f57c00; border-radius: 0; text-align: center;">
            <h4 style="margin: 0 0 8px 0; color: #f57c00; font-size: 12px;">EZCATER TIPS</h4>
            <p style="font-size: 18px; font-weight: bold; margin: 0; color: #f57c00;">$${tipPoolSummary.ezcaterTips.toFixed(2)}</p>
          </div>
        </div>
        
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 30px;">
          <div style="background: #f8f9fa; padding: 15px; border: 2px solid #1e3c72; border-radius: 0; text-align: center;">
            <h4 style="margin: 0 0 8px 0; color: #1e3c72; font-size: 12px;">TOTAL POOL</h4>
            <p style="font-size: 20px; font-weight: bold; margin: 0; color: #1e3c72;">$${tipPoolSummary.pool.toFixed(2)}</p>
          </div>
          
          <div style="background: #f8f9fa; padding: 15px; border: 2px solid #6c757d; border-radius: 0; text-align: center;">
            <h4 style="margin: 0 0 8px 0; color: #6c757d; font-size: 12px;">HOURLY RATE</h4>
            <p style="font-size: 18px; font-weight: bold; margin: 0; color: #6c757d;">$${tipPoolSummary.hourlyRate.toFixed(2)}</p>
          </div>
          
          <div style="background: #f8f9fa; padding: 15px; border: 2px solid ${cashNeeded > 0 ? '#dc3545' : '#28a745'}; border-radius: 0; text-align: center;">
            <h4 style="margin: 0 0 8px 0; ${cashStatusClass}; font-size: 12px;">CASH ${cashStatusText}</h4>
            <p style="font-size: 18px; font-weight: bold; margin: 0; ${cashStatusClass};">$${Math.abs(cashNeeded).toFixed(2)}</p>
          </div>
        </div>
        
        <!-- Employee Distribution Table -->
        <div style="margin-bottom: 30px;">
          <h3 style="color: #1e3c72; margin-bottom: 15px; border-bottom: 2px solid #1e3c72; padding-bottom: 5px;">
            EMPLOYEE TIP DISTRIBUTION
          </h3>
          
          <table style="width: 100%; border-collapse: collapse; border: 2px solid #000;">
            <thead>
              <tr style="background: #1e3c72; color: white;">
                <th style="padding: 12px; text-align: left; border: 1px solid #000; font-size: 12px;">EMPLOYEE</th>
                <th style="padding: 12px; text-align: center; border: 1px solid #000; font-size: 12px;">HOURS</th>
                <th style="padding: 12px; text-align: center; border: 1px solid #000; font-size: 12px;">EQUITY</th>
                <th style="padding: 12px; text-align: center; border: 1px solid #000; font-size: 12px;">WEIGHTED HOURS</th>
                <th style="padding: 12px; text-align: center; border: 1px solid #000; font-size: 12px;">TIPS DUE</th>
              </tr>
            </thead>
            <tbody>
    `;
    
    tipPoolRecords.forEach((record, index) => {
      const rowBg = index % 2 === 0 ? '#f8f9fa' : 'white';
      return `
        <tr style="background: ${rowBg};">
          <td style="padding: 10px; border: 1px solid #000; font-weight: bold;">${record.first} ${record.last}</td>
          <td style="padding: 10px; text-align: center; border: 1px solid #000;">${record.hours.toFixed(1)}</td>
          <td style="padding: 10px; text-align: center; border: 1px solid #000;">${record.equity.toFixed(2)}</td>
          <td style="padding: 10px; text-align: center; border: 1px solid #000;">${record.weighted.toFixed(1)}</td>
          <td style="padding: 10px; text-align: center; border: 1px solid #000; font-weight: bold; color: #28a745; font-size: 16px;">$${record.due.toFixed(2)}</td>
        </tr>
      `;
    }).join('') + `
            </tbody>
          </table>
        </div>
        
        <!-- Footer -->
        <div style="text-align: center; margin-top: 30px; padding-top: 20px; border-top: 2px solid #ddd; color: #666; font-size: 12px;">
          <p style="margin: 0;">Tips calculated by: <strong>${tipPoolSummary.calculatedByName}</strong></p>
          <p style="margin: 5px 0 0 0;">Generated: ${tipPoolSummary.generatedAt}</p>
          <p style="margin: 5px 0 0 0;">Jayna Gyro Cash Counter & Tip Pool System v2.86</p>
        </div>
      </div>
    `;
  }

  async function generateCombinedReport() {
    const startDate = document.getElementById('combinedStartDate').value;
    const endDate = document.getElementById('combinedEndDate').value;
    const realEnvelopeAmount = parseFloat(document.getElementById('combinedRealEnvelope').value) || null;

    console.log('generateCombinedReport called with auto-populated data:', { startDate, endDate, realEnvelopeAmount });

    if (!startDate || !endDate) {
      showErrorMessage('Please select both start and end dates for the cash report period.');
      return;
    }

    if (!tipPoolRecords || tipPoolRecords.length === 0) {
      showErrorMessage('Please calculate tip pool first before generating combined report.');
      return;
    }

    // Prompt for current cashbox count (only if user wants to use this feature)
    const shouldPromptCashbox = confirm(
      'NEW FEATURE: Weekly Cashbox Reconciliation\\n\\n' +
      'Would you like to enter your current cashbox total for weekly tracking?\\n\\n' +
      '• This feature tracks total cash on hand (not just registers)\\n' +
      '• Helps reconcile weekly cashbox changes vs daily discrepancies\\n' +
      '• Optional - you can skip for now and start using it later\\n\\n' +
      'Click OK to enter cashbox amount, or Cancel to skip.'
    );
    
    let cashboxTotal = null;
    if (shouldPromptCashbox) {
      const cashboxAmount = prompt(
        'Enter current total cashbox amount:\\n\\n' +
        'Count all cash and coins in the cashbox and enter the total amount.\\n' +
        'This will be used to track weekly cashbox changes.\\n\\n' +
        'Amount (e.g., 1234.56):',
        ''
      );
      
      if (cashboxAmount === null) {
        return; // User cancelled
      }
      
      cashboxTotal = parseFloat(cashboxAmount);
      if (isNaN(cashboxTotal) || cashboxTotal < 0) {
        showErrorMessage('Please enter a valid cashbox amount (numbers only, no $ sign).');
        return;
      }
    }

    try {
      showLoading('Generating Combined Report', 'Fetching cash count data and combining with tip pool...');

      // Save cashbox count to database if provided
      if (cashboxTotal !== null) {
        await saveCashboxCountFromReport(cashboxTotal);
      }

      // Fetch cash count data for the date range (reusing existing logic)
      const start = new Date(startDate + 'T12:00:00');
      const end = new Date(endDate + 'T12:00:00');

      if (start > end) {
        throw new Error('Start date must be before end date');
      }

      const diffTime = Math.abs(end - start);
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      
      if (diffDays > 7) {
        throw new Error('Date range cannot exceed 7 days');
      }

      // Copy exact working query from generateDateRangePDF
      const { data: rangeData } = await supabase
        .from('cash_counts')
        .select('*')
        .gte('date', startDate)
        .lte('date', endDate)
        .not('pm_total', 'is', null)
        .order('date', { ascending: true });

      if (!rangeData || rangeData.length === 0) {
        throw new Error('No cash count data found for this date range');
      }

      // Store cash data for potential re-generation
      window.lastCombinedCashData = rangeData;
      
      // Save combined report data for persistence
      saveCombinedReportData();

      // Generate the HTML content first
      const cashReportHtml = generateDateRangeReportHtml(startDate, endDate, rangeData, realEnvelopeAmount);
      
      // Get tip pool HTML and clean ONLY for saving (don't modify the original DOM)
      let tipPoolHtml = document.getElementById('tipPoolResults').innerHTML;
      
      // Create a clean copy for saving without affecting the live DOM
      let cleanTipPoolHtml = tipPoolHtml;
      cleanTipPoolHtml = cleanTipPoolHtml.replace(/<div[^>]*id="combinedReportSection"[^>]*>.*?<\/div>/gs, '');
      cleanTipPoolHtml = cleanTipPoolHtml.replace(/Weekly Combined Report[\s\S]*?Generate Combined Weekly Report/g, '');
      cleanTipPoolHtml = cleanTipPoolHtml.replace(/Download PDF Back to Menu/g, '');
      
      // SAVE TIP VARIANCE TO DATABASE (for compliance tracking)
      if (tipPoolRecords && tipPoolRecords.length > 0) {
        try {
          // Recalculate variance based on FINAL tip distribution (after any equity adjustments)
          const totalPaidOut = tipPoolRecords.reduce((sum, rec) => sum + rec.due, 0);
          const currentVariance = tipPoolSummary.pool - totalPaidOut;

          console.log(`💾 Saving final variance record for week ${startDate} to ${endDate}:`);
          console.log(`   Pool Total: $${tipPoolSummary.pool.toFixed(2)}`);
          console.log(`   Paid Out: $${totalPaidOut.toFixed(2)}`);
          console.log(`   Variance to carry forward: $${currentVariance.toFixed(2)}`);
          console.log(`   Previous variance included: $${(tipPoolSummary.previousVariance || 0).toFixed(2)}`);

          const varianceRecord = {
            week_ending_date: endDate,
            calculated_total: tipPoolSummary.pool,
            actual_paid_total: totalPaidOut,
            variance_amount: currentVariance,
            previous_variance: tipPoolSummary.previousVariance || 0,
            carried_from_date: tipPoolSummary.carriedFromDate || null
          };

          const { data: savedVariance, error: saveError } = await supabase
            .from('tip_variance')
            .upsert(varianceRecord, { onConflict: 'week_ending_date' })
            .select()
            .single();

          if (saveError) {
            console.error('❌ Error saving variance record:', saveError);
          } else {
            console.log(`✅ Variance record saved successfully!`);
            console.log(`   Record ID: ${savedVariance.id}`);
            console.log(`   Week ending: ${savedVariance.week_ending_date}`);
            console.log(`   Variance amount: $${savedVariance.variance_amount.toFixed(2)}`);
            console.log(`   This variance will be added to next week's tip pool (week after ${endDate})`);
          }
        } catch (varianceErr) {
          console.error('❌ Exception saving variance:', varianceErr);
        }
      }

      // SAVE ALL DATA TO DATABASE BEFORE PDF GENERATION
      console.log('Saving comprehensive weekly report data to database...');
      try {
        const savedReportId = await saveWeeklyCombinedReportData(startDate, endDate, rangeData, realEnvelopeAmount, cashboxTotal, cashReportHtml, cleanTipPoolHtml);
        console.log(`Weekly report data saved successfully with ID: ${savedReportId}`);
      } catch (saveError) {
        console.error('Warning: Failed to save report data to database:', saveError);
        // Don't stop PDF generation if database save fails
      }

      // Check for uploaded PDF attachments
      const voidsLogFile = document.getElementById('voidsLogUpload').files[0];
      const extrasFile = document.getElementById('extrasUpload').files[0];
      
      // Generate main PDF report
      const mainPdfData = await generateCombinedReportPDF(startDate, endDate, rangeData, realEnvelopeAmount, cashboxTotal);
      
      // If attachments exist, merge them; otherwise save main PDF directly
      if (voidsLogFile || extrasFile) {
        await mergePDFsWithAttachments(mainPdfData, voidsLogFile, extrasFile);
        
        let attachmentInfo = '';
        if (voidsLogFile && extrasFile) {
          attachmentInfo = ' (with Voids Log and Extras attached)';
        } else if (voidsLogFile) {
          attachmentInfo = ' (with Voids Log attached)';
        } else if (extrasFile) {
          attachmentInfo = ' (with Extras attached)';
        }
        
        showSuccessMessage(`Combined weekly report generated successfully${attachmentInfo}! You can modify data and generate again.`);
      } else {
        // No attachments, save main PDF directly
        mainPdfData.doc.save(mainPdfData.filename);
        showSuccessMessage('Combined weekly report generated successfully! You can modify data and generate again.');
      }
      
      hideLoading();
      
      // Return to tip pool section for easy re-editing
      showTipPool();
      
      // Return to tip pool section for easy re-editing
      showTipPool();
      
    } catch (error) {
      hideLoading();
      showErrorMessage('Error generating combined report: ' + error.message);
      console.error('Combined report generation error:', error);
    }
  }

  function generateCombinedReportHtml(startDate, endDate, cashData, realEnvelopeAmount = null) {
    // Calculate cash report totals using EXACT same logic as generateDateRangePDF
    let totalToastSalesReported = 0;
    let totalActualCashIn = 0;
    let totalDiscrepancy = 0;
    let totalEnvelopeDeposits = 0;
    let totalBackToCashbox = 0;

    cashData.forEach(day => {
      totalToastSalesReported += day.pm_toast_sales || 0;
      totalActualCashIn += (day.pm_total - day.am_total) || 0;  // Fixed: PM minus AM, not PM + AM
      totalDiscrepancy += day.pm_discrepancy || 0;              // Fixed: Use stored discrepancy
      totalEnvelopeDeposits += day.pm_deposit_amount || 0;      // Fixed: Use correct column name
      totalBackToCashbox += (day.pm_amount_to_keep - day.am_total) || 0;
    });

    const { cashNeeded } = tipPoolSummary;
    
    // COPY EXACT LOGIC FROM ORIGINAL TIP POOL CALCULATOR LINE 565 (CORRECT LOGIC)
    let cashStatusText = '';
    let cashStatusClass = '';
    if (cashNeeded > 0) {
      // Need additional cash - show positive amount in red
      cashStatusText = 'NEEDED';
      cashStatusClass = 'color: #dc3545';
    } else {
      // Have surplus - show positive amount in green
      cashStatusText = 'SURPLUS';
      cashStatusClass = 'color: #28a745';
    }

    return `
      <div style="font-family: Arial, sans-serif; padding: 20px; background: white;">
        <!-- Header matching tip pool calculator style -->
        <div style="text-align: center; margin-bottom: 30px; border-bottom: 3px solid #1e3c72; padding-bottom: 20px;">
          <h1 style="margin: 0; color: #1e3c72; font-size: 24px;">JAYNA GYRO COMBINED WEEKLY REPORT</h1>
          <h2 style="margin: 10px 0 0 0; color: #666; font-size: 16px; font-weight: normal;">CASH COUNT & TIP POOL DISTRIBUTION</h2>
          <h3 style="margin: 10px 0 0 0; color: #666; font-size: 14px; font-weight: normal;">PERIOD: ${startDate.toUpperCase()} TO ${endDate.toUpperCase()} | GENERATED: ${new Date().toLocaleString().toUpperCase()}</h3>
        </div>

        <!-- Cash Count Summary Section -->
        <div style="margin-bottom: 30px;">
          <h3 style="color: #1e3c72; margin-bottom: 15px; border-bottom: 2px solid #1e3c72; padding-bottom: 5px;">
            CASH COUNT SUMMARY
          </h3>
          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px;">
            <div style="background: #f8f9fa; padding: 15px; border: 2px solid #007bff; border-radius: 0; text-align: center;">
              <h4 style="margin: 0 0 8px 0; color: #007bff; font-size: 12px;">TOTAL TOAST SALES</h4>
              <p style="font-size: 18px; font-weight: bold; margin: 0; color: #007bff;">$${totalToastSalesReported.toFixed(2)}</p>
            </div>
            <div style="background: #f8f9fa; padding: 15px; border: 2px solid #28a745; border-radius: 0; text-align: center;">
              <h4 style="margin: 0 0 8px 0; color: #28a745; font-size: 12px;">ACTUAL CASH IN</h4>
              <p style="font-size: 18px; font-weight: bold; margin: 0; color: #28a745;">$${totalActualCashIn.toFixed(2)}</p>
            </div>
            <div style="background: #f8f9fa; padding: 15px; border: 2px solid #dc3545; border-radius: 0; text-align: center;">
              <h4 style="margin: 0 0 8px 0; color: #dc3545; font-size: 12px;">TOTAL DISCREPANCY</h4>
              <p style="font-size: 18px; font-weight: bold; margin: 0; color: #dc3545;">$${totalDiscrepancy.toFixed(2)}</p>
            </div>
          </div>
          <div style="display: grid; grid-template-columns: repeat(${realEnvelopeAmount !== null ? '3' : '2'}, 1fr); gap: 15px;">
            <div style="background: #f8f9fa; padding: 15px; border: 2px solid #6c757d; border-radius: 0; text-align: center;">
              <h4 style="margin: 0 0 8px 0; color: #6c757d; font-size: 12px;">ENVELOPE DEPOSITS</h4>
              <p style="font-size: 18px; font-weight: bold; margin: 0; color: #6c757d;">$${totalEnvelopeDeposits.toFixed(2)}</p>
            </div>
            <div style="background: #f8f9fa; padding: 15px; border: 2px solid #f57c00; border-radius: 0; text-align: center;">
              <h4 style="margin: 0 0 8px 0; color: #f57c00; font-size: 12px;">EXCESS BACK TO CASH BOX</h4>
              <p style="font-size: 18px; font-weight: bold; margin: 0; color: #f57c00;">$${totalBackToCashbox.toFixed(2)}</p>
            </div>
            ${realEnvelopeAmount !== null ? `
            <div style="background: #f8f9fa; padding: 15px; border: 2px solid #9c27b0; border-radius: 0; text-align: center;">
              <h4 style="margin: 0 0 8px 0; color: #9c27b0; font-size: 12px;">REAL ENVELOPE AMOUNT</h4>
              <p style="font-size: 18px; font-weight: bold; margin: 0; color: #9c27b0;">$${realEnvelopeAmount.toFixed(2)}</p>
            </div>
            ` : ''}
          </div>
        </div>

        <!-- Tip Pool Summary Section -->
        <div style="margin-bottom: 30px;">
          <h3 style="color: #1e3c72; margin-bottom: 15px; border-bottom: 2px solid #1e3c72; padding-bottom: 5px;">
            TIP POOL SUMMARY
          </h3>
          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px;">
            <div style="background: #f8f9fa; padding: 15px; border: 2px solid #007bff; border-radius: 0; text-align: center;">
              <h4 style="margin: 0 0 8px 0; color: #007bff; font-size: 12px;">CREDIT TIPS</h4>
              <p style="font-size: 18px; font-weight: bold; margin: 0; color: #007bff;">$${tipPoolSummary.creditTips.toFixed(2)}</p>
            </div>
            <div style="background: #f8f9fa; padding: 15px; border: 2px solid #28a745; border-radius: 0; text-align: center;">
              <h4 style="margin: 0 0 8px 0; color: #28a745; font-size: 12px;">CASH TIPS</h4>
              <p style="font-size: 18px; font-weight: bold; margin: 0; color: #28a745;">$${tipPoolSummary.cashTips.toFixed(2)}</p>
            </div>
            <div style="background: #f8f9fa; padding: 15px; border: 2px solid #f57c00; border-radius: 0; text-align: center;">
              <h4 style="margin: 0 0 8px 0; color: #f57c00; font-size: 12px;">EZCATER TIPS</h4>
              <p style="font-size: 18px; font-weight: bold; margin: 0; color: #f57c00;">$${tipPoolSummary.ezcaterTips.toFixed(2)}</p>
            </div>
          </div>
          <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px;">
            <div style="background: #f8f9fa; padding: 15px; border: 2px solid #e91e63; border-radius: 0; text-align: center;">
              <h4 style="margin: 0 0 8px 0; color: #e91e63; font-size: 12px;">TDS DRIVER</h4>
              <p style="font-size: 18px; font-weight: bold; margin: 0; color: #e91e63;">$${tipPoolSummary.tdsDriverTips.toFixed(2)}</p>
            </div>
            <div style="background: #f8f9fa; padding: 15px; border: 2px solid #17a2b8; border-radius: 0; text-align: center;">
              <h4 style="margin: 0 0 8px 0; color: #17a2b8; font-size: 12px;">CASH SALES</h4>
              <p style="font-size: 18px; font-weight: bold; margin: 0; color: #17a2b8;">$${tipPoolSummary.toastCashSales.toFixed(2)}</p>
            </div>
            <div style="background: #f8f9fa; padding: 15px; border: 2px solid #1e3c72; border-radius: 0; text-align: center;">
              <h4 style="margin: 0 0 8px 0; color: #1e3c72; font-size: 12px;">TOTAL POOL</h4>
              <p style="font-size: 20px; font-weight: bold; margin: 0; color: #1e3c72;">$${tipPoolSummary.pool.toFixed(2)}</p>
            </div>
            <div style="background: #f8f9fa; padding: 15px; border: 2px solid #6c757d; border-radius: 0; text-align: center;">
              <h4 style="margin: 0 0 8px 0; color: #6c757d; font-size: 12px;">HOURLY RATE</h4>
              <p style="font-size: 18px; font-weight: bold; margin: 0; color: #6c757d;">$${tipPoolSummary.hourlyRate.toFixed(2)}</p>
            </div>
          </div>
        </div>

        <!-- Cash Status Line (prominent display matching tip pool calculator) -->
        <div style="text-align: center; margin-bottom: 30px; background: #f8f9fa; padding: 15px; border: 2px solid ${cashNeeded > 0 ? '#dc3545' : '#28a745'}; border-radius: 0;">
          <h4 style="margin: 0 0 8px 0; ${cashStatusClass}; font-size: 14px; font-weight: bold;">
            ${cashNeeded > 0 ? 'CASH NEEDED TO PAY OUT TIPS' : 'ZERO CASH NEEDED TO PAY OUT TIPS THIS WEEK. EXCESS CASH ON HAND'}
          </h4>
          <p style="font-size: 24px; font-weight: bold; margin: 0; ${cashStatusClass};">$${Math.abs(cashNeeded).toFixed(2)}</p>
        </div>

        <!-- Employee Distribution Table -->
        <div style="margin-bottom: 30px;">
          <h3 style="color: #1e3c72; margin-bottom: 15px; border-bottom: 2px solid #1e3c72; padding-bottom: 5px;">
            EMPLOYEE TIP DISTRIBUTION
          </h3>
          <table style="width: 100%; border-collapse: collapse; border: 2px solid #000;">
            <thead>
              <tr style="background: #1e3c72; color: white;">
                <th style="padding: 12px; text-align: left; border: 1px solid #000; font-size: 12px;">EMPLOYEE</th>
                <th style="padding: 12px; text-align: center; border: 1px solid #000; font-size: 12px;">HOURS</th>
                <th style="padding: 12px; text-align: center; border: 1px solid #000; font-size: 12px;">EQUITY (%)</th>
                <th style="padding: 12px; text-align: center; border: 1px solid #000; font-size: 12px;">WEIGHTED</th>
                <th style="padding: 12px; text-align: center; border: 1px solid #000; font-size: 12px;">DUE</th>
              </tr>
            </thead>
            <tbody>
              ${tipPoolRecords.map((record, index) => {
                const rowBg = index % 2 === 0 ? '#f8f9fa' : 'white';
                return `
                  <tr style="background: ${rowBg};">
                    <td style="padding: 10px; border: 1px solid #000; font-weight: bold; font-size: 11px;">${record.first.toUpperCase()} ${record.last.toUpperCase()}</td>
                    <td style="padding: 10px; text-align: center; border: 1px solid #000; font-size: 11px;">${record.hours.toFixed(1)}</td>
                    <td style="padding: 10px; text-align: center; border: 1px solid #000; font-size: 11px;">${(record.equity * 100).toFixed(0)}</td>
                    <td style="padding: 10px; text-align: center; border: 1px solid #000; font-size: 11px;">${record.weighted.toFixed(1)}</td>
                    <td style="padding: 10px; text-align: center; border: 1px solid #000; font-weight: bold; font-size: 14px; color: #28a745;">$${record.due.toFixed(2)}</td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        </div>

        <!-- Daily Cash Breakdown -->
        <div style="border: 2px solid #000; margin: 30px 0; border-radius: 0; overflow: hidden;">
          <div style="background: #f0f0f0; padding: 10px; border-bottom: 2px solid #000;">
            <h4 style="margin: 0; text-align: center; font-size: 14px; color: #1e3c72;">DAILY CASH BREAKDOWN</h4>
          </div>
          
          <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
              <thead>
                <tr style="background: #f8f9fa;">
                  <th style="border: 1px solid #000; padding: 8px; text-align: left; font-weight: bold;">Date</th>
                  <th style="border: 1px solid #000; padding: 8px; text-align: center; font-weight: bold;">Counter</th>
                  <th style="border: 1px solid #000; padding: 8px; text-align: right; font-weight: bold;">Toast Sales</th>
                  <th style="border: 1px solid #000; padding: 8px; text-align: right; font-weight: bold;">Actual Cash In</th>
                  <th style="border: 1px solid #000; padding: 8px; text-align: right; font-weight: bold;">Discrepancy</th>
                  <th style="border: 1px solid #000; padding: 8px; text-align: right; font-weight: bold;">Envelope</th>
                  <th style="border: 1px solid #000; padding: 8px; text-align: right; font-weight: bold;">Cashbox</th>
                </tr>
              </thead>
              <tbody>
                ${cashData.map(day => {
                  const actualCashIn = day.pm_total - day.am_total;
                  const discrepancySign = day.pm_discrepancy >= 0 ? '+' : '';
                  return `
                    <tr>
                      <td style="border: 1px solid #000; padding: 6px; font-weight: bold;">
                        ${new Date(day.date + 'T12:00:00').toLocaleDateString()}
                      </td>
                      <td style="border: 1px solid #000; padding: 6px; text-align: center;">
                        ${day.pm_counter || 'N/A'}
                      </td>
                      <td style="border: 1px solid #000; padding: 6px; text-align: right;">
                        $${(day.pm_toast_sales || 0).toFixed(2)}
                      </td>
                      <td style="border: 1px solid #000; padding: 6px; text-align: right;">
                        $${actualCashIn.toFixed(2)}
                      </td>
                      <td style="border: 1px solid #000; padding: 6px; text-align: right; color: ${day.pm_discrepancy >= 0 ? '#28a745' : '#dc3545'};">
                        ${discrepancySign}$${Math.abs(day.pm_discrepancy || 0).toFixed(2)}
                      </td>
                      <td style="border: 1px solid #000; padding: 6px; text-align: right;">
                        $${day.pm_deposit_amount || 0}
                      </td>
                      <td style="border: 1px solid #000; padding: 6px; text-align: right;">
                        $${(day.pm_amount_to_keep || 0).toFixed(2)}
                      </td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          </div>
        </div>

        <!-- Footer -->
        <div style="text-align: center; margin-top: 30px; padding: 15px; border-top: 2px solid #1e3c72; font-size: 10px; background: #f8f9fa;">
          <div style="margin-bottom: 5px; font-weight: bold; color: #1e3c72;">Cash counts verified and tips calculated by: ${tipPoolSummary.ranBy || 'SYSTEM'}</div>
          <div style="margin-bottom: 5px; color: #666;">Generated: ${new Date().toLocaleString()}</div>
          <div style="color: #1e3c72; font-weight: bold;">Jayna Gyro Combined Weekly Report System v2.86</div>
        </div>
      </div>
    `;
  }

  // ====================================
  // ORDERING SYSTEM - START
  // ====================================

  /**
   * @typedef {Object} InventoryItem
   * @property {number} id - Database ID
   * @property {string} itemName - Full name with packaging
   * @property {string} vendor - Vendor name
   * @property {number} parLevel - Target stock level
   * @property {number} currentStock - Current on-hand quantity
   * @property {string} unit - Unit of measurement (CS, EA, LB, etc.)
   * @property {string} [lastCountedDate] - Last stock count date
   */

  /**
   * @typedef {Object} CalculatedOrder
   * @property {string} vendor - Vendor name
   * @property {Date} orderDate - When to place order
   * @property {string} cutoffTime - Order deadline
   * @property {Date} deliveryDate - Expected delivery
   * @property {OrderItem[]} items - Items to order
   * @property {string} [notes] - Special instructions
   */

  /**
   * @typedef {Object} OrderItem
   * @property {string} itemName - Item name
   * @property {number} quantity - Quantity to order
   * @property {string} unit - Unit of measurement
   * @property {number} parLevel - Par level for reference
   * @property {number} currentStock - Current stock for reference
   */

  /**
   * Global state for ordering system
   */
  const orderingSystemState = {
    items: [],
    calculatedOrders: [],
    currentTab: 'upcomingOrders',
    lastUpdated: null,
    pendingStockUpdates: new Map(), // Track unsaved stock updates
    currentCountSession: 'morning_prep', // Track current prep count session
    previousCounts: new Map(), // Track previous counts for consumption calculation (itemId -> {count, session})
    // Invoice system state
    currentInvoiceImage: null,
    extractedInvoiceItems: [],
    invoiceType: 'invoice' // 'invoice' or 'order'
  };

  /**
   * Start the ordering system
   */
  async function startOrderingSystem() {
    // Keep main menu visible at top
    hideAllSections();
    document.getElementById('orderingSystemForm').classList.add('active');

    // Load data AFTER form is visible (same pattern as startPMCount)
    try {
      await loadInventoryData();
      calculateUpcomingOrders();
      renderInventoryList();
      renderStockCountList();
      renderPrepCountList(); // Render PREP items in PREP tab
    } catch (error) {
      console.error('Error loading ordering system data:', error);
      showMessage(`Error: ${error.message}`, 'error');
    }
  }

  /**
   * Switch between tabs
   */
  function openOrderTab(event, tabName) {
    console.log('openOrderTab:', tabName);

    // Hide all tab contents
    const tabContents = document.querySelectorAll('.tab-content');
    tabContents.forEach(content => content.style.display = 'none');

    // Remove active class from all tab links
    const tabLinks = document.querySelectorAll('.tab-link');
    tabLinks.forEach(link => {
      link.style.background = '#f5f5f5';
      link.style.color = '#1e3c72';
    });

    // Show selected tab and mark button as active
    document.getElementById(tabName).style.display = 'block';
    if (event && event.target) {
      event.target.style.background = '#1e3c72';
      event.target.style.color = 'white';
    }

    orderingSystemState.currentTab = tabName;

    // Auto-refresh prep sheet when tab is opened
    if (tabName === 'prepSheet') {
      refreshPrepSheet();
    }
  }

  /**
   * Load inventory data from database
   */
  async function loadInventoryData() {
    if (!supabase) {
      console.error('Supabase is not initialized!');
      throw new Error('Database not connected');
    }

    console.log('showLoading called...');
    showLoading('Loading Inventory', 'Fetching items from database...');

    try {
      console.log('Querying inventory_items table...');
      const { data, error } = await supabase
        .from('inventory_items')
        .select('*')
        .order('vendor', { ascending: true })
        .order('item_name', { ascending: true });

      console.log('Query result - error:', error);
      console.log('Query result - data:', data);
      console.log('Number of items loaded:', data?.length || 0);

      if (error) throw error;

      orderingSystemState.items = (data || []).map(item => ({
        id: item.id,
        itemName: item.item_name,
        vendor: item.vendor,
        parLevel: item.par_level || 0,
        currentStock: item.current_stock || 0,
        unit: item.unit,
        lastCountedDate: item.last_counted_date,
        currentUnitCost: item.current_unit_cost,
        lastCostUpdate: item.last_cost_update,
        itemType: item.item_type || 'ingredient' // Track if item is 'prep' or 'ingredient'
      }));

      console.log('orderingSystemState.items:', orderingSystemState.items);
      console.log('orderingSystemState.items.length:', orderingSystemState.items.length);

      orderingSystemState.lastUpdated = new Date();
      hideLoading();
      console.log('hideLoading called');
    } catch (error) {
      hideLoading();
      console.error('loadInventoryData error:', error);
      throw new Error(`Failed to load inventory: ${error.message}`);
    }
  }

  /**
   * Calculate upcoming orders for next 7 days
   */
  function calculateUpcomingOrders() {
    console.log('calculateUpcomingOrders() called');
    const now = new Date();
    const orders = [];

    // Check next 7 days
    for (let i = 0; i < 7; i++) {
      const checkDate = new Date(now);
      checkDate.setDate(checkDate.getDate() + i);
      const dayName = checkDate.toLocaleDateString('en-US', { weekday: 'long' });

      // Greenleaf - Daily orders (except Saturday)
      if (dayName !== 'Saturday') {
        const greenleafOrder = calculateGreenleafOrder(checkDate, dayName);
        if (greenleafOrder) orders.push(greenleafOrder);
      }

      // Performance - Sunday and Wednesday
      if (dayName === 'Sunday' || dayName === 'Wednesday') {
        const performanceOrder = calculatePerformanceOrder(checkDate, dayName);
        if (performanceOrder) orders.push(performanceOrder);
      }

      // Mani Imports - Tuesday and Thursday
      if (dayName === 'Tuesday' || dayName === 'Thursday') {
        const maniOrder = calculateManiOrder(checkDate, dayName);
        if (maniOrder) orders.push(maniOrder);
      }

      // Eatopia - Any Wednesday for Thursday delivery
      if (dayName === 'Wednesday') {
        const eatopiaOrder = calculateEatopiaOrder(checkDate);
        if (eatopiaOrder) orders.push(eatopiaOrder);
      }
    }

    orderingSystemState.calculatedOrders = orders;
    renderUpcomingOrders();
  }

  /**
   * Calculate Greenleaf order
   */
  function calculateGreenleafOrder(orderDate, dayName) {
    const isFriday = dayName === 'Friday';
    const multiplier = isFriday ? 2 : 1; // Friday covers Sat + Sun

    const items = orderingSystemState.items
      .filter(item => item.vendor === 'Greenleaf')
      .map(item => ({
        itemName: item.itemName,
        quantity: Math.max(0, Math.ceil((item.parLevel - item.currentStock) * multiplier)),
        unit: item.unit,
        parLevel: item.parLevel,
        currentStock: item.currentStock,
        lastCountedDate: item.lastCountedDate,
        currentUnitCost: item.currentUnitCost,
        lastCostUpdate: item.lastCostUpdate
      }))
      .filter(item => item.quantity > 0);

    if (items.length === 0) return null;

    const deliveryDate = new Date(orderDate);
    deliveryDate.setDate(deliveryDate.getDate() + 1);

    return {
      vendor: 'Greenleaf',
      orderDate: orderDate,
      cutoffTime: '10:00 PM',
      deliveryDate: deliveryDate,
      items: items,
      notes: isFriday ? '🚨 2-DAY SUPPLY for Saturday and Sunday' : null
    };
  }

  /**
   * Calculate Performance order
   */
  function calculatePerformanceOrder(orderDate, dayName) {
    const items = orderingSystemState.items
      .filter(item => item.vendor === 'Performance')
      .map(item => ({
        itemName: item.itemName,
        quantity: Math.max(0, item.parLevel - item.currentStock),
        unit: item.unit,
        parLevel: item.parLevel,
        currentStock: item.currentStock,
        lastCountedDate: item.lastCountedDate,
        currentUnitCost: item.currentUnitCost,
        lastCostUpdate: item.lastCostUpdate
      }))
      .filter(item => item.quantity > 0);

    if (items.length === 0) return null;

    const deliveryDate = new Date(orderDate);
    deliveryDate.setDate(deliveryDate.getDate() + 1);

    return {
      vendor: 'Performance',
      orderDate: orderDate,
      cutoffTime: '3:00 PM',
      deliveryDate: deliveryDate,
      items: items,
      notes: dayName === 'Sunday' ? 'Delivery Monday morning' : 'Delivery Thursday morning'
    };
  }

  /**
   * Calculate Mani Imports order
   */
  function calculateManiOrder(orderDate, dayName) {
    const isThursday = dayName === 'Thursday';
    const multiplier = isThursday ? 5 : 3; // Thursday = 5 days, Tuesday = 3 days

    const items = orderingSystemState.items
      .filter(item => item.vendor === 'Mani Imports')
      .map(item => ({
        itemName: item.itemName,
        quantity: Math.max(0, Math.ceil((item.parLevel - item.currentStock) * (multiplier / 7))),
        unit: item.unit,
        parLevel: item.parLevel,
        currentStock: item.currentStock,
        lastCountedDate: item.lastCountedDate,
        currentUnitCost: item.currentUnitCost,
        lastCostUpdate: item.lastCostUpdate
      }))
      .filter(item => item.quantity > 0);

    if (items.length === 0) return null;

    const deliveryDate = new Date(orderDate);
    deliveryDate.setDate(deliveryDate.getDate() + 1);

    return {
      vendor: 'Mani Imports',
      orderDate: orderDate,
      cutoffTime: '3:00 PM',
      deliveryDate: deliveryDate,
      items: items,
      notes: isThursday ? '🚨 LARGE ORDER - 5-day supply covering weekend' : 'Small order - 3-day supply'
    };
  }

  /**
   * Calculate Eatopia order
   */
  function calculateEatopiaOrder(orderDate) {
    const items = orderingSystemState.items
      .filter(item => item.vendor === 'Eatopia Foods')
      .map(item => ({
        itemName: item.itemName,
        quantity: Math.max(0, item.parLevel - item.currentStock),
        unit: item.unit,
        parLevel: item.parLevel,
        currentStock: item.currentStock,
        lastCountedDate: item.lastCountedDate,
        currentUnitCost: item.currentUnitCost,
        lastCostUpdate: item.lastCostUpdate
      }))
      .filter(item => item.quantity > 0);

    if (items.length === 0) return null;

    const deliveryDate = new Date(orderDate);
    deliveryDate.setDate(deliveryDate.getDate() + 1); // Thursday delivery

    return {
      vendor: 'Eatopia Foods',
      orderDate: orderDate,
      cutoffTime: 'Flexible',
      deliveryDate: deliveryDate,
      items: items,
      notes: 'Delivery always on Thursday'
    };
  }

  /**
   * Format timestamp as relative time (e.g., "2h ago", "5d ago")
   * Matches email format
   */
  function formatRelativeTime(dateStr) {
    if (!dateStr) return 'Never';

    const date = new Date(dateStr);
    const now = new Date();
    const diffMs = now - date;
    const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

    if (diffHours < 24) {
      return `${diffHours}h ago`;
    } else if (diffDays < 7) {
      return `${diffDays}d ago`;
    } else {
      return date.toLocaleDateString('en-US', { month: 'numeric', day: 'numeric', year: '2-digit' });
    }
  }

  /**
   * Format price with date (e.g., "$24.38 (9/22/25)")
   * Matches email format
   */
  function formatPriceWithDate(price, dateStr) {
    if (!price) return '';

    const formattedPrice = '$' + parseFloat(price).toFixed(2);

    if (!dateStr) return formattedPrice;

    const date = new Date(dateStr);
    const formattedDate = date.toLocaleDateString('en-US', { month: 'numeric', day: 'numeric', year: '2-digit' });

    return `${formattedPrice} (${formattedDate})`;
  }

  /**
   * Render upcoming orders
   */
  function renderUpcomingOrders() {
    const container = document.getElementById('upcomingOrders');

    if (orderingSystemState.calculatedOrders.length === 0) {
      container.innerHTML = `
        <div style="text-align: center; padding: 40px; background: #f0f4f8; border-radius: 4px;">
          <p style="font-size: 16px; color: #666;">✅ No orders needed in the next 7 days!</p>
          <p style="font-size: 14px; color: #999; margin-top: 10px;">All inventory levels are sufficient.</p>
        </div>
      `;
      return;
    }

    let html = `
      <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
        <button class="submit-btn" onclick="generateAllPDFs()" style="background: #d32f2f;">
          📄 Generate All PDFs
        </button>
        <button class="submit-btn" onclick="calculateUpcomingOrders()" style="background: #0288d1;">
          🔄 Refresh Orders
        </button>
      </div>
      <div style="font-size: 12px; color: #666; margin-bottom: 20px;">
        Last updated: ${orderingSystemState.lastUpdated ? orderingSystemState.lastUpdated.toLocaleString() : 'Never'}
      </div>
    `;

    orderingSystemState.calculatedOrders.forEach((order, index) => {
      const orderDateStr = order.orderDate.toLocaleDateString('en-US', {
        weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
      });
      const deliveryDateStr = order.deliveryDate.toLocaleDateString('en-US', {
        weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
      });

      html += `
        <div class="order-card" id="order-${index}" style="
          border: 2px solid #1e3c72;
          margin-bottom: 20px;
          padding: 20px;
          border-radius: 8px;
          background: white;
          box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        ">
          <h3 style="color: #1e3c72; margin-bottom: 15px; font-size: 20px;">
            📦 ${order.vendor} - Order #${index + 1}
          </h3>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; padding: 15px; background: #f8f9fa; border-radius: 4px;">
            <div>
              <div style="font-weight: bold; color: #666; font-size: 12px;">ORDER DATE</div>
              <div style="font-size: 14px; margin-top: 5px;">${orderDateStr}</div>
            </div>
            <div>
              <div style="font-weight: bold; color: #666; font-size: 12px;">CUTOFF TIME</div>
              <div style="font-size: 14px; margin-top: 5px;">${order.cutoffTime}</div>
            </div>
            <div>
              <div style="font-weight: bold; color: #666; font-size: 12px;">DELIVERY DATE</div>
              <div style="font-size: 14px; margin-top: 5px;">${deliveryDateStr}</div>
            </div>
            <div>
              <div style="font-weight: bold; color: #666; font-size: 12px;">ITEMS</div>
              <div style="font-size: 14px; margin-top: 5px;">${order.items.length} items</div>
            </div>
          </div>

          ${order.notes ? `
            <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 10px; margin-bottom: 15px; border-radius: 4px;">
              <strong>Note:</strong> ${order.notes}
            </div>
          ` : ''}

          <table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
            <thead>
              <tr style="background: #1e3c72; color: white;">
                <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Item</th>
                <th style="padding: 10px; text-align: center; border: 1px solid #ddd;">Qty</th>
                <th style="padding: 10px; text-align: center; border: 1px solid #ddd;">Unit</th>
                <th style="padding: 10px; text-align: center; border: 1px solid #ddd;">Par</th>
                <th style="padding: 10px; text-align: center; border: 1px solid #ddd;">Current</th>
              </tr>
            </thead>
            <tbody>
              ${order.items.map((item, i) => {
                // Calculate reasoning text (matches email format)
                const isFriday = order.orderDate.toLocaleDateString('en-US', { weekday: 'long' }) === 'Friday';
                const isThursday = order.orderDate.toLocaleDateString('en-US', { weekday: 'long' }) === 'Thursday';
                let reasoningText = '';

                if (order.vendor === 'Greenleaf' && isFriday) {
                  // Friday Greenleaf = 2-day coverage
                  reasoningText = `AI: (Par ${item.parLevel} - Stock ${item.currentStock}) × 2 days = ${item.quantity} to order`;
                } else if (order.vendor === 'Mani Imports' && isThursday) {
                  // Thursday Mani = 5-day coverage
                  const calc = Math.ceil((item.parLevel - item.currentStock) * (5 / 7));
                  reasoningText = `AI: (Par ${item.parLevel} - Stock ${item.currentStock}) × 5/7 days = ${calc} to order`;
                } else if (order.vendor === 'Mani Imports') {
                  // Tuesday Mani = 3-day coverage
                  const calc = Math.ceil((item.parLevel - item.currentStock) * (3 / 7));
                  reasoningText = `AI: (Par ${item.parLevel} - Stock ${item.currentStock}) × 3/7 days = ${calc} to order`;
                } else {
                  // Simple par-based calculation
                  reasoningText = `AI: Par ${item.parLevel} - Stock ${item.currentStock} = ${item.quantity} to order`;
                }

                // Format last count and last price (matches email format)
                const lastCountStr = item.lastCountedDate ? `Last count: ${formatRelativeTime(item.lastCountedDate)}` : '';
                const lastPriceStr = item.currentUnitCost ? `Last price: ${formatPriceWithDate(item.currentUnitCost, item.lastCostUpdate)}` : '';

                return `
                <tr style="background: ${i % 2 === 0 ? '#f8f9fa' : 'white'};">
                  <td style="padding: 10px; border: 1px solid #ddd;">
                    ${item.itemName}
                    ${lastCountStr ? `<div style="font-size: 11px; color: #999; margin-top: 2px;">${lastCountStr}</div>` : ''}
                    ${lastPriceStr ? `<div style="font-size: 11px; color: #999; margin-top: 2px;">${lastPriceStr}</div>` : ''}
                    <div style="font-size: 9px; color: #bbb; margin-top: 2px; font-style: italic;">${reasoningText}</div>
                  </td>
                  <td style="padding: 10px; text-align: center; border: 1px solid #ddd; font-weight: bold; color: #d32f2f;">${item.quantity}</td>
                  <td style="padding: 10px; text-align: center; border: 1px solid #ddd;">
                    <input
                      type="text"
                      value="${item.unit}"
                      onchange="updateItemUnit(${item.id}, this.value)"
                      style="width: 80px; padding: 5px; text-align: center; border: 1px solid #ccc; border-radius: 4px; font-size: 12px;"
                      placeholder="e.g., CS, EA"
                    />
                  </td>
                  <td style="padding: 10px; text-align: center; border: 1px solid #ddd;">${item.parLevel}</td>
                  <td style="padding: 10px; text-align: center; border: 1px solid #ddd;">${item.currentStock}</td>
                </tr>
                `;
              }).join('')}
            </tbody>
          </table>

          <div style="margin-top: 20px; display: flex; gap: 10px;">
            <button class="submit-btn" onclick="printOrder(${index})" style="flex: 1; background: #2e7d32;">
              🖨️ Print Order
            </button>
            <button class="submit-btn" onclick="generateOrderPDF(${index})" style="flex: 1; background: #d32f2f;">
              📄 Generate PDF
            </button>
          </div>
        </div>
      `;
    });

    container.innerHTML = html;
  }

  /**
   * Sort vendors with PREP first, then alphabetically
   */
  function sortVendorsWithPrepFirst(vendors) {
    return vendors.sort((a, b) => {
      if (a === 'PREP') return -1;
      if (b === 'PREP') return 1;
      return a.localeCompare(b);
    });
  }

  /**
   * Render inventory list for managing par levels
   */
  function renderInventoryList() {
    const container = document.getElementById('inventoryList');

    if (orderingSystemState.items.length === 0) {
      container.innerHTML = '<p style="text-align: center; padding: 20px;">No inventory items found. Add items using the form above.</p>';
      return;
    }

    // Group by vendor
    const itemsByVendor = {};
    orderingSystemState.items.forEach(item => {
      if (!itemsByVendor[item.vendor]) {
        itemsByVendor[item.vendor] = [];
      }
      itemsByVendor[item.vendor].push(item);
    });

    let html = '';
    sortVendorsWithPrepFirst(Object.keys(itemsByVendor)).forEach(vendor => {
      const items = itemsByVendor[vendor];
      const isPrepCategory = vendor === 'PREP';
      const headerColor = isPrepCategory ? '#ff6b35' : '#1e3c72'; // Orange for PREP, blue for vendors
      html += `
        <div style="margin-bottom: 30px;">
          <h4 style="background: ${headerColor}; color: white; padding: 10px; border-radius: 4px; margin-bottom: 10px;">
            ${isPrepCategory ? '🍳 ' : ''}${vendor} (${items.length} items)
          </h4>
          <table style="width: 100%; border-collapse: collapse;">
            <thead>
              <tr style="background: #f8f9fa;">
                <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Item Name</th>
                <th style="padding: 10px; text-align: center; border: 1px solid #ddd; width: 150px;">Vendor</th>
                <th style="padding: 10px; text-align: center; border: 1px solid #ddd; width: 100px;">Unit</th>
                <th style="padding: 10px; text-align: center; border: 1px solid #ddd; width: 120px;">Par Level</th>
                <th style="padding: 10px; text-align: center; border: 1px solid #ddd; width: 120px;">Current Stock</th>
                <th style="padding: 10px; text-align: center; border: 1px solid #ddd; width: 100px;">Actions</th>
              </tr>
            </thead>
            <tbody>
              ${items.map((item, i) => `
                <tr style="background: ${i % 2 === 0 ? 'white' : '#f8f9fa'};">
                  <td style="padding: 10px; border: 1px solid #ddd;">${item.itemName}</td>
                  <td style="padding: 10px; text-align: center; border: 1px solid #ddd;">
                    <select
                      value="${item.vendor}"
                      onchange="updateItemVendor(${item.id}, this.value)"
                      style="width: 140px; padding: 5px; border: 1px solid #ccc; border-radius: 4px; font-size: 12px;"
                    >
                      ${getAllVendors().map(v => `<option value="${v}" ${v === item.vendor ? 'selected' : ''}>${v}</option>`).join('')}
                    </select>
                  </td>
                  <td style="padding: 10px; text-align: center; border: 1px solid #ddd;">
                    <input
                      type="text"
                      value="${item.unit}"
                      onchange="updateItemUnit(${item.id}, this.value)"
                      style="width: 80px; padding: 5px; text-align: center; border: 1px solid #ccc; border-radius: 4px; font-size: 12px;"
                      placeholder="e.g., CS, EA"
                    />
                  </td>
                  <td style="padding: 10px; text-align: center; border: 1px solid #ddd;">
                    <input
                      type="number"
                      value="${item.parLevel}"
                      min="0"
                      onchange="updateParLevel(${item.id}, this.value)"
                      style="width: 80px; padding: 5px; text-align: center; border: 1px solid #ccc; border-radius: 4px;"
                    />
                  </td>
                  <td style="padding: 10px; text-align: center; border: 1px solid #ddd; color: #666;">${item.currentStock}</td>
                  <td style="padding: 10px; text-align: center; border: 1px solid #ddd;">
                    <button onclick="deleteInventoryItem(${item.id})" style="
                      background: #d32f2f;
                      color: white;
                      border: none;
                      padding: 5px 10px;
                      border-radius: 4px;
                      cursor: pointer;
                      font-size: 12px;
                    ">Delete</button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
    });

    container.innerHTML = html;
  }

  /**
   * Render stock count list for updating inventory
   * Mobile-first card-based design with large touch targets
   */
  function renderStockCountList() {
    const container = document.getElementById('stockCountList');

    if (orderingSystemState.items.length === 0) {
      container.innerHTML = '<p style="text-align: center; padding: 20px;">No inventory items found.</p>';
      return;
    }

    // Group by vendor (exclude PREP items - they go in PREP tab)
    const itemsByVendor = {};
    orderingSystemState.items.forEach(item => {
      // Skip PREP items - they belong in PREP tab
      if (item.vendor === 'PREP' || item.category === 'PREP') {
        return;
      }
      if (!itemsByVendor[item.vendor]) {
        itemsByVendor[item.vendor] = [];
      }
      itemsByVendor[item.vendor].push(item);
    });

    // Helper function to get stock status
    function getStockStatus(currentStock, parLevel) {
      if (parLevel === 0) return { label: 'N/A', color: '#999', bg: '#f5f5f5' };
      const percentage = (currentStock / parLevel) * 100;
      if (percentage < 30) return { label: 'LOW', color: '#d32f2f', bg: '#ffebee' };
      if (percentage < 70) return { label: 'MEDIUM', color: '#f57c00', bg: '#fff3e0' };
      return { label: 'GOOD', color: '#388e3c', bg: '#e8f5e9' };
    }

    // Helper function to format last counted date
    function formatLastCounted(dateStr) {
      if (!dateStr) return 'Never';
      const date = new Date(dateStr);
      const now = new Date();
      const diffMs = now - date;
      const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
      const diffDays = Math.floor(diffHours / 24);

      if (diffHours < 24) return `${diffHours}h ago`;
      if (diffDays < 7) return `${diffDays}d ago`;
      return date.toLocaleDateString('en-US', { month: 'numeric', day: 'numeric', year: '2-digit' });
    }

    let html = '';
    sortVendorsWithPrepFirst(Object.keys(itemsByVendor)).forEach(vendor => {
      const items = itemsByVendor[vendor];
      const isPrepCategory = vendor === 'PREP';
      const headerColor = isPrepCategory ? '#ff6b35' : '#2e7d32'; // Orange for PREP, green for vendors
      html += `
        <div style="margin-bottom: 30px;">
          <h4 style="background: ${headerColor}; color: white; padding: 12px 16px; border-radius: 8px; margin-bottom: 12px; font-size: 16px; font-weight: 600;">
            ${isPrepCategory ? '🍳 ' : ''}${vendor} <span style="opacity: 0.85; font-weight: 400; font-size: 14px;">(${items.length})</span>
          </h4>

          <!-- Single column layout for all screens -->
          <div style="display: flex; flex-direction: column; gap: ${isCompactMode ? '8px' : '10px'};">
            ${items.map((item) => {
              const status = getStockStatus(item.currentStock, item.parLevel);
              const lastCounted = formatLastCounted(item.lastCountedDate);

              return `
                <div style="
                  background: white;
                  border: 1px solid #e0e0e0;
                  border-radius: ${isCompactMode ? '6px' : '8px'};
                  padding: ${isCompactMode ? '10px' : '14px'};
                  box-shadow: 0 1px 3px rgba(0,0,0,0.08);
                  transition: box-shadow 0.2s;
                "
                onmouseover="this.style.boxShadow='0 2px 8px rgba(0,0,0,0.12)'"
                onmouseout="this.style.boxShadow='0 1px 3px rgba(0,0,0,0.08)'">

                  <!-- Header: Item Name + Status Badge -->
                  <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: ${isCompactMode ? '8px' : '12px'}; gap: 8px;">
                    <div style="flex: 1; font-weight: 600; font-size: ${isCompactMode ? '14px' : '15px'}; line-height: 1.3; color: #333;">
                      ${item.itemName}
                    </div>
                    <div style="
                      background: ${status.bg};
                      color: ${status.color};
                      padding: ${isCompactMode ? '3px 8px' : '4px 10px'};
                      border-radius: 12px;
                      font-size: ${isCompactMode ? '10px' : '11px'};
                      font-weight: 700;
                      white-space: nowrap;
                      letter-spacing: 0.3px;
                    ">
                      ${status.label}
                    </div>
                  </div>

                  <!-- Metadata Row -->
                  <div style="
                    display: flex;
                    gap: ${isCompactMode ? '12px' : '16px'};
                    margin-bottom: ${isCompactMode ? '8px' : '12px'};
                    font-size: ${isCompactMode ? '12px' : '13px'};
                    color: #666;
                  ">
                    <div>
                      <span style="color: #999;">Unit:</span> <strong>${item.unit}</strong>
                    </div>
                    <div>
                      <span style="color: #999;">Par:</span> <strong>${item.parLevel}</strong>
                    </div>
                    <div style="margin-left: auto; color: #999; font-size: ${isCompactMode ? '11px' : '12px'};">
                      ${lastCounted}
                    </div>
                  </div>

                  <!-- Stock Input with Quick Adjustments (Mobile-Optimized) -->
                  <div>
                    <label style="display: block; font-size: 12px; color: #666; margin-bottom: 6px; font-weight: 500;">
                      Current Stock
                    </label>
                    <!-- Input with Stepper Buttons -->
                    <div style="display: flex; gap: 5px; align-items: stretch;">
                      <!-- Decrement Button -->
                      <button
                        type="button"
                        onclick="quickAdjustStock(${item.id}, -0.25)"
                        style="
                          flex: 0 0 40px;
                          padding: 0;
                          font-size: 22px;
                          font-weight: 700;
                          background: #f5f5f5;
                          border: 2px solid #e0e0e0;
                          border-radius: 6px;
                          color: #666;
                          cursor: pointer;
                          transition: all 0.2s;
                          min-height: 48px;
                          display: flex;
                          align-items: center;
                          justify-content: center;
                        "
                        onmousedown="this.style.background='#e0e0e0'; this.style.transform='scale(0.95)';"
                        onmouseup="this.style.background='#f5f5f5'; this.style.transform='scale(1)';"
                        onmouseleave="this.style.background='#f5f5f5'; this.style.transform='scale(1)';"
                      >−</button>

                      <!-- Stock Input Field -->
                      <input
                        type="number"
                        inputmode="decimal"
                        id="stock-${item.id}"
                        value="${item.currentStock}"
                        min="0"
                        step="0.25"
                        onblur="autoSaveStockCount(${item.id}, this.value, this)"
                        onchange="autoSaveStockCount(${item.id}, this.value, this)"
                        style="
                          flex: 1;
                          padding: 12px 6px;
                          font-size: 20px;
                          font-weight: 700;
                          text-align: center;
                          border: 2px solid #2e7d32;
                          border-radius: 6px;
                          background: #f9fdf9;
                          color: #2e7d32;
                          box-sizing: border-box;
                          -webkit-appearance: none;
                          -moz-appearance: textfield;
                          min-height: 48px;
                          transition: all 0.2s;
                        "
                        onfocus="this.style.borderColor='#1b5e20'; this.style.background='#ffffff'; this.select();"
                        onblur="this.style.borderColor='#2e7d32'; this.style.background='#f9fdf9';"
                      />

                      <!-- Increment Button -->
                      <button
                        type="button"
                        onclick="quickAdjustStock(${item.id}, 0.25)"
                        style="
                          flex: 0 0 40px;
                          padding: 0;
                          font-size: 22px;
                          font-weight: 700;
                          background: #2e7d32;
                          border: 2px solid #2e7d32;
                          border-radius: 6px;
                          color: white;
                          cursor: pointer;
                          transition: all 0.2s;
                          min-height: 48px;
                          display: flex;
                          align-items: center;
                          justify-content: center;
                        "
                        onmousedown="this.style.background='#1b5e20'; this.style.transform='scale(0.95)';"
                        onmouseup="this.style.background='#2e7d32'; this.style.transform='scale(1)';"
                        onmouseleave="this.style.background='#2e7d32'; this.style.transform='scale(1)';"
                      >+</button>
                    </div>

                    <!-- Save Status Indicator -->
                    <div
                      id="save-status-${item.id}"
                      style="
                        margin-top: 6px;
                        font-size: 11px;
                        text-align: center;
                        min-height: 16px;
                        font-weight: 600;
                        opacity: 0;
                        transition: opacity 0.2s;
                      "
                    ></div>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        </div>
      `;
    });

    container.innerHTML = html;
  }

  /**
   * Render PREP items count list (for PREP tab)
   * Shows only PREP category items
   */
  function renderPrepCountList() {
    const container = document.getElementById('prepCountList');
    if (!container) return;

    // Filter to only PREP items
    const prepItems = orderingSystemState.items.filter(item =>
      item.vendor === 'PREP' || item.category === 'PREP'
    );

    if (prepItems.length === 0) {
      container.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--gray-500); font-size: 13px;">No prep items found. Add prep items using the form above.</p>';
      return;
    }

    // Helper functions
    function getStockStatus(currentStock, parLevel) {
      if (parLevel === 0) return { label: 'N/A', color: '#999', bg: '#f5f5f5' };
      const percentage = (currentStock / parLevel) * 100;
      if (percentage < 30) return { label: 'LOW', color: '#d32f2f', bg: '#ffebee' };
      if (percentage < 70) return { label: 'MEDIUM', color: '#f57c00', bg: '#fff3e0' };
      return { label: 'GOOD', color: '#388e3c', bg: '#e8f5e9' };
    }

    function formatLastCounted(dateStr) {
      if (!dateStr) return 'Never';
      const date = new Date(dateStr);
      const now = new Date();
      const diffMs = now - date;
      const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
      const diffDays = Math.floor(diffHours / 24);

      if (diffHours < 24) return `${diffHours}h ago`;
      if (diffDays < 7) return `${diffDays}d ago`;
      return date.toLocaleDateString('en-US', { month: 'numeric', day: 'numeric', year: '2-digit' });
    }

    let html = `
      <div style="margin-bottom: 20px;">
        <h4 style="background: var(--gray-700); color: var(--white); padding: 12px 16px; border-radius: 0; margin-bottom: 12px; font-size: 14px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;">
          PREP ITEMS <span style="opacity: 0.85; font-weight: 400; font-size: 12px;">(${prepItems.length})</span>
        </h4>

        <!-- Single column layout for all screens -->
        <div style="display: flex; flex-direction: column; gap: ${isCompactMode ? '8px' : '10px'};">
          ${prepItems.map((item) => {
            const status = getStockStatus(item.currentStock, item.parLevel);
            const lastCounted = formatLastCounted(item.lastCountedDate);

            return `
              <div style="
                background: var(--white);
                border: 2px solid var(--gray-300);
                border-radius: 0;
                padding: ${isCompactMode ? '10px' : '14px'};
                box-shadow: 0 1px 3px rgba(0,0,0,0.08);
                transition: box-shadow 0.2s;
              "
              onmouseover="this.style.boxShadow='0 2px 8px rgba(0,0,0,0.12)'"
              onmouseout="this.style.boxShadow='0 1px 3px rgba(0,0,0,0.08)'">

                <!-- Header: Item Name + Status Badge -->
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: ${isCompactMode ? '8px' : '12px'}; gap: 8px;">
                  <div style="flex: 1; font-weight: 700; font-size: ${isCompactMode ? '14px' : '15px'}; line-height: 1.3; color: var(--gray-900); text-transform: uppercase; letter-spacing: 0.5px;">
                    ${item.itemName}
                  </div>
                  <div style="
                    background: ${status.bg};
                    color: ${status.color};
                    padding: ${isCompactMode ? '3px 8px' : '4px 10px'};
                    border-radius: 0;
                    font-size: ${isCompactMode ? '10px' : '11px'};
                    font-weight: 700;
                    white-space: nowrap;
                    letter-spacing: 0.3px;
                  ">
                    ${status.label}
                  </div>
                </div>

                <!-- Metadata Row -->
                <div style="
                  display: flex;
                  gap: ${isCompactMode ? '12px' : '16px'};
                  margin-bottom: ${isCompactMode ? '8px' : '12px'};
                  font-size: ${isCompactMode ? '12px' : '13px'};
                  color: var(--gray-600);
                ">
                  <div>
                    <span style="color: var(--gray-500);">Unit:</span> <strong>${item.unit}</strong>
                  </div>
                  <div>
                    <span style="color: var(--gray-500);">Par:</span> <strong>${item.parLevel}</strong>
                  </div>
                  ${item.batchLifespan ? `<div><span style="color: var(--gray-500);">Life:</span> <strong>${item.batchLifespan}h</strong></div>` : ''}
                  <div style="margin-left: auto; color: var(--gray-500); font-size: ${isCompactMode ? '11px' : '12px'};">
                    ${lastCounted}
                  </div>
                </div>

                <!-- Stock Input with Quick Adjustments -->
                <div>
                  <label style="display: block; font-size: 12px; color: var(--gray-600); margin-bottom: 6px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">
                    Current Stock
                  </label>
                  <div style="display: flex; gap: 5px; align-items: stretch;">
                    <!-- Decrement Button -->
                    <button
                      type="button"
                      onclick="quickAdjustStock(${item.id}, -0.25)"
                      style="
                        flex: 0 0 40px;
                        padding: 0;
                        font-size: 22px;
                        font-weight: 700;
                        background: var(--gray-100);
                        border: 2px solid var(--gray-300);
                        border-radius: 0;
                        color: var(--gray-700);
                        cursor: pointer;
                        transition: all 0.2s;
                        min-height: 48px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                      "
                      onmousedown="this.style.background='var(--gray-300)'; this.style.transform='scale(0.95)';"
                      onmouseup="this.style.background='var(--gray-100)'; this.style.transform='scale(1)';"
                      onmouseleave="this.style.background='var(--gray-100)'; this.style.transform='scale(1)';"
                    >−</button>

                    <!-- Stock Input Field -->
                    <input
                      type="number"
                      inputmode="decimal"
                      id="stock-${item.id}"
                      value="${item.currentStock}"
                      min="0"
                      step="0.25"
                      onblur="autoSaveStockCount(${item.id}, this.value, this)"
                      onchange="autoSaveStockCount(${item.id}, this.value, this)"
                      style="
                        flex: 1;
                        padding: 12px 6px;
                        font-size: 20px;
                        font-weight: 700;
                        text-align: center;
                        border: 2px solid var(--gray-700);
                        border-radius: 0;
                        background: var(--gray-100);
                        color: var(--gray-900);
                        box-sizing: border-box;
                        -webkit-appearance: none;
                        -moz-appearance: textfield;
                        min-height: 48px;
                        transition: all 0.2s;
                      "
                      onfocus="this.style.borderColor='var(--gray-900)'; this.style.background='var(--white)'; this.select();"
                      onblur="this.style.borderColor='var(--gray-700)'; this.style.background='var(--gray-100)';"
                    />

                    <!-- Increment Button -->
                    <button
                      type="button"
                      onclick="quickAdjustStock(${item.id}, 0.25)"
                      style="
                        flex: 0 0 40px;
                        padding: 0;
                        font-size: 22px;
                        font-weight: 700;
                        background: var(--gray-700);
                        border: 2px solid var(--gray-700);
                        border-radius: 0;
                        color: var(--white);
                        cursor: pointer;
                        transition: all 0.2s;
                        min-height: 48px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                      "
                      onmousedown="this.style.background='var(--gray-900)'; this.style.transform='scale(0.95)';"
                      onmouseup="this.style.background='var(--gray-700)'; this.style.transform='scale(1)';"
                      onmouseleave="this.style.background='var(--gray-700)'; this.style.transform='scale(1)';"
                    >+</button>
                  </div>

                  <!-- Save Status Indicator -->
                  <div
                    id="save-status-${item.id}"
                    style="
                      margin-top: 6px;
                      font-size: 11px;
                      text-align: center;
                      min-height: 16px;
                      font-weight: 600;
                      opacity: 0;
                      transition: opacity 0.2s;
                    "
                  ></div>
                </div>
              </div>
            `;
          }).join('')}
        </div>
      </div>
    `;

    container.innerHTML = html;
  }

  /**
   * Filter inventory list based on search and vendor
   */
  function filterInventoryList() {
    const searchTerm = document.getElementById('inventorySearchInput').value.toLowerCase();
    const selectedVendor = document.getElementById('inventoryVendorFilter').value;

    // Filter items
    const filteredItems = orderingSystemState.items.filter(item => {
      const matchesSearch = item.itemName.toLowerCase().includes(searchTerm);
      const matchesVendor = !selectedVendor || item.vendor === selectedVendor;
      return matchesSearch && matchesVendor;
    });

    // Re-render with filtered items
    renderFilteredInventoryList(filteredItems);
  }

  /**
   * Render filtered inventory list
   */
  function renderFilteredInventoryList(filteredItems) {
    const container = document.getElementById('inventoryList');

    if (filteredItems.length === 0) {
      container.innerHTML = '<p style="text-align: center; padding: 20px; color: #999;">No items match your search.</p>';
      return;
    }

    // Group by vendor
    const itemsByVendor = {};
    filteredItems.forEach(item => {
      if (!itemsByVendor[item.vendor]) {
        itemsByVendor[item.vendor] = [];
      }
      itemsByVendor[item.vendor].push(item);
    });

    let html = '';
    sortVendorsWithPrepFirst(Object.keys(itemsByVendor)).forEach(vendor => {
      const items = itemsByVendor[vendor];
      const isPrepCategory = vendor === 'PREP';
      const headerColor = isPrepCategory ? '#ff6b35' : '#1e3c72'; // Orange for PREP, blue for vendors
      html += `
        <div style="margin-bottom: 30px;">
          <h4 style="background: ${headerColor}; color: white; padding: 10px; border-radius: 4px; margin-bottom: 10px;">
            ${isPrepCategory ? '🍳 ' : ''}${vendor} (${items.length} items)
          </h4>
          <table style="width: 100%; border-collapse: collapse;">
            <thead>
              <tr style="background: #f8f9fa;">
                <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Item Name</th>
                <th style="padding: 10px; text-align: center; border: 1px solid #ddd; width: 150px;">Vendor</th>
                <th style="padding: 10px; text-align: center; border: 1px solid #ddd; width: 100px;">Unit</th>
                <th style="padding: 10px; text-align: center; border: 1px solid #ddd; width: 120px;">Par Level</th>
                <th style="padding: 10px; text-align: center; border: 1px solid #ddd; width: 120px;">Current Stock</th>
                <th style="padding: 10px; text-align: center; border: 1px solid #ddd; width: 100px;">Actions</th>
              </tr>
            </thead>
            <tbody>
              ${items.map((item, i) => `
                <tr style="background: ${i % 2 === 0 ? 'white' : '#f8f9fa'};">
                  <td style="padding: 10px; border: 1px solid #ddd;">${item.itemName}</td>
                  <td style="padding: 10px; text-align: center; border: 1px solid #ddd;">
                    <select
                      value="${item.vendor}"
                      onchange="updateItemVendor(${item.id}, this.value)"
                      style="width: 140px; padding: 5px; border: 1px solid #ccc; border-radius: 4px; font-size: 12px;"
                    >
                      ${getAllVendors().map(v => `<option value="${v}" ${v === item.vendor ? 'selected' : ''}>${v}</option>`).join('')}
                    </select>
                  </td>
                  <td style="padding: 10px; text-align: center; border: 1px solid #ddd;">
                    <input
                      type="text"
                      value="${item.unit}"
                      onchange="updateItemUnit(${item.id}, this.value)"
                      style="width: 80px; padding: 5px; text-align: center; border: 1px solid #ccc; border-radius: 4px; font-size: 12px;"
                      placeholder="e.g., CS, EA"
                    />
                  </td>
                  <td style="padding: 10px; text-align: center; border: 1px solid #ddd;">
                    <input
                      type="number"
                      value="${item.parLevel}"
                      min="0"
                      onchange="updateParLevel(${item.id}, this.value)"
                      style="width: 80px; padding: 5px; text-align: center; border: 1px solid #ccc; border-radius: 4px;"
                    />
                  </td>
                  <td style="padding: 10px; text-align: center; border: 1px solid #ddd; color: #666;">${item.currentStock}</td>
                  <td style="padding: 10px; text-align: center; border: 1px solid #ddd;">
                    <button onclick="deleteInventoryItem(${item.id})" style="
                      background: #d32f2f;
                      color: white;
                      border: none;
                      padding: 5px 10px;
                      border-radius: 4px;
                      cursor: pointer;
                      font-size: 12px;
                    ">Delete</button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
    });

    container.innerHTML = html;
  }

  /**
   * Filter stock count list based on search and vendor
   */
  function filterStockCountList() {
    const searchTerm = document.getElementById('stockCountSearchInput').value.toLowerCase();
    const selectedVendor = document.getElementById('stockCountVendorFilter').value;

    // Filter items
    const filteredItems = orderingSystemState.items.filter(item => {
      const matchesSearch = item.itemName.toLowerCase().includes(searchTerm);
      const matchesVendor = !selectedVendor || item.vendor === selectedVendor;
      return matchesSearch && matchesVendor;
    });

    // Re-render with filtered items
    renderFilteredStockCountList(filteredItems);
  }

  /**
   * Render filtered stock count list
   */
  function renderFilteredStockCountList(filteredItems) {
    const container = document.getElementById('stockCountList');

    if (filteredItems.length === 0) {
      container.innerHTML = '<p style="text-align: center; padding: 20px; color: #999;">No items match your search.</p>';
      return;
    }

    // Helper function to get stock status
    function getStockStatus(currentStock, parLevel) {
      if (parLevel === 0) return { label: 'N/A', color: '#999', bg: '#f5f5f5' };
      const percentage = (currentStock / parLevel) * 100;
      if (percentage < 30) return { label: 'LOW', color: '#d32f2f', bg: '#ffebee' };
      if (percentage < 70) return { label: 'MEDIUM', color: '#f57c00', bg: '#fff3e0' };
      return { label: 'GOOD', color: '#388e3c', bg: '#e8f5e9' };
    }

    // Helper function to format last counted date
    function formatLastCounted(dateStr) {
      if (!dateStr) return 'Never';
      const date = new Date(dateStr);
      const now = new Date();
      const diffMs = now - date;
      const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
      const diffDays = Math.floor(diffHours / 24);

      if (diffHours < 24) return `${diffHours}h ago`;
      if (diffDays < 7) return `${diffDays}d ago`;
      return date.toLocaleDateString('en-US', { month: 'numeric', day: 'numeric', year: '2-digit' });
    }

    // Group by vendor
    const itemsByVendor = {};
    filteredItems.forEach(item => {
      if (!itemsByVendor[item.vendor]) {
        itemsByVendor[item.vendor] = [];
      }
      itemsByVendor[item.vendor].push(item);
    });

    let html = '';
    sortVendorsWithPrepFirst(Object.keys(itemsByVendor)).forEach(vendor => {
      const items = itemsByVendor[vendor];
      const isPrepCategory = vendor === 'PREP';
      const headerColor = isPrepCategory ? '#ff6b35' : '#2e7d32'; // Orange for PREP, green for vendors
      html += `
        <div style="margin-bottom: 30px;">
          <h4 style="background: ${headerColor}; color: white; padding: 12px 16px; border-radius: 8px; margin-bottom: 12px; font-size: 16px; font-weight: 600;">
            ${isPrepCategory ? '🍳 ' : ''}${vendor} <span style="opacity: 0.85; font-weight: 400; font-size: 14px;">(${items.length})</span>
          </h4>

          <!-- Single column layout for all screens -->
          <div style="display: flex; flex-direction: column; gap: ${isCompactMode ? '8px' : '10px'};">
            ${items.map((item) => {
              const status = getStockStatus(item.currentStock, item.parLevel);
              const lastCounted = formatLastCounted(item.lastCountedDate);

              return `
                <div style="
                  background: white;
                  border: 1px solid #e0e0e0;
                  border-radius: ${isCompactMode ? '6px' : '8px'};
                  padding: ${isCompactMode ? '10px' : '14px'};
                  box-shadow: 0 1px 3px rgba(0,0,0,0.08);
                  transition: box-shadow 0.2s;
                "
                onmouseover="this.style.boxShadow='0 2px 8px rgba(0,0,0,0.12)'"
                onmouseout="this.style.boxShadow='0 1px 3px rgba(0,0,0,0.08)'">

                  <!-- Header: Item Name + Status Badge -->
                  <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: ${isCompactMode ? '8px' : '12px'}; gap: 8px;">
                    <div style="flex: 1; font-weight: 600; font-size: ${isCompactMode ? '14px' : '15px'}; line-height: 1.3; color: #333;">
                      ${item.itemName}
                    </div>
                    <div style="
                      background: ${status.bg};
                      color: ${status.color};
                      padding: ${isCompactMode ? '3px 8px' : '4px 10px'};
                      border-radius: 12px;
                      font-size: ${isCompactMode ? '10px' : '11px'};
                      font-weight: 700;
                      white-space: nowrap;
                      letter-spacing: 0.3px;
                    ">
                      ${status.label}
                    </div>
                  </div>

                  <!-- Metadata Row -->
                  <div style="
                    display: flex;
                    gap: ${isCompactMode ? '12px' : '16px'};
                    margin-bottom: ${isCompactMode ? '8px' : '12px'};
                    font-size: ${isCompactMode ? '12px' : '13px'};
                    color: #666;
                  ">
                    <div>
                      <span style="color: #999;">Unit:</span> <strong>${item.unit}</strong>
                    </div>
                    <div>
                      <span style="color: #999;">Par:</span> <strong>${item.parLevel}</strong>
                    </div>
                    <div style="margin-left: auto; color: #999; font-size: ${isCompactMode ? '11px' : '12px'};">
                      ${lastCounted}
                    </div>
                  </div>

                  <!-- Stock Input with Quick Adjustments (Mobile-Optimized) -->
                  <div>
                    <label style="display: block; font-size: 12px; color: #666; margin-bottom: 6px; font-weight: 500;">
                      Current Stock
                    </label>
                    <!-- Input with Stepper Buttons -->
                    <div style="display: flex; gap: 5px; align-items: stretch;">
                      <!-- Decrement Button -->
                      <button
                        type="button"
                        onclick="quickAdjustStock(${item.id}, -0.25)"
                        style="
                          flex: 0 0 40px;
                          padding: 0;
                          font-size: 22px;
                          font-weight: 700;
                          background: #f5f5f5;
                          border: 2px solid #e0e0e0;
                          border-radius: 6px;
                          color: #666;
                          cursor: pointer;
                          transition: all 0.2s;
                          min-height: 48px;
                          display: flex;
                          align-items: center;
                          justify-content: center;
                        "
                        onmousedown="this.style.background='#e0e0e0'; this.style.transform='scale(0.95)';"
                        onmouseup="this.style.background='#f5f5f5'; this.style.transform='scale(1)';"
                        onmouseleave="this.style.background='#f5f5f5'; this.style.transform='scale(1)';"
                      >−</button>

                      <!-- Stock Input Field -->
                      <input
                        type="number"
                        inputmode="decimal"
                        id="stock-${item.id}"
                        value="${item.currentStock}"
                        min="0"
                        step="0.25"
                        onblur="autoSaveStockCount(${item.id}, this.value, this)"
                        onchange="autoSaveStockCount(${item.id}, this.value, this)"
                        style="
                          flex: 1;
                          padding: 12px 6px;
                          font-size: 20px;
                          font-weight: 700;
                          text-align: center;
                          border: 2px solid #2e7d32;
                          border-radius: 6px;
                          background: #f9fdf9;
                          color: #2e7d32;
                          box-sizing: border-box;
                          -webkit-appearance: none;
                          -moz-appearance: textfield;
                          min-height: 48px;
                          transition: all 0.2s;
                        "
                        onfocus="this.style.borderColor='#1b5e20'; this.style.background='#ffffff'; this.select();"
                        onblur="this.style.borderColor='#2e7d32'; this.style.background='#f9fdf9';"
                      />

                      <!-- Increment Button -->
                      <button
                        type="button"
                        onclick="quickAdjustStock(${item.id}, 0.25)"
                        style="
                          flex: 0 0 40px;
                          padding: 0;
                          font-size: 22px;
                          font-weight: 700;
                          background: #2e7d32;
                          border: 2px solid #2e7d32;
                          border-radius: 6px;
                          color: white;
                          cursor: pointer;
                          transition: all 0.2s;
                          min-height: 48px;
                          display: flex;
                          align-items: center;
                          justify-content: center;
                        "
                        onmousedown="this.style.background='#1b5e20'; this.style.transform='scale(0.95)';"
                        onmouseup="this.style.background='#2e7d32'; this.style.transform='scale(1)';"
                        onmouseleave="this.style.background='#2e7d32'; this.style.transform='scale(1)';"
                      >+</button>
                    </div>

                    <!-- Save Status Indicator -->
                    <div
                      id="save-status-${item.id}"
                      style="
                        margin-top: 6px;
                        font-size: 11px;
                        text-align: center;
                        min-height: 16px;
                        font-weight: 600;
                        opacity: 0;
                        transition: opacity 0.2s;
                      "
                    ></div>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        </div>
      `;
    });

    container.innerHTML = html;
  }

  /**
   * Update current count session and create/update session record
   */
  async function updateCountSession() {
    const selector = document.getElementById('countSessionSelector');
    const newSession = selector.value;
    orderingSystemState.currentCountSession = newSession;

    // Create or update prep_count_sessions record for today
    const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD

    try {
      const { error } = await supabase
        .from('prep_count_sessions')
        .upsert({
          count_date: today,
          session_type: newSession,
          session_timestamp: new Date().toISOString(),
          notes: 'Session started'
        }, {
          onConflict: 'count_date,session_type'
        });

      if (error) throw error;

      console.log(`Count session updated to: ${newSession} for ${today}`);
    } catch (error) {
      console.error('Failed to update session record:', error);
    }
  }

  /**
   * Track stock updates before saving (legacy - kept for compatibility)
   */
  function trackStockUpdate(itemId, newValue) {
    orderingSystemState.pendingStockUpdates.set(itemId, parseInt(newValue));
    console.log('Tracked stock update:', itemId, newValue);
  }

  /**
   * Auto-save stock count when input loses focus
   */
  async function autoSaveStockCount(itemId, newValue, inputElement) {
    const stockValue = parseFloat(newValue); // Support decimal counts (0.25, 0.5, 0.75)
    if (isNaN(stockValue)) return;

    // Visual feedback - saving state
    const originalBorder = inputElement.style.borderColor;
    const originalBg = inputElement.style.background;
    const statusDiv = document.getElementById(`save-status-${itemId}`);

    inputElement.style.borderColor = '#ff9800';
    inputElement.style.background = '#fff3e0';
    inputElement.disabled = true;

    // Show "Saving..." status
    if (statusDiv) {
      statusDiv.textContent = '💾 Saving...';
      statusDiv.style.color = '#ff9800';
      statusDiv.style.opacity = '1';
    }

    try {
      const { error } = await supabase
        .from('inventory_items')
        .update({
          current_stock: stockValue,
          last_counted_date: new Date().toISOString()
        })
        .eq('id', itemId);

      if (error) throw error;

      // Update local state
      const item = orderingSystemState.items.find(i => i.id === itemId);
      if (item) {
        item.currentStock = stockValue;
        item.lastCountedDate = new Date().toISOString();
      }

      // PREP CONSUMPTION TRACKING: Track consumption between sessions
      if (item && item.itemType === 'prep') {
        const currentSession = orderingSystemState.currentCountSession;
        const previousData = orderingSystemState.previousCounts.get(itemId);
        const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD

        // If we have a previous count from a different session, calculate consumption
        if (previousData && previousData.session !== currentSession) {
          const consumption = previousData.count - stockValue;

          // Only log if there was consumption (or waste if negative)
          if (consumption !== 0) {
            try {
              await supabase
                .from('prep_consumption_log')
                .insert({
                  item_id: itemId,
                  count_date: today,
                  from_session: previousData.session,
                  to_session: currentSession,
                  starting_count: previousData.count,
                  ending_count: stockValue,
                  consumption_amount: consumption > 0 ? consumption : 0,
                  waste_amount: consumption < 0 ? Math.abs(consumption) : 0
                });

              console.log(`Consumption tracked: ${item.itemName} - ${consumption} units from ${previousData.session} to ${currentSession}`);
            } catch (err) {
              console.error('Failed to log consumption:', err);
              // Don't block the save if consumption logging fails
            }
          }
        }

        // Update previous counts with current data
        orderingSystemState.previousCounts.set(itemId, {
          count: stockValue,
          session: currentSession
        });
      }

      // Success feedback - green flash
      inputElement.style.borderColor = '#388e3c';
      inputElement.style.background = '#e8f5e9';

      // Show "Saved!" status
      if (statusDiv) {
        statusDiv.textContent = '✓ Saved!';
        statusDiv.style.color = '#388e3c';
      }

      setTimeout(() => {
        inputElement.style.borderColor = '#2e7d32';
        inputElement.style.background = '#f9fdf9';
        inputElement.disabled = false;

        // Fade out status message
        if (statusDiv) {
          statusDiv.style.opacity = '0';
        }
      }, 800);

      // Recalculate orders in background
      calculateUpcomingOrders();

    } catch (error) {
      console.error('Auto-save failed:', error);
      // Error feedback - red flash
      inputElement.style.borderColor = '#d32f2f';
      inputElement.style.background = '#ffebee';

      // Show error status
      if (statusDiv) {
        statusDiv.textContent = '✗ Failed';
        statusDiv.style.color = '#d32f2f';
      }

      setTimeout(() => {
        inputElement.style.borderColor = originalBorder;
        inputElement.style.background = originalBg;
        inputElement.disabled = false;

        // Fade out error message
        if (statusDiv) {
          statusDiv.style.opacity = '0';
        }
      }, 1000);

      showMessage(`Failed to save: ${error.message}`, 'error');
    }
  }

  /**
   * Quick adjust stock count with +/- buttons (Mobile-Optimized)
   */
  function quickAdjustStock(itemId, adjustment) {
    const inputElement = document.getElementById(`stock-${itemId}`);
    if (!inputElement) return;

    const currentValue = parseFloat(inputElement.value) || 0;
    const newValue = Math.max(0, currentValue + adjustment); // Don't go below 0

    // Round to 2 decimal places to avoid floating point errors
    const roundedValue = Math.round(newValue * 100) / 100;

    inputElement.value = roundedValue;

    // Trigger auto-save
    autoSaveStockCount(itemId, roundedValue, inputElement);
  }

  /**
   * Toggle compact mode for Update Counts view
   */
  let isCompactMode = false;
  function toggleCompactMode() {
    isCompactMode = !isCompactMode;
    const icon = document.getElementById('compactModeIcon');

    if (isCompactMode) {
      // Compact mode: smaller cards, tighter spacing
      icon.textContent = '📱';
      // Apply compact styles by re-rendering
      renderStockCountList();
    } else {
      // Normal mode: larger cards, comfortable spacing
      icon.textContent = '📋';
      // Apply normal styles by re-rendering
      renderStockCountList();
    }
  }

  /**
   * Save all pending stock count updates
   */
  async function saveAllStockCounts() {
    if (orderingSystemState.pendingStockUpdates.size === 0) {
      showMessage('No changes to save!', 'info');
      return;
    }

    showLoading('Saving Stock Counts', `Updating ${orderingSystemState.pendingStockUpdates.size} items...`);

    try {
      const updates = [];
      for (const [itemId, newStock] of orderingSystemState.pendingStockUpdates.entries()) {
        updates.push(
          supabase
            .from('inventory_items')
            .update({
              current_stock: newStock,
              last_counted_date: new Date().toISOString()
            })
            .eq('id', itemId)
        );

        // Update local state
        const item = orderingSystemState.items.find(i => i.id === itemId);
        if (item) {
          item.currentStock = newStock;
          item.lastCountedDate = new Date().toISOString();
        }
      }

      await Promise.all(updates);

      // Clear pending updates
      orderingSystemState.pendingStockUpdates.clear();

      // Recalculate orders
      calculateUpcomingOrders();
      renderStockCountList();

      hideLoading();
      showMessage(`✅ Successfully updated ${updates.length} items!`, 'success');
    } catch (error) {
      hideLoading();
      showMessage(`Error saving stock counts: ${error.message}`, 'error');
    }
  }

  /**
   * Update par level for an item
   */
  async function updateParLevel(itemId, newParLevel) {
    showLoading('Updating Par Level', 'Saving changes...');

    try {
      const { error } = await supabase
        .from('inventory_items')
        .update({ par_level: parseInt(newParLevel) })
        .eq('id', itemId);

      if (error) throw error;

      // Update local state
      const item = orderingSystemState.items.find(i => i.id === itemId);
      if (item) {
        item.parLevel = parseInt(newParLevel);
      }

      // Recalculate orders
      calculateUpcomingOrders();

      hideLoading();
      showMessage('✅ Par level updated!', 'success');
    } catch (error) {
      hideLoading();
      showMessage(`Error updating par level: ${error.message}`, 'error');
    }
  }

  /**
   * Update unit type for an inventory item
   */
  async function updateItemUnit(itemId, newUnit) {
    if (!newUnit || newUnit.trim() === '') {
      showMessage('Unit cannot be empty', 'error');
      return;
    }

    showLoading('Updating Unit', 'Saving changes...');

    try {
      const { error } = await supabase
        .from('inventory_items')
        .update({ unit: newUnit.trim().toUpperCase() })
        .eq('id', itemId);

      if (error) throw error;

      // Update local state
      const item = orderingSystemState.items.find(i => i.id === itemId);
      if (item) {
        item.unit = newUnit.trim().toUpperCase();
      }

      hideLoading();
      showMessage('Unit updated', 'success');

      // Re-render to show updated value
      renderInventoryList();
    } catch (error) {
      hideLoading();
      showMessage('Error updating unit: ' + error.message, 'error');
    }
  }

  /**
   * Handle add new item form submission
   */
  async function handleAddItem(event) {
    event.preventDefault();

    const itemName = document.getElementById('newItemName').value.trim();
    let vendor = document.getElementById('newItemVendor').value;
    const unit = document.getElementById('newItemUnit').value.trim();
    const parLevel = parseInt(document.getElementById('newItemPar').value);

    if (!itemName || !vendor || !unit) {
      showMessage('Please fill in all required fields!', 'error');
      return;
    }

    // Handle new vendor creation
    if (vendor === 'OTHER') {
      const newVendor = prompt('Enter new vendor name:');
      if (!newVendor || newVendor.trim() === '') {
        showMessage('Vendor name is required', 'error');
        return;
      }
      vendor = newVendor.trim();
    }

    showLoading('Adding Item', 'Saving to database...');

    try {
      const { data, error } = await supabase
        .from('inventory_items')
        .insert([{
          item_name: itemName,
          vendor: vendor,
          unit: unit,
          par_level: parLevel,
          current_stock: 0,
          created_date: new Date().toISOString()
        }])
        .select();

      if (error) throw error;

      // Add to local state
      orderingSystemState.items.push({
        id: data[0].id,
        itemName: data[0].item_name,
        vendor: data[0].vendor,
        parLevel: data[0].par_level,
        currentStock: data[0].current_stock,
        unit: data[0].unit,
        lastCountedDate: null
      });

      // Reset form
      document.getElementById('addItemForm').reset();

      // Refresh displays
      renderInventoryList();
      renderStockCountList();
      renderPrepCountList();
      calculateUpcomingOrders();

      hideLoading();
      showMessage('✅ Item added successfully!', 'success');
    } catch (error) {
      hideLoading();
      showMessage(`Error adding item: ${error.message}`, 'error');
    }
  }

  /**
   * Handle adding a new prep item
   */
  async function handleAddPrepItem(event) {
    event.preventDefault();

    const itemName = document.getElementById('newPrepItemName').value.trim();
    let vendor = document.getElementById('newPrepItemVendor').value;
    const unit = document.getElementById('newPrepItemUnit').value.trim().toUpperCase();
    const parLevel = parseFloat(document.getElementById('newPrepItemPar').value);
    const batchLifespan = parseInt(document.getElementById('newPrepItemLifespan').value);
    const storageLocation = document.getElementById('newPrepItemStorage').value;

    if (!itemName || !vendor || !unit) {
      showMessage('Please fill in all required fields!', 'error');
      return;
    }

    // Handle new vendor creation
    if (vendor === 'OTHER') {
      const newVendor = prompt('Enter new vendor name:');
      if (!newVendor || newVendor.trim() === '') {
        showMessage('Vendor name is required', 'error');
        return;
      }
      vendor = newVendor.trim();
    }

    showLoading('Adding Prep Item', 'Saving to database...');

    try {
      const { data, error } = await supabase
        .from('inventory_items')
        .insert([{
          item_name: itemName,
          vendor: vendor,
          unit: unit,
          par_level: parLevel,
          current_stock: 0,
          category: 'PREP',
          batch_lifespan: batchLifespan,
          storage_location: storageLocation,
          created_date: new Date().toISOString()
        }])
        .select();

      if (error) throw error;

      // Add to local state
      orderingSystemState.items.push({
        id: data[0].id,
        itemName: data[0].item_name,
        vendor: data[0].vendor,
        parLevel: data[0].par_level,
        currentStock: data[0].current_stock,
        unit: data[0].unit,
        category: 'PREP',
        batchLifespan: data[0].batch_lifespan,
        storageLocation: data[0].storage_location,
        lastCountedDate: null
      });

      // Reset form
      document.getElementById('addPrepItemForm').reset();

      // Refresh displays
      renderInventoryList();
      renderStockCountList();
      renderPrepCountList();
      refreshPrepSheet(); // Refresh prep recommendations

      hideLoading();
      showMessage('Prep item added successfully!', 'success');
    } catch (error) {
      hideLoading();
      showMessage(`Error adding prep item: ${error.message}`, 'error');
    }
  }

  /**
   * Delete an inventory item
   */
  async function deleteInventoryItem(itemId) {
    if (!confirm('Are you sure you want to delete this item? This action cannot be undone.')) {
      return;
    }

    showLoading('Deleting Item', 'Removing from database...');

    try {
      const { error } = await supabase
        .from('inventory_items')
        .delete()
        .eq('id', itemId);

      if (error) throw error;

      // Remove from local state
      orderingSystemState.items = orderingSystemState.items.filter(i => i.id !== itemId);

      // Refresh displays
      renderInventoryList();
      renderStockCountList();
      renderPrepCountList();
      calculateUpcomingOrders();

      hideLoading();
      showMessage('✅ Item deleted successfully!', 'success');
    } catch (error) {
      hideLoading();
      showMessage(`Error deleting item: ${error.message}`, 'error');
    }
  }

  /**
   * Get all unique vendors from inventory
   */
  function getAllVendors() {
    const vendors = new Set();
    orderingSystemState.items.forEach(item => {
      if (item.vendor) vendors.add(item.vendor);
    });
    return Array.from(vendors).sort();
  }

  /**
   * Update item vendor
   */
  async function updateItemVendor(itemId, newVendor) {
    showLoading('Updating Vendor', 'Saving changes...');

    try {
      const { error } = await supabase
        .from('inventory_items')
        .update({ vendor: newVendor })
        .eq('id', itemId);

      if (error) throw error;

      // Update local state
      const item = orderingSystemState.items.find(i => i.id === itemId);
      if (item) {
        item.vendor = newVendor;
      }

      // Refresh displays
      renderInventoryList();
      renderStockCountList();
      renderPrepCountList();
      calculateUpcomingOrders();

      hideLoading();
      showMessage('✅ Vendor updated!', 'success');
    } catch (error) {
      hideLoading();
      showMessage(`Error updating vendor: ${error.message}`, 'error');
    }
  }

  /**
   * Rename vendor (updates all items with that vendor)
   */
  async function renameVendor(oldVendorName, newVendorName) {
    if (!newVendorName || newVendorName.trim() === '') {
      showMessage('Vendor name cannot be empty!', 'error');
      return;
    }

    const itemsWithVendor = orderingSystemState.items.filter(i => i.vendor === oldVendorName);

    if (itemsWithVendor.length === 0) {
      showMessage('No items found for this vendor!', 'error');
      return;
    }

    if (!confirm(`Rename "${oldVendorName}" to "${newVendorName}"? This will update ${itemsWithVendor.length} items.`)) {
      return;
    }

    showLoading('Renaming Vendor', `Updating ${itemsWithVendor.length} items...`);

    try {
      const { error } = await supabase
        .from('inventory_items')
        .update({ vendor: newVendorName })
        .eq('vendor', oldVendorName);

      if (error) throw error;

      // Update local state
      itemsWithVendor.forEach(item => {
        item.vendor = newVendorName;
      });

      // Refresh displays
      renderInventoryList();
      renderStockCountList();
      renderPrepCountList();
      calculateUpcomingOrders();

      hideLoading();
      showMessage(`✅ Renamed "${oldVendorName}" to "${newVendorName}" (${itemsWithVendor.length} items updated)`, 'success');
    } catch (error) {
      hideLoading();
      showMessage(`Error renaming vendor: ${error.message}`, 'error');
    }
  }

  /**
   * Delete vendor (requires moving all items to another vendor first)
   */
  async function deleteVendor(vendorName) {
    const itemsWithVendor = orderingSystemState.items.filter(i => i.vendor === vendorName);

    if (itemsWithVendor.length > 0) {
      showMessage(`Cannot delete vendor "${vendorName}" - ${itemsWithVendor.length} items are still assigned to it. Move them to another vendor first.`, 'error');
      return;
    }

    showMessage(`Vendor "${vendorName}" has no items and can be removed. Simply rename it or ignore it.`, 'info');
  }

  /**
   * Show vendor management modal
   */
  function showVendorManagement() {
    const vendors = getAllVendors();
    const vendorList = vendors.map(vendor => {
      const itemCount = orderingSystemState.items.filter(i => i.vendor === vendor).length;
      return `
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #e0e0e0;">
          <div>
            <strong style="font-size: 15px;">${vendor}</strong>
            <span style="color: #666; font-size: 13px; margin-left: 8px;">(${itemCount} items)</span>
          </div>
          <div style="display: flex; gap: 8px;">
            <button onclick="promptRenameVendor('${vendor.replace(/'/g, "\\'")}')" style="
              background: #1e3c72;
              color: white;
              border: none;
              padding: 6px 12px;
              border-radius: 4px;
              cursor: pointer;
              font-size: 12px;
            ">Rename</button>
          </div>
        </div>
      `;
    }).join('');

    const modalHTML = `
      <div style="
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10000;
      " onclick="closeVendorManagement(event)">
        <div style="
          background: white;
          border-radius: 8px;
          padding: 24px;
          max-width: 600px;
          width: 90%;
          max-height: 80vh;
          overflow-y: auto;
        " onclick="event.stopPropagation()">
          <h2 style="margin: 0 0 20px 0; color: #1e3c72;">Vendor Management</h2>
          <div style="margin-bottom: 20px;">
            ${vendorList}
          </div>
          <button onclick="closeVendorManagement()" class="submit-btn" style="background: #666;">Close</button>
        </div>
      </div>
    `;

    const modalDiv = document.createElement('div');
    modalDiv.id = 'vendorManagementModal';
    modalDiv.innerHTML = modalHTML;
    document.body.appendChild(modalDiv);
  }

  /**
   * Close vendor management modal
   */
  function closeVendorManagement(event) {
    if (event && event.target !== event.currentTarget) return;
    const modal = document.getElementById('vendorManagementModal');
    if (modal) modal.remove();
  }

  /**
   * Prompt to rename vendor
   */
  function promptRenameVendor(vendorName) {
    const newName = prompt(`Rename vendor "${vendorName}" to:`, vendorName);
    if (newName && newName !== vendorName) {
      renameVendor(vendorName, newName);
      closeVendorManagement();
    }
  }

  // ============================================
  // PREP SHEET SYSTEM
  // ============================================

  /**
   * Refresh prep sheet with current recommendations
   */
  async function refreshPrepSheet() {
    console.log('Refreshing prep sheet...');
    const prepItems = orderingSystemState.items.filter(item => item.itemType === 'prep');

    if (prepItems.length === 0) {
      document.getElementById('prepRecommendationsList').innerHTML = `
        <div style="text-align: center; padding: 40px; background: #f8f9fa; border-radius: 8px;">
          <p style="color: #666; font-size: 16px;">No prep items found. Add prep items to get started!</p>
        </div>
      `;
      return;
    }

    // Fetch consumption data for all prep items
    const today = new Date().toISOString().split('T')[0];
    const sevenDaysAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];

    try {
      const { data: consumptionData, error } = await supabase
        .from('prep_consumption_log')
        .select('*')
        .gte('count_date', sevenDaysAgo)
        .lte('count_date', today);

      if (error) throw error;

      // Calculate recommendations for each prep item
      const recommendations = prepItems.map(item => {
        return calculatePrepRecommendation(item, consumptionData);
      });

      // Sort by priority (lowest stock % first, then by consumption rate)
      recommendations.sort((a, b) => {
        if (a.stockPercentage !== b.stockPercentage) {
          return a.stockPercentage - b.stockPercentage;
        }
        return (b.avgConsumptionRate || 0) - (a.avgConsumptionRate || 0);
      });

      // Render summary stats
      renderPrepSummaryStats(recommendations);

      // Render recommendations list
      renderPrepRecommendations(recommendations);

    } catch (error) {
      console.error('Error refreshing prep sheet:', error);
      showMessage(`Error loading prep data: ${error.message}`, 'error');
    }
  }

  /**
   * Calculate recommendation for a single prep item
   */
  function calculatePrepRecommendation(item, consumptionData) {
    // Filter consumption data for this item
    const itemConsumption = consumptionData.filter(c => c.item_id === item.id);

    // Calculate average consumption rate
    let avgConsumptionRate = 0;
    let totalConsumption = 0;
    if (itemConsumption.length > 0) {
      totalConsumption = itemConsumption.reduce((sum, c) => sum + (c.consumption_amount || 0), 0);
      avgConsumptionRate = totalConsumption / itemConsumption.length;
    }

    // Calculate stock percentage (current / par)
    const stockPercentage = item.parLevel > 0 ? (item.currentStock / item.parLevel) * 100 : 0;

    // Determine recommendation amount
    let recommendedAmount = 0;
    let priority = 'low';
    let reasoning = '';

    if (item.currentStock === 0) {
      // Out of stock - urgent
      recommendedAmount = Math.max(item.parLevel, Math.ceil(avgConsumptionRate * 2)); // At least par or 2x consumption
      priority = 'urgent';
      reasoning = 'Out of stock - make immediately';
    } else if (stockPercentage < 50) {
      // Low stock - high priority
      recommendedAmount = Math.ceil(item.parLevel - item.currentStock);
      priority = 'high';
      reasoning = `Stock below 50% (${stockPercentage.toFixed(0)}%)`;
    } else if (stockPercentage < 75 && avgConsumptionRate > 0) {
      // Medium stock but consuming - medium priority
      recommendedAmount = Math.ceil(avgConsumptionRate * 1.5);
      priority = 'medium';
      reasoning = `Stock at ${stockPercentage.toFixed(0)}%, consuming ${avgConsumptionRate.toFixed(1)}/session`;
    } else {
      // Stock is good
      priority = 'low';
      reasoning = `Stock good (${stockPercentage.toFixed(0)}%)`;
    }

    return {
      id: item.id,
      itemName: item.itemName,
      currentStock: item.currentStock,
      parLevel: item.parLevel,
      unit: item.unit,
      stockPercentage,
      avgConsumptionRate,
      recommendedAmount,
      priority,
      reasoning,
      lastCountedDate: item.lastCountedDate
    };
  }

  /**
   * Render summary statistics
   */
  function renderPrepSummaryStats(recommendations) {
    const urgent = recommendations.filter(r => r.priority === 'urgent').length;
    const high = recommendations.filter(r => r.priority === 'high').length;
    const medium = recommendations.filter(r => r.priority === 'medium').length;
    const low = recommendations.filter(r => r.priority === 'low').length;

    const totalToPrepare = recommendations.filter(r => r.recommendedAmount > 0).length;

    document.getElementById('prepSummaryStats').innerHTML = `
      <div style="background: #ffebee; padding: 16px; border-radius: 8px; border-left: 4px solid #d32f2f;">
        <div style="font-size: 24px; font-weight: 700; color: #d32f2f;">${urgent}</div>
        <div style="font-size: 13px; color: #666; margin-top: 4px;">Urgent Items</div>
      </div>
      <div style="background: #fff3e0; padding: 16px; border-radius: 8px; border-left: 4px solid #ff9800;">
        <div style="font-size: 24px; font-weight: 700; color: #ff9800;">${high}</div>
        <div style="font-size: 13px; color: #666; margin-top: 4px;">High Priority</div>
      </div>
      <div style="background: #fff9c4; padding: 16px; border-radius: 8px; border-left: 4px solid #fbc02d;">
        <div style="font-size: 24px; font-weight: 700; color: #f57f17;">${medium}</div>
        <div style="font-size: 13px; color: #666; margin-top: 4px;">Medium Priority</div>
      </div>
      <div style="background: #e8f5e9; padding: 16px; border-radius: 8px; border-left: 4px solid #2e7d32;">
        <div style="font-size: 24px; font-weight: 700; color: #2e7d32;">${totalToPrepare}</div>
        <div style="font-size: 13px; color: #666; margin-top: 4px;">Total to Prepare</div>
      </div>
    `;
  }

  /**
   * Render prep recommendations list
   */
  function renderPrepRecommendations(recommendations) {
    const container = document.getElementById('prepRecommendationsList');

    if (recommendations.length === 0) {
      container.innerHTML = `
        <div style="text-align: center; padding: 40px;">
          <p style="color: #666;">All prep items are well-stocked! 🎉</p>
        </div>
      `;
      return;
    }

    // Group by priority
    const urgent = recommendations.filter(r => r.priority === 'urgent');
    const high = recommendations.filter(r => r.priority === 'high');
    const medium = recommendations.filter(r => r.priority === 'medium');
    const low = recommendations.filter(r => r.priority === 'low');

    let html = '';

    // Render each priority group
    if (urgent.length > 0) {
      html += renderPriorityGroup('🚨 URGENT - Out of Stock', urgent, '#d32f2f', '#ffebee');
    }
    if (high.length > 0) {
      html += renderPriorityGroup('⚠️ HIGH PRIORITY - Low Stock', high, '#ff9800', '#fff3e0');
    }
    if (medium.length > 0) {
      html += renderPriorityGroup('📋 MEDIUM PRIORITY', medium, '#fbc02d', '#fff9c4');
    }
    if (low.length > 0) {
      html += renderPriorityGroup('✅ LOW PRIORITY - Stock Good', low, '#2e7d32', '#e8f5e9');
    }

    container.innerHTML = html;
  }

  /**
   * Render a priority group of recommendations
   */
  function renderPriorityGroup(title, items, borderColor, bgColor) {
    const itemsHTML = items.map(item => {
      const lastCountStr = item.lastCountedDate ? formatRelativeTime(item.lastCountedDate) : 'Never';
      const stockStatus = item.currentStock === 0 ? '❌ OUT' : `${item.currentStock} ${item.unit}`;

      return `
        <div style="
          display: grid;
          grid-template-columns: 2fr 1fr 1fr 1fr 2fr;
          gap: 12px;
          padding: 12px 16px;
          border-bottom: 1px solid #e0e0e0;
          align-items: center;
        ">
          <div>
            <div style="font-weight: 600; font-size: 14px; color: #333;">${item.itemName}</div>
            <div style="font-size: 11px; color: #999; margin-top: 2px;">Last count: ${lastCountStr}</div>
          </div>
          <div style="text-align: center;">
            <div style="font-weight: 600; font-size: 16px; color: ${item.currentStock === 0 ? '#d32f2f' : '#333'};">${stockStatus}</div>
            <div style="font-size: 11px; color: #666;">Current</div>
          </div>
          <div style="text-align: center;">
            <div style="font-weight: 600; font-size: 16px; color: #666;">${item.parLevel} ${item.unit}</div>
            <div style="font-size: 11px; color: #666;">Par</div>
          </div>
          <div style="text-align: center;">
            <div style="font-weight: 700; font-size: 18px; color: ${borderColor};">${item.recommendedAmount > 0 ? item.recommendedAmount : '—'}</div>
            <div style="font-size: 11px; color: #666;">To Make</div>
          </div>
          <div style="font-size: 12px; color: #666; font-style: italic;">
            ${item.reasoning}
          </div>
        </div>
      `;
    }).join('');

    return `
      <div style="margin-bottom: 24px;">
        <h4 style="
          background: ${bgColor};
          color: ${borderColor};
          padding: 12px 16px;
          border-radius: 6px 6px 0 0;
          border-left: 4px solid ${borderColor};
          margin: 0;
          font-size: 15px;
        ">
          ${title} (${items.length} items)
        </h4>
        <div style="background: white; border: 1px solid #e0e0e0; border-top: none; border-radius: 0 0 6px 6px;">
          <!-- Header Row -->
          <div style="
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 2fr;
            gap: 12px;
            padding: 10px 16px;
            background: #f8f9fa;
            border-bottom: 2px solid #e0e0e0;
            font-size: 12px;
            font-weight: 600;
            color: #666;
            text-transform: uppercase;
          ">
            <div>Item Name</div>
            <div style="text-align: center;">Current</div>
            <div style="text-align: center;">Par</div>
            <div style="text-align: center;">Recommend</div>
            <div>Reasoning</div>
          </div>
          ${itemsHTML}
        </div>
      </div>
    `;
  }

  /**
   * Generate prep sheet PDF
   */
  async function generatePrepSheetPDF() {
    showMessage('Generating prep sheet PDF...', 'info');
    // TODO: Implement PDF generation using jsPDF
    showMessage('PDF generation coming soon!', 'info');
  }

  /**
   * Print prep sheet
   */
  function printPrepSheet() {
    const prepSheet = document.getElementById('prepRecommendationsList');
    if (!prepSheet) return;

    const printWindow = window.open('', '', 'height=800,width=1000');
    printWindow.document.write('<html><head><title>Prep Sheet - ' + new Date().toLocaleDateString() + '</title>');
    printWindow.document.write('<style>body{font-family: Arial, sans-serif; padding: 20px;} table{width:100%; border-collapse: collapse;} th, td{border: 1px solid #ddd; padding: 8px; text-align: left;} th{background: #ff6b35; color: white;}</style>');
    printWindow.document.write('</head><body>');
    printWindow.document.write('<h1 style="color: #ff6b35;">🍳 Prep Sheet - ' + new Date().toLocaleDateString() + '</h1>');
    printWindow.document.write(prepSheet.innerHTML);
    printWindow.document.write('</body></html>');
    printWindow.document.close();
    printWindow.print();
  }

  // ===================================================================
  // INVOICE CHECK-IN SYSTEM - DOM-BASED MODAL APPROACH (SAFE)
  // ===================================================================

  /**
   * Handle invoice/order image upload
   */
  function handleInvoiceUpload(event) {
    const file = event.target.files[0];
    if (!file) return;

    // Validate file type
    if (!file.type.startsWith('image/')) {
      showMessage('Please upload an image file (JPG, PNG, etc.)', 'error');
      return;
    }

    // Convert to base64 and display preview
    const reader = new FileReader();
    reader.onload = function(e) {
      orderingSystemState.currentInvoiceImage = e.target.result;

      // Show preview section
      document.getElementById('invoicePreviewSection').style.display = 'block';
      document.getElementById('invoicePreviewImage').src = e.target.result;

      // Hide other sections
      document.getElementById('ocrProcessingStatus').style.display = 'none';
      document.getElementById('extractedItemsSection').style.display = 'none';
    };
    reader.readAsDataURL(file);
  }

  /**
   * Clear uploaded invoice and reset
   */
  function clearInvoiceUpload() {
    orderingSystemState.currentInvoiceImage = null;
    orderingSystemState.extractedInvoiceItems = [];

    document.getElementById('invoiceFileInput').value = '';
    document.getElementById('invoiceCameraInput').value = '';
    document.getElementById('invoicePreviewSection').style.display = 'none';
    document.getElementById('ocrProcessingStatus').style.display = 'none';
    document.getElementById('extractedItemsSection').style.display = 'none';
  }

  /**
   * Process invoice with Tesseract OCR
   */
  async function processInvoiceOCR() {
    if (!orderingSystemState.currentInvoiceImage) {
      showMessage('No image uploaded', 'error');
      return;
    }

    // Show processing status
    document.getElementById('ocrProcessingStatus').style.display = 'block';
    document.getElementById('ocrProgressText').textContent = 'Initializing OCR engine...';
    document.getElementById('processOCRButton').disabled = true;

    try {
      // Initialize Tesseract
      const worker = await Tesseract.createWorker('eng');

      // Update progress
      document.getElementById('ocrProgressText').textContent = 'Extracting text from image...';

      // Perform OCR
      const { data } = await worker.recognize(orderingSystemState.currentInvoiceImage);

      // Update progress
      document.getElementById('ocrProgressText').textContent = 'Parsing extracted text...';

      // Parse the extracted text to find items
      const extractedItems = parseInvoiceText(data.text);

      if (extractedItems.length === 0) {
        showMessage('No items found in invoice. Please try a clearer image.', 'warning');
        document.getElementById('ocrProcessingStatus').style.display = 'none';
        document.getElementById('processOCRButton').disabled = false;
        await worker.terminate();
        return;
      }

      // Update progress
      document.getElementById('ocrProgressText').textContent = 'Matching items with inventory...';

      // Match items with inventory using fuzzy matching
      for (const item of extractedItems) {
        const match = fuzzyMatchInventoryItem(item.name);
        if (match) {
          item.matchedInventoryId = match.id;
          item.matchConfidence = match.confidence;
          item.matchedItemName = match.itemName;
        }
      }

      // Store extracted items
      orderingSystemState.extractedInvoiceItems = extractedItems;

      // Hide processing, show results
      document.getElementById('ocrProcessingStatus').style.display = 'none';
      document.getElementById('extractedItemsSection').style.display = 'block';

      // Render extracted items
      renderExtractedItems();

      // Cleanup
      await worker.terminate();
      document.getElementById('processOCRButton').disabled = false;

      showMessage(`Successfully extracted ${extractedItems.length} items from invoice!`, 'success');

    } catch (error) {
      console.error('OCR processing error:', error);
      showMessage('Failed to process invoice: ' + error.message, 'error');
      document.getElementById('ocrProcessingStatus').style.display = 'none';
      document.getElementById('processOCRButton').disabled = false;
    }
  }

  /**
   * Parse extracted OCR text to find line items
   * Simple pattern matching for common invoice formats
   */
  function parseInvoiceText(text) {
    const items = [];
    const lines = text.split('\n');

    // Pattern to match: quantity, item name, price
    // Example: "2 Arugula 4# CS 12.50" or "1.5 Fresh Basil Bunch 8.99"
    const itemPattern = /^[\s]*([0-9]+\.?[0-9]*)\s+(.+?)\s+([0-9]+\.[0-9]{2})[\s]*$/;

    for (const line of lines) {
      const trimmed = line.trim();
      if (trimmed.length < 5) continue; // Skip short lines

      const match = trimmed.match(itemPattern);
      if (match) {
        const quantity = parseFloat(match[1]);
        const name = match[2].trim();
        const price = parseFloat(match[3]);

        // Only add if quantity is reasonable (0.25 to 1000)
        if (quantity >= 0.25 && quantity <= 1000 && name.length > 2) {
          items.push({
            id: Date.now() + Math.random(), // Temporary ID
            detectedName: name,
            detectedQuantity: quantity,
            detectedPrice: price,
            matchedInventoryId: null,
            matchConfidence: 0,
            matchedItemName: null
          });
        }
      }
    }

    return items;
  }

  /**
   * Fuzzy match detected item name with inventory items
   * Returns {id, itemName, confidence} or null
   */
  function fuzzyMatchInventoryItem(detectedName) {
    if (!detectedName || orderingSystemState.items.length === 0) return null;

    const normalizedDetected = detectedName.toLowerCase().replace(/[^a-z0-9\s]/g, '');
    let bestMatch = null;
    let bestScore = 0;

    for (const item of orderingSystemState.items) {
      const normalizedItem = item.itemName.toLowerCase().replace(/[^a-z0-9\s]/g, '');

      // Calculate similarity score (simple word matching)
      const detectedWords = normalizedDetected.split(/\s+/);
      const itemWords = normalizedItem.split(/\s+/);

      let matchCount = 0;
      for (const word of detectedWords) {
        if (word.length < 3) continue; // Skip short words
        for (const itemWord of itemWords) {
          if (itemWord.includes(word) || word.includes(itemWord)) {
            matchCount++;
            break;
          }
        }
      }

      const score = matchCount / Math.max(detectedWords.length, itemWords.length);

      if (score > bestScore) {
        bestScore = score;
        bestMatch = {
          id: item.id,
          itemName: item.itemName,
          confidence: score
        };
      }
    }

    // Only return match if confidence is above threshold
    return bestScore > 0.4 ? bestMatch : null;
  }

  /**
   * Render extracted invoice items with matched inventory
   * Uses DOM manipulation to avoid template literal issues
   */
  function renderExtractedItems() {
    const container = document.getElementById('extractedItemsList');
    if (!container) return;

    // Clear existing items
    container.innerHTML = '';

    if (orderingSystemState.extractedInvoiceItems.length === 0) {
      const emptyMessage = document.createElement('p');
      emptyMessage.textContent = 'No items extracted yet.';
      emptyMessage.style.textAlign = 'center';
      emptyMessage.style.color = '#666';
      emptyMessage.style.padding = '20px';
      container.appendChild(emptyMessage);
      return;
    }

    // Create a card for each extracted item
    orderingSystemState.extractedInvoiceItems.forEach((item, index) => {
      const card = document.createElement('div');
      card.style.cssText = 'background: var(--white); border: 2px solid var(--gray-300); border-radius: 0; padding: 12px; margin-bottom: 10px;';

      // Header row with detected name and quantity
      const headerRow = document.createElement('div');
      headerRow.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;';

      const detectedName = document.createElement('strong');
      detectedName.textContent = item.detectedName;
      detectedName.style.cssText = 'font-size: 14px; color: var(--gray-900); text-transform: uppercase; letter-spacing: 0.5px;';

      const detectedQty = document.createElement('span');
      detectedQty.textContent = 'QTY: ' + item.detectedQuantity;
      detectedQty.style.cssText = 'background: var(--gray-100); padding: 4px 8px; border-radius: 0; font-size: 11px; font-weight: 700; color: var(--gray-700); letter-spacing: 0.5px;';

      headerRow.appendChild(detectedName);
      headerRow.appendChild(detectedQty);
      card.appendChild(headerRow);

      // Match confidence indicator
      const matchRow = document.createElement('div');
      matchRow.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;';

      const matchInfo = document.createElement('div');
      matchInfo.style.flex = '1';

      if (item.matchedInventoryId) {
        // Has a match
        const matchLabel = document.createElement('div');
        matchLabel.textContent = 'Matched: ' + item.matchedItemName;
        matchLabel.style.cssText = 'font-size: 12px; color: var(--gray-700); margin-bottom: 4px;';

        const confidenceBadge = document.createElement('span');
        const confidence = Math.round(item.matchConfidence * 100);
        confidenceBadge.textContent = confidence + '%';
        confidenceBadge.style.cssText = 'font-size: 10px; padding: 2px 6px; border-radius: 0; font-weight: 700; letter-spacing: 0.5px;';

        // Grayscale based on confidence (darker = higher confidence)
        if (item.matchConfidence >= 0.7) {
          confidenceBadge.style.background = 'var(--gray-700)';
          confidenceBadge.style.color = 'var(--white)';
        } else if (item.matchConfidence >= 0.5) {
          confidenceBadge.style.background = 'var(--gray-400)';
          confidenceBadge.style.color = 'var(--gray-900)';
        } else {
          confidenceBadge.style.background = 'var(--gray-300)';
          confidenceBadge.style.color = 'var(--gray-700)';
        }

        matchInfo.appendChild(matchLabel);
        matchInfo.appendChild(confidenceBadge);
      } else {
        // No match found
        const noMatchLabel = document.createElement('div');
        noMatchLabel.textContent = 'NO MATCH FOUND';
        noMatchLabel.style.cssText = 'font-size: 11px; color: var(--gray-500); font-weight: 700; letter-spacing: 0.5px;';
        matchInfo.appendChild(noMatchLabel);
      }

      matchRow.appendChild(matchInfo);

      // Manual match button for low confidence or no match
      if (!item.matchedInventoryId || item.matchConfidence < 0.7) {
        const manualMatchBtn = document.createElement('button');
        manualMatchBtn.textContent = item.matchedInventoryId ? 'CHANGE' : 'MATCH';
        manualMatchBtn.style.cssText = 'background: var(--gray-100); color: var(--gray-900); border: 2px solid var(--gray-300); padding: 6px 12px; border-radius: 0; cursor: pointer; font-size: 10px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase;';
        manualMatchBtn.onclick = function() { showManualMatchModal(index); };
        matchRow.appendChild(manualMatchBtn);
      }

      card.appendChild(matchRow);

      // Price info
      if (item.detectedPrice) {
        const priceLabel = document.createElement('div');
        priceLabel.textContent = 'PRICE: $' + item.detectedPrice.toFixed(2);
        priceLabel.style.cssText = 'font-size: 11px; color: var(--gray-500); margin-top: 6px; font-weight: 700; letter-spacing: 0.5px;';
        card.appendChild(priceLabel);
      }

      container.appendChild(card);
    });

    // Add check-in button at the bottom
    const checkInButton = document.createElement('button');
    checkInButton.textContent = 'CHECK IN ALL ITEMS';
    checkInButton.className = 'submit-btn';
    checkInButton.style.cssText = 'width: 100%; padding: 14px; background: var(--gray-100); color: var(--gray-900); border: 2px solid var(--gray-300); border-radius: 0; font-size: 12px; font-weight: 700; letter-spacing: 1.2px; text-transform: uppercase; cursor: pointer; margin-top: 20px;';
    checkInButton.onclick = checkInInvoiceItems;
    container.appendChild(checkInButton);
  }

  /**
   * Show manual matching modal using DOM manipulation (Option 1 - safest)
   * Avoids template literals that caused previous crash
   */
  function showManualMatchModal(itemIndex) {
    const item = orderingSystemState.extractedInvoiceItems[itemIndex];
    if (!item) return;

    // Create modal overlay
    const overlay = document.createElement('div');
    overlay.id = 'manualMatchModal';
    overlay.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 10000;';

    // Create modal content container
    const modal = document.createElement('div');
    modal.style.cssText = 'background: var(--white); border-radius: 0; padding: 20px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; border: 2px solid var(--gray-400);';

    // Header
    const header = document.createElement('h3');
    header.textContent = 'MANUAL ITEM MATCHING';
    header.style.cssText = 'margin: 0 0 16px 0; font-size: 14px; color: var(--gray-900); font-weight: 700; text-transform: uppercase; letter-spacing: 1px;';
    modal.appendChild(header);

    // Detected item info
    const detectedInfo = document.createElement('div');
    detectedInfo.style.cssText = 'background: var(--gray-100); padding: 12px; border-radius: 0; margin-bottom: 16px; border: 1px solid var(--gray-300);';

    const detectedLabel = document.createElement('div');
    detectedLabel.textContent = 'DETECTED ITEM:';
    detectedLabel.style.cssText = 'font-size: 10px; color: var(--gray-500); margin-bottom: 4px; font-weight: 700; letter-spacing: 0.5px;';
    detectedInfo.appendChild(detectedLabel);

    const detectedName = document.createElement('div');
    detectedName.textContent = item.detectedName;
    detectedName.style.cssText = 'font-size: 14px; font-weight: 700; color: var(--gray-900); text-transform: uppercase; letter-spacing: 0.5px;';
    detectedInfo.appendChild(detectedName);

    modal.appendChild(detectedInfo);

    // Search box
    const searchLabel = document.createElement('label');
    searchLabel.textContent = 'SEARCH INVENTORY:';
    searchLabel.style.cssText = 'display: block; font-size: 11px; margin-bottom: 8px; color: var(--gray-700); font-weight: 700; letter-spacing: 0.5px;';
    modal.appendChild(searchLabel);

    const searchInput = document.createElement('input');
    searchInput.type = 'text';
    searchInput.placeholder = 'Type to search...';
    searchInput.style.cssText = 'width: 100%; padding: 10px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 13px; margin-bottom: 16px; box-sizing: border-box;';
    modal.appendChild(searchInput);

    // Items list container
    const itemsList = document.createElement('div');
    itemsList.id = 'manualMatchItemsList';
    itemsList.style.cssText = 'max-height: 300px; overflow-y: auto; border: 2px solid var(--gray-300); border-radius: 0; margin-bottom: 16px;';
    modal.appendChild(itemsList);

    // Function to render inventory items
    function renderInventoryItems(filter = '') {
      itemsList.innerHTML = '';

      const filterLower = filter.toLowerCase();
      const filteredItems = orderingSystemState.items.filter(invItem =>
        invItem.itemName.toLowerCase().includes(filterLower) ||
        invItem.vendor.toLowerCase().includes(filterLower)
      );

      if (filteredItems.length === 0) {
        const noResults = document.createElement('div');
        noResults.textContent = 'No items found';
        noResults.style.cssText = 'padding: 20px; text-align: center; color: #666;';
        itemsList.appendChild(noResults);
        return;
      }

      // Group by vendor
      const byVendor = {};
      filteredItems.forEach(invItem => {
        if (!byVendor[invItem.vendor]) byVendor[invItem.vendor] = [];
        byVendor[invItem.vendor].push(invItem);
      });

      // Render each vendor group
      Object.keys(byVendor).sort().forEach(vendor => {
        const vendorHeader = document.createElement('div');
        vendorHeader.textContent = vendor;
        vendorHeader.style.cssText = 'background: var(--gray-300); padding: 8px 12px; font-weight: 700; font-size: 11px; color: var(--gray-900); position: sticky; top: 0; text-transform: uppercase; letter-spacing: 1px;';
        itemsList.appendChild(vendorHeader);

        byVendor[vendor].forEach(invItem => {
          const itemRow = document.createElement('div');
          itemRow.style.cssText = 'padding: 10px 12px; border-bottom: 1px solid var(--gray-300); cursor: pointer; display: flex; justify-content: space-between; align-items: center; background: var(--white);';
          itemRow.onmouseover = function() { this.style.background = 'var(--gray-100)'; };
          itemRow.onmouseout = function() { this.style.background = 'var(--white)'; };
          itemRow.onclick = function() {
            // Update the matched item
            orderingSystemState.extractedInvoiceItems[itemIndex].matchedInventoryId = invItem.id;
            orderingSystemState.extractedInvoiceItems[itemIndex].matchedItemName = invItem.itemName;
            orderingSystemState.extractedInvoiceItems[itemIndex].matchConfidence = 1.0; // Manual match = 100%

            // Close modal and re-render
            document.body.removeChild(overlay);
            renderExtractedItems();
            showMessage('Item matched successfully!', 'success');
          };

          const itemName = document.createElement('div');
          itemName.textContent = invItem.itemName;
          itemName.style.cssText = 'font-size: 13px; color: var(--gray-900); font-weight: 600;';
          itemRow.appendChild(itemName);

          const itemUnit = document.createElement('div');
          itemUnit.textContent = invItem.unit;
          itemUnit.style.cssText = 'font-size: 10px; color: var(--gray-700); padding: 2px 6px; background: var(--gray-100); border-radius: 0; font-weight: 700; letter-spacing: 0.5px;';
          itemRow.appendChild(itemUnit);

          itemsList.appendChild(itemRow);
        });
      });
    }

    // Initial render
    renderInventoryItems();

    // Search handler
    searchInput.addEventListener('input', function() {
      renderInventoryItems(this.value);
    });

    // Button row
    const buttonRow = document.createElement('div');
    buttonRow.style.cssText = 'display: flex; gap: 8px;';

    const cancelBtn = document.createElement('button');
    cancelBtn.textContent = 'CANCEL';
    cancelBtn.style.cssText = 'flex: 1; padding: 12px; background: var(--gray-100); color: var(--gray-900); border: 2px solid var(--gray-300); border-radius: 0; font-size: 11px; font-weight: 700; letter-spacing: 1px; cursor: pointer;';
    cancelBtn.onclick = function() {
      document.body.removeChild(overlay);
    };
    buttonRow.appendChild(cancelBtn);

    const createNewBtn = document.createElement('button');
    createNewBtn.textContent = 'CREATE NEW';
    createNewBtn.style.cssText = 'flex: 1; padding: 12px; background: var(--gray-700); color: var(--white); border: 2px solid var(--gray-700); border-radius: 0; font-size: 11px; font-weight: 700; letter-spacing: 1px; cursor: pointer;';
    createNewBtn.onclick = async function() {
      // Prompt for new item details
      const newItemName = prompt('Enter item name:', item.detectedName || '');
      if (!newItemName || newItemName.trim() === '') {
        showMessage('Item name is required', 'error');
        return;
      }

      const vendorOptions = ['Greenleaf', 'Performance', 'Mani Imports', 'Eatopia', 'Restaurant Depot', 'Alsco', 'SRC Pumping', 'Southern Glazer\'s', 'Breakthru Beverage', 'PREP'];
      const vendorChoice = prompt('Enter vendor name (or choose from: ' + vendorOptions.join(', ') + '):', '');
      if (!vendorChoice || vendorChoice.trim() === '') {
        showMessage('Vendor is required', 'error');
        return;
      }

      const unit = prompt('Enter unit (e.g., CS, EA, LB):', '');
      if (!unit || unit.trim() === '') {
        showMessage('Unit is required', 'error');
        return;
      }

      const parLevel = prompt('Enter par level (default 0):', '0');
      const category = confirm('Is this a PREP item? (OK = Yes, Cancel = No)') ? 'PREP' : 'INVENTORY';

      // Create the item
      document.body.removeChild(overlay);
      showLoading('Creating New Item', 'Saving to database...');

      try {
        const insertData = {
          item_name: newItemName.trim(),
          vendor: vendorChoice.trim(),
          unit: unit.trim().toUpperCase(),
          par_level: parseFloat(parLevel) || 0,
          current_stock: 0,
          category: category,
          created_date: new Date().toISOString()
        };

        // Add prep-specific fields if category is PREP
        if (category === 'PREP') {
          const batchLifespan = prompt('Enter batch lifespan in hours (default 48):', '48');
          insertData.batch_lifespan = parseInt(batchLifespan) || 48;
        }

        const { data, error } = await supabase
          .from('inventory_items')
          .insert([insertData])
          .select();

        if (error) throw error;

        // Add to local state
        orderingSystemState.items.push({
          id: data[0].id,
          itemName: data[0].item_name,
          vendor: data[0].vendor,
          parLevel: data[0].par_level,
          currentStock: data[0].current_stock,
          unit: data[0].unit,
          category: data[0].category,
          batchLifespan: data[0].batch_lifespan,
          lastCountedDate: null
        });

        // Auto-match the newly created item
        orderingSystemState.extractedInvoiceItems[itemIndex].matchedInventoryId = data[0].id;
        orderingSystemState.extractedInvoiceItems[itemIndex].matchedItemName = data[0].item_name;
        orderingSystemState.extractedInvoiceItems[itemIndex].matchConfidence = 1.0;

        hideLoading();
        renderExtractedItems();
        showMessage('New item created and matched!', 'success');
      } catch (error) {
        hideLoading();
        showMessage('Error creating item: ' + error.message, 'error');
      }
    };
    buttonRow.appendChild(createNewBtn);

    const skipBtn = document.createElement('button');
    skipBtn.textContent = 'SKIP';
    skipBtn.style.cssText = 'flex: 1; padding: 12px; background: var(--gray-100); color: var(--gray-900); border: 2px solid var(--gray-300); border-radius: 0; font-size: 11px; font-weight: 700; letter-spacing: 1px; cursor: pointer;';
    skipBtn.onclick = function() {
      // Mark as skipped
      orderingSystemState.extractedInvoiceItems[itemIndex].matchedInventoryId = null;
      orderingSystemState.extractedInvoiceItems[itemIndex].matchConfidence = 0;
      document.body.removeChild(overlay);
      renderExtractedItems();
      showMessage('Item skipped', 'info');
    };
    buttonRow.appendChild(skipBtn);

    modal.appendChild(buttonRow);

    // Assemble modal
    overlay.appendChild(modal);
    document.body.appendChild(overlay);

    // Focus search input
    searchInput.focus();
  }

  /**
   * Check in invoice items and update inventory
   * Handles both invoice reconciliation and order receiving flows
   */
  async function checkInInvoiceItems() {
    const items = orderingSystemState.extractedInvoiceItems;

    if (items.length === 0) {
      showMessage('No items to check in', 'warning');
      return;
    }

    // Validate that all items have matches
    const unmatchedItems = items.filter(item => !item.matchedInventoryId);
    if (unmatchedItems.length > 0) {
      const confirmContinue = confirm(
        unmatchedItems.length + ' item(s) are not matched. These will be skipped during check-in. Continue?'
      );
      if (!confirmContinue) return;
    }

    // Get matched items only
    const matchedItems = items.filter(item => item.matchedInventoryId);
    if (matchedItems.length === 0) {
      showMessage('No matched items to check in', 'warning');
      return;
    }

    showLoading('Checking In Items', 'Updating inventory...');

    try {
      // Create invoice record
      const { data: invoiceData, error: invoiceError } = await supabase
        .from('invoices')
        .insert({
          invoice_date: new Date().toISOString().split('T')[0],
          vendor: 'MIXED', // Could be enhanced to detect vendor from items
          invoice_type: orderingSystemState.invoiceType || 'invoice',
          total_items: matchedItems.length,
          processed_by: 'System',
          notes: 'Auto-processed via OCR'
        })
        .select()
        .single();

      if (invoiceError) throw invoiceError;

      const invoiceId = invoiceData.id;

      // Process each matched item
      let successCount = 0;
      let errorCount = 0;

      for (const item of matchedItems) {
        try {
          // Save to invoice_items table
          const { error: itemError } = await supabase
            .from('invoice_items')
            .insert({
              invoice_id: invoiceId,
              inventory_item_id: item.matchedInventoryId,
              detected_item_name: item.detectedName,
              detected_quantity: item.detectedQuantity,
              detected_price: item.detectedPrice || 0,
              match_confidence: item.matchConfidence,
              matched_at: new Date().toISOString(),
              checked_in: true,
              checked_in_at: new Date().toISOString()
            });

          if (itemError) throw itemError;

          // Update inventory stock
          // Get current stock first
          const { data: currentItem, error: fetchError } = await supabase
            .from('inventory_items')
            .select('current_stock')
            .eq('id', item.matchedInventoryId)
            .single();

          if (fetchError) throw fetchError;

          const newStock = (parseFloat(currentItem.current_stock) || 0) + (parseFloat(item.detectedQuantity) || 0);

          // Update the stock
          const { error: updateError } = await supabase
            .from('inventory_items')
            .update({
              current_stock: newStock,
              last_counted_date: new Date().toISOString()
            })
            .eq('id', item.matchedInventoryId);

          if (updateError) throw updateError;

          successCount++;

        } catch (itemError) {
          console.error('Error processing item:', item.detectedName, itemError);
          errorCount++;
        }
      }

      hideLoading();

      // Clear the extracted items
      orderingSystemState.extractedInvoiceItems = [];
      orderingSystemState.currentInvoiceImage = null;

      // Reset UI
      document.getElementById('extractedItemsSection').style.display = 'none';
      document.getElementById('invoicePreviewImage').src = '';
      document.getElementById('invoiceFileInput').value = '';
      document.getElementById('invoiceCameraInput').value = '';
      renderExtractedItems();

      // Reload inventory to show updated counts
      await loadOrderingData();

      // Show success message
      if (errorCount === 0) {
        showMessage('Successfully checked in ' + successCount + ' items!', 'success');
      } else {
        showMessage(
          'Checked in ' + successCount + ' items with ' + errorCount + ' errors. Check console for details.',
          'warning'
        );
      }

    } catch (error) {
      hideLoading();
      console.error('Check-in error:', error);
      showMessage('Failed to check in items: ' + error.message, 'error');
    }
  }

  /**
   * Print a specific order
   */
  function printOrder(orderIndex) {
    const order = orderingSystemState.calculatedOrders[orderIndex];
    if (!order) return;

    const orderCard = document.getElementById(`order-${orderIndex}`);
    if (!orderCard) return;

    const printWindow = window.open('', '', 'height=800,width=800');
    printWindow.document.write('<html><head><title>Order - ' + order.vendor + '</title>');
    printWindow.document.write('<style>body{font-family: Arial, sans-serif; padding: 20px;} table{width:100%; border-collapse: collapse;} th, td{border: 1px solid #ddd; padding: 8px; text-align: left;} th{background: #1e3c72; color: white;}</style>');
    printWindow.document.write('</head><body>');
    printWindow.document.write(orderCard.innerHTML);
    printWindow.document.write('</body></html>');
    printWindow.document.close();
    printWindow.print();
  }

  /**
   * Generate PDF for a specific order
   */
  async function generateOrderPDF(orderIndex) {
    const order = orderingSystemState.calculatedOrders[orderIndex];
    if (!order) return;

    showLoading('Generating PDF', 'Creating order document...');

    try {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      // Header
      doc.setFontSize(20);
      doc.setFont('helvetica', 'bold');
      doc.text('JAYNA GYRO', 105, 20, { align: 'center' });

      doc.setFontSize(16);
      doc.text(`${order.vendor} Order`, 105, 30, { align: 'center' });

      // Order details
      doc.setFontSize(10);
      doc.setFont('helvetica', 'normal');
      doc.text(`Order Date: ${order.orderDate.toLocaleDateString()}`, 20, 45);
      doc.text(`Cutoff Time: ${order.cutoffTime}`, 20, 52);
      doc.text(`Delivery Date: ${order.deliveryDate.toLocaleDateString()}`, 20, 59);

      if (order.notes) {
        doc.setFont('helvetica', 'bold');
        doc.text(`Notes: ${order.notes}`, 20, 66);
      }

      // Table with AI reasoning
      const isFriday = order.orderDate.toLocaleDateString('en-US', { weekday: 'long' }) === 'Friday';
      const isThursday = order.orderDate.toLocaleDateString('en-US', { weekday: 'long' }) === 'Thursday';

      const tableData = order.items.map(item => {
        // Calculate reasoning text (matches email format)
        let reasoningText = '';
        if (order.vendor === 'Greenleaf' && isFriday) {
          reasoningText = `AI: (Par ${item.parLevel} - Stock ${item.currentStock}) × 2 days = ${item.quantity} to order`;
        } else if (order.vendor === 'Mani Imports' && isThursday) {
          const calc = Math.ceil((item.parLevel - item.currentStock) * (5 / 7));
          reasoningText = `AI: (Par ${item.parLevel} - Stock ${item.currentStock}) × 5/7 days = ${calc} to order`;
        } else if (order.vendor === 'Mani Imports') {
          const calc = Math.ceil((item.parLevel - item.currentStock) * (3 / 7));
          reasoningText = `AI: (Par ${item.parLevel} - Stock ${item.currentStock}) × 3/7 days = ${calc} to order`;
        } else {
          reasoningText = `AI: Par ${item.parLevel} - Stock ${item.currentStock} = ${item.quantity} to order`;
        }

        // Format last count and last price (matches email format)
        const lastCountStr = item.lastCountedDate ? `Last count: ${formatRelativeTime(item.lastCountedDate)}` : '';
        const lastPriceStr = item.currentUnitCost ? `Last price: ${formatPriceWithDate(item.currentUnitCost, item.lastCostUpdate)}` : '';

        // Combine all metadata
        let itemNameWithMetadata = item.itemName;
        if (lastCountStr) itemNameWithMetadata += '\n' + lastCountStr;
        if (lastPriceStr) itemNameWithMetadata += '\n' + lastPriceStr;
        itemNameWithMetadata += '\n' + reasoningText;

        return [
          itemNameWithMetadata,
          item.quantity.toString(),
          item.unit,
          item.parLevel.toString(),
          item.currentStock.toString()
        ];
      });

      doc.autoTable({
        head: [['Item', 'Qty to Order', 'Unit', 'Par Level', 'Current Stock']],
        body: tableData,
        startY: order.notes ? 75 : 68,
        theme: 'grid',
        headStyles: { fillColor: [30, 60, 114] },
        styles: { fontSize: 9, cellPadding: 3 },
        columnStyles: {
          0: { cellWidth: 80 } // Wider first column for multi-line content
        },
        willDrawCell: function(data) {
          // Prevent default text rendering for Item column - clear BEFORE drawing
          if (data.column.index === 0 && data.cell.section === 'body' && data.cell.text.length > 1) {
            data.cell.text = []; // This prevents the default rendering
          }
        },
        didDrawCell: function(data) {
          // Custom rendering for Item column with metadata
          if (data.column.index === 0 && data.cell.section === 'body') {
            const cellData = tableData[data.row.index][0];
            const lines = cellData.split('\n');

            if (lines.length > 1) {
              let yPos = data.cell.y + 5;
              const lineHeight = 4;

              // Draw each line with appropriate styling
              lines.forEach((line, index) => {
                if (index === 0) {
                  // Item name - normal size, black
                  doc.setFontSize(9);
                  doc.setFont('helvetica', 'normal');
                  doc.setTextColor(0, 0, 0);
                  doc.text(line, data.cell.x + 2, yPos);
                } else if (line.startsWith('Last count:') || line.startsWith('Last price:')) {
                  // Metadata - smaller, gray
                  doc.setFontSize(8);
                  doc.setFont('helvetica', 'normal');
                  doc.setTextColor(120, 120, 120);
                  doc.text(line, data.cell.x + 2, yPos);
                } else if (line.startsWith('AI:')) {
                  // Reasoning - smallest, light gray, italic
                  doc.setFontSize(7);
                  doc.setFont('helvetica', 'italic');
                  doc.setTextColor(170, 170, 170);
                  doc.text(line, data.cell.x + 2, yPos);
                  doc.setFont('helvetica', 'normal');
                }
                yPos += lineHeight;
              });

              // Reset to defaults
              doc.setFont('helvetica', 'normal');
              doc.setTextColor(0, 0, 0);
            }
          }
        }
      });

      // Footer
      const pageCount = doc.internal.getNumberOfPages();
      for (let i = 1; i <= pageCount; i++) {
        doc.setPage(i);
        doc.setFontSize(8);
        doc.text(`Generated: ${new Date().toLocaleString()}`, 20, 285);
        doc.text(`Page ${i} of ${pageCount}`, 190, 285, { align: 'right' });
      }

      doc.save(`${order.vendor}_Order_${order.orderDate.toISOString().split('T')[0]}.pdf`);

      hideLoading();
      showMessage('✅ PDF generated successfully!', 'success');
    } catch (error) {
      hideLoading();
      showMessage(`Error generating PDF: ${error.message}`, 'error');
    }
  }

  /**
   * Generate combined PDF with all orders
   */
  async function generateAllPDFs() {
    if (orderingSystemState.calculatedOrders.length === 0) {
      showMessage('No orders to generate!', 'info');
      return;
    }

    showLoading('Generating Combined PDF', 'Creating document with all orders...');

    try {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      // Cover page
      doc.setFontSize(24);
      doc.setFont('helvetica', 'bold');
      doc.text('JAYNA GYRO', 105, 40, { align: 'center' });

      doc.setFontSize(18);
      doc.text('Weekly Order Summary', 105, 55, { align: 'center' });

      doc.setFontSize(12);
      doc.setFont('helvetica', 'normal');
      doc.text(`Generated: ${new Date().toLocaleString()}`, 105, 70, { align: 'center' });
      doc.text(`Total Orders: ${orderingSystemState.calculatedOrders.length}`, 105, 80, { align: 'center' });

      // Add each order
      orderingSystemState.calculatedOrders.forEach((order, index) => {
        doc.addPage();

        // Header
        doc.setFontSize(18);
        doc.setFont('helvetica', 'bold');
        doc.text(`${order.vendor} - Order #${index + 1}`, 105, 20, { align: 'center' });

        // Order details
        doc.setFontSize(10);
        doc.setFont('helvetica', 'normal');
        doc.text(`Order Date: ${order.orderDate.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}`, 20, 35);
        doc.text(`Cutoff Time: ${order.cutoffTime}`, 20, 42);
        doc.text(`Delivery Date: ${order.deliveryDate.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}`, 20, 49);

        if (order.notes) {
          doc.setFont('helvetica', 'bold');
          doc.text(`Notes: ${order.notes}`, 20, 56);
        }

        // Table with AI reasoning
        const isFriday = order.orderDate.toLocaleDateString('en-US', { weekday: 'long' }) === 'Friday';
        const isThursday = order.orderDate.toLocaleDateString('en-US', { weekday: 'long' }) === 'Thursday';

        const tableData = order.items.map(item => {
          // Calculate reasoning text (matches email format)
          let reasoningText = '';
          if (order.vendor === 'Greenleaf' && isFriday) {
            reasoningText = `AI: (Par ${item.parLevel} - Stock ${item.currentStock}) × 2 days = ${item.quantity} to order`;
          } else if (order.vendor === 'Mani Imports' && isThursday) {
            const calc = Math.ceil((item.parLevel - item.currentStock) * (5 / 7));
            reasoningText = `AI: (Par ${item.parLevel} - Stock ${item.currentStock}) × 5/7 days = ${calc} to order`;
          } else if (order.vendor === 'Mani Imports') {
            const calc = Math.ceil((item.parLevel - item.currentStock) * (3 / 7));
            reasoningText = `AI: (Par ${item.parLevel} - Stock ${item.currentStock}) × 3/7 days = ${calc} to order`;
          } else {
            reasoningText = `AI: Par ${item.parLevel} - Stock ${item.currentStock} = ${item.quantity} to order`;
          }

          // Format last count and last price (matches email format)
          const lastCountStr = item.lastCountedDate ? `Last count: ${formatRelativeTime(item.lastCountedDate)}` : '';
          const lastPriceStr = item.currentUnitCost ? `Last price: ${formatPriceWithDate(item.currentUnitCost, item.lastCostUpdate)}` : '';

          // Combine all metadata
          let itemNameWithMetadata = item.itemName;
          if (lastCountStr) itemNameWithMetadata += '\n' + lastCountStr;
          if (lastPriceStr) itemNameWithMetadata += '\n' + lastPriceStr;
          itemNameWithMetadata += '\n' + reasoningText;

          return [
            itemNameWithMetadata,
            item.quantity.toString(),
            item.unit,
            item.parLevel.toString(),
            item.currentStock.toString()
          ];
        });

        doc.autoTable({
          head: [['Item', 'Qty', 'Unit', 'Par', 'Stock']],
          body: tableData,
          startY: order.notes ? 65 : 58,
          theme: 'grid',
          headStyles: { fillColor: [30, 60, 114] },
          styles: { fontSize: 9, cellPadding: 3 },
          columnStyles: {
            0: { cellWidth: 80 } // Wider first column for multi-line content
          },
          willDrawCell: function(data) {
            // Prevent default text rendering for Item column - clear BEFORE drawing
            if (data.column.index === 0 && data.cell.section === 'body' && data.cell.text.length > 1) {
              data.cell.text = []; // This prevents the default rendering
            }
          },
          didDrawCell: function(data) {
            // Custom rendering for Item column with metadata
            if (data.column.index === 0 && data.cell.section === 'body') {
              const cellData = tableData[data.row.index][0];
              const lines = cellData.split('\n');

              if (lines.length > 1) {
                let yPos = data.cell.y + 5;
                const lineHeight = 4;

                // Draw each line with appropriate styling
                lines.forEach((line, index) => {
                  if (index === 0) {
                    // Item name - normal size, black
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(0, 0, 0);
                    doc.text(line, data.cell.x + 2, yPos);
                  } else if (line.startsWith('Last count:') || line.startsWith('Last price:')) {
                    // Metadata - smaller, gray
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(120, 120, 120);
                    doc.text(line, data.cell.x + 2, yPos);
                  } else if (line.startsWith('AI:')) {
                    // Reasoning - smallest, light gray, italic
                    doc.setFontSize(7);
                    doc.setFont('helvetica', 'italic');
                    doc.setTextColor(170, 170, 170);
                    doc.text(line, data.cell.x + 2, yPos);
                    doc.setFont('helvetica', 'normal');
                  }
                  yPos += lineHeight;
                });

                // Reset to defaults
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(0, 0, 0);
              }
            }
          }
        });
      });

      // Footer on all pages
      const pageCount = doc.internal.getNumberOfPages();
      for (let i = 1; i <= pageCount; i++) {
        doc.setPage(i);
        doc.setFontSize(8);
        doc.setFont('helvetica', 'normal');
        doc.text(`Jayna Gyro Ordering System`, 20, 285);
        doc.text(`Page ${i} of ${pageCount}`, 190, 285, { align: 'right' });
      }

      const filename = `Jayna_All_Orders_${new Date().toISOString().split('T')[0]}.pdf`;
      doc.save(filename);

      hideLoading();
      showMessage('✅ Combined PDF generated successfully!', 'success');
    } catch (error) {
      hideLoading();
      showMessage(`Error generating PDF: ${error.message}`, 'error');
    }
  }

  // ====================================
  // ORDERING SYSTEM - END
  // ====================================
</script>
</body>
</html>