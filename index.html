<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Jayna Gyro Cash Counter</title>
  
  <link rel="apple-touch-icon" href="https://static.spotapps.co/website_images/ab_websites/229800_website_v1/logo.png">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#667eea">
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
    .container { max-width: 600px; margin: 0 auto; background: white; border-radius: 20px; overflow: hidden; box-shadow: 0 20px 40px rgba(0,0,0,0.1); }
    .header { background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: white; text-align: center; padding: 30px 20px; }
    .header h1 { font-size: 28px; font-weight: 700; margin-bottom: 8px; }
    .header p { opacity: 0.9; font-size: 16px; }
    .content { padding: 30px; }
    .main-menu { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 30px; }
    .main-menu.show-report { grid-template-columns: 1fr 1fr 1fr; }
    .menu-btn { padding: 25px 20px; border: 3px solid #e0e0e0; border-radius: 15px; background: white; font-size: 18px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; text-align: center; }
    .menu-btn:hover { border-color: #667eea; transform: translateY(-2px); }
    .menu-btn.active { border-color: #667eea; background: #667eea; color: white; transform: translateY(-2px); }
    .menu-btn.report { background: #28a745; color: white; border-color: #28a745; }
    .form-section { display: none; }
    .form-section.active { display: block; }
    .form-group { margin-bottom: 20px; }
    .form-group label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px; }
    .form-input, .form-select { width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; }
    .form-input:focus, .form-select:focus { outline: none; border-color: #667eea; }
    .drawer-section { margin: 25px 0; border: 2px solid #f0f0f0; border-radius: 12px; overflow: hidden; }
    .drawer-header { background: #f8f9fa; padding: 15px 20px; font-weight: 600; display: flex; justify-content: space-between; align-items: center; }
    .skip-toggle { display: flex; align-items: center; gap: 8px; font-size: 14px; color: #666; }
    .drawer-content { padding: 20px; }
    .denom-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #f0f0f0; }
    .denom-row:last-child { border-bottom: none; }
    .denom-label { font-weight: 600; font-size: 16px; }
    .denom-value { font-size: 14px; color: #666; margin-top: 2px; }
    .qty-input { width: 80px; height: 40px; text-align: center; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 16px; font-weight: 600; }
    .qty-input:focus { outline: none; border-color: #667eea; }
    .drawer-total { margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px; text-align: center; font-size: 18px; font-weight: 600; }
    .grand-total { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; text-align: center; margin: 20px 0; }
    .grand-total h3 { font-size: 18px; margin-bottom: 5px; }
    .grand-total .amount { font-size: 32px; font-weight: 700; }
    .notes-area { width: 100%; min-height: 80px; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; resize: vertical; }
    .notes-area:focus { outline: none; border-color: #667eea; }
    .submit-btn { width: 100%; padding: 18px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 12px; font-size: 18px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; margin-top: 20px; }
    .submit-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3); }
    .submit-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
    .am-total-display { background: #e7f3ff; padding: 15px; border-radius: 8px; margin: 15px 0; }
    .am-total-display h4 { margin-bottom: 5px; color: #1976d2; }
    .am-total-display .amount { font-size: 24px; font-weight: bold; color: #1565c0; }
    .currency-input { width: 100%; padding: 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 18px; text-align: center; }
    .currency-input:focus { outline: none; border-color: #667eea; }
    .confirmation-screen { text-align: center; padding: 40px 20px; }
    .confirmation-screen h2 { color: #28a745; margin-bottom: 30px; font-size: 28px; }
    .deposit-instruction { background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; padding: 25px; border-radius: 15px; margin: 20px 0; font-size: 22px; font-weight: bold; }
    .return-instruction { background: linear-gradient(135deg, #fd7e14 0%, #e83e8c 100%); color: white; padding: 25px; border-radius: 15px; margin: 20px 0; font-size: 22px; font-weight: bold; }
    .thank-you { font-size: 20px; color: #28a745; margin: 30px 0; font-weight: 600; }
    .confirm-btn { background: #28a745; margin-top: 30px; }
    .loading { text-align: center; padding: 40px; }
    .loading-spinner { width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .message { padding: 15px; border-radius: 8px; margin: 15px 0; text-align: center; }
    .message.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .message.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    .message.info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
    .hidden { display: none; }
    .skip-content { padding: 20px; }
    .skip-reason { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; }
  </style>
  
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>JAYNA GYRO CASH COUNTER</h1>
      <p>App created by Demetri Gregorakis</p>
    </div>
    
    <div class="content">
      <div id="messageArea"></div>
      
      <!-- Main Menu -->
      <div id="mainMenu" class="main-menu">
        <button class="menu-btn" onclick="startAMCount()">AM Count</button>
        <button class="menu-btn" onclick="startPMCount()">PM Close</button>
        <button class="menu-btn report" onclick="showReports()">Generate Report</button>
      </div>
      
      <!-- AM Count Form -->
      <div id="amForm" class="form-section">
        <h2 style="margin-bottom: 20px; color: #1e3c72;">Morning Cash Count</h2>
        
        <div class="form-group">
          <label for="amDate">Date:</label>
          <input type="date" id="amDate" class="form-input" required>
        </div>
        
        <div class="form-group">
          <label for="amCounter">Counted by:</label>
          <select id="amCounter" class="form-select" required>
            <option value="">Choose Name</option>
            <option value="Demetri Gregorakis">Demetri Gregorakis</option>
            <option value="Ahmet Can Guler">Ahmet Can Guler</option>
            <option value="Bryan Cox">Bryan Cox</option>
          </select>
        </div>
        
        <!-- Drawer 1 -->
        <div class="drawer-section">
          <div class="drawer-header">
            <span>Drawer 1</span>
            <label class="skip-toggle">
              <input type="checkbox" id="amDrawer1Skip" onchange="toggleSkip('am', 1)">
              Skip Drawer
            </label>
          </div>
          <div id="amDrawer1Content" class="drawer-content">
            <div id="amDrawer1Denoms"></div>
            <div class="drawer-total" id="amDrawer1Total">$0.00</div>
          </div>
          <div id="amDrawer1SkipContent" class="skip-content hidden">
            <input type="text" class="skip-reason" id="amDrawer1Reason" placeholder="Reason for skipping drawer 1">
          </div>
        </div>
        
        <!-- Drawer 2 -->
        <div class="drawer-section">
          <div class="drawer-header">
            <span>Drawer 2</span>
            <label class="skip-toggle">
              <input type="checkbox" id="amDrawer2Skip" onchange="toggleSkip('am', 2)">
              Skip Drawer
            </label>
          </div>
          <div id="amDrawer2Content" class="drawer-content">
            <div id="amDrawer2Denoms"></div>
            <div class="drawer-total" id="amDrawer2Total">$0.00</div>
          </div>
          <div id="amDrawer2SkipContent" class="skip-content hidden">
            <input type="text" class="skip-reason" id="amDrawer2Reason" placeholder="Reason for skipping drawer 2">
          </div>
        </div>
        
        <div class="grand-total">
          <h3>Total Cash Count</h3>
          <div class="amount" id="amGrandTotal">$0.00</div>
        </div>
        
        <div class="form-group">
          <label for="amNotes">Notes (Optional):</label>
          <textarea id="amNotes" class="notes-area" placeholder="Any notes for the PM shift..."></textarea>
        </div>
        
        <button class="submit-btn" onclick="submitAM()">Submit AM Count</button>
        <button class="submit-btn" onclick="goHome()" style="background: #6c757d; margin-top: 10px;">Back to Menu</button>
      </div>
      
      <!-- PM Count Form -->
      <div id="pmForm" class="form-section">
        <h2 style="margin-bottom: 20px; color: #1e3c72;">Evening Cash Close</h2>
        
        <div class="form-group">
          <label for="pmDate">Date:</label>
          <input type="date" id="pmDate" class="form-input" required>
        </div>
        
        <div class="form-group">
          <label for="pmCounter">Counted by:</label>
          <select id="pmCounter" class="form-select" required>
            <option value="">Choose Name</option>
            <option value="Demetri Gregorakis">Demetri Gregorakis</option>
            <option value="Ahmet Can Guler">Ahmet Can Guler</option>
            <option value="Bryan Cox">Bryan Cox</option>
          </select>
        </div>
        
        <!-- AM Total Display -->
        <div id="amTotalDisplay" class="am-total-display">
          <h4>Morning Starting Amount:</h4>
          <div class="amount" id="pmAmTotal">Loading...</div>
          <div id="amNotes" style="margin-top: 10px; font-style: italic; color: #666;"></div>
        </div>
        
        <!-- Drawer 1 -->
        <div class="drawer-section">
          <div class="drawer-header">
            <span>Drawer 1</span>
            <label class="skip-toggle">
              <input type="checkbox" id="pmDrawer1Skip" onchange="toggleSkip('pm', 1)">
              Skip Drawer
            </label>
          </div>
          <div id="pmDrawer1Content" class="drawer-content">
            <div id="pmDrawer1Denoms"></div>
            <div class="drawer-total" id="pmDrawer1Total">$0.00</div>
          </div>
          <div id="pmDrawer1SkipContent" class="skip-content hidden">
            <input type="text" class="skip-reason" id="pmDrawer1Reason" placeholder="Reason for skipping drawer 1">
          </div>
        </div>
        
        <!-- Drawer 2 -->
        <div class="drawer-section">
          <div class="drawer-header">
            <span>Drawer 2</span>
            <label class="skip-toggle">
              <input type="checkbox" id="pmDrawer2Skip" onchange="toggleSkip('pm', 2)">
              Skip Drawer
            </label>
          </div>
          <div id="pmDrawer2Content" class="drawer-content">
            <div id="pmDrawer2Denoms"></div>
            <div class="drawer-total" id="pmDrawer2Total">$0.00</div>
          </div>
          <div id="pmDrawer2SkipContent" class="skip-content hidden">
            <input type="text" class="skip-reason" id="pmDrawer2Reason" placeholder="Reason for skipping drawer 2">
          </div>
        </div>
        
        <div class="grand-total">
          <h3>Total Cash Count</h3>
          <div class="amount" id="pmGrandTotal">$0.00</div>
        </div>
        
        <div class="form-group">
          <label for="toastSales">Toast Cash Sales (exact amount):</label>
          <input type="number" id="toastSales" class="currency-input" placeholder="0.00" step="0.01" min="0" onfocus="this.select()">
        </div>
        
        <div class="form-group">
          <label for="cashTips">Cash Tips (whole number):</label>
          <input type="number" id="cashTips" class="currency-input" placeholder="0" step="1" min="0" onfocus="this.select()">
        </div>
        
        <div class="form-group">
          <label for="pmNotes">Notes (Optional):</label>
          <textarea id="pmNotes" class="notes-area" placeholder="Any notes about the day..."></textarea>
        </div>
        
        <button class="submit-btn" onclick="submitPM()">Submit PM Close</button>
        <button class="submit-btn" onclick="goHome()" style="background: #6c757d; margin-top: 10px;">Back to Menu</button>
      </div>
      
      <!-- Loading Screen -->
      <div id="loadingScreen" class="form-section">
        <div class="loading">
          <div class="loading-spinner"></div>
          <h3>Processing your count...</h3>
          <p>Calculating totals and sending report...</p>
        </div>
      </div>
      
      <!-- Confirmation Screen -->
      <div id="confirmationScreen" class="form-section">
        <div class="confirmation-screen">
          <h2>Count Submitted Successfully!</h2>
          
          <div class="deposit-instruction">
            DEPOSIT <span id="depositAmount">$0</span> INTO ENVELOPE
          </div>
          
          <div class="return-instruction">
            RETURN <span id="returnAmount">$0.00</span> TO CASH BOX AND LOCK IN SAFE FOR THE NIGHT
          </div>
          
          <div class="thank-you">THANK YOU!</div>
          
          <button class="submit-btn confirm-btn" onclick="goHome()">Confirm and Close</button>
        </div>
      </div>
      
      <!-- Reports Section -->
      <div id="reportsForm" class="form-section">
        <h2 style="margin-bottom: 20px; color: #1e3c72;">Generate Report</h2>
        
        <div class="form-group">
          <label for="reportDate">Select Date:</label>
          <input type="date" id="reportDate" class="form-input" required>
        </div>
        
        <button class="submit-btn" onclick="generateReport()" style="background: #28a745;">Generate Email Report</button>
        <button class="submit-btn" onclick="goHome()" style="background: #6c757d; margin-top: 10px;">Back to Menu</button>
      </div>
    </div>
  </div>

<script>
  // Configuration
  const SUPABASE_URL = 'YOUR_SUPABASE_URL_HERE';
  const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY_HERE';
  
  const EMAILJS_CONFIG = {
    PUBLIC_KEY: 'LHbq8j4mlt49O75eo',
    SERVICE_ID: 'service_xm62z73',
    TEMPLATE_ID: 'template_cash_report',
    MANAGER_EMAIL: 'smanager@jaynagyro.com, GSS4168CTJJA73@PRINT.EPSONCONNECT.COM'
  };
  
  const DENOMINATIONS = [
    { label: '$100', value: 100.00 },
    { label: '$50', value: 50.00 },
    { label: '$20', value: 20.00 },
    { label: '$10', value: 10.00 },
    { label: '$5', value: 5.00 },
    { label: '$1', value: 1.00 },
    { label: '$0.25', value: 0.25 },
    { label: '$0.10', value: 0.10 },
    { label: '$0.05', value: 0.05 },
    { label: '$0.01', value: 0.01 }
  ];
  
  let supabase = null;
  let currentAMData = null;
  
  // Initialize app
  document.addEventListener('DOMContentLoaded', function() {
    initializeSupabase();
    initializeEmailJS();
    setTodayDate();
    showMessage('App ready! Select AM Count, PM Close, or Generate Report.', 'info');
  });
  
  function initializeSupabase() {
    if (SUPABASE_URL === 'YOUR_SUPABASE_URL_HERE' || SUPABASE_ANON_KEY === 'YOUR_SUPABASE_ANON_KEY_HERE') {
      showMessage('Please configure Supabase credentials', 'error');
      return;
    }
    try {
      supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      console.log('Supabase initialized');
    } catch (error) {
      console.error('Supabase init failed:', error);
      showMessage('Database connection failed', 'error');
    }
  }
  
  function initializeEmailJS() {
    if (typeof emailjs !== 'undefined') {
      emailjs.init(EMAILJS_CONFIG.PUBLIC_KEY);
    }
  }
  
  function setTodayDate() {
    const today = getPacificDate();
    document.getElementById('amDate').value = today;
    document.getElementById('pmDate').value = today;
    document.getElementById('reportDate').value = today;
  }
  
  function getPacificDate() {
    const now = new Date();
    const pacific = new Date(now.toLocaleString("en-US", {timeZone: "America/Los_Angeles"}));
    const year = pacific.getFullYear();
    const month = String(pacific.getMonth() + 1).padStart(2, '0');
    const day = String(pacific.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
  }
  
  function showMessage(text, type) {
    const messageArea = document.getElementById('messageArea');
    messageArea.innerHTML = `<div class="message ${type}">${text}</div>`;
    setTimeout(() => { messageArea.innerHTML = ''; }, 5000);
  }
  
  function hideAllSections() {
    document.querySelectorAll('.form-section').forEach(section => section.classList.remove('active'));
  }
  
  function goHome() {
    hideAllSections();
    document.getElementById('mainMenu').style.display = 'grid';
  }
  
  function startAMCount() {
    document.getElementById('mainMenu').style.display = 'none';
    hideAllSections();
    document.getElementById('amForm').classList.add('active');
    setupDenominations('am');
  }
  
  async function startPMCount() {
    document.getElementById('mainMenu').style.display = 'none';
    hideAllSections();
    document.getElementById('pmForm').classList.add('active');
    setupDenominations('pm');
    await loadAMData();
  }
  
  function showReports() {
    document.getElementById('mainMenu').style.display = 'none';
    hideAllSections();
    document.getElementById('reportsForm').classList.add('active');
  }
  
  function setupDenominations(shift) {
    [1, 2].forEach(drawer => {
      const container = document.getElementById(`${shift}Drawer${drawer}Denoms`);
      container.innerHTML = '';
      
      DENOMINATIONS.forEach((denom, index) => {
        const row = document.createElement('div');
        row.className = 'denom-row';
        row.innerHTML = `
          <div>
            <div class="denom-label">${denom.label}</div>
            <div class="denom-value" id="${shift}D${drawer}V${index}">0 × $${denom.value.toFixed(2)} = $0.00</div>
          </div>
          <input type="number" class="qty-input" id="${shift}D${drawer}Q${index}" 
                 min="0" step="1" value="0" 
                 oninput="updateCalculations('${shift}', ${drawer})" 
                 onfocus="this.select()">
        `;
        container.appendChild(row);
      });
    });
  }
  
  function toggleSkip(shift, drawer) {
    const skipBox = document.getElementById(`${shift}Drawer${drawer}Skip`);
    const content = document.getElementById(`${shift}Drawer${drawer}Content`);
    const skipContent = document.getElementById(`${shift}Drawer${drawer}SkipContent`);
    
    if (skipBox.checked) {
      content.classList.add('hidden');
      skipContent.classList.remove('hidden');
    } else {
      content.classList.remove('hidden');
      skipContent.classList.add('hidden');
    }
    updateCalculations(shift, drawer);
  }
  
  function updateCalculations(shift, drawer) {
    const skipBox = document.getElementById(`${shift}Drawer${drawer}Skip`);
    let drawerTotal = 0;
    
    if (!skipBox.checked) {
      DENOMINATIONS.forEach((denom, index) => {
        const qtyInput = document.getElementById(`${shift}D${drawer}Q${index}`);
        const qty = parseInt(qtyInput.value) || 0;
        const value = qty * denom.value;
        
        document.getElementById(`${shift}D${drawer}V${index}`).textContent = 
          `${qty} × $${denom.value.toFixed(2)} = $${value.toFixed(2)}`;
        
        drawerTotal += value;
      });
    }
    
    document.getElementById(`${shift}Drawer${drawer}Total`).textContent = `$${drawerTotal.toFixed(2)}`;
    updateGrandTotal(shift);
  }
  
  function updateGrandTotal(shift) {
    const drawer1Skip = document.getElementById(`${shift}Drawer1Skip`).checked;
    const drawer2Skip = document.getElementById(`${shift}Drawer2Skip`).checked;
    
    const drawer1Total = drawer1Skip ? 0 : parseFloat(document.getElementById(`${shift}Drawer1Total`).textContent.replace('$', ''));
    const drawer2Total = drawer2Skip ? 0 : parseFloat(document.getElementById(`${shift}Drawer2Total`).textContent.replace('$', ''));
    
    const grandTotal = drawer1Total + drawer2Total;
    document.getElementById(`${shift}GrandTotal`).textContent = `$${grandTotal.toFixed(2)}`;
  }
  
  async function loadAMData() {
    const date = document.getElementById('pmDate').value;
    if (!date) return;
    
    try {
      const amData = await getAMData(date);
      if (amData) {
        currentAMData = amData;
        document.getElementById('pmAmTotal').textContent = `$${amData.total.toFixed(2)}`;
        
        if (amData.notes) {
          document.getElementById('amNotes').textContent = `Morning Notes: ${amData.notes}`;
        }
        
        showMessage('AM data loaded automatically!', 'success');
      } else {
        document.getElementById('pmAmTotal').textContent = 'No AM data found';
        showMessage('No AM count found for this date', 'error');
      }
    } catch (error) {
      console.error('Error loading AM data:', error);
      document.getElementById('pmAmTotal').textContent = 'Error loading AM data';
    }
  }
  
  function collectFormData(shift) {
    const counter = document.getElementById(`${shift}Counter`).value;
    const date = document.getElementById(`${shift}Date`).value;
    const notes = document.getElementById(`${shift}Notes`).value.trim();
    
    if (!counter) throw new Error('Please select a name');
    if (!date) throw new Error('Please select a date');
    
    const drawer1Skip = document.getElementById(`${shift}Drawer1Skip`).checked;
    const drawer2Skip = document.getElementById(`${shift}Drawer2Skip`).checked;
    
    const drawer1Data = collectDrawerData(shift, 1, drawer1Skip);
    const drawer2Data = collectDrawerData(shift, 2, drawer2Skip);
    
    const data = {
      shift: shift,
      counter: counter,
      date: date,
      timestamp: new Date().toISOString(),
      drawer1: drawer1Data,
      drawer2: drawer2Data,
      notes: notes || null,
      total: drawer1Data.total + drawer2Data.total
    };
    
    if (shift === 'pm') {
      const toastSales = parseFloat(document.getElementById('toastSales').value) || 0;
      const cashTips = parseInt(document.getElementById('cashTips').value) || 0;
      
      data.toastSales = toastSales;
      data.cashTips = cashTips;
      data.amTotal = currentAMData ? currentAMData.total : 0;
    }
    
    return data;
  }
  
  function collectDrawerData(shift, drawer, skipped) {
    if (skipped) {
      const reason = document.getElementById(`${shift}Drawer${drawer}Reason`).value.trim();
      return {
        skipped: true,
        skipReason: reason || 'No reason provided',
        counts: {},
        total: 0
      };
    }
    
    const counts = {};
    let total = 0;
    
    DENOMINATIONS.forEach((denom, index) => {
      const qty = parseInt(document.getElementById(`${shift}D${drawer}Q${index}`).value) || 0;
      counts[denom.label] = qty;
      total += qty * denom.value;
    });
    
    return {
      skipped: false,
      skipReason: null,
      counts: counts,
      total: Math.round(total * 100) / 100
    };
  }
  
  async function submitAM() {
    try {
      const data = collectFormData('am');
      await storeAMData(data);
      showMessage('AM count submitted successfully!', 'success');
      
      setTimeout(() => {
        resetForm('am');
        goHome();
      }, 2000);
      
    } catch (error) {
      console.error('AM submission error:', error);
      showMessage(`Error: ${error.message}`, 'error');
    }
  }
  
  async function submitPM() {
    try {
      hideAllSections();
      document.getElementById('loadingScreen').classList.add('active');
      
      const data = collectFormData('pm');
      const calculations = calculatePMAmounts(data);
      
      await storePMData(data, calculations);
      await sendEmailReport(data, calculations);
      
      // Show confirmation screen
      hideAllSections();
      document.getElementById('confirmationScreen').classList.add('active');
      
      // Display amounts
      document.getElementById('depositAmount').textContent = `$${Math.round(calculations.depositAmount)}`;
      document.getElementById('returnAmount').textContent = `$${calculations.returnAmount.toFixed(2)}`;
      
    } catch (error) {
      console.error('PM submission error:', error);
      showMessage(`Error: ${error.message}`, 'error');
      goHome();
    }
  }
  
  function calculatePMAmounts(data) {
    const amTotal = data.amTotal;
    const pmTotal = data.total;
    const toastSales = data.toastSales;
    const cashTips = data.cashTips;
    
    // Drawer change = PM - AM
    const drawerChange = pmTotal - amTotal;
    
    // Discrepancy = actual change vs expected (Toast sales)
    const discrepancy = drawerChange - toastSales;
    
    // Staff see: Deposit = Toast + Tips (always whole number)
    const depositAmount = toastSales + cashTips;
    
    // Manager calculations for email
    let adjustedTips = cashTips;
    let returnAmount = amTotal;
    
    if (discrepancy > 0) {
      // Over: add excess to return amount
      returnAmount += discrepancy;
    } else if (discrepancy < 0) {
      // Short: reduce tips to cover shortage
      const shortage = Math.abs(discrepancy);
      adjustedTips = Math.max(0, cashTips - shortage);
    }
    
    return {
      amTotal,
      pmTotal,
      drawerChange,
      toastSales,
      cashTips,
      discrepancy,
      adjustedTips,
      depositAmount,
      returnAmount,
      drawerOver: discrepancy > 0 ? discrepancy : 0,
      drawerShort: discrepancy < 0 ? Math.abs(discrepancy) : 0
    };
  }
  
  async function storeAMData(data) {
    if (!supabase) throw new Error('Database not connected');
    
    const { error } = await supabase
      .from('cash_counts')
      .upsert({
        date: data.date,
        am_counter: data.counter,
        am_timestamp: data.timestamp,
        am_total: data.total,
        am_drawer1_total: data.drawer1.total,
        am_drawer1_skip: data.drawer1.skipped,
        am_drawer1_skip_reason: data.drawer1.skipReason,
        am_drawer1_data: data.drawer1.counts,
        am_drawer2_total: data.drawer2.total,
        am_drawer2_skip: data.drawer2.skipped,
        am_drawer2_skip_reason: data.drawer2.skipReason,
        am_drawer2_data: data.drawer2.counts,
        am_notes: data.notes
      });
    
    if (error) throw new Error(`Database error: ${error.message}`);
  }
  
  async function storePMData(data, calculations) {
    if (!supabase) throw new Error('Database not connected');
    
    const { error } = await supabase
      .from('cash_counts')
      .update({
        pm_counter: data.counter,
        pm_timestamp: data.timestamp,
        pm_total: data.total,
        pm_cash_tips: data.cashTips,
        pm_toast_sales: data.toastSales,
        pm_drawer1_total: data.drawer1.total,
        pm_drawer1_skip: data.drawer1.skipped,
        pm_drawer1_skip_reason: data.drawer1.skipReason,
        pm_drawer1_data: data.drawer1.counts,
        pm_drawer2_total: data.drawer2.total,
        pm_drawer2_skip: data.drawer2.skipped,
        pm_drawer2_skip_reason: data.drawer2.skipReason,
        pm_drawer2_data: data.drawer2.counts,
        pm_notes: data.notes,
        pm_discrepancy: calculations.discrepancy,
        pm_adjusted_tips: calculations.adjustedTips,
        pm_drawer_over_amount: calculations.drawerOver,
        pm_deposit_amount: calculations.depositAmount,
        pm_amount_to_keep: calculations.returnAmount
      })
      .eq('date', data.date);
    
    if (error) throw new Error(`Database error: ${error.message}`);
  }
  
  async function getAMData(date) {
    if (!supabase) return null;
    
    const { data, error } = await supabase
      .from('cash_counts')
      .select('*')
      .eq('date', date)
      .single();
    
    if (error || !data || !data.am_total) return null;
    
    return {
      date: data.date,
      counter: data.am_counter,
      timestamp: data.am_timestamp,
      total: data.am_total,
      drawer1: {
        total: data.am_drawer1_total,
        skipped: data.am_drawer1_skip,
        skipReason: data.am_drawer1_skip_reason,
        counts: data.am_drawer1_data
      },
      drawer2: {
        total: data.am_drawer2_total,
        skipped: data.am_drawer2_skip,
        skipReason: data.am_drawer2_skip_reason,
        counts: data.am_drawer2_data
      },
      notes: data.am_notes
    };
  }
  
  async function sendEmailReport(data, calculations) {
    const templateParams = {
      to_email: EMAILJS_CONFIG.MANAGER_EMAIL,
      date: data.date,
      am_counter: currentAMData ? currentAMData.counter : 'N/A',
      pm_counter: data.counter,
      am_timestamp: currentAMData ? new Date(currentAMData.timestamp).toLocaleString() : 'N/A',
      pm_timestamp: new Date(data.timestamp).toLocaleString(),
      am_total: calculations.amTotal.toFixed(2),
      pm_total: calculations.pmTotal.toFixed(2),
      drawer_change: calculations.drawerChange.toFixed(2),
      toast_sales: calculations.toastSales.toFixed(2),
      original_tips: calculations.cashTips.toFixed(2),
      discrepancy: calculations.discrepancy.toFixed(2),
      discrepancy_direction: calculations.discrepancy >= 0 ? 'Over' : 'Short',
      adjusted_tips: calculations.adjustedTips.toFixed(2),
      deposit_amount: Math.round(calculations.depositAmount).toString(),
      return_amount: calculations.returnAmount.toFixed(2),
      drawer_over: calculations.drawerOver.toFixed(2),
      drawer_short: calculations.drawerShort.toFixed(2),
      am_notes: currentAMData ? (currentAMData.notes || '') : '',
      pm_notes: data.notes || '',
      has_discrepancy: calculations.discrepancy !== 0 ? 'true' : 'false'
    };
    
    const response = await emailjs.send(
      EMAILJS_CONFIG.SERVICE_ID,
      EMAILJS_CONFIG.TEMPLATE_ID,
      templateParams
    );
    
    if (!response.status === 200) {
      throw new Error('Email send failed');
    }
  }
  
  async function generateReport() {
    const date = document.getElementById('reportDate').value;
    if (!date) {
      showMessage('Please select a date', 'error');
      return;
    }
    
    try {
      showMessage('Generating report...', 'info');
      
      const amData = await getAMData(date);
      if (!amData) {
        throw new Error('No data found for this date');
      }
      
      // For report generation, we'll use stored PM data or create a basic report
      const { data: fullData } = await supabase
        .from('cash_counts')
        .select('*')
        .eq('date', date)
        .single();
      
      if (fullData && fullData.pm_total) {
        // Full day report
        const reportData = {
          date: date,
          counter: fullData.pm_counter,
          total: fullData.pm_total,
          toastSales: fullData.pm_toast_sales,
          cashTips: fullData.pm_cash_tips,
          amTotal: fullData.am_total,
          notes: fullData.pm_notes
        };
        
        const calculations = {
          amTotal: fullData.am_total,
          pmTotal: fullData.pm_total,
          drawerChange: fullData.pm_total - fullData.am_total,
          toastSales: fullData.pm_toast_sales,
          cashTips: fullData.pm_cash_tips,
          discrepancy: fullData.pm_discrepancy,
          adjustedTips: fullData.pm_adjusted_tips,
          depositAmount: fullData.pm_deposit_amount,
          returnAmount: fullData.pm_amount_to_keep,
          drawerOver: fullData.pm_drawer_over_amount || 0,
          drawerShort: fullData.pm_discrepancy < 0 ? Math.abs(fullData.pm_discrepancy) : 0
        };
        
        currentAMData = amData;
        await sendEmailReport(reportData, calculations);
      } else {
        throw new Error('Incomplete data for this date');
      }
      
      showMessage('Report sent successfully!', 'success');
      
    } catch (error) {
      console.error('Report generation error:', error);
      showMessage(`Error: ${error.message}`, 'error');
    }
  }
  
  function resetForm(shift) {
    document.getElementById(`${shift}Counter`).value = '';
    document.getElementById(`${shift}Notes`).value = '';
    
    // Reset drawer skips
    document.getElementById(`${shift}Drawer1Skip`).checked = false;
    document.getElementById(`${shift}Drawer2Skip`).checked = false;
    toggleSkip(shift, 1);
    toggleSkip(shift, 2);
    
    // Reset all denomination inputs
    DENOMINATIONS.forEach((denom, index) => {
      document.getElementById(`${shift}D1Q${index}`).value = '0';
      document.getElementById(`${shift}D2Q${index}`).value = '0';
    });
    
    if (shift === 'pm') {
      document.getElementById('toastSales').value = '';
      document.getElementById('cashTips').value = '';
    }
    
    updateCalculations(shift, 1);
    updateCalculations(shift, 2);
  }
</script>
</body>
</html>