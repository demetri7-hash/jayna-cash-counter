<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Jayna Gyro Cash Counter</title>
  
  <link rel="apple-touch-icon" href="https://static.spotapps.co/website_images/ab_websites/229800_website_v1/logo.png">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#667eea">
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 10px; } /* Reduced padding */
    .container { max-width: 600px; margin: 0 auto; background: white; border-radius: 20px; overflow: hidden; box-shadow: 0 20px 40px rgba(0,0,0,0.1); }
    .header { background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: white; text-align: center; padding: 20px; } /* Reduced from 30px 20px */
    .header h1 { font-size: 24px; font-weight: 700; margin-bottom: 5px; } /* Reduced font size and margin */
    .header p { opacity: 0.9; font-size: 14px; } /* Reduced font size */
    /* Mobile-First Responsive Design */
    .content { padding: 15px; } /* Reduced from 20px */
    .main-menu { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; } /* Reduced gaps */
    .main-menu.show-report { grid-template-columns: 1fr 1fr 1fr; }
    .menu-btn { padding: 25px 20px; border: 3px solid #e0e0e0; border-radius: 15px; background: white; font-size: 18px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; text-align: center; min-height: 70px; display: flex; align-items: center; justify-content: center; } /* Reduced from 80px */
    .menu-btn:hover { border-color: #667eea; transform: translateY(-2px); }
    .menu-btn.active { border-color: #667eea; background: #667eea; color: white; transform: translateY(-2px); }
    .menu-btn.report { background: #28a745; color: white; border-color: #28a745; }
    .form-section { display: none; }
    .form-section.active { display: block; }
    .form-group { margin-bottom: 20px; } /* Reduced from 25px */
    .form-group label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 16px; color: #333; } /* Reduced margin */
    
    /* Enhanced Mobile-Friendly Inputs */
    .form-input, .form-select { 
      width: 100%; 
      padding: 18px 20px; 
      border: 2px solid #e0e0e0; 
      border-radius: 12px; 
      font-size: 18px; 
      min-height: 56px;
      box-sizing: border-box;
      -webkit-appearance: none;
      appearance: none;
    }
    .form-input:focus, .form-select:focus { 
      outline: none; 
      border-color: #667eea; 
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    /* Number inputs with mobile optimization */
    input[type="number"] {
      -webkit-appearance: none;
      -moz-appearance: textfield;
      appearance: none;
      /* Remove number input arrows */
    }
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    
    .drawer-section { margin: 20px 0; border: 2px solid #f0f0f0; border-radius: 15px; overflow: hidden; } /* Reduced margin */
    .drawer-header { background: #f8f9fa; padding: 15px 20px; font-weight: 600; display: flex; justify-content: space-between; align-items: center; font-size: 16px; } /* Reduced padding */
    .skip-toggle { display: flex; align-items: center; gap: 12px; font-size: 16px; color: #666; }
    .skip-toggle input[type="checkbox"] { width: 20px; height: 20px; }
    .drawer-content { padding: 20px; } /* Reduced from 25px */
    .denom-row { display: flex; justify-content: space-between; align-items: center; padding: 14px 0; border-bottom: 1px solid #f0f0f0; } /* Reduced padding */
    .denom-row:last-child { border-bottom: none; }
    .denom-label { font-weight: 600; font-size: 18px; color: #333; }
    .denom-value { font-size: 16px; color: #666; margin-top: 4px; }
    
    /* Mobile-Optimized Quantity Inputs */
    .qty-input { 
      width: 100px; 
      height: 56px; 
      text-align: center; 
      border: 2px solid #e0e0e0; 
      border-radius: 12px; 
      font-size: 20px; 
      font-weight: 600;
      -webkit-appearance: none;
      -moz-appearance: textfield;
      appearance: none;
      /* Force numeric keyboard on mobile */
      inputmode: numeric;
      pattern: "[0-9]*";
    }
    .qty-input:focus { 
      outline: none; 
      border-color: #667eea; 
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    /* Remove number arrows */
    .qty-input::-webkit-outer-spin-button,
    .qty-input::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    
    .drawer-total { margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 12px; text-align: center; font-size: 20px; font-weight: 600; } /* Reduced margins and padding */
    .grand-total { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 15px; text-align: center; margin: 20px 0; } /* Reduced margin */
    .grand-total h3 { font-size: 20px; margin-bottom: 8px; }
    .grand-total .amount { font-size: 36px; font-weight: 700; }
    .notes-area { width: 100%; min-height: 100px; padding: 18px; border: 2px solid #e0e0e0; border-radius: 12px; font-size: 16px; resize: vertical; box-sizing: border-box; } /* Reduced min-height */
    .notes-area:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
    .submit-btn { width: 100%; padding: 18px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 15px; font-size: 20px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; margin-top: 20px; min-height: 56px; } /* Reduced padding and margin */
    .submit-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3); }
    .submit-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
    .am-total-display { background: #e7f3ff; padding: 20px; border-radius: 12px; margin: 20px 0; }
    .am-total-display h4 { margin-bottom: 8px; color: #1976d2; font-size: 16px; }
    .am-total-display .amount { font-size: 28px; font-weight: bold; color: #1565c0; }
    
    /* Enhanced Currency Inputs */
    .currency-input { 
      width: 100%; 
      padding: 20px; 
      border: 2px solid #e0e0e0; 
      border-radius: 12px; 
      font-size: 22px; 
      text-align: center; 
      min-height: 60px;
      box-sizing: border-box;
      -webkit-appearance: none;
      -moz-appearance: textfield;
      appearance: none;
      inputmode: decimal;
    }
    .currency-input:focus { 
      outline: none; 
      border-color: #667eea; 
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    /* Remove number arrows from currency inputs */
    .currency-input::-webkit-outer-spin-button,
    .currency-input::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    
    .confirmation-screen { text-align: center; padding: 40px 20px; }
    .confirmation-screen h2 { color: #28a745; margin-bottom: 30px; font-size: 32px; }
    .deposit-instruction { background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; padding: 30px; border-radius: 15px; margin: 25px 0; font-size: 24px; font-weight: bold; }
    .return-instruction { background: linear-gradient(135deg, #fd7e14 0%, #e83e8c 100%); color: white; padding: 30px; border-radius: 15px; margin: 25px 0; font-size: 24px; font-weight: bold; }
    .thank-you { font-size: 22px; color: #28a745; margin: 30px 0; font-weight: 600; }
    .confirm-btn { background: #28a745; margin-top: 30px; }
    .loading { text-align: center; padding: 40px; }
    .loading-spinner { width: 60px; height: 60px; border: 6px solid #f3f3f3; border-top: 6px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .message { padding: 18px; border-radius: 12px; margin: 20px 0; text-align: center; font-size: 16px; }
    .message.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .message.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    .message.info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
    .hidden { display: none; }
    .skip-content { padding: 25px; }
    .skip-reason { width: 100%; padding: 18px; border: 2px solid #e0e0e0; border-radius: 12px; font-size: 16px; min-height: 56px; box-sizing: border-box; }
    
    /* Mobile responsive adjustments */
    @media (max-width: 768px) {
      .container { margin: 0; border-radius: 0; }
      .header { padding: 20px; }
      .header h1 { font-size: 24px; }
      .content { padding: 15px; }
      .main-menu { gap: 12px; }
      .menu-btn { padding: 25px 15px; font-size: 16px; min-height: 70px; }
      .denom-row { flex-direction: column; align-items: flex-start; gap: 12px; padding: 20px 0; }
      .qty-input { width: 120px; margin-top: 8px; }
      .grand-total .amount { font-size: 32px; }
      .confirmation-screen h2 { font-size: 28px; }
      .deposit-instruction, .return-instruction { font-size: 20px; padding: 25px; }
    }
    
    @media (max-width: 480px) {
      .header h1 { font-size: 20px; }
      .main-menu { grid-template-columns: 1fr; }
      .main-menu.show-report { grid-template-columns: 1fr; }
      .menu-btn { padding: 20px 15px; min-height: 60px; }
      .denom-label { font-size: 16px; }
      .qty-input { width: 100px; height: 50px; font-size: 18px; }
      .grand-total .amount { font-size: 28px; }
      .deposit-instruction, .return-instruction { font-size: 18px; padding: 20px; }
    }
    
    /* Elegant Loading Overlay */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      z-index: 9999;
      display: flex;
      justify-content: center;
      align-items: center;
      transition: opacity 0.3s ease;
    }
    .loading-overlay.hidden {
      display: none;
    }
    .loading-content {
      text-align: center;
      padding: 40px;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    .loading-spinner-elegant {
      width: 60px;
      height: 60px;
      border: 4px solid rgba(102, 126, 234, 0.1);
      border-top: 4px solid #667eea;
      border-radius: 50%;
      animation: spin-elegant 1.2s linear infinite;
      margin: 0 auto 20px;
    }
    @keyframes spin-elegant {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .loading-content h3 {
      margin: 0 0 10px 0;
      font-size: 24px;
      color: #333;
      font-weight: 600;
    }
    .loading-content p {
      margin: 0;
      font-size: 16px;
      color: #666;
      opacity: 0.8;
    }
    
    /* Success Screens */
    .success-screen {
      text-align: center;
      padding: 40px 20px;
      max-width: 600px;
      margin: 0 auto;
    }
    .success-icon {
      font-size: 80px;
      margin-bottom: 20px;
      animation: success-bounce 0.6s ease;
    }
    @keyframes success-bounce {
      0% { transform: scale(0.3); opacity: 0; }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); opacity: 1; }
    }
    .success-screen h2 {
      color: #28a745;
      margin-bottom: 15px;
      font-size: 32px;
      font-weight: 700;
    }
    .success-message {
      font-size: 18px;
      color: #666;
      margin-bottom: 30px;
      line-height: 1.5;
    }
    .success-details {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 25px;
      margin: 25px 0;
      border-left: 4px solid #28a745;
    }
    .detail-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      font-size: 16px;
    }
    .detail-row:not(:last-child) {
      border-bottom: 1px solid #e9ecef;
    }
    .detail-row span:first-child {
      color: #666;
      font-weight: 500;
    }
    .detail-row span:last-child {
      color: #333;
      font-weight: 600;
    }
    .success-btn {
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
      margin-top: 30px;
      font-size: 18px;
      padding: 20px 40px;
      border-radius: 12px;
      transition: all 0.3s ease;
    }
    .success-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(40, 167, 69, 0.3);
    }
  </style>
  
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>JAYNA GYRO CASH COUNTER</h1>
      <p>App created by Demetri Gregorakis</p>
    </div>
    
    <div class="content">
      <div id="messageArea"></div>
      
      <!-- Main Menu -->
      <div id="mainMenu" class="main-menu">
        <button class="menu-btn" onclick="startAMCount()">AM Count</button>
        <button class="menu-btn" onclick="startPMCount()">PM Close</button>
        <button class="menu-btn report" onclick="showReports()">Generate Report</button>
      </div>
      
      <!-- AM Count Form -->
      <div id="amForm" class="form-section">
        <h2 style="margin-bottom: 20px; color: #1e3c72;">Morning Cash Count</h2>
        
        <div class="form-group">
          <label for="amDate">Date:</label>
          <input type="date" id="amDate" class="form-input" required>
        </div>
        
        <div class="form-group">
          <label for="amCounter">Counted by:</label>
          <select id="amCounter" class="form-select" required>
            <option value="">Choose Name</option>
            <option value="Demetri Gregorakis">Demetri Gregorakis</option>
            <option value="Ahmet Can Guler">Ahmet Can Guler</option>
            <option value="Bryan Cox">Bryan Cox</option>
          </select>
        </div>
        
        <!-- Drawer 1 -->
        <div class="drawer-section">
          <div class="drawer-header">
            <span>Drawer 1</span>
            <label class="skip-toggle">
              <input type="checkbox" id="amDrawer1Skip" onchange="toggleSkip('am', 1)">
              Skip Drawer
            </label>
          </div>
          <div id="amDrawer1Content" class="drawer-content">
            <div id="amDrawer1Denoms"></div>
            <div class="drawer-total" id="amDrawer1Total">$0.00</div>
          </div>
          <div id="amDrawer1SkipContent" class="skip-content hidden">
            <input type="text" class="skip-reason" id="amDrawer1Reason" placeholder="Reason for skipping drawer 1">
          </div>
        </div>
        
        <!-- Drawer 2 -->
        <div class="drawer-section">
          <div class="drawer-header">
            <span>Drawer 2</span>
            <label class="skip-toggle">
              <input type="checkbox" id="amDrawer2Skip" onchange="toggleSkip('am', 2)">
              Skip Drawer
            </label>
          </div>
          <div id="amDrawer2Content" class="drawer-content">
            <div id="amDrawer2Denoms"></div>
            <div class="drawer-total" id="amDrawer2Total">$0.00</div>
          </div>
          <div id="amDrawer2SkipContent" class="skip-content hidden">
            <input type="text" class="skip-reason" id="amDrawer2Reason" placeholder="Reason for skipping drawer 2">
          </div>
        </div>
        
        <div class="grand-total">
          <h3>Total Cash Count</h3>
          <div class="amount" id="amGrandTotal">$0.00</div>
        </div>
        
        <div class="form-group">
          <label for="amNotes">Notes (Optional):</label>
          <textarea id="amNotes" class="notes-area" placeholder="Any notes for the PM shift..."></textarea>
        </div>
        
        <button class="submit-btn" onclick="submitAM()">Submit AM Count</button>
        <button class="submit-btn" onclick="goHome()" style="background: #6c757d; margin-top: 10px;">Back to Menu</button>
      </div>
      
      <!-- PM Count Form -->
      <div id="pmForm" class="form-section">
        <h2 style="margin-bottom: 20px; color: #1e3c72;">Evening Cash Close</h2>
        
        <div class="form-group">
          <label for="pmDate">Date:</label>
          <input type="date" id="pmDate" class="form-input" required>
        </div>
        
        <div class="form-group">
          <label for="pmCounter">Counted by:</label>
          <select id="pmCounter" class="form-select" required>
            <option value="">Choose Name</option>
            <option value="Demetri Gregorakis">Demetri Gregorakis</option>
            <option value="Ahmet Can Guler">Ahmet Can Guler</option>
            <option value="Bryan Cox">Bryan Cox</option>
          </select>
        </div>
        
        <!-- AM Total Display -->
        <div id="amTotalDisplay" class="am-total-display">
          <h4>Morning Count Information:</h4>
          <div style="display: flex; justify-content: space-between; margin: 10px 0; font-size: 14px;">
            <span><strong>Counted by:</strong> <span id="amCounterName">Loading...</span></span>
            <span><strong>Time:</strong> <span id="amCountTime">Loading...</span></span>
          </div>
          <div style="text-align: center; margin: 15px 0;">
            <strong>Starting Amount:</strong>
            <div class="amount" id="pmAmTotal" style="font-size: 28px; margin: 5px 0;">Loading...</div>
          </div>
          <div id="amNotesDisplay" style="background: #fff3cd; padding: 12px; border-radius: 6px; margin-top: 15px; border-left: 4px solid #ffc107; display: none;">
            <strong style="color: #856404;">Morning Notes:</strong>
            <div id="amNotes" style="margin-top: 5px; color: #856404;"></div>
          </div>
        </div>
        
        <!-- Drawer 1 -->
        <div class="drawer-section">
          <div class="drawer-header">
            <span>Drawer 1</span>
            <label class="skip-toggle">
              <input type="checkbox" id="pmDrawer1Skip" onchange="toggleSkip('pm', 1)">
              Skip Drawer
            </label>
          </div>
          <div id="pmDrawer1Content" class="drawer-content">
            <div id="pmDrawer1Denoms"></div>
            <div class="drawer-total" id="pmDrawer1Total">$0.00</div>
          </div>
          <div id="pmDrawer1SkipContent" class="skip-content hidden">
            <input type="text" class="skip-reason" id="pmDrawer1Reason" placeholder="Reason for skipping drawer 1">
          </div>
        </div>
        
        <!-- Drawer 2 -->
        <div class="drawer-section">
          <div class="drawer-header">
            <span>Drawer 2</span>
            <label class="skip-toggle">
              <input type="checkbox" id="pmDrawer2Skip" onchange="toggleSkip('pm', 2)">
              Skip Drawer
            </label>
          </div>
          <div id="pmDrawer2Content" class="drawer-content">
            <div id="pmDrawer2Denoms"></div>
            <div class="drawer-total" id="pmDrawer2Total">$0.00</div>
          </div>
          <div id="pmDrawer2SkipContent" class="skip-content hidden">
            <input type="text" class="skip-reason" id="pmDrawer2Reason" placeholder="Reason for skipping drawer 2">
          </div>
        </div>
        
        <div class="grand-total">
          <h3>Total Cash Count</h3>
          <div class="amount" id="pmGrandTotal">$0.00</div>
        </div>
        
        <div class="form-group">
          <label for="toastSales">Toast Cash Sales (exact amount):</label>
          <input type="number" id="toastSales" class="currency-input" placeholder="0.00" step="0.01" min="0" inputmode="decimal" onfocus="this.select()">
        </div>
        
        <div class="form-group">
          <label for="cashTips">Cash Tips (whole number):</label>
          <input type="number" id="cashTips" class="currency-input" placeholder="0" step="1" min="0" inputmode="numeric" pattern="[0-9]*" onfocus="this.select()">
        </div>
        
        <div class="form-group">
          <label for="pmNotes">Notes (Optional):</label>
          <textarea id="pmNotes" class="notes-area" placeholder="Any notes about the day..."></textarea>
        </div>
        
        <button class="submit-btn" onclick="submitPM()">Submit PM Close</button>
        <button class="submit-btn" onclick="goHome()" style="background: #6c757d; margin-top: 10px;">Back to Menu</button>
      </div>
      
      <!-- Elegant Loading Overlay -->
      <div id="loadingOverlay" class="loading-overlay hidden">
        <div class="loading-content">
          <div class="loading-spinner-elegant"></div>
          <h3 id="loadingTitle">Processing...</h3>
          <p id="loadingMessage">Please wait while we process your request</p>
        </div>
      </div>
      
      <!-- AM Success Screen -->
      <div id="amSuccessScreen" class="form-section">
        <div class="success-screen">
          <div class="success-icon">‚úÖ</div>
          <h2>AM Count Submitted!</h2>
          <p class="success-message">Your morning cash count has been successfully recorded and stored.</p>
          <div class="success-details">
            <div class="detail-row">
              <span>Total Counted:</span>
              <span id="amSuccessTotal">$0.00</span>
            </div>
            <div class="detail-row">
              <span>Time Submitted:</span>
              <span id="amSuccessTime">--</span>
            </div>
          </div>
          <button class="submit-btn success-btn" onclick="goHome()">Return to Menu</button>
        </div>
      </div>

      <!-- PM Success Screen -->
      <div id="pmSuccessScreen" class="form-section">
        <div class="success-screen">
          <div class="success-icon">‚úÖ</div>
          <h2>PM Close Completed!</h2>
          <p class="success-message">Evening close successful! Report sent to management.</p>
          
          <div class="deposit-instruction">
            DEPOSIT <span id="depositAmount">$0</span> INTO ENVELOPE
          </div>
          
          <div class="return-instruction">
            RETURN <span id="returnAmount">$0.00</span> TO CASH BOX AND LOCK IN SAFE
          </div>
          
          <div class="success-details">
            <div class="detail-row">
              <span>Cash Discrepancy:</span>
              <span id="pmDiscrepancyAmount">$0.00</span>
            </div>
          </div>
          
          <button class="submit-btn success-btn" onclick="goHome()">Confirm and Close</button>
        </div>
      </div>

      <!-- Report Success Screen -->
      <div id="reportSuccessScreen" class="form-section">
        <div class="success-screen">
          <div class="success-icon">üìß</div>
          <h2>Report Sent Successfully!</h2>
          <p class="success-message">Daily cash report has been emailed to management.</p>
          <div class="success-details">
            <div class="detail-row">
              <span>Report Date:</span>
              <span id="reportSuccessDate">--</span>
            </div>
            <div class="detail-row">
              <span>Sent At:</span>
              <span id="reportSuccessTime">--</span>
            </div>
          </div>
          <button class="submit-btn success-btn" onclick="goHome()">Return to Menu</button>
        </div>
      </div>
      
      <!-- Reports Section -->
      <div id="reportsForm" class="form-section">
        <h2 style="margin-bottom: 20px; color: #1e3c72;">Generate Report</h2>
        
        <div class="form-group">
          <label for="reportDate">Select Date:</label>
          <input type="date" id="reportDate" class="form-input" required>
        </div>
        
        <button class="submit-btn" onclick="generateReport()" style="background: #28a745;">Generate Email Report</button>
        <button class="submit-btn" onclick="goHome()" style="background: #6c757d; margin-top: 10px;">Back to Menu</button>
      </div>
    </div>
  </div>

<script>
  // Configuration
   const SUPABASE_URL = 'https://gaawtbqpnnbbnsyswqwv.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdhYXd0YnFwbm5iYm5zeXN3cXd2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1MDE1NTAsImV4cCI6MjA3MjA3NzU1MH0.F-y7AIQTWaUe7DRT4OnIZVn94mhXxfhpBbng2aJ8nXg';  
  const EMAILJS_CONFIG = {
    PUBLIC_KEY: 'LHbq8j4mlt49O75eo',
    SERVICE_ID: 'service_xm62z73',
    TEMPLATE_ID: 'template_cash_report',
    MANAGER_EMAIL: 'smanager@jaynagyro.com, GSS4168CTJJA73@PRINT.EPSONCONNECT.COM'
  };

  // Elegant Loading and Success Functions
  function showLoading(title, message) {
    const overlay = document.getElementById('loadingOverlay');
    document.getElementById('loadingTitle').textContent = title;
    document.getElementById('loadingMessage').textContent = message;
    overlay.classList.remove('hidden');
    hideAllSections();
  }

  function hideLoading() {
    document.getElementById('loadingOverlay').classList.add('hidden');
  }

  function showAMSuccess(total) {
    hideLoading();
    hideAllSections();
    document.getElementById('amSuccessTotal').textContent = `$${total.toFixed(2)}`;
    document.getElementById('amSuccessTime').textContent = new Date().toLocaleString();
    document.getElementById('amSuccessScreen').classList.add('active');
  }

  function showPMSuccess(depositAmount, returnAmount, discrepancy) {
    hideLoading();
    hideAllSections();
    document.getElementById('depositAmount').textContent = `$${Math.round(depositAmount)}`;
    document.getElementById('returnAmount').textContent = `$${returnAmount.toFixed(2)}`;
    document.getElementById('pmDiscrepancyAmount').textContent = `$${Math.abs(discrepancy).toFixed(2)}`;
    document.getElementById('pmSuccessScreen').classList.add('active');
  }

  function showReportSuccess(date) {
    hideLoading();
    hideAllSections();
    document.getElementById('reportSuccessDate').textContent = date;
    document.getElementById('reportSuccessTime').textContent = new Date().toLocaleString();
    document.getElementById('reportSuccessScreen').classList.add('active');
  }
  
  const DENOMINATIONS = [
    { label: '$100', value: 100.00 },
    { label: '$50', value: 50.00 },
    { label: '$20', value: 20.00 },
    { label: '$10', value: 10.00 },
    { label: '$5', value: 5.00 },
    { label: '$1', value: 1.00 },
    { label: '$0.25', value: 0.25 },
    { label: '$0.10', value: 0.10 },
    { label: '$0.05', value: 0.05 },
    { label: '$0.01', value: 0.01 }
  ];
  
  // Password protection for date changes (only Demetri knows this)
  const ADMIN_PASSWORD = 'JaynaGyro2025!';
  
  let supabase = null;
  let currentAMData = null;
  
  // Initialize app
  document.addEventListener('DOMContentLoaded', function() {
    initializeSupabase();
    initializeEmailJS();
    setTodayDate();
    // Removed "App ready" message to prevent page bouncing
  });
  
  function initializeSupabase() {
    if (SUPABASE_URL === 'YOUR_SUPABASE_URL_HERE' || SUPABASE_ANON_KEY === 'YOUR_SUPABASE_ANON_KEY_HERE') {
      showMessage('Please configure Supabase credentials', 'error');
      return;
    }
    try {
      supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      console.log('Supabase initialized');
    } catch (error) {
      console.error('Supabase init failed:', error);
      showMessage('Database connection failed', 'error');
    }
  }
  
  function initializeEmailJS() {
    if (typeof emailjs !== 'undefined') {
      emailjs.init(EMAILJS_CONFIG.PUBLIC_KEY);
    }
  }
  
  function setTodayDate() {
    const today = getPacificDate();
    document.getElementById('amDate').value = today;
    document.getElementById('pmDate').value = today;
    document.getElementById('reportDate').value = today;
    
    // Add password protection to date inputs
    document.getElementById('amDate').addEventListener('change', function() {
      const result = validateDateChange(this);
      if (result instanceof Promise) {
        // Handle async validation - input value already reset if needed
        return;
      }
    });
    
    document.getElementById('pmDate').addEventListener('change', function() {
      const result = validateDateChange(this);
      if (result instanceof Promise) {
        result.then((success) => {
          if (success) {
            // Only load AM data if date change was authorized
            loadAMData();
          }
        });
      } else if (result) {
        // Synchronous case (current date selected)
        loadAMData();
      }
    });
    
    document.getElementById('reportDate').addEventListener('change', function() {
      const result = validateDateChange(this);
      if (result instanceof Promise) {
        // Handle async validation - input value already reset if needed
        return;
      }
    });
  }
  
  function getPacificDate() {
    const now = new Date();
    const pacific = new Date(now.toLocaleString("en-US", {timeZone: "America/Los_Angeles"}));
    const year = pacific.getFullYear();
    const month = String(pacific.getMonth() + 1).padStart(2, '0');
    const day = String(pacific.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
  }
  
  function showMessage(text, type) {
    // Only show popups for important messages (errors), ignore info/success
    if (type === 'error') {
      showPopupMessage(text, type);
    }
    // Silently ignore info and success messages to prevent bouncing
  }
  
  function showPopupMessage(text, type) {
    const messageType = type === 'error' ? 'Error' : type === 'success' ? 'Success' : 'Notice';
    const backgroundColor = type === 'error' ? '#f44336' : '#4CAF50';
    const iconEmoji = type === 'error' ? '‚ùå' : '‚úÖ';
    
    const modalHTML = `
      <div id="messageModal" style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.7);
        z-index: 10000;
        display: flex;
        justify-content: center;
        align-items: center;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      ">
        <div style="
          background: white;
          padding: 30px;
          border-radius: 12px;
          box-shadow: 0 10px 30px rgba(0,0,0,0.3);
          max-width: 400px;
          width: 90%;
          text-align: center;
        ">
          <h3 style="margin: 0 0 20px 0; color: ${backgroundColor};">${iconEmoji} ${messageType}</h3>
          <p style="margin: 0 0 25px 0; line-height: 1.4; font-size: 16px;">
            ${text}
          </p>
          <button onclick="closeMessageModal()" style="
            background: ${backgroundColor};
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
          ">OK</button>
        </div>
      </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
  }
  
  function closeMessageModal() {
    const modal = document.getElementById('messageModal');
    if (modal) {
      modal.remove();
    }
  }
  
  function validateDateChange(inputElement) {
    const selectedDate = inputElement.value;
    const currentDate = getPacificDate();
    
    // If user selects current date, allow it
    if (selectedDate === currentDate) {
      return true;
    }
    
    // If user selects different date, require password using custom modal
    return new Promise((resolve) => {
      showPasswordModal(selectedDate, currentDate, (success) => {
        if (!success) {
          inputElement.value = currentDate;
        }
        resolve(success);
      });
    });
  }
  
  function showPasswordModal(selectedDate, currentDate, callback) {
    // Create modal HTML
    const modalHTML = `
      <div id="passwordModal" style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.7);
        z-index: 10000;
        display: flex;
        justify-content: center;
        align-items: center;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      ">
        <div style="
          background: white;
          padding: 30px;
          border-radius: 12px;
          box-shadow: 0 10px 30px rgba(0,0,0,0.3);
          max-width: 400px;
          width: 90%;
          text-align: center;
        ">
          <h3 style="margin: 0 0 20px 0; color: #d32f2f;">‚ö†Ô∏è Date Change Warning</h3>
          <p style="margin: 0 0 15px 0; line-height: 1.4;">
            You are trying to change the date from<br>
            <strong>TODAY (${currentDate})</strong> to <strong>${selectedDate}</strong>
          </p>
          <p style="margin: 0 0 20px 0; color: #d32f2f; font-weight: bold;">
            This could overwrite existing data!
          </p>
          <p style="margin: 0 0 15px 0;">Enter admin password to continue:</p>
          <input type="password" id="passwordInput" style="
            width: 80%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            text-align: center;
            margin-bottom: 20px;
          " placeholder="Password">
          <div>
            <button onclick="submitPassword()" style="
              background: #4CAF50;
              color: white;
              border: none;
              padding: 10px 20px;
              border-radius: 6px;
              margin: 0 10px;
              cursor: pointer;
              font-size: 16px;
            ">Continue</button>
            <button onclick="cancelPassword()" style="
              background: #f44336;
              color: white;
              border: none;
              padding: 10px 20px;
              border-radius: 6px;
              margin: 0 10px;
              cursor: pointer;
              font-size: 16px;
            ">Cancel</button>
          </div>
        </div>
      </div>
    `;
    
    // Add modal to page
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // Focus password input
    document.getElementById('passwordInput').focus();
    
    // Store callback for button handlers
    window.passwordModalCallback = callback;
    
    // Add enter key support
    document.getElementById('passwordInput').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        submitPassword();
      }
    });
  }
  
  function submitPassword() {
    const password = document.getElementById('passwordInput').value;
    const modal = document.getElementById('passwordModal');
    
    if (password === ADMIN_PASSWORD) {
      // Silent success - no bouncing message
      modal.remove();
      window.passwordModalCallback(true);
    } else {
      showMessage('Incorrect password. Date has been reset to today for safety.', 'error');
      modal.remove();
      window.passwordModalCallback(false);
    }
  }
  
  function cancelPassword() {
    const modal = document.getElementById('passwordModal');
    modal.remove();
    window.passwordModalCallback(false);
  }
  
  function hideAllSections() {
    document.querySelectorAll('.form-section').forEach(section => section.classList.remove('active'));
  }
  
  function goHome() {
    hideAllSections();
    document.getElementById('mainMenu').style.display = 'grid';
  }
  
  function startAMCount() {
    document.getElementById('mainMenu').style.display = 'none';
    hideAllSections();
    document.getElementById('amForm').classList.add('active');
    setupDenominations('am');
  }
  
  async function startPMCount() {
    document.getElementById('mainMenu').style.display = 'none';
    hideAllSections();
    document.getElementById('pmForm').classList.add('active');
    setupDenominations('pm');
    
    await loadAMData();
  }
  
  function showReports() {
    document.getElementById('mainMenu').style.display = 'none';
    hideAllSections();
    document.getElementById('reportsForm').classList.add('active');
  }
  
  function setupDenominations(shift) {
    [1, 2].forEach(drawer => {
      const container = document.getElementById(`${shift}Drawer${drawer}Denoms`);
      container.innerHTML = '';
      
      DENOMINATIONS.forEach((denom, index) => {
        const row = document.createElement('div');
        row.className = 'denom-row';
        row.innerHTML = `
          <div>
            <div class="denom-label">${denom.label}</div>
            <div class="denom-value" id="${shift}D${drawer}V${index}">0 √ó $${denom.value.toFixed(2)} = $0.00</div>
          </div>
          <input type="number" class="qty-input" id="${shift}D${drawer}Q${index}" 
                 min="0" step="1" value="0" 
                 inputmode="numeric" pattern="[0-9]*"
                 oninput="updateCalculations('${shift}', ${drawer})" 
                 onfocus="this.select()">
        `;
        container.appendChild(row);
      });
    });
  }
  
  function toggleSkip(shift, drawer) {
    const skipBox = document.getElementById(`${shift}Drawer${drawer}Skip`);
    const content = document.getElementById(`${shift}Drawer${drawer}Content`);
    const skipContent = document.getElementById(`${shift}Drawer${drawer}SkipContent`);
    
    if (skipBox.checked) {
      content.classList.add('hidden');
      skipContent.classList.remove('hidden');
    } else {
      content.classList.remove('hidden');
      skipContent.classList.add('hidden');
    }
    updateCalculations(shift, drawer);
  }
  
  function updateCalculations(shift, drawer) {
    const skipBox = document.getElementById(`${shift}Drawer${drawer}Skip`);
    let drawerTotal = 0;
    
    if (!skipBox.checked) {
      DENOMINATIONS.forEach((denom, index) => {
        const qtyInput = document.getElementById(`${shift}D${drawer}Q${index}`);
        const qty = parseInt(qtyInput.value) || 0;
        const value = qty * denom.value;
        
        document.getElementById(`${shift}D${drawer}V${index}`).textContent = 
          `${qty} √ó $${denom.value.toFixed(2)} = $${value.toFixed(2)}`;
        
        drawerTotal += value;
      });
    }
    
    document.getElementById(`${shift}Drawer${drawer}Total`).textContent = `$${drawerTotal.toFixed(2)}`;
    updateGrandTotal(shift);
  }
  
  function updateGrandTotal(shift) {
    const drawer1Skip = document.getElementById(`${shift}Drawer1Skip`).checked;
    const drawer2Skip = document.getElementById(`${shift}Drawer2Skip`).checked;
    
    const drawer1Total = drawer1Skip ? 0 : parseFloat(document.getElementById(`${shift}Drawer1Total`).textContent.replace('$', ''));
    const drawer2Total = drawer2Skip ? 0 : parseFloat(document.getElementById(`${shift}Drawer2Total`).textContent.replace('$', ''));
    
    const grandTotal = drawer1Total + drawer2Total;
    document.getElementById(`${shift}GrandTotal`).textContent = `$${grandTotal.toFixed(2)}`;
  }
  
  async function loadAMData() {
    const date = document.getElementById('pmDate').value;
    console.log('Loading AM data for date:', date);
    
    if (!date) {
      document.getElementById('pmAmTotal').textContent = 'Please select a date';
      document.getElementById('amCounterName').textContent = 'Please select a date';
      document.getElementById('amCountTime').textContent = 'Please select a date';
      return;
    }
    
    // Show loading state
    document.getElementById('pmAmTotal').textContent = 'Loading...';
    document.getElementById('amCounterName').textContent = 'Loading...';
    document.getElementById('amCountTime').textContent = 'Loading...';
    
    try {
      if (!supabase) {
        throw new Error('Database not connected');
      }
      
      console.log('Querying Supabase for AM data...');
      const amData = await getAMData(date);
      console.log('AM data result:', amData);
      
      if (amData && amData.total > 0) {
        currentAMData = amData;
        document.getElementById('pmAmTotal').textContent = `$${amData.total.toFixed(2)}`;
        
        // FIX: Set AM counter name and timestamp
        document.getElementById('amCounterName').textContent = amData.counter || 'N/A';
        document.getElementById('amCountTime').textContent = amData.timestamp ? new Date(amData.timestamp).toLocaleString() : 'N/A';
        
        // Handle AM notes display
        const amNotesDisplay = document.getElementById('amNotesDisplay');
        const amNotesEl = document.getElementById('amNotes');
        if (amData.notes && amData.notes.trim()) {
          amNotesEl.textContent = amData.notes;
          amNotesDisplay.style.display = 'block';
        } else {
          amNotesDisplay.style.display = 'none';
        }
        
        // Removed "AM data loaded successfully" message to prevent bouncing
      } else {
        currentAMData = null;
        document.getElementById('pmAmTotal').textContent = 'No AM data found';
        document.getElementById('amCounterName').textContent = 'No AM data found';
        document.getElementById('amCountTime').textContent = 'No AM data found';
        const amNotesDisplay = document.getElementById('amNotesDisplay');
        if (amNotesDisplay) amNotesDisplay.style.display = 'none';
        showMessage(`No AM count found for ${date}`, 'error');
      }
    } catch (error) {
      console.error('Error loading AM data:', error);
      document.getElementById('pmAmTotal').textContent = 'Error loading AM data';
      document.getElementById('amCounterName').textContent = 'Error loading AM data';
      document.getElementById('amCountTime').textContent = 'Error loading AM data';
      showMessage(`Error: ${error.message}`, 'error');
    }
  }
  
  function collectFormData(shift) {
    const counter = document.getElementById(`${shift}Counter`).value;
    const date = document.getElementById(`${shift}Date`).value;
    const notes = document.getElementById(`${shift}Notes`).value.trim();
    
    if (!counter) throw new Error('Please select a name');
    if (!date) throw new Error('Please select a date');
    
    const drawer1Skip = document.getElementById(`${shift}Drawer1Skip`).checked;
    const drawer2Skip = document.getElementById(`${shift}Drawer2Skip`).checked;
    
    const drawer1Data = collectDrawerData(shift, 1, drawer1Skip);
    const drawer2Data = collectDrawerData(shift, 2, drawer2Skip);
    
    const data = {
      shift: shift,
      counter: counter,
      date: date,
      timestamp: new Date().toISOString(),
      drawer1: drawer1Data,
      drawer2: drawer2Data,
      drawer1Total: drawer1Data.total, // Add individual drawer totals for email template
      drawer2Total: drawer2Data.total,
      notes: notes || null,
      total: drawer1Data.total + drawer2Data.total
    };
    
    if (shift === 'pm') {
      const toastSales = parseFloat(document.getElementById('toastSales').value) || 0;
      const cashTips = parseInt(document.getElementById('cashTips').value) || 0;
      
      data.toastSales = toastSales;
      data.cashTips = cashTips;
      data.amTotal = currentAMData ? currentAMData.total : 0;
    }
    
    return data;
  }
  
  function collectDrawerData(shift, drawer, skipped) {
    if (skipped) {
      const reason = document.getElementById(`${shift}Drawer${drawer}Reason`).value.trim();
      return {
        skipped: true,
        skipReason: reason || 'No reason provided',
        counts: {},
        total: 0
      };
    }
    
    const counts = {};
    let total = 0;
    
    DENOMINATIONS.forEach((denom, index) => {
      const qty = parseInt(document.getElementById(`${shift}D${drawer}Q${index}`).value) || 0;
      counts[denom.label] = qty;
      total += qty * denom.value;
    });
    
    return {
      skipped: false,
      skipReason: null,
      counts: counts,
      total: Math.round(total * 100) / 100
    };
  }
  
  async function submitAM() {
    try {
      showLoading('Submitting AM Count', 'Recording your morning cash count...');
      
      const data = collectFormData('am');
      await storeAMData(data);
      
      // Show elegant success screen
      showAMSuccess(data.total);
      resetForm('am');
      
    } catch (error) {
      hideLoading();
      console.error('AM submission error:', error);
      showMessage(`Error: ${error.message}`, 'error');
    }
  }
  
  async function submitPM() {
    try {
      showLoading('Processing PM Close', 'Calculating totals and sending report to management...');
      
      const data = collectFormData('pm');
      const calculations = calculatePMAmounts(data);
      
      await storePMData(data, calculations);
      await sendEmailReport(data, calculations);
      
      // Show elegant success screen with deposit/return instructions
      showPMSuccess(calculations.depositAmount, calculations.returnAmount, calculations.discrepancy);
      
    } catch (error) {
      hideLoading();
      console.error('PM submission error:', error);
      showMessage(`Error: ${error.message}`, 'error');
      goHome();
    }
  }
  
  function calculatePMAmounts(data) {
    const amTotal = data.amTotal;
    const pmTotal = data.total;
    const toastSales = data.toastSales;
    const cashTips = data.cashTips;
    
    // Drawer change = PM - AM
    const drawerChange = pmTotal - amTotal;
    
    // Discrepancy = actual change vs expected (Toast sales)
    const discrepancy = drawerChange - toastSales;
    
    // Staff see: Deposit = Toast + Tips (always whole number)
    const depositAmount = toastSales + cashTips;
    
    // Manager calculations for email
    let adjustedTips = cashTips;
    let returnAmount = amTotal;
    
    if (discrepancy > 0) {
      // Over: add excess to return amount
      returnAmount += discrepancy;
    } else if (discrepancy < 0) {
      // Short: reduce tips to cover shortage
      const shortage = Math.abs(discrepancy);
      adjustedTips = Math.max(0, cashTips - shortage);
    }
    
    return {
      amTotal,
      pmTotal,
      drawerChange,
      toastSales,
      cashTips,
      discrepancy,
      adjustedTips,
      depositAmount,
      returnAmount,
      drawerOver: discrepancy > 0 ? discrepancy : 0,
      drawerShort: discrepancy < 0 ? Math.abs(discrepancy) : 0
    };
  }
  
  async function storeAMData(data) {
    if (!supabase) throw new Error('Database not connected');
    
    const { error } = await supabase
      .from('cash_counts')
      .upsert({
        date: data.date,
        am_counter: data.counter,
        am_timestamp: data.timestamp,
        am_total: data.total,
        am_drawer1_total: data.drawer1.total,
        am_drawer1_skip: data.drawer1.skipped,
        am_drawer1_skip_reason: data.drawer1.skipReason,
        am_drawer1_data: data.drawer1.counts,
        am_drawer2_total: data.drawer2.total,
        am_drawer2_skip: data.drawer2.skipped,
        am_drawer2_skip_reason: data.drawer2.skipReason,
        am_drawer2_data: data.drawer2.counts,
        am_notes: data.notes
      });
    
    if (error) throw new Error(`Database error: ${error.message}`);
  }
  
  async function storePMData(data, calculations) {
    if (!supabase) throw new Error('Database not connected');
    
    const { error } = await supabase
      .from('cash_counts')
      .update({
        pm_counter: data.counter,
        pm_timestamp: data.timestamp,
        pm_total: data.total,
        pm_cash_tips: data.cashTips,
        pm_toast_sales: data.toastSales,
        pm_drawer1_total: data.drawer1.total,
        pm_drawer1_skip: data.drawer1.skipped,
        pm_drawer1_skip_reason: data.drawer1.skipReason,
        pm_drawer1_data: data.drawer1.counts,
        pm_drawer2_total: data.drawer2.total,
        pm_drawer2_skip: data.drawer2.skipped,
        pm_drawer2_skip_reason: data.drawer2.skipReason,
        pm_drawer2_data: data.drawer2.counts,
        pm_notes: data.notes,
        pm_discrepancy: calculations.discrepancy,
        pm_adjusted_tips: calculations.adjustedTips,
        pm_drawer_over_amount: calculations.drawerOver,
        pm_deposit_amount: calculations.depositAmount,
        pm_amount_to_keep: calculations.returnAmount
      })
      .eq('date', data.date);
    
    if (error) throw new Error(`Database error: ${error.message}`);
  }
  
  async function getAMData(date) {
    if (!supabase) return null;
    
    const { data, error } = await supabase
      .from('cash_counts')
      .select('*')
      .eq('date', date)
      .single();
    
    if (error || !data || !data.am_total) return null;
    
    return {
      date: data.date,
      counter: data.am_counter,
      timestamp: data.am_timestamp,
      total: data.am_total,
      drawer1: {
        total: data.am_drawer1_total,
        skipped: data.am_drawer1_skip,
        skipReason: data.am_drawer1_skip_reason,
        counts: data.am_drawer1_data
      },
      drawer2: {
        total: data.am_drawer2_total,
        skipped: data.am_drawer2_skip,
        skipReason: data.am_drawer2_skip_reason,
        counts: data.am_drawer2_data
      },
      notes: data.am_notes
    };
  }
  
  async function sendEmailReport(data, calculations) {
    const templateParams = {
      to_email: EMAILJS_CONFIG.MANAGER_EMAIL,
      date: data.date,
      am_counter: currentAMData ? currentAMData.counter : 'N/A',
      counter: data.counter, // PM counter (was pm_counter)
      am_timestamp: currentAMData ? new Date(currentAMData.timestamp).toLocaleString() : 'N/A',
      pm_timestamp: new Date(data.timestamp).toLocaleString(),
      am_total: calculations.amTotal.toFixed(2),
      pm_total: calculations.pmTotal.toFixed(2),
      total_cash: calculations.pmTotal.toFixed(2), // Template expects total_cash
      drawer_change: calculations.drawerChange.toFixed(2),
      toast_sales: calculations.toastSales.toFixed(2),
      original_tips: calculations.cashTips.toFixed(2),
      discrepancy: Math.abs(calculations.discrepancy).toFixed(2),
      discrepancy_direction: calculations.discrepancy >= 0 ? 'Over' : 'Short',
      large_discrepancy_flag: Math.abs(calculations.discrepancy) > 10 ? ' ‚ö†Ô∏è LARGE DISCREPANCY!' : '',
      adjusted_tips: calculations.adjustedTips.toFixed(2),
      deposit_amount: Math.round(calculations.depositAmount).toString(),
      amount_to_keep: calculations.returnAmount.toFixed(2), // Template expects amount_to_keep
      drawer_over: calculations.drawerOver.toFixed(2),
      drawer_short: calculations.drawerShort.toFixed(2),
      am_notes: currentAMData ? (currentAMData.notes || '') : '',
      notes: data.notes || '', // Template expects notes (not pm_notes)
      has_discrepancy: calculations.discrepancy !== 0 ? 'true' : 'false',
      // Add drawer breakdown for comparison table
      has_am_comparison: currentAMData ? 'true' : 'false',
      am_drawer1_total: currentAMData ? currentAMData.drawer1.total.toFixed(2) : '0.00',
      am_drawer2_total: currentAMData ? currentAMData.drawer2.total.toFixed(2) : '0.00',
      pm_drawer1_total: data.drawer1Total.toFixed(2),
      pm_drawer2_total: data.drawer2Total.toFixed(2),
      am_grand_total: calculations.amTotal.toFixed(2),
      pm_grand_total: calculations.pmTotal.toFixed(2)
    };
    
    const response = await emailjs.send(
      EMAILJS_CONFIG.SERVICE_ID,
      EMAILJS_CONFIG.TEMPLATE_ID,
      templateParams
    );
    
    if (!response.status === 200) {
      throw new Error('Email send failed');
    }
  }
  
  async function generateReport() {
    const date = document.getElementById('reportDate').value;
    if (!date) {
      showMessage('Please select a date', 'error');
      return;
    }

    try {
      showLoading('Generating Report', 'Creating email report for management...');
      
      const amData = await getAMData(date);
      if (!amData) {
        throw new Error('No data found for this date');
      }
      
      // For report generation, we'll use stored PM data or create a basic report
      const { data: fullData } = await supabase
        .from('cash_counts')
        .select('*')
        .eq('date', date)
        .single();
      
      if (fullData && fullData.pm_total) {
        // Full day report
        const reportData = {
          date: date,
          counter: fullData.pm_counter,
          total: fullData.pm_total,
          toastSales: fullData.pm_toast_sales,
          cashTips: fullData.pm_cash_tips,
          amTotal: fullData.am_total,
          notes: fullData.pm_notes
        };
        
        const calculations = {
          amTotal: fullData.am_total,
          pmTotal: fullData.pm_total,
          drawerChange: fullData.pm_total - fullData.am_total,
          toastSales: fullData.pm_toast_sales,
          cashTips: fullData.pm_cash_tips,
          discrepancy: fullData.pm_discrepancy,
          adjustedTips: fullData.pm_adjusted_tips,
          depositAmount: fullData.pm_deposit_amount,
          returnAmount: fullData.pm_amount_to_keep,
          drawerOver: fullData.pm_drawer_over_amount || 0,
          drawerShort: fullData.pm_discrepancy < 0 ? Math.abs(fullData.pm_discrepancy) : 0
        };
        
        currentAMData = amData;
        await sendEmailReport(reportData, calculations);
      } else {
        throw new Error('Incomplete data for this date');
      }
      
      // Show elegant success screen
      showReportSuccess(date);
      
    } catch (error) {
      hideLoading();
      console.error('Report generation error:', error);
      showMessage(`Error: ${error.message}`, 'error');
    }
  }
  
  function resetForm(shift) {
    document.getElementById(`${shift}Counter`).value = '';
    document.getElementById(`${shift}Notes`).value = '';
    
    // Reset drawer skips
    document.getElementById(`${shift}Drawer1Skip`).checked = false;
    document.getElementById(`${shift}Drawer2Skip`).checked = false;
    toggleSkip(shift, 1);
    toggleSkip(shift, 2);
    
    // Reset all denomination inputs
    DENOMINATIONS.forEach((denom, index) => {
      document.getElementById(`${shift}D1Q${index}`).value = '0';
      document.getElementById(`${shift}D2Q${index}`).value = '0';
    });
    
    if (shift === 'pm') {
      document.getElementById('toastSales').value = '';
      document.getElementById('cashTips').value = '';
    }
    
    updateCalculations(shift, 1);
    updateCalculations(shift, 2);
  }
</script>
</body>
</html>