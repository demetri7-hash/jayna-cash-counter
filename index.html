<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, viewport-fit=cover">
  <title>Jayna Gyro Cash Counter</title>
  
  <link rel="apple-touch-icon" href="https://static.spotapps.co/website_images/ab_websites/229800_website_v1/logo.png">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#00A8E1">
  
  <style>
    /* Jayna Brand Design - Sky Blue & Grayscale */
    :root {
      --primary-blue: #00A8E1;
      --secondary-blue: #0094D6;
      --light-blue: #E3F4FC;
      --accent-blue: #0081C6;
      --gray-900: #212121;
      --gray-700: #424242;
      --gray-600: #616161;
      --gray-500: #757575;
      --gray-400: #BDBDBD;
      --gray-300: #E0E0E0;
      --gray-100: #F5F5F5;
      --success: #00C853;
      --warning: #FFB300;
      --error: #D32F2F;
      --white: #FFFFFF;
      --blue-bg: #dbeafe;
      --blue-text: #1e40af;
      --success-bg: #d1fae5;
      --success-text: #065f46;
      --success-border: #059669;
      --warning-bg: #fef3c7;
      --warning-text: #92400e;
      --warning-border: #f59e0b;
      --error-bg: #fee2e2;
      --error-text: #991b1b;
      --error-border: #dc2626;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body {
      font-family: 'Aptos', 'Segoe UI Variable', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      background: var(--white); /* White background to blend with Google Sites header */
      min-height: 100vh;
      padding: 0;
      overflow-x: hidden;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
      background: var(--white);
      border-radius: 0;
      overflow: visible;
      box-shadow: none; /* Remove shadow for seamless Google Sites embed */
      min-height: auto;
      max-height: none;
    }
    .header {
      background: var(--white);
      color: var(--gray-900);
      text-align: center;
      padding: 12px;
      border-radius: 0;
      border-bottom: 1px solid var(--gray-300);
    }
    .header h1 { font-size: 18px; font-weight: 700; margin-bottom: 2px; letter-spacing: 1.5px; text-transform: uppercase; }
    .header p { opacity: 0.7; font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }
    /* Mobile-First Responsive Design */
    .content {
      padding: 12px;
      /* Google Sites full page embed optimization */
      max-height: none;
      overflow: visible;
    }
    .main-menu { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px; }
    .secondary-links { display: flex; flex-wrap: wrap; gap: 12px; justify-content: center; margin-bottom: 20px; font-size: 11px; }
    .secondary-links a { color: var(--gray-700); text-decoration: underline; cursor: pointer; transition: color 0.15s ease; }
    .secondary-links a:hover { color: var(--gray-900); }
    .menu-btn {
      padding: 16px 12px;
      border: 2px solid var(--gray-300);
      border-radius: 0;
      background: var(--gray-100);
      font-size: 11px;
      font-weight: 700;
      color: var(--gray-900);
      cursor: pointer;
      transition: all 0.15s ease;
      text-align: center;
      min-height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      text-transform: uppercase;
      letter-spacing: 1.2px;
    }
    .menu-btn:hover {
      background: var(--gray-300);
      color: var(--gray-900);
      border-color: var(--gray-400);
      transform: translateY(-1px);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
    }
    .menu-btn.active {
      border-color: var(--gray-400);
      background: var(--gray-300);
      color: var(--gray-900);
      transform: translateY(-1px);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
    }
    .menu-btn.primary {
      background: var(--white);
      color: var(--gray-700);
      border-color: var(--gray-300);
    }
    .menu-btn.primary:hover {
      background: var(--gray-100);
      border-color: var(--gray-400);
    }
    .form-section { 
      display: none; 
      /* Ensure sections don't get cut off */
      min-height: auto;
      overflow: visible;
    }
    .form-section.active {
      display: block;
      /* Force visibility in Google Sites */
      position: relative;
      z-index: 1;
    }
    .form-group { margin-bottom: 12px; }
    .form-group label {
      display: block;
      margin-bottom: 4px;
      font-weight: 700;
      font-size: 10px;
      color: var(--gray-700);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    /* Enhanced Mobile-Friendly Inputs */
    .form-input, .form-select {
      width: 100%;
      padding: 12px 14px;
      border: 1px solid var(--gray-300);
      border-radius: 0;
      font-size: 14px;
      min-height: 44px;
      box-sizing: border-box;
      -webkit-appearance: none;
      appearance: none;
      transition: all 0.15s ease;
      background: var(--white);
      color: var(--gray-900);
    }
    .form-input:focus, .form-select:focus {
      outline: none;
      border-color: var(--primary-blue);
      box-shadow: 0 0 0 2px rgba(0, 217, 217, 0.15);
      background: var(--white);
    }
    
    /* Number inputs with mobile optimization */
    input[type="number"] {
      -webkit-appearance: none;
      -moz-appearance: textfield;
      appearance: none;
      /* Remove number input arrows */
    }
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    input, select, textarea, button {
      font-size: 16px !important;
    }

    .drawer-section {
      margin: 20px 0;
      border: 2px solid var(--gray-300);
      border-radius: 0;
      overflow: hidden;
    }
    .drawer-header {
      background: var(--light-blue);
      padding: 15px 20px;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 15px;
      color: var(--primary-blue);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .skip-toggle {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 16px;
      color: var(--gray-500);
    }
    .skip-toggle input[type="checkbox"] { width: 20px; height: 20px; }
    .drawer-content { padding: 20px; }
    .denom-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 0;
      border-bottom: 1px solid var(--gray-300);
    }
    .denom-row:last-child { border-bottom: none; }
    .denom-label { font-weight: 500; font-size: 18px; color: var(--gray-700); }
    .denom-value { font-size: 16px; color: var(--gray-500); margin-top: 4px; }

    /* Mobile-Optimized Quantity Inputs */
    .qty-input {
      width: 100px;
      height: 56px;
      text-align: center;
      border: 2px solid var(--gray-300);
      border-radius: 0;
      font-size: 20px;
      font-weight: 500;
      color: var(--gray-700);
      -webkit-appearance: none;
      -moz-appearance: textfield;
      appearance: none;
      transition: all 0.2s ease;
      background: var(--white);
    }
    .qty-input:focus {
      outline: none;
      border-color: var(--primary-blue);
      box-shadow: 0 0 0 3px rgba(44, 95, 141, 0.1);
    }
    /* Remove number arrows */
    .qty-input::-webkit-outer-spin-button,
    .qty-input::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    
    /* Disabled denomination inputs */
    .qty-input:disabled {
      background-color: var(--gray-300);
      color: var(--gray-500);
      border-color: var(--gray-300);
      cursor: not-allowed;
    }

    .denom-row.disabled {
      opacity: 0.5;
    }

    .drawer-total {
      margin-top: 15px;
      padding: 15px;
      background: var(--light-blue);
      border-radius: 0;
      text-align: center;
      font-size: 18px;
      font-weight: 600;
      color: var(--primary-blue);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .grand-total {
      background: linear-gradient(135deg, var(--primary-blue) 0%, var(--secondary-blue) 100%);
      color: var(--white);
      padding: 20px;
      border-radius: 0;
      text-align: center;
      margin: 20px 0;
      box-shadow: 0 4px 12px rgba(44, 95, 141, 0.2);
    }
    .grand-total h3 { font-size: 18px; margin-bottom: 8px; font-weight: 600; opacity: 0.9; text-transform: uppercase; letter-spacing: 0.5px; }
    .grand-total .amount { font-size: 36px; font-weight: 600; }
    .notes-area {
      width: 100%;
      min-height: 100px;
      padding: 18px;
      border: 2px solid var(--gray-300);
      border-radius: 0;
      font-size: 16px;
      resize: vertical;
      box-sizing: border-box;
      transition: all 0.2s ease;
    }
    .notes-area:focus {
      outline: none;
      border-color: var(--primary-blue);
      box-shadow: 0 0 0 3px rgba(44, 95, 141, 0.1);
    }
    .submit-btn {
      padding: 14px 20px;
      background: var(--gray-100);
      color: var(--gray-900);
      border: none;
      border-radius: 0;
      font-size: 12px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.15s ease;
      min-height: 48px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
      text-transform: uppercase;
      letter-spacing: 1.2px;
      border: 2px solid var(--gray-300);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      white-space: nowrap;
    }
    .submit-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.12);
      background: var(--gray-300);
    }
    .submit-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
      background: var(--gray-300);
      color: var(--gray-500);
    }
    .am-total-display {
      background: var(--light-blue);
      padding: 20px;
      border-radius: 0;
      margin: 20px 0;
      border: 2px solid rgba(44, 95, 141, 0.1);
    }
    .am-total-display h4 { margin-bottom: 8px; color: var(--primary-blue); font-size: 16px; font-weight: 500; }
    .am-total-display .amount { font-size: 28px; font-weight: 600; color: var(--primary-blue); }

    /* Enhanced Currency Inputs */
    .currency-input {
      width: 100%;
      padding: 20px;
      border: 2px solid var(--gray-300);
      border-radius: 0;
      font-size: 22px;
      text-align: center;
      min-height: 60px;
      box-sizing: border-box;
      -webkit-appearance: none;
      -moz-appearance: textfield;
      appearance: none;
      transition: all 0.2s ease;
      background: var(--white);
      color: var(--gray-700);
    }
    .currency-input:focus {
      outline: none;
      border-color: var(--primary-blue);
      box-shadow: 0 0 0 3px rgba(44, 95, 141, 0.1);
    }
    .currency-input::-webkit-outer-spin-button,
    .currency-input::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    .confirmation-screen { text-align: center; padding: 40px 20px; }
    .confirmation-screen h2 { color: var(--success); margin-bottom: 30px; font-size: 32px; font-weight: 600; }
    .deposit-instruction {
      background: linear-gradient(135deg, var(--success) 0%, #4A8C63 100%);
      color: var(--white);
      padding: 30px;
      border-radius: 0;
      margin: 25px 0;
      font-size: 24px;
      font-weight: 500;
      box-shadow: 0 4px 12px rgba(95, 167, 119, 0.2);
    }
    .return-instruction {
      background: linear-gradient(135deg, var(--warning) 0%, #C69563 100%);
      color: var(--white);
      padding: 30px;
      border-radius: 0;
      margin: 25px 0;
      font-size: 24px;
      font-weight: 500;
      box-shadow: 0 4px 12px rgba(212, 165, 116, 0.2);
    }
    .thank-you { font-size: 22px; color: var(--success); margin: 30px 0; font-weight: 500; }
    .confirm-btn {
      background: linear-gradient(135deg, var(--success) 0%, #4A8C63 100%);
      margin-top: 30px;
    }
    .loading { text-align: center; padding: 40px; }
    .loading-spinner {
      width: 60px;
      height: 60px;
      border: 6px solid var(--gray-300);
      border-top: 6px solid var(--primary-blue);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .message {
      padding: 18px;
      border-radius: 0;
      margin: 20px 0;
      text-align: center;
      font-size: 15px;
      font-weight: 500;
      letter-spacing: 0.3px;
    }
    .message.success {
      background: #E8F5EC;
      color: #2D5F3F;
      border: 2px solid var(--success);
    }
    .message.error {
      background: #F8E6E7;
      color: #6B3638;
      border: 2px solid var(--error);
    }
    .message.info {
      background: var(--light-blue);
      color: var(--primary-blue);
      border: 2px solid var(--secondary-blue);
    }

    /* Typography - Headers */
    h2, h3, h4, h5, h6 {
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 600;
    }
    h2 { font-size: 22px; }
    h3 { font-size: 19px; }
    h4 { font-size: 16px; }
    h5 { font-size: 14px; }
    h6 { font-size: 12px; }

    /* Tip Pool Calculator Styles */
    .cash-needed { color: var(--error); font-weight: 600; }
    .cash-surplus { color: var(--success); font-weight: 600; }
    .hidden { display: none; }
    .skip-content { padding: 25px; }
    .skip-reason {
      width: 100%;
      padding: 18px;
      border: 2px solid var(--gray-300);
      border-radius: 0;
      font-size: 16px;
      min-height: 56px;
      box-sizing: border-box;
      transition: all 0.2s ease;
    }
    .skip-reason:focus {
      outline: none;
      border-color: var(--primary-blue);
      box-shadow: 0 0 0 3px rgba(44, 95, 141, 0.1);
    }
    
    /* Mobile responsive adjustments */
    @media (max-width: 768px) {
      .container { margin: 0; border-radius: 0; }
      .header { padding: 20px; }
      .header h1 { font-size: 24px; }
      .content { padding: 15px; }
      .main-menu { gap: 12px; }
      .menu-btn { padding: 25px 15px; font-size: 16px; min-height: 70px; }
      .denom-row { flex-direction: column; align-items: flex-start; gap: 12px; padding: 20px 0; }
      .qty-input { width: 120px; margin-top: 8px; }
      .grand-total .amount { font-size: 32px; }
      .confirmation-screen h2 { font-size: 28px; }
      .deposit-instruction, .return-instruction { font-size: 20px; padding: 25px; }
    }
    
    @media (max-width: 480px) {
      .header h1 { font-size: 20px; }
      .main-menu { grid-template-columns: 1fr; gap: 10px; }
      .main-menu.show-report { grid-template-columns: 1fr; }
      .menu-btn { padding: 20px 15px; min-height: 60px; }
      .secondary-links { font-size: 10px; gap: 10px; }
      .denom-label { font-size: 16px; }
      .qty-input { width: 100px; height: 50px; font-size: 18px; }
      .grand-total .amount { font-size: 28px; }
      .deposit-instruction, .return-instruction { font-size: 18px; padding: 20px; }
    }
    
    /* Google Sites Full Page Embed Optimizations */
    @media screen {
      html {
        /* Force proper viewport handling in Google Sites */
        height: auto !important;
        min-height: 100% !important;
        overflow-y: auto !important;
      }
      
      body {
        /* Ensure body can scroll properly in Google Sites iframe */
        height: auto !important;
        min-height: 100% !important;
        position: relative !important;
        overflow-y: auto !important;
        padding-bottom: 50px !important; /* Extra space at bottom */
      }
      
      .container {
        /* Ensure container doesn't get viewport-locked */
        position: relative !important;
        height: auto !important;
        min-height: auto !important;
        max-height: none !important;
        overflow: visible !important;
        margin-bottom: 50px !important; /* Extra bottom margin */
      }
      
      .submit-btn {
        /* Ensure submit buttons are always accessible */
        position: relative !important;
        z-index: 10 !important;
        margin-bottom: 30px !important;
      }
      
      /* Force visibility of bottom elements in Google Sites */
      .form-section:last-child,
      .form-section .submit-btn:last-child {
        margin-bottom: 100px !important;
      }
    }
    
    /* Elegant Loading Overlay */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      z-index: 9999;
      display: flex;
      justify-content: center;
      align-items: center;
      transition: opacity 0.3s ease;
    }
    .loading-overlay.hidden {
      display: none;
    }
    .loading-content {
      text-align: center;
      padding: 40px;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 0;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    .loading-spinner-elegant {
      width: 60px;
      height: 60px;
      border: 4px solid rgba(102, 126, 234, 0.1);
      border-top: 4px solid #667eea;
      border-radius: 50%;
      animation: spin-elegant 1.2s linear infinite;
      margin: 0 auto 20px;
    }
    @keyframes spin-elegant {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .loading-content h3 {
      margin: 0 0 10px 0;
      font-size: 24px;
      color: #333;
      font-weight: 600;
    }
    .loading-content p {
      margin: 0;
      font-size: 16px;
      color: #666;
      opacity: 0.8;
    }
    
    /* Success Screens */
    .success-screen {
      text-align: center;
      padding: 40px 20px;
      max-width: 600px;
      margin: 0 auto;
    }
    .success-icon {
      font-size: 80px;
      margin-bottom: 20px;
      animation: success-bounce 0.6s ease;
    }
    @keyframes success-bounce {
      0% { transform: scale(0.3); opacity: 0; }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); opacity: 1; }
    }
    .success-screen h2 {
      color: #28a745;
      margin-bottom: 15px;
      font-size: 32px;
      font-weight: 700;
    }
    .success-message {
      font-size: 18px;
      color: #666;
      margin-bottom: 30px;
      line-height: 1.5;
    }
    .success-details {
      background: #f8f9fa;
      border-radius: 0;
      padding: 25px;
      margin: 25px 0;
      border-left: 4px solid #28a745;
    }
    .detail-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      font-size: 16px;
    }
    .detail-row:not(:last-child) {
      border-bottom: 1px solid #e9ecef;
    }
    .detail-row span:first-child {
      color: #666;
      font-weight: 500;
    }
    .detail-row span:last-child {
      color: #333;
      font-weight: 600;
    }
    .success-btn {
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
      margin-top: 30px;
      font-size: 18px;
      padding: 20px 40px;
      border-radius: 0;
      transition: all 0.3s ease;
    }
    .success-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(40, 167, 69, 0.3);
    }
  </style>
  
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
  <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
  <!-- Tip Pool Calculator Dependencies -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

  <!-- OCR Dependencies -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>
    // Configure PDF.js worker
    if (typeof pdfjsLib !== 'undefined') {
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    }
  </script>
</head>
<body>
  <!-- Loading Overlay (consolidated) -->
  <div id="loadingOverlay" style="
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    z-index: 9999;
    justify-content: center;
    align-items: center;
  ">
    <div style="
      text-align: center;
      color: white;
    ">
      <div class="spinner" style="
        border: 8px solid #f3f3f3;
        border-top: 8px solid #4CAF50;
        border-radius: 50%;
        width: 60px;
        height: 60px;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
      "></div>
      <h3 id="loadingTitle" style="
        font-size: 18px;
        font-weight: bold;
        margin-bottom: 10px;
      ">Fetching Toast data...</h3>
      <p id="loadingMessage" style="
        font-size: 14px;
        color: #ccc;
      ">This may take up to 2 minutes</p>
    </div>
  </div>

  <style>
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>

  <div class="container">
    <div class="header">
      <img src="jayna-logo.png" alt="Jayna Gyro Logo" style="width: 80px; height: 80px; margin-bottom: 12px;">
      <h1 style="margin-bottom: 4px;">JAYNA GYRO</h1>
      <h2 style="font-size: 18px; font-weight: 600; margin-bottom: 4px; letter-spacing: 1.5px;">INTERNAL FUNCTION APP</h2>
      <p style="font-size: 11px; font-weight: 500; letter-spacing: 1px; margin-bottom: 8px;">FOR AUTHORIZED USE ONLY</p>
      <p style="opacity: 0.7;">App created by Demetri Gregorakis</p>
      <div style="font-size: 12px; color: #666; margin-top: 5px;">
        <span id="sessionStatus"></span>
        <button id="logoutBtn" onclick="logoutManager()" style="
          background: #f44336; 
          color: white; 
          border: none; 
          padding: 2px 8px; 
          border-radius: 0; 
          font-size: 10px; 
          margin-left: 10px;
          cursor: pointer;
          display: none;
        ">Logout Manager</button>
      </div>
    </div>
    
    <div class="content">
      <div id="messageArea"></div>
      
      <!-- Main Menu -->
      <div id="mainMenu" class="main-menu">
        <button class="menu-btn primary" onclick="startSmartCashFlow()">Cash</button>
        <button class="menu-btn" onclick="startOrderingSystem()" style="background: var(--gray-700) !important; color: white !important; border-color: var(--gray-700) !important;">Orders & Prep</button>
        <a href="foh-checklists.html" class="menu-btn primary" style="text-decoration: none;">FOH</a>
        <button class="menu-btn" onclick="" style="background: var(--gray-700) !important; color: white !important; border-color: var(--gray-700) !important; cursor: default;">BOH</button>
      </div>

      <!-- Secondary Links -->
      <div class="secondary-links">
        <a onclick="requirePasswordFor('Generate Reports', showReports)">Generate Report</a>
        <span style="color: var(--gray-400);">|</span>
        <a onclick="requirePasswordFor('Tip Pool Calculator', showTipPool)">Tip Pool</a>
        <span style="color: var(--gray-400);">|</span>
        <a onclick="requirePasswordFor('Weekly Cashbox Count', showCashbox)">Weekly Cashbox</a>
        <span style="color: var(--gray-400);">|</span>
        <a onclick="requirePasswordFor('Manager Dashboard', () => window.location.href='manager.html')">Manager</a>
        <span style="color: var(--gray-400);">|</span>
        <a onclick="requirePasswordFor('Catering Operations', accessCatering)">Catering</a>
      </div>
      
      <!-- AM Count Form -->
      <div id="amForm" class="form-section">
        <h2 style="margin-bottom: 20px; color: #1e3c72;">Morning Cash Count</h2>
        
        <div class="form-group">
          <label for="amDate">Date:</label>
          <input type="date" id="amDate" class="form-input" required>
        </div>
        
        <div class="form-group">
          <label for="amCounter">Counted by:</label>
          <select id="amCounter" class="form-select" onchange="toggleDenominationInputs('am')" required>
            <option value="">Choose Name</option>
            <option value="Demetri Gregorakis">Demetri Gregorakis</option>
            <option value="Ahmet Can Guler">Ahmet Can Guler</option>
            <option value="Bryan Cox">Bryan Cox</option>
            <option value="Kayla Mccullough">Kayla Mccullough</option>
            <option value="Dilan Uzum">Dilan Uzum</option>
          </select>
        </div>
        
        <!-- Drawer 1 -->
        <div class="drawer-section">
          <div class="drawer-header">
            <span>Drawer 1</span>
            <label class="skip-toggle">
              <input type="checkbox" id="amDrawer1Skip" onchange="toggleSkip('am', 1)">
              Skip Drawer
            </label>
          </div>
          <div id="amDrawer1Content" class="drawer-content">
            <div id="amDrawer1Denoms"></div>
            <div class="drawer-total" id="amDrawer1Total">$0.00</div>
          </div>
          <div id="amDrawer1SkipContent" class="skip-content hidden">
            <input type="text" class="skip-reason" id="amDrawer1Reason" placeholder="Reason for skipping drawer 1">
          </div>
        </div>
        
        <!-- Drawer 2 -->
        <div class="drawer-section">
          <div class="drawer-header">
            <span>Drawer 2</span>
            <label class="skip-toggle">
              <input type="checkbox" id="amDrawer2Skip" onchange="toggleSkip('am', 2)">
              Skip Drawer
            </label>
          </div>
          <div id="amDrawer2Content" class="drawer-content">
            <div id="amDrawer2Denoms"></div>
            <div class="drawer-total" id="amDrawer2Total">$0.00</div>
          </div>
          <div id="amDrawer2SkipContent" class="skip-content hidden">
            <input type="text" class="skip-reason" id="amDrawer2Reason" placeholder="Reason for skipping drawer 2">
          </div>
        </div>
        
        <div class="grand-total">
          <h3>Total Cash Count</h3>
          <div class="amount" id="amGrandTotal">$0.00</div>
        </div>
        
        <div class="form-group">
          <label for="amNotes">Notes (Optional):</label>
          <textarea id="amNotes" class="notes-area" placeholder="Any notes for the PM shift..."></textarea>
        </div>
        
        <button class="submit-btn" onclick="submitAM()">Submit AM Count</button>
        <button class="submit-btn" onclick="goHome()" style="margin-top: 10px;">Back to Menu</button>
      </div>
      
      <!-- PM Count Form -->
      <div id="pmForm" class="form-section">
        <h2 style="margin-bottom: 20px; color: #1e3c72;">Evening Cash Close</h2>
        
        <div class="form-group">
          <label for="pmDate">Date:</label>
          <input type="date" id="pmDate" class="form-input" required>
        </div>
        
        <div class="form-group">
          <label for="pmCounter">Counted by:</label>
          <select id="pmCounter" class="form-select" onchange="toggleDenominationInputs('pm')" required>
            <option value="">Choose Name</option>
            <option value="Demetri Gregorakis">Demetri Gregorakis</option>
            <option value="Ahmet Can Guler">Ahmet Can Guler</option>
            <option value="Bryan Cox">Bryan Cox</option>
            <option value="Kayla Mccullough">Kayla Mccullough</option>
            <option value="Dilan Uzum">Dilan Uzum</option>
          </select>
        </div>
        
        <!-- AM Total Display -->
        <div id="amTotalDisplay" class="am-total-display">
          <h4>Morning Count Information:</h4>
          <div style="display: flex; justify-content: space-between; margin: 10px 0; font-size: 14px;">
            <span><strong>Counted by:</strong> <span id="amCounterName">Loading...</span></span>
            <span><strong>Time:</strong> <span id="amCountTime">Loading...</span></span>
          </div>
          <div style="text-align: center; margin: 15px 0;">
            <strong>Starting Amount:</strong>
            <div class="amount" id="pmAmTotal" style="font-size: 28px; margin: 5px 0;">Loading...</div>
          </div>
          <div id="amNotesDisplay" style="background: #fff3cd; padding: 12px; border-radius: 0; margin-top: 15px; border-left: 4px solid #ffc107; display: none;">
            <strong style="color: #856404;">Morning Notes:</strong>
            <div id="amNotes" style="margin-top: 5px; color: #856404;"></div>
          </div>
        </div>
        
        <!-- Drawer 1 -->
        <div class="drawer-section">
          <div class="drawer-header">
            <span>Drawer 1</span>
            <label class="skip-toggle">
              <input type="checkbox" id="pmDrawer1Skip" onchange="toggleSkip('pm', 1)">
              Skip Drawer
            </label>
          </div>
          <div id="pmDrawer1Content" class="drawer-content">
            <div id="pmDrawer1Denoms"></div>
            <div class="drawer-total" id="pmDrawer1Total">$0.00</div>
          </div>
          <div id="pmDrawer1SkipContent" class="skip-content hidden">
            <input type="text" class="skip-reason" id="pmDrawer1Reason" placeholder="Reason for skipping drawer 1">
          </div>
        </div>
        
        <!-- Drawer 2 -->
        <div class="drawer-section">
          <div class="drawer-header">
            <span>Drawer 2</span>
            <label class="skip-toggle">
              <input type="checkbox" id="pmDrawer2Skip" onchange="toggleSkip('pm', 2)">
              Skip Drawer
            </label>
          </div>
          <div id="pmDrawer2Content" class="drawer-content">
            <div id="pmDrawer2Denoms"></div>
            <div class="drawer-total" id="pmDrawer2Total">$0.00</div>
          </div>
          <div id="pmDrawer2SkipContent" class="skip-content hidden">
            <input type="text" class="skip-reason" id="pmDrawer2Reason" placeholder="Reason for skipping drawer 2">
          </div>
        </div>
        
        <div class="grand-total">
          <h3>Total Cash Count</h3>
          <div class="amount" id="pmGrandTotal">$0.00</div>
        </div>
        
        <div class="form-group">
          <label for="toastSales">Toast Cash Sales (Auto-Calculated):</label>
          
          <!-- Auto-calculated display section -->
          <div style="background: var(--gray-100); border: 2px solid var(--gray-300); border-radius: 0; padding: 20px; margin-bottom: 10px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
              <span style="font-weight: 700; color: var(--gray-900); font-size: 16px;">Auto-Fetched from Toast API</span>
              <span style="background: var(--gray-100); color: var(--gray-900); padding: 6px 12px; border-radius: 0; font-size: 12px; font-weight: 600; border: 2px solid var(--gray-300);">
                LIVE DATA
              </span>
            </div>

            <div style="text-align: center; margin: 15px 0;">
              <div style="font-size: 32px; font-weight: bold; color: var(--gray-900); margin-bottom: 8px;" id="autoToastAmount">Loading...</div>
              <div style="font-size: 14px; color: var(--gray-700); font-weight: 500;" id="autoToastDetails">Fetching today's cash sales automatically...</div>
            </div>

            <div style="background: var(--white); padding: 10px; border-radius: 0; font-size: 13px; color: var(--gray-700); border: 1px solid var(--gray-300);">
              <strong>Fully Automated:</strong> This amount is automatically calculated from today's Toast POS cash transactions. No manual entry required.
            </div>
          </div>
          
          <!-- Hidden field for form processing -->
          <input type="hidden" id="toastSales" value="0">
        </div>
        
        <!-- Discrepancy Validation Section -->
        <div id="discrepancySection" class="form-group" style="display: none;">
          <label>Cash Count vs Toast Sales Validation:</label>
          <div id="discrepancyDisplay" style="border-radius: 0; padding: 20px; margin-bottom: 10px;">
            <!-- Dynamic content will be inserted here -->
          </div>
        </div>
        
        <div class="form-group">
          <label for="cashTips">Cash Tips (whole number):</label>
          <input type="number" id="cashTips" class="currency-input" placeholder="0" step="1" min="0" inputmode="numeric" pattern="[0-9]*" onfocus="this.select()">
        </div>
        
        <div class="form-group">
          <label for="pmNotes">Notes (Optional):</label>
          <textarea id="pmNotes" class="notes-area" placeholder="Any notes about the day..."></textarea>
        </div>
        
        <button class="submit-btn" onclick="submitPM()">Submit PM Close</button>
        <button class="submit-btn" onclick="goHome()" style="margin-top: 10px;">Back to Menu</button>
      </div>

      <!-- AM Success Screen -->
      <div id="amSuccessScreen" class="form-section">
        <div class="success-screen">
          <div class="success-icon"></div>
          <h2>AM Count Submitted!</h2>
          <p class="success-message">Your morning cash count has been successfully recorded and stored.</p>
          <div class="success-details">
            <div class="detail-row">
              <span>Total Counted:</span>
              <span id="amSuccessTotal">$0.00</span>
            </div>
            <div class="detail-row">
              <span>Time Submitted:</span>
              <span id="amSuccessTime">--</span>
            </div>
          </div>
          <button class="submit-btn success-btn" onclick="goHome()">Return to Menu</button>
        </div>
      </div>

      <!-- PM Success Screen -->
      <div id="pmSuccessScreen" class="form-section">
        <div class="success-screen">
          <div class="success-icon"></div>
          <h2>PM Close Completed!</h2>
          <p class="success-message">Evening close successful! Report sent to management.</p>
          
          <div class="deposit-instruction">
            DEPOSIT <span id="depositAmount">$0</span> INTO ENVELOPE
          </div>
          
          <div class="return-instruction">
            RETURN <span id="returnAmount">$0.00</span> TO CASH BOX AND LOCK IN SAFE
          </div>
          
          <button class="submit-btn success-btn" onclick="goHome()">Confirm and Close</button>
        </div>
      </div>

      <!-- Report Success Screen -->
      <div id="reportSuccessScreen" class="form-section">
        <div class="success-screen">
          <div class="success-icon"></div>
          <h2>Report Sent Successfully!</h2>
          <p class="success-message">Daily cash report has been emailed to management.</p>
          <div class="success-details">
            <div class="detail-row">
              <span>Report Date:</span>
              <span id="reportSuccessDate">--</span>
            </div>
            <div class="detail-row">
              <span>Sent At:</span>
              <span id="reportSuccessTime">--</span>
            </div>
          </div>
          <button class="submit-btn success-btn" onclick="goHome()">Return to Menu</button>
        </div>
      </div>
      
      <!-- Reports Section -->
      <div id="reportsForm" class="form-section">
        <h2 style="margin-bottom: 20px; color: #1e3c72;">Historical Reports</h2>
        
        <div style="background: #f8f9fa; padding: 15px; border-radius: 0; margin-bottom: 20px; border-left: 4px solid #1e3c72;">
          <h4 style="margin: 0 0 10px 0; color: #1e3c72;">Business Intelligence Reports</h4>
          <p style="margin: 5px 0; font-size: 14px;">Generate comprehensive reports from your saved weekly data including tip pools, cash reconciliation, and employee performance.</p>
          <p style="margin: 5px 0; font-size: 12px; color: #666;"><strong>Note:</strong> Historical reports can only show data from dates that have been processed in weekly combined reports. Generate a weekly report first to save data to the database.</p>
        </div>
        
        <div class="form-group">
          <label>Report Type:</label>
          <div style="display: flex; gap: 15px; margin: 10px 0;">
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="radio" name="reportType" value="single" checked onchange="toggleReportType()">
              <span>Single Day Report</span>
            </label>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="radio" name="reportType" value="weekly" onchange="toggleReportType()">
              <span>Weekly Report (7 days)</span>
            </label>
          </div>
        </div>
        
        <div id="singleDateGroup" class="form-group">
          <label for="reportDate">Select Date:</label>
          <input type="date" id="reportDate" class="form-input" required>
          <div style="margin-top: 5px; font-size: 12px; color: #666;">
            Generate a detailed report for a specific day including cash reconciliation and employee data.
          </div>
        </div>
        
        <div id="weeklyRangeGroup" class="form-group" style="display: none;">
          <label for="savedWeeksDropdown">Select Saved Weekly Report:</label>
          <select id="savedWeeksDropdown" class="form-input" required>
            <option value="">Loading saved reports...</option>
          </select>
          <div style="margin-top: 10px; font-size: 14px; color: #666;">
            <strong>Saved Weekly Reports:</strong> Select from previously generated weekly reports to view the complete summary.
          </div>
        </div>
        
        <button type="button" class="submit-btn" onclick="generateHistoricalReport()" style="background: #1e3c72;">Generate Historical Report</button>
        
        <button class="submit-btn" onclick="goHome()" style="margin-top: 10px;">Back to Menu</button>
        
        <!-- Report Display Area -->
        <div id="reportDisplay" style="display: none; margin-top: 30px; padding: 20px; border: 2px solid #1e3c72; border-radius: 0; background: #f8f9fa;">
          <div id="reportContent"></div>
        </div>
      </div>
      
      <!-- Tip Pool Calculator Section -->
      <div id="tipPoolForm" class="form-section">
        <h2 style="margin-bottom: 20px; color: #1e3c72;">Tip Pool Calculator</h2>
        
        <div style="background: #f8f9fa; padding: 15px; border-radius: 0; margin-bottom: 20px; border-left: 4px solid #007bff;">
          <h4 style="margin: 0 0 10px 0; color: #007bff;">Quick Start:</h4>
          <p style="margin: 5px 0; font-size: 14px;">1. Select date range → data auto-fetches from Toast</p>
          <p style="margin: 5px 0; font-size: 14px;">2. Enter Real Envelope Deposit</p>
          <p style="margin: 5px 0; font-size: 14px;">3. Enter EZ Cater tips + your name</p>
          <p style="margin: 5px 0; font-size: 14px;">4. Click Calculate</p>
          <p style="margin: 5px 0; font-size: 12px; color: #666;"><em>TDS Driver tips auto-calculate from your saved PM data</em></p>
        </div>
        
        <!-- Optional manual file uploads (data auto-fetches from Toast API) -->
        <details style="margin: 15px 0; padding: 10px; background: #f8f9fa; border-radius: 0;">
          <summary style="cursor: pointer; font-size: 13px; color: #666; font-weight: 600;">
            Manual File Upload (Optional - Click to expand)
          </summary>
          <div style="margin-top: 15px;">
            <div class="form-group" style="margin-bottom: 10px;">
              <label for="laborFile" style="font-size: 12px;">Labor Summary CSV File:</label>
              <input type="file" id="laborFile" class="form-input" accept=".csv" style="padding: 8px;">
            </div>

            <div class="form-group" style="margin-bottom: 0;">
              <label for="salesFile" style="font-size: 12px;">Sales Summary ZIP File:</label>
              <input type="file" id="salesFile" class="form-input" accept=".zip" style="padding: 8px;">
            </div>
          </div>
        </details>

        <div class="form-group">
          <label for="tipPoolDateRange">Date Range for Tip Pool:</label>
          <div style="display: flex; gap: 15px; margin: 10px 0;">
            <div style="flex: 1;">
              <label for="tipPoolStartDate" style="font-size: 12px; color: #666;">Start Date:</label>
              <input type="date" id="tipPoolStartDate" class="form-input" onchange="calculateCashTips()">
            </div>
            <div style="flex: 1;">
              <label for="tipPoolEndDate" style="font-size: 12px; color: #666;">End Date:</label>
              <input type="date" id="tipPoolEndDate" class="form-input" onchange="calculateCashTips(); autoFetchOnDateChange()">
            </div>
          </div>
          <div id="autoFetchStatus" style="font-size: 11px; color: #666; margin-top: 5px; min-height: 16px;">
            <!-- Auto-fetch status will appear here -->
          </div>
        </div>
        
        <div class="form-group">
          <label for="realEnvelopeDeposit">Real Envelope Deposit ($):</label>
          <input type="number" id="realEnvelopeDeposit" class="form-input" step="1" placeholder="e.g., 550" inputmode="numeric" pattern="[0-9]*" onchange="calculateCashTips()">
          <div style="font-size: 12px; color: #666; margin-top: 5px;">
            Actual cash amount counted from envelopes
          </div>
        </div>
        
        <div class="form-group">
          <label for="calculatedCashTips">Cash Tips (Auto-Calculated):</label>
          <input type="number" id="calculatedCashTips" class="form-input" step="0.01" inputmode="decimal" readonly style="background: #f8f9fa; color: #666;">
          <div style="font-size: 12px; color: #007bff; margin-top: 5px;">
            <strong>Formula:</strong> Real Envelope Deposit - Toast Cash Sales (from saved PM data)
          </div>
        </div>
        
        <div class="form-group">
          <label for="ezcaterTips">EZ Cater Tips for the Week ($):</label>
          <input type="number" id="ezcaterTips" class="form-input" step="0.01" placeholder="e.g., 40.00" inputmode="decimal">
        </div>
        
        <div class="form-group">
          <label for="tdsDriverTips">TDS Driver Tips for the Week ($):</label>
          <input type="number" id="tdsDriverTips" class="form-input" step="0.01" inputmode="decimal" readonly style="background: #f8f9fa; color: #666;">
          <div id="tdsAutoFetchStatus" style="font-size: 14px; color: #666; margin-top: 5px;">Auto-calculated from Toast API when you calculate tip pool</div>
        </div>

        <div class="form-group">
          <label for="manualLaborCost">Total Labor Cost from Toast Web (Optional):</label>
          <input type="number" id="manualLaborCost" class="form-input" step="0.01" placeholder="e.g., 9637.82" inputmode="decimal">
          <div style="font-size: 12px; color: #666; margin-top: 5px;">
            <strong>Why?</strong> CA double-time rules make API labor cost inaccurate. Enter the "Total Cost" from Toast web labor report for exact calculations.
          </div>
          <div style="font-size: 11px; color: #999; margin-top: 3px;">
            If left blank, will use API data (may be $100-150 low due to double-time hours)
          </div>
        </div>

        <div class="form-group">
          <label for="manualNetSales">Manual Net Sales (Optional):</label>
          <input type="number" id="manualNetSales" class="form-input" step="0.01" placeholder="e.g., 31250.45" inputmode="decimal">
          <div style="font-size: 12px; color: #666; margin-top: 5px;">
            <strong>Why?</strong> Manually enter net sales if API data doesn't match Toast web reports. This will be used for labor percentage calculations.
          </div>
          <div style="font-size: 11px; color: #999; margin-top: 3px;">
            If left blank, will use API-fetched net sales data from Toast
          </div>
        </div>

        <div class="form-group">
          <label for="calculatedByName">Tips Calculated By:</label>
          <input type="text" id="calculatedByName" class="form-input" placeholder="Your Full Name">
        </div>

        <div class="form-group">
          <label for="tipPoolNotes">Custom Notes (Optional):</label>
          <textarea id="tipPoolNotes" class="form-input" rows="3" placeholder="Enter any notes or adjustments for this tip pool calculation..."></textarea>
          <div style="font-size: 12px; color: #666; margin-top: 5px;">These notes will be displayed in the tip pool summary below.</div>
        </div>

        <!-- Cashbox Count Section (Collapsible) -->
        <details style="margin: 15px 0; padding: 10px; background: #f8f9fa; border-radius: 0;">
          <summary style="cursor: pointer; font-size: 13px; color: #666; font-weight: 600;">
            Cashbox Count (Optional - Click to expand)
          </summary>
          <div style="margin-top: 15px;">
            <p style="color: #666; font-size: 12px; margin-bottom: 15px;">
              Count all cash and coins in the cashbox <strong>before</strong> generating the combined report. This enables weekly reconciliation tracking.
            </p>

            <!-- Counter Name Selection -->
            <div class="form-group">
              <label for="tipPoolCashboxCounter">Counted by:</label>
              <select id="tipPoolCashboxCounter" class="form-select" onchange="toggleTipPoolCashboxInputs()">
                <option value="">Choose Name (or skip if not counting today)</option>
                <option value="Demetri Gregorakis">Demetri Gregorakis</option>
                <option value="Ahmet Can Guler">Ahmet Can Guler</option>
                <option value="Bryan Cox">Bryan Cox</option>
                <option value="Kayla Mccullough">Kayla Mccullough</option>
                <option value="Dilan Uzum">Dilan Uzum</option>
                <option value="Other">Other</option>
              </select>
            </div>

            <div class="form-group" id="tipPoolCashboxOtherNameGroup" style="display: none;">
              <label for="tipPoolCashboxOtherName">Enter your name:</label>
              <input type="text" id="tipPoolCashboxOtherName" class="form-input" placeholder="Full Name">
            </div>

            <!-- Denomination Inputs -->
            <div id="tipPoolCashboxDenominationInputs" style="display: none; margin-top: 15px;">
              <h5 style="color: #666; margin-bottom: 15px;">Count by Denomination</h5>

              <!-- Bills Section -->
              <div style="background: #f8f9fa; padding: 15px; border-radius: 0; margin-bottom: 15px; border: 1px solid #ddd;">
                <h6 style="color: #666; margin-bottom: 10px; font-size: 13px;">Bills</h6>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px;">
                  <div class="denomination-group">
                    <label style="font-size: 12px;">$100 bills:</label>
                    <input type="number" id="tipPool_cashbox_hundreds" class="form-input" min="0" value="0" inputmode="numeric" onchange="calculateTipPoolCashboxTotal()">
                  </div>
                  <div class="denomination-group">
                    <label style="font-size: 12px;">$50 bills:</label>
                    <input type="number" id="tipPool_cashbox_fifties" class="form-input" min="0" value="0" inputmode="numeric" onchange="calculateTipPoolCashboxTotal()">
                  </div>
                  <div class="denomination-group">
                    <label style="font-size: 12px;">$20 bills:</label>
                    <input type="number" id="tipPool_cashbox_twenties" class="form-input" min="0" value="0" inputmode="numeric" onchange="calculateTipPoolCashboxTotal()">
                  </div>
                  <div class="denomination-group">
                    <label style="font-size: 12px;">$10 bills:</label>
                    <input type="number" id="tipPool_cashbox_tens" class="form-input" min="0" value="0" inputmode="numeric" onchange="calculateTipPoolCashboxTotal()">
                  </div>
                  <div class="denomination-group">
                    <label style="font-size: 12px;">$5 bills:</label>
                    <input type="number" id="tipPool_cashbox_fives" class="form-input" min="0" value="0" inputmode="numeric" onchange="calculateTipPoolCashboxTotal()">
                  </div>
                  <div class="denomination-group">
                    <label style="font-size: 12px;">$1 bills:</label>
                    <input type="number" id="tipPool_cashbox_ones" class="form-input" min="0" value="0" inputmode="numeric" onchange="calculateTipPoolCashboxTotal()">
                  </div>
                </div>
              </div>

              <!-- Coins Section -->
              <div style="background: #f8f9fa; padding: 15px; border-radius: 0; margin-bottom: 15px; border: 1px solid #ddd;">
                <h6 style="color: #666; margin-bottom: 10px; font-size: 13px;">Coins</h6>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px;">
                  <div class="denomination-group">
                    <label style="font-size: 12px;">Quarters:</label>
                    <input type="number" id="tipPool_cashbox_quarters" class="form-input" min="0" value="0" inputmode="numeric" onchange="calculateTipPoolCashboxTotal()">
                  </div>
                  <div class="denomination-group">
                    <label style="font-size: 12px;">Dimes:</label>
                    <input type="number" id="tipPool_cashbox_dimes" class="form-input" min="0" value="0" inputmode="numeric" onchange="calculateTipPoolCashboxTotal()">
                  </div>
                  <div class="denomination-group">
                    <label style="font-size: 12px;">Nickels:</label>
                    <input type="number" id="tipPool_cashbox_nickels" class="form-input" min="0" value="0" inputmode="numeric" onchange="calculateTipPoolCashboxTotal()">
                  </div>
                  <div class="denomination-group">
                    <label style="font-size: 12px;">Pennies:</label>
                    <input type="number" id="tipPool_cashbox_pennies" class="form-input" min="0" value="0" inputmode="numeric" onchange="calculateTipPoolCashboxTotal()">
                  </div>
                </div>
              </div>

              <!-- Total Display -->
              <div style="background: #fff; padding: 20px; border-radius: 0; text-align: center; border: 2px solid #ddd;">
                <h5 style="margin: 0 0 10px 0; color: #666; font-size: 14px; text-transform: uppercase;">Total Cashbox Amount</h5>
                <div id="tipPoolCashboxTotal" style="font-size: 28px; font-weight: bold; color: #333;">$0.00</div>
                <div style="font-size: 12px; color: #666; margin-top: 8px;">This will be used for weekly reconciliation on the combined report</div>
              </div>
            </div>
          </div>
        </details>

        <button class="submit-btn" onclick="calculateTipPool()">Calculate Tip Pool</button>
        <button class="submit-btn" onclick="downloadTipPoolPDF()" id="tipPoolPdfBtn" style="margin-left: 10px; display: none;">Download Tip Pool PDF</button>
        <button class="submit-btn" onclick="clearSavedData()" style="margin-left: 10px;" title="Clear all saved data and start fresh">Clear Saved Data</button>
        

        
        <!-- Tip Pool Results Display -->
        <div id="tipPoolResults" style="display: none; margin-top: 20px;">
          <div id="tipPoolSummary"></div>
          <div id="tipPoolTable"></div>
          
          <!-- Combined Report Section - Auto-populated -->
          <div id="combinedReportSection" style="display: none; margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 0; border: 2px solid #6f42c1;">
            <h4 style="margin: 0 0 15px 0; color: #6f42c1;">Weekly Combined Report</h4>
            <p style="margin: 0 0 15px 0; font-size: 14px; color: #666;">
              Generate a comprehensive weekly summary combining your tip pool calculations with cash count reports.
            </p>
            
            <!-- PDF Upload Options -->
            <div style="margin-bottom: 20px; padding: 15px; background: white; border-radius: 0; border: 1px solid #ddd;">
              <h5 style="margin: 0 0 10px 0; color: #333;">Attach Additional PDFs (Optional)</h5>
              
              <div style="display: flex; gap: 15px; margin-bottom: 10px;">
                <div style="flex: 1;">
                  <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #555;">Add Weekly Voids Log:</label>
                  <input type="file" id="voidsLogUpload" accept=".pdf" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 0;">
                </div>
                <div style="flex: 1;">
                  <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #555;">Add Extras:</label>
                  <input type="file" id="extrasUpload" accept=".pdf" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 0;">
                </div>
              </div>
              
              <p style="margin: 5px 0 0 0; font-size: 12px; color: #666;">
                Upload PDFs to include in your weekly report. Order: Generated Report → Voids Log → Extras
              </p>
            </div>
            
            <div style="display: flex; gap: 15px; align-items: center;">
              <button class="submit-btn" onclick="generateCombinedReport()" style="flex: 1;">Generate Combined Weekly Report</button>
            </div>
            
            <!-- Hidden inputs for auto-populated data -->
            <input type="hidden" id="combinedStartDate">
            <input type="hidden" id="combinedEndDate">
            <input type="hidden" id="combinedRealEnvelope">
          </div>
        </div>
        
        <!-- Hidden Tip Pool Report Display for PDF generation -->
        <div id="tipPoolReportDisplay" style="display: none; position: fixed; top: 0; left: 0; width: 800px; background: white; z-index: 9999; opacity: 0; pointer-events: none;">
          <div id="tipPoolReportContent"></div>
        </div>

        <button class="submit-btn" onclick="goHome()" style="margin-top: 10px;">Back to Menu</button>
      </div>

      <!-- Ordering System Section -->
      <div id="orderingSystemForm" class="form-section">
        <h2 style="margin-bottom: 20px; color: var(--gray-900);">Orders & Prep System</h2>

        <!-- Ordering Guide Print -->
        <div style="margin-bottom: 16px; padding: 12px; background: var(--gray-100); border-left: 3px solid var(--gray-700); border-radius: 0;">
          <span style="font-size: 12px; font-weight: 700; color: var(--gray-700); text-transform: uppercase; letter-spacing: 0.5px; margin-right: 12px;">Print Ordering Guides:</span>
          <a href="#" onclick="downloadOrderingGuide('greenleaf'); return false;" style="font-size: 12px; color: #059669; text-decoration: underline; margin-right: 16px; cursor: pointer;">🖨️ Greenleaf</a>
          <a href="#" onclick="downloadOrderingGuide('performance'); return false;" style="font-size: 12px; color: #059669; text-decoration: underline; margin-right: 16px; cursor: pointer;">🖨️ Performance</a>
          <a href="#" onclick="downloadOrderingGuide('mani'); return false;" style="font-size: 12px; color: #059669; text-decoration: underline; cursor: pointer;">🖨️ Mani</a>
        </div>

        <!-- Tab Navigation -->
        <div style="position: sticky; top: 0; z-index: 100; background: var(--white); margin-bottom: 20px; padding-bottom: 10px;">
          <div class="tabs" style="display: flex; border-bottom: 2px solid var(--gray-300); overflow-x: auto; overflow-y: hidden; -webkit-overflow-scrolling: touch; gap: 4px;">
            <button class="tab-link active" onclick="openOrderTab(event, 'prepSheet')" style="
            flex: 0 0 auto;
            padding: 12px 10px;
            min-width: 80px;
            background: var(--gray-700);
            color: var(--white);
            border: none;
            cursor: pointer;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            transition: all 0.15s ease;
          ">PREP</button>
          <button class="tab-link" onclick="openOrderTab(event, 'checkInInvoice')" style="
            flex: 0 0 auto;
            padding: 12px 10px;
            min-width: 80px;
            background: var(--gray-100);
            color: var(--gray-700);
            border: none;
            cursor: pointer;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            transition: all 0.15s ease;
          ">RECEIVE</button>
          <button class="tab-link" onclick="openOrderTab(event, 'upcomingOrders')" style="
            flex: 0 0 auto;
            padding: 12px 10px;
            min-width: 80px;
            background: var(--gray-100);
            color: var(--gray-700);
            border: none;
            cursor: pointer;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            transition: all 0.15s ease;
          ">ORDERING</button>
          <button class="tab-link" onclick="openOrderTab(event, 'updateCounts')" style="
            flex: 0 0 auto;
            padding: 12px 10px;
            min-width: 80px;
            background: var(--gray-100);
            color: var(--gray-700);
            border: none;
            cursor: pointer;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            transition: all 0.15s ease;
          ">COUNT</button>
          <button class="tab-link" onclick="openOrderTab(event, 'manageInventory')" style="
            flex: 0 0 auto;
            padding: 12px 10px;
            min-width: 80px;
            background: var(--gray-100);
            color: var(--gray-700);
            border: none;
            cursor: pointer;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            transition: all 0.15s ease;
          ">EDIT</button>
          <button class="tab-link" onclick="openManageOrdersTab(event)" style="
            flex: 0 0 auto;
            padding: 12px 10px;
            min-width: 80px;
            background: var(--gray-100);
            color: var(--gray-700);
            border: none;
            cursor: pointer;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            transition: all 0.15s ease;
          ">MANAGE</button>
          <button class="tab-link" onclick="openOrderTab(event, 'priceHistory')" style="
            flex: 0 0 auto;
            padding: 12px 10px;
            min-width: 80px;
            background: var(--gray-100);
            color: var(--gray-700);
            border: none;
            cursor: pointer;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            transition: all 0.15s ease;
          ">PRICES</button>
          </div>
        </div>

        <!-- Tab Content: Upcoming Orders -->
        <div id="upcomingOrders" class="tab-content" style="display: none;">
          <div style="text-align: center; padding: 20px;">
            <p>Loading orders...</p>
          </div>
        </div>

        <!-- Tab Content: Manage Inventory -->
        <div id="manageInventory" class="tab-content" style="display: none;">
          <!-- Add Item Button -->
          <div style="margin-bottom: 20px;">
            <button onclick="showAddInventoryModal()" style="
              background: var(--gray-700);
              color: white;
              border: none;
              padding: 10px 20px;
              border-radius: 0;
              cursor: pointer;
              font-size: 12px;
              font-weight: 700;
              text-transform: uppercase;
              letter-spacing: 0.8px;
            ">+ Add Inventory Item</button>
          </div>

          <!-- Inventory List -->
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3 style="margin: 0; color: var(--gray-900);">Inventory Items</h3>
            <button onclick="showVendorManagement()" style="
              background: var(--gray-600);
              color: white;
              border: none;
              padding: 8px 16px;
              border-radius: 0;
              cursor: pointer;
              font-size: 13px;
              font-weight: 600;
            ">Manage Vendors</button>
          </div>

          <!-- Search and Filter Controls -->
          <div style="display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap;">
            <input
              type="text"
              id="inventorySearchInput"
              placeholder="Search items..."
              oninput="filterInventoryList()"
              style="
                flex: 1;
                min-width: 200px;
                padding: 10px 14px;
                border: 2px solid #e0e0e0;
                border-radius: 6px;
                font-size: 14px;
                transition: border-color 0.2s;
              "
              onfocus="this.style.borderColor='var(--gray-700)'"
              onblur="this.style.borderColor='#e0e0e0'"
            />
            <select
              id="inventoryVendorFilter"
              onchange="filterInventoryList()"
              style="
                padding: 10px 14px;
                border: 2px solid #e0e0e0;
                border-radius: 6px;
                font-size: 14px;
                background: white;
                cursor: pointer;
              "
            >
              <option value="">All Vendors</option>
              <option value="PREP">PREP</option>
              <option value="Greenleaf">Greenleaf</option>
              <option value="Performance">Performance</option>
              <option value="Mani Imports">Mani Imports</option>
              <option value="Eatopia">Eatopia</option>
              <option value="Restaurant Depot">Restaurant Depot</option>
              <option value="Alsco">Alsco</option>
              <option value="SRC Pumping">SRC Pumping</option>
              <option value="Southern Glazer's">Southern Glazer's</option>
              <option value="Breakthru Beverage">Breakthru Beverage</option>
            </select>
          </div>

          <div id="inventoryList" style="width: 100%;">
            <p style="text-align: center; padding: 20px;">Loading inventory...</p>
          </div>
        </div>

        <!-- Tab Content: Price History -->
        <div id="priceHistory" class="tab-content" style="display: none;">
          <div style="border: 2px solid var(--gray-300); padding: 18px; margin-bottom: 18px; background: var(--gray-100);">
            <h3 style="margin: 0 0 16px 0; color: var(--gray-900); font-size: 15px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.6px;">Price History Explorer</h3>

            <div style="display: flex; flex-wrap: wrap; gap: 16px; margin-bottom: 16px;">
              <div style="flex: 1 1 200px;">
                <label for="priceHistoryStartDate" style="display: block; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: var(--gray-700); margin-bottom: 4px;">Start Date</label>
                <input type="date" id="priceHistoryStartDate" style="width: 100%; padding: 10px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 13px;" />
              </div>
              <div style="flex: 1 1 200px;">
                <label for="priceHistoryEndDate" style="display: block; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: var(--gray-700); margin-bottom: 4px;">End Date</label>
                <input type="date" id="priceHistoryEndDate" style="width: 100%; padding: 10px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 13px;" />
              </div>
              <div style="flex: 1 1 220px;">
                <label for="priceHistoryVendor" style="display: block; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: var(--gray-700); margin-bottom: 4px;">Vendor Filter</label>
                <select id="priceHistoryVendor" onchange="handlePriceHistoryVendorChange()" style="width: 100%; padding: 10px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 13px; background: white;">
                  <option value="ALL">All Vendors</option>
                </select>
              </div>
            </div>

            <div style="border: 2px solid var(--gray-300); background: white; padding: 16px;">
              <div style="display: flex; flex-wrap: wrap; gap: 12px; align-items: center; margin-bottom: 12px;">
                <div style="flex: 1 1 200px;">
                  <label for="priceHistoryItemSearch" style="display: block; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: var(--gray-700); margin-bottom: 4px;">Search Items</label>
                  <input type="text" id="priceHistoryItemSearch" placeholder="Search inventory items..." oninput="handlePriceHistorySearch(this.value)" style="width: 100%; padding: 8px 10px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 12px;" />
                </div>
                <div style="display: flex; gap: 10px;">
                  <button type="button" onclick="priceHistorySelectAll()" style="padding: 8px 12px; border: 2px solid var(--gray-400); background: var(--gray-100); color: var(--gray-800); font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; cursor: pointer;">Select All</button>
                  <button type="button" onclick="priceHistoryClearSelection()" style="padding: 8px 12px; border: 2px solid var(--gray-400); background: white; color: var(--gray-700); font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; cursor: pointer;">Clear</button>
                </div>
              </div>
              <div id="priceHistoryItemList" style="max-height: 220px; overflow-y: auto; border: 1px solid var(--gray-200); padding: 8px; background: #f8f9fa;"></div>
              <p style="margin-top: 8px; font-size: 11px; color: var(--gray-600);">Tip: leave vendor on "All" to compare cross-vendor items. Select at least one item or choose a vendor to analyze.</p>
            </div>

            <div style="margin-top: 16px; display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
              <button type="button" onclick="loadPriceHistory()" style="padding: 12px 20px; background: var(--gray-900); color: white; border: 2px solid var(--gray-900); font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.8px; cursor: pointer;">Load Price History</button>
              <span id="priceHistoryStatus" style="font-size: 12px; color: var(--gray-600);"></span>
            </div>
          </div>

          <div id="priceHistoryResults" style="border: 2px solid var(--gray-300); padding: 18px; background: white; min-height: 120px;">
            <p style="margin: 0; font-size: 13px; color: var(--gray-600);">Select a date range and items to view pricing trends.</p>
          </div>
        </div>

        <!-- Tab Content: Update Counts -->
        <div id="updateCounts" class="tab-content" style="display: none;">
          <!-- Search and Filter Controls -->
          <div style="display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap;">
            <input
              type="text"
              id="stockCountSearchInput"
              placeholder="Search items..."
              oninput="filterStockCountList()"
              style="
                flex: 1;
                min-width: 200px;
                padding: 10px 14px;
                border: 2px solid #e0e0e0;
                border-radius: 6px;
                font-size: 14px;
                transition: border-color 0.2s;
              "
              onfocus="this.style.borderColor='var(--gray-700)'"
              onblur="this.style.borderColor='#e0e0e0'"
            />
            <select
              id="stockCountVendorFilter"
              onchange="filterStockCountList()"
              style="
                padding: 10px 14px;
                border: 2px solid #e0e0e0;
                border-radius: 6px;
                font-size: 14px;
                background: white;
                cursor: pointer;
              "
            >
              <option value="">All Vendors</option>
              <option value="Greenleaf">Greenleaf</option>
              <option value="Performance">Performance</option>
              <option value="Mani Imports">Mani Imports</option>
              <option value="Eatopia">Eatopia</option>
              <option value="Restaurant Depot">Restaurant Depot</option>
              <option value="Alsco">Alsco</option>
              <option value="SRC Pumping">SRC Pumping</option>
              <option value="Southern Glazer's">Southern Glazer's</option>
              <option value="Breakthru Beverage">Breakthru Beverage</option>
            </select>
          </div>

          <div id="stockCountList" style="width: 100%;">
            <p style="text-align: center; padding: 20px;">Loading items...</p>
          </div>
        </div>

        <!-- Tab Content: Prep Sheet -->
        <div id="prepSheet" class="tab-content" style="display: block;">
          <!-- Add Prep Item Button -->
          <div style="margin-bottom: 20px;">
            <button onclick="showAddPrepModal()" style="
              background: var(--gray-700);
              color: white;
              border: none;
              padding: 10px 20px;
              border-radius: 0;
              cursor: pointer;
              font-size: 12px;
              font-weight: 700;
              text-transform: uppercase;
              letter-spacing: 0.8px;
            ">+ Add Prep Item</button>
          </div>

          <!-- Info Notice -->
          <div style="margin-bottom: 20px; padding: 12px 16px; background: #e3f2fd; border-left: 4px solid #2196f3; border-radius: 0;">
            <p style="color: #1565c0; font-size: 12px; margin: 0; font-weight: 600;">
              View today's full prep recommendations at the bottom of this page
            </p>
          </div>

          <!-- Count Session Info (Auto-detected) -->
          <div id="countSessionInfo" style="margin-bottom: 20px; padding: 16px; background: var(--gray-100); border-radius: 0; border: 2px solid var(--gray-300);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
              <div style="font-weight: 700; color: var(--gray-900); font-size: 14px; text-transform: uppercase; letter-spacing: 1px;">
                <span id="currentSessionIcon"></span>
                <span id="currentSessionName"></span>
              </div>
              <div style="font-size: 11px; color: var(--gray-500); font-weight: 600;">
                <span id="currentSessionTime"></span>
              </div>
            </div>
            <div id="sessionCompletionStats" style="font-size: 12px; color: var(--gray-700); line-height: 1.6;">
              <!-- Populated by JavaScript -->
            </div>
          </div>

          <!-- PREP Item Counting Section -->
          <div style="margin-bottom: 30px;">
            <h3 style="margin-bottom: 12px; color: var(--gray-900); font-size: 14px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;">Update Prep Stock Counts</h3>
            <div id="prepCountList" style="width: 100%;">
              <p style="text-align: center; padding: 20px; color: var(--gray-500);">Loading prep items...</p>
            </div>
          </div>

          <!-- Custom Notes Section -->
          <div style="margin-bottom: 20px;">
            <label for="prepSheetNotes" style="display: block; font-size: 12px; font-weight: 700; color: var(--gray-700); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">
              Custom Notes (optional - will appear on PDF):
            </label>
            <textarea
              id="prepSheetNotes"
              placeholder="Add any special instructions or notes for the prep team..."
              style="width: 100%; padding: 12px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 13px; min-height: 80px; font-family: inherit; resize: vertical;"
            ></textarea>
          </div>

          <!-- Action Buttons -->
          <div style="display: flex; gap: 12px; margin-bottom: 20px; margin-top: 0;">
            <button class="submit-btn" onclick="refreshPrepSheet()" style="background: #808080; color: white; flex: 1 1 0; min-width: 0;">
              REFRESH
            </button>
            <button class="submit-btn" onclick="generatePrepSheetPDF()" style="background: #808080; color: white; flex: 1 1 0; min-width: 0;">
              DOWNLOAD PDF
            </button>
            <button class="submit-btn" onclick="emailPrepSheetToPrinter()" style="background: #808080; color: white; flex: 1 1 0; min-width: 0;">
              EMAIL TO PRINTER
            </button>
          </div>

          <!-- Auto-Print Status Disclaimer -->
          <div id="autoPrintStatus" style="margin-bottom: 20px;">
            <p style="text-align: center; padding: 12px; color: var(--gray-500); font-size: 12px;">
              Checking auto-print status...
            </p>
          </div>

          <!-- Prep Summary Stats -->
          <div id="prepSummaryStats" style="
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
          ">
            <!-- Will be populated by JavaScript -->
          </div>

          <!-- Prep Recommendations List -->
          <div id="prepRecommendationsList" style="width: 100%;">
            <p style="text-align: center; padding: 20px;">Loading prep recommendations...</p>
          </div>
        </div>

        <!-- Tab Content: Check-In Invoice -->
        <div id="checkInInvoice" class="tab-content" style="display: none;">
          <div style="margin-bottom: 20px;">
            <h3 style="color: var(--gray-900); margin-bottom: 10px; font-size: 16px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;">Invoice Check-In</h3>
            <p style="color: var(--gray-500); font-size: 13px; margin-bottom: 20px;">
              Upload an invoice photo to scan and reconcile items with inventory.
            </p>

            <!-- Type Selector - REQUIRED DROPDOWN -->
            <div style="background: white; border: 2px solid var(--gray-300); padding: 16px; margin-bottom: 20px;">
              <label for="documentTypeSelect" style="display: block; color: var(--gray-700); font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px;">
                DOCUMENT TYPE: <span style="color: #dc2626;">* REQUIRED</span>
              </label>
              <select
                id="documentTypeSelect"
                onchange="selectInvoiceType(this.value)"
                style="width: 100%; padding: 12px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 13px; background: white; font-weight: 600; cursor: pointer;"
              >
                <option value="">-- SELECT TYPE --</option>
                <option value="invoice">INVOICE FROM DELIVERY (Updates Inventory)</option>
                <option value="order">PENDING ORDER (For Future Delivery)</option>
              </select>
              <p id="invoiceTypeDescription" style="margin-top: 10px; font-size: 11px; color: var(--gray-500); line-height: 1.5;">
                Select whether this is an invoice from a delivery you're receiving now, or a pending order for a future date.
              </p>
            </div>
          </div>

          <!-- Orders Due Today Alert (dynamically populated) -->
          <div id="ordersDueTodayAlert"></div>

          <!-- Pending Order Check-In View (dynamically populated) -->
          <div id="pendingOrderCheckInView" style="display: none;"></div>

          <!-- Pending Order Metadata (shown BEFORE upload if type is 'order') -->
          <div id="pendingOrderMetadata" style="display: none; background: white; border: 2px solid var(--gray-300); padding: 20px; margin-bottom: 20px;">
            <h4 style="margin: 0 0 16px 0; color: var(--gray-900); font-size: 14px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;">Order Details</h4>

            <label style="display: block; color: var(--gray-700); font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">
              YOUR NAME: <span style="color: #dc2626;">*</span>
            </label>
            <input
              type="text"
              id="pendingOrderName"
              placeholder="Enter your name"
              style="width: 100%; padding: 12px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 13px; margin-bottom: 16px; box-sizing: border-box;"
            />

            <label style="display: block; color: var(--gray-700); font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">
              EXPECTED DELIVERY DATE: <span style="color: #dc2626;">*</span>
            </label>
            <input
              type="date"
              id="pendingOrderDate"
              style="width: 100%; padding: 12px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 13px; margin-bottom: 16px; box-sizing: border-box;"
            />

            <label style="display: block; color: var(--gray-700); font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">
              NOTES (OPTIONAL):
            </label>
            <textarea
              id="pendingOrderNotes"
              placeholder="Add any special instructions or notes..."
              style="width: 100%; min-height: 80px; padding: 12px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 13px; resize: vertical; font-family: inherit; box-sizing: border-box;"
            ></textarea>
          </div>

          <!-- Upload Section -->
          <div id="uploadSection" style="background: var(--gray-100); padding: 24px; border-radius: 0; margin-bottom: 24px; border: 2px solid var(--gray-300); opacity: 0.5; pointer-events: none;">
            <div style="text-align: center;">
              <h4 style="margin: 0 0 12px 0; color: var(--gray-900); font-size: 14px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;">Upload Invoice/Order</h4>
              <p style="color: var(--gray-500); font-size: 12px; margin-bottom: 16px;">Select document type above first</p>

              <!-- File Input for Camera (Hidden) -->
              <input
                type="file"
                id="invoiceCameraInput"
                accept="image/*,application/pdf,.csv,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
                capture="environment"
                style="display: none;"
                onchange="handleInvoiceUpload(event)"
              />

              <!-- File Input for Upload (Hidden) -->
              <input
                type="file"
                id="invoiceFileInput"
                accept="image/*,application/pdf,.csv,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
                style="display: none;"
                onchange="handleInvoiceUpload(event)"
              />

              <!-- Upload Buttons (Side by Side) -->
              <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                <button
                  class="submit-btn"
                  onclick="document.getElementById('invoiceCameraInput').click()"
                  style="background: var(--gray-100); color: var(--gray-900); border: 2px solid var(--gray-300); flex: 1; max-width: 200px; padding: 14px;"
                >
                  TAKE PHOTO
                </button>
                <button
                  class="submit-btn"
                  onclick="document.getElementById('invoiceFileInput').click()"
                  style="background: var(--gray-100); color: var(--gray-900); border: 2px solid var(--gray-300); flex: 1; max-width: 200px; padding: 14px;"
                >
                  UPLOAD
                </button>
              </div>
            </div>
          </div>

          <!-- Preview Section (Hidden until image uploaded) -->
          <div id="invoicePreviewSection" style="display: none; margin-bottom: 24px;">
            <h4 style="color: var(--gray-900); margin-bottom: 12px; font-size: 14px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;">Uploaded Image</h4>
            <div style="background: var(--white); padding: 16px; border-radius: 0; border: 1px solid var(--gray-300); position: relative;">
              <img
                id="invoicePreviewImage"
                style="max-width: 100%; height: auto; border-radius: 0; display: block; margin: 0 auto;"
              />

              <!-- Vendor Format Selector -->
              <div style="margin-top: 16px; padding: 12px; background: var(--gray-100); border: 2px solid var(--gray-300);">
                <label style="display: block; margin-bottom: 8px; color: var(--gray-700); font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;">
                  VENDOR FORMAT (helps OCR accuracy)
                </label>
                <select
                  id="ocrVendorFormat"
                  style="width: 100%; padding: 10px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 13px; background: white; font-weight: 600;"
                  onchange="handleVendorFormatChange(this.value)"
                >
                  <option value="auto">Auto-Detect Format</option>
                  <option value="performance-order">Performance - Order Email</option>
                  <option value="performance-invoice">Performance - Invoice</option>
                  <option value="greenleaf-invoice">Greenleaf - Invoice</option>
                  <option value="mani-invoice">Mani Imports - Invoice</option>
                  <option value="generic">Generic Format</option>
                  <option value="__ADD_NEW__" style="border-top: 2px solid #ccc; margin-top: 4px; font-weight: 700;">➕ CREATE NEW FORMAT...</option>
                </select>
                <p style="margin-top: 6px; font-size: 10px; color: var(--gray-600);">
                  System learns and improves with each check-in!
                </p>
              </div>

              <div style="margin-top: 16px; display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                <button
                  class="submit-btn"
                  onclick="processInvoiceOCR()"
                  id="processOCRButton"
                  style="background: var(--gray-700); color: white; border: 2px solid var(--gray-700); flex: 1; max-width: 200px; padding: 14px; font-weight: 700;"
                >
                  SCAN & EXTRACT
                </button>
                <button
                  class="submit-btn"
                  onclick="clearInvoiceUpload()"
                  style="background: var(--gray-100); color: var(--gray-900); border: 2px solid var(--gray-300); flex: 1; max-width: 200px; padding: 14px;"
                >
                  CLEAR
                </button>
              </div>
            </div>
          </div>

          <!-- OCR Processing Status -->
          <div id="ocrProcessingStatus" style="display: none; margin-bottom: 24px;">
            <div style="background: var(--gray-100); padding: 16px; border-radius: 0; border: 2px solid var(--gray-300);">
              <div style="display: flex; align-items: center; gap: 12px;">
                <div class="spinner" style="
                  border: 3px solid var(--gray-300);
                  border-top: 3px solid var(--gray-500);
                  border-radius: 50%;
                  width: 24px;
                  height: 24px;
                  animation: spin 1s linear infinite;
                "></div>
                <div>
                  <strong style="color: var(--gray-900); font-size: 13px; text-transform: uppercase; letter-spacing: 1px;">Processing Invoice...</strong>
                  <p id="ocrProgressText" style="margin: 4px 0 0 0; color: var(--gray-500); font-size: 12px;">
                    Extracting text from image...
                  </p>
                </div>
              </div>
            </div>
          </div>

          <!-- Extracted Items Section (Hidden until OCR complete) -->
          <div id="extractedItemsSection" style="display: none;">
            <h4 style="color: var(--gray-900); margin-bottom: 16px; font-size: 14px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;">Extracted Items</h4>
            <div id="extractedItemsList" style="width: 100%;">
              <!-- Will be populated by JavaScript including check-in button -->
            </div>
          </div>
        </div>

        <!-- Tab Content: Manage Pending Orders (Password Protected) -->
        <div id="manageOrders" class="tab-content" style="display: none;">
          <!-- Page Header -->
          <div style="background: var(--gray-100); border: 2px solid var(--gray-300); padding: 20px; margin-bottom: 20px;">
            <h3 style="color: var(--gray-900); margin: 0 0 12px 0; font-size: 18px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;">Manage Pending Orders</h3>
            <p style="color: var(--gray-600); font-size: 13px; margin: 0; line-height: 1.5;">View, edit, and delete all pending orders. Change delivery dates to control when orders appear in the Check-In flow. <strong>Red dates</strong> are overdue, <strong style="color: #f59e0b;">orange</strong> are today, <strong style="color: #059669;">green</strong> are future.</p>
          </div>

          <!-- Orders List Container -->
          <div id="managePendingOrdersList" style="width: 100%;"></div>
        </div>

        <button class="submit-btn" onclick="goHome()" style="margin-top: 20px;">Back to Menu</button>
      </div>
    </div>
  </div>

  <!-- Historical Report Results Section - MOVED OUTSIDE tipPoolForm -->
  <div id="reportResults" style="display: none; margin-top: 20px;">
    <div id="reportContent"></div>
  </div>

  <!-- Cashbox Count Section -->
  <div id="cashboxSection" class="form-section main-section">
    <div class="container">
      <div class="form-container" style="max-width: 600px;">
        <h2 style="text-align: center; margin-bottom: 30px; color: #6f42c1;">
          Weekly Cashbox Count
        </h2>
        <p style="text-align: center; margin-bottom: 30px; color: #666; font-size: 14px;">
          Count all cash and coins in the cashbox. This will be used for weekly reconciliation.
        </p>

        <div class="form-group">
          <label for="cashboxCounter">Counted by:</label>
          <select id="cashboxCounter" class="form-select" onchange="toggleCashboxDenominationInputs()" required>
            <option value="">Choose Name</option>
            <option value="Demetri Gregorakis">Demetri Gregorakis</option>
            <option value="Ahmet Can Guler">Ahmet Can Guler</option>
            <option value="Bryan Cox">Bryan Cox</option>
            <option value="Kayla Mccullough">Kayla Mccullough</option>
            <option value="Dilan Uzum">Dilan Uzum</option>
            <option value="Other">Other</option>
          </select>
        </div>

        <div class="form-group" id="cashboxOtherNameGroup" style="display: none;">
          <label for="cashboxOtherName">Enter your name:</label>
          <input type="text" id="cashboxOtherName" class="form-input" placeholder="Full Name">
        </div>

        <!-- Denomination Input Section -->
        <div id="cashboxDenominationInputs" style="display: none; margin-top: 20px;">
          <h4 style="color: #6f42c1; margin-bottom: 15px;">Count by Denomination</h4>
          
          <!-- Bills Section -->
          <div style="background: #f8f9fa; padding: 15px; border-radius: 0; margin-bottom: 15px;">
            <h5 style="color: #495057; margin-bottom: 10px;">Bills</h5>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px;">
              <div class="denomination-group">
                <label>$100 bills:</label>
                <input type="number" id="cashbox_hundreds" class="form-input" min="0" value="0" inputmode="numeric" onchange="calculateCashboxTotal()">
              </div>
              <div class="denomination-group">
                <label>$50 bills:</label>
                <input type="number" id="cashbox_fifties" class="form-input" min="0" value="0" inputmode="numeric" onchange="calculateCashboxTotal()">
              </div>
              <div class="denomination-group">
                <label>$20 bills:</label>
                <input type="number" id="cashbox_twenties" class="form-input" min="0" value="0" inputmode="numeric" onchange="calculateCashboxTotal()">
              </div>
              <div class="denomination-group">
                <label>$10 bills:</label>
                <input type="number" id="cashbox_tens" class="form-input" min="0" value="0" inputmode="numeric" onchange="calculateCashboxTotal()">
              </div>
              <div class="denomination-group">
                <label>$5 bills:</label>
                <input type="number" id="cashbox_fives" class="form-input" min="0" value="0" inputmode="numeric" onchange="calculateCashboxTotal()">
              </div>
              <div class="denomination-group">
                <label>$1 bills:</label>
                <input type="number" id="cashbox_ones" class="form-input" min="0" value="0" inputmode="numeric" onchange="calculateCashboxTotal()">
              </div>
            </div>
          </div>

          <!-- Coins Section -->
          <div style="background: #f8f9fa; padding: 15px; border-radius: 0; margin-bottom: 15px;">
            <h5 style="color: #495057; margin-bottom: 10px;">Coins</h5>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px;">
              <div class="denomination-group">
                <label>Quarters:</label>
                <input type="number" id="cashbox_quarters" class="form-input" min="0" value="0" inputmode="numeric" onchange="calculateCashboxTotal()">
              </div>
              <div class="denomination-group">
                <label>Dimes:</label>
                <input type="number" id="cashbox_dimes" class="form-input" min="0" value="0" inputmode="numeric" onchange="calculateCashboxTotal()">
              </div>
              <div class="denomination-group">
                <label>Nickels:</label>
                <input type="number" id="cashbox_nickels" class="form-input" min="0" value="0" inputmode="numeric" onchange="calculateCashboxTotal()">
              </div>
              <div class="denomination-group">
                <label>Pennies:</label>
                <input type="number" id="cashbox_pennies" class="form-input" min="0" value="0" inputmode="numeric" onchange="calculateCashboxTotal()">
              </div>
            </div>
          </div>

          <!-- Total Display -->
          <div style="background: #e6f3ff; padding: 20px; border-radius: 0; text-align: center; border: 2px solid #007bff;">
            <h4 style="margin: 0 0 10px 0; color: #007bff;">Total Cashbox Amount</h4>
            <div id="cashboxTotal" style="font-size: 24px; font-weight: bold; color: #007bff;">$0.00</div>
          </div>

          <!-- Reconciliation Section -->
          <div id="cashboxReconciliation" style="margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 0; border: 2px solid #ffc107; display: none;">
            <h5 style="color: #856404; margin-bottom: 10px;">Weekly Reconciliation</h5>
            <div id="reconciliationDetails"></div>
          </div>

          <button class="submit-btn" onclick="saveCashboxCount()" style="margin-top: 20px;">Save Cashbox Count</button>
        </div>

        <button class="submit-btn" onclick="goHome()" style="margin-top: 20px;">Back to Menu</button>
      </div>
    </div>
  </div>

<script>
  // Configuration
   const SUPABASE_URL = 'https://gaawtbqpnnbbnsyswqwv.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdhYXd0YnFwbm5iYm5zeXN3cXd2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1MDE1NTAsImV4cCI6MjA3MjA3NzU1MH0.F-y7AIQTWaUe7DRT4OnIZVn94mhXxfhpBbng2aJ8nXg';  
  const EMAILJS_CONFIG = {
    PUBLIC_KEY: 'LHbq8j4mlt49O75eo',
    SERVICE_ID: 'service_xm62z73',
    TEMPLATE_ID: 'template_cash_report',
    MANAGER_EMAIL: 'smanager@jaynagyro.com, GSS4168CTJJA73@PRINT.EPSONCONNECT.COM'
  };
  const BOTTLED_SAUCE_ITEMS = [
    { label: 'Spicy Aioli Bottled', aliases: ['spicy aioli bottled', 'spicy aioli - bottled'] },
    { label: 'Tzatziki Bottled', aliases: ['tzatziki bottled', 'tzatziki - bottled'] },
    { label: 'Lemon Vinaigrette Bottled', aliases: ['lemon vinaigrette bottled', 'lemon vinaigrette - bottled'] }
  ];

  // Function to check if an item should be in bottled/to-go section
  function isBottledOrToGoItem(itemName) {
    const name = (itemName || '').trim().toLowerCase();
    // Check if it's in the bottled sauce list
    const isBottled = BOTTLED_SAUCE_ITEMS.some(config => 
      config.aliases.some(alias => name.includes(alias))
    );
    // Check if it has "to go" or "to-go" in the name
    const isToGo = name.includes('to go') || name.includes('to-go');
    return isBottled || isToGo;
  }

  // Elegant Loading and Success Functions
  function showLoading(title, message) {
    const overlay = document.getElementById('loadingOverlay');
    document.getElementById('loadingTitle').textContent = title;
    document.getElementById('loadingMessage').textContent = message;
    overlay.style.display = 'flex'; // Override inline style
    // Don't hide sections - loading overlay should appear on top, not replace content
  }

  function hideLoading() {
    document.getElementById('loadingOverlay').style.display = 'none';
  }

  function showAMSuccess(total) {
    hideLoading();
    hideAllSections();
    document.getElementById('amSuccessTotal').textContent = `$${total.toFixed(2)}`;
    document.getElementById('amSuccessTime').textContent = new Date().toLocaleString();
    document.getElementById('amSuccessScreen').classList.add('active');
  }

  function showPMSuccess(depositAmount, returnAmount, discrepancy) {
    hideLoading();
    hideAllSections();
    document.getElementById('depositAmount').textContent = `$${depositAmount}`;
    document.getElementById('returnAmount').textContent = `$${returnAmount.toFixed(2)}`;
    document.getElementById('pmSuccessScreen').classList.add('active');
  }

  function showReportSuccess(date) {
    hideLoading();
    hideAllSections();
    document.getElementById('reportSuccessDate').textContent = date;
    document.getElementById('reportSuccessTime').textContent = new Date().toLocaleString();
    document.getElementById('reportSuccessScreen').classList.add('active');
  }
  
  const DENOMINATIONS = [
    { label: '$100', value: 100.00 },
    { label: '$50', value: 50.00 },
    { label: '$20', value: 20.00 },
    { label: '$10', value: 10.00 },
    { label: '$5', value: 5.00 },
    { label: '$1', value: 1.00 },
    { label: '$0.25', value: 0.25 },
    { label: '$0.10', value: 0.10 },
    { label: '$0.05', value: 0.05 },
    { label: '$0.01', value: 0.01 }
  ];
  
  // Password protection for date changes (only Demetri knows this)
  const ADMIN_PASSWORD = 'JaynaGyro2025!';
  const CASH_PASSWORD = 'jaynacash'; // Cash flow access password

  // Session management for manager access (60 minutes)
  function setManagerSession() {
    const now = new Date().getTime();
    const expiryTime = now + (60 * 60 * 1000); // 1 hour from now
    localStorage.setItem('managerSession', expiryTime.toString());
  }

  function isManagerSessionValid() {
    const sessionExpiry = localStorage.getItem('managerSession');
    if (!sessionExpiry) return false;

    const now = new Date().getTime();
    const expiryTime = parseInt(sessionExpiry);

    if (now > expiryTime) {
      // Session expired, clean up
      localStorage.removeItem('managerSession');
      return false;
    }

    return true;
  }

  function clearManagerSession() {
    localStorage.removeItem('managerSession');
  }

  // Session management for cash flow access (30 minutes)
  function setCashSession() {
    const now = new Date().getTime();
    const expiryTime = now + (30 * 60 * 1000); // 30 minutes from now
    localStorage.setItem('cashSession', expiryTime.toString());
  }

  function isCashSessionValid() {
    const sessionExpiry = localStorage.getItem('cashSession');
    if (!sessionExpiry) return false;

    const now = new Date().getTime();
    const expiryTime = parseInt(sessionExpiry);

    if (now > expiryTime) {
      // Session expired, clean up
      localStorage.removeItem('cashSession');
      return false;
    }

    return true;
  }

  function clearCashSession() {
    localStorage.removeItem('cashSession');
  }
  
  let supabase = null;
  let currentAMData = null;
  
  // Initialize app
  document.addEventListener('DOMContentLoaded', function() {
    initializeSupabase();
    initializeEmailJS();
    setTodayDate();

    // Load custom vendor formats from database
    loadCustomVendorFormats();

    // Load saved data (removed loadTipPoolData to reset tip pool fields every time)
    loadCombinedReportData();

    // Initialize TDS data and button state
    resetTdsData();
    updateCalculateButtonState();

    // Add file upload listeners to show status when files are selected
    document.getElementById('laborFile').addEventListener('change', handleFileUpload);
    document.getElementById('salesFile').addEventListener('change', handleFileUpload);

    // Event delegation for delete buttons in inventory list
    document.addEventListener('click', function(event) {
      if (event.target.classList.contains('delete-item-btn')) {
        const itemId = parseInt(event.target.getAttribute('data-delete-item'));
        if (itemId) {
          deleteInventoryItem(itemId);
        }
      }
    });

    // Check auto-print status on initial page load (PREP tab is default)
    setTimeout(() => checkAutoPrintStatus(), 500);

    // Removed "App ready" message to prevent page bouncing
  });
  
  function initializeSupabase() {
    if (SUPABASE_URL === 'YOUR_SUPABASE_URL_HERE' || SUPABASE_ANON_KEY === 'YOUR_SUPABASE_ANON_KEY_HERE') {
      showMessage('Please configure Supabase credentials', 'error');
      return;
    }
    try {
      supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      console.log('Supabase initialized');
    } catch (error) {
      console.error('Supabase init failed:', error);
      showMessage('Database connection failed', 'error');
    }
  }
  
  function initializeEmailJS() {
    if (typeof emailjs !== 'undefined') {
      emailjs.init(EMAILJS_CONFIG.PUBLIC_KEY);
    }
  }
  
  function setTodayDate() {
    const today = getPacificDate();
    document.getElementById('amDate').value = today;
    document.getElementById('pmDate').value = today;
    document.getElementById('reportDate').value = today;
    
    // Add password protection to date inputs
    document.getElementById('amDate').addEventListener('change', function() {
      const result = validateDateChange(this);
      if (result instanceof Promise) {
        // Handle async validation - input value already reset if needed
        return;
      }
    });
    
    document.getElementById('pmDate').addEventListener('change', function() {
      const result = validateDateChange(this);
      if (result instanceof Promise) {
        result.then((success) => {
          if (success) {
            // Only load AM data if date change was authorized
            loadAMData();
            // Also reload Toast cash sales for the new date
            fetchToastCashSalesForDate(this.value);
          }
        });
      } else if (result) {
        // Synchronous case (current date selected)
        loadAMData();
        // Also reload Toast cash sales for the new date
        fetchToastCashSalesForDate(this.value);
      }
    });
    
    document.getElementById('reportDate').addEventListener('change', function() {
      const result = validateDateChange(this);
      if (result instanceof Promise) {
        // Handle async validation - input value already reset if needed
        return;
      }
    });
  }
  
  const PACIFIC_TIMEZONE = 'America/Los_Angeles';

  /**
   * Determine the offset (in minutes) for Pacific time at a specific moment.
   * We rely on Intl to hand us either PDT/PST or a GMT offset string.
   */
  function getPacificOffsetMinutes(date) {
    const parts = new Intl.DateTimeFormat('en-US', {
      timeZone: PACIFIC_TIMEZONE,
      timeZoneName: 'short'
    }).formatToParts(date);

    const tzName = parts.find(part => part.type === 'timeZoneName')?.value || 'PST';

    if (tzName.includes('PDT')) return 420; // UTC-7
    if (tzName.includes('PST')) return 480; // UTC-8

    const gmtMatch = tzName.match(/GMT([+-]\d{2})(\d{2})?/i);
    if (gmtMatch) {
      const hours = parseInt(gmtMatch[1], 10);
      const minutes = gmtMatch[2] ? parseInt(gmtMatch[2], 10) : 0;
      return Math.abs(hours) * 60 + minutes;
    }

    // Default to standard time if we hit an unexpected string.
    return 480;
  }

  /**
   * Create a Date that represents a Pacific-local wall clock time by
   * translating the supplied components into the correct UTC instant.
   * We default to 12:00 (noon) to avoid DST edge cases right at midnight.
   */
  function createPacificDate(year, month, day, hour = 12, minute = 0, second = 0) {
    const utcMillis = Date.UTC(year, month - 1, day, hour, minute, second);
    const tempUtcDate = new Date(utcMillis);
    const offsetMinutes = getPacificOffsetMinutes(tempUtcDate);
    return new Date(utcMillis + offsetMinutes * 60000);
  }

  /**
   * Convert any JS Date into a Pacific-local date (defaulting to midday).
   */
  function getPacificMidday(date = new Date()) {
    const parts = new Intl.DateTimeFormat('en-US', {
      timeZone: PACIFIC_TIMEZONE,
      year: 'numeric',
      month: '2-digit',
      day: '2-digit'
    }).formatToParts(date);

    const year = Number(parts.find(part => part.type === 'year')?.value);
    const month = Number(parts.find(part => part.type === 'month')?.value);
    const day = Number(parts.find(part => part.type === 'day')?.value);

    return createPacificDate(year, month, day, 12, 0, 0);
  }

  /**
   * Parse a YYYY-MM-DD string into a Pacific-local Date (midday).
   */
  function parsePacificDate(dateString) {
    if (!dateString) return null;
    const [year, month, day] = dateString.split('-').map(Number);
    if (!year || !month || !day) return null;
    return createPacificDate(year, month, day, 12, 0, 0);
  }

  /**
   * Format a Date as YYYY-MM-DD in Pacific time.
   */
  function formatPacificDate(date) {
    if (!date) return '';
    const parts = new Intl.DateTimeFormat('en-US', {
      timeZone: PACIFIC_TIMEZONE,
      year: 'numeric',
      month: '2-digit',
      day: '2-digit'
    }).formatToParts(date);

    const year = parts.find(part => part.type === 'year')?.value;
    const month = parts.find(part => part.type === 'month')?.value;
    const day = parts.find(part => part.type === 'day')?.value;

    return `${year}-${month}-${day}`;
  }

  /**
   * Format helper for display strings while forcing Pacific timezone.
   */
  function formatPacificDateDisplay(date, options = {}) {
    if (!date) return '';
    return new Intl.DateTimeFormat('en-US', {
      timeZone: PACIFIC_TIMEZONE,
      ...options
    }).format(date);
  }

  function formatPacificWeekday(date) {
    return formatPacificDateDisplay(date, { weekday: 'long' });
  }

  function getPacificHour(date) {
    if (!date) return null;
    const hourString = new Intl.DateTimeFormat('en-US', {
      timeZone: PACIFIC_TIMEZONE,
      hour: '2-digit',
      hour12: false
    }).format(date);
    return Number(hourString);
  }

  /**
   * Add days to a Pacific Date and return the normalized Pacific midday Date.
   */
  function addPacificDays(date, days) {
    if (!date) return null;
    const pacificMidday = getPacificMidday(date);
    const nextUtc = new Date(pacificMidday.getTime() + days * 86400000);
    return getPacificMidday(nextUtc);
  }

  /**
   * Return the current Pacific date as YYYY-MM-DD (optionally pass a Date).
   */
  function getPacificDate(date = new Date()) {
    return formatPacificDate(date);
  }
  
  function showMessage(text, type) {
    // Only show popups for important messages (errors), ignore info/success
    if (type === 'error') {
      showPopupMessage(text, type);
    }
    // Silently ignore info and success messages to prevent bouncing
  }
  
  function showPopupMessage(text, type) {
    const messageType = type === 'error' ? 'Error' : type === 'success' ? 'Success' : 'Notice';
    const backgroundColor = type === 'error' ? '#f44336' : '#4CAF50';
    const iconEmoji = '';
    
    const modalHTML = `
      <div id="messageModal" style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.7);
        z-index: 10000;
        display: flex;
        justify-content: center;
        align-items: center;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      ">
        <div style="
          background: white;
          padding: 30px;
          border-radius: 0;
          box-shadow: 0 10px 30px rgba(0,0,0,0.3);
          max-width: 400px;
          width: 90%;
          text-align: center;
        ">
          <h3 style="margin: 0 0 20px 0; color: ${backgroundColor};">${iconEmoji} ${messageType}</h3>
          <p style="margin: 0 0 25px 0; line-height: 1.4; font-size: 16px;">
            ${text}
          </p>
          <button onclick="closeMessageModal()" style="
            background: ${backgroundColor};
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 0;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
          ">OK</button>
        </div>
      </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
  }
  
  function closeMessageModal() {
    const modal = document.getElementById('messageModal');
    if (modal) {
      modal.remove();
    }
  }
  
  function validateDateChange(inputElement) {
    const selectedDate = inputElement.value;
    const currentDate = getPacificDate();
    
    // If user selects current date, allow it
    if (selectedDate === currentDate) {
      return true;
    }
    
    // If user selects different date, require password using custom modal
    return new Promise((resolve) => {
      showPasswordModal(selectedDate, currentDate, (success) => {
        if (!success) {
          inputElement.value = currentDate;
        }
        resolve(success);
      });
    });
  }
  
  function showPasswordModal(selectedDate, currentDate, callback) {
    // Create modal HTML
    const modalHTML = `
      <div id="passwordModal" style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.7);
        z-index: 10000;
        display: flex;
        justify-content: center;
        align-items: center;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      ">
        <div style="
          background: white;
          padding: 30px;
          border-radius: 0;
          box-shadow: 0 10px 30px rgba(0,0,0,0.3);
          max-width: 400px;
          width: 90%;
          text-align: center;
        ">
          <h3 style="margin: 0 0 20px 0; color: #d32f2f;">Date Change Warning</h3>
          <p style="margin: 0 0 15px 0; line-height: 1.4;">
            You are trying to change the date from<br>
            <strong>TODAY (${currentDate})</strong> to <strong>${selectedDate}</strong>
          </p>
          <p style="margin: 0 0 20px 0; color: #d32f2f; font-weight: bold;">
            This could overwrite existing data!
          </p>
          <p style="margin: 0 0 15px 0;">Enter admin password to continue:</p>
          <input type="password" id="passwordInput" style="
            width: 80%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 0;
            font-size: 16px;
            text-align: center;
            margin-bottom: 20px;
          " placeholder="Password">
          <div>
            <button onclick="submitPassword()" style="
              background: var(--gray-700);
              color: white;
              border: none;
              padding: 10px 20px;
              border-radius: 0;
              margin: 0 10px;
              cursor: pointer;
              font-size: 16px;
            ">Continue</button>
            <button onclick="cancelPassword()" style="
              background: var(--error);
              color: white;
              border: none;
              padding: 10px 20px;
              border-radius: 0;
              margin: 0 10px;
              cursor: pointer;
              font-size: 16px;
            ">Cancel</button>
          </div>
        </div>
      </div>
    `;
    
    // Add modal to page
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // Focus password input
    document.getElementById('passwordInput').focus();
    
    // Store callback for button handlers
    window.passwordModalCallback = callback;
    
    // Add enter key support
    document.getElementById('passwordInput').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        submitPassword();
      }
    });
  }
  
  function submitPassword() {
    const password = document.getElementById('passwordInput').value;
    const modal = document.getElementById('passwordModal');
    
    if (password === ADMIN_PASSWORD) {
      // Silent success - no bouncing message
      modal.remove();
      window.passwordModalCallback(true);
    } else {
      showMessage('Incorrect password. Date has been reset to today for safety.', 'error');
      modal.remove();
      window.passwordModalCallback(false);
    }
  }
  
  function cancelPassword() {
    const modal = document.getElementById('passwordModal');
    modal.remove();
    window.passwordModalCallback(false);
  }

  // General password protection function for manager features
  function requirePasswordFor(featureName, callback) {
    // Check if we have a valid session first
    if (isManagerSessionValid()) {
      // Session is valid, proceed directly
      callback();
      return;
    }

    // No valid session, show password modal
    showManagerPasswordModal(featureName, callback);
  }

  // Catering access function - redirects to catering.html with session persistence
  function accessCatering() {
    window.location.href = 'catering.html';
  }

  function showManagerPasswordModal(featureName, callback) {
    // Create modal HTML for manager features
    const modalHTML = `
      <div id="passwordModal" style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.7);
        z-index: 10000;
        display: flex;
        justify-content: center;
        align-items: center;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      ">
        <div style="
          background: white;
          padding: 30px;
          border-radius: 0;
          box-shadow: 0 10px 30px rgba(0,0,0,0.3);
          max-width: 400px;
          width: 90%;
          text-align: center;
        ">
          <h3 style="margin: 0 0 20px 0; color: #d32f2f;">Manager Access Required</h3>
          <p style="margin: 0 0 15px 0; line-height: 1.4;">
            <strong>${featureName}</strong> requires manager authorization.
          </p>
          <p style="margin: 0 0 20px 0; color: #666;">
            This feature contains sensitive financial data and management tools.
          </p>
          <p style="margin: 0 0 15px 0;">Enter manager password:</p>
          <input type="password" id="passwordInput" style="
            width: 80%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 0;
            font-size: 16px;
            text-align: center;
            margin-bottom: 20px;
          " placeholder="Manager Password">
          <div>
            <button onclick="submitManagerPassword()" style="
              background: var(--gray-700);
              color: white;
              border: none;
              padding: 10px 20px;
              border-radius: 0;
              margin: 0 10px;
              cursor: pointer;
              font-size: 16px;
            ">Access ${featureName}</button>
            <button onclick="cancelManagerPassword()" style="
              background: var(--error);
              color: white;
              border: none;
              padding: 10px 20px;
              border-radius: 0;
              margin: 0 10px;
              cursor: pointer;
              font-size: 16px;
            ">Cancel</button>
          </div>
        </div>
      </div>
    `;
    
    // Add modal to page
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // Focus password input
    document.getElementById('passwordInput').focus();
    
    // Store callback for button handlers
    window.managerPasswordCallback = callback;
    
    // Add enter key support
    document.getElementById('passwordInput').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        submitManagerPassword();
      }
    });
  }

  function submitManagerPassword() {
    const password = document.getElementById('passwordInput').value;
    const modal = document.getElementById('passwordModal');
    
    if (password === ADMIN_PASSWORD) {
      // Success - set manager session and execute the protected function
      setManagerSession();
      modal.remove();
      showMessage('Manager access granted for 1 hour', 'success');
      // Update the session status display immediately
      updateSessionStatus();
      window.managerPasswordCallback();
    } else {
      showMessage('Incorrect manager password. Access denied.', 'error');
      modal.remove();
    }
  }

  function cancelManagerPassword() {
    const modal = document.getElementById('passwordModal');
    modal.remove();
    // Don't call callback on cancel
  }
  
  function logoutManager() {
    clearManagerSession();
    updateSessionStatus();
    showMessage('Manager session ended', 'success');
  }
  
  function updateSessionStatus() {
    const statusElement = document.getElementById('sessionStatus');
    const logoutBtn = document.getElementById('logoutBtn');
    
    if (!statusElement || !logoutBtn) return; // Elements not ready yet
    
    if (isManagerSessionValid()) {
      const sessionExpiry = localStorage.getItem('managerSession');
      const expiryTime = parseInt(sessionExpiry);
      const now = new Date().getTime();
      const remainingMinutes = Math.ceil((expiryTime - now) / (60 * 1000));
      
      statusElement.textContent = `Manager access: ${remainingMinutes} min remaining`;
      statusElement.style.color = '#28a745';
      logoutBtn.style.display = 'inline-block';
    } else {
      statusElement.textContent = 'Staff access mode';
      statusElement.style.color = '#666';
      logoutBtn.style.display = 'none';
    }
  }
  
  // Update session status every minute
  setInterval(updateSessionStatus, 60000);
  
  // Initialize session status when page loads
  window.addEventListener('load', function() {
    setTimeout(updateSessionStatus, 100); // Small delay to ensure DOM is ready
  });
  
  function logoutManager() {
    clearManagerSession();
    updateSessionStatus();
    showMessage('Manager session ended', 'success');
  }
  
  function updateSessionStatus() {
    const statusElement = document.getElementById('sessionStatus');
    const logoutBtn = document.getElementById('logoutBtn');
    
    if (isManagerSessionValid()) {
      const sessionExpiry = localStorage.getItem('managerSession');
      const expiryTime = parseInt(sessionExpiry);
      const now = new Date().getTime();
      const remainingMinutes = Math.ceil((expiryTime - now) / (60 * 1000));
      
      statusElement.textContent = `Manager access: ${remainingMinutes} min remaining`;
      statusElement.style.color = '#28a745';
      logoutBtn.style.display = 'inline-block';
    } else {
      statusElement.textContent = 'Staff access mode';
      statusElement.style.color = '#666';
      logoutBtn.style.display = 'none';
    }
  }
  
  // Update session status every minute
  setInterval(updateSessionStatus, 60000);
  
  // Update session status on page load
  document.addEventListener('DOMContentLoaded', updateSessionStatus);

  function hideAllSections() {
    console.log('hideAllSections() called - this might be hiding tip pool results!');
    console.trace('hideAllSections call stack');
    document.querySelectorAll('.form-section').forEach(section => section.classList.remove('active'));
  }
  
  function goHome() {
    console.log('goHome() called - this will hide tip pool results!');
    console.trace('goHome call stack');
    hideAllSections();
    document.getElementById('mainMenu').style.display = 'grid';
    
    // Reset container width
    const container = document.querySelector('.container');
    if (container) {
      container.style.maxWidth = '600px';
    }
  }

  // Toast API Integration
  let autoCalculatedToastAmount = 0;
  
  async function fetchToastCashSales() {
    // Use today's date by default
    const today = new Date();
    const businessDate = formatDateForToast(today);
    await fetchToastCashSalesForDate(businessDate);
  }

  async function fetchToastCashSalesForDate(dateInput) {
    // Show loading state
    document.getElementById('autoToastAmount').textContent = 'Loading...';
    document.getElementById('autoToastDetails').textContent = 'Fetching live data from Toast API...';
    
    try {
      // Handle both date string (YYYY-MM-DD) and formatted date (YYYYMMDD)
      let businessDate;
      if (dateInput.includes('-')) {
        // Convert YYYY-MM-DD to YYYYMMDD
        const dateObj = new Date(dateInput + 'T12:00:00'); // Add time to avoid timezone issues
        businessDate = formatDateForToast(dateObj);
      } else {
        // Already in YYYYMMDD format
        businessDate = dateInput;
      }
      
      console.log('Auto-fetching Toast cash sales for:', businessDate);
      
      // First authenticate with Toast
      const authResponse = await fetch('/api/toast-auth', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      });
      
      if (!authResponse.ok) {
        throw new Error('Failed to authenticate with Toast API');
      }
      
      const authData = await authResponse.json();
      if (!authData.success || !authData.data?.accessToken) {
        throw new Error('Toast authentication failed');
      }
      
      // Fetch cash sales using payments API
      const paymentsUrl = `/api/toast-payments?businessDate=${businessDate}&token=${encodeURIComponent(authData.data.accessToken)}`;
      const paymentsResponse = await fetch(paymentsUrl);
      
      if (!paymentsResponse.ok) {
        throw new Error('Failed to fetch Toast payments data');
      }
      
      const paymentsData = await paymentsResponse.json();
      if (!paymentsData.success) {
        throw new Error(paymentsData.error || 'Toast payments API returned an error');
      }
      
      // Store the auto-calculated amount
      autoCalculatedToastAmount = paymentsData.totalCashAmount;
      
      // Update the hidden field for form processing
      document.getElementById('toastSales').value = autoCalculatedToastAmount.toFixed(2);
      
      // Show success result
      document.getElementById('autoToastAmount').textContent = `$${autoCalculatedToastAmount.toFixed(2)}`;
      document.getElementById('autoToastDetails').textContent = 
        `${paymentsData.totalCashPayments} cash payments • ${paymentsData.totalPaymentGuids} total transactions • Auto-synced`;
      
      console.log('Toast cash sales auto-fetched successfully:', autoCalculatedToastAmount);
      
      // Trigger discrepancy validation if we're in PM mode
      const pmGrandTotal = document.getElementById('pmGrandTotal');
      if (pmGrandTotal && pmGrandTotal.textContent !== '$0.00') {
        const pmTotal = parseFloat(pmGrandTotal.textContent.replace('$', '').replace(',', '')) || 0;
        validatePMDiscrepancy(pmTotal);
      }
      
    } catch (error) {
      console.error('Toast API auto-fetch error:', error);
      
      // Show error state but don't provide fallback
      document.getElementById('autoToastAmount').textContent = 'API Error';
      document.getElementById('autoToastDetails').textContent = 
        `Failed to fetch: ${error.message} • Please check internet connection and try again`;
      
      // Reset auto amount
      autoCalculatedToastAmount = 0;
      document.getElementById('toastSales').value = '0';
    }
  }

  function formatDateForToast(date) {
    // Convert to YYYYMMDD format for Toast API
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}${month}${day}`;
  }
  
  function startAMCount() {
    // Keep main menu visible at top
    hideAllSections();
    document.getElementById('amForm').classList.add('active');
    setupDenominations('am');
  }
  
  async function startPMCount() {
    // Keep main menu visible at top
    hideAllSections();
    document.getElementById('pmForm').classList.add('active');
    setupDenominations('pm');

    await loadAMData();

    // Automatically fetch Toast cash sales when PM section loads
    console.log('PM Count started - automatically fetching Toast cash sales...');
    try {
      await fetchToastCashSales();
    } catch (error) {
      console.error('Auto-fetch Toast sales failed:', error);
      // Don't block the UI - user can still proceed manually if needed
    }
  }

  /**
   * Smart Cash Button - Time-based AM/PM flow with password protection
   * 7AM-7PM PT: AM Count
   * 7PM-2AM PT: PM Close
   * 2AM-7AM PT: No flow available
   */
  function startSmartCashFlow() {
    // Check if session is valid
    if (isCashSessionValid()) {
      // Session valid, proceed directly
      loadCashFlowByTime();
      return;
    }

    // No valid session, show password modal
    showCashPasswordModal();
  }

  function showCashPasswordModal() {
    const modal = document.createElement('div');
    modal.id = 'cashPasswordModal'; // Add unique ID for safe removal
    modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10000;';

    modal.innerHTML = `
      <div style="background: white; padding: 40px; border-radius: 0; border: 3px solid var(--gray-700); max-width: 400px; width: 90%;">
        <h3 style="margin: 0 0 20px 0; font-size: 18px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;">Cash Flow Access</h3>
        <p style="margin-bottom: 20px; color: var(--gray-700); font-size: 13px;">Enter password to access cash counting:</p>
        <input type="password" id="cashPasswordInput" placeholder="Enter password" style="width: 100%; padding: 12px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 14px; margin-bottom: 20px; box-sizing: border-box;" />
        <div style="display: flex; gap: 12px;">
          <button onclick="closeCashPasswordModal()" style="flex: 1; padding: 12px 24px; background: var(--gray-100); border: 2px solid var(--gray-300); color: var(--gray-900); font-size: 13px; font-weight: 700; cursor: pointer; text-transform: uppercase; letter-spacing: 0.5px;">Cancel</button>
          <button onclick="verifyCashPassword()" style="flex: 1; padding: 12px 24px; background: var(--gray-900); border: 2px solid var(--gray-900); color: white; font-size: 13px; font-weight: 700; cursor: pointer; text-transform: uppercase; letter-spacing: 0.5px;">Submit</button>
        </div>
      </div>
    `;

    document.body.appendChild(modal);

    // Focus password input
    setTimeout(() => {
      document.getElementById('cashPasswordInput').focus();
    }, 100);

    // Add enter key support
    document.getElementById('cashPasswordInput').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        verifyCashPassword();
      }
    });
  }

  function closeCashPasswordModal() {
    const modal = document.getElementById('cashPasswordModal');
    if (modal && modal.parentNode) {
      modal.parentNode.removeChild(modal);
    }
  }

  function verifyCashPassword() {
    const input = document.getElementById('cashPasswordInput');
    if (!input) {
      console.error('Cash password input not found');
      return;
    }

    const password = input.value;

    if (password === CASH_PASSWORD) {
      // Set 30-minute session
      setCashSession();

      // Remove modal
      closeCashPasswordModal();

      // Load appropriate flow
      loadCashFlowByTime();
    } else {
      showMessage('Incorrect password. Access denied.', 'error');
      closeCashPasswordModal();
    }
  }

  function loadCashFlowByTime() {
    // Get Pacific time
    const now = new Date();
    const pacificTime = new Date(now.toLocaleString('en-US', { timeZone: 'America/Los_Angeles' }));
    const hour = pacificTime.getHours();

    console.log(`Smart Cash Flow: Pacific hour is ${hour}`);

    // 7AM-7PM (07:00-19:00): AM Count
    if (hour >= 7 && hour < 19) {
      console.log('Loading AM Count (7AM-7PM)');
      startAMCount();
    }
    // 7PM-2AM (19:00-02:00): PM Close
    else if (hour >= 19 || hour < 2) {
      console.log('Loading PM Close (7PM-2AM)');
      startPMCount();
    }
    // 2AM-7AM: No flow available
    else {
      console.log('No cash flow available (2AM-7AM)');
      showMessage('Cash counting is not available at this time. Please try between 7:00 AM and 2:00 AM Pacific Time.', 'error');
    }
  }
  
  function showReports() {
    // Keep main menu visible at top
    hideAllSections();
    document.getElementById('reportsForm').classList.add('active');
  }
  
  function showTipPool() {
    // Keep main menu visible at top
    hideAllSections();
    document.getElementById('tipPoolForm').classList.add('active');
    
    // Show results if we have loaded data
    if (tipPoolRecords.length > 0) {
      document.getElementById('tipPoolResults').style.display = 'block';
      document.getElementById('tipPoolPdfBtn').style.display = 'inline-block';
      document.getElementById('combinedReportSection').style.display = 'block';
    }
  }
  
  // ===== CASHBOX FUNCTIONS =====
  
  function showCashbox() {
    // Keep main menu visible at top
    hideAllSections();
    document.getElementById('cashboxSection').classList.add('active');
    loadPreviousCashboxData();
  }
  
  function toggleCashboxDenominationInputs() {
    const counterSelect = document.getElementById('cashboxCounter');
    const otherNameGroup = document.getElementById('cashboxOtherNameGroup');
    const denominationInputs = document.getElementById('cashboxDenominationInputs');
    
    if (counterSelect.value === 'Other') {
      otherNameGroup.style.display = 'block';
    } else {
      otherNameGroup.style.display = 'none';
    }
    
    if (counterSelect.value && counterSelect.value !== '') {
      denominationInputs.style.display = 'block';
    } else {
      denominationInputs.style.display = 'none';
    }
  }
  
  function calculateCashboxTotal() {
    const denominations = [
      { id: 'cashbox_hundreds', value: 100 },
      { id: 'cashbox_fifties', value: 50 },
      { id: 'cashbox_twenties', value: 20 },
      { id: 'cashbox_tens', value: 10 },
      { id: 'cashbox_fives', value: 5 },
      { id: 'cashbox_ones', value: 1 },
      { id: 'cashbox_quarters', value: 0.25 },
      { id: 'cashbox_dimes', value: 0.10 },
      { id: 'cashbox_nickels', value: 0.05 },
      { id: 'cashbox_pennies', value: 0.01 }
    ];
    
    let total = 0;
    denominations.forEach(denom => {
      const count = parseInt(document.getElementById(denom.id).value) || 0;
      total += count * denom.value;
    });
    
    document.getElementById('cashboxTotal').textContent = `$${total.toFixed(2)}`;
    return total;
  }
  
  async function loadPreviousCashboxData() {
    try {
      // Get the most recent cashbox count for reconciliation
      const { data, error } = await supabase
        .from('cashbox_counts')
        .select('*')
        .order('date', { ascending: false })
        .limit(1);
      
      if (error) throw error;
      
      if (data && data.length > 0) {
        const lastCount = data[0];
        showReconciliation(lastCount);
      }
    } catch (error) {
      console.error('Error loading previous cashbox data:', error);
    }
  }
  
  function showReconciliation(lastCount) {
    const reconciliationSection = document.getElementById('cashboxReconciliation');
    const reconciliationDetails = document.getElementById('reconciliationDetails');

    const lastDate = new Date(lastCount.date).toLocaleDateString();
    const lastAmount = lastCount.total;

    reconciliationDetails.innerHTML = `
      <div style="margin-bottom: 10px;">
        <strong>Previous Cashbox Count:</strong> ${lastDate} - $${lastAmount.toFixed(2)}
      </div>
      <div style="margin-bottom: 10px; font-size: 12px; color: #856404;">
        <strong>Reconciliation Logic:</strong><br>
        Expected This Week = Previous Week + Daily Discrepancies<br>
        <em>Note: AM register loading amounts do not affect total cashbox reconciliation</em>
      </div>
      <div style="font-size: 12px; color: #856404;">
        After entering your count, we'll calculate discrepancies and verify reconciliation.
      </div>
    `;

    reconciliationSection.style.display = 'block';
  }

  // Tip Pool Cashbox Functions (separate from main cashbox counting)
  function toggleTipPoolCashboxInputs() {
    const counterSelect = document.getElementById('tipPoolCashboxCounter');
    const otherNameGroup = document.getElementById('tipPoolCashboxOtherNameGroup');
    const denominationInputs = document.getElementById('tipPoolCashboxDenominationInputs');

    if (counterSelect.value === 'Other') {
      otherNameGroup.style.display = 'block';
    } else {
      otherNameGroup.style.display = 'none';
    }

    if (counterSelect.value && counterSelect.value !== '') {
      denominationInputs.style.display = 'block';
    } else {
      denominationInputs.style.display = 'none';
    }
  }

  function calculateTipPoolCashboxTotal() {
    const denominations = [
      { id: 'tipPool_cashbox_hundreds', value: 100 },
      { id: 'tipPool_cashbox_fifties', value: 50 },
      { id: 'tipPool_cashbox_twenties', value: 20 },
      { id: 'tipPool_cashbox_tens', value: 10 },
      { id: 'tipPool_cashbox_fives', value: 5 },
      { id: 'tipPool_cashbox_ones', value: 1 },
      { id: 'tipPool_cashbox_quarters', value: 0.25 },
      { id: 'tipPool_cashbox_dimes', value: 0.10 },
      { id: 'tipPool_cashbox_nickels', value: 0.05 },
      { id: 'tipPool_cashbox_pennies', value: 0.01 }
    ];

    let total = 0;
    denominations.forEach(denom => {
      const count = parseInt(document.getElementById(denom.id).value) || 0;
      total += count * denom.value;
    });

    document.getElementById('tipPoolCashboxTotal').textContent = `$${total.toFixed(2)}`;
    return total;
  }

  function getTipPoolCashboxData() {
    // Get counter name
    const counterSelect = document.getElementById('tipPoolCashboxCounter');
    let counterName = counterSelect.value;

    if (counterName === 'Other') {
      counterName = document.getElementById('tipPoolCashboxOtherName').value;
    }

    // If no counter selected, return null (optional feature)
    if (!counterName) {
      return null;
    }

    // Get total
    const total = calculateTipPoolCashboxTotal();

    // If total is 0, return null
    if (total === 0) {
      return null;
    }

    // Get denominations
    const denominations = {
      hundreds: parseInt(document.getElementById('tipPool_cashbox_hundreds').value) || 0,
      fifties: parseInt(document.getElementById('tipPool_cashbox_fifties').value) || 0,
      twenties: parseInt(document.getElementById('tipPool_cashbox_twenties').value) || 0,
      tens: parseInt(document.getElementById('tipPool_cashbox_tens').value) || 0,
      fives: parseInt(document.getElementById('tipPool_cashbox_fives').value) || 0,
      ones: parseInt(document.getElementById('tipPool_cashbox_ones').value) || 0,
      quarters: parseInt(document.getElementById('tipPool_cashbox_quarters').value) || 0,
      dimes: parseInt(document.getElementById('tipPool_cashbox_dimes').value) || 0,
      nickels: parseInt(document.getElementById('tipPool_cashbox_nickels').value) || 0,
      pennies: parseInt(document.getElementById('tipPool_cashbox_pennies').value) || 0
    };

    return {
      counter: counterName,
      total: total,
      denominations: denominations,
      date: getPacificDate()
    };
  }

  async function saveCashboxCountFromTipPool(cashboxData) {
    try {
      console.log('💾 Saving cashbox count from tip pool:', cashboxData);

      // Save to database
      const { data, error } = await supabase
        .from('cashbox_counts')
        .insert([{
          date: cashboxData.date,
          counter: cashboxData.counter,
          total: cashboxData.total,
          denominations: cashboxData.denominations,
          notes: 'Entered from tip pool calculator'
        }]);

      if (error) {
        // Check if it's a duplicate date error
        if (error.code === '23505') {
          console.log('⚠️ Cashbox count already exists for this date, updating instead...');
          const { data: updateData, error: updateError } = await supabase
            .from('cashbox_counts')
            .update({
              counter: cashboxData.counter,
              total: cashboxData.total,
              denominations: cashboxData.denominations,
              notes: 'Updated from tip pool calculator'
            })
            .eq('date', cashboxData.date);

          if (updateError) throw updateError;
          console.log('✅ Cashbox count updated successfully');
        } else {
          throw error;
        }
      } else {
        console.log('✅ Cashbox count saved successfully');
      }

      return cashboxData.total;
    } catch (error) {
      console.error('❌ Error saving cashbox count:', error);
      throw error;
    }
  }

  async function saveCashboxCount() {
    try {
      const counterSelect = document.getElementById('cashboxCounter');
      const otherName = document.getElementById('cashboxOtherName').value;
      
      let counterName = counterSelect.value;
      if (counterName === 'Other') {
        counterName = otherName;
      }
      
      if (!counterName) {
        throw new Error('Please select or enter a name');
      }
      
      const total = calculateCashboxTotal();
      if (total === 0) {
        throw new Error('Please enter denomination counts');
      }
      
      const denominations = {
        hundreds: parseInt(document.getElementById('cashbox_hundreds').value) || 0,
        fifties: parseInt(document.getElementById('cashbox_fifties').value) || 0,
        twenties: parseInt(document.getElementById('cashbox_twenties').value) || 0,
        tens: parseInt(document.getElementById('cashbox_tens').value) || 0,
        fives: parseInt(document.getElementById('cashbox_fives').value) || 0,
        ones: parseInt(document.getElementById('cashbox_ones').value) || 0,
        quarters: parseInt(document.getElementById('cashbox_quarters').value) || 0,
        dimes: parseInt(document.getElementById('cashbox_dimes').value) || 0,
        nickels: parseInt(document.getElementById('cashbox_nickels').value) || 0,
        pennies: parseInt(document.getElementById('cashbox_pennies').value) || 0
      };
      
      const { data, error } = await supabase
        .from('cashbox_counts')
        .insert([{
          date: getPacificDate(),
          counter: counterName,
          denominations: denominations,
          total: total,
          timestamp: new Date().toISOString()
        }]);
      
      if (error) throw error;
      
      showMessage(`Cashbox count saved successfully! Total: $${total.toFixed(2)}`, 'success');
      
      // Reset form
      document.getElementById('cashboxCounter').value = '';
      document.getElementById('cashboxOtherName').value = '';
      toggleCashboxDenominationInputs();
      
      // Reset all denomination inputs
      Object.keys(denominations).forEach(key => {
        document.getElementById(`cashbox_${key}`).value = '0';
      });
      calculateCashboxTotal();
      
    } catch (error) {
      showMessage(error.message, 'error');
    }
  }
  
  async function saveCashboxCountFromReport(total) {
    try {
      const counterName = tipPoolSummary.calculatedByName || 'Unknown';
      
      const { data, error } = await supabase
        .from('cashbox_counts')
        .insert([{
          date: getPacificDate(),
          counter: counterName,
          denominations: { manual_entry: true }, // Mark as manual entry from report
          total: total,
          timestamp: new Date().toISOString(),
          notes: 'Entered during combined report generation'
        }]);
      
      if (error) throw error;
      
      console.log('Cashbox count saved from report:', total);
      
    } catch (error) {
      console.error('Error saving cashbox count from report:', error);
    }
  }
  
  async function getCashboxReconciliation(currentTotal) {
    try {
      // Get the two most recent cashbox counts for comparison
      const { data, error } = await supabase
        .from('cashbox_counts')
        .select('*')
        .order('date', { ascending: false })
        .limit(2);
      
      if (error) throw error;
      
      if (!data || data.length === 0) {
        return {
          isFirstCount: true,
          currentTotal: currentTotal,
          message: 'First cashbox count recorded - baseline established'
        };
      }
      
      if (data.length === 1) {
        return {
          isFirstCount: true,
          currentTotal: currentTotal,
          previousTotal: null,
          message: 'Second cashbox count - reconciliation will begin next week'
        };
      }
      
      const current = data[0]; // Most recent (just saved)
      const previous = data[1]; // Previous week
      
      // Get date range for daily discrepancies between the two cashbox counts
      const startDate = new Date(previous.date);
      const endDate = new Date(current.date);
      
      // Fetch daily cash count data for the period (need more fields for Excess calculation)
      const { data: discrepancyData, error: discrepancyError } = await supabase
        .from('cash_counts')
        .select('pm_discrepancy, pm_amount_to_keep, am_total, date')
        .gte('date', previous.date)
        .lt('date', current.date) // Use < to exclude current date
        .not('pm_discrepancy', 'is', null)
        .order('date', { ascending: true });

      if (discrepancyError) throw discrepancyError;

      // Calculate total discrepancies for the period
      const totalDiscrepancies = discrepancyData ?
        discrepancyData.reduce((sum, day) => sum + (day.pm_discrepancy || 0), 0) : 0;

      // CRITICAL FIX: Calculate total Excess returned to cashbox
      // Excess = Net change to cashbox each day (what went back in minus what came out)
      // Formula: (pm_amount_to_keep) - (am_total)
      // Positive excess = cash returned to box, Negative excess = cash taken from box
      const totalExcessReturned = discrepancyData ?
        discrepancyData.reduce((sum, day) => {
          const pmKeep = day.pm_amount_to_keep || 0;
          const amTotal = day.am_total || 0;
          const dailyExcess = pmKeep - amTotal;
          return sum + dailyExcess;
        }, 0) : 0;

      console.log('📊 Cashbox Reconciliation Breakdown:');
      console.log(`   Previous Week Total: $${previous.total.toFixed(2)}`);
      console.log(`   Total Discrepancies: $${totalDiscrepancies.toFixed(2)}`);
      console.log(`   Total Excess Returned: $${totalExcessReturned.toFixed(2)}`);

      // CORRECT RECONCILIATION FORMULA (FIXED):
      // Week_N_Ending_Cashbox = Week_N_Starting_Cashbox + Sum(Daily_Discrepancies) + Sum(Daily_Excess)
      // This accounts for BOTH daily over/under AND actual cash flow in/out of cashbox
      const expectedEnding = previous.total + totalDiscrepancies + totalExcessReturned;
      const actualVariance = currentTotal - expectedEnding;

      console.log(`   Expected Ending: $${expectedEnding.toFixed(2)}`);
      console.log(`   Actual Ending: $${currentTotal.toFixed(2)}`);
      console.log(`   Variance: $${actualVariance.toFixed(2)}`);
      
      return {
        isFirstCount: false,
        currentTotal: currentTotal,
        currentDate: new Date(current.date).toLocaleDateString(),
        previousTotal: previous.total,
        previousDate: new Date(previous.date).toLocaleDateString(),
        totalDiscrepancies: totalDiscrepancies,
        totalExcessReturned: totalExcessReturned, // NEW: Include Excess in return object
        expectedEnding: expectedEnding,
        actualVariance: actualVariance,
        discrepancyDays: discrepancyData ? discrepancyData.length : 0,
        reconciliationStatus: Math.abs(actualVariance) < 0.01 ? 'BALANCED' :
                             actualVariance > 0 ? 'OVERAGE' : 'SHORTAGE',
        message: Math.abs(actualVariance) < 0.01 ?
                'Perfect reconciliation! Cashbox balances correctly.' :
                actualVariance > 0 ?
                `Unexplained overage of $${actualVariance.toFixed(2)}` :
                `Unexplained shortage of $${Math.abs(actualVariance).toFixed(2)}`
      };
      
    } catch (error) {
      console.error('Error getting cashbox reconciliation:', error);
      return null;
    }
  }
  
  function setupDenominations(shift) {
    [1, 2].forEach(drawer => {
      const container = document.getElementById(`${shift}Drawer${drawer}Denoms`);
      container.innerHTML = '';
      
      DENOMINATIONS.forEach((denom, index) => {
        const row = document.createElement('div');
        row.className = 'denom-row';
        row.innerHTML = `
          <div>
            <div class="denom-label">${denom.label}</div>
            <div class="denom-value" id="${shift}D${drawer}V${index}">0 × $${denom.value.toFixed(2)} = $0.00</div>
          </div>
          <input type="number" class="qty-input" id="${shift}D${drawer}Q${index}" 
                 min="0" step="1" value="0" 
                 inputmode="numeric" pattern="[0-9]*"
                 oninput="updateCalculations('${shift}', ${drawer})" 
                 onfocus="this.select()">
        `;
        container.appendChild(row);
      });
    });
    
    // Apply disabled state based on current name selection
    toggleDenominationInputs(shift);
  }
  
  function toggleSkip(shift, drawer) {
    const skipBox = document.getElementById(`${shift}Drawer${drawer}Skip`);
    const content = document.getElementById(`${shift}Drawer${drawer}Content`);
    const skipContent = document.getElementById(`${shift}Drawer${drawer}SkipContent`);
    
    if (skipBox.checked) {
      content.classList.add('hidden');
      skipContent.classList.remove('hidden');
    } else {
      content.classList.remove('hidden');
      skipContent.classList.add('hidden');
    }
    updateCalculations(shift, drawer);
  }
  
  function toggleDenominationInputs(shift) {
    const counterSelect = document.getElementById(`${shift}Counter`);
    if (!counterSelect) return; // Safety check
    
    const hasName = counterSelect.value.trim() !== '';
    
    // Toggle denomination inputs for both drawers
    for (let drawer = 1; drawer <= 2; drawer++) {
      DENOMINATIONS.forEach((denom, index) => {
        const qtyInput = document.getElementById(`${shift}D${drawer}Q${index}`);
        if (!qtyInput) return; // Safety check
        
        const denomRow = qtyInput.closest('.denom-row');
        if (!denomRow) return; // Safety check
        
        if (hasName) {
          qtyInput.disabled = false;
          denomRow.classList.remove('disabled');
        } else {
          qtyInput.disabled = true;
          qtyInput.value = ''; // Clear any existing values
          denomRow.classList.add('disabled');
        }
      });
      
      // Update calculations after enabling/disabling
      updateCalculations(shift, drawer);
    }
  }
  
  function updateCalculations(shift, drawer) {
    const skipBox = document.getElementById(`${shift}Drawer${drawer}Skip`);
    let drawerTotal = 0;
    
    if (!skipBox.checked) {
      DENOMINATIONS.forEach((denom, index) => {
        const qtyInput = document.getElementById(`${shift}D${drawer}Q${index}`);
        const qty = parseInt(qtyInput.value) || 0;
        const value = qty * denom.value;
        
        document.getElementById(`${shift}D${drawer}V${index}`).textContent = 
          `${qty} × $${denom.value.toFixed(2)} = $${value.toFixed(2)}`;
        
        drawerTotal += value;
      });
    }
    
    document.getElementById(`${shift}Drawer${drawer}Total`).textContent = `$${drawerTotal.toFixed(2)}`;
    updateGrandTotal(shift);
  }
  
  function updateGrandTotal(shift) {
    const drawer1Skip = document.getElementById(`${shift}Drawer1Skip`).checked;
    const drawer2Skip = document.getElementById(`${shift}Drawer2Skip`).checked;
    
    const drawer1Total = drawer1Skip ? 0 : parseFloat(document.getElementById(`${shift}Drawer1Total`).textContent.replace('$', ''));
    const drawer2Total = drawer2Skip ? 0 : parseFloat(document.getElementById(`${shift}Drawer2Total`).textContent.replace('$', ''));
    
    const grandTotal = drawer1Total + drawer2Total;
    document.getElementById(`${shift}GrandTotal`).textContent = `$${grandTotal.toFixed(2)}`;
    
    // Add discrepancy validation for PM shift only
    if (shift === 'pm') {
      validatePMDiscrepancy(grandTotal);
    }
  }

  function validatePMDiscrepancy(pmTotal) {
    const discrepancySection = document.getElementById('discrepancySection');
    const discrepancyDisplay = document.getElementById('discrepancyDisplay');
    
    // Get AM total and Toast sales
    const amTotalText = document.getElementById('pmAmTotal').textContent;
    const toastSales = autoCalculatedToastAmount || 0;
    
    // Only validate if we have all necessary data
    if (!amTotalText || amTotalText === 'Loading...' || amTotalText === 'Please select a date' || toastSales === 0) {
      discrepancySection.style.display = 'none';
      return;
    }
    
    const amTotal = parseFloat(amTotalText.replace('$', '').replace(',', '')) || 0;
    const netCashChange = pmTotal - amTotal; // This should equal Toast sales
    const discrepancy = netCashChange - toastSales;
    const absDiscrepancy = Math.abs(discrepancy);
    
    // Show the section
    discrepancySection.style.display = 'block';
    
    // Determine warning level and styling
    let borderColor, backgroundColor, textColor, warningLevel, warningMessage, warningIcon;
    
    if (absDiscrepancy <= 3) {
      // Good - within $3
      borderColor = '#28a745';
      backgroundColor = '#d4edda';
      textColor = '#155724';
      warningLevel = 'GOOD';
      warningMessage = 'Cash count matches Toast sales within acceptable range.';
      warningIcon = '';
    } else if (absDiscrepancy <= 10) {
      // Warning - $3-$10
      borderColor = '#ffc107';
      backgroundColor = '#fff3cd';
      textColor = '#856404';
      warningLevel = 'SUGGESTION';
      warningMessage = 'Consider recounting your cash to ensure accuracy, but you may proceed if confident.';
      warningIcon = '';
    } else {
      // Severe - over $10
      borderColor = '#dc3545';
      backgroundColor = '#f8d7da';
      textColor = '#721c24';
      warningLevel = 'IMPORTANT';
      warningMessage = 'Significant discrepancy detected. Please recount everything carefully or confirm you want to proceed.';
      warningIcon = '';
    }
    
    // Add special message for negative discrepancies
    let negativeWarning = '';
    if (discrepancy < 0) {
      negativeWarning = `<div style="background: rgba(220, 53, 69, 0.1); padding: 8px; border-radius: 0; font-size: 13px; margin-top: 10px;">
        <strong>Cash Tips Impact:</strong> This ${Math.abs(discrepancy).toFixed(2)} shortage will be deducted from cash tips. Please verify your count is accurate.
      </div>`;
    }
    
    discrepancyDisplay.style.border = `2px solid ${borderColor}`;
    discrepancyDisplay.style.background = backgroundColor;
    discrepancyDisplay.style.color = textColor;
    
    discrepancyDisplay.innerHTML = `
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <span style="font-weight: 700; font-size: 16px;">${warningIcon} Cash vs Toast Validation</span>
        <span style="background: ${borderColor}; color: white; padding: 6px 12px; border-radius: 0; font-size: 12px; font-weight: 600;">
          ${warningLevel}
        </span>
      </div>
      
      <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin: 15px 0; text-align: center;">
        <div>
          <div style="font-size: 12px; opacity: 0.8;">Net Cash Change</div>
          <div style="font-size: 24px; font-weight: bold;">$${netCashChange.toFixed(2)}</div>
          <div style="font-size: 11px; opacity: 0.7;">PM Total - AM Total</div>
        </div>
        <div>
          <div style="font-size: 12px; opacity: 0.8;">Toast Sales</div>
          <div style="font-size: 24px; font-weight: bold;">$${toastSales.toFixed(2)}</div>
          <div style="font-size: 11px; opacity: 0.7;">Expected Amount</div>
        </div>
        <div>
          <div style="font-size: 12px; opacity: 0.8;">Discrepancy</div>
          <div style="font-size: 24px; font-weight: bold; color: ${discrepancy >= 0 ? borderColor : '#dc3545'};">
            ${discrepancy >= 0 ? '+' : ''}$${discrepancy.toFixed(2)}
          </div>
          <div style="font-size: 11px; opacity: 0.7;">${discrepancy >= 0 ? 'Overage' : 'Shortage'}</div>
        </div>
      </div>
      
      <div style="background: rgba(${borderColor === '#28a745' ? '40, 167, 69' : borderColor === '#ffc107' ? '255, 193, 7' : '220, 53, 69'}, 0.1); padding: 10px; border-radius: 0; font-size: 13px; text-align: center;">
        <strong>${warningMessage}</strong>
      </div>
      
      ${negativeWarning}
    `;
  }
  
  async function loadAMData() {
    const date = document.getElementById('pmDate').value;
    console.log('Loading AM data for date:', date);
    
    if (!date) {
      document.getElementById('pmAmTotal').textContent = 'Please select a date';
      document.getElementById('amCounterName').textContent = 'Please select a date';
      document.getElementById('amCountTime').textContent = 'Please select a date';
      return;
    }
    
    // Show loading state
    document.getElementById('pmAmTotal').textContent = 'Loading...';
    document.getElementById('amCounterName').textContent = 'Loading...';
    document.getElementById('amCountTime').textContent = 'Loading...';
    
    try {
      if (!supabase) {
        throw new Error('Database not connected');
      }
      
      console.log('Querying Supabase for AM data...');
      const amData = await getAMData(date);
      console.log('AM data result:', amData);
      
      if (amData && amData.total > 0) {
        currentAMData = amData;
        document.getElementById('pmAmTotal').textContent = `$${amData.total.toFixed(2)}`;
        
        // FIX: Set AM counter name and timestamp
        document.getElementById('amCounterName').textContent = amData.counter || 'N/A';
        document.getElementById('amCountTime').textContent = amData.timestamp ? new Date(amData.timestamp).toLocaleString() : 'N/A';
        
        // Handle AM notes display
        const amNotesDisplay = document.getElementById('amNotesDisplay');
        const amNotesEl = document.getElementById('amNotes');
        if (amData.notes && amData.notes.trim()) {
          amNotesEl.textContent = amData.notes;
          amNotesDisplay.style.display = 'block';
        } else {
          amNotesDisplay.style.display = 'none';
        }
        
        // Removed "AM data loaded successfully" message to prevent bouncing
      } else {
        currentAMData = null;
        document.getElementById('pmAmTotal').textContent = 'No AM data found';
        document.getElementById('amCounterName').textContent = 'No AM data found';
        document.getElementById('amCountTime').textContent = 'No AM data found';
        const amNotesDisplay = document.getElementById('amNotesDisplay');
        if (amNotesDisplay) amNotesDisplay.style.display = 'none';
        showMessage(`No AM count found for ${date}`, 'error');
      }
    } catch (error) {
      console.error('Error loading AM data:', error);
      document.getElementById('pmAmTotal').textContent = 'Error loading AM data';
      document.getElementById('amCounterName').textContent = 'Error loading AM data';
      document.getElementById('amCountTime').textContent = 'Error loading AM data';
      showMessage(`Error: ${error.message}`, 'error');
    }
  }
  
  function collectFormData(shift) {
    const counter = document.getElementById(`${shift}Counter`).value;
    const date = document.getElementById(`${shift}Date`).value;
    const notes = document.getElementById(`${shift}Notes`).value.trim();
    
    if (!counter) throw new Error('Please select a name');
    if (!date) throw new Error('Please select a date');
    
    const drawer1Skip = document.getElementById(`${shift}Drawer1Skip`).checked;
    const drawer2Skip = document.getElementById(`${shift}Drawer2Skip`).checked;
    
    const drawer1Data = collectDrawerData(shift, 1, drawer1Skip);
    const drawer2Data = collectDrawerData(shift, 2, drawer2Skip);
    
    const data = {
      shift: shift,
      counter: counter,
      date: date,
      timestamp: new Date().toISOString(),
      drawer1: drawer1Data,
      drawer2: drawer2Data,
      drawer1Total: drawer1Data.total, // Add individual drawer totals for email template
      drawer2Total: drawer2Data.total,
      notes: notes || null,
      total: drawer1Data.total + drawer2Data.total
    };
    
    if (shift === 'pm') {
      // Use auto-calculated Toast amount (no manual override)
      const toastSales = autoCalculatedToastAmount || 0;
      const cashTips = parseInt(document.getElementById('cashTips').value) || 0;
      
      data.toastSales = toastSales;
      data.cashTips = cashTips;
      data.amTotal = currentAMData ? currentAMData.total : 0;
      
      // Always indicate auto-calculated method
      data.toastSalesMethod = 'auto_calculated';
    }
    
    return data;
  }
  
  function collectDrawerData(shift, drawer, skipped) {
    if (skipped) {
      const reason = document.getElementById(`${shift}Drawer${drawer}Reason`).value.trim();
      return {
        skipped: true,
        skipReason: reason || 'No reason provided',
        counts: {},
        total: 0
      };
    }
    
    const counts = {};
    let total = 0;
    
    // Map denomination labels to email template keys
    const denominationKeys = [
      'hundreds',    // $100
      'fifties',     // $50
      'twenties',    // $20
      'tens',        // $10
      'fives',       // $5
      'ones',        // $1
      'quarters',    // $0.25
      'dimes',       // $0.10
      'nickels',     // $0.05
      'pennies'      // $0.01
    ];
    
    DENOMINATIONS.forEach((denom, index) => {
      const qty = parseInt(document.getElementById(`${shift}D${drawer}Q${index}`).value) || 0;
      // Store with both the original label and the email template key
      counts[denom.label] = qty;
      counts[denominationKeys[index]] = qty;
      total += qty * denom.value;
    });
    
    return {
      skipped: false,
      skipReason: null,
      counts: counts,
      total: Math.round(total * 100) / 100
    };
  }
  
  async function submitAM() {
    try {
      showLoading('Submitting AM Count', 'Recording your morning cash count...');
      
      const data = collectFormData('am');
      await storeAMData(data);
      
      // Show elegant success screen
      showAMSuccess(data.total);
      resetForm('am');
      
    } catch (error) {
      hideLoading();
      console.error('AM submission error:', error);
      showMessage(`Error: ${error.message}`, 'error');
    }
  }
  
  async function submitPM() {
    try {
      showLoading('Processing PM Close', 'Calculating totals and sending report to management...');
      
      const data = collectFormData('pm');
      const calculations = calculatePMAmounts(data);
      
      await storePMData(data, calculations);
      await sendEmailReport(data, calculations);
      
      // Show elegant success screen with deposit/return instructions
      showPMSuccess(calculations.depositAmount, calculations.returnAmount, calculations.discrepancy);
      
    } catch (error) {
      hideLoading();
      console.error('PM submission error:', error);
      
      // Check if it's a validation error (these shouldn't reset the form)
      const isValidationError = error.message.includes('Please select') || 
                               error.message.includes('required') ||
                               error.message.includes('name') ||
                               error.message.includes('date');
      
      showMessage(`Error: ${error.message}`, 'error');
      
      // Only redirect home for non-validation errors (like network issues)
      if (!isValidationError) {
        goHome();
      }
    }
  }
  
  function calculatePMAmounts(data) {
    const amTotal = data.amTotal;
    const pmTotal = data.total;
    const toastSales = data.toastSales;
    const cashTips = data.cashTips;
    
    // Drawer change = PM - AM
    const drawerChange = pmTotal - amTotal;
    
    // Actual cash in
    const actualCashIn = drawerChange;
    
    // Expected vs actual (Toast sales vs actual cash in)
    const discrepancy = actualCashIn - toastSales;
    
    // Step 1: Calculate raw deposit amount
    const rawDepositAmount = toastSales + cashTips;
    
    // Step 2: Round deposit to whole dollars (what staff actually deposits)
    const depositAmount = Math.round(rawDepositAmount);
    
    // Step 3: Calculate deposit rounding adjustment needed
    const depositRoundingAdjustment = depositAmount - rawDepositAmount;
    
    // Step 4: Handle deposit rounding with whole dollar tip adjustments
    let depositTipAdjustment = 0;
    let depositExcessToCashbox = 0;
    
    if (depositRoundingAdjustment > 0) {
      // Need extra money for rounding - take whole dollars from tips
      depositTipAdjustment = Math.ceil(depositRoundingAdjustment);
      depositExcessToCashbox = depositTipAdjustment - depositRoundingAdjustment;
    } else if (depositRoundingAdjustment < 0) {
      // Deposit rounded down - staff keeps the rounding benefit
      depositExcessToCashbox = Math.abs(depositRoundingAdjustment);
    }
    
    // Step 5: Handle shortage/overage adjustments with whole dollars
    let shortageTipAdjustment = 0;
    let shortageExcessToCashbox = 0;
    
    if (discrepancy < 0) {
      // SHORTAGE: Take whole dollars from tips to cover shortage
      const shortageAmount = Math.abs(discrepancy);
      shortageTipAdjustment = Math.ceil(shortageAmount);
      shortageExcessToCashbox = shortageTipAdjustment - shortageAmount;
    }
    
    // Step 6: Calculate final tip amounts
    const totalTipAdjustment = depositTipAdjustment + shortageTipAdjustment;
    let finalCashTips = cashTips - totalTipAdjustment;
    
    // Ensure tips don't go negative
    if (finalCashTips < 0) {
      const shortfall = Math.abs(finalCashTips);
      finalCashTips = 0;
      // Add shortfall to what business owes staff (tracked but not paid)
    }
    
    // Final tips are always whole dollars (floor any remaining decimals)
    const adjustedTips = Math.floor(finalCashTips);
    const tipDecimalRemainder = finalCashTips - adjustedTips;
    
    // Step 7: Calculate return amount to cashbox
    let returnAmount = amTotal;
    
    // Add overage to cashbox
    if (discrepancy > 0) {
      returnAmount += discrepancy;
    }
    
    // Add all excess amounts to cashbox
    returnAmount += depositExcessToCashbox + shortageExcessToCashbox + tipDecimalRemainder;
    
    return {
      amTotal,
      pmTotal,
      drawerChange,
      actualCashIn,
      toastSales,
      cashTips, // Original tips reported
      discrepancy,
      tipAdjustment: totalTipAdjustment, // Total amount taken from tips
      adjustedTips, // Final whole dollar tips
      depositAmount, // Rounded deposit amount (what staff deposits)
      returnAmount, // What goes back to cashbox
      drawerOver: discrepancy > 0 ? discrepancy : 0,
      drawerShort: discrepancy < 0 ? Math.abs(discrepancy) : 0,
      restaurantOwed: toastSales, // Exact Toast sales amount
      staffOwed: adjustedTips, // Final tips after adjustment
      // New fields for tracking the logic
      rawDepositAmount, // Original exact deposit amount
      depositRoundingAdjustment, // How much rounding was needed
      depositTipAdjustment, // Whole dollars taken from tips for rounding
      depositExcessToCashbox, // Excess from deposit rounding adjustments
      shortageTipAdjustment, // Whole dollars taken from tips for shortage
      shortageExcessToCashbox, // Excess from shortage adjustments
      tipDecimalRemainder // Decimal remainder from final tip flooring
    };
  }
  
  async function storeAMData(data) {
    if (!supabase) throw new Error('Database not connected');

    const { error } = await supabase
      .from('cash_counts')
      .upsert({
        date: data.date,
        am_counter: data.counter,
        am_timestamp: data.timestamp,
        am_total: data.total,
        am_drawer1_total: data.drawer1.total,
        am_drawer1_skip: data.drawer1.skipped,
        am_drawer1_skip_reason: data.drawer1.skipReason,
        am_drawer1_data: data.drawer1.counts,
        am_drawer2_total: data.drawer2.total,
        am_drawer2_skip: data.drawer2.skipped,
        am_drawer2_skip_reason: data.drawer2.skipReason,
        am_drawer2_data: data.drawer2.counts,
        am_notes: data.notes
      }, {
        onConflict: 'date',
        ignoreDuplicates: false
      });

    if (error) throw new Error(`Database error: ${error.message}`);
  }
  
  async function storePMData(data, calculations) {
    if (!supabase) throw new Error('Database not connected');
    
    const { error } = await supabase
      .from('cash_counts')
      .update({
        pm_counter: data.counter,
        pm_timestamp: data.timestamp,
        pm_total: data.total,
        pm_cash_tips: data.cashTips,
        pm_toast_sales: data.toastSales,
        pm_drawer1_total: data.drawer1.total,
        pm_drawer1_skip: data.drawer1.skipped,
        pm_drawer1_skip_reason: data.drawer1.skipReason,
        pm_drawer1_data: data.drawer1.counts,
        pm_drawer2_total: data.drawer2.total,
        pm_drawer2_skip: data.drawer2.skipped,
        pm_drawer2_skip_reason: data.drawer2.skipReason,
        pm_drawer2_data: data.drawer2.counts,
        pm_notes: data.notes,
        pm_discrepancy: calculations.discrepancy,
        pm_adjusted_tips: calculations.adjustedTips,
        pm_drawer_over_amount: calculations.drawerOver,
        pm_deposit_amount: calculations.depositAmount,
        pm_amount_to_keep: calculations.returnAmount
      })
      .eq('date', data.date);
    
    if (error) throw new Error(`Database error: ${error.message}`);
  }
  
  async function getAMData(date) {
    if (!supabase) return null;
    
    const { data, error } = await supabase
      .from('cash_counts')
      .select('*')
      .eq('date', date)
      .single();
    
    if (error || !data || !data.am_total) return null;
    
    return {
      date: data.date,
      counter: data.am_counter,
      timestamp: data.am_timestamp,
      total: data.am_total,
      drawer1: {
        total: data.am_drawer1_total,
        skipped: data.am_drawer1_skip,
        skipReason: data.am_drawer1_skip_reason,
        counts: data.am_drawer1_data
      },
      drawer2: {
        total: data.am_drawer2_total,
        skipped: data.am_drawer2_skip,
        skipReason: data.am_drawer2_skip_reason,
        counts: data.am_drawer2_data
      },
      notes: data.am_notes
    };
  }
  
  async function sendEmailReport(data, calculations) {
    // Format date with day of the week
    const dateObj = new Date(data.date + 'T00:00:00');
    const dayOfWeek = dateObj.toLocaleDateString('en-US', { weekday: 'long' }).toUpperCase();
    const formattedDate = dateObj.toLocaleDateString('en-US', { 
      year: 'numeric', 
      month: 'long', 
      day: 'numeric' 
    }).toUpperCase();
    
    const templateParams = {
      to_email: EMAILJS_CONFIG.MANAGER_EMAIL,
      date: data.date,
      day_of_week: dayOfWeek,
      formatted_date: formattedDate,
      am_counter: currentAMData ? currentAMData.counter : 'N/A',
      counter: data.counter, // PM counter (was pm_counter)
      am_timestamp: currentAMData ? new Date(currentAMData.timestamp).toLocaleString() : 'N/A',
      pm_timestamp: new Date(data.timestamp).toLocaleString(),
      am_total: calculations.amTotal.toFixed(2),
      pm_total: calculations.pmTotal.toFixed(2),
      total_cash: calculations.pmTotal.toFixed(2), // Template expects total_cash
      drawer_change: calculations.drawerChange.toFixed(2),
      actual_cash_in: calculations.actualCashIn.toFixed(2),
      toast_sales: calculations.toastSales.toFixed(2),
      original_tips: calculations.cashTips.toFixed(2),
      discrepancy: Math.abs(calculations.discrepancy).toFixed(2),
      discrepancy_direction: calculations.discrepancy >= 0 ? 'Over' : 'Short',
      discrepancy_sign: calculations.discrepancy >= 0 ? '+' : '-',
      large_discrepancy_flag: Math.abs(calculations.discrepancy) > 10 ? ' LARGE DISCREPANCY!' : '',
      tip_adjustment: (calculations.shortageTipAdjustment || 0) > 0 ? (calculations.shortageTipAdjustment || 0).toFixed(2) : null,
      adjusted_tips: calculations.adjustedTips.toString(), // Whole dollars only
      deposit_amount: calculations.depositAmount.toString(), // Already rounded to whole dollar
      amount_to_keep: calculations.returnAmount.toFixed(2), // Template expects amount_to_keep
      return_breakdown: (calculations.returnAmount - calculations.amTotal).toFixed(2),
      drawer_over: calculations.drawerOver.toFixed(2),
      drawer_short: calculations.drawerShort.toFixed(2),
      am_notes: currentAMData ? (currentAMData.notes || '') : '',
      notes: data.notes || '', // Template expects notes (not pm_notes)
      has_discrepancy: calculations.discrepancy !== 0 ? 'true' : 'false',
      // Add drawer breakdown for comparison table
      has_am_comparison: currentAMData ? 'true' : 'false',
      am_drawer1_total: currentAMData ? currentAMData.drawer1.total.toFixed(2) : '0.00',
      am_drawer2_total: currentAMData ? currentAMData.drawer2.total.toFixed(2) : '0.00',
      pm_drawer1_total: data.drawer1Total.toFixed(2),
      pm_drawer2_total: data.drawer2Total.toFixed(2),
      am_grand_total: calculations.amTotal.toFixed(2),
      pm_grand_total: calculations.pmTotal.toFixed(2),
      // Manager breakdown fields
      restaurant_owed: calculations.toastSales.toFixed(2),
      staff_owed: calculations.adjustedTips.toString(), // Whole dollars only
      total_accounted: (calculations.toastSales + calculations.adjustedTips).toFixed(2),
      
      // Deposit rounding breakdown fields
      raw_deposit_amount: calculations.rawDepositAmount ? calculations.rawDepositAmount.toFixed(2) : null,
      deposit_rounding_adjustment: calculations.depositRoundingAdjustment ? calculations.depositRoundingAdjustment.toFixed(2) : null,
      deposit_tip_adjustment: calculations.depositTipAdjustment ? calculations.depositTipAdjustment.toFixed(2) : null,
      deposit_excess_to_cashbox: calculations.depositExcessToCashbox ? calculations.depositExcessToCashbox.toFixed(2) : null,
      has_deposit_rounding: (calculations.depositRoundingAdjustment && Math.abs(calculations.depositRoundingAdjustment) > 0) ? 'true' : 'false',
      
      // AM Drawer 1 denomination breakdown
      am_drawer1_100: currentAMData ? (currentAMData.drawer1.counts.hundreds || 0) : 0,
      am_drawer1_100_total: currentAMData ? ((currentAMData.drawer1.counts.hundreds || 0) * 100).toFixed(2) : '0.00',
      am_drawer1_50: currentAMData ? (currentAMData.drawer1.counts.fifties || 0) : 0,
      am_drawer1_50_total: currentAMData ? ((currentAMData.drawer1.counts.fifties || 0) * 50).toFixed(2) : '0.00',
      am_drawer1_20: currentAMData ? (currentAMData.drawer1.counts.twenties || 0) : 0,
      am_drawer1_20_total: currentAMData ? ((currentAMData.drawer1.counts.twenties || 0) * 20).toFixed(2) : '0.00',
      am_drawer1_10: currentAMData ? (currentAMData.drawer1.counts.tens || 0) : 0,
      am_drawer1_10_total: currentAMData ? ((currentAMData.drawer1.counts.tens || 0) * 10).toFixed(2) : '0.00',
      am_drawer1_5: currentAMData ? (currentAMData.drawer1.counts.fives || 0) : 0,
      am_drawer1_5_total: currentAMData ? ((currentAMData.drawer1.counts.fives || 0) * 5).toFixed(2) : '0.00',
      am_drawer1_1: currentAMData ? (currentAMData.drawer1.counts.ones || 0) : 0,
      am_drawer1_1_total: currentAMData ? ((currentAMData.drawer1.counts.ones || 0) * 1).toFixed(2) : '0.00',
      am_drawer1_quarter: currentAMData ? (currentAMData.drawer1.counts.quarters || 0) : 0,
      am_drawer1_quarter_total: currentAMData ? ((currentAMData.drawer1.counts.quarters || 0) * 0.25).toFixed(2) : '0.00',
      am_drawer1_dime: currentAMData ? (currentAMData.drawer1.counts.dimes || 0) : 0,
      am_drawer1_dime_total: currentAMData ? ((currentAMData.drawer1.counts.dimes || 0) * 0.10).toFixed(2) : '0.00',
      am_drawer1_nickel: currentAMData ? (currentAMData.drawer1.counts.nickels || 0) : 0,
      am_drawer1_nickel_total: currentAMData ? ((currentAMData.drawer1.counts.nickels || 0) * 0.05).toFixed(2) : '0.00',
      am_drawer1_penny: currentAMData ? (currentAMData.drawer1.counts.pennies || 0) : 0,
      am_drawer1_penny_total: currentAMData ? ((currentAMData.drawer1.counts.pennies || 0) * 0.01).toFixed(2) : '0.00',
      
      // AM Drawer 2 denomination breakdown
      am_drawer2_100: currentAMData ? (currentAMData.drawer2.counts.hundreds || 0) : 0,
      am_drawer2_100_total: currentAMData ? ((currentAMData.drawer2.counts.hundreds || 0) * 100).toFixed(2) : '0.00',
      am_drawer2_50: currentAMData ? (currentAMData.drawer2.counts.fifties || 0) : 0,
      am_drawer2_50_total: currentAMData ? ((currentAMData.drawer2.counts.fifties || 0) * 50).toFixed(2) : '0.00',
      am_drawer2_20: currentAMData ? (currentAMData.drawer2.counts.twenties || 0) : 0,
      am_drawer2_20_total: currentAMData ? ((currentAMData.drawer2.counts.twenties || 0) * 20).toFixed(2) : '0.00',
      am_drawer2_10: currentAMData ? (currentAMData.drawer2.counts.tens || 0) : 0,
      am_drawer2_10_total: currentAMData ? ((currentAMData.drawer2.counts.tens || 0) * 10).toFixed(2) : '0.00',
      am_drawer2_5: currentAMData ? (currentAMData.drawer2.counts.fives || 0) : 0,
      am_drawer2_5_total: currentAMData ? ((currentAMData.drawer2.counts.fives || 0) * 5).toFixed(2) : '0.00',
      am_drawer2_1: currentAMData ? (currentAMData.drawer2.counts.ones || 0) : 0,
      am_drawer2_1_total: currentAMData ? ((currentAMData.drawer2.counts.ones || 0) * 1).toFixed(2) : '0.00',
      am_drawer2_quarter: currentAMData ? (currentAMData.drawer2.counts.quarters || 0) : 0,
      am_drawer2_quarter_total: currentAMData ? ((currentAMData.drawer2.counts.quarters || 0) * 0.25).toFixed(2) : '0.00',
      am_drawer2_dime: currentAMData ? (currentAMData.drawer2.counts.dimes || 0) : 0,
      am_drawer2_dime_total: currentAMData ? ((currentAMData.drawer2.counts.dimes || 0) * 0.10).toFixed(2) : '0.00',
      am_drawer2_nickel: currentAMData ? (currentAMData.drawer2.counts.nickels || 0) : 0,
      am_drawer2_nickel_total: currentAMData ? ((currentAMData.drawer2.counts.nickels || 0) * 0.05).toFixed(2) : '0.00',
      am_drawer2_penny: currentAMData ? (currentAMData.drawer2.counts.pennies || 0) : 0,
      am_drawer2_penny_total: currentAMData ? ((currentAMData.drawer2.counts.pennies || 0) * 0.01).toFixed(2) : '0.00',
      
      // PM Drawer 1 denomination breakdown
      pm_drawer1_100: data.drawer1.counts.hundreds || 0,
      pm_drawer1_100_total: ((data.drawer1.counts.hundreds || 0) * 100).toFixed(2),
      pm_drawer1_50: data.drawer1.counts.fifties || 0,
      pm_drawer1_50_total: ((data.drawer1.counts.fifties || 0) * 50).toFixed(2),
      pm_drawer1_20: data.drawer1.counts.twenties || 0,
      pm_drawer1_20_total: ((data.drawer1.counts.twenties || 0) * 20).toFixed(2),
      pm_drawer1_10: data.drawer1.counts.tens || 0,
      pm_drawer1_10_total: ((data.drawer1.counts.tens || 0) * 10).toFixed(2),
      pm_drawer1_5: data.drawer1.counts.fives || 0,
      pm_drawer1_5_total: ((data.drawer1.counts.fives || 0) * 5).toFixed(2),
      pm_drawer1_1: data.drawer1.counts.ones || 0,
      pm_drawer1_1_total: ((data.drawer1.counts.ones || 0) * 1).toFixed(2),
      pm_drawer1_quarter: data.drawer1.counts.quarters || 0,
      pm_drawer1_quarter_total: ((data.drawer1.counts.quarters || 0) * 0.25).toFixed(2),
      pm_drawer1_dime: data.drawer1.counts.dimes || 0,
      pm_drawer1_dime_total: ((data.drawer1.counts.dimes || 0) * 0.10).toFixed(2),
      pm_drawer1_nickel: data.drawer1.counts.nickels || 0,
      pm_drawer1_nickel_total: ((data.drawer1.counts.nickels || 0) * 0.05).toFixed(2),
      pm_drawer1_penny: data.drawer1.counts.pennies || 0,
      pm_drawer1_penny_total: ((data.drawer1.counts.pennies || 0) * 0.01).toFixed(2),
      
      // PM Drawer 2 denomination breakdown
      pm_drawer2_100: data.drawer2.counts.hundreds || 0,
      pm_drawer2_100_total: ((data.drawer2.counts.hundreds || 0) * 100).toFixed(2),
      pm_drawer2_50: data.drawer2.counts.fifties || 0,
      pm_drawer2_50_total: ((data.drawer2.counts.fifties || 0) * 50).toFixed(2),
      pm_drawer2_20: data.drawer2.counts.twenties || 0,
      pm_drawer2_20_total: ((data.drawer2.counts.twenties || 0) * 20).toFixed(2),
      pm_drawer2_10: data.drawer2.counts.tens || 0,
      pm_drawer2_10_total: ((data.drawer2.counts.tens || 0) * 10).toFixed(2),
      pm_drawer2_5: data.drawer2.counts.fives || 0,
      pm_drawer2_5_total: ((data.drawer2.counts.fives || 0) * 5).toFixed(2),
      pm_drawer2_1: data.drawer2.counts.ones || 0,
      pm_drawer2_1_total: ((data.drawer2.counts.ones || 0) * 1).toFixed(2),
      pm_drawer2_quarter: data.drawer2.counts.quarters || 0,
      pm_drawer2_quarter_total: ((data.drawer2.counts.quarters || 0) * 0.25).toFixed(2),
      pm_drawer2_dime: data.drawer2.counts.dimes || 0,
      pm_drawer2_dime_total: ((data.drawer2.counts.dimes || 0) * 0.10).toFixed(2),
      pm_drawer2_nickel: data.drawer2.counts.nickels || 0,
      pm_drawer2_nickel_total: ((data.drawer2.counts.nickels || 0) * 0.05).toFixed(2),
      pm_drawer2_penny: data.drawer2.counts.pennies || 0,
      pm_drawer2_penny_total: ((data.drawer2.counts.pennies || 0) * 0.01).toFixed(2)
    };
    
    const response = await emailjs.send(
      EMAILJS_CONFIG.SERVICE_ID,
      EMAILJS_CONFIG.TEMPLATE_ID,
      templateParams
    );
    
    if (!response.status === 200) {
      throw new Error('Email send failed');
    }
  }
  
  async function generateReport() {
    const date = document.getElementById('reportDate').value;
    if (!date) {
      showMessage('Please select a date', 'error');
      return;
    }

    try {
      showLoading('Generating Report', 'Creating email report for management...');
      
      const amData = await getAMData(date);
      if (!amData) {
        throw new Error('No data found for this date');
      }
      
      // For report generation, we'll use stored PM data or create a basic report
      const { data: fullData } = await supabase
        .from('cash_counts')
        .select('*')
        .eq('date', date)
        .single();
      
      if (fullData && fullData.pm_total) {
        // Full day report - recalculate using the same logic as PM flow
        const reportData = {
          date: date,
          counter: fullData.pm_counter,
          total: fullData.pm_total,
          toastSales: fullData.pm_toast_sales,
          cashTips: fullData.pm_cash_tips,
          amTotal: fullData.am_total,
          notes: fullData.pm_notes
        };
        
        // Use same calculation function as PM flow for consistency
        const calculations = calculatePMAmounts({
          amTotal: fullData.am_total,
          total: fullData.pm_total,
          toastSales: fullData.pm_toast_sales,
          cashTips: fullData.pm_cash_tips
        });
        
        currentAMData = amData;
        await sendEmailReport(reportData, calculations);
      } else {
        throw new Error('Incomplete data for this date');
      }
      
      // Show elegant success screen
      showReportSuccess(date);
      
    } catch (error) {
      hideLoading();
      console.error('Report generation error:', error);
      showMessage(`Error: ${error.message}`, 'error');
    }
  }
  
  // New Report Functions
  function toggleReportType() {
    const reportType = document.querySelector('input[name="reportType"]:checked').value;
    const singleGroup = document.getElementById('singleDateGroup');
    const weeklyGroup = document.getElementById('weeklyRangeGroup');
    
    if (reportType === 'single') {
      singleGroup.style.display = 'block';
      weeklyGroup.style.display = 'none';
    } else {
      singleGroup.style.display = 'none';
      weeklyGroup.style.display = 'block';
      // Load saved weeks when weekly report is selected
      loadSavedWeeks();
    }
  }

  // Load Saved Weekly Reports for Dropdown
  async function loadSavedWeeks() {
    const dropdown = document.getElementById('savedWeeksDropdown');
    
    try {
      dropdown.innerHTML = '<option value="">Loading saved reports...</option>';
      
      if (!supabase) {
        dropdown.innerHTML = '<option value="">Database connection not available</option>';
        return;
      }

      const { data: savedReports, error } = await supabase
        .from('weekly_combined_reports')
        .select('id, week_start_date, week_end_date, generated_by, generated_at')
        .order('week_start_date', { ascending: false });

      if (error) {
        console.error('Error loading saved reports:', error);
        dropdown.innerHTML = '<option value="">Error loading reports</option>';
        return;
      }

      if (!savedReports || savedReports.length === 0) {
        dropdown.innerHTML = '<option value="">No saved weekly reports found. Generate a weekly combined report first.</option>';
        return;
      }

      // Populate dropdown with saved reports
      dropdown.innerHTML = '<option value="">Select a saved weekly report...</option>';
      
      savedReports.forEach(report => {
        const startDate = new Date(report.week_start_date).toLocaleDateString();
        const endDate = new Date(report.week_end_date).toLocaleDateString();
        const generatedDate = new Date(report.generated_at).toLocaleDateString();
        
        const option = document.createElement('option');
        option.value = report.id;
        option.textContent = `Week of ${startDate} - ${endDate} (Generated: ${generatedDate})`;
        dropdown.appendChild(option);
      });

    } catch (error) {
      console.error('Error in loadSavedWeeks:', error);
      dropdown.innerHTML = '<option value="">Error loading reports</option>';
    }
  }

  // Generate Historical Report from Database
  async function generateHistoricalReport() {
    const reportTypeElement = document.querySelector('input[name="reportType"]:checked');
    
    if (!reportTypeElement) {
      alert('Please select a report type (Daily or Weekly)');
      return;
    }
    
    const reportType = reportTypeElement.value;
    console.log('Generate Historical Report - Report type:', reportType);
    
    try {
      showLoading('Generating Historical Report', 'Retrieving data from database...');
      
      if (reportType === 'single') {
        await generateSingleDayHistoricalReport();
      } else {
        await generateWeeklyHistoricalReport();
      }
      
      hideLoading();
      showSuccessMessage('Historical report generated successfully!', 'reportsForm');
      
    } catch (error) {
      hideLoading();
      showErrorMessage('Error generating historical report: ' + error.message, 'reportsForm');
      console.error('Historical report error:', error);
    }
  }

  // Generate Single Day Historical Report
  async function generateSingleDayHistoricalReport() {
    const reportDate = document.getElementById('reportDate').value;
    
    if (!reportDate) {
      throw new Error('Please select a date for the report');
    }
    
    if (!supabase) {
      throw new Error('Database connection not available');
    }
    
    // Query for complete daily cash count data
    const { data: fullData, error: dataError } = await supabase
      .from('cash_counts')
      .select('*')
      .eq('date', reportDate)
      .single();
    
    if (dataError) {
      console.error('Database error details:', dataError);
      throw new Error(`Database query failed: ${dataError.message}`);
    }
    
    if (!fullData) {
      throw new Error(`No cash count data found for ${reportDate}. This date may not have been processed yet.`);
    }
    
    // Check if we have both AM and PM data
    if (!fullData.am_total && !fullData.pm_total) {
      throw new Error(`No AM or PM data found for ${reportDate}. This date may not have been processed yet.`);
    }
    
    // Display single day report in modal using PM flow format
    displayPMFlowSingleDayReportModal(fullData, reportDate);
  }
  
  // Display Single Day Report in Modal using PM Flow Format
  function displayPMFlowSingleDayReportModal(fullData, reportDate) {
    console.log('=== PM FLOW SINGLE DAY REPORT MODAL ===');
    
    // Generate comprehensive HTML content using PM flow format
    const reportHtml = generatePMFlowSingleDayReportHtml(fullData, reportDate);
    
    // Create modal overlay
    const overlay = document.createElement('div');
    overlay.id = 'singleDayReportOverlay';
    overlay.style.cssText = `
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      width: 100vw !important;
      height: 100vh !important;
      background: rgba(0, 0, 0, 0.8) !important;
      z-index: 99999 !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      overflow: auto !important;
    `;
    
    const contentBox = document.createElement('div');
    contentBox.style.cssText = `
      background: white !important;
      margin: 20px !important;
      padding: 0 !important;
      border-radius: 12px !important;
      max-width: 95vw !important;
      max-height: 95vh !important;
      overflow: hidden !important;
      position: relative !important;
      box-shadow: 0 8px 32px rgba(0,0,0,0.4) !important;
      display: flex !important;
      flex-direction: column !important;
    `;
    
    // Add header with controls
    const headerDiv = document.createElement('div');
    headerDiv.style.cssText = `
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%) !important;
      padding: 20px 30px !important;
      color: white !important;
      display: flex !important;
      justify-content: space-between !important;
      align-items: center !important;
      flex-shrink: 0 !important;
    `;
    
    const titleDiv = document.createElement('div');
    titleDiv.innerHTML = `
      <h2 style="margin: 0; font-size: 24px; font-weight: 600;">Daily Cash Report</h2>
      <p style="margin: 5px 0 0 0; opacity: 0.9; font-size: 16px;">${new Date(reportDate).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
    `;
    
    const controlsDiv = document.createElement('div');
    controlsDiv.style.cssText = `
      display: flex !important;
      gap: 15px !important;
      align-items: center !important;
    `;
    
    // PDF Download button
    const pdfBtn = document.createElement('button');
    pdfBtn.innerHTML = 'Download PDF';
    pdfBtn.style.cssText = `
      background: rgba(255,255,255,0.2) !important;
      color: white !important;
      border: 2px solid rgba(255,255,255,0.4) !important;
      padding: 10px 20px !important;
      border-radius: 8px !important;
      cursor: pointer !important;
      font-size: 14px !important;
      font-weight: 500 !important;
      transition: all 0.3s ease !important;
    `;
    pdfBtn.onmouseover = () => pdfBtn.style.background = 'rgba(255,255,255,0.3)';
    pdfBtn.onmouseout = () => pdfBtn.style.background = 'rgba(255,255,255,0.2)';
    pdfBtn.onclick = () => generatePMFlowSingleDayPDF(fullData, reportDate);
    
    // Close button
    const closeBtn = document.createElement('button');
    closeBtn.innerHTML = 'X';
    closeBtn.style.cssText = `
      background: rgba(255,255,255,0.2) !important;
      color: white !important;
      border: 2px solid rgba(255,255,255,0.4) !important;
      padding: 8px 12px !important;
      border-radius: 50% !important;
      cursor: pointer !important;
      font-size: 18px !important;
      font-weight: bold !important;
      width: 40px !important;
      height: 40px !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      transition: all 0.3s ease !important;
    `;
    closeBtn.onmouseover = () => closeBtn.style.background = 'rgba(255,80,80,0.8)';
    closeBtn.onmouseout = () => closeBtn.style.background = 'rgba(255,255,255,0.2)';
    closeBtn.onclick = () => document.body.removeChild(overlay);
    
    controlsDiv.appendChild(pdfBtn);
    controlsDiv.appendChild(closeBtn);
    headerDiv.appendChild(titleDiv);
    headerDiv.appendChild(controlsDiv);
    
    // Add content area
    const contentDiv = document.createElement('div');
    contentDiv.style.cssText = `
      padding: 30px !important;
      overflow: auto !important;
      flex: 1 !important;
      background: #f8f9fa !important;
    `;
    contentDiv.innerHTML = reportHtml;
    
    contentBox.appendChild(headerDiv);
    contentBox.appendChild(contentDiv);
    overlay.appendChild(contentBox);
    document.body.appendChild(overlay);
    
    console.log('PM Flow single day report modal created and displayed');
  }
  
  // Generate Enhanced Single Day Report HTML
  function generateEnhancedSingleDayReportHtml(dayData, reportDate) {
    const formattedDate = new Date(reportDate).toLocaleDateString('en-US', { 
      weekday: 'long', 
      year: 'numeric', 
      month: 'long', 
      day: 'numeric' 
    });
    
    const weekStart = new Date(dayData.weekly_combined_reports.week_start_date).toLocaleDateString();
    const weekEnd = new Date(dayData.weekly_combined_reports.week_end_date).toLocaleDateString();
    
    return `
      <div style="max-width: 1200px; margin: 0 auto; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
        
        <!-- Header Summary Cards -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px;">
          
          <!-- Date & Staff Info Card -->
          <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 0; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
            <div style="display: flex; align-items: center; margin-bottom: 15px;">
              <span style="font-size: 24px; margin-right: 10px;"></span>
              <h3 style="margin: 0; font-size: 18px; font-weight: 600;">Date & Staff</h3>
            </div>
            <div style="space-y: 8px;">
              <p style="margin: 8px 0; font-size: 16px;"><strong>Date:</strong> ${formattedDate}</p>
              <p style="margin: 8px 0; font-size: 14px;"><strong>Report Week:</strong> ${weekStart} - ${weekEnd}</p>
              <p style="margin: 8px 0; font-size: 14px;"><strong>Night Counter:</strong> ${dayData.night_counter || 'N/A'}</p>
              <p style="margin: 8px 0; font-size: 12px; opacity: 0.9;"><strong>Generated:</strong> ${new Date().toLocaleString()}</p>
            </div>
          </div>

          <!-- Cash Flow Summary Card -->
          <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 25px; border-radius: 0; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
            <div style="display: flex; align-items: center; margin-bottom: 15px;">
              <span style="font-size: 24px; margin-right: 10px;"></span>
              <h3 style="margin: 0; font-size: 18px; font-weight: 600;">Cash Flow</h3>
            </div>
            <div style="space-y: 8px;">
              <p style="margin: 8px 0; font-size: 16px;"><strong>Toast Sales:</strong> $${dayData.toast_sales?.toFixed(2) || '0.00'}</p>
              <p style="margin: 8px 0; font-size: 14px;"><strong>Actual Cash In:</strong> $${dayData.actual_cash_in?.toFixed(2) || '0.00'}</p>
              <p style="margin: 8px 0; font-size: 14px;"><strong>Discrepancy:</strong> ${dayData.discrepancy >= 0 ? '+' : ''}$${Math.abs(dayData.discrepancy || 0).toFixed(2)}</p>
              <p style="margin: 8px 0; font-size: 14px;"><strong>Excess:</strong> $${dayData.excess?.toFixed(2) || '0.00'}</p>
            </div>
          </div>

          <!-- Performance Indicators Card -->
          <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 25px; border-radius: 0; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
            <div style="display: flex; align-items: center; margin-bottom: 15px;">
              <span style="font-size: 24px; margin-right: 10px;"></span>
              <h3 style="margin: 0; font-size: 18px; font-weight: 600;">Performance</h3>
            </div>
            <div style="space-y: 8px;">
              <p style="margin: 8px 0; font-size: 14px;"><strong>Accuracy:</strong> ${Math.abs(dayData.discrepancy || 0) < 5 ? 'Excellent' : Math.abs(dayData.discrepancy || 0) < 20 ? 'Good' : 'Needs Review'}</p>
              <p style="margin: 8px 0; font-size: 14px;"><strong>Variance:</strong> ${((Math.abs(dayData.discrepancy || 0) / (dayData.toast_sales || 1)) * 100).toFixed(1)}%</p>
              <p style="margin: 8px 0; font-size: 14px;"><strong>Week Generated By:</strong> ${dayData.weekly_combined_reports.generated_by || 'N/A'}</p>
            </div>
          </div>
        </div>

        <!-- Detailed Analysis Section -->
        <div style="background: white; border-radius: 0; box-shadow: 0 4px 20px rgba(0,0,0,0.08); overflow: hidden; margin-bottom: 30px;">
          <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px;">
            <h3 style="margin: 0; font-size: 20px; font-weight: 600; display: flex; align-items: center;">
              <span style="margin-right: 10px;"></span>
              Detailed Cash Analysis
            </h3>
          </div>
          
          <div style="padding: 30px;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px;">
              
              <!-- Revenue Breakdown -->
              <div>
                <h4 style="color: #333; margin-bottom: 20px; font-size: 16px; font-weight: 600; border-bottom: 2px solid #667eea; padding-bottom: 8px;">Revenue Breakdown</h4>
                <div style="space-y: 12px;">
                  <div style="display: flex; justify-content: space-between; padding: 12px; background: #f8f9fa; border-radius: 0; border-left: 4px solid #28a745;">
                    <span style="font-weight: 500;">Toast Sales Reported</span>
                    <span style="font-weight: 600; color: #28a745;">$${dayData.toast_sales?.toFixed(2) || '0.00'}</span>
                  </div>
                  <div style="display: flex; justify-content: space-between; padding: 12px; background: #f8f9fa; border-radius: 0; border-left: 4px solid #17a2b8;">
                    <span style="font-weight: 500;">Actual Cash Collected</span>
                    <span style="font-weight: 600; color: #17a2b8;">$${dayData.actual_cash_in?.toFixed(2) || '0.00'}</span>
                  </div>
                  <div style="display: flex; justify-content: space-between; padding: 12px; background: #f8f9fa; border-radius: 0; border-left: 4px solid ${dayData.discrepancy >= 0 ? '#28a745' : '#dc3545'};">
                    <span style="font-weight: 500;">Cash Variance</span>
                    <span style="font-weight: 600; color: ${dayData.discrepancy >= 0 ? '#28a745' : '#dc3545'};">${dayData.discrepancy >= 0 ? '+' : ''}$${Math.abs(dayData.discrepancy || 0).toFixed(2)}</span>
                  </div>
                </div>
              </div>

              <!-- Operational Metrics -->
              <div>
                <h4 style="color: #333; margin-bottom: 20px; font-size: 16px; font-weight: 600; border-bottom: 2px solid #f093fb; padding-bottom: 8px;">Operational Metrics</h4>
                <div style="space-y: 12px;">
                  <div style="display: flex; justify-content: space-between; padding: 12px; background: #f8f9fa; border-radius: 0; border-left: 4px solid #6f42c1;">
                    <span style="font-weight: 500;">Cash Excess to Tips</span>
                    <span style="font-weight: 600; color: #6f42c1;">$${dayData.excess?.toFixed(2) || '0.00'}</span>
                  </div>
                  <div style="display: flex; justify-content: space-between; padding: 12px; background: #f8f9fa; border-radius: 0; border-left: 4px solid #fd7e14;">
                    <span style="font-weight: 500;">Accuracy Rate</span>
                    <span style="font-weight: 600; color: #fd7e14;">${Math.abs(dayData.discrepancy || 0) < 5 ? '98%+' : Math.abs(dayData.discrepancy || 0) < 20 ? '95%+' : '90%-'}</span>
                  </div>
                  <div style="display: flex; justify-content: space-between; padding: 12px; background: #f8f9fa; border-radius: 0; border-left: 4px solid #20c997;">
                    <span style="font-weight: 500;">Status</span>
                    <span style="font-weight: 600; color: #20c997;">${Math.abs(dayData.discrepancy || 0) < 10 ? 'Balanced' : 'Review Needed'}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Raw Data Section -->
        <div style="background: white; border-radius: 0; box-shadow: 0 4px 20px rgba(0,0,0,0.08); overflow: hidden; margin-bottom: 30px;">
          <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 20px;">
            <h3 style="margin: 0; font-size: 20px; font-weight: 600; display: flex; align-items: center;">
              <span style="margin-right: 10px;"></span>
              Complete Data Summary
            </h3>
          </div>
          
          <div style="padding: 30px;">
            <div style="overflow-x: auto;">
              <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                <thead>
                  <tr style="background: #f8f9fa;">
                    <th style="padding: 15px; text-align: left; border-bottom: 2px solid #dee2e6; font-weight: 600; color: #495057;">Field</th>
                    <th style="padding: 15px; text-align: right; border-bottom: 2px solid #dee2e6; font-weight: 600; color: #495057;">Value</th>
                    <th style="padding: 15px; text-align: left; border-bottom: 2px solid #dee2e6; font-weight: 600; color: #495057;">Description</th>
                  </tr>
                </thead>
                <tbody>
                  <tr style="border-bottom: 1px solid #dee2e6;">
                    <td style="padding: 12px; font-weight: 500;">Date</td>
                    <td style="padding: 12px; text-align: right;">${formattedDate}</td>
                    <td style="padding: 12px; color: #6c757d;">Business day for this report</td>
                  </tr>
                  <tr style="border-bottom: 1px solid #dee2e6; background: #f8f9fa;">
                    <td style="padding: 12px; font-weight: 500;">Night Counter</td>
                    <td style="padding: 12px; text-align: right;">${dayData.night_counter || 'N/A'}</td>
                    <td style="padding: 12px; color: #6c757d;">Staff member who completed closing count</td>
                  </tr>
                  <tr style="border-bottom: 1px solid #dee2e6;">
                    <td style="padding: 12px; font-weight: 500;">Toast Sales</td>
                    <td style="padding: 12px; text-align: right; color: #28a745; font-weight: 600;">$${dayData.toast_sales?.toFixed(2) || '0.00'}</td>
                    <td style="padding: 12px; color: #6c757d;">Total sales reported by POS system</td>
                  </tr>
                  <tr style="border-bottom: 1px solid #dee2e6; background: #f8f9fa;">
                    <td style="padding: 12px; font-weight: 500;">Actual Cash In</td>
                    <td style="padding: 12px; text-align: right; color: #17a2b8; font-weight: 600;">$${dayData.actual_cash_in?.toFixed(2) || '0.00'}</td>
                    <td style="padding: 12px; color: #6c757d;">Physical cash counted in registers</td>
                  </tr>
                  <tr style="border-bottom: 1px solid #dee2e6;">
                    <td style="padding: 12px; font-weight: 500;">Discrepancy</td>
                    <td style="padding: 12px; text-align: right; color: ${dayData.discrepancy >= 0 ? '#28a745' : '#dc3545'}; font-weight: 600;">${dayData.discrepancy >= 0 ? '+' : ''}$${Math.abs(dayData.discrepancy || 0).toFixed(2)}</td>
                    <td style="padding: 12px; color: #6c757d;">Difference between expected and actual cash</td>
                  </tr>
                  <tr style="border-bottom: 1px solid #dee2e6; background: #f8f9fa;">
                    <td style="padding: 12px; font-weight: 500;">Excess</td>
                    <td style="padding: 12px; text-align: right; color: #6f42c1; font-weight: 600;">$${dayData.excess?.toFixed(2) || '0.00'}</td>
                    <td style="padding: 12px; color: #6c757d;">Amount moved from tips to balance operations</td>
                  </tr>
                  <tr style="border-bottom: 1px solid #dee2e6;">
                    <td style="padding: 12px; font-weight: 500;">Week Start</td>
                    <td style="padding: 12px; text-align: right;">${weekStart}</td>
                    <td style="padding: 12px; color: #6c757d;">Start of report week containing this day</td>
                  </tr>
                  <tr style="border-bottom: 1px solid #dee2e6; background: #f8f9fa;">
                    <td style="padding: 12px; font-weight: 500;">Week End</td>
                    <td style="padding: 12px; text-align: right;">${weekEnd}</td>
                    <td style="padding: 12px; color: #6c757d;">End of report week containing this day</td>
                  </tr>
                  <tr style="border-bottom: 1px solid #dee2e6;">
                    <td style="padding: 12px; font-weight: 500;">Weekly Report By</td>
                    <td style="padding: 12px; text-align: right;">${dayData.weekly_combined_reports.generated_by || 'N/A'}</td>
                    <td style="padding: 12px; color: #6c757d;">Manager who generated the weekly report</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Notes Section -->
        <div style="background: white; border-radius: 0; box-shadow: 0 4px 20px rgba(0,0,0,0.08); overflow: hidden; margin-bottom: 20px;">
          <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 20px;">
            <h3 style="margin: 0; font-size: 20px; font-weight: 600; display: flex; align-items: center;">
              <span style="margin-right: 10px;"></span>
              Important Notes
            </h3>
          </div>
          
          <div style="padding: 30px;">
            <div style="background: #e3f2fd; border-left: 4px solid #2196f3; padding: 20px; border-radius: 0; margin-bottom: 20px;">
              <h4 style="margin: 0 0 10px 0; color: #1976d2; font-size: 16px;">Understanding the Data</h4>
              <ul style="margin: 10px 0 0 20px; color: #424242; line-height: 1.6;">
                <li><strong>Discrepancy:</strong> Shows cash over/under compared to expected sales (negative = short, positive = over)</li>
                <li><strong>Excess:</strong> Amount taken from tips to balance daily operations</li>
                <li><strong>Accuracy Rate:</strong> Calculated based on variance from expected cash amounts</li>
              </ul>
            </div>
            
            <div style="background: #f3e5f5; border-left: 4px solid #9c27b0; padding: 20px; border-radius: 0;">
              <h4 style="margin: 0 0 10px 0; color: #7b1fa2; font-size: 16px;">Performance Benchmarks</h4>
              <ul style="margin: 10px 0 0 20px; color: #424242; line-height: 1.6;">
                <li><strong>Excellent:</strong> Discrepancy under $5 (98%+ accuracy)</li>
                <li><strong>Good:</strong> Discrepancy $5-$20 (95%+ accuracy)</li>
                <li><strong>Review Needed:</strong> Discrepancy over $20 (requires attention)</li>
              </ul>
            </div>
          </div>
        </div>

        <!-- Footer -->
        <div style="text-align: center; padding: 20px; color: #6c757d; font-size: 12px; border-top: 1px solid #dee2e6;">
          <p style="margin: 0;">Report generated by Jayna Gyro Cash Counter v3.0+ | ${new Date().toLocaleString()}</p>
          <p style="margin: 5px 0 0 0;">Designed and coded by Demetri Gregorakis | demetri_gregorakis@icloud.com</p>
        </div>
      </div>
    `;
  }

  // Generate Weekly Historical Report
  async function generateWeeklyHistoricalReport() {
    const reportId = document.getElementById('savedWeeksDropdown').value;
    
    console.log('Selected report ID:', reportId);
    
    if (!reportId) {
      throw new Error('Please select a saved weekly report from the dropdown');
    }
    
    if (!supabase) {
      throw new Error('Database connection not available');
    }
    
    // Get the saved report data including the generated HTML content
    const { data: reportData, error: reportError } = await supabase
      .from('weekly_combined_reports')
      .select('*')
      .eq('id', reportId)
      .single();
    
    if (reportError) {
      console.error('Report query error:', reportError);
      throw new Error(`Failed to load report: ${reportError.message}`);
    }
    
    if (!reportData) {
      throw new Error('Report not found');
    }
    
    console.log('Retrieved report data:', reportData);
    console.log('Has cash HTML:', !!reportData.generated_cash_report_html);
    console.log('Has tip pool HTML:', !!reportData.generated_tip_pool_html);
    
    // Display the saved HTML content directly
    const reportContent = document.getElementById('reportContent');
    
    console.log('About to set report content...');
    console.log('Report data keys:', Object.keys(reportData));
    console.log('Cash HTML length:', reportData.generated_cash_report_html?.length || 0);
    console.log('Tip pool HTML length:', reportData.generated_tip_pool_html?.length || 0);
    
    if (reportData.generated_cash_report_html && reportData.generated_tip_pool_html) {
      // We have saved HTML content - display it in the main content area like tip pool results!
      const mainContentHtml = `
        <div style="max-width: 1200px; margin: 0 auto; padding: 20px;">
          <div style="background: #f8f9fa; padding: 20px; border-radius: 0; margin-bottom: 20px; border-left: 4px solid #28a745;">
            <h3 style="margin: 0 0 10px 0; color: #28a745;">Historical Report Retrieved</h3>
            <p style="margin: 0; font-size: 14px;">Report for: ${new Date(reportData.week_start_date).toLocaleDateString()} - ${new Date(reportData.week_end_date).toLocaleDateString()}</p>
            <p style="margin: 0; font-size: 14px;">Generated by: ${reportData.generated_by} on ${new Date(reportData.generated_at).toLocaleDateString()}</p>
            <div style="text-align: center; margin-top: 15px;">
              <button class="submit-btn" onclick="downloadHistoricalReportPDF('${reportData.week_start_date}', '${reportData.week_end_date}')" style="margin-right: 10px;">Download PDF</button>
              <button class="submit-btn" onclick="goHome()">Back to Menu</button>
            </div>
          </div>
          
          <div style="margin-bottom: 30px;">
            <h3 style="color: #1e3c72; margin-bottom: 15px; border-bottom: 2px solid #1e3c72; padding-bottom: 5px;">WEEKLY CASH REPORT</h3>
            ${reportData.generated_cash_report_html}
          </div>
          
          <div>
            <h3 style="color: #1e3c72; margin-bottom: 15px; border-bottom: 2px solid #1e3c72; padding-bottom: 5px;">TIP POOL DISTRIBUTION</h3>
            ${reportData.generated_tip_pool_html}
          </div>
          
          <div style="text-align: center; margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 0;">
            <button class="submit-btn" onclick="downloadHistoricalReportPDF('${reportData.week_start_date}', '${reportData.week_end_date}')" style="margin-right: 10px;">Download PDF</button>
            <button class="submit-btn" onclick="goHome()">Back to Menu</button>
          </div>
        </div>
      `;
      
      console.log('Setting main content HTML...');
      console.log('HTML length:', mainContentHtml.length);
      
      // Use the proven working method - set content and show like tip pool results
      reportContent.innerHTML = mainContentHtml;
      
      // Store the report data globally for PDF generation
      window.currentHistoricalReport = reportData;
      
      // Hide all sections and show the results (copy exact pattern from tip pool)
      hideAllSections();
      
      console.log('Looking for reportResults element...');
      const reportResultsElement = document.getElementById('reportResults');
      console.log('reportResults element found:', !!reportResultsElement);
      console.log('reportResults element:', reportResultsElement);
      
      if (reportResultsElement) {
        console.log('=== ALTERNATIVE DISPLAY METHOD ===');
        
        // NUCLEAR OPTION: Create a completely new modal-style overlay
        const overlay = document.createElement('div');
        overlay.id = 'reportOverlay';
        overlay.style.cssText = `
          position: fixed !important;
          top: 0 !important;
          left: 0 !important;
          width: 100vw !important;
          height: 100vh !important;
          background: rgba(0, 0, 0, 0.8) !important;
          z-index: 99999 !important;
          display: flex !important;
          align-items: center !important;
          justify-content: center !important;
          overflow: auto !important;
        `;
        
        const contentBox = document.createElement('div');
        contentBox.style.cssText = `
          background: white !important;
          margin: 20px !important;
          padding: 30px !important;
          border-radius: 8px !important;
          max-width: 90vw !important;
          max-height: 90vh !important;
          overflow: auto !important;
          position: relative !important;
          box-shadow: 0 4px 20px rgba(0,0,0,0.3) !important;
        `;
        
        // Add close button
        const closeBtn = document.createElement('button');
        closeBtn.innerHTML = 'X Close Report';
        closeBtn.style.cssText = `
          position: sticky !important;
          top: 0 !important;
          right: 0 !important;
          float: right !important;
          background: #dc3545 !important;
          color: white !important;
          border: none !important;
          padding: 10px 15px !important;
          border-radius: 4px !important;
          cursor: pointer !important;
          margin-bottom: 20px !important;
          font-size: 14px !important;
        `;
        closeBtn.onclick = () => document.body.removeChild(overlay);
        
        // Add PDF download button
        const downloadBtn = document.createElement('button');
        downloadBtn.innerHTML = 'Download PDF';
        downloadBtn.style.cssText = `
          position: sticky !important;
          top: 0 !important;
          right: 120px !important;
          float: right !important;
          background: #28a745 !important;
          color: white !important;
          border: none !important;
          padding: 10px 15px !important;
          border-radius: 4px !important;
          cursor: pointer !important;
          margin-bottom: 20px !important;
          margin-right: 10px !important;
          font-size: 14px !important;
        `;
        downloadBtn.onclick = () => {
          if (window.currentHistoricalReport) {
            downloadHistoricalReportPDF(window.currentHistoricalReport.week_start_date, window.currentHistoricalReport.week_end_date);
          } else {
            alert('Report data not available for PDF download');
          }
        };
        
        // Copy the content (clean it up to remove duplicate forms)
        contentBox.appendChild(closeBtn);
        contentBox.appendChild(downloadBtn);
        const contentDiv = document.createElement('div');
        
        // Clean the content - remove any tip pool forms that shouldn't be there
        let cleanContent = reportContent.innerHTML;
        
        // Remove the Weekly Combined Report section and all form elements
        cleanContent = cleanContent.replace(/<div[^>]*id="combinedReportSection"[^>]*>.*?<\/div>/gs, '');
        cleanContent = cleanContent.replace(/<div[^>]*id="tipPoolForm"[^>]*>.*?<\/div>/gs, '');
        cleanContent = cleanContent.replace(/<form[^>]*>.*?<\/form>/gs, '');
        cleanContent = cleanContent.replace(/<button[^>]*onclick="goHome\(\)"[^>]*>.*?<\/button>/gs, '');
        cleanContent = cleanContent.replace(/Weekly Combined Report[\s\S]*?Generate Combined Weekly Report/g, '');
        cleanContent = cleanContent.replace(/Download PDF Back to Menu/g, '');
        
        contentDiv.innerHTML = cleanContent;
        contentBox.appendChild(contentDiv);
        
        overlay.appendChild(contentBox);
        document.body.appendChild(overlay);
        
        console.log('Created modal overlay for report display');
        console.log('Report should be visible as modal overlay!');
        
      } else {
        console.error('reportResults element not found!');
      }
      
      console.log('Historical report content should now be visible');
      
    } else {
      // Fallback: no HTML content saved, show basic info
      const legacyContentHtml = `
        <div style="max-width: 800px; margin: 0 auto; padding: 20px;">
          <div style="background: #fff3cd; padding: 20px; border-radius: 0; border-left: 4px solid #ffc107;">
            <h3 style="margin: 0 0 10px 0; color: #856404;">Legacy Report Format</h3>
            <p style="margin: 0 0 10px 0; font-size: 14px;">This report was generated before HTML content saving was implemented.</p>
            <p style="margin: 0; font-size: 14px;"><strong>Report Details:</strong></p>
            <ul style="margin: 10px 0 0 20px;">
              <li>Week: ${new Date(reportData.week_start_date).toLocaleDateString()} - ${new Date(reportData.week_end_date).toLocaleDateString()}</li>
              <li>Generated by: ${reportData.generated_by}</li>
              <li>Generated on: ${new Date(reportData.generated_at).toLocaleDateString()}</li>
              <li>Total Tips: $${reportData.total_tips || 0}</li>
              <li>Tip Pool Total: $${reportData.tip_pool_total || 0}</li>
            </ul>
            <div style="text-align: center; margin-top: 20px;">
              <button class="submit-btn" onclick="goHome()">Back to Menu</button>
            </div>
          </div>
        </div>
      `;
      
      console.log('Setting legacy content HTML...');
      reportContent.innerHTML = legacyContentHtml;
      
      hideAllSections();
      
      console.log('Looking for reportResults element (legacy)...');
      const reportResultsElement = document.getElementById('reportResults');
      console.log('reportResults element found (legacy):', !!reportResultsElement);
      
      if (reportResultsElement) {
        console.log('=== ALTERNATIVE DISPLAY METHOD (LEGACY) ===');
        
        // NUCLEAR OPTION: Create a completely new modal-style overlay
        const overlay = document.createElement('div');
        overlay.id = 'reportOverlayLegacy';
        overlay.style.cssText = `
          position: fixed !important;
          top: 0 !important;
          left: 0 !important;
          width: 100vw !important;
          height: 100vh !important;
          background: rgba(0, 0, 0, 0.8) !important;
          z-index: 99999 !important;
          display: flex !important;
          align-items: center !important;
          justify-content: center !important;
          overflow: auto !important;
        `;
        
        const contentBox = document.createElement('div');
        contentBox.style.cssText = `
          background: white !important;
          margin: 20px !important;
          padding: 30px !important;
          border-radius: 8px !important;
          max-width: 90vw !important;
          max-height: 90vh !important;
          overflow: auto !important;
          position: relative !important;
          box-shadow: 0 4px 20px rgba(0,0,0,0.3) !important;
        `;
        
        // Add close button
        const closeBtn = document.createElement('button');
        closeBtn.innerHTML = 'X Close Report (Legacy)';
        closeBtn.style.cssText = `
          position: sticky !important;
          top: 0 !important;
          right: 0 !important;
          float: right !important;
          background: #dc3545 !important;
          color: white !important;
          border: none !important;
          padding: 10px 15px !important;
          border-radius: 4px !important;
          cursor: pointer !important;
          margin-bottom: 20px !important;
          font-size: 14px !important;
        `;
        closeBtn.onclick = () => document.body.removeChild(overlay);
        
        // Set fallback content
        contentBox.appendChild(closeBtn);
        const contentDiv = document.createElement('div');
        contentDiv.innerHTML = '<h2>Legacy Report Content</h2><p>This is the legacy path display.</p>';
        contentBox.appendChild(contentDiv);
        
        overlay.appendChild(contentBox);
        document.body.appendChild(overlay);
        
        console.log('Created modal overlay for report display (legacy)');
        
      } else {
        console.error('reportResults element not found (legacy)!');
      }
    }
  }

  // Generate PM Flow Single Day Report HTML
  function generatePMFlowSingleDayReportHtml(fullData, reportDate) {
    // Format date with day of the week
    const dateObj = new Date(reportDate + 'T00:00:00');
    const dayOfWeek = dateObj.toLocaleDateString('en-US', { weekday: 'long' }).toUpperCase();
    const formattedDate = dateObj.toLocaleDateString('en-US', { 
      year: 'numeric', 
      month: 'long', 
      day: 'numeric' 
    }).toUpperCase();
    
    // Calculate amounts using PM flow logic
    const amTotal = fullData.am_total || 0;
    const pmTotal = fullData.pm_total || 0;
    const toastSales = fullData.pm_toast_sales || 0;
    const originalTips = fullData.pm_cash_tips || 0;
    const actualCashIn = pmTotal - amTotal;
    const discrepancy = actualCashIn - toastSales;
    const discrepancySign = discrepancy >= 0 ? '+' : '-';
    const largeDiscrepancyFlag = Math.abs(discrepancy) > 10 ? ' LARGE DISCREPANCY!' : '';
    
    // Additional PM flow calculations
    const tipAdjustment = (originalTips - (fullData.pm_adjusted_tips || originalTips));
    const rawDepositAmount = fullData.pm_deposit_amount ? (toastSales + originalTips) : 0;
    const roundedDepositAmount = fullData.pm_deposit_amount || 0;
    const depositRoundingAdjustment = rawDepositAmount - roundedDepositAmount;
    const depositTipAdjustment = fullData.pm_adjusted_tips ? (originalTips - fullData.pm_adjusted_tips) : 0;
    const depositExcessToCashbox = Math.abs(depositRoundingAdjustment);
    const returnBreakdown = fullData.pm_amount_to_keep ? (fullData.pm_amount_to_keep - amTotal) : 0;
    
    // Helper function to get denomination breakdown
    function getDenominationBreakdown(drawerData, prefix) {
      if (!drawerData) return `<div style="color: #999; font-style: italic;">No data available</div>`;
      
      const counts = drawerData.counts || drawerData;
      
      return `
        <div>$100: ${counts.hundreds || 0} = $${((counts.hundreds || 0) * 100).toFixed(2)}</div>
        <div>$50: ${counts.fifties || 0} = $${((counts.fifties || 0) * 50).toFixed(2)}</div>
        <div>$20: ${counts.twenties || 0} = $${((counts.twenties || 0) * 20).toFixed(2)}</div>
        <div>$10: ${counts.tens || 0} = $${((counts.tens || 0) * 10).toFixed(2)}</div>
        <div>$5: ${counts.fives || 0} = $${((counts.fives || 0) * 5).toFixed(2)}</div>
        <div>$1: ${counts.ones || 0} = $${((counts.ones || 0) * 1).toFixed(2)}</div>
        <div>¢25: ${counts.quarters || 0} = $${((counts.quarters || 0) * 0.25).toFixed(2)}</div>
        <div>¢10: ${counts.dimes || 0} = $${((counts.dimes || 0) * 0.10).toFixed(2)}</div>
        <div>¢5: ${counts.nickels || 0} = $${((counts.nickels || 0) * 0.05).toFixed(2)}</div>
        <div>¢1: ${counts.pennies || 0} = $${((counts.pennies || 0) * 0.01).toFixed(2)}</div>
      `;
    }
    
    return `
      <div style="font-family: Arial, sans-serif; margin: 0; padding: 8px; font-size: 12px; line-height: 1.3; max-width: 800px;">
        
        <div style="text-align: center; font-weight: bold; font-size: 18px; margin-bottom: 4px; border-bottom: 2px solid #000; padding-bottom: 6px;">
          JAYNA GYRO DAILY CASH REPORT
        </div>
        
        <div style="text-align: center; font-weight: bold; font-size: 16px; margin-bottom: 12px; padding-bottom: 6px;">
          ${dayOfWeek} ${formattedDate}
        </div>

        <!-- Staff and Timing Info -->
        <div style="border: 1px solid #000; margin: 6px 0; padding: 8px;">
          <div style="display: table; width: 100%;">
            <div style="display: table-cell; width: 50%; vertical-align: top; padding: 0 6px; border-right: 1px solid #ccc;">
              <div style="display: flex; justify-content: space-between; margin: 2px 0; max-width: 180px;">
                <span style="font-weight: bold; text-align: right; padding-right: 10px;">AM Counter:</span>
                <span style="text-align: left; font-weight: bold;">${fullData.am_counter || 'N/A'}</span>
              </div>
              <div style="display: flex; justify-content: space-between; margin: 2px 0; max-width: 180px;">
                <span style="font-weight: bold; text-align: right; padding-right: 10px;">AM Time:</span>
                <span style="text-align: left; font-weight: bold;">${fullData.am_timestamp ? new Date(fullData.am_timestamp).toLocaleString() : 'N/A'}</span>
              </div>
            </div>
            <div style="display: table-cell; width: 50%; vertical-align: top; padding: 0 6px;">
              <div style="display: flex; justify-content: space-between; margin: 2px 0; max-width: 180px;">
                <span style="font-weight: bold; text-align: right; padding-right: 10px;">PM Counter:</span>
                <span style="text-align: left; font-weight: bold;">${fullData.pm_counter || 'N/A'}</span>
              </div>
              <div style="display: flex; justify-content: space-between; margin: 2px 0; max-width: 180px;">
                <span style="font-weight: bold; text-align: right; padding-right: 10px;">PM Time:</span>
                <span style="text-align: left; font-weight: bold;">${fullData.pm_timestamp ? new Date(fullData.pm_timestamp).toLocaleString() : 'N/A'}</span>
              </div>
            </div>
          </div>
        </div>

        ${amTotal > 0 ? `
        <!-- Cash Summary -->
        <div style="border: 1px solid #000; margin: 6px 0; padding: 8px;">
          <div style="font-weight: bold; font-size: 14px; text-align: center; margin-bottom: 6px; border-bottom: 1px solid #000; padding-bottom: 3px;">CASH FLOW SUMMARY</div>
          <div style="display: table; width: 100%;">
            <div style="display: table-cell; width: 50%; vertical-align: top; padding: 0 6px; border-right: 1px solid #ccc;">
              <div style="display: flex; justify-content: space-between; margin: 2px 0; max-width: 180px;">
                <span style="font-weight: bold; text-align: right; padding-right: 10px;">Starting Cash (AM):</span>
                <span style="text-align: left; font-weight: bold;">$${amTotal.toFixed(2)}</span>
              </div>
              <div style="display: flex; justify-content: space-between; margin: 2px 0; max-width: 180px;">
                <span style="font-weight: bold; text-align: right; padding-right: 10px;">Ending Cash (PM):</span>
                <span style="text-align: left; font-weight: bold;">$${pmTotal.toFixed(2)}</span>
              </div>
              <div style="display: flex; justify-content: space-between; margin: 2px 0; max-width: 180px;">
                <span style="font-weight: bold; text-align: right; padding-right: 10px;">Actual Cash In:</span>
                <span style="text-align: left; font-weight: bold;">$${actualCashIn.toFixed(2)}</span>
              </div>
            </div>
            <div style="display: table-cell; width: 50%; vertical-align: top; padding: 0 6px;">
              <div style="display: flex; justify-content: space-between; margin: 2px 0; max-width: 180px;">
                <span style="font-weight: bold; text-align: right; padding-right: 10px;">Toast Sales:</span>
                <span style="text-align: left; font-weight: bold;">$${toastSales.toFixed(2)}</span>
              </div>
              <div style="display: flex; justify-content: space-between; margin: 2px 0; max-width: 180px;">
                <span style="font-weight: bold; text-align: right; padding-right: 10px;">Original Tips:</span>
                <span style="text-align: left; font-weight: bold;">$${originalTips.toFixed(2)}</span>
              </div>
              <div style="display: flex; justify-content: space-between; margin: 2px 0; max-width: 180px;">
                <span style="font-weight: bold; text-align: right; padding-right: 10px;">Discrepancy:</span>
                <span style="text-align: left; font-weight: bold;">${discrepancySign}$${Math.abs(discrepancy).toFixed(2)}${largeDiscrepancyFlag}</span>
              </div>
            </div>
          </div>
        </div>
        ` : ''}

        ${fullData.pm_deposit_amount ? `
        <!-- Deposit Instructions -->
        <div style="background-color: #e6ffe6; border: 2px solid #000; padding: 8px; text-align: center; font-weight: bold; font-size: 13px; margin: 6px 0;">
          DEPOSIT IN ENVELOPE: $${fullData.pm_deposit_amount}
          <div style="font-size: 10px;">(Toast Sales $${toastSales.toFixed(2)} + Original Tips $${originalTips.toFixed(2)})</div>
        </div>
        <div style="background-color: #fff0e6; border: 2px solid #000; padding: 8px; text-align: center; font-weight: bold; font-size: 13px; margin: 6px 0;">
          RETURN TO CASHBOX/SAFE: $${fullData.pm_amount_to_keep ? fullData.pm_amount_to_keep.toFixed(2) : '0.00'}
        </div>
        ` : ''}

        <!-- Notes Section -->
        <div style="display: table; width: 100%; margin: 6px 0;">
          <div style="display: table-cell; width: 50%; padding: 6px; border: 1px solid #000; vertical-align: top; text-align: center; font-weight: bold; background-color: #e6f3ff;">
            <div style="font-weight: bold; text-align: center; margin-bottom: 4px;">AM NOTES</div>
            <div style="text-align: center; font-weight: bold;">
              ${fullData.am_notes || 'No AM Notes'}
            </div>
          </div>
          <div style="display: table-cell; width: 50%; padding: 6px; border: 1px solid #000; border-left: none; vertical-align: top; text-align: center; font-weight: bold; background-color: #fff8f0;">
            <div style="font-weight: bold; text-align: center; margin-bottom: 4px;">PM NOTES</div>
            <div style="text-align: center; font-weight: bold;">
              ${fullData.pm_notes || 'No PM Notes'}
            </div>
          </div>
        </div>

        <!-- Manager Breakdown -->
        <div style="border: 1px solid #000; margin: 6px 0; padding: 8px;">
          <div style="font-weight: bold; font-size: 14px; text-align: center; margin-bottom: 6px; border-bottom: 1px solid #000; padding-bottom: 3px;">MANAGER BREAKDOWN</div>
          <div style="display: table; width: 100%;">
            <div style="display: table-row;"><div style="display: table-cell; padding: 3px 6px; border-bottom: 1px dotted #ccc; font-weight: bold; width: 50%; text-align: right; padding-right: 10px;">Starting Cash Total:</div><div style="display: table-cell; padding: 3px 6px; border-bottom: 1px dotted #ccc; text-align: left; font-weight: bold; width: 50%; padding-left: 10px;">$${amTotal.toFixed(2)}</div></div>
            <div style="display: table-row;"><div style="display: table-cell; padding: 3px 6px; border-bottom: 1px dotted #ccc; font-weight: bold; width: 50%; text-align: right; padding-right: 10px;">Ending Cash Total:</div><div style="display: table-cell; padding: 3px 6px; border-bottom: 1px dotted #ccc; text-align: left; font-weight: bold; width: 50%; padding-left: 10px;">$${pmTotal.toFixed(2)}</div></div>
            <div style="display: table-row;"><div style="display: table-cell; padding: 3px 6px; border-bottom: 1px dotted #ccc; font-weight: bold; width: 50%; text-align: right; padding-right: 10px;">Actual Cash In:</div><div style="display: table-cell; padding: 3px 6px; border-bottom: 1px dotted #ccc; text-align: left; font-weight: bold; width: 50%; padding-left: 10px;">$${actualCashIn.toFixed(2)}</div></div>
            <div style="display: table-row;"><div style="display: table-cell; padding: 3px 6px; border-bottom: 1px dotted #ccc; font-weight: bold; width: 50%; text-align: right; padding-right: 10px;">Toast Sales Reported:</div><div style="display: table-cell; padding: 3px 6px; border-bottom: 1px dotted #ccc; text-align: left; font-weight: bold; width: 50%; padding-left: 10px;">$${toastSales.toFixed(2)}</div></div>
            <div style="display: table-row;"><div style="display: table-cell; padding: 3px 6px; border-bottom: 1px dotted #ccc; font-weight: bold; width: 50%; text-align: right; padding-right: 10px;">Tips Reported by Staff:</div><div style="display: table-cell; padding: 3px 6px; border-bottom: 1px dotted #ccc; text-align: left; font-weight: bold; width: 50%; padding-left: 10px;">$${originalTips.toFixed(2)}</div></div>
            <div style="display: table-row;"><div style="display: table-cell; padding: 3px 6px; border-bottom: 1px dotted #ccc; font-weight: bold; width: 50%; text-align: right; padding-right: 10px;">Discrepancy (Drawers vs Toast):</div><div style="display: table-cell; padding: 3px 6px; border-bottom: 1px dotted #ccc; text-align: left; font-weight: bold; width: 50%; padding-left: 10px;">${discrepancySign}$${Math.abs(discrepancy).toFixed(2)}</div></div>
            ${tipAdjustment > 0 ? `
            <div style="display: table-row;"><div style="display: table-cell; padding: 3px 6px; border-bottom: 1px dotted #ccc; font-weight: bold; width: 50%; text-align: right; padding-right: 10px;">Cash Tip Adjustment:</div><div style="display: table-cell; padding: 3px 6px; border-bottom: 1px dotted #ccc; text-align: left; font-weight: bold; width: 50%; padding-left: 10px;">-$${tipAdjustment.toFixed(2)}</div></div>
            ` : ''}
            ${Math.abs(depositRoundingAdjustment) > 0.001 ? `
            <div style="display: table-row; background-color: #fff3cd;"><div style="display: table-cell; padding: 3px 6px; border-bottom: 1px dotted #ccc; font-weight: bold; width: 50%; text-align: right; padding-right: 10px;">Raw Deposit Amount:</div><div style="display: table-cell; padding: 3px 6px; border-bottom: 1px dotted #ccc; text-align: left; font-weight: bold; width: 50%; padding-left: 10px;">$${rawDepositAmount.toFixed(2)}</div></div>
            <div style="display: table-row; background-color: #fff3cd;"><div style="display: table-cell; padding: 3px 6px; border-bottom: 1px dotted #ccc; font-weight: bold; width: 50%; text-align: right; padding-right: 10px;">Rounded Deposit Amount:</div><div style="display: table-cell; padding: 3px 6px; border-bottom: 1px dotted #ccc; text-align: left; font-weight: bold; width: 50%; padding-left: 10px;">$${roundedDepositAmount}</div></div>
            <div style="display: table-row; background-color: #fff3cd;"><div style="display: table-cell; padding: 3px 6px; border-bottom: 1px dotted #ccc; font-weight: bold; width: 50%; text-align: right; padding-right: 10px;">Rounding Adjustment Needed:</div><div style="display: table-cell; padding: 3px 6px; border-bottom: 1px dotted #ccc; text-align: left; font-weight: bold; width: 50%; padding-left: 10px;">$${depositRoundingAdjustment.toFixed(2)}</div></div>
            <div style="display: table-row; background-color: #fff3cd;"><div style="display: table-cell; padding: 3px 6px; border-bottom: 1px dotted #ccc; font-weight: bold; width: 50%; text-align: right; padding-right: 10px;">Taken from Tips (Whole $):</div><div style="display: table-cell; padding: 3px 6px; border-bottom: 1px dotted #ccc; text-align: left; font-weight: bold; width: 50%; padding-left: 10px;">${depositTipAdjustment > 0 ? `-$${depositTipAdjustment.toFixed(2)}` : '-$'}</div></div>
            <div style="display: table-row; background-color: #fff3cd;"><div style="display: table-cell; padding: 3px 6px; border-bottom: 1px dotted #ccc; font-weight: bold; width: 50%; text-align: right; padding-right: 10px;">Excess to Cashbox:</div><div style="display: table-cell; padding: 3px 6px; border-bottom: 1px dotted #ccc; text-align: left; font-weight: bold; width: 50%; padding-left: 10px;">+$${depositExcessToCashbox.toFixed(2)}</div></div>
            ` : ''}
            ${fullData.pm_deposit_amount ? `
            <div style="display: table-row;"><div style="display: table-cell; padding: 3px 6px; border-bottom: 1px dotted #ccc; font-weight: bold; width: 50%; text-align: right; padding-right: 10px;">Owed to Restaurant:</div><div style="display: table-cell; padding: 3px 6px; border-bottom: 1px dotted #ccc; text-align: left; font-weight: bold; width: 50%; padding-left: 10px;">$${toastSales.toFixed(2)}</div></div>
            <div style="display: table-row;"><div style="display: table-cell; padding: 3px 6px; border-bottom: 1px dotted #ccc; font-weight: bold; width: 50%; text-align: right; padding-right: 10px;">Cash Tips Owed to Staff:</div><div style="display: table-cell; padding: 3px 6px; border-bottom: 1px dotted #ccc; text-align: left; font-weight: bold; width: 50%; padding-left: 10px;">$${fullData.pm_adjusted_tips || originalTips}</div></div>
            <div style="display: table-row;"><div style="display: table-cell; padding: 3px 6px; border-bottom: 1px dotted #ccc; font-weight: bold; width: 50%; text-align: right; padding-right: 10px;">Returned to Cashbox:</div><div style="display: table-cell; padding: 3px 6px; border-bottom: 1px dotted #ccc; text-align: left; font-weight: bold; width: 50%; padding-left: 10px;">$${returnBreakdown.toFixed(2)} + AM Total</div></div>
            ` : ''}
          </div>
        </div>

        <!-- Complete Cash Count Breakdown -->
        <div style="border: 1px solid #000; margin: 6px 0; padding: 8px;">
          <div style="font-weight: bold; font-size: 14px; text-align: center; margin-bottom: 6px; border-bottom: 1px solid #000; padding-bottom: 3px;">COMPLETE CASH COUNT BREAKDOWN</div>
          <div style="display: table; width: 100%;">
            <!-- AM Counts -->
            <div style="display: table-cell; width: 50%; vertical-align: top; padding: 0 6px; border-right: 1px solid #ccc;">
              <div style="text-align: center; font-weight: bold; font-size: 10px; margin-bottom: 4px; background-color: #e6f3ff; padding: 3px;">AM COUNTS</div>
              
              <div style="font-size: 10px; line-height: 1.2;">
                <div style="font-weight: bold; text-decoration: underline; margin-bottom: 3px;">DRAWER A</div>
                ${getDenominationBreakdown(fullData.am_drawer1_data, 'am_drawer1')}
                <div style="font-weight: bold; border-top: 1px solid #000; margin-top: 3px; padding-top: 3px;">TOTAL: $${fullData.am_drawer1_total ? fullData.am_drawer1_total.toFixed(2) : '0.00'}</div>
              </div>
              
              <div style="font-size: 10px; line-height: 1.2; margin-top: 6px;">
                <div style="font-weight: bold; text-decoration: underline; margin-bottom: 3px;">DRAWER B</div>
                ${getDenominationBreakdown(fullData.am_drawer2_data, 'am_drawer2')}
                <div style="font-weight: bold; border-top: 1px solid #000; margin-top: 3px; padding-top: 3px;">TOTAL: $${fullData.am_drawer2_total ? fullData.am_drawer2_total.toFixed(2) : '0.00'}</div>
              </div>
              
              <div style="font-weight: bold; text-align: center; padding: 4px; border: 2px solid #000; margin-top: 6px; font-size: 10px; background-color: #e6f3ff;">TOTAL AM: $${amTotal.toFixed(2)}</div>
            </div>
            
            <!-- PM Counts -->
            <div style="display: table-cell; width: 50%; vertical-align: top; padding: 0 6px;">
              <div style="text-align: center; font-weight: bold; font-size: 10px; margin-bottom: 4px; background-color: #fff8f0; padding: 3px;">PM COUNTS</div>
              
              <div style="font-size: 10px; line-height: 1.2;">
                <div style="font-weight: bold; text-decoration: underline; margin-bottom: 3px;">DRAWER A</div>
                ${getDenominationBreakdown(fullData.pm_drawer1_data, 'pm_drawer1')}
                <div style="font-weight: bold; border-top: 1px solid #000; margin-top: 3px; padding-top: 3px;">TOTAL: $${fullData.pm_drawer1_total ? fullData.pm_drawer1_total.toFixed(2) : '0.00'}</div>
              </div>
              
              <div style="font-size: 10px; line-height: 1.2; margin-top: 6px;">
                <div style="font-weight: bold; text-decoration: underline; margin-bottom: 3px;">DRAWER B</div>
                ${getDenominationBreakdown(fullData.pm_drawer2_data, 'pm_drawer2')}
                <div style="font-weight: bold; border-top: 1px solid #000; margin-top: 3px; padding-top: 3px;">TOTAL: $${fullData.pm_drawer2_total ? fullData.pm_drawer2_total.toFixed(2) : '0.00'}</div>
              </div>
              
              <div style="font-weight: bold; text-align: center; padding: 4px; border: 2px solid #000; margin-top: 6px; font-size: 10px; background-color: #fff8f0;">TOTAL PM: $${pmTotal.toFixed(2)}</div>
            </div>
          </div>
        </div>
      </div>
    `;
  }

  // Generate PM Flow Single Day PDF Report
  async function generatePMFlowSingleDayPDF(fullData, reportDate) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'letter' });
    
    const pageWidth = doc.internal.pageSize.getWidth();
    const pageHeight = doc.internal.pageSize.getHeight();
    const margin = 20; // Tight margins like screenshot
    let currentY = margin + 10;
    
    // Helper function to draw bordered sections like screenshot
    function drawBorderedSection(x, y, width, height, fillColor = null) {
      doc.setDrawColor(0, 0, 0);
      doc.setLineWidth(0.5);
      if (fillColor) {
        doc.setFillColor(fillColor[0], fillColor[1], fillColor[2]);
        doc.rect(x, y, width, height, 'FD');
      } else {
        doc.rect(x, y, width, height, 'S');
      }
    }
    
    // Helper function for denomination breakdown in tight format
    function drawDenominationBreakdown(drawerData, startX, startY, width, title) {
      let y = startY + 10;
      
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(8);
      doc.text(title, startX + 3, y);
      y += 12;
      
      if (!drawerData) {
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(7);
        doc.text('(Detailed counts not available)', startX + 3, y);
        return y + 15;
      }
      
      // Handle JSON string data from database
      let counts = drawerData;
      if (typeof drawerData === 'string') {
        try {
          counts = JSON.parse(drawerData);
        } catch (e) {
          doc.setFont('helvetica', 'normal');
          doc.setFontSize(7);
          doc.text('(Detailed counts not available)', startX + 3, y);
          return y + 15;
        }
      }
      
      // Access counts property if it exists, otherwise use the object directly
      if (counts && counts.counts) {
        counts = counts.counts;
      }
      
      if (!counts || typeof counts !== 'object') {
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(7);
        doc.text('(Detailed counts not available)', startX + 3, y);
        return y + 15;
      }
      
      doc.setFont('helvetica', 'normal');
      doc.setFontSize(7);
      
      // All denominations in tight format
      const denominations = [
        { name: '$100', field: 'hundreds', value: 100 },
        { name: '$50', field: 'fifties', value: 50 },
        { name: '$20', field: 'twenties', value: 20 },
        { name: '$10', field: 'tens', value: 10 },
        { name: '$5', field: 'fives', value: 5 },
        { name: '$1', field: 'ones', value: 1 },
        { name: '¢25', field: 'quarters', value: 0.25 },
        { name: '¢10', field: 'dimes', value: 0.10 },
        { name: '¢5', field: 'nickels', value: 0.05 },
        { name: '¢1', field: 'pennies', value: 0.01 }
      ];
      
      let hasAnyData = false;
      denominations.forEach(denom => {
        const count = counts[denom.field] || 0;
        if (count > 0) {
          hasAnyData = true;
          const total = (count * denom.value).toFixed(2);
          doc.text(`${denom.name}: ${count} = $${total}`, startX + 3, y);
          y += 9;
        }
      });
      
      // If no denomination data, show fallback message
      if (!hasAnyData) {
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(7);
        doc.text('(Detailed counts not available)', startX + 3, y);
        y += 12;
      }
      
      return y;
    }
    
    // Format date
    const dateObj = new Date(reportDate + 'T00:00:00');
    const dayOfWeek = dateObj.toLocaleDateString('en-US', { weekday: 'long' }).toUpperCase();
    const formattedDate = dateObj.toLocaleDateString('en-US', { 
      year: 'numeric', 
      month: 'long', 
      day: 'numeric' 
    }).toUpperCase();
    
    // Calculate amounts
    const amTotal = fullData.am_total || 0;
    const pmTotal = fullData.pm_total || 0;
    const toastSales = fullData.pm_toast_sales || 0;
    const originalTips = fullData.pm_cash_tips || 0;
    const actualCashIn = pmTotal - amTotal;
    const discrepancy = actualCashIn - toastSales;
    const discrepancySign = discrepancy >= 0 ? '+' : '-';
    
    // Debug: Log the drawer data structure
    console.log('PDF Generation - Drawer Data Debug:');
    console.log('AM Drawer 1:', fullData.am_drawer1_data);
    console.log('AM Drawer 2:', fullData.am_drawer2_data); 
    console.log('PM Drawer 1:', fullData.pm_drawer1_data);
    console.log('PM Drawer 2:', fullData.pm_drawer2_data);
    
    const tipAdjustment = (originalTips - (fullData.pm_adjusted_tips || originalTips));
    const rawDepositAmount = fullData.pm_deposit_amount ? (toastSales + originalTips) : 0;
    const roundedDepositAmount = fullData.pm_deposit_amount || 0;
    const depositRoundingAdjustment = rawDepositAmount - roundedDepositAmount;
    const depositTipAdjustment = fullData.pm_adjusted_tips ? (originalTips - fullData.pm_adjusted_tips) : 0;
    const depositExcessToCashbox = Math.abs(depositRoundingAdjustment);
    const returnBreakdown = fullData.pm_amount_to_keep ? (fullData.pm_amount_to_keep - amTotal) : 0;
    
    // Header - exactly like screenshot
    drawBorderedSection(margin, currentY, pageWidth - 2 * margin, 25);
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(14);
    doc.text('JAYNA GYRO DAILY CASH REPORT', pageWidth / 2, currentY + 17, { align: 'center' });
    currentY += 25;
    
    // Date header - tight
    drawBorderedSection(margin, currentY, pageWidth - 2 * margin, 20);
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(12);
    doc.text(`${dayOfWeek} ${formattedDate}`, pageWidth / 2, currentY + 14, { align: 'center' });
    currentY += 20;
    
    // Staff info - tight like screenshot
    drawBorderedSection(margin, currentY, pageWidth - 2 * margin, 35);
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(8);
    
    const amTime = fullData.am_timestamp ? new Date(fullData.am_timestamp).toLocaleString() : 'N/A';
    const pmTime = fullData.pm_timestamp ? new Date(fullData.pm_timestamp).toLocaleString() : 'N/A';
    
    doc.text(`AM Counter: ${fullData.am_counter || 'N/A'}`, margin + 5, currentY + 12);
    doc.text(`AM Time: ${amTime}`, margin + 5, currentY + 24);
    doc.text(`PM Counter: ${fullData.pm_counter || 'N/A'}`, pageWidth / 2 + 5, currentY + 12);
    doc.text(`PM Time: ${pmTime}`, pageWidth / 2 + 5, currentY + 24);
    currentY += 35;
    
    // Cash Flow Summary header
    drawBorderedSection(margin, currentY, pageWidth - 2 * margin, 15);
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(10);
    doc.text('CASH FLOW SUMMARY', pageWidth / 2, currentY + 11, { align: 'center' });
    currentY += 15;
    
    // Cash flow content
    drawBorderedSection(margin, currentY, pageWidth - 2 * margin, 50);
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(8);
    
    // Left column - right aligned
    doc.text(`Starting Cash (AM): $${amTotal.toFixed(2)}`, pageWidth / 2 - 5, currentY + 12, { align: 'right' });
    doc.text(`Ending Cash (PM): $${pmTotal.toFixed(2)}`, pageWidth / 2 - 5, currentY + 24, { align: 'right' });
    doc.text(`Actual Cash In: $${actualCashIn.toFixed(2)}`, pageWidth / 2 - 5, currentY + 36, { align: 'right' });
    
    // Right column - left aligned
    doc.text(`Toast Sales: $${toastSales.toFixed(2)}`, pageWidth / 2 + 5, currentY + 12);
    doc.text(`Original Tips: $${originalTips.toFixed(2)}`, pageWidth / 2 + 5, currentY + 24);
    doc.text(`Discrepancy: ${discrepancySign}$${Math.abs(discrepancy).toFixed(2)}`, pageWidth / 2 + 5, currentY + 36);
    currentY += 50;
    
    // Deposit sections - highlighted like screenshot
    if (fullData.pm_deposit_amount) {
      drawBorderedSection(margin, currentY, pageWidth - 2 * margin, 20, [230, 255, 230]);
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(10);
      doc.text(`DEPOSIT IN ENVELOPE: $${fullData.pm_deposit_amount}`, pageWidth / 2, currentY + 14, { align: 'center' });
      currentY += 20;
      
      drawBorderedSection(margin, currentY, pageWidth - 2 * margin, 15, [255, 240, 230]);
      const returnAmount = fullData.pm_amount_to_keep ? fullData.pm_amount_to_keep.toFixed(2) : '0.00';
      doc.text(`RETURN TO CASHBOX/SAFE: $${returnAmount}`, pageWidth / 2, currentY + 11, { align: 'center' });
      currentY += 15;
    }
    
    // Notes header
    drawBorderedSection(margin, currentY, pageWidth - 2 * margin, 15);
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(8);
    doc.text('AM NOTES', margin + (pageWidth - 2 * margin) / 4, currentY + 11, { align: 'center' });
    doc.text('PM NOTES', margin + 3 * (pageWidth - 2 * margin) / 4, currentY + 11, { align: 'center' });
    currentY += 15;
    
    // Notes content
    drawBorderedSection(margin, currentY, pageWidth - 2 * margin, 25);
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(8);
    const amNotes = fullData.am_notes || 'No AM Notes';
    const pmNotes = fullData.pm_notes || 'No PM Notes';
    // Center-align notes content
    doc.text(amNotes, margin + (pageWidth - 2 * margin) / 4, currentY + 15, { align: 'center', maxWidth: (pageWidth - 2 * margin) / 2 - 10 });
    doc.text(pmNotes, margin + 3 * (pageWidth - 2 * margin) / 4, currentY + 15, { align: 'center', maxWidth: (pageWidth - 2 * margin) / 2 - 10 });
    currentY += 25;
    
    // Manager Breakdown header
    drawBorderedSection(margin, currentY, pageWidth - 2 * margin, 15);
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(10);
    doc.text('MANAGER BREAKDOWN', pageWidth / 2, currentY + 11, { align: 'center' });
    currentY += 15;
    
    // Manager breakdown items
    const managerItems = [
      ['Starting Cash Total:', `$${amTotal.toFixed(2)}`],
      ['Ending Cash Total:', `$${pmTotal.toFixed(2)}`],
      ['Actual Cash In:', `$${actualCashIn.toFixed(2)}`],
      ['Toast Sales Reported:', `$${toastSales.toFixed(2)}`],
      ['Tips Reported by Staff:', `$${originalTips.toFixed(2)}`],
      ['Discrepancy (Drawers vs Toast):', `${discrepancySign}$${Math.abs(discrepancy).toFixed(2)}`]
    ];
    
    if (tipAdjustment > 0) {
      managerItems.push(['Cash Tip Adjustment:', `-$${tipAdjustment.toFixed(2)}`]);
    }
    
    if (Math.abs(depositRoundingAdjustment) > 0.001) {
      managerItems.push(
        ['Raw Deposit Amount:', `$${rawDepositAmount.toFixed(2)}`],
        ['Rounded Deposit Amount:', `$${roundedDepositAmount}`],
        ['Rounding Adjustment Needed:', `$${depositRoundingAdjustment.toFixed(2)}`],
        ['Taken from Tips (Whole $):', depositTipAdjustment > 0 ? `-$${depositTipAdjustment.toFixed(2)}` : '-$'],
        ['Excess to Cashbox:', `+$${depositExcessToCashbox.toFixed(2)}`]
      );
    }
    
    if (fullData.pm_deposit_amount) {
      managerItems.push(
        ['Owed to Restaurant:', `$${toastSales.toFixed(2)}`],
        ['Cash Tips Owed to Staff:', `$${fullData.pm_adjusted_tips || originalTips}`],
        ['Returned to Cashbox:', `$${returnBreakdown.toFixed(2)} + AM Total`]
      );
    }
    
    const managerHeight = managerItems.length * 10 + 15;
    drawBorderedSection(margin, currentY, pageWidth - 2 * margin, managerHeight);
    
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(8);
    let managerY = currentY + 12;
    
    // Calculate center point with small gap
    const centerPoint = pageWidth / 2;
    const gapSize = 5; // Small gap between label and value
    
    managerItems.forEach(([label, value]) => {
      // Right-align labels to center minus gap
      doc.text(label, centerPoint - gapSize, managerY, { align: 'right' });
      // Left-align values from center plus gap
      doc.text(value, centerPoint + gapSize, managerY);
      managerY += 10;
    });
    
    currentY += managerHeight;
    
    // Complete Cash Count Breakdown header
    drawBorderedSection(margin, currentY, pageWidth - 2 * margin, 15);
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(10);
    doc.text('COMPLETE CASH COUNT BREAKDOWN', pageWidth / 2, currentY + 11, { align: 'center' });
    currentY += 15;
    
    // AM/PM headers
    drawBorderedSection(margin, currentY, pageWidth - 2 * margin, 15);
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(9);
    doc.text('AM COUNTS', margin + (pageWidth - 2 * margin) / 4, currentY + 11, { align: 'center' });
    doc.text('PM COUNTS', margin + 3 * (pageWidth - 2 * margin) / 4, currentY + 11, { align: 'center' });
    currentY += 15;
    
    // Calculate dynamic breakdown section height
    const halfWidth = (pageWidth - 2 * margin) / 2;
    
    // First, calculate the content without drawing to get the height
    let tempY = currentY + 10;
    let amY1 = tempY + 25; // Estimate for Drawer 1 start
    let pmY1 = tempY + 25;
    
    // Estimate heights based on data availability
    const estimateDrawerHeight = (drawerData) => {
      if (!drawerData) return 25;
      let count = 0;
      
      // Parse and count denominations
      let counts = drawerData;
      if (typeof drawerData === 'string') {
        try { counts = JSON.parse(drawerData); } catch (e) { return 25; }
      }
      if (counts && counts.counts) counts = counts.counts;
      if (!counts) return 25;
      
      const denominations = ['hundreds', 'fifties', 'twenties', 'tens', 'fives', 'ones', 'quarters', 'dimes', 'nickels', 'pennies'];
      denominations.forEach(field => { if ((counts[field] || 0) > 0) count++; });
      
      return Math.max(25, count * 9 + 20); // 9px per line + header
    };
    
    const am1Height = estimateDrawerHeight(fullData.am_drawer1_data);
    const pm1Height = estimateDrawerHeight(fullData.pm_drawer1_data);
    const am2Height = estimateDrawerHeight(fullData.am_drawer2_data);
    const pm2Height = estimateDrawerHeight(fullData.pm_drawer2_data);
    
    const drawer1MaxHeight = Math.max(am1Height, pm1Height);
    const drawer2MaxHeight = Math.max(am2Height, pm2Height);
    const breakdownHeight = drawer1MaxHeight + drawer2MaxHeight + 40; // Extra padding
    
    // Now draw the actual section
    drawBorderedSection(margin, currentY, pageWidth - 2 * margin, breakdownHeight);
    
    // Draw vertical divider
    doc.setDrawColor(0, 0, 0);
    doc.setLineWidth(0.5);
    doc.line(margin + halfWidth, currentY, margin + halfWidth, currentY + breakdownHeight);
    
    // Drawer 1 breakdowns
    let amY1Actual = drawDenominationBreakdown(fullData.am_drawer1_data, margin, currentY, halfWidth, 'DRAWER 1');
    let pmY1Actual = drawDenominationBreakdown(fullData.pm_drawer1_data, margin + halfWidth, currentY, halfWidth, 'DRAWER 1');
    
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(8);
    doc.text(`TOTAL: $${fullData.am_drawer1_total ? fullData.am_drawer1_total.toFixed(2) : '0.00'}`, margin + 3, amY1Actual + 8);
    doc.text(`TOTAL: $${fullData.pm_drawer1_total ? fullData.pm_drawer1_total.toFixed(2) : '0.00'}`, margin + halfWidth + 3, pmY1Actual + 8);
    
    let drawerMidY = Math.max(amY1Actual, pmY1Actual) + 18;
    
    // Drawer 2 breakdowns
    let amY2Actual = drawDenominationBreakdown(fullData.am_drawer2_data, margin, drawerMidY, halfWidth, 'DRAWER 2');
    let pmY2Actual = drawDenominationBreakdown(fullData.pm_drawer2_data, margin + halfWidth, drawerMidY, halfWidth, 'DRAWER 2');
    
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(8);
    doc.text(`TOTAL: $${fullData.am_drawer2_total ? fullData.am_drawer2_total.toFixed(2) : '0.00'}`, margin + 3, amY2Actual + 8);
    doc.text(`TOTAL: $${fullData.pm_drawer2_total ? fullData.pm_drawer2_total.toFixed(2) : '0.00'}`, margin + halfWidth + 3, pmY2Actual + 8);
    
    currentY += breakdownHeight;
    
    // Final totals - highlighted like screenshot
    drawBorderedSection(margin, currentY, halfWidth, 20, [230, 243, 255]);
    drawBorderedSection(margin + halfWidth, currentY, halfWidth, 20, [255, 248, 240]);
    
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(10);
    doc.text(`TOTAL AM: $${amTotal.toFixed(2)}`, margin + halfWidth / 2, currentY + 14, { align: 'center' });
    doc.text(`TOTAL PM: $${pmTotal.toFixed(2)}`, margin + halfWidth + halfWidth / 2, currentY + 14, { align: 'center' });
    
    // Save PDF
    const fileName = `Jayna_Gyro_Daily_Report_${reportDate}.pdf`;
    doc.save(fileName);
  }

  // Generate Single Day PDF Report
  async function generateSingleDayPDF(dayData, reportDate) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'letter' });
    
    const pageWidth = doc.internal.pageSize.getWidth();
    const pageHeight = doc.internal.pageSize.getHeight();
    const margin = 40;
    let currentY = margin;
    
    // Helper function to check for page break and add new page if needed
    function checkPageBreak(requiredSpace) {
      if (currentY + requiredSpace > pageHeight - margin) {
        doc.addPage();
        currentY = margin;
        return true;
      }
      return false;
    }
    
    // Helper function to add a colored section header
    function addSectionHeader(title, color = [102, 126, 234]) {
      checkPageBreak(35);
      doc.setFillColor(color[0], color[1], color[2]);
      doc.rect(margin, currentY, pageWidth - 2 * margin, 25, 'F');
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(12);
      doc.setTextColor(255, 255, 255);
      doc.text(title, margin + 10, currentY + 16);
      currentY += 35;
      doc.setTextColor(0, 0, 0); // Reset text color
    }
    
    // Header with enhanced styling
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(20);
    doc.setTextColor(50, 50, 50);
    doc.text('JAYNA GYRO DAILY REPORT', margin, currentY);
    
    currentY += 30;
    const formattedDate = new Date(reportDate).toLocaleDateString('en-US', { 
      weekday: 'long', 
      year: 'numeric', 
      month: 'long', 
      day: 'numeric' 
    });
    
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(14);
    doc.setTextColor(102, 126, 234);
    doc.text(`${formattedDate.toUpperCase()}`, margin, currentY);
    
    currentY += 20;
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(9);
    doc.setTextColor(100, 100, 100);
    doc.text(`Generated: ${new Date().toLocaleString().toUpperCase()}`, margin, currentY);
    doc.text(`Night Counter: ${(dayData.night_counter || 'N/A').toUpperCase()}`, margin, currentY + 12);
    
    currentY += 35;
    
    // Summary Cards Section
    addSectionHeader('FINANCIAL SUMMARY', [102, 126, 234]);
    
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(10);
    
    const summaryData = [
      ['TOAST SALES REPORTED:', `$${dayData.toast_sales?.toFixed(2) || '0.00'}`, [40, 167, 69]],
      ['ACTUAL CASH COLLECTED:', `$${dayData.actual_cash_in?.toFixed(2) || '0.00'}`, [23, 162, 184]],
      ['CASH DISCREPANCY:', `${dayData.discrepancy >= 0 ? '+' : ''}$${Math.abs(dayData.discrepancy || 0).toFixed(2)}`, dayData.discrepancy >= 0 ? [40, 167, 69] : [220, 53, 69]],
      ['EXCESS TO TIPS:', `$${dayData.excess?.toFixed(2) || '0.00'}`, [111, 66, 193]]
    ];
    
    summaryData.forEach((row, index) => {
      checkPageBreak(20);
      
      // Background color for alternating rows
      if (index % 2 === 0) {
        doc.setFillColor(248, 249, 250);
        doc.rect(margin, currentY - 5, pageWidth - 2 * margin, 18, 'F');
      }
      
      doc.setFont('helvetica', 'bold');
      doc.setTextColor(73, 80, 87);
      doc.text(row[0], margin + 10, currentY + 8);
      
      doc.setFont('helvetica', 'bold');
      doc.setTextColor(row[2][0], row[2][1], row[2][2]);
      const valueWidth = doc.getTextWidth(row[1]);
      doc.text(row[1], pageWidth - margin - valueWidth - 10, currentY + 8);
      
      currentY += 18;
    });
    
    currentY += 20;
    
    // Performance Analysis Section
    addSectionHeader('PERFORMANCE ANALYSIS', [240, 147, 251]);
    
    const variance = ((Math.abs(dayData.discrepancy || 0) / (dayData.toast_sales || 1)) * 100);
    const accuracyStatus = Math.abs(dayData.discrepancy || 0) < 5 ? 'EXCELLENT (98%+)' : 
                          Math.abs(dayData.discrepancy || 0) < 20 ? 'GOOD (95%+)' : 
                          'NEEDS REVIEW (90%-)';
    const statusColor = Math.abs(dayData.discrepancy || 0) < 5 ? [40, 167, 69] : 
                       Math.abs(dayData.discrepancy || 0) < 20 ? [255, 193, 7] : 
                       [220, 53, 69];
    
    const performanceData = [
      ['ACCURACY RATING:', accuracyStatus, statusColor],
      ['VARIANCE PERCENTAGE:', `${variance.toFixed(2)}%`, [108, 117, 125]],
      ['OPERATIONAL STATUS:', Math.abs(dayData.discrepancy || 0) < 10 ? 'BALANCED' : 'REVIEW NEEDED', Math.abs(dayData.discrepancy || 0) < 10 ? [40, 167, 69] : [255, 193, 7]]
    ];
    
    performanceData.forEach((row, index) => {
      checkPageBreak(20);
      
      if (index % 2 === 0) {
        doc.setFillColor(248, 249, 250);
        doc.rect(margin, currentY - 5, pageWidth - 2 * margin, 18, 'F');
      }
      
      doc.setFont('helvetica', 'bold');
      doc.setTextColor(73, 80, 87);
      doc.text(row[0], margin + 10, currentY + 8);
      
      doc.setFont('helvetica', 'bold');
      doc.setTextColor(row[2][0], row[2][1], row[2][2]);
      const valueWidth = doc.getTextWidth(row[1]);
      doc.text(row[1], pageWidth - margin - valueWidth - 10, currentY + 8);
      
      currentY += 18;
    });
    
    currentY += 20;
    
    // Detailed Data Table Section
    addSectionHeader('COMPLETE DATA SUMMARY', [79, 172, 254]);
    
    const weekStart = new Date(dayData.weekly_combined_reports.week_start_date).toLocaleDateString();
    const weekEnd = new Date(dayData.weekly_combined_reports.week_end_date).toLocaleDateString();
    
    const detailedData = [
      ['Report Date:', formattedDate],
      ['Night Counter:', dayData.night_counter || 'N/A'],
      ['Toast Sales:', `$${dayData.toast_sales?.toFixed(2) || '0.00'}`],
      ['Actual Cash In:', `$${dayData.actual_cash_in?.toFixed(2) || '0.00'}`],
      ['Discrepancy:', `${dayData.discrepancy >= 0 ? '+' : ''}$${Math.abs(dayData.discrepancy || 0).toFixed(2)}`],
      ['Excess Amount:', `$${dayData.excess?.toFixed(2) || '0.00'}`],
      ['Report Week:', `${weekStart} - ${weekEnd}`],
      ['Weekly Report By:', dayData.weekly_combined_reports.generated_by || 'N/A']
    ];
    
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(9);
    doc.setTextColor(80, 80, 80);
    
    // Table headers
    checkPageBreak(25);
    doc.setFillColor(52, 58, 64);
    doc.rect(margin, currentY, (pageWidth - 2 * margin) * 0.6, 20, 'F');
    doc.rect(margin + (pageWidth - 2 * margin) * 0.6, currentY, (pageWidth - 2 * margin) * 0.4, 20, 'F');
    
    doc.setTextColor(255, 255, 255);
    doc.text('FIELD', margin + 10, currentY + 13);
    doc.text('VALUE', margin + (pageWidth - 2 * margin) * 0.6 + 10, currentY + 13);
    currentY += 20;
    
    // Table data
    detailedData.forEach((row, index) => {
      checkPageBreak(18);
      
      // Alternating row colors
      const bgColor = index % 2 === 0 ? [248, 249, 250] : [255, 255, 255];
      doc.setFillColor(bgColor[0], bgColor[1], bgColor[2]);
      doc.rect(margin, currentY, pageWidth - 2 * margin, 18, 'F');
      
      // Border lines
      doc.setDrawColor(222, 226, 230);
      doc.setLineWidth(0.5);
      doc.line(margin, currentY + 18, pageWidth - margin, currentY + 18);
      doc.line(margin + (pageWidth - 2 * margin) * 0.6, currentY, margin + (pageWidth - 2 * margin) * 0.6, currentY + 18);
      
      doc.setFont('helvetica', 'bold');
      doc.setTextColor(73, 80, 87);
      doc.text(row[0], margin + 10, currentY + 12);
      
      doc.setFont('helvetica', 'normal');
      doc.setTextColor(33, 37, 41);
      doc.text(row[1], margin + (pageWidth - 2 * margin) * 0.6 + 10, currentY + 12);
      
      currentY += 18;
    });
    
    currentY += 30;
    
    // Performance Benchmarks Section
    addSectionHeader('PERFORMANCE BENCHMARKS', [255, 112, 67]);
    
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(9);
    doc.setTextColor(73, 80, 87);
    
    const benchmarks = [
      '• EXCELLENT: Discrepancy under $5.00 (98%+ accuracy)',
      '• GOOD: Discrepancy $5.00-$20.00 (95%+ accuracy)', 
      '• REVIEW NEEDED: Discrepancy over $20.00 (requires management attention)',
      '',
      '• DISCREPANCY: Difference between expected and actual cash (negative = short, positive = over)',
      '• EXCESS: Amount taken from tips to balance daily operations and account for variances'
    ];
    
    benchmarks.forEach(benchmark => {
      checkPageBreak(15);
      doc.text(benchmark, margin + 10, currentY);
      currentY += 15;
    });
    
    // Footer
    if (currentY < pageHeight - 100) {
      currentY = pageHeight - 80;
    } else {
      checkPageBreak(80);
    }
    
    doc.setDrawColor(222, 226, 230);
    doc.setLineWidth(1);
    doc.line(margin, currentY, pageWidth - margin, currentY);
    currentY += 15;
    
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(8);
    doc.setTextColor(73, 80, 87);
    const creditText = 'Jayna Gyro Cash Counter v3.0+ | Report Generation App';
    const emailText = 'Designed and coded by Demetri Gregorakis | demetri_gregorakis@icloud.com';
    
    const creditWidth = doc.getTextWidth(creditText);
    const emailWidth = doc.getTextWidth(emailText);
    const centerXCredit = (pageWidth - creditWidth) / 2;
    const centerXEmail = (pageWidth - emailWidth) / 2;
    
    doc.text(creditText, centerXCredit, currentY);
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(7);
    doc.setTextColor(108, 117, 125);
    doc.text(emailText, centerXEmail, currentY + 12);
    
    // Save PDF with enhanced filename
    const filename = `Jayna_Daily_Report_${reportDate.replace(/-/g, '_')}_Enhanced.pdf`;
    doc.save(filename);
  }

  // Generate Weekly Historical PDF Report
  async function generateWeeklyHistoricalPDF(weeklyData, startDate, endDate) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'letter' });
    
    const pageWidth = doc.internal.pageSize.getWidth();
    const margin = 40;
    let currentY = margin;
    
    // Header
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(16);
    doc.setTextColor(0, 0, 0);
    doc.text('JAYNA GYRO HISTORICAL WEEKLY REPORT', margin, currentY + 12);
    
    currentY += 30;
    doc.setFontSize(9);
    doc.setFont('helvetica', 'normal');
    const dateRange = `${startDate.toUpperCase()} TO ${endDate.toUpperCase()}`;
    doc.text(`WEEK OF: ${dateRange}`, margin, currentY);
    doc.text(`GENERATED BY: ${(weeklyData.generated_by || 'N/A').toUpperCase()}`, margin, currentY + 12);
    doc.text(`GENERATED: ${new Date().toLocaleString().toUpperCase()}`, margin, currentY + 24);
    
    // Summary section
    currentY += 50;
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(12);
    doc.text('WEEKLY SUMMARY', margin, currentY);
    
    currentY += 20;
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(9);
    
    // Build summary lines with voided tips breakdown if applicable
    const summaryLines = [
      `TOAST CASH SALES REPORTED: $${weeklyData.total_toast_sales.toFixed(2)}`,
      `ACTUAL CASH IN: $${weeklyData.actual_cash_in.toFixed(2)}`,
      `TOTAL DISCREPANCY: $${weeklyData.total_discrepancy.toFixed(2)}`,
      `ENVELOPE DEPOSITS: $${weeklyData.envelope_deposits.toFixed(2)}`
    ];

    // Add credit tips breakdown if voided tips exist
    if (tipPoolSummary.voidedTipsTotal && tipPoolSummary.voidedTipsTotal > 0) {
      summaryLines.push(`CREDIT TIPS (GROSS): $${tipPoolSummary.creditTipsGross.toFixed(2)}`);
      summaryLines.push(`  - VOIDED TIPS: -$${tipPoolSummary.voidedTipsTotal.toFixed(2)}`);
      summaryLines.push(`CREDIT TIPS (NET): $${weeklyData.credit_tips.toFixed(2)}`);
    } else {
      summaryLines.push(`CREDIT TIPS: $${weeklyData.credit_tips.toFixed(2)}`);
    }

    summaryLines.push(
      `CASH TIPS: $${weeklyData.cash_tips.toFixed(2)}`,
      `EZCATER TIPS: $${weeklyData.ezcater_tips.toFixed(2)}`,
      `TOTAL TIPS: $${weeklyData.total_tips.toFixed(2)}`,
      `TDS DRIVER: $${weeklyData.tds_driver_tips.toFixed(2)}`,
      `TIP POOL TOTAL (MINUS TDS): $${weeklyData.tip_pool_total.toFixed(2)}`,
      `HOURLY RATE: $${weeklyData.hourly_rate.toFixed(2)}`,
      `CASH NEEDED: $${weeklyData.cash_needed.toFixed(2)}`
    );
    
    summaryLines.forEach((line, index) => {
      if (index % 2 === 0) {
        doc.text(line, margin, currentY + Math.floor(index / 2) * 15);
      } else {
        doc.text(line, margin + 280, currentY + Math.floor(index / 2) * 15);
      }
    });
    
    // Employee tips table
    if (weeklyData.weekly_employee_tips && weeklyData.weekly_employee_tips.length > 0) {
      currentY += Math.ceil(summaryLines.length / 2) * 15 + 30;
      
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(12);
      doc.text('EMPLOYEE TIP DISTRIBUTION', margin, currentY);
      
      currentY += 20;
      
      const employeeTableData = weeklyData.weekly_employee_tips.map(emp => [
        `${emp.employee_first_name} ${emp.employee_last_name}`,
        emp.hours_worked.toFixed(1),
        emp.equity_percentage.toFixed(0),
        emp.weighted_hours.toFixed(1),
        `$${emp.tips_due.toFixed(2)}`
      ]);
      
      doc.autoTable({
        head: [['EMPLOYEE', 'HOURS', 'EQUITY (%)', 'WEIGHTED', 'DUE']],
        body: employeeTableData,
        startY: currentY,
        margin: { left: margin, right: margin },
        styles: { font: 'helvetica', fontSize: 8, textColor: [0, 0, 0] },
        headStyles: { font: 'helvetica', fontStyle: 'bold', fillColor: [245, 245, 245] }
      });
      
      currentY = doc.autoTable.previous.finalY + 20;
    }
    
    // Daily breakdown table
    if (weeklyData.weekly_daily_breakdown && weeklyData.weekly_daily_breakdown.length > 0) {
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(12);
      doc.text('DAILY CASH BREAKDOWN', margin, currentY);
      
      currentY += 15;
      doc.setFont('helvetica', 'normal');
      doc.setFontSize(8);
      doc.text(`* Only showing ${weeklyData.weekly_daily_breakdown.length} days with PM cash count data`, margin, currentY);
      
      currentY += 15;
      
      // Filter and format the data better
      const dailyTableData = weeklyData.weekly_daily_breakdown
        .filter(day => day.toast_sales > 0 || day.actual_cash_in > 0) // Only show days with actual data
        .map(day => [
          day.date,
          day.night_counter || 'N/A',
          day.toast_sales > 0 ? `$${day.toast_sales.toFixed(2)}` : 'No Data',
          day.actual_cash_in > 0 ? `$${day.actual_cash_in.toFixed(2)}` : 'No Data', 
          Math.abs(day.discrepancy) > 0.01 ? `${day.discrepancy >= 0 ? '+' : ''}$${day.discrepancy.toFixed(2)}` : '$0.00',
          day.excess > 0 ? `$${day.excess.toFixed(2)}` : '$0.00'
        ]);
      
      doc.autoTable({
        head: [['DATE', 'NIGHT COUNTER', 'TOAST SALES', 'ACTUAL CASH IN', 'DISCREPANCY', 'EXCESS']],
        body: dailyTableData,
        startY: currentY,
        margin: { left: margin, right: margin },
        styles: { font: 'helvetica', fontSize: 7, textColor: [0, 0, 0] },
        headStyles: { font: 'helvetica', fontStyle: 'bold', fillColor: [245, 245, 245] },
        didParseCell: function(data) {
          // Color discrepancy column
          if (data.column.index === 4 && data.row.index < dailyTableData.length) {
            const cellValue = data.cell.text[0];
            if (cellValue && cellValue.includes('-')) {
              data.cell.styles.textColor = [139, 69, 19]; // Dark red
              data.cell.styles.fontStyle = 'italic';
            } else if (cellValue && cellValue.includes('+')) {
              data.cell.styles.textColor = [34, 139, 34]; // Dark green
            }
          }
        }
      });
    }
    
    // Save PDF
    const filename = `Historical_Weekly_Report_${startDate.replace(/-/g, '_')}_to_${endDate.replace(/-/g, '_')}.pdf`;
    doc.save(filename);
  }
  
  async function generateAndDownloadReport() {
    const reportType = document.querySelector('input[name="reportType"]:checked').value;
    
    try {
      showLoading('Generating PDF Report', 'Creating your report...');
      
      if (reportType === 'single') {
        await generateSingleDayPDF();
      } else {
        await generateDateRangePDF();
      }
      
      hideLoading();
      showPDFSuccessMessage();
      
    } catch (error) {
      hideLoading();
      console.error('Report generation error:', error);
      showMessage(`Error: ${error.message}`, 'error');
    }
  }
  
  function showPDFSuccessMessage() {
    const modalHTML = `
      <div id="pdfSuccessModal" style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.7);
        z-index: 10000;
        display: flex;
        justify-content: center;
        align-items: center;
      ">
        <div style="
          background: white;
          padding: 40px;
          border-radius: 0;
          text-align: center;
          max-width: 400px;
          width: 90%;
          box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        ">
          <div style="font-size: 48px; margin-bottom: 20px;"></div>
          <h2 style="color: #28a745; margin-bottom: 15px; font-size: 24px;">PDF Downloaded Successfully!</h2>
          <p style="color: #666; margin-bottom: 30px; font-size: 16px;">Your cash report has been generated and downloaded.</p>
          <button onclick="closePDFSuccessModal(); goHome();" style="
            background: var(--gray-700);
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 16px;
            border-radius: 0;
            cursor: pointer;
            margin-right: 10px;
          ">Return to Menu</button>
          <button onclick="closePDFSuccessModal();" style="
            background: var(--gray-600);
            color: white;
            border: none;
            padding: 12px 20px;
            font-size: 16px;
            border-radius: 0;
            cursor: pointer;
          ">Stay Here</button>
        </div>
      </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
  }
  
  function closePDFSuccessModal() {
    const modal = document.getElementById('pdfSuccessModal');
    if (modal) {
      modal.remove();
    }
  }

  function showTipPoolSuccessMessage() {
    const modalHTML = `
      <div id="tipPoolSuccessModal" style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.7);
        z-index: 10000;
        display: flex;
        justify-content: center;
        align-items: center;
      ">
        <div style="
          background: white;
          padding: 40px;
          border-radius: 0;
          text-align: center;
          max-width: 400px;
          width: 90%;
          box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        ">
          <div style="font-size: 48px; margin-bottom: 20px;"></div>
          <h2 style="color: #28a745; margin-bottom: 15px; font-size: 24px;">Tip Pool PDF Downloaded Successfully!</h2>
          <p style="color: #666; margin-bottom: 30px; font-size: 16px;">Your tip pool distribution report has been generated and downloaded.</p>
          <button onclick="closeTipPoolSuccessModal(); goHome();" style="
            background: var(--gray-700);
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 16px;
            border-radius: 0;
            cursor: pointer;
            margin-right: 10px;
          ">Return to Menu</button>
          <button onclick="closeTipPoolSuccessModal();" style="
            background: var(--gray-600);
            color: white;
            border: none;
            padding: 12px 20px;
            font-size: 16px;
            border-radius: 0;
            cursor: pointer;
          ">Stay Here</button>
        </div>
      </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
  }
  
  function closeTipPoolSuccessModal() {
    const modal = document.getElementById('tipPoolSuccessModal');
    if (modal) {
      modal.remove();
    }
  }
  
  async function generateSingleDayPDF() {
    const date = document.getElementById('reportDate').value;
    console.log('generateSingleDayPDF called with date:', date);
    
    if (!date) {
      throw new Error('Please select a date');
    }
    
    console.log('Getting AM data for date:', date);
    const amData = await getAMData(date);
    console.log('AM data retrieved:', amData);
    
    if (!amData) {
      throw new Error('No AM data found for this date');
    }
    
    console.log('Getting PM data for date:', date);
    const { data: fullData, error } = await supabase
      .from('cash_counts')
      .select('*')
      .eq('date', date)
      .single();
    
    console.log('PM data retrieved:', fullData, 'Error:', error);
    
    if (!fullData || !fullData.pm_total) {
      throw new Error('No PM data found for this date');
    }
    
    console.log('Generating report HTML...');
    
    // Calculate PM amounts using same logic as PM flow for consistency
    const calculations = calculatePMAmounts({
      amTotal: amData.total,
      total: fullData.pm_total,
      toastSales: fullData.pm_toast_sales,
      cashTips: fullData.pm_cash_tips
    });
    
    console.log('Calculations for report:', calculations);
    
    // Create enhanced pmData with calculation results
    const enhancedPmData = {
      ...fullData,
      // Add calculated fields for deposit rounding breakdown
      raw_deposit_amount: calculations.rawDepositAmount ? calculations.rawDepositAmount.toFixed(2) : null,
      deposit_rounding_adjustment: calculations.depositRoundingAdjustment ? calculations.depositRoundingAdjustment.toFixed(2) : null,
      deposit_tip_adjustment: calculations.depositTipAdjustment ? calculations.depositTipAdjustment.toFixed(2) : null,
      deposit_excess_to_cashbox: calculations.depositExcessToCashbox ? calculations.depositExcessToCashbox.toFixed(2) : null,
      // Only show deposit rounding breakdown if:
      // 1. There's actually a meaningful rounding adjustment (> 0.001)
      // 2. This data was processed with the new logic (stored amount matches rounded amount)
      has_deposit_rounding: (
        calculations.depositRoundingAdjustment && 
        Math.abs(calculations.depositRoundingAdjustment) > 0.001 &&
        Math.abs(fullData.pm_deposit_amount - calculations.depositAmount) < 0.001
      ) ? 'true' : 'false',
      deposit_amount: calculations.depositAmount.toString()
    };
    
    console.log('Enhanced PM Data:', enhancedPmData);
    
    // Generate full single day report (same format as email)
    const reportHtml = generateSingleDayReportHtml(date, amData, enhancedPmData);
    console.log('Report HTML generated, creating PDF...');
    
    // Set the content in the hidden div
    const reportContent = document.getElementById('reportContent');
    if (reportContent) {
      reportContent.innerHTML = reportHtml;
      
      // Generate PDF
      const filename = `jayna-gyro-daily-report-${date}.pdf`;
      await generatePDF(reportContent, filename);
      
    } else {
      throw new Error('Report content element not found');
    }
  }
  
  async function generateDateRangePDF() {
    // IMPORTANT: Tip pool reports MUST use Monday-Sunday date ranges (7 days)
    // startDate = Monday, endDate = Sunday (the week_end_date stored in database)
    // Example: Monday 9/29/2025 through Sunday 10/5/2025
    // All dates stored as YYYY-MM-DD format (e.g., "2025-10-05" for Sunday)

    const startDate = document.getElementById('reportStartDate').value;
    const endDate = document.getElementById('reportEndDate').value;
    const realEnvelopeAmount = parseFloat(document.getElementById('realEnvelopeAmount').value) || null;

    if (!startDate || !endDate) {
      throw new Error('Please select both start and end dates');
    }

    // Handle dates properly with timezone-safe parsing (append T12:00:00 to force local time)
    // This prevents UTC midnight interpretation which shifts dates by timezone offset
    const start = new Date(startDate + 'T12:00:00');
    const end = new Date(endDate + 'T12:00:00');
    
    if (start > end) {
      throw new Error('Start date must be before end date');
    }
    
    // Check if date range exceeds 7 days
    const daysDiff = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
    if (daysDiff > 7) {
      throw new Error('Date range cannot exceed 7 days');
    }
    
    console.log('Date range query:', { startDate, endDate, daysDiff });
    
    const { data: rangeData } = await supabase
      .from('cash_counts')
      .select('*')
      .gte('date', startDate)
      .lte('date', endDate)
      .not('pm_total', 'is', null)
      .order('date', { ascending: true });
    
    if (!rangeData || rangeData.length === 0) {
      throw new Error('No data found for this date range');
    }
    
    // Generate date range summary report
    const reportHtml = generateDateRangeReportHtml(startDate, endDate, rangeData, realEnvelopeAmount);
    
    // Set the content in the hidden div
    const reportContent = document.getElementById('reportContent');
    if (reportContent) {
      reportContent.innerHTML = reportHtml;
      
      // Generate PDF
      const filename = `jayna-gyro-range-report-${startDate}-to-${endDate}.pdf`;
      await generatePDF(reportContent, filename);
      
    } else {
      throw new Error('Report content element not found');
    }
  }
  
  async function generatePDF(element, filename) {
    console.log('Generating PDF with filename:', filename);
    
    // Extract only the body content, skipping the CSS
    const fullHTML = element.innerHTML;
    
    // Find the start of the actual content (after </style> tag)
    const contentStart = fullHTML.indexOf('</style>') + 8;
    const contentEnd = fullHTML.lastIndexOf('</html>');
    
    let bodyContent = '';
    if (contentStart > 7 && contentEnd > contentStart) {
      // Extract content between </style> and </html>
      bodyContent = fullHTML.substring(contentStart, contentEnd);
      // Remove any remaining head/body tags and just keep the content
      bodyContent = bodyContent.replace(/<\/head>|<body>|<\/body>/g, '').trim();
    } else {
      // Fallback: try to find content starting with "JAYNA GYRO"
      const jaynaStart = fullHTML.indexOf('JAYNA GYRO DAILY CASH REPORT');
      if (jaynaStart > 0) {
        bodyContent = fullHTML.substring(jaynaStart);
        bodyContent = bodyContent.replace(/<\/html>|<\/body>/g, '').trim();
      } else {
        bodyContent = element.innerHTML;
      }
    }
    
    // Create a temporary element with just the clean content and basic styling
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = `
      <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 8px; font-size: 9px; line-height: 1.1; }
        .header { text-align: center; font-weight: bold; font-size: 16px; margin-bottom: 2px; border-bottom: 2px solid #000; padding-bottom: 4px; }
        .date-header { text-align: center; font-weight: bold; font-size: 14px; margin-bottom: 8px; padding-bottom: 4px; text-transform: uppercase; letter-spacing: 0.3px; }
        .section { border: 1px solid #000; margin: 4px 0; padding: 6px; }
        .section-title { font-weight: bold; font-size: 12px; text-align: center; margin-bottom: 4px; border-bottom: 1px solid #000; padding-bottom: 2px; text-transform: uppercase; letter-spacing: 0.3px; }
        .two-column { display: table; width: 100%; }
        .column { display: table-cell; width: 50%; vertical-align: top; padding: 0 4px; }
        .column:first-child { border-right: 1px solid #ccc; }
        .data-row { display: flex; justify-content: space-between; margin: 1px 0; max-width: 150px; }
        .label { font-weight: bold; text-align: right; padding-right: 8px; }
        .value { text-align: left; font-weight: bold; }
        .deposit-box { background-color: #e6ffe6; border: 2px solid #000; padding: 6px; text-align: center; font-weight: bold; font-size: 11px; margin: 4px 0; }
        .keep-box { background-color: #fff0e6; border: 2px solid #000; padding: 6px; text-align: center; font-weight: bold; font-size: 11px; margin: 4px 0; }
        .notes-section { display: table; width: 100%; margin: 4px 0; }
        .notes-column { display: table-cell; width: 50%; padding: 4px; border: 1px solid #000; vertical-align: top; text-align: center; font-weight: bold; }
        .notes-column:first-child { border-right: none; }
        .breakdown-grid { display: table; width: 100%; }
        .breakdown-row { display: table-row; }
        .breakdown-cell { display: table-cell; padding: 2px 4px; border-bottom: 1px dotted #ccc; }
        .breakdown-label { font-weight: bold; width: 50%; text-align: right; padding-right: 8px; }
        .breakdown-value { text-align: left; font-weight: bold; width: 50%; padding-left: 8px; }
        .cash-count { font-size: 7px; line-height: 1.0; }
        .drawer-total { font-weight: bold; border-top: 1px solid #000; margin-top: 2px; padding-top: 2px; }
        .shift-total { font-weight: bold; text-align: center; padding: 3px; border: 2px solid #000; margin-top: 4px; font-size: 8px; }
        .am-bg { background-color: #e6f3ff; }
        .pm-bg { background-color: #fff8f0; }
      </style>
      ${bodyContent}
    `;
    
    // Hide the original element and show the temp one
    const originalParent = element.parentNode;
    const originalDisplay = element.style.display;
    
    // Insert temp div and hide original
    document.body.appendChild(tempDiv);
    element.style.display = 'none';
    
    // Configure PDF options for better output
    const opt = {
      margin: 0.5,
      filename: filename,
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { 
        scale: 2,
        useCORS: true,
        backgroundColor: '#ffffff',
        width: 800,
        height: tempDiv.scrollHeight,
        logging: false
      },
      jsPDF: { 
        unit: 'in', 
        format: 'letter', 
        orientation: 'portrait' 
      }
    };
    
    try {
      // Generate PDF from the clean temp element
      await html2pdf().set(opt).from(tempDiv).save();
      console.log('PDF generated and downloaded successfully');
    } catch (pdfError) {
      console.error('PDF generation error:', pdfError);
      throw pdfError;
    } finally {
      // Clean up: remove temp div and restore original
      try {
        if (tempDiv && tempDiv.parentNode) {
          document.body.removeChild(tempDiv);
        }
        if (element) {
          element.style.display = originalDisplay;
        }
      } catch (cleanupError) {
        console.error('Cleanup error:', cleanupError);
      }
    }
  }
  
  // Download Historical Report as PDF
  async function downloadHistoricalReportPDF(startDate, endDate) {
    try {
      console.log('Downloading historical report PDF...');
      
      if (!window.currentHistoricalReport) {
        throw new Error('No historical report data available');
      }
      
      const reportData = window.currentHistoricalReport;
      const reportContent = document.getElementById('reportContent');
      
      if (!reportContent) {
        throw new Error('Report content not found');
      }
      
      // Generate PDF from the displayed content
      const filename = `jayna-gyro-historical-report-${startDate}-to-${endDate}.pdf`;
      await generatePDF(reportContent, filename);
      
      console.log('Historical report PDF downloaded successfully');
      
    } catch (error) {
      console.error('Error downloading historical report PDF:', error);
      showErrorMessage('Failed to download PDF: ' + error.message, 'reportResults');
    }
  }
  
  function generateSingleDayReportHtml(date, amData, pmData) {
    console.log('generateSingleDayReportHtml called with:');
    console.log('date:', date);
    console.log('amData:', amData);
    console.log('pmData:', pmData);
    
    // Validate data exists
    if (!amData || !pmData) {
      console.error('Missing data - amData:', !!amData, 'pmData:', !!pmData);
      return '<div style="padding: 20px; color: red; font-size: 18px;">Error: Missing report data</div>';
    }
    
    const dayOfWeek = new Date(date + 'T12:00:00').toLocaleDateString('en-US', { weekday: 'long' }).toUpperCase();
    const formattedDate = new Date(date + 'T12:00:00').toLocaleDateString('en-US', { 
      year: 'numeric', 
      month: 'long', 
      day: 'numeric' 
    }).toUpperCase();
    
    const actualCashIn = pmData.pm_total - amData.total;
    const discrepancySign = pmData.pm_discrepancy >= 0 ? '+' : '';
    const tipAdjustment = pmData.pm_discrepancy < 0 ? Math.abs(pmData.pm_discrepancy) : 0;
    
    // Helper function to get denomination counts and totals
    function getDenomData(drawerData, denomKey) {
      if (!drawerData || !drawerData) return { count: 0, total: 0 };
      
      // Map display format to stored format
      const denomMapping = {
        '$100': 'hundreds',
        '$50': 'fifties', 
        '$20': 'twenties',
        '$10': 'tens',
        '$5': 'fives',
        '$1': 'ones',
        '¢25': 'quarters',
        '¢10': 'dimes', 
        '¢5': 'nickels',
        '¢1': 'pennies'
      };
      
      const dataKey = denomMapping[denomKey];
      if (!dataKey) return { count: 0, total: 0 };
      
      const count = parseInt(drawerData[dataKey]) || 0;
      const denomValues = {
        '$100': 100, '$50': 50, '$20': 20, '$10': 10, '$5': 5, '$1': 1,
        '¢25': 0.25, '¢10': 0.10, '¢5': 0.05, '¢1': 0.01
      };
      const value = denomValues[denomKey] || 0;
      return { count, total: (count * value).toFixed(2) };
    }
    
    const htmlContent = `
    <!DOCTYPE html>
    <html>
    <head>
        <style>
            body {
                font-family: Arial, sans-serif;
                margin: 0;
                padding: 8px;
                font-size: 9px;
                line-height: 1.1;
            }
            .header {
                text-align: center;
                font-weight: bold;
                font-size: 16px;
                margin-bottom: 2px;
                border-bottom: 2px solid #000;
                padding-bottom: 4px;
            }
            .date-header {
                text-align: center;
                font-weight: bold;
                font-size: 14px;
                margin-bottom: 8px;
                padding-bottom: 4px;
            }
            .section {
                border: 1px solid #000;
                margin: 4px 0;
                padding: 6px;
            }
            .section-title {
                font-weight: bold;
                font-size: 12px;
                text-align: center;
                margin-bottom: 4px;
                border-bottom: 1px solid #000;
                padding-bottom: 2px;
            }
            .two-column {
                display: table;
                width: 100%;
            }
            .column {
                display: table-cell;
                width: 50%;
                vertical-align: top;
                padding: 0 4px;
            }
            .column:first-child {
                border-right: 1px solid #ccc;
            }
            .data-row {
                display: flex;
                justify-content: space-between;
                margin: 1px 0;
                max-width: 150px;
            }
            .label {
                font-weight: bold;
                text-align: right;
                padding-right: 8px;
            }
            .value {
                text-align: left;
                font-weight: bold;
            }
            .deposit-box {
                background-color: #e6ffe6;
                border: 2px solid #000;
                padding: 6px;
                text-align: center;
                font-weight: bold;
                font-size: 11px;
                margin: 4px 0;
            }
            .keep-box {
                background-color: #fff0e6;
                border: 2px solid #000;
                padding: 6px;
                text-align: center;
                font-weight: bold;
                font-size: 11px;
                margin: 4px 0;
            }
            .notes-section {
                display: table;
                width: 100%;
                margin: 4px 0;
            }
            .notes-column {
                display: table-cell;
                width: 50%;
                padding: 4px;
                border: 1px solid #000;
                vertical-align: top;
                text-align: center;
                font-weight: bold;
            }
            .notes-column:first-child {
                border-right: none;
            }
            .breakdown-grid {
                display: table;
                width: 100%;
            }
            .breakdown-row {
                display: table-row;
            }
            .breakdown-cell {
                display: table-cell;
                padding: 2px 4px;
                border-bottom: 1px dotted #ccc;
            }
            .breakdown-label {
                font-weight: bold;
                width: 50%;
                text-align: right;
                padding-right: 8px;
            }
            .breakdown-value {
                text-align: left;
                font-weight: bold;
                width: 50%;
                padding-left: 8px;
            }
            .cash-count {
                font-size: 7px;
                line-height: 1.0;
            }
            .drawer-total {
                font-weight: bold;
                border-top: 1px solid #000;
                margin-top: 2px;
                padding-top: 2px;
            }
            .shift-total {
                font-weight: bold;
                text-align: center;
                padding: 3px;
                border: 2px solid #000;
                margin-top: 4px;
                font-size: 8px;
            }
            .am-bg { background-color: #e6f3ff; }
            .pm-bg { background-color: #fff8f0; }
        </style>
    </head>
    <body>
        <div class="header">
            JAYNA GYRO DAILY CASH REPORT
        </div>
        <div class="date-header">
            ${dayOfWeek} ${formattedDate}
        </div>
        <div style="text-align: center; font-size: 8px; color: #666; margin-bottom: 8px; border-bottom: 1px dotted #ccc; padding-bottom: 4px;">
            Report Generated: ${new Date().toLocaleString()}
        </div>

        <!-- Staff and Timing Info -->
        <div class="section">
            <div class="two-column">
                <div class="column">
                    <div class="data-row">
                        <span class="label">AM Counter:</span>
                        <span class="value">${amData.counter}</span>
                    </div>
                    <div class="data-row">
                        <span class="label">AM Time:</span>
                        <span class="value">${new Date(amData.timestamp).toLocaleTimeString()}</span>
                    </div>
                </div>
                <div class="column">
                    <div class="data-row">
                        <span class="label">PM Counter:</span>
                        <span class="value">${pmData.pm_counter}</span>
                    </div>
                    <div class="data-row">
                        <span class="label">PM Time:</span>
                        <span class="value">${new Date(pmData.pm_timestamp).toLocaleTimeString()}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Cash Summary -->
        <div class="section">
            <div class="section-title">CASH FLOW SUMMARY</div>
            <div class="two-column">
                <div class="column">
                    <div class="data-row">
                        <span class="label">Starting Cash (AM):</span>
                        <span class="value">$${amData.total.toFixed(2)}</span>
                    </div>
                    <div class="data-row">
                        <span class="label">Ending Cash (PM):</span>
                        <span class="value">$${pmData.pm_total.toFixed(2)}</span>
                    </div>
                    <div class="data-row">
                        <span class="label">Actual Cash In:</span>
                        <span class="value">$${actualCashIn.toFixed(2)}</span>
                    </div>
                </div>
                <div class="column">
                    <div class="data-row">
                        <span class="label">Toast Sales:</span>
                        <span class="value">$${pmData.pm_toast_sales.toFixed(2)}</span>
                    </div>
                    <div class="data-row">
                        <span class="label">Original Tips:</span>
                        <span class="value">$${pmData.pm_cash_tips.toFixed(2)}</span>
                    </div>
                    <div class="data-row">
                        <span class="label">Discrepancy:</span>
                        <span class="value">${discrepancySign}$${Math.abs(pmData.pm_discrepancy).toFixed(2)}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Deposit Instructions -->
        <div class="deposit-box">
            DEPOSIT IN ENVELOPE: $${pmData.pm_deposit_amount}
            <div style="font-size: 8px;">(Toast Sales $${pmData.pm_toast_sales.toFixed(2)} + Original Tips $${pmData.pm_cash_tips.toFixed(2)})</div>
        </div>
        <div class="keep-box">
            RETURN TO CASHBOX/SAFE: $${pmData.pm_amount_to_keep.toFixed(2)}
        </div>

        <!-- Notes Section -->
        <div class="notes-section">
            <div class="notes-column am-bg">
                <div style="font-weight: bold; text-align: center; margin-bottom: 3px;">AM NOTES</div>
                <div style="text-align: center; font-weight: bold;">
                    ${amData.notes || 'No AM Notes'}
                </div>
            </div>
            <div class="notes-column pm-bg">
                <div style="font-weight: bold; text-align: center; margin-bottom: 3px;">PM NOTES</div>
                <div style="text-align: center; font-weight: bold;">
                    ${pmData.pm_notes || 'No PM Notes'}
                </div>
            </div>
        </div>

        <!-- Manager Breakdown -->
        <div class="section">
            <div class="section-title">MANAGER BREAKDOWN</div>
            <div class="breakdown-grid">
                <div class="breakdown-row">
                    <div class="breakdown-cell breakdown-label">Starting Cash Total:</div>
                    <div class="breakdown-cell breakdown-value">$${amData.total.toFixed(2)}</div>
                </div>
                <div class="breakdown-row">
                    <div class="breakdown-cell breakdown-label">Ending Cash Total:</div>
                    <div class="breakdown-cell breakdown-value">$${pmData.pm_total.toFixed(2)}</div>
                </div>
                <div class="breakdown-row">
                    <div class="breakdown-cell breakdown-label">Actual Cash In:</div>
                    <div class="breakdown-cell breakdown-value">$${actualCashIn.toFixed(2)}</div>
                </div>
                <div class="breakdown-row">
                    <div class="breakdown-cell breakdown-label">Toast Sales Reported:</div>
                    <div class="breakdown-cell breakdown-value">$${pmData.pm_toast_sales.toFixed(2)}</div>
                </div>
                <div class="breakdown-row">
                    <div class="breakdown-cell breakdown-label">Tips Reported by Staff:</div>
                    <div class="breakdown-cell breakdown-value">$${pmData.pm_cash_tips.toFixed(2)}</div>
                </div>
                <div class="breakdown-row">
                    <div class="breakdown-cell breakdown-label">Discrepancy (Drawers vs Toast):</div>
                    <div class="breakdown-cell breakdown-value">${discrepancySign}$${Math.abs(pmData.pm_discrepancy).toFixed(2)}</div>
                </div>
                ${tipAdjustment > 0 ? `
                <div class="breakdown-row">
                    <div class="breakdown-cell breakdown-label">Cash Tip Adjustment:</div>
                    <div class="breakdown-cell breakdown-value">-$${tipAdjustment.toFixed(2)}</div>
                </div>` : ''}
                ${pmData.has_deposit_rounding === 'true' ? `
                <div class="breakdown-row" style="background-color: #fff3cd;">
                    <div class="breakdown-cell breakdown-label">Raw Deposit Amount:</div>
                    <div class="breakdown-cell breakdown-value">$${pmData.raw_deposit_amount}</div>
                </div>
                <div class="breakdown-row" style="background-color: #fff3cd;">
                    <div class="breakdown-cell breakdown-label">Rounded Deposit Amount:</div>
                    <div class="breakdown-cell breakdown-value">$${pmData.deposit_amount}</div>
                </div>
                <div class="breakdown-row" style="background-color: #fff3cd;">
                    <div class="breakdown-cell breakdown-label">Rounding Adjustment Needed:</div>
                    <div class="breakdown-cell breakdown-value">$${pmData.deposit_rounding_adjustment}</div>
                </div>
                <div class="breakdown-row" style="background-color: #fff3cd;">
                    <div class="breakdown-cell breakdown-label">Taken from Tips (Whole $):</div>
                    <div class="breakdown-cell breakdown-value">-$${pmData.deposit_tip_adjustment}</div>
                </div>
                <div class="breakdown-row" style="background-color: #fff3cd;">
                    <div class="breakdown-cell breakdown-label">Excess to Cashbox:</div>
                    <div class="breakdown-cell breakdown-value">+$${pmData.deposit_excess_to_cashbox}</div>
                </div>` : ''}
                <div class="breakdown-row">
                    <div class="breakdown-cell breakdown-label">Owed to Restaurant:</div>
                    <div class="breakdown-cell breakdown-value">$${pmData.pm_toast_sales.toFixed(2)}</div>
                </div>
                <div class="breakdown-row">
                    <div class="breakdown-cell breakdown-label">Cash Tips Owed to Staff:</div>
                    <div class="breakdown-cell breakdown-value">$${pmData.pm_adjusted_tips.toFixed(2)}</div>
                </div>
                <div class="breakdown-row">
                    <div class="breakdown-cell breakdown-label">Returned to Cashbox:</div>
                    <div class="breakdown-cell breakdown-value">$${(pmData.pm_amount_to_keep - amData.total).toFixed(2)} + AM Total</div>
                </div>
            </div>
        </div>

        <!-- Complete Cash Count Breakdown -->
        <div class="section">
            <div class="section-title">COMPLETE CASH COUNT BREAKDOWN</div>
            <div class="two-column">
                <!-- AM Counts -->
                <div class="column">
                    <div style="text-align: center; font-weight: bold; font-size: 8px; margin-bottom: 3px; background-color: #e6f3ff; padding: 2px;">AM COUNTS</div>
                    
                    <div class="cash-count">
                        <div style="font-weight: bold; text-decoration: underline; margin-bottom: 2px;">DRAWER 1</div>
                        ${['$100', '$50', '$20', '$10', '$5', '$1', '¢25', '¢10', '¢5', '¢1'].map(denom => {
                          const data = getDenomData(amData.drawer1.counts, denom);
                          return `<div>${denom}: ${data.count} = $${data.total}</div>`;
                        }).join('')}
                        <div class="drawer-total">TOTAL: $${amData.drawer1.total.toFixed(2)}</div>
                    </div>
                    
                    <div class="cash-count" style="margin-top: 4px;">
                        <div style="font-weight: bold; text-decoration: underline; margin-bottom: 2px;">DRAWER 2</div>
                        ${['$100', '$50', '$20', '$10', '$5', '$1', '¢25', '¢10', '¢5', '¢1'].map(denom => {
                          const data = getDenomData(amData.drawer2.counts, denom);
                          return `<div>${denom}: ${data.count} = $${data.total}</div>`;
                        }).join('')}
                        <div class="drawer-total">TOTAL: $${amData.drawer2.total.toFixed(2)}</div>
                    </div>
                    
                    <div class="shift-total am-bg">TOTAL AM: $${amData.total.toFixed(2)}</div>
                </div>
                
                <!-- PM Counts -->
                <div class="column">
                    <div style="text-align: center; font-weight: bold; font-size: 8px; margin-bottom: 3px; background-color: #fff8f0; padding: 2px;">PM COUNTS</div>
                    
                    <div class="cash-count">
                        <div style="font-weight: bold; text-decoration: underline; margin-bottom: 2px;">DRAWER 1</div>
                        ${['$100', '$50', '$20', '$10', '$5', '$1', '¢25', '¢10', '¢5', '¢1'].map(denom => {
                          const data = getDenomData(pmData.pm_drawer1_data, denom);
                          return `<div>${denom}: ${data.count} = $${data.total}</div>`;
                        }).join('')}
                        <div class="drawer-total">TOTAL: $${pmData.pm_drawer1_total.toFixed(2)}</div>
                    </div>
                    
                    <div class="cash-count" style="margin-top: 4px;">
                        <div style="font-weight: bold; text-decoration: underline; margin-bottom: 2px;">DRAWER 2</div>
                        ${['$100', '$50', '$20', '$10', '$5', '$1', '¢25', '¢10', '¢5', '¢1'].map(denom => {
                          const data = getDenomData(pmData.pm_drawer2_data, denom);
                          return `<div>${denom}: ${data.count} = $${data.total}</div>`;
                        }).join('')}
                        <div class="drawer-total">TOTAL: $${pmData.pm_drawer2_total.toFixed(2)}</div>
                    </div>
                    
                    <div class="shift-total pm-bg">TOTAL PM: $${pmData.pm_total.toFixed(2)}</div>
                </div>
            </div>
            
            <!-- Overall Drawer Totals Summary -->
            <div style="margin-top: 8px; padding-top: 8px; border-top: 2px solid #000;">
                <div style="text-align: center; font-weight: bold; font-size: 10px; margin-bottom: 6px;">DRAWER TOTALS SUMMARY</div>
                <div class="two-column">
                    <div class="column">
                        <div style="font-size: 8px; font-weight: bold; text-align: center; margin-bottom: 3px;">DRAWER 1 TOTALS</div>
                        <div style="font-size: 8px;">
                            <div style="display: flex; justify-content: space-between; margin: 1px 0;">
                                <span>AM:</span>
                                <span>$${amData.drawer1.total.toFixed(2)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin: 1px 0;">
                                <span>PM:</span>
                                <span>$${pmData.pm_drawer1_total.toFixed(2)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin: 1px 0; border-top: 1px solid #000; padding-top: 1px; font-weight: bold;">
                                <span>Change:</span>
                                <span>$${(pmData.pm_drawer1_total - amData.drawer1.total).toFixed(2)}</span>
                            </div>
                        </div>
                    </div>
                    <div class="column">
                        <div style="font-size: 8px; font-weight: bold; text-align: center; margin-bottom: 3px;">DRAWER 2 TOTALS</div>
                        <div style="font-size: 8px;">
                            <div style="display: flex; justify-content: space-between; margin: 1px 0;">
                                <span>AM:</span>
                                <span>$${amData.drawer2.total.toFixed(2)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin: 1px 0;">
                                <span>PM:</span>
                                <span>$${pmData.pm_drawer2_total.toFixed(2)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin: 1px 0; border-top: 1px solid #000; padding-top: 1px; font-weight: bold;">
                                <span>Change:</span>
                                <span>$${(pmData.pm_drawer2_total - amData.drawer2.total).toFixed(2)}</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div style="text-align: center; font-weight: bold; font-size: 9px; margin-top: 6px; padding: 4px; border: 2px solid #000; background-color: #f0f0f0;">
                    COMBINED DRAWER CHANGE: $${(actualCashIn).toFixed(2)}
                </div>
            </div>
        </div>
    </body>
    </html>
    `;
    
    console.log('Generated HTML length:', htmlContent.length);
    return htmlContent;
  }
  
  function generateDateRangeReportHtml(startDate, endDate, data, realEnvelopeAmount = null) {
    // Calculate totals according to requirements
    let totalToastSalesReported = 0;
    let totalActualCashIn = 0;
    let totalDiscrepancy = 0;
    let totalOriginalCashTips = 0;
    let totalAdjustedCashTips = 0;
    let totalEnvelopeDeposits = 0;
    let totalBackToCashbox = 0;
    
    data.forEach(day => {
      totalToastSalesReported += day.pm_toast_sales || 0;
      totalActualCashIn += (day.pm_total - day.am_total) || 0;
      totalDiscrepancy += day.pm_discrepancy || 0;
      totalOriginalCashTips += day.pm_cash_tips || 0;
      totalAdjustedCashTips += day.pm_adjusted_tips || 0;
      totalEnvelopeDeposits += day.pm_deposit_amount || 0;
      // Fix: Calculate actual excess returned to cashbox (not total amount)
      totalBackToCashbox += (day.pm_amount_to_keep - day.am_total) || 0;
    });
    
    return `
      <div style="font-family: Arial, sans-serif; max-width: 900px; margin: 0 auto; font-size: 14px; line-height: 1.3;">
        <!-- Title with Confidential -->
        <div style="text-align: center; margin-bottom: 25px; padding: 15px; background: #f0f0f0; border-radius: 0; border: 2px solid #000;">
          <h2 style="margin: 0; color: #333; font-size: 18px; font-weight: bold;">**CONFIDENTIAL**</h2>
          <h2 style="margin: 5px 0; color: #333; font-size: 16px;">JAYNA GYRO MULTI-DAY CASH REPORT</h2>
          <p style="margin: 5px 0; font-size: 14px; color: #666; font-weight: bold;">
            ${new Date(startDate + 'T12:00:00').toLocaleDateString()} - ${new Date(endDate + 'T12:00:00').toLocaleDateString()}
          </p>
          <p style="margin: 5px 0; font-size: 12px; color: #888;">${data.length} days included</p>
        </div>
        
        <!-- Key Totals Grid -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px;">
          
          <div style="background: #e6f3ff; padding: 15px; border: 2px solid #000; border-radius: 0; text-align: center;">
            <h4 style="margin: 0 0 8px 0; color: #1e3c72; font-size: 12px;">TOTAL TOAST CASH SALES REPORTED</h4>
            <p style="font-size: 20px; font-weight: bold; margin: 0; color: #1e3c72;">$${totalToastSalesReported.toFixed(2)}</p>
          </div>
          
          <div style="background: #f0f8ff; padding: 15px; border: 2px solid #000; border-radius: 0; text-align: center;">
            <h4 style="margin: 0 0 8px 0; color: #28a745; font-size: 12px;">TOTAL ACTUAL CASH IN</h4>
            <p style="font-size: 20px; font-weight: bold; margin: 0; color: #28a745;">$${totalActualCashIn.toFixed(2)}</p>
            <p style="font-size: 10px; margin: 5px 0 0 0; color: #666;">(Based on PM-AM counts for each day)</p>
          </div>
          
          <div style="background: #ffe6e6; padding: 15px; border: 2px solid #000; border-radius: 0; text-align: center;">
            <h4 style="margin: 0 0 8px 0; color: #dc3545; font-size: 12px;">TOTAL DISCREPANCY</h4>
            <p style="font-size: 20px; font-weight: bold; margin: 0; color: #dc3545;">
              ${totalDiscrepancy >= 0 ? '+' : ''}$${totalDiscrepancy.toFixed(2)}
            </p>
            <p style="font-size: 10px; margin: 5px 0 0 0; color: #666;">(Between Toast and Count)</p>
          </div>
          
          <div style="background: #fff3e0; padding: 15px; border: 2px solid #000; border-radius: 0; text-align: center;">
            <h4 style="margin: 0 0 8px 0; color: #ff9800; font-size: 12px;">TOTAL CASH TIPS ORIGINALLY REPORTED</h4>
            <p style="font-size: 20px; font-weight: bold; margin: 0; color: #ff9800;">$${totalOriginalCashTips.toFixed(2)}</p>
          </div>
          
          <div style="background: #f3e5f5; padding: 15px; border: 2px solid #000; border-radius: 0; text-align: center;">
            <h4 style="margin: 0 0 8px 0; color: #9c27b0; font-size: 12px;">TOTAL ADJUSTED CASH TIPS</h4>
            <p style="font-size: 20px; font-weight: bold; margin: 0; color: #9c27b0;">$${totalAdjustedCashTips.toFixed(2)}</p>
            <p style="font-size: 10px; margin: 5px 0 0 0; color: #666;">(Adjusted to make up for discrepancies)</p>
          </div>
          
          <div style="background: #e8f5e8; padding: 15px; border: 2px solid #000; border-radius: 0; text-align: center;">
            <h4 style="margin: 0 0 8px 0; color: #2e7d32; font-size: 12px;">TOTAL ENVELOPE DEPOSITS</h4>
            <p style="font-size: 20px; font-weight: bold; margin: 0; color: #2e7d32;">$${totalEnvelopeDeposits}</p>
          </div>
          
          <div style="background: #fff8e1; padding: 15px; border: 2px solid #000; border-radius: 0; text-align: center;">
            <h4 style="margin: 0 0 8px 0; color: #f57c00; font-size: 12px;">TOTAL "BACK TO CASHBOX"</h4>
            <p style="font-size: 20px; font-weight: bold; margin: 0; color: #f57c00;">$${totalBackToCashbox.toFixed(2)}</p>
          </div>
          
          ${realEnvelopeAmount !== null ? `
          <div style="background: #f3e5f5; padding: 15px; border: 2px solid #000; border-radius: 0; text-align: center;">
            <h4 style="margin: 0 0 8px 0; color: #7b1fa2; font-size: 12px;">REAL ENVELOPE AMOUNT</h4>
            <p style="font-size: 20px; font-weight: bold; margin: 0; color: #7b1fa2;">$${realEnvelopeAmount.toFixed(2)}</p>
          </div>
          
          <div style="background: #e8f5e8; padding: 15px; border: 2px solid #000; border-radius: 0; text-align: center;">
            <h4 style="margin: 0 0 8px 0; color: #2e7d32; font-size: 12px;">ENVELOPE DIFFERENCE</h4>
            <p style="font-size: 20px; font-weight: bold; margin: 0; color: ${(realEnvelopeAmount - totalEnvelopeDeposits) >= 0 ? '#2e7d32' : '#d32f2f'};">
              $${(realEnvelopeAmount - totalEnvelopeDeposits).toFixed(2)}
            </p>
          </div>
          ` : ''}
          
        </div>
        
        <!-- Daily Breakdown Table -->
        <div style="border: 2px solid #000; margin: 20px 0; border-radius: 0; overflow: hidden;">
          <div style="background: #f0f0f0; padding: 10px; border-bottom: 2px solid #000;">
            <h4 style="margin: 0; text-align: center; font-size: 14px;">DAILY BREAKDOWN</h4>
          </div>
          
          <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
              <thead>
                <tr style="background: #f8f9fa;">
                  <th style="border: 1px solid #000; padding: 8px; text-align: left;">Date</th>
                  <th style="border: 1px solid #000; padding: 8px; text-align: center;">Counter</th>
                  <th style="border: 1px solid #000; padding: 8px; text-align: right;">Toast Sales</th>
                  <th style="border: 1px solid #000; padding: 8px; text-align: right;">Actual Cash In</th>
                  <th style="border: 1px solid #000; padding: 8px; text-align: right;">Discrepancy</th>
                  <th style="border: 1px solid #000; padding: 8px; text-align: right;">Envelope</th>
                  <th style="border: 1px solid #000; padding: 8px; text-align: right;">Cashbox</th>
                </tr>
              </thead>
              <tbody>
                ${data.map(day => {
                  const actualCashIn = day.pm_total - day.am_total;
                  const discrepancySign = day.pm_discrepancy >= 0 ? '+' : '';
                  return `
                    <tr>
                      <td style="border: 1px solid #000; padding: 6px; font-weight: bold;">
                        ${new Date(day.date + 'T12:00:00').toLocaleDateString()}
                      </td>
                      <td style="border: 1px solid #000; padding: 6px; text-align: center;">
                        ${day.pm_counter || 'N/A'}
                      </td>
                      <td style="border: 1px solid #000; padding: 6px; text-align: right;">
                        $${(day.pm_toast_sales || 0).toFixed(2)}
                      </td>
                      <td style="border: 1px solid #000; padding: 6px; text-align: right;">
                        $${actualCashIn.toFixed(2)}
                      </td>
                      <td style="border: 1px solid #000; padding: 6px; text-align: right; color: ${day.pm_discrepancy >= 0 ? '#28a745' : '#dc3545'};">
                        ${discrepancySign}$${Math.abs(day.pm_discrepancy || 0).toFixed(2)}
                      </td>
                      <td style="border: 1px solid #000; padding: 6px; text-align: right;">
                        $${day.pm_deposit_amount || 0}
                      </td>
                      <td style="border: 1px solid #000; padding: 6px; text-align: right;">
                        $${(day.pm_amount_to_keep || 0).toFixed(2)}
                      </td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          </div>
        </div>

        <!-- Notes and Labor Summary Section (2 columns) -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 0;">

          <!-- Left Column: Daily Notes -->
          <div style="border: 2px solid #000; border-radius: 0; overflow: hidden;">
            <div style="background: #f0f0f0; padding: 10px; border-bottom: 2px solid #000;">
              <h4 style="margin: 0; text-align: center; font-size: 14px;">DAILY NOTES</h4>
            </div>
            <div style="padding: 12px; max-height: 300px; overflow-y: auto;">
              ${data.map(day => {
                const hasNotes = (day.am_notes && day.am_notes.trim()) || (day.pm_notes && day.pm_notes.trim());
                if (!hasNotes) return '';
                return `
                  <div style="margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-left: 4px solid #667eea; border-radius: 0;">
                    <div style="font-weight: bold; color: #1e3c72; margin-bottom: 5px;">
                      ${new Date(day.date + 'T12:00:00').toLocaleDateString()}
                    </div>
                    ${day.am_notes && day.am_notes.trim() ? `
                      <div style="margin: 5px 0; font-size: 12px;">
                        <span style="font-weight: bold; color: #666;">AM:</span> ${day.am_notes}
                      </div>
                    ` : ''}
                    ${day.pm_notes && day.pm_notes.trim() ? `
                      <div style="margin: 5px 0; font-size: 12px;">
                        <span style="font-weight: bold; color: #666;">PM:</span> ${day.pm_notes}
                      </div>
                    ` : ''}
                  </div>
                `;
              }).join('') || '<p style="text-align: center; color: #999; padding: 20px;">No notes for this period</p>'}
            </div>
          </div>

          <!-- Right Column: Labor Summary -->
          <div style="border: 2px solid #000; border-radius: 0; overflow: hidden;">
            <div style="background: #f0f0f0; padding: 10px; border-bottom: 2px solid #000;">
              <h4 style="margin: 0; text-align: center; font-size: 14px;">WEEKLY LABOR SUMMARY</h4>
            </div>
            <div style="padding: 12px;">
              ${typeof tipPoolSummary !== 'undefined' && tipPoolSummary.laborData ? `
                <!-- Labor Breakdown -->
                <div style="margin-bottom: 12px;">
                  <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #ddd; font-size: 12px;">
                    <span>Base Labor Cost:</span>
                    <span style="font-weight: bold;">$${tipPoolSummary.laborData.baseLaborCost.toFixed(2)}</span>
                  </div>
                  <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #ddd; font-size: 12px;">
                    <span>Manager Salary (prorated):</span>
                    <span style="font-weight: bold;">$${tipPoolSummary.laborData.demetriSalary.toFixed(2)}</span>
                  </div>
                  <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #ddd; font-size: 12px;">
                    <span>Subtotal:</span>
                    <span style="font-weight: bold;">$${tipPoolSummary.laborData.subtotalLabor.toFixed(2)}</span>
                  </div>
                  <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 2px solid #000; font-size: 12px;">
                    <span>Payroll Burden (33%):</span>
                    <span style="font-weight: bold;">$${tipPoolSummary.laborData.payrollBurden.toFixed(2)}</span>
                  </div>
                  <div style="display: flex; justify-content: space-between; padding: 8px 0; font-size: 13px;">
                    <span style="font-weight: bold;">True Total Labor Cost:</span>
                    <span style="font-weight: bold; color: #1e3c72;">$${tipPoolSummary.laborData.trueTotalLaborCost.toFixed(2)}</span>
                  </div>
                </div>

                <!-- Labor Percentage Analysis -->
                <div style="background: ${tipPoolSummary.laborData.laborVariance > 0 ? '#ffe6e6' : '#e8f5e8'}; padding: 12px; border-radius: 0; border: 2px solid ${tipPoolSummary.laborData.laborVariance > 0 ? '#dc3545' : '#28a745'}; margin-top: 12px;">
                  <div style="text-align: center; margin-bottom: 8px;">
                    <div style="font-size: 11px; color: #666; margin-bottom: 4px;">NET SALES</div>
                    <div style="font-size: 16px; font-weight: bold;">$${tipPoolSummary.laborData.netSales.toFixed(2)}</div>
                  </div>
                  <div style="text-align: center; margin-bottom: 8px;">
                    <div style="font-size: 11px; color: #666; margin-bottom: 4px;">LABOR PERCENTAGE</div>
                    <div style="font-size: 24px; font-weight: bold; color: ${tipPoolSummary.laborData.laborVariance > 0 ? '#dc3545' : '#28a745'};">
                      ${tipPoolSummary.laborData.laborPercentage.toFixed(2)}%
                    </div>
                  </div>
                  <div style="display: flex; justify-content: space-between; padding: 6px 0; border-top: 1px solid #ddd; font-size: 11px;">
                    <span>Industry Benchmark:</span>
                    <span style="font-weight: bold;">${tipPoolSummary.laborData.industryBenchmark.toFixed(1)}%</span>
                  </div>
                  <div style="display: flex; justify-content: space-between; padding: 6px 0; font-size: 11px;">
                    <span>Variance:</span>
                    <span style="font-weight: bold; color: ${tipPoolSummary.laborData.laborVariance > 0 ? '#dc3545' : '#28a745'};">
                      ${tipPoolSummary.laborData.laborVariance > 0 ? '+' : ''}${tipPoolSummary.laborData.laborVariance.toFixed(2)}%
                      ${tipPoolSummary.laborData.laborVariance > 0 ? 'OVER' : 'UNDER'}
                    </span>
                  </div>
                </div>

                <div style="margin-top: 10px; padding: 8px; background: #f8f9fa; border-radius: 0; font-size: 10px; text-align: center; color: #666;">
                  <strong>Note:</strong> Includes $85k annual manager salary ($1,634.62/week) + 33% payroll burden
                </div>
              ` : `
                <p style="text-align: center; color: #999; padding: 20px; font-size: 12px;">
                  Labor data not available.<br>
                  Calculate tip pool first to see labor summary.
                </p>
              `}
            </div>
          </div>

        </div>
      </div>
    `;
  }
  
  function resetForm(shift) {
    document.getElementById(`${shift}Counter`).value = '';
    document.getElementById(`${shift}Notes`).value = '';
    
    // Reset drawer skips
    document.getElementById(`${shift}Drawer1Skip`).checked = false;
    document.getElementById(`${shift}Drawer2Skip`).checked = false;
    toggleSkip(shift, 1);
    toggleSkip(shift, 2);
    
    // Reset all denomination inputs
    DENOMINATIONS.forEach((denom, index) => {
      document.getElementById(`${shift}D1Q${index}`).value = '0';
      document.getElementById(`${shift}D2Q${index}`).value = '0';
    });
    
    if (shift === 'pm') {
      document.getElementById('toastSales').value = '';
      document.getElementById('cashTips').value = '';
    }
    
    updateCalculations(shift, 1);
    updateCalculations(shift, 2);
  }

  // ===== TIP POOL CALCULATOR FUNCTIONS =====
  
  // Global state for tip pool calculations
  let tipPoolRecords = [];
  let tipPoolSummary = {};
  
  // Predefined equity mapping - can be extended as needed
  const defaultEquity = {
    'Dokcu, Huseyin': 0.5,
    'Morales, Emilio': 0.5
  };

  // Helper function to show error messages
  function showErrorMessage(message, targetSectionId = null) {
    const errorMsg = document.createElement('div');
    errorMsg.className = 'message error';
    errorMsg.innerHTML = `<strong>Error:</strong> ${message}`;
    
    let targetSection;
    
    if (targetSectionId) {
      // Use specified target section
      targetSection = document.getElementById(targetSectionId);
    } else {
      // Find the currently active section
      targetSection = document.querySelector('.form-section.active');
    }
    
    if (targetSection) {
      // Insert at the top of the target section
      const firstChild = targetSection.firstElementChild;
      targetSection.insertBefore(errorMsg, firstChild.nextSibling);
    } else {
      // Fallback to tip pool form if no target section found
      const tipPoolForm = document.getElementById('tipPoolForm');
      const firstChild = tipPoolForm.firstElementChild;
      tipPoolForm.insertBefore(errorMsg, firstChild.nextSibling);
    }
    
    // Remove message after 8 seconds (longer for historical report errors)
    setTimeout(() => {
      if (errorMsg.parentNode) {
        errorMsg.remove();
      }
    }, 8000);
  }

  // Helper function to show success messages
  function showSuccessMessage(message, targetSectionId = 'tipPoolForm') {
    console.log('showSuccessMessage called with:', message);
    const successMsg = document.createElement('div');
    successMsg.className = 'message success';
    successMsg.innerHTML = `<strong>Success:</strong> ${message}`;
    
    // Insert at the top of the specified form
    const targetForm = document.getElementById(targetSectionId);
    console.log(`${targetSectionId} form found:`, targetForm);
    const firstChild = targetForm.firstElementChild;
    targetForm.insertBefore(successMsg, firstChild.nextSibling);
    console.log('Success message inserted');
    
    // Remove message after 5 seconds
    setTimeout(() => {
      if (successMsg.parentNode) {
        successMsg.remove();
      }
    }, 5000);
    console.log('showSuccessMessage completed');
  }

  // ===== DATA PERSISTENCE FUNCTIONS =====
  
  // Save tip pool data to localStorage - DISABLED to reset fields every time
  function saveTipPoolData() {
    // No-op: Tip pool fields now reset every time instead of persisting
    console.log('Tip pool localStorage persistence disabled - fields will reset every time');
  }
  
  // Load tip pool data from localStorage - DISABLED to reset fields every time
  function loadTipPoolData() {
    // No-op: Tip pool fields now reset every time instead of loading from localStorage
    console.log('Tip pool localStorage loading disabled - fields start fresh every time');
    return false;
  }
  
  // Save combined report data to localStorage
  function saveCombinedReportData() {
    try {
      const combinedData = {
        formData: {
          startDate: document.getElementById('combinedStartDate').value,
          endDate: document.getElementById('combinedEndDate').value,
          realEnvelope: document.getElementById('combinedRealEnvelope').value
        },
        lastCashData: window.lastCombinedCashData || null,
        timestamp: new Date().toISOString()
      };
      localStorage.setItem('jaynaGyroCashCounter_combinedReportData', JSON.stringify(combinedData));
      console.log('Combined report data saved to localStorage');
    } catch (error) {
      console.error('Error saving combined report data:', error);
    }
  }
  
  // Load combined report data from localStorage
  function loadCombinedReportData() {
    try {
      const saved = localStorage.getItem('jaynaGyroCashCounter_combinedReportData');
      if (!saved) return false;
      
      const combinedData = JSON.parse(saved);
      
      // Restore form data
      if (combinedData.formData) {
        const form = combinedData.formData;
        document.getElementById('combinedStartDate').value = form.startDate || '';
        document.getElementById('combinedEndDate').value = form.endDate || '';
        document.getElementById('combinedRealEnvelope').value = form.realEnvelope || '';
      }
      
      // Restore cash data for re-generation
      if (combinedData.lastCashData) {
        window.lastCombinedCashData = combinedData.lastCashData;
      }
      
      console.log('Combined report data loaded from localStorage');
      return true;
    } catch (error) {
      console.error('Error loading combined report data:', error);
      return false;
    }
  }
  
  // Clear all saved data
  function clearSavedData() {
    try {
      localStorage.removeItem('jaynaGyroCashCounter_tipPoolData');
      localStorage.removeItem('jaynaGyroCashCounter_combinedReportData');
      
      // Reset tip pool state
      tipPoolRecords = [];
      tipPoolSummary = {};

      // Note: tipPoolForm is a div, not a form element, so we manually clear inputs
      // Clear tip pool form inputs
      const tipPoolInputs = document.getElementById('tipPoolForm').querySelectorAll('input, select, textarea');
      tipPoolInputs.forEach(input => {
        if (input.type === 'checkbox' || input.type === 'radio') {
          input.checked = false;
        } else {
          input.value = '';
        }
      });
      
      // Hide results
      document.getElementById('tipPoolResults').style.display = 'none';
      document.getElementById('tipPoolPdfBtn').style.display = 'none';
      document.getElementById('combinedReportSection').style.display = 'none';
      document.getElementById('tipPoolForm').classList.remove('active');
      
      showSuccessMessage('All saved data cleared. You can start fresh.');
      console.log('All saved data cleared');
    } catch (error) {
      console.error('Error clearing saved data:', error);
      showErrorMessage('Error clearing saved data: ' + error.message);
    }
  }

  // Global variable to store TDS fetch status
  let tdsDataStatus = {
    isFetching: false,
    hasData: false,
    data: 0,
    error: null
  };

  async function calculateCashTips() {
    const startDate = document.getElementById('tipPoolStartDate').value;
    const endDate = document.getElementById('tipPoolEndDate').value;
    const realEnvelopeDeposit = parseFloat(document.getElementById('realEnvelopeDeposit').value) || 0;

    if (!startDate || !endDate) {
      document.getElementById('calculatedCashTips').value = '';
      // Reset TDS data when dates are cleared
      resetTdsData();
      updateCalculateButtonState();
      return;
    }

    if (!realEnvelopeDeposit) {
      document.getElementById('calculatedCashTips').value = '';
      return;
    }

    try {
      // PRIORITY 1: Use API-fetched cash sales if available
      let totalToastCashSales = 0;

      if (apiFetchedData.salesData && apiFetchedData.salesData.cashSales) {
        // Use API data (more accurate)
        totalToastCashSales = apiFetchedData.salesData.cashSales;
        console.log('calculateCashTips: Using API cash sales:', totalToastCashSales);
      } else {
        // PRIORITY 2: Fall back to database PM data if API data not available
        const { data: rangeData } = await supabase
          .from('cash_counts')
          .select('*')
          .gte('date', startDate)
          .lte('date', endDate)
          .not('pm_total', 'is', null)
          .order('date', { ascending: true });

        if (!rangeData || rangeData.length === 0) {
          document.getElementById('calculatedCashTips').value = '';
          return;
        }

        // Calculate total Toast cash sales using correct column name
        totalToastCashSales = rangeData.reduce((sum, day) => sum + (day.pm_toast_sales || 0), 0);
        console.log('calculateCashTips: Using PM database data:', totalToastCashSales);
      }

      // Calculate cash tips: Real Envelope Deposit - Toast Cash Sales
      const calculatedCashTips = realEnvelopeDeposit - totalToastCashSales;

      // Update the display
      document.getElementById('calculatedCashTips').value = calculatedCashTips.toFixed(2);

      // TDS Driver tips are now auto-fetched with other data when dates change (no delay!)

    } catch (error) {
      console.error('Error calculating cash tips:', error);
      document.getElementById('calculatedCashTips').value = '';
    }
  }

  function resetTdsData() {
    tdsDataStatus = {
      isFetching: false,
      hasData: false,
      data: 0,
      error: null
    };
    
    // Reset UI
    document.getElementById('tdsAutoFetchStatus').innerHTML = '<span style="color: #666;">Auto-calculated from Toast API when you calculate tip pool</span>';
    document.getElementById('tdsDriverTips').value = '0';
  }

  function updateCalculateButtonState() {
    const calculateBtn = document.querySelector('button[onclick="calculateTipPool()"]');
    const startDate = document.getElementById('tipPoolStartDate').value;
    const endDate = document.getElementById('tipPoolEndDate').value;
    
    if (!startDate || !endDate) {
      calculateBtn.disabled = true;
      calculateBtn.textContent = 'Calculate Tip Pool';
      calculateBtn.style.background = '#6c757d';
    } else if (tdsDataStatus.isFetching) {
      calculateBtn.disabled = true;
      calculateBtn.textContent = 'Fetching TDS Data...';
      calculateBtn.style.background = '#ffc107';
    } else if (tdsDataStatus.hasData || tdsDataStatus.error) {
      calculateBtn.disabled = false;
      calculateBtn.textContent = 'Calculate Tip Pool';
      calculateBtn.style.background = '#28a745';
    } else {
      calculateBtn.disabled = true;
      calculateBtn.textContent = 'Calculate Tip Pool';
      calculateBtn.style.background = '#6c757d';
    }
  }

  async function autoFetchTdsDriverTips(startDate, endDate, retryCount = 0) {
    // Only fetch if not already fetching for these dates
    if (tdsDataStatus.isFetching) {
      return;
    }

    console.log('Auto-fetching TDS Driver tips for date range:', startDate, 'to', endDate);
    
    tdsDataStatus.isFetching = true;
    tdsDataStatus.hasData = false;
    tdsDataStatus.error = null;
    
    // Update UI to show fetching
    document.getElementById('tdsAutoFetchStatus').innerHTML = '<span style="color: #666;">Fetching TDS driver tips...</span>';
    updateCalculateButtonState();
    
    try {
      // First authenticate with Toast - same pattern as fetchToastCashSalesForDate
      const authResponse = await fetch('/api/toast-auth', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      });
      
      if (!authResponse.ok) {
        throw new Error('Failed to authenticate with Toast API');
      }
      
      const authData = await authResponse.json();
      if (!authData.success || !authData.data?.accessToken) {
        throw new Error('Toast authentication failed');
      }
      
      // Calculate total tips across the date range
      let totalNetTips = 0;
      let totalOrderCount = 0;
      
      // Use the TDS-specific API for the entire date range (single call)
      console.log('Processing TDS fetch for entire date range:', startDate, 'to', endDate);
      
      try {
          // Use the TDS-specific API that matches comprehensive analysis exactly
          console.log(`Making TDS API call for date range with accessToken:`, authData.data.accessToken.substring(0, 20) + '...');
          const deliveryResponse = await fetch('/api/toast-tds-driver-tips', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              accessToken: authData.data.accessToken,
              startDate: startDate,
              endDate: endDate
            })
          });
          
          if (!deliveryResponse.ok) {
            if (deliveryResponse.status === 405) {
              // For 405 errors, try once more after a short delay
              if (retryCount === 0) {
                console.log('405 error encountered, retrying in 2 seconds...');
                tdsDataStatus.isFetching = false;
                await new Promise(resolve => setTimeout(resolve, 2000));
                return await autoFetchTdsDriverTips(startDate, endDate, 1);
              }
              throw new Error('TDS Driver API temporarily unavailable (405 error)');
            }
            throw new Error(`Failed to fetch TDS Driver tips: ${deliveryResponse.status}`);
          }
          
          const deliveryData = await deliveryResponse.json();
          if (deliveryData.success && deliveryData.data) {
            // Extract tips from comprehensive analysis response (single call for all dates)
            const netTips = deliveryData.data.netTips || 0;
            const grossTips = deliveryData.data.grossTips || 0;
            const voidedTips = deliveryData.data.voidedTips || 0;
            const refundedTips = deliveryData.data.refundedTips || 0;
            const orderCount = deliveryData.data.tdsDriverOrders || 0;
            
            totalNetTips = netTips; // Use NET tips (after voids/refunds)
            totalOrderCount = orderCount;
            
            console.log('TDS Driver tips fetched successfully using comprehensive analysis method:');
            console.log(`- Gross Tips: $${grossTips.toFixed(2)}`);
            console.log(`- Voided Tips: $${voidedTips.toFixed(2)}`);
            console.log(`- Refunded Tips: $${refundedTips.toFixed(2)}`);
            console.log(`- Net Tips: $${netTips.toFixed(2)}`);
            console.log(`- Orders: ${orderCount}`);
            console.log(`- Expected: $481.83 (gross) or $478.36 (net)`);
            
            // Data retrieved successfully from single comprehensive call
          }
        } catch (dayError) {
          console.warn(`Failed to fetch TDS data:`, dayError.message);
          // Set defaults if API fails
          totalNetTips = 0;
          totalOrderCount = 0;
        }
      
      // Store successful data
      tdsDataStatus.isFetching = false;
      tdsDataStatus.hasData = true;
      tdsDataStatus.data = totalNetTips;
      
      // Update the field and UI
      document.getElementById('tdsDriverTips').value = totalNetTips.toFixed(2);
      document.getElementById('tdsAutoFetchStatus').innerHTML = `<span style="color: #28a745;">Loaded: $${totalNetTips.toFixed(2)} from ${totalOrderCount} TDS orders</span>`;
      
      console.log('TDS Driver tips auto-fetched successfully:', totalNetTips);
      
    } catch (tdsError) {
      console.error('TDS Driver auto-fetch error:', tdsError);
      
      tdsDataStatus.isFetching = false;
      tdsDataStatus.error = tdsError.message;
      
      // Update UI to show error but allow calculation to proceed with 0
      document.getElementById('tdsAutoFetchStatus').innerHTML = `<span style="color: #dc3545;">Failed to fetch TDS tips: ${tdsError.message}</span>`;

      // Use 0 for TDS tips if auto-fetch fails
      document.getElementById('tdsDriverTips').value = '0';
    }
    
    // Update button state regardless of success/failure
    updateCalculateButtonState();
  }

  // Handle file upload - show status and clear API data
  function handleFileUpload() {
    const laborFile = document.getElementById('laborFile').files[0];
    const salesFile = document.getElementById('salesFile').files[0];
    const statusDiv = document.getElementById('autoFetchStatus');

    if (laborFile && salesFile) {
      // Both files uploaded - clear any API data and show success message
      apiFetchedData.laborData = null;
      apiFetchedData.salesData = null;
      statusDiv.innerHTML = '<span style="color: #28a745;">Files uploaded - will use these instead of database/API</span>';
      console.log('Files uploaded, API data cleared');
    } else if (laborFile || salesFile) {
      // Only one file - show reminder
      statusDiv.innerHTML = '<span style="color: #ffc107;">Please upload both Labor Summary CSV and Sales Summary ZIP</span>';
    } else {
      // No files - clear message
      statusDiv.innerHTML = '';
    }
  }

  // Global storage for API-fetched data
  let apiFetchedData = {
    laborData: null,
    salesData: null
  };

  // Auto-fetch function called when end date changes
  async function autoFetchOnDateChange() {
    const startDate = document.getElementById('tipPoolStartDate').value;
    const endDate = document.getElementById('tipPoolEndDate').value;

    if (!startDate || !endDate) {
      return; // Silently skip if dates not set
    }

    // CRITICAL: Check if user uploaded files
    const laborFile = document.getElementById('laborFile').files[0];
    const salesFile = document.getElementById('salesFile').files[0];
    const hasFiles = laborFile && salesFile;

    if (hasFiles) {
      console.log('Files already uploaded - skipping sales/labor auto-fetch, but still fetching TDS driver tips');
      const statusDiv = document.getElementById('autoFetchStatus');
      statusDiv.innerHTML = '<span style="color: #28a745;">Using uploaded files (will bypass database and API)</span>';

      // CRITICAL FIX: Still need to fetch TDS Driver tips (not in manual files!)
      await autoFetchTdsDriverTips(startDate, endDate);
      return;
    }

    // Show loading overlay
    const loadingOverlay = document.getElementById('loadingOverlay');
    loadingOverlay.style.display = 'flex';

    // Update status indicator
    const statusDiv = document.getElementById('autoFetchStatus');
    statusDiv.innerHTML = '<span style="color: #666;">Fetching data from Toast API...</span>';

    try {
      // Authenticate with Toast API
      console.log('Fetching from Toast API...');
      document.getElementById('loadingTitle').textContent = 'Authenticating with Toast API...';
      document.getElementById('loadingMessage').textContent = 'Please wait...';

      const authResponse = await fetch('/api/toast-auth', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      });

      if (!authResponse.ok) throw new Error('Authentication failed');
      const authData = await authResponse.json();
      if (!authData.success || !authData.data?.accessToken) throw new Error('Failed to get access token');
      const token = authData.data.accessToken;

      // Fetch labor and sales data from API
      document.getElementById('loadingTitle').textContent = 'Fetching labor and payment data...';
      document.getElementById('loadingMessage').textContent = 'Processing hundreds of payments - this may take 2-3 minutes. Please be patient!';

      const [laborResponse, salesResponse] = await Promise.all([
        fetch(`/api/toast-labor-summary?startDate=${startDate}&endDate=${endDate}&token=${token}`),
        fetch(`/api/toast-sales-summary?startDate=${startDate}&endDate=${endDate}&token=${token}`)
      ]);

      console.log('Labor response:', laborResponse.status, laborResponse.statusText);
      console.log('Sales response:', salesResponse.status, salesResponse.statusText);

      if (!laborResponse.ok) {
        const laborError = await laborResponse.text();
        console.error('Labor API error response:', laborError);
        throw new Error(`Labor API failed: ${laborResponse.status} - ${laborError}`);
      }

      if (!salesResponse.ok) {
        const salesError = await salesResponse.text();
        console.error('Sales API error response:', salesError);
        throw new Error(`Sales API failed: ${salesResponse.status} - ${salesError}`);
      }

      const [laborResult, salesResult] = await Promise.all([
        laborResponse.json(),
        salesResponse.json()
      ]);

      // Store the fetched data globally
      apiFetchedData.laborData = laborResult.employees;
      apiFetchedData.laborData.totalLaborCost = laborResult.totalLaborCost;
      apiFetchedData.salesData = {
        creditTips: salesResult.creditTips,
        creditTipsGross: salesResult.creditTipsGross || salesResult.creditTips,
        voidedTips: salesResult.voidedTips || 0,
        discounts: salesResult.discounts || 0,
        tipsOnDiscountedChecks: salesResult.tipsOnDiscountedChecks || 0,
        cashSales: salesResult.cashSales,
        netSales: salesResult.netSales
      };

      // Show subtle success indicator
      statusDiv.innerHTML = `<span style="color: #28a745;">✓ Data loaded from Toast API: ${laborResult.employeesCount} employees, $${salesResult.creditTips.toFixed(2)} credit tips</span>`;

      console.log('Auto-fetch complete:', { laborResult, salesResult });

      // Display enhanced sales summary
      console.log(`\n=== SALES SUMMARY ===`);
      console.log(`Method: ${salesResult.method || 'ordersBulk endpoint'}`);
      console.log(`Version: ${salesResult.version || 'Unknown'}`);
      console.log(`Net Sales: $${salesResult.netSales.toFixed(2)}`);

      // Handle both ordersBulk and Payments endpoint formats
      if (salesResult.creditCount !== undefined) {
        // Payments endpoint format
        console.log(`Credit Payments: ${salesResult.creditCount}, Amount: $${salesResult.creditAmount.toFixed(2)}`);
      }
      console.log(`Credit Tips: $${salesResult.creditTips.toFixed(2)}`);

      if (salesResult.creditTipsGross && salesResult.creditTipsGross !== salesResult.creditTips) {
        console.log(`  - Gross: $${salesResult.creditTipsGross.toFixed(2)}`);
      }

      if (salesResult.cashSales && salesResult.cashSales > 0) {
        const cashTipsDisplay = salesResult.cashTips !== undefined ? `, Tips: $${salesResult.cashTips.toFixed(2)}` : '';
        console.log(`Cash Sales: $${salesResult.cashSales.toFixed(2)}${cashTipsDisplay}`);
      }

      if (salesResult.otherSales && salesResult.otherSales > 0) {
        console.log(`Other Sales: $${salesResult.otherSales.toFixed(2)}, Tips: $${salesResult.otherTips.toFixed(2)}`);
      }

      if (salesResult.voidedTips && salesResult.voidedTips > 0) {
        console.log(`Voided Tips: $${salesResult.voidedTips.toFixed(2)}`);
      }

      if (salesResult.deniedPayments && salesResult.deniedPayments > 0) {
        console.log(`DENIED Payments: ${salesResult.deniedPayments}`);
      }

      if (salesResult.tipsOnDiscountedChecks && salesResult.tipsOnDiscountedChecks > 0) {
        console.log(`Tips on Discounted Checks: $${salesResult.tipsOnDiscountedChecks.toFixed(2)}`);
      }

      if (salesResult.totalTips !== undefined) {
        console.log(`Total Tips: $${salesResult.totalTips.toFixed(2)}`);
      }
      console.log(`===================\n`);

      // Auto-fetch TDS Driver tips
      await autoFetchTdsDriverTips(startDate, endDate);

      // Hide loading overlay on success
      loadingOverlay.style.display = 'none';

    } catch (error) {
      console.error('Auto-fetch error:', error);
      const statusDiv = document.getElementById('autoFetchStatus');
      statusDiv.innerHTML = '<span style="color: #dc3545;">Failed to fetch data. You can upload files manually instead.</span>';

      // Hide loading overlay on error
      loadingOverlay.style.display = 'none';
    }
  }

  // Legacy function kept for compatibility (if called elsewhere)
  async function fetchTipPoolDataFromAPI() {
    await autoFetchOnDateChange();
  }

  async function calculateTipPool() {
    const laborFile = document.getElementById('laborFile').files[0];
    const salesFile = document.getElementById('salesFile').files[0];
    const startDate = document.getElementById('tipPoolStartDate').value;
    const endDate = document.getElementById('tipPoolEndDate').value;
    const realEnvelopeDeposit = parseFloat(document.getElementById('realEnvelopeDeposit').value) || 0;
    const ezcaterTips = parseFloat(document.getElementById('ezcaterTips').value) || 0;
    const calculatedByName = document.getElementById('calculatedByName').value.trim();
    const customNotes = document.getElementById('tipPoolNotes').value.trim();

    // Fetch previous week's unpaid tip variance from database
    let previousVariance = 0;
    let carriedFromDate = null;

    console.log(`🔍 Checking for unpaid tip variance from weeks before ${endDate}...`);

    try {
      const { data: varianceData, error: varianceError } = await supabase
        .from('tip_variance')
        .select('*')
        .lt('week_ending_date', endDate)  // Only get weeks BEFORE current week
        .order('week_ending_date', { ascending: false })  // Most recent first
        .limit(1)
        .single();

      if (varianceError) {
        // No previous data found (expected on first run)
        console.log(`✅ No previous week variance data found. This is expected for the first week.`);
        console.log(`   Current week: ${startDate} to ${endDate}`);
        console.log(`   Previous variance: $0.00 (no carryover)`);
      } else if (varianceData) {
        previousVariance = parseFloat(varianceData.variance_amount) || 0;
        carriedFromDate = varianceData.week_ending_date;
        console.log(`✅ Found previous week variance!`);
        console.log(`   Current week: ${startDate} to ${endDate}`);
        console.log(`   Carrying over: $${previousVariance.toFixed(2)} from week ending ${carriedFromDate}`);
        console.log(`   This amount will be ADDED to this week's tip pool`);
      }
    } catch (err) {
      console.log(`✅ No previous variance data exists (table may not exist yet or this is the first week)`);
      console.log(`   Error: ${err.message}`);
      console.log(`   Previous variance: $0.00 (no carryover)`);
    }

    // Fetch previous week's cash surplus from database (ONLY if positive = surplus)
    // NOTE: Tip pool date ranges are ALWAYS Monday through Sunday (7 days)
    // week_end_date is stored as Sunday's date (e.g., "2025-10-05" for week 9/29-10/5)
    let previousCashSurplus = 0;
    let cashSurplusFromDate = null;

    console.log(`🔍 Checking for previous week cash surplus from weeks before ${endDate}...`);

    try {
      const { data: cashData, error: cashError } = await supabase
        .from('weekly_combined_reports')
        .select('cash_needed, week_end_date')
        .lt('week_end_date', endDate)  // Only get weeks BEFORE current week
        .order('week_end_date', { ascending: false })  // Most recent first
        .limit(1)
        .single();

      if (cashError) {
        // No previous data found (expected on first run)
        console.log(`✅ No previous week cash data found. This is expected for the first week.`);
        console.log(`   Current week: ${startDate} to ${endDate}`);
        console.log(`   Previous cash surplus: $0.00 (no carryover)`);
      } else if (cashData) {
        const cashNeededValue = parseFloat(cashData.cash_needed) || 0;
        // ONLY carry over if it's NEGATIVE (which means surplus in our calculation)
        // In the code, negative cashNeeded = surplus (excess cash)
        if (cashNeededValue < 0) {
          previousCashSurplus = Math.abs(cashNeededValue); // Store as positive number
          cashSurplusFromDate = cashData.week_end_date;
          console.log(`✅ Found previous week cash surplus!`);
          console.log(`   Current week: ${startDate} to ${endDate}`);
          console.log(`   Carrying over: $${previousCashSurplus.toFixed(2)} from week ending ${cashSurplusFromDate}`);
          console.log(`   This amount will REDUCE cash needed (or increase surplus)`);
        } else {
          console.log(`✅ Previous week needed cash (no surplus to carry over)`);
          console.log(`   Previous week cash needed: $${cashNeededValue.toFixed(2)}`);
        }
      }
    } catch (err) {
      console.log(`✅ No previous cash data exists (table may not exist yet or this is the first week)`);
      console.log(`   Error: ${err.message}`);
      console.log(`   Previous cash surplus: $0.00 (no carryover)`);
    }

    // Check if we have either files OR API-fetched data
    const hasFiles = laborFile && salesFile;
    const hasAPIData = apiFetchedData.laborData && apiFetchedData.salesData;

    if (!hasFiles && !hasAPIData) {
      showErrorMessage('Please select dates first (data will auto-fetch) OR upload files manually.');
      return;
    }

    if (!startDate || !endDate) {
      showErrorMessage('Please select both start and end dates for cash sales calculation.');
      return;
    }

    if (!realEnvelopeDeposit) {
      showErrorMessage('Please enter the Real Envelope Deposit amount.');
      return;
    }

    if (!calculatedByName) {
      showErrorMessage('Please enter your name in the "Tips Calculated By" field.');
      return;
    }

    try {
      showLoading('Calculating Tip Pool', 'Processing payroll and sales data...');

      // Use the already-fetched TDS Driver tips from global state
      const tdsDriverTips = tdsDataStatus.hasData ? tdsDataStatus.data : 0;
      
      console.log('Using TDS Driver tips from cache:', tdsDriverTips);

      // Get Toast Cash Sales from Supabase for the date range
      const start = new Date(startDate + 'T12:00:00');
      const end = new Date(endDate + 'T12:00:00');

      if (start > end) {
        throw new Error('Start date must be before end date');
      }

      const diffTime = Math.abs(end - start);
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      
      if (diffDays > 7) {
        throw new Error('Date range cannot exceed 7 days');
      }

      // Copy exact working query from generateDateRangePDF
      const { data: rangeData } = await supabase
        .from('cash_counts')
        .select('*')
        .gte('date', startDate)
        .lte('date', endDate)
        .not('pm_total', 'is', null)
        .order('date', { ascending: true });

      if (!rangeData || rangeData.length === 0) {
        throw new Error('No cash count data found for this date range');
      }

      // Get data from either files OR API
      let payrollData, creditTips, cashSales, netSales;

      if (hasFiles) {
        // Parse uploaded files
        console.log('Using uploaded files...');
        payrollData = await parsePayrollCSV(laborFile);
        const salesData = await parseSalesZip(salesFile);
        creditTips = salesData.creditTips;
        cashSales = salesData.cashSales;
        netSales = salesData.netSales;
      } else {
        // Use API-fetched data
        console.log('Using API-fetched data...');
        payrollData = apiFetchedData.laborData;
        creditTips = apiFetchedData.salesData.creditTips;
        cashSales = apiFetchedData.salesData.cashSales;
        netSales = apiFetchedData.salesData.netSales;
      }

      // Calculate total Toast cash sales
      // ALWAYS use API cashSales when using API data (never database)
      let totalToastCashSales = 0;
      if (!hasFiles) {
        // Using API data - ALWAYS use API value (even if 0)
        totalToastCashSales = cashSales || 0;
        console.log(`Using API cashSales: $${totalToastCashSales.toFixed(2)}`);
      } else {
        // Using files - sum from database
        totalToastCashSales = rangeData.reduce((sum, day) => sum + (day.pm_toast_sales || 0), 0);
        console.log(`Using database cashSales: $${totalToastCashSales.toFixed(2)}`);
      }

      // Calculate cash tips: Real Envelope Deposit - Toast Cash Sales
      const calculatedCashTips = realEnvelopeDeposit - totalToastCashSales;

      // Update the cash tips display
      document.getElementById('calculatedCashTips').value = calculatedCashTips.toFixed(2);

      // Calculate labor metrics
      const manualLaborCostInput = parseFloat(document.getElementById('manualLaborCost').value) || 0;
      const apiLaborCost = payrollData.totalLaborCost || 0;

      // Use manual labor cost if provided (includes CA double-time), otherwise use API
      const baseLaborCost = manualLaborCostInput > 0 ? manualLaborCostInput : apiLaborCost;

      // Log the difference for transparency
      if (manualLaborCostInput > 0 && apiLaborCost > 0) {
        const difference = manualLaborCostInput - apiLaborCost;
        console.log(`Labor Cost Comparison:`);
        console.log(`  Toast Web (manual): $${manualLaborCostInput.toFixed(2)}`);
        console.log(`  API (base wages): $${apiLaborCost.toFixed(2)}`);
        console.log(`  Difference (CA double-time): $${difference.toFixed(2)} (${(difference/apiLaborCost*100).toFixed(1)}%)`);
      }

      // Handle manual net sales override
      const manualNetSalesInput = parseFloat(document.getElementById('manualNetSales').value) || 0;
      const apiNetSales = netSales; // Store original API value

      // Use manual net sales if provided, otherwise use API
      const finalNetSales = manualNetSalesInput > 0 ? manualNetSalesInput : apiNetSales;

      // Log the difference for transparency
      if (manualNetSalesInput > 0 && apiNetSales > 0) {
        const difference = manualNetSalesInput - apiNetSales;
        console.log(`Net Sales Comparison:`);
        console.log(`  Manual Net Sales: $${manualNetSalesInput.toFixed(2)}`);
        console.log(`  API Net Sales: $${apiNetSales.toFixed(2)}`);
        console.log(`  Difference: $${difference.toFixed(2)} (${(difference/apiNetSales*100).toFixed(1)}%)`);
      }

      const demetriSalary = 85000 / 52; // $85k annual salary / 52 weeks
      const subtotalLabor = baseLaborCost + demetriSalary;
      const payrollBurden = subtotalLabor * 0.33; // 33% for taxes, insurance, etc.
      const trueTotalLaborCost = subtotalLabor + payrollBurden;
      const laborPercentage = finalNetSales > 0 ? (trueTotalLaborCost / finalNetSales) * 100 : 0;
      const industryBenchmark = 30.0;
      const laborVariance = laborPercentage - industryBenchmark;

      // Compute tip pool using calculated cash tips + previous variance carryover + previous cash surplus
      const result = computeTipPool(
        payrollData,
        creditTips,
        calculatedCashTips,
        ezcaterTips,
        tdsDriverTips,
        cashSales,
        previousVariance,
        previousCashSurplus
      );

      // Store global state
      tipPoolRecords = result.records;

      // Parse date range from filename or use form dates
      let dateRange;
      if (hasFiles) {
        dateRange = parseDateRange(laborFile.name) || parseDateRange(salesFile.name);
      }
      if (!dateRange) {
        // Format: "09/29/2025 - 10/05/2025"
        const startFormatted = new Date(startDate).toLocaleDateString();
        const endFormatted = new Date(endDate).toLocaleDateString();
        dateRange = `${startFormatted} - ${endFormatted}`;
      }

      // Get voided tips info if using API
      const voidedTipsAmount = !hasFiles && apiFetchedData.salesData?.voidedTips
        ? apiFetchedData.salesData.voidedTips
        : 0;
      const creditTipsGross = !hasFiles && apiFetchedData.salesData?.creditTipsGross
        ? apiFetchedData.salesData.creditTipsGross
        : creditTips;

      tipPoolSummary = {
        creditTips: creditTips,
        creditTipsGross: creditTipsGross,
        voidedTipsTotal: voidedTipsAmount,
        cashSales: cashSales,
        cashTips: calculatedCashTips,
        realEnvelopeDeposit: realEnvelopeDeposit,
        toastCashSales: totalToastCashSales,
        ezcaterTips: ezcaterTips,
        tdsDriverTips: tdsDriverTips,
        totalTips: result.totalTips,
        pool: result.pool,
        totalWeightedHours: result.totalWeightedHours,
        hourlyRate: result.rate,
        cashNeeded: result.cashNeeded,
        dateRange: dateRange,
        calculatedByName: calculatedByName,
        customNotes: customNotes,
        generatedAt: new Date().toLocaleString(),
        // Variance tracking for compliance
        previousVariance: previousVariance,
        carriedFromDate: carriedFromDate,
        currentVariance: result.currentVariance,
        totalPaidOut: result.totalPaidOut,
        // Cash surplus tracking
        previousCashSurplus: previousCashSurplus,
        cashSurplusFromDate: cashSurplusFromDate,
        // Labor metrics for combined report
        laborData: {
          baseLaborCost: baseLaborCost,
          apiLaborCost: apiLaborCost,
          manualLaborCost: manualLaborCostInput,
          usingManualCost: manualLaborCostInput > 0,
          demetriSalary: demetriSalary,
          subtotalLabor: subtotalLabor,
          payrollBurden: payrollBurden,
          trueTotalLaborCost: trueTotalLaborCost,
          netSales: finalNetSales,
          apiNetSales: apiNetSales,
          manualNetSales: manualNetSalesInput,
          usingManualNetSales: manualNetSalesInput > 0,
          laborPercentage: laborPercentage,
          industryBenchmark: industryBenchmark,
          laborVariance: laborVariance
        }
      };

      // Display results for user to review
      console.log('About to render tip pool summary and table...');
      renderTipPoolSummary();
      console.log('Tip pool summary rendered');
      renderTipPoolTable();
      console.log('Tip pool table rendered');
      
      console.log('About to show tip pool results div...');
      
      // NUCLEAR OPTION: Force all possible visibility settings
      const tipPoolResultsDiv = document.getElementById('tipPoolResults');
      tipPoolResultsDiv.style.display = 'block';
      tipPoolResultsDiv.style.visibility = 'visible';
      tipPoolResultsDiv.style.opacity = '1';
      tipPoolResultsDiv.style.height = 'auto';
      tipPoolResultsDiv.style.overflow = 'visible';
      tipPoolResultsDiv.style.position = 'static';
      tipPoolResultsDiv.style.zIndex = 'auto';
      tipPoolResultsDiv.style.transform = 'none';
      tipPoolResultsDiv.style.maxHeight = 'none';
      tipPoolResultsDiv.style.width = 'auto';
      
      console.log('FORCED all visibility properties on tipPoolResults');
      
      document.getElementById('tipPoolPdfBtn').style.display = 'inline-block';
      document.getElementById('combinedReportSection').style.display = 'block';
      
      // Auto-populate combined report data from tip pool inputs
      document.getElementById('combinedStartDate').value = startDate;
      document.getElementById('combinedEndDate').value = endDate;
      document.getElementById('combinedRealEnvelope').value = realEnvelopeDeposit.toString();
      console.log('Auto-populated combined report data:', { startDate, endDate, realEnvelopeDeposit });
      
      // Removed saveTipPoolData() - tip pool fields now reset every time
      
      // Ensure tip pool form stays active
      document.getElementById('tipPoolForm').classList.add('active');
      console.log('Tip pool results div should now be visible');

      hideLoading();

      // Show success message with instruction to review equity
      showSuccessMessage('Tip pool calculated successfully! Please review and adjust equity percentages if needed, then click "Download Tip Pool PDF".');
      
      // Debug: Check if elements are still visible after success message
      setTimeout(() => {
        const resultsDiv = document.getElementById('tipPoolResults');
        const formDiv = document.getElementById('tipPoolForm');
        console.log('FINAL CHECK - Results div display:', resultsDiv.style.display);
        console.log('FINAL CHECK - Results div innerHTML length:', resultsDiv.innerHTML.length);
        console.log('FINAL CHECK - Results div offsetHeight:', resultsDiv.offsetHeight);
        console.log('FINAL CHECK - Results div scrollHeight:', resultsDiv.scrollHeight);
        console.log('FINAL CHECK - Results div computed style:', window.getComputedStyle(resultsDiv).display);
        console.log('FINAL CHECK - Form div classes:', formDiv.className);
        console.log('FINAL CHECK - Form div active?', formDiv.classList.contains('active'));
        console.log('FINAL CHECK - Results div visible?', resultsDiv.offsetHeight > 0);
        console.log('FINAL CHECK - Form div visible?', formDiv.offsetHeight > 0);
        
        // If still not visible, try scrolling to it
        if (resultsDiv.offsetHeight === 0) {
          console.log('Results div still not visible - trying to force scroll and flash');
          resultsDiv.style.border = '5px solid red';
          resultsDiv.style.backgroundColor = 'yellow';
          resultsDiv.style.minHeight = '200px';
          resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      }, 100);
      
      console.log('calculateTipPool function completed successfully');
      
    } catch (error) {
      hideLoading();
      console.error('Tip pool calculation error:', error);
      showErrorMessage(`Error: ${error.message}`);
    }
  }

  async function downloadTipPoolPDF() {
    try {
      showLoading('Generating PDF', 'Creating tip pool distribution report...');

      // Recalculate variance based on FINAL tip distribution (after equity adjustments)
      const totalPaidOut = tipPoolRecords.reduce((sum, rec) => sum + rec.due, 0);
      const currentVariance = tipPoolSummary.pool - totalPaidOut;

      console.log(`Final Variance Calculation (after equity adjustments):
        - Pool: $${tipPoolSummary.pool.toFixed(2)}
        - Total Paid Out: $${totalPaidOut.toFixed(2)}
        - Variance to carry forward: $${currentVariance.toFixed(2)}
      `);

      // Update tipPoolSummary with recalculated values
      tipPoolSummary.totalPaidOut = totalPaidOut;
      tipPoolSummary.currentVariance = currentVariance;

      // Save variance record to database (AFTER final equity adjustments)
      try {
        const endDate = document.getElementById('tipPoolEndDate').value;
        const startDate = document.getElementById('tipPoolStartDate').value;
        const varianceRecord = {
          week_ending_date: endDate,
          calculated_total: tipPoolSummary.pool,
          actual_paid_total: totalPaidOut,
          variance_amount: currentVariance,
          previous_variance: tipPoolSummary.previousVariance || 0,
          carried_from_date: tipPoolSummary.carriedFromDate || null
        };

        console.log(`💾 Saving final variance record for week ${startDate} to ${endDate}:`);
        console.log(`   Pool Total: $${tipPoolSummary.pool.toFixed(2)}`);
        console.log(`   Paid Out: $${totalPaidOut.toFixed(2)}`);
        console.log(`   Variance to carry forward: $${currentVariance.toFixed(2)}`);
        console.log(`   Previous variance included: $${(tipPoolSummary.previousVariance || 0).toFixed(2)}`);

        const { data: savedVariance, error: saveError } = await supabase
          .from('tip_variance')
          .upsert(varianceRecord, { onConflict: 'week_ending_date' })
          .select()
          .single();

        if (saveError) {
          console.error('❌ Error saving variance record:', saveError);
          showErrorMessage('Warning: Variance record could not be saved. PDF will still be generated.');
          await new Promise(resolve => setTimeout(resolve, 2000)); // Give user time to see warning
        } else {
          console.log(`✅ Variance record saved successfully!`);
          console.log(`   Record ID: ${savedVariance.id}`);
          console.log(`   Week ending: ${savedVariance.week_ending_date}`);
          console.log(`   Variance amount: $${savedVariance.variance_amount.toFixed(2)}`);
          console.log(`   This variance will be added to next week's tip pool (week after ${endDate})`);
        }
      } catch (varianceErr) {
        console.error('❌ Exception saving variance:', varianceErr);
        showErrorMessage('Warning: Variance record could not be saved. PDF will still be generated.');
        await new Promise(resolve => setTimeout(resolve, 2000));
      }

      await generateTipPoolPDF();

      hideLoading();
      showTipPoolSuccessMessage();

    } catch (error) {
      hideLoading();
      console.error('PDF generation error:', error);
      showErrorMessage(`Error generating PDF: ${error.message}`);
    }
  }

  async function downloadCombinedReportPDF() {
    try {
      const startDate = document.getElementById('combinedStartDate').value;
      const endDate = document.getElementById('combinedEndDate').value;
      const realEnvelopeAmount = parseFloat(document.getElementById('combinedRealEnvelope').value) || null;

      if (!startDate || !endDate) {
        showErrorMessage('Please select both start and end dates for the cash report period.');
        return;
      }

      if (!tipPoolRecords || tipPoolRecords.length === 0) {
        showErrorMessage('Please calculate tip pool first before generating combined report.');
        return;
      }

      showLoading('Generating Combined PDF', 'Creating combined weekly report...');

      // Fetch cash count data for the date range
      const start = new Date(startDate + 'T12:00:00');
      const end = new Date(endDate + 'T12:00:00');

      if (start > end) {
        throw new Error('Start date must be before end date');
      }

      const diffTime = Math.abs(end - start);
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      
      if (diffDays > 7) {
        throw new Error('Date range cannot exceed 7 days');
      }

      // Get cash data
      const { data: rangeData } = await supabase
        .from('cash_counts')
        .select('*')
        .gte('date', startDate)
        .lte('date', endDate)
        .not('pm_total', 'is', null)
        .order('date', { ascending: true });

      if (!rangeData || rangeData.length === 0) {
        throw new Error('No cash count data found for this date range');
      }

      // Store cash data for potential re-generation
      window.lastCombinedCashData = rangeData;
      
      // Save combined report data for persistence
      saveCombinedReportData();

      // Generate clean PDF using jsPDF (like tip pool report)
      await generateCombinedReportPDF(startDate, endDate, rangeData, realEnvelopeAmount);
      
      hideLoading();
      showSuccessMessage('Combined weekly report generated successfully!');
      
    } catch (error) {
      hideLoading();
      console.error('Combined PDF generation error:', error);
      showErrorMessage(`Error generating combined report: ${error.message}`);
    }
  }

  function parseDateRange(filename) {
    const re = /(\d{4})[_-](\d{2})[_-](\d{2})[-_](\d{4})[_-](\d{2})[_-](\d{2})/;
    const match = filename.match(re);
    if (!match) return '';
    
    const [, y1, m1, d1, y2, m2, d2] = match;
    const startMonth = parseInt(m1, 10).toString();
    const startDay = parseInt(d1, 10).toString();
    const endMonth = parseInt(m2, 10).toString();
    const endDay = parseInt(d2, 10).toString();
    
    return `${startMonth}/${startDay}—${endMonth}/${endDay} ${y2}`;
  }

  function parsePayrollCSV(file) {
    return new Promise((resolve, reject) => {
      Papa.parse(file, {
        header: true,
        skipEmptyLines: true,
        complete: function(results) {
          const data = results.data;
          const employeeMap = {};
          let totalLaborCost = 0;

          data.forEach(row => {
            const emp = row['Employee'];
            if (!emp) return;

            const regHours = parseFloat(row['Regular Hours']) || 0;
            const otHours = parseFloat(row['Overtime Hours']) || 0;
            const total = regHours + otHours;
            const totalPay = parseFloat(row['Total Pay']?.replace(',', '')) || 0;

            // Accumulate total labor cost
            totalLaborCost += totalPay;

            if (!employeeMap[emp]) {
              employeeMap[emp] = { hours: 0, regularHours: 0, overtimeHours: 0 };
            }
            employeeMap[emp].hours += total;
            employeeMap[emp].regularHours += regHours;
            employeeMap[emp].overtimeHours += otHours;
          });

          const result = [];
          for (const emp in employeeMap) {
            const parts = emp.split(',');
            const last = parts[0].trim();
            const first = parts.slice(1).join(',').trim();
            result.push({
              employee: emp,
              first: first,
              last: last,
              hours: employeeMap[emp].hours,
              regularHours: employeeMap[emp].regularHours,
              overtimeHours: employeeMap[emp].overtimeHours
            });
          }

          // Add labor cost data to result
          result.totalLaborCost = totalLaborCost;

          resolve(result);
        },
        error: function(err) {
          reject(err);
        }
      });
    });
  }

  async function parseSalesZip(file) {
    const arrayBuffer = await file.arrayBuffer();
    const zip = await JSZip.loadAsync(arrayBuffer);

    // Find Payments summary CSV and Net sales summary CSV
    let paymentsFile = null;
    let netSalesFile = null;
    zip.forEach((relativePath, zipEntry) => {
      if (relativePath.endsWith('Payments summary.csv')) {
        paymentsFile = zipEntry;
      }
      if (relativePath.endsWith('Net sales summary.csv')) {
        netSalesFile = zipEntry;
      }
    });

    // Parse Net Sales
    let netSales = 0;
    if (netSalesFile) {
      const netSalesCsv = await netSalesFile.async('string');
      const netSalesParsed = Papa.parse(netSalesCsv, { header: true, skipEmptyLines: true });
      if (netSalesParsed.data && netSalesParsed.data[0]) {
        netSales = parseFloat(netSalesParsed.data[0]['Net sales']) || 0;
      }
    }

    if (!paymentsFile) {
      return { creditTips: 0, cashSales: 0, netSales: netSales };
    }

    const paymentsCsv = await paymentsFile.async('string');
    const parsed = Papa.parse(paymentsCsv, { header: true, skipEmptyLines: true });

    let creditTips = 0;
    let cashSales = 0;

    parsed.data.forEach(row => {
      const paymentType = row['Payment type'] ? row['Payment type'].trim() : '';
      const paymentSubType = row['Payment sub type'];

      // Credit tips from detailed card types only
      if (paymentType === 'Credit/debit' && paymentSubType && paymentSubType.trim() !== '') {
        creditTips += parseFloat(row['Tips']) || 0;
      }

      if (paymentType === 'Cash') {
        cashSales += parseFloat(row['Amount']) || 0;
      }
    });

    return { creditTips, cashSales, netSales };
  }

  function computeTipPool(payrollData, creditTips, cashTips, ezcaterTips, tdsDriverTips, cashSales, previousVariance = 0, previousCashSurplus = 0) {
    // Build equity mapping
    const equityMap = {};
    payrollData.forEach(rec => {
      equityMap[rec.employee] = defaultEquity.hasOwnProperty(rec.employee)
        ? defaultEquity[rec.employee]
        : 1.0;
    });

    // Compute weighted hours
    let totalWeightedHours = 0;
    const records = payrollData.map(rec => {
      const equity = equityMap[rec.employee];
      const weighted = rec.hours * equity;
      totalWeightedHours += weighted;

      return {
        employee: rec.employee,
        first: rec.first,
        last: rec.last,
        hours: rec.hours,
        regularHours: rec.regularHours || 0,
        overtimeHours: rec.overtimeHours || 0,
        equity: equity,
        weighted: weighted,
        due: 0
      };
    });

    // Calculate pool WITH previous variance carryover
    const totalTips = creditTips + cashTips + ezcaterTips;
    const rawPool = totalTips - tdsDriverTips + previousVariance; // Add unpaid variance from previous week
    const pool = Math.floor(rawPool); // Floor to whole dollar

    // Calculate hourly rate
    const rate = totalWeightedHours ? pool / totalWeightedHours : 0;

    // Calculate due amounts (floored to whole dollars)
    let totalPaidOut = 0;
    records.forEach(r => {
      const rawDue = r.weighted * rate;
      r.due = Math.floor(rawDue);
      totalPaidOut += r.due;
    });

    // Calculate current week's variance (will be carried to next week)
    // This is the difference between the floored pool and what was actually paid out
    const currentVariance = pool - totalPaidOut;

    console.log(`Tip Pool Variance Calculation:
      - Raw Pool (with carryover): $${rawPool.toFixed(2)}
      - Floored Pool: $${pool.toFixed(2)}
      - Total Paid Out: $${totalPaidOut.toFixed(2)}
      - Current Variance (carryover to next week): $${currentVariance.toFixed(2)}
    `);

    // Calculate cash needed (subtract previous surplus to reduce need or increase surplus)
    const rawCashNeeded = creditTips - tdsDriverTips + ezcaterTips - cashSales;
    const cashNeeded = rawCashNeeded - previousCashSurplus;

    console.log(`Cash Need Calculation:
      - Raw Cash Needed: $${rawCashNeeded.toFixed(2)}
      - Previous Week Surplus: $${previousCashSurplus.toFixed(2)}
      - Final Cash Needed: $${cashNeeded.toFixed(2)}
    `);

    return { records, rate, totalWeightedHours, totalTips, pool, cashNeeded, currentVariance, totalPaidOut };
  }

  function renderTipPoolSummary() {
    console.log('renderTipPoolSummary called, tipPoolSummary:', tipPoolSummary);
    const summaryDiv = document.getElementById('tipPoolSummary');
    const { cashNeeded } = tipPoolSummary;
    
    // COPY EXACT LOGIC FROM ORIGINAL TIP POOL CALCULATOR LINE 565 (CORRECT LOGIC)
    let cashStatusHtml = '';
    if (cashNeeded > 0) {
      // Need additional cash - show positive amount in red
      cashStatusHtml = `<p><strong>Cash needed to pay out tips:</strong> <span class="cash-needed">$${cashNeeded.toFixed(2)}</span></p>`;
    } else {
      // Have surplus - show positive amount in green
      cashStatusHtml = `<p><strong>Zero cash needed to pay out tips this week. Excess cash on hand:</strong> <span class="cash-surplus">$${Math.abs(cashNeeded).toFixed(2)}</span></p>`;
    }
    
    // Build variance carryover display
    let varianceCarryoverHtml = '';
    if (tipPoolSummary.previousVariance && tipPoolSummary.previousVariance > 0) {
      const carriedDate = new Date(tipPoolSummary.carriedFromDate + 'T12:00:00').toLocaleDateString();
      varianceCarryoverHtml = `
          <div style="background: white; padding: 15px; border-radius: 0; border: 2px solid #ff9800; grid-column: 1 / -1;">
            <h4 style="margin: 0 0 8px 0; color: #ff9800; font-size: 12px;">⚠️ UNPAID TIPS FROM PREVIOUS WEEK</h4>
            <p style="margin: 0; font-size: 18px; font-weight: bold; color: #ff9800;">$${tipPoolSummary.previousVariance.toFixed(2)}</p>
            <p style="margin: 5px 0 0 0; font-size: 11px; color: #666;">Carried from week ending: ${carriedDate}</p>
            <p style="margin: 5px 0 0 0; font-size: 11px; font-style: italic; color: #666;">This amount has been added to this week's tip pool</p>
          </div>`;
    }

    summaryDiv.innerHTML = `
      <div style="background: #f8f9fa; padding: 20px; border-radius: 0; margin: 20px 0;">
        <h3 style="margin: 0 0 15px 0; color: #1e3c72;">Tip Pool Summary</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">

          ${varianceCarryoverHtml}

          <div style="background: white; padding: 15px; border-radius: 0; border: 1px solid #ddd;">
            <h4 style="margin: 0 0 8px 0; color: #666; font-size: 12px;">CREDIT TIPS</h4>
            <p style="margin: 0; font-size: 18px; font-weight: bold; color: #007bff;">$${tipPoolSummary.creditTips.toFixed(2)}</p>
          </div>
          
          <div style="background: white; padding: 15px; border-radius: 0; border: 1px solid #ddd;">
            <h4 style="margin: 0 0 8px 0; color: #666; font-size: 12px;">REAL ENVELOPE DEPOSIT</h4>
            <p style="margin: 0; font-size: 18px; font-weight: bold; color: #28a745;">$${tipPoolSummary.realEnvelopeDeposit.toFixed(2)}</p>
          </div>
          
          <div style="background: white; padding: 15px; border-radius: 0; border: 1px solid #ddd;">
            <h4 style="margin: 0 0 8px 0; color: #666; font-size: 12px;">TOAST CASH SALES</h4>
            <p style="margin: 0; font-size: 18px; font-weight: bold; color: #dc3545;">$${tipPoolSummary.toastCashSales.toFixed(2)}</p>
          </div>
          
          <div style="background: white; padding: 15px; border-radius: 0; border: 1px solid #ddd;">
            <h4 style="margin: 0 0 8px 0; color: #666; font-size: 12px;">CASH TIPS (CALCULATED)</h4>
            <p style="margin: 0; font-size: 18px; font-weight: bold; color: #28a745;">$${tipPoolSummary.cashTips.toFixed(2)}</p>
            <p style="margin: 5px 0 0 0; font-size: 10px; color: #666;">($${tipPoolSummary.realEnvelopeDeposit.toFixed(2)} - $${tipPoolSummary.toastCashSales.toFixed(2)})</p>
          </div>
          
          <div style="background: white; padding: 15px; border-radius: 0; border: 1px solid #ddd;">
            <h4 style="margin: 0 0 8px 0; color: #666; font-size: 12px;">TOTAL POOL</h4>
            <p style="margin: 0; font-size: 18px; font-weight: bold; color: #1e3c72;">$${tipPoolSummary.pool.toFixed(2)}</p>
          </div>
          
          <div style="background: white; padding: 15px; border-radius: 0; border: 1px solid #ddd;">
            <h4 style="margin: 0 0 8px 0; color: #666; font-size: 12px;">HOURLY RATE</h4>
            <p style="margin: 0; font-size: 18px; font-weight: bold; color: #f57c00;">$${tipPoolSummary.hourlyRate.toFixed(2)}</p>
          </div>
          
        </div>
        
        <!-- Cash Status from Original Logic -->
        <div style="margin-top: 15px; padding: 15px; background: white; border-radius: 0; border: 1px solid #ddd; text-align: center;">
          ${cashStatusHtml}
        </div>
        
        <div style="margin-top: 15px; padding: 10px; background: #e3f2fd; border-radius: 0; border-left: 4px solid #2196f3;">
          <p style="margin: 0; font-size: 14px;"><strong>Period:</strong> ${tipPoolSummary.dateRange || 'Not specified'}</p>
          <p style="margin: 5px 0 0 0; font-size: 14px;"><strong>Calculated by:</strong> ${tipPoolSummary.calculatedByName}</p>
          ${tipPoolSummary.customNotes ? `<p style="margin: 10px 0 0 0; font-size: 13px; padding-top: 8px; border-top: 1px solid #90caf9;"><strong>Notes:</strong> ${tipPoolSummary.customNotes}</p>` : ''}
        </div>

        ${tipPoolSummary.laborData ? `
        <!-- Labor Summary Section -->
        <div style="margin-top: 20px; padding: 20px; background: white; border-radius: 0; border: 2px solid #1e3c72;">
          <h3 style="margin: 0 0 15px 0; color: #1e3c72; text-transform: uppercase;">Labor Cost Analysis</h3>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">

            <!-- Left Column -->
            <div>
              <div style="padding: 10px; background: #f8f9fa; border-left: 3px solid #1e3c72; margin-bottom: 8px;">
                <div style="font-size: 11px; color: #666;">BASE LABOR COST ${tipPoolSummary.laborData.usingManualCost ? '(TOAST WEB)' : '(API)'}</div>
                <div style="font-size: 18px; font-weight: bold; color: #1e3c72;">$${tipPoolSummary.laborData.baseLaborCost.toFixed(2)}</div>
                ${tipPoolSummary.laborData.usingManualCost ? `
                  <div style="font-size: 10px; color: #28a745; margin-top: 4px;">✓ Manual cost includes CA double-time</div>
                  <div style="font-size: 9px; color: #999;">API: $${tipPoolSummary.laborData.apiLaborCost.toFixed(2)} (+$${(tipPoolSummary.laborData.manualLaborCost - tipPoolSummary.laborData.apiLaborCost).toFixed(2)})</div>
                ` : `
                  <div style="font-size: 10px; color: #ffc107; margin-top: 4px;">⚠️ May be $100-150 low (CA double-time)</div>
                `}
              </div>
              <div style="padding: 10px; background: #f8f9fa; border-left: 3px solid #6c757d; margin-bottom: 8px;">
                <div style="font-size: 11px; color: #666;">MANAGER SALARY (WEEKLY)</div>
                <div style="font-size: 18px; font-weight: bold; color: #6c757d;">$${tipPoolSummary.laborData.demetriSalary.toFixed(2)}</div>
              </div>
              <div style="padding: 10px; background: #f8f9fa; border-left: 3px solid #17a2b8; margin-bottom: 8px;">
                <div style="font-size: 11px; color: #666;">SUBTOTAL LABOR</div>
                <div style="font-size: 18px; font-weight: bold; color: #17a2b8;">$${tipPoolSummary.laborData.subtotalLabor.toFixed(2)}</div>
              </div>
              <div style="padding: 10px; background: #f8f9fa; border-left: 3px solid #ffc107; margin-bottom: 8px;">
                <div style="font-size: 11px; color: #666;">PAYROLL BURDEN (33%)</div>
                <div style="font-size: 18px; font-weight: bold; color: #f57c00;">$${tipPoolSummary.laborData.payrollBurden.toFixed(2)}</div>
              </div>
            </div>

            <!-- Right Column -->
            <div>
              <div style="padding: 10px; background: #f8f9fa; border-left: 3px solid #28a745; margin-bottom: 8px;">
                <div style="font-size: 11px; color: #666;">TRUE TOTAL LABOR COST</div>
                <div style="font-size: 18px; font-weight: bold; color: #28a745;">$${tipPoolSummary.laborData.trueTotalLaborCost.toFixed(2)}</div>
              </div>
              <div style="padding: 10px; background: #f8f9fa; border-left: 3px solid #007bff; margin-bottom: 8px;">
                <div style="font-size: 11px; color: #666;">NET SALES</div>
                <div style="font-size: 18px; font-weight: bold; color: #007bff;">$${tipPoolSummary.laborData.netSales.toFixed(2)}</div>
              </div>
              <div style="padding: 15px; background: ${tipPoolSummary.laborData.laborVariance > 0 ? '#ffebee' : '#e8f5e9'}; border-left: 4px solid ${tipPoolSummary.laborData.laborVariance > 0 ? '#dc3545' : '#28a745'}; text-align: center;">
                <div style="font-size: 11px; color: #666; margin-bottom: 5px;">LABOR PERCENTAGE</div>
                <div style="font-size: 32px; font-weight: bold; color: ${tipPoolSummary.laborData.laborVariance > 0 ? '#dc3545' : '#28a745'};">
                  ${tipPoolSummary.laborData.laborPercentage.toFixed(2)}%
                </div>
                <div style="font-size: 10px; color: #666; margin-top: 5px;">
                  Industry Benchmark: ${tipPoolSummary.laborData.industryBenchmark.toFixed(1)}%
                  <br>
                  <span style="font-weight: bold; color: ${tipPoolSummary.laborData.laborVariance > 0 ? '#dc3545' : '#28a745'};">
                    ${tipPoolSummary.laborData.laborVariance > 0 ? '▲' : '▼'} ${Math.abs(tipPoolSummary.laborData.laborVariance).toFixed(2)}%
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>
        ` : ''}
      </div>
    `;
  }

  function renderTipPoolTable() {
    console.log('renderTipPoolTable called, tipPoolRecords:', tipPoolRecords);
    const tableDiv = document.getElementById('tipPoolTable');
    
    let tableHtml = `
      <div style="margin: 16px 0;">
        <h3 style="color: var(--gray-900); margin-bottom: 8px; font-size: 14px; font-weight: 700; text-transform: uppercase; letter-spacing: 1.5px;">Employee Tip Distribution</h3>
        <p style="color: var(--gray-500); margin-bottom: 12px; font-size: 11px;">Check boxes to mark paid. Adjust equity percentages - changes save automatically.</p>
        <div style="overflow-x: auto;">
          <table id="tipPoolRecordsTable" style="width: 100%; border-collapse: collapse; background: white; border-radius: 0; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <thead>
              <tr style="background: var(--primary-blue); color: var(--gray-900);">
                <th style="padding: 8px; text-align: center; font-size: 10px; width: 30px;"></th>
                <th style="padding: 8px; text-align: left; font-size: 10px; text-transform: uppercase; letter-spacing: 1px;">#</th>
                <th style="padding: 8px; text-align: left; font-size: 10px; text-transform: uppercase; letter-spacing: 1px;">First</th>
                <th style="padding: 8px; text-align: left; font-size: 10px; text-transform: uppercase; letter-spacing: 1px;">Last</th>
                <th style="padding: 8px; text-align: center; font-size: 10px; text-transform: uppercase; letter-spacing: 1px;">Reg Hrs</th>
                <th style="padding: 8px; text-align: center; font-size: 10px; text-transform: uppercase; letter-spacing: 1px;">OT Hrs</th>
                <th style="padding: 8px; text-align: center; font-size: 10px; text-transform: uppercase; letter-spacing: 1px;">Total Hrs</th>
                <th style="padding: 8px; text-align: center; font-size: 10px; text-transform: uppercase; letter-spacing: 1px;">Equity %</th>
                <th style="padding: 8px; text-align: center; font-size: 10px; text-transform: uppercase; letter-spacing: 1px;">Weighted</th>
                <th style="padding: 8px; text-align: center; font-size: 10px; text-transform: uppercase; letter-spacing: 1px;">Tips Due</th>
              </tr>
            </thead>
            <tbody>
    `;
    
    // Sort records by last name like original
    tipPoolRecords.sort((a, b) => a.last.localeCompare(b.last));
    
    tipPoolRecords.forEach((record, index) => {
      const rowBg = index % 2 === 0 ? '#f8f9fa' : 'white';
      const equityPercent = record.equity * 100;
      // Calculate OT hours (regularHours and overtimeHours come from API)
      const regularHours = record.regularHours || 0;
      const overtimeHours = record.overtimeHours || 0;
      const totalHours = record.hours;

      // Highlight OT hours in orange if > 0
      const otStyle = overtimeHours > 0
        ? 'color: #ff8c00; font-weight: bold;'
        : '';

      tableHtml += `
        <tr data-employee="${record.employee}" style="background: ${rowBg};">
          <td style="padding: 8px; text-align: center; border-bottom: 1px solid var(--gray-300);">
            <input type="checkbox" style="width: 18px; height: 18px; cursor: pointer; accent-color: var(--primary-blue);" />
          </td>
          <td style="padding: 8px; border-bottom: 1px solid var(--gray-300); font-size: 13px; color: var(--gray-700);">${index + 1}</td>
          <td style="padding: 8px; border-bottom: 1px solid var(--gray-300); font-size: 13px; color: var(--gray-900);">${record.first}</td>
          <td style="padding: 8px; border-bottom: 1px solid var(--gray-300); font-size: 13px; font-weight: 600; color: var(--gray-900);">${record.last}</td>
          <td style="padding: 8px; text-align: center; border-bottom: 1px solid var(--gray-300); font-size: 13px; color: var(--gray-700);">${regularHours.toFixed(2)}</td>
          <td style="padding: 8px; text-align: center; border-bottom: 1px solid var(--gray-300); ${otStyle}; font-size: 13px;">${overtimeHours.toFixed(2)}</td>
          <td style="padding: 8px; text-align: center; border-bottom: 1px solid var(--gray-300); font-weight: 600; font-size: 13px; color: var(--gray-900);">${totalHours.toFixed(2)}</td>
          <td style="padding: 8px; text-align: center; border-bottom: 1px solid var(--gray-300);">
            <input type="number" name="equity" step="1" min="1" max="100" value="${equityPercent.toFixed(0)}"
                   inputmode="numeric" pattern="[0-9]*"
                   style="width: 50px; text-align: center; border: 1px solid var(--gray-300); border-radius: 0; padding: 4px; font-size: 12px;" />
          </td>
          <td style="padding: 8px; text-align: center; border-bottom: 1px solid var(--gray-300); font-size: 12px; color: var(--gray-700);">${record.weighted.toFixed(3)}</td>
          <td style="padding: 8px; text-align: center; border-bottom: 1px solid var(--gray-300); font-weight: 700; font-size: 14px; color: var(--primary-blue);">$${record.due.toFixed(2)}</td>
        </tr>
      `;
    });
    
    tableHtml += `
            </tbody>
          </table>
        </div>
      </div>
    `;
    
    tableDiv.innerHTML = tableHtml;
    
    // Attach change listeners to equity inputs - use 'blur' to prevent cursor jumping
    const inputs = tableDiv.querySelectorAll('input[name="equity"]');
    inputs.forEach(inp => {
      inp.addEventListener('blur', () => {
        recomputeTipPoolFromTable();
      });
      // Also listen for Enter key to update immediately
      inp.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          inp.blur(); // Trigger blur event
        }
      });
    });
  }

  // Recompute the tip pool when equity values are changed in the table
  function recomputeTipPoolFromTable() {
    // Read equity inputs from DOM
    const rows = document.querySelectorAll('#tipPoolRecordsTable tbody tr');
    const updatedEquity = {};
    
    rows.forEach(row => {
      const emp = row.getAttribute('data-employee');
      const eqInput = row.querySelector('input[name="equity"]');
      // The equity input represents a whole percentage (1—100). Convert it
      // to a fractional equity by dividing by 100. Use 0 if parsing fails.
      const eqPercent = parseFloat(eqInput.value);
      const eqFraction = isNaN(eqPercent) ? 0 : eqPercent / 100.0;
      updatedEquity[emp] = eqFraction;
    });
    
    // Recalculate
    let totalWeightedHours = 0;
    tipPoolRecords.forEach(r => {
      r.equity = updatedEquity[r.employee];
      r.weighted = r.hours * r.equity;
      totalWeightedHours += r.weighted;
    });
    
    // Compute the raw pool and then floor it to meet business rules
    // IMPORTANT: Include previous variance carryover in the pool
    const rawPool = tipPoolSummary.totalTips - tipPoolSummary.tdsDriverTips + (tipPoolSummary.previousVariance || 0);
    const pool = Math.floor(rawPool);
    const rate = totalWeightedHours ? pool / totalWeightedHours : 0;
    
    tipPoolRecords.forEach(r => {
      const rawDue = r.weighted * rate;
      // Round each individual's due down to the nearest whole dollar
      r.due = Math.floor(rawDue);
    });
    
    // Update summary
    tipPoolSummary.pool = pool;
    tipPoolSummary.totalWeightedHours = totalWeightedHours;
    tipPoolSummary.hourlyRate = rate;
    tipPoolSummary.cashNeeded = tipPoolSummary.creditTips - tipPoolSummary.tdsDriverTips + tipPoolSummary.ezcaterTips - tipPoolSummary.cashSales;
    
    // Removed saveTipPoolData() - tip pool fields now reset every time
    
    // Rerender summary and table
    renderTipPoolSummary();
    renderTipPoolTable();
  }

  async function generateTipPoolPDF() {
    try {
      // Create jsPDF instance
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'letter' });
      
      const pageWidth = doc.internal.pageSize.getWidth();
      const pageHeight = doc.internal.pageSize.getHeight();
      const margin = 40;
      
      // Set default font to a modern sans-serif and black text
      doc.setFont('helvetica', 'normal');
      doc.setTextColor(0, 0, 0);
      
      let currentY = margin;
      
      // Header text
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(18);
      doc.text('JAYNA SAC WEEKLY TIP POOL REPORT', margin, currentY + 15);
      doc.setFontSize(10);
      doc.setFont('helvetica', 'normal');
      
      // Use uppercase labels and values for header metadata
      const dateRange = (tipPoolSummary.dateRange || '').toUpperCase();
      doc.text(`WEEK OF: ${dateRange}`, margin, currentY + 32);
      const reporter = (tipPoolSummary.calculatedByName || '').toUpperCase();
      doc.text(`RAN BY: ${reporter}`, margin, currentY + 44);
      const timestamp = (tipPoolSummary.generatedAt || '').toUpperCase();
      doc.text(`GENERATED: ${timestamp}`, margin, currentY + 56);
      
      // Draw a thin horizontal line below header for separation
      doc.setLineWidth(0.5);
      doc.line(margin, currentY + 70, pageWidth - margin, currentY + 70);
      
      // Summary section: arrange entries in two columns
      doc.setFontSize(10);
      doc.setFont('helvetica', 'normal');
      
      // Build an array of [label, value] pairs
      const entries = [];

      // Add previous variance carryover if it exists (compliance tracking)
      if (tipPoolSummary.previousVariance && tipPoolSummary.previousVariance > 0) {
        const carriedDate = new Date(tipPoolSummary.carriedFromDate + 'T12:00:00').toLocaleDateString();
        entries.push(
          ['⚠️ UNPAID TIPS FROM PREVIOUS WEEK', `$${tipPoolSummary.previousVariance.toFixed(2)}`],
          [`   Carried from week ending ${carriedDate}`, '(ADDED TO POOL)']
        );
      }

      // Standard tip pool entries
      entries.push(
        ['Cash tips', `$${tipPoolSummary.cashTips.toFixed(2)}`],
        ['EZCater tips', `$${tipPoolSummary.ezcaterTips.toFixed(2)}`],
        ['Credit tips', `$${tipPoolSummary.creditTips.toFixed(2)}`],
        ['TDS driver', `$${tipPoolSummary.tdsDriverTips.toFixed(2)}`],
        ['Cash sales', `$${tipPoolSummary.cashSales.toFixed(2)}`],
        ['Total tips', `$${tipPoolSummary.totalTips.toFixed(2)}`],
        ['Pool (minus TDS driver)', `$${tipPoolSummary.pool.toFixed(2)}`],
        ['Total weighted hours', `${tipPoolSummary.totalWeightedHours.toFixed(3)}`],
        ['Hourly rate', `$${tipPoolSummary.hourlyRate.toFixed(2)}`]
      );

      // Convert all to uppercase
      const formattedEntries = entries.map(([label, value]) => [label.toUpperCase(), value.toUpperCase()]);
      
      // Define fixed x offsets for values within each column
      const colValueOffset = 200; // points from the left edge of the column
      let summaryY = currentY + 86;
      const lineHeight = 14;
      const colSplitIndex = Math.ceil(formattedEntries.length / 2);
      const col2X = pageWidth / 2;

      // Render first column
      for (let i = 0; i < colSplitIndex; i++) {
        const [label, value] = formattedEntries[i];
        doc.setFont('helvetica', 'bold');
        doc.text(`${label}:`, margin, summaryY + i * lineHeight);
        doc.setFont('helvetica', 'normal');
        doc.text(value, margin + colValueOffset, summaryY + i * lineHeight);
      }

      // Render second column
      for (let i = colSplitIndex; i < formattedEntries.length; i++) {
        const [label, value] = formattedEntries[i];
        const rowIdx = i - colSplitIndex;
        doc.setFont('helvetica', 'bold');
        doc.text(`${label}:`, col2X, summaryY + rowIdx * lineHeight);
        doc.setFont('helvetica', 'normal');
        doc.text(value, col2X + colValueOffset, summaryY + rowIdx * lineHeight);
      }

      // Cash needed line with color coding
      const cashNeeded = tipPoolSummary.cashNeeded;
      let needLabel, needValue, textColor;

      if (cashNeeded > 0) {
        // Need additional cash - show positive number in red
        needLabel = 'CASH NEEDED TO PAY OUT TIPS';
        needValue = `$${cashNeeded.toFixed(2)}`;
        textColor = [220, 53, 69]; // Red color
      } else {
        // Have surplus - show positive number in green
        needLabel = 'ZERO CASH NEEDED TO PAY OUT TIPS THIS WEEK. EXCESS CASH ON HAND';
        needValue = `$${Math.abs(cashNeeded).toFixed(2)}`;
        textColor = [40, 167, 69]; // Green color
      }

      const summaryLines = Math.max(colSplitIndex, formattedEntries.length - colSplitIndex);
      const cashY = summaryY + summaryLines * lineHeight + 10;
      
      // Set label in bold black
      doc.setFont('helvetica', 'bold');
      doc.setTextColor(0, 0, 0);
      doc.text(`${needLabel}:`, margin, cashY);
      
      // Calculate proper positioning for the value
      let valueX = margin + colValueOffset;
      let valueY = cashY;
      
      if (needLabel.length > 35) { // Long label - put value on next line
        valueX = margin;
        valueY = cashY + lineHeight;
      }
      
      // Set value in colored italic
      doc.setFont('helvetica', 'italic');
      doc.setTextColor(textColor[0], textColor[1], textColor[2]);
      doc.text(needValue, valueX, valueY);
      
      // Reset text color back to black for the rest of the document
      doc.setTextColor(0, 0, 0);
      
      // Draw a horizontal separator before the table
      const tableStartY = cashY + 25;
      doc.setFont('helvetica', 'normal');
      doc.setLineWidth(0.5);
      doc.line(margin, tableStartY - 5, pageWidth - margin, tableStartY - 5);
      
      // Prepare table data (convert names to uppercase)
      const tableBody = tipPoolRecords.map(r => [
        r.first.toUpperCase(),
        r.last.toUpperCase(),
        r.hours.toFixed(2),
        (r.equity * 100).toFixed(0),
        r.weighted.toFixed(3),
        '$' + r.due.toFixed(2)
      ]);
      
      // Generate the table
      doc.autoTable({
        head: [['FIRST', 'LAST', 'HOURS', 'EQUITY (%)', 'WEIGHTED', 'DUE']],
        body: tableBody,
        startY: tableStartY,
        margin: { left: margin, right: margin },
        styles: { font: 'helvetica', fontSize: 8, textColor: [0, 0, 0], lineColor: [0, 0, 0], lineWidth: 0.1 },
        headStyles: { font: 'helvetica', fontStyle: 'bold', textColor: [0, 0, 0], fillColor: null },
        bodyStyles: { font: 'helvetica', textColor: [0, 0, 0], fillColor: null },
        tableWidth: 'auto'
      });
      
      // Generate filename and save
      const dateStr = tipPoolSummary.dateRange || new Date().toLocaleDateString().replace(/\//g, '-');
      const filename = `Tip_Pool_Distribution_${dateStr}.pdf`;
      doc.save(filename);
      
    } catch (error) {
      console.error('PDF generation error:', error);
      throw error;
    }
  }

  async function generateCombinedReportPDF(startDate, endDate, cashData, realEnvelopeAmount = null, cashboxTotal = null) {
    try {
      // Fetch cashbox reconciliation data
      let cashboxReconciliation = null;
      if (cashboxTotal !== null) {
        cashboxReconciliation = await getCashboxReconciliation(cashboxTotal);
      }
      
      // Create jsPDF instance
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'letter' });
      
      const pageWidth = doc.internal.pageSize.getWidth();
      const pageHeight = doc.internal.pageSize.getHeight();
      const margin = 40;
      
      // Set default font to a modern sans-serif and black text
      doc.setFont('helvetica', 'normal');
      doc.setTextColor(0, 0, 0);
      
      let currentY = margin;
      
      // Header text with tighter spacing
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(16);  // Reduced from 18
      doc.text('JAYNA GYRO COMBINED WEEKLY REPORT', margin, currentY + 12);
      doc.setFontSize(9);   // Reduced from 10
      doc.setFont('helvetica', 'normal');
      
      // Use uppercase labels and values for header metadata with tighter spacing
      const dateRange = `${startDate.toUpperCase()} TO ${endDate.toUpperCase()}`;
      doc.text(`WEEK OF: ${dateRange}`, margin, currentY + 26);  // Reduced spacing
      const reporter = (tipPoolSummary.calculatedByName || '').toUpperCase();
      doc.text(`RAN BY: ${reporter}`, margin, currentY + 36);     // Reduced spacing
      const timestamp = new Date().toLocaleString().toUpperCase();
      doc.text(`GENERATED: ${timestamp}`, margin, currentY + 46); // Reduced spacing
      
      // Draw a thin horizontal line below header for separation
      doc.setLineWidth(0.5);
      doc.line(margin, currentY + 56, pageWidth - margin, currentY + 56); // Reduced spacing
      
      // Calculate cash report totals using same logic
      let totalToastSalesReported = 0;
      let totalActualCashIn = 0;
      let totalDiscrepancy = 0;
      let totalEnvelopeDeposits = 0;
      let totalBackToCashbox = 0;

      cashData.forEach(day => {
        totalToastSalesReported += day.pm_toast_sales || 0;
        totalActualCashIn += (day.pm_total - day.am_total) || 0;
        totalDiscrepancy += day.pm_discrepancy || 0;
        totalEnvelopeDeposits += day.pm_deposit_amount || 0;
        totalBackToCashbox += (day.pm_amount_to_keep - day.am_total) || 0;
      });

      // Summary section: arrange entries in three columns with tighter spacing
      doc.setFontSize(7);   // Further reduced for better fit
      doc.setFont('helvetica', 'normal');

      // Column 1: Cash data
      const leftColumnEntries = [
        ['Toast Cash Sales Reported', `$${totalToastSalesReported.toFixed(2)}`],
        ['Actual Cash In', `$${totalActualCashIn.toFixed(2)}`],
        ['Total Discrepancy', `$${totalDiscrepancy.toFixed(2)}`]
      ];

      // Add cashbox reconciliation if available
      if (cashboxReconciliation) {
        leftColumnEntries.push(['Current Cashbox Total', `$${cashboxReconciliation.currentTotal.toFixed(2)}`]);

        if (!cashboxReconciliation.isFirstCount && cashboxReconciliation.expectedEnding !== undefined) {
          leftColumnEntries.push(['Expected', `$${cashboxReconciliation.expectedEnding.toFixed(2)}`]);
          leftColumnEntries.push(['Total Period Discrepancies', `$${cashboxReconciliation.totalDiscrepancies.toFixed(2)}`]);

          if (Math.abs(cashboxReconciliation.actualVariance) >= 0.01) {
            const varianceLabel = cashboxReconciliation.actualVariance >= 0 ? 'Unexplained Overage' : 'Unexplained Shortage';
            leftColumnEntries.push([varianceLabel, `$${Math.abs(cashboxReconciliation.actualVariance).toFixed(2)}`]);
          } else {
            leftColumnEntries.push(['Reconciliation Status', 'BALANCED']);
          }
        } else if (!cashboxReconciliation.isFirstCount) {
          // Fallback for old logic
          const varianceLabel = cashboxReconciliation.variance >= 0 ? 'Cashbox Increase' : 'Cashbox Decrease';
          leftColumnEntries.push([varianceLabel, `$${Math.abs(cashboxReconciliation.variance).toFixed(2)}`]);
        }
      } else {
        // Fallback when no cashbox data is available yet
        leftColumnEntries.push(['Cashbox Reconciliation', 'N/A']);
      }

      const leftColumnMapped = leftColumnEntries.map(([label, value]) => [label.toUpperCase(), value.toUpperCase()]);

      // Column 2: Tip sources
      const middleColumnEntries = [];

      // Add previous variance carryover if it exists (compliance tracking)
      if (tipPoolSummary.previousVariance && tipPoolSummary.previousVariance > 0) {
        const carriedDate = new Date(tipPoolSummary.carriedFromDate + 'T12:00:00').toLocaleDateString();
        middleColumnEntries.push(
          ['UNPAID TIPS', `$${tipPoolSummary.previousVariance.toFixed(2)}`],
          [`Carried from ${carriedDate}`, '']
        );
      }

      middleColumnEntries.push(
        ['Credit Tips', `$${tipPoolSummary.creditTips.toFixed(2)}`],
        ['Cash Tips', `$${tipPoolSummary.cashTips.toFixed(2)}`],
        ['EZCater Tips', `$${tipPoolSummary.ezcaterTips.toFixed(2)}`]
      );

      const middleColumnMapped = middleColumnEntries.map(([label, value]) => [label.toUpperCase(), value.toUpperCase()]);

      // Column 3: Tip distribution
      const rightColumnEntries = [
        ['Total Tips', `$${tipPoolSummary.totalTips.toFixed(2)}`],
        ['TDS Driver', `$${tipPoolSummary.tdsDriverTips.toFixed(2)}`],
        ['Tip Pool Total (Minus TDS)', `$${tipPoolSummary.pool.toFixed(2)}`],
        ['Hourly Rate', `$${tipPoolSummary.hourlyRate.toFixed(2)}`]
      ];

      const rightColumnMapped = rightColumnEntries.map(([label, value]) => [label.toUpperCase(), value.toUpperCase()]);

      // Define fixed x offsets for values within each column
      const colWidth = (pageWidth - (2 * margin)) / 3;
      const colValueOffset = colWidth - 55;  // Dynamic offset based on column width
      let summaryY = currentY + 66; // Reduced from 86
      const lineHeight = 9;         // Further reduced to 9 from 11
      const col2X = margin + colWidth;
      const col3X = margin + (colWidth * 2);

      // Draw column 1 (cash data)
      let col1Y = summaryY;
      for (const [label, value] of leftColumnMapped) {
        doc.setFont('helvetica', 'bold');
        doc.text(`${label}:`, margin, col1Y);
        doc.setFont('helvetica', 'normal');
        doc.text(value, margin + colValueOffset, col1Y);
        col1Y += lineHeight;
      }

      // Draw column 2 (tip sources)
      let col2Y = summaryY;
      for (const [label, value] of middleColumnMapped) {
        doc.setFont('helvetica', 'bold');
        doc.text(`${label}:`, col2X, col2Y);
        doc.setFont('helvetica', 'normal');
        doc.text(value, col2X + colValueOffset, col2Y);
        col2Y += lineHeight;
      }

      // Draw column 3 (tip distribution)
      let col3Y = summaryY;
      for (const [label, value] of rightColumnMapped) {
        doc.setFont('helvetica', 'bold');
        doc.text(`${label}:`, col3X, col3Y);
        doc.setFont('helvetica', 'normal');
        doc.text(value, col3X + colValueOffset, col3Y);
        col3Y += lineHeight;
      }
      
      // Add centered Cash Needed/Surplus line below all three columns with larger italic font
      const cashNeededY = Math.max(col1Y, col2Y, col3Y) + 8;
      const cashNeededLabel = tipPoolSummary.cashNeeded > 0 ? 'CASH NEEDED' : 'CASH SURPLUS';
      const cashNeededValue = `$${Math.abs(tipPoolSummary.cashNeeded).toFixed(2)}`;
      const cashNeededText = `${cashNeededLabel}: ${cashNeededValue}`;
      
      // Set color and font for cash needed line
      if (tipPoolSummary.cashNeeded > 0) {
        doc.setTextColor(220, 53, 69); // Red for cash needed
      } else {
        doc.setTextColor(40, 167, 69); // Green for surplus
      }
      
      doc.setFont('helvetica', 'italic');
      doc.setFontSize(10); // Slightly larger but not too big
      
      // Center the text between the margins
      const textWidth = doc.getTextWidth(cashNeededText);
      const centerX = (pageWidth / 2) - (textWidth / 2);
      doc.text(cashNeededText, centerX, cashNeededY);
      
      // Reset font and color
      doc.setTextColor(0, 0, 0);
      doc.setFont('helvetica', 'normal');
      doc.setFontSize(9);

      // Add previous week cash surplus note if applicable
      let cashSurplusNoteY = cashNeededY + 8;
      if (tipPoolSummary.previousCashSurplus && tipPoolSummary.previousCashSurplus > 0) {
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(7);
        doc.setTextColor(100, 100, 100); // Gray

        // Parse date without timezone shift (dates stored as YYYY-MM-DD for Sunday of the week)
        // Append 'T12:00:00' to force local time interpretation instead of UTC
        const surplusDate = new Date(tipPoolSummary.cashSurplusFromDate + 'T12:00:00').toLocaleDateString();
        const surplusText = `Includes $${tipPoolSummary.previousCashSurplus.toFixed(2)} surplus from week ending ${surplusDate}`;

        const surplusWidth = doc.getTextWidth(surplusText);
        const surplusCenterX = (pageWidth / 2) - (surplusWidth / 2);
        doc.text(surplusText, surplusCenterX, cashSurplusNoteY);

        // Reset for next section
        doc.setTextColor(0, 0, 0);
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(9);

        // Move Y position down for next note
        cashSurplusNoteY += 8;
      }

      // Add note about cashbox reconciliation if not available
      if (!cashboxReconciliation || cashboxReconciliation.isFirstCount) {
        const noteY = cashSurplusNoteY;
        doc.setFont('helvetica', 'italic');
        doc.setFontSize(7);
        doc.setTextColor(128, 128, 128); // Light gray
        
        const noteText = cashboxReconciliation ? 
          'Weekly cashbox reconciliation will be available after multiple counts are recorded.' :
          'Weekly cashbox reconciliation feature coming soon - track total cash on hand vs. daily discrepancies.';
        
        const noteWidth = doc.getTextWidth(noteText);
        const noteCenterX = (pageWidth / 2) - (noteWidth / 2);
        doc.text(noteText, noteCenterX, noteY);
        
        // Reset font and color
        doc.setTextColor(0, 0, 0);
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(9);
      }
      
      // Draw a horizontal line after summary with reduced spacing
      // Calculate spacing based on whether we have surplus note and/or cashbox note
      let extraSpacing = 12;
      if (tipPoolSummary.previousCashSurplus > 0) extraSpacing += 8; // Add space for surplus note
      if (!cashboxReconciliation || cashboxReconciliation.isFirstCount) extraSpacing += 8; // Add space for cashbox note
      const postSummaryY = cashNeededY + extraSpacing;
      doc.setLineWidth(0.5);
      doc.line(margin, postSummaryY, pageWidth - margin, postSummaryY);
      
      // Employee distribution table with reduced spacing
      if (tipPoolRecords && tipPoolRecords.length > 0) {
        currentY = postSummaryY + 12; // Reduced from 20
        
        const tableData = tipPoolRecords.map(record => [
          `${record.first.toUpperCase()} ${record.last.toUpperCase()}`,
          record.hours.toFixed(1),
          (record.equity * 100).toFixed(0),
          record.weighted.toFixed(1),
          `$${record.due.toFixed(2)}`
        ]);
        
        // Calculate totals for the employee table
        const totalHours = tipPoolRecords.reduce((sum, record) => sum + record.hours, 0);
        const totalWeighted = tipPoolRecords.reduce((sum, record) => sum + record.weighted, 0);
        const totalDue = tipPoolRecords.reduce((sum, record) => sum + record.due, 0);
        
        // Add totals row
        const totalsRow = [
          'TOTALS',
          totalHours.toFixed(1),
          '', // Skip equity column as it doesn't make sense to total percentages
          totalWeighted.toFixed(1),
          `$${totalDue.toFixed(2)}`
        ];
        
        const tableDataWithTotals = [...tableData, totalsRow];
        
        doc.autoTable({
          startY: currentY,
          head: [['EMPLOYEE', 'HOURS', 'EQUITY (%)', 'WEIGHTED', 'DUE']],
          body: tableDataWithTotals,
          margin: { left: margin, right: margin },
          theme: 'grid',
          headStyles: { 
            font: 'helvetica', 
            fontStyle: 'bold', 
            textColor: [0, 0, 0], 
            fillColor: [245, 245, 245],
            fontSize: 8,        // Reduced font size
            cellPadding: 3      // Reduced padding
          },
          bodyStyles: { 
            font: 'helvetica', 
            textColor: [0, 0, 0], 
            fillColor: null,
            fontSize: 8,        // Reduced font size
            cellPadding: 3      // Reduced padding
          },
          didParseCell: function(data) {
            // Apply bold styling to totals row (last row)
            if (data.row.index === tableDataWithTotals.length - 1) {
              data.cell.styles.fontStyle = 'bold';
              data.cell.styles.fillColor = [240, 240, 240]; // Light gray background for totals
            }
            
            // Color formatting for DISCREPANCY column (column index 4)
            if (data.column.index === 4 && data.row.index < tableDataWithTotals.length - 1) {
              const cellValue = data.cell.text[0];
              if (cellValue && cellValue.includes('-')) {
                // Negative discrepancy - dark pastel red and italic
                data.cell.styles.textColor = [139, 69, 19]; // Dark red
                data.cell.styles.fontStyle = 'italic';
              } else if (cellValue && cellValue.includes('+')) {
                // Positive discrepancy - dark pastel green
                data.cell.styles.textColor = [34, 139, 34]; // Dark green
              }
            }
          },
          tableWidth: 'auto'
        });
        
        currentY = doc.lastAutoTable.finalY + 10; // Reduced from 20
      }
      
      // Daily cash breakdown table - Clean left-to-right flow
      if (cashData && cashData.length > 0) {
        const dailyTableData = cashData.map(day => {
          const toast = day.pm_toast_sales || 0;
          const actual = (day.pm_total || 0) - (day.am_total || 0);

          // +/- (Over/Short): Actual - Toast
          const overShort = actual - toast;
          const overShortFormatted = overShort >= 0
            ? `+$${overShort.toFixed(2)}`
            : `-$${Math.abs(overShort).toFixed(2)}`;

          // ROUND: Adjustment needed to round Toast to whole dollar
          const rounded = Math.round(toast);
          const roundAdjust = rounded - toast;
          const roundFormatted = roundAdjust >= 0
            ? `+$${roundAdjust.toFixed(2)}`
            : `-$${Math.abs(roundAdjust).toFixed(2)}`;

          // TIPS $: Whole dollar taken from tips
          const originalTips = day.pm_cash_tips || 0;
          const adjustedTips = day.pm_adjusted_tips || originalTips;
          const tipsTaken = originalTips - adjustedTips;

          // CASHBOX: Total excess to cashbox
          const cashbox = (day.pm_amount_to_keep || 0) - (day.am_total || 0);

          return [
            new Date(day.date + 'T12:00:00').toLocaleDateString(),
            day.pm_counter || 'N/A',
            `$${toast.toFixed(2)}`,
            `$${actual.toFixed(2)}`,
            overShortFormatted,
            roundFormatted,
            `$${tipsTaken.toFixed(2)}`,
            `$${cashbox.toFixed(2)}`
          ];
        });

        // Calculate totals for numerical columns (skip DATE and COUNTER columns)
        const totalsRow = ['TOTALS', '', '', '', '', '', '', ''];

        // Calculate totals for columns 2-7 (TOAST, ACTUAL, +/-, ROUND, TIPS $, CASHBOX)
        for (let col = 2; col < 8; col++) {
          let total = 0;
          dailyTableData.forEach(row => {
            let value = row[col].replace('$', '').replace('+', '').replace('-', '').replace(',', '');
            const isNegative = row[col].includes('-');
            const numValue = parseFloat(value) || 0;
            total += isNegative ? -numValue : numValue;
          });

          // Add sign formatting for +/- and ROUND columns
          if (col === 4 || col === 5) { // +/- and ROUND columns
            const sign = total >= 0 ? '+' : '';
            totalsRow[col] = `${sign}$${Math.abs(total).toFixed(2)}`;
          } else {
            totalsRow[col] = `$${total.toFixed(2)}`;
          }
        }

        // Add totals row to table data
        const tableDataWithTotals = [...dailyTableData, totalsRow];

        doc.autoTable({
          startY: currentY,
          head: [['DATE', 'COUNTER', 'TOAST', 'ACTUAL', '+/-', 'ROUND', 'TIPS $', 'CASHBOX']],
          body: tableDataWithTotals,
          margin: { left: margin, right: margin },
          theme: 'plain', // No gridlines - clean look
          headStyles: {
            font: 'helvetica',
            fontStyle: 'bold',
            textColor: [0, 0, 0],
            fillColor: [220, 220, 220], // Darker gray header
            fontSize: 7,
            cellPadding: 3,
            halign: 'center'
          },
          bodyStyles: {
            font: 'helvetica',
            textColor: [0, 0, 0],
            fontSize: 7,
            cellPadding: 3
          },
          alternateRowStyles: {
            fillColor: [245, 245, 245] // Soft gray alternating rows
          },
          didParseCell: function(data) {
            // Totals row - slightly darker background and bold
            if (data.row.index === tableDataWithTotals.length - 1) {
              data.cell.styles.fontStyle = 'bold';
              data.cell.styles.fillColor = [230, 230, 230]; // Slightly darker gray for totals
            }

            // Color formatting for +/- column (column index 4)
            if (data.column.index === 4 && data.row.index < tableDataWithTotals.length - 1) {
              const cellValue = data.cell.text[0];
              if (cellValue && cellValue.includes('-')) {
                data.cell.styles.textColor = [200, 0, 0]; // Soft red for shortage
              } else if (cellValue && cellValue.includes('+')) {
                data.cell.styles.textColor = [0, 150, 0]; // Soft green for overage
              }
            }

            // Color formatting for ROUND column (column index 5)
            if (data.column.index === 5 && data.row.index < tableDataWithTotals.length - 1) {
              const cellValue = data.cell.text[0];
              if (cellValue && cellValue.includes('+')) {
                data.cell.styles.textColor = [100, 100, 100]; // Gray for round up
              } else if (cellValue && cellValue.includes('-')) {
                data.cell.styles.textColor = [100, 100, 100]; // Gray for round down
              }
            }
          },
          tableWidth: 'auto'
        });
      }

      // Add 2-column section: Daily Notes (left) and Labor Summary (right)
      currentY = doc.autoTable.previous.finalY + 10; // Reduced from 15

      // Always show labor summary boxes (they will fit on page with compressed layout)
      if (true) {
        // Draw two bordered boxes side by side
        const boxHeight = 95; // Increased to 95 to fit all labor summary content
        const boxWidth = (pageWidth - (2 * margin) - 10) / 2; // 10pt gap between boxes
        const leftBoxX = margin;
        const rightBoxX = margin + boxWidth + 10;

        // Left box border (Daily Notes)
        doc.setDrawColor(0, 0, 0);
        doc.setLineWidth(1);
        doc.rect(leftBoxX, currentY, boxWidth, boxHeight, 'S');

        // Right box border (Labor Summary)
        doc.rect(rightBoxX, currentY, boxWidth, boxHeight, 'S');

        // Left box header - NOTES
        doc.setFillColor(240, 240, 240);
        doc.rect(leftBoxX, currentY, boxWidth, 16, 'F'); // Reduced header height to 16
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(8); // Reduced from 9
        doc.setTextColor(0, 0, 0);
        const leftHeaderText = 'NOTES';
        const leftHeaderWidth = doc.getTextWidth(leftHeaderText);
        doc.text(leftHeaderText, leftBoxX + (boxWidth - leftHeaderWidth) / 2, currentY + 11);

        // Right box header - WEEKLY LABOR SUMMARY
        doc.setFillColor(240, 240, 240);
        doc.rect(rightBoxX, currentY, boxWidth, 16, 'F'); // Reduced header height to 16
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(8); // Reduced from 9
        const rightHeaderText = 'WEEKLY LABOR SUMMARY';
        const rightHeaderWidth = doc.getTextWidth(rightHeaderText);
        doc.text(rightHeaderText, rightBoxX + (boxWidth - rightHeaderWidth) / 2, currentY + 11);

        // Horizontal line below headers
        doc.setLineWidth(1);
        doc.line(leftBoxX, currentY + 16, leftBoxX + boxWidth, currentY + 16); // Adjusted to new header height
        doc.line(rightBoxX, currentY + 16, rightBoxX + boxWidth, currentY + 16);

        // Left box content - Tip Pool Notes Only
        let notesY = currentY + 26; // Adjusted from 35
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(6.5); // Reduced from 7
        doc.setTextColor(0, 0, 0);

        // Display custom tip pool notes if available
        if (tipPoolSummary && tipPoolSummary.customNotes && tipPoolSummary.customNotes.trim()) {
          // Custom notes content
          const noteLines = doc.splitTextToSize(tipPoolSummary.customNotes.trim(), boxWidth - 10);
          noteLines.forEach(line => {
            if (notesY < currentY + boxHeight - 5) {
              doc.text(line, leftBoxX + 5, notesY);
              notesY += 7; // Reduced from 8
            }
          });
        } else {
          // No notes message (centered)
          doc.setTextColor(150, 150, 150);
          doc.text('No additional notes added during tip pool calculation', leftBoxX + boxWidth / 2, currentY + 45, { align: 'center' });
        }

        // Right box content - Labor Summary (clean and simple)
        let laborY = currentY + 26; // Adjusted from 30
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(6.5); // Reduced from 7
        doc.setTextColor(0, 0, 0);

        if (tipPoolSummary.laborData) {
          const ld = tipPoolSummary.laborData;

          // Compact labor breakdown
          const laborEntries = [
            ['Base Labor Cost:', `$${ld.baseLaborCost.toFixed(2)}`],
            ['Manager Salary (prorated):', `$${ld.demetriSalary.toFixed(2)}`],
            ['Subtotal:', `$${ld.subtotalLabor.toFixed(2)}`],
            ['Payroll Burden (33%):', `$${ld.payrollBurden.toFixed(2)}`]
          ];

          laborEntries.forEach(([label, value]) => {
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(6.5);
            doc.setTextColor(0, 0, 0);
            doc.text(label, rightBoxX + 5, laborY);
            doc.setFont('helvetica', 'bold');
            doc.text(value, rightBoxX + boxWidth - 5, laborY, { align: 'right' });
            laborY += 8.5; // Increased spacing for better readability
          });

          // Line before total
          doc.setLineWidth(0.5);
          doc.setDrawColor(200, 200, 200);
          doc.line(rightBoxX + 5, laborY + 1, rightBoxX + boxWidth - 5, laborY + 1);
          laborY += 8; // Increased spacing

          // True Total Labor Cost
          doc.setFont('helvetica', 'bold');
          doc.setFontSize(7);
          doc.setTextColor(0, 0, 0);
          doc.text('True Total Labor Cost:', rightBoxX + 5, laborY);
          doc.text(`$${ld.trueTotalLaborCost.toFixed(2)}`, rightBoxX + boxWidth - 5, laborY, { align: 'right' });
          laborY += 11; // Increased spacing before Net Sales section

          // Net Sales and Labor %
          const isOverBudget = ld.laborVariance > 0;
          const textColor = isOverBudget ? [220, 53, 69] : [40, 167, 69];

          // Background bar
          doc.setFillColor(245, 245, 245);
          doc.rect(rightBoxX + 5, laborY, boxWidth - 10, 18, 'F'); // Reduced from 24

          doc.setFont('helvetica', 'normal');
          doc.setFontSize(6); // Reduced from 7
          doc.setTextColor(0, 0, 0);
          doc.text('NET SALES', rightBoxX + 10, laborY + 5);
          doc.setFont('helvetica', 'bold');
          doc.text(`$${ld.netSales.toFixed(2)}`, rightBoxX + boxWidth - 10, laborY + 5, { align: 'right' });

          doc.setFont('helvetica', 'normal');
          doc.setFontSize(6); // Reduced from 7
          doc.setTextColor(100, 100, 100);
          doc.text('LABOR PERCENTAGE', rightBoxX + 10, laborY + 11);

          doc.setFont('helvetica', 'bold');
          doc.setFontSize(7.5); // Reduced from 9
          doc.setTextColor(textColor[0], textColor[1], textColor[2]);
          doc.text(`${ld.laborPercentage.toFixed(2)}%`, rightBoxX + boxWidth - 10, laborY + 11, { align: 'right' });

          // Variance note (smaller)
          laborY += 20; // Reduced from 26
          doc.setFont('helvetica', 'normal');
          doc.setFontSize(5.5); // Reduced from 6
          doc.setTextColor(100, 100, 100);
          const varianceText = `Target: 30.00% | ${ld.laborVariance > 0 ? '+' : ''}${ld.laborVariance.toFixed(2)}% ${isOverBudget ? 'over' : 'under'}`;
          doc.text(varianceText, rightBoxX + boxWidth / 2, laborY, { align: 'center' });

        } else {
          doc.setTextColor(150, 150, 150);
          doc.text('Labor data not available', rightBoxX + boxWidth / 2, currentY + 40, { align: 'center' });
          doc.setFont('helvetica', 'normal');
          doc.setFontSize(5.5);
          doc.text('Calculate tip pool first', rightBoxX + boxWidth / 2, currentY + 48, { align: 'center' });
        }

        // Move currentY past the boxes
        currentY += boxHeight + 8; // Further reduced spacing to prevent page overflow
      }

      // Add developer credit - centered, bold, black, positioned near bottom of page
      const footerY = pageHeight - 18; // Position near bottom (18pt from edge to prevent cutoff)
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(8);
      doc.setTextColor(0, 0, 0); // Black
      const creditText = 'Report Generation App designed and coded by Demetri Gregorakis';
      const emailText = 'demetri_gregorakis@icloud.com for troubleshooting';

      const creditWidth = doc.getTextWidth(creditText);
      const emailWidth = doc.getTextWidth(emailText);
      const centerXCredit = (pageWidth - creditWidth) / 2;
      const centerXEmail = (pageWidth - emailWidth) / 2;

      doc.text(creditText, centerXCredit, footerY);
      doc.setFont('helvetica', 'normal');
      doc.setFontSize(7);
      doc.text(emailText, centerXEmail, footerY + 8); // Reduced spacing from 12 to 8
      
      // Add payday sign off sheet as page 2
      generatePaydaySignOffPage(doc, startDate, endDate);

      // Return PDF data for potential merging, or save directly if no attachments
      // Use actual form dates for filename (not CSV parsed dates which may be off by 1 day)
      const dateStr = `${startDate}_to_${endDate}`.replace(/-/g, '_');
      const filename = `Combined_Weekly_Report_${dateStr}.pdf`;
      
      return {
        doc: doc,
        filename: filename,
        pdfBytes: doc.output('arraybuffer')
      };
      
    } catch (error) {
      console.error('Combined PDF generation error:', error);
      throw error;
    }
  }

  // Save ALL Weekly Combined Report Data to Database
  async function saveWeeklyCombinedReportData(startDate, endDate, cashData, realEnvelopeAmount, cashboxTotal, cashReportHtml = null, tipPoolHtml = null) {
    try {
      if (!supabase) {
        console.log('Supabase not available - skipping data save');
        return;
      }

      // Prepare comprehensive report data
      const reportData = {
        // Report metadata
        week_start_date: startDate,
        week_end_date: endDate,
        generated_by: tipPoolSummary.calculatedByName || 'Unknown',
        generated_at: new Date().toISOString(),
        real_envelope_amount: realEnvelopeAmount,
        cashbox_total: cashboxTotal,
        
        // Tip Pool Summary Data
        total_toast_sales: tipPoolSummary.toastSalesReported || 0,
        actual_cash_in: tipPoolSummary.actualCashIn || 0,
        total_discrepancy: tipPoolSummary.totalDiscrepancy || 0,
        envelope_deposits: tipPoolSummary.envelopeDeposits || 0,
        credit_tips: tipPoolSummary.creditTips || 0,
        cash_tips: tipPoolSummary.cashTips || 0,
        ezcater_tips: tipPoolSummary.ezcaterTips || 0,
        total_tips: tipPoolSummary.totalTips || 0,
        tds_driver_tips: tipPoolSummary.tdsDriverTips || 0,
        tip_pool_total: tipPoolSummary.tipPoolTotal || 0,
        hourly_rate: tipPoolSummary.hourlyRate || 0,
        cash_needed: tipPoolSummary.cashNeeded || 0,
        
        // Additional tip pool fields
        calculated_cash_tips: tipPoolSummary.calculatedCashTips || 0,
        total_weighted_hours: tipPoolSummary.totalWeightedHours || 0,
        total_hours_worked: tipPoolSummary.totalHoursWorked || 0,
        
        // Employee data as JSON
        employee_tip_data: JSON.stringify(tipPoolRecords || []),
        
        // Daily cash breakdown as JSON
        daily_cash_breakdown: JSON.stringify(cashData || []),
        
        // System metadata
        report_version: '3.0',
        has_attachments: false, // Will be updated if attachments exist
        
        // Store the generated HTML content for easy retrieval
        generated_cash_report_html: cashReportHtml,
        generated_tip_pool_html: tipPoolHtml
      };

      // Save main report data
      const { data: savedReport, error: reportError } = await supabase
        .from('weekly_combined_reports')
        .insert([reportData])
        .select()
        .single();

      if (reportError) {
        console.error('Error saving weekly report:', reportError);
        throw reportError;
      }

      console.log('Weekly combined report data saved successfully:', savedReport.id);
      
      // Save individual employee records for easier querying
      if (tipPoolRecords && tipPoolRecords.length > 0) {
        const employeeRecords = tipPoolRecords.map(employee => ({
          weekly_report_id: savedReport.id,
          week_start_date: startDate,
          week_end_date: endDate,
          employee_first_name: employee.first,
          employee_last_name: employee.last,
          hours_worked: employee.hours,
          regular_hours: employee.regularHours || 0,
          overtime_hours: employee.overtimeHours || 0,
          equity_percentage: employee.equity,
          weighted_hours: employee.weighted,
          tips_due: employee.due,
          created_at: new Date().toISOString()
        }));

        const { error: employeeError } = await supabase
          .from('weekly_employee_tips')
          .insert(employeeRecords);

        if (employeeError) {
          console.error('Error saving employee tip records:', employeeError);
          // Don't throw here - main report is saved
        } else {
          console.log(`Saved ${employeeRecords.length} employee tip records`);
        }
      }

      // Save daily cash breakdown records
      if (cashData && cashData.length > 0) {
        console.log('Preparing daily breakdown records from cashData:', cashData);
        
        // Filter to only include days with meaningful PM data
        const validDays = cashData.filter(day => 
          day.pm_total && day.pm_total > 0 && 
          day.pm_toast_sales && day.pm_toast_sales > 0
        );
        
        console.log(`Filtered to ${validDays.length} days with valid PM data out of ${cashData.length} total days`);
        
        const dailyRecords = validDays.map(day => {
          console.log('Processing day:', day);
          return {
            weekly_report_id: savedReport.id,
            date: day.date,
            night_counter: day.pm_counter || day.night_counter_name || 'Unknown',
            toast_sales: parseFloat(day.pm_toast_sales) || 0,
            actual_cash_in: parseFloat(day.pm_total) || 0,
            discrepancy: parseFloat(day.pm_discrepancy) || 0,
            excess: parseFloat(day.pm_drawer_over_amount) || 0,
            created_at: new Date().toISOString()
          };
        });
        
        console.log('Final daily records to insert:', dailyRecords);

        const { error: dailyError } = await supabase
          .from('weekly_daily_breakdown')
          .insert(dailyRecords);

        if (dailyError) {
          console.error('Error saving daily breakdown records:', dailyError);
          // Don't throw here - main report is saved
        } else {
          console.log(`Saved ${dailyRecords.length} daily breakdown records`);
        }
      }

      return savedReport.id;

    } catch (error) {
      console.error('Error saving weekly combined report data:', error);
      throw error;
    }
  }

  // Generate Payday Sign Off Sheet as PDF page
  function generatePaydaySignOffPage(doc, startDate, endDate) {
    try {
      // Add new page for payday sign off
      doc.addPage();
      
      const pageWidth = doc.internal.pageSize.getWidth();
      const margin = 40;
      let currentY = margin;
      
      // Header
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(18);
      doc.setTextColor(0, 0, 0);
      doc.text('JAYNA GYRO EMPLOYEE TIP OUT ACKNOWLEDGEMENT', margin, currentY + 15);
      
      // Week of section
      currentY += 35;
      doc.setFontSize(13);
      doc.text('WEEK OF', margin, currentY);
      doc.setFont('helvetica', 'normal');
      const weekRange = `${startDate.toUpperCase()} - ${endDate.toUpperCase()}`;
      doc.text(weekRange, margin + 80, currentY);
      
      // Disclaimer text - compressed for space
      currentY += 20;
      doc.setFontSize(7);
      doc.setFont('helvetica', 'normal');
      const disclaimerLines = [
        'As an employee, ensure accuracy in your working hours, compensation, and breaks. Please review the following:',
        '',
        'I have reviewed my hours worked and have been provided with a copy if requested.',
        'The tip amount in cash I was given is accurate and complete.',
        'All details in the timekeeping system including tip amounts, breaks, meal periods, and overtime are correct.',
        '',
        'If any information is incorrect or if I have not been provided a meal or rest break, I will document it below.',
        'It is not mandatory to note missed meal breaks if I worked less than six hours or have signed a meal break waiver.',
        'I am not required to document missed breaks if they were made available but I chose not to take them.'
      ];

      disclaimerLines.forEach((line, index) => {
        if (line !== '') {
          doc.text(line, margin, currentY + (index * 8));
        }
      });
      
      // Employee signature table
      currentY += disclaimerLines.length * 8 + 15;

      // Table headers
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(11);
      doc.text('EMPLOYEE NAME', margin, currentY);
      doc.text('EMPLOYEE SIGNATURE', margin + 250, currentY);

      // Line under headers
      currentY += 5;
      doc.line(margin, currentY, pageWidth - margin, currentY);

      // Employee rows - get from tip pool records
      currentY += 12;
      doc.setFont('helvetica', 'normal');
      doc.setFontSize(9);

      // Create employee list from tip pool records
      const employees = tipPoolRecords.map(record => ({
        first: record.first,
        last: record.last
      }));

      // Sort alphabetically by first name
      employees.sort((a, b) => a.first.localeCompare(b.first));

      employees.forEach((employee, index) => {
        const rowHeight = 22; // Reduced from 25 to 22
        const yPos = currentY + (index * rowHeight);

        // Alternating row background - aligned with text baseline
        if (index % 2 === 1) {
          doc.setFillColor(232, 240, 254); // Light blue background
          doc.rect(margin - 5, yPos - 8, pageWidth - 2 * margin + 10, rowHeight, 'F');
        }

        // Employee name
        doc.setTextColor(0, 0, 0);
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(9);
        doc.text(`${employee.first} ${employee.last}`, margin, yPos);

        // Signature line - positioned at same baseline as employee name for signing on top
        doc.setDrawColor(0, 0, 0);
        doc.line(margin + 250, yPos, pageWidth - margin - 10, yPos);
      });
      
      return doc;
      
    } catch (error) {
      console.error('Error generating payday sign off sheet:', error);
      throw error;
    }
  }

  // PDF Merging Function
  async function mergePDFsWithAttachments(mainPdfData, voidsFile = null, extrasFile = null) {
    try {
      const { PDFDocument } = PDFLib;
      
      // Create new PDF document
      const mergedPdf = await PDFDocument.create();
      
      // Add main report pages
      const mainPdf = await PDFDocument.load(mainPdfData.pdfBytes);
      const mainPages = await mergedPdf.copyPages(mainPdf, mainPdf.getPageIndices());
      mainPages.forEach((page) => mergedPdf.addPage(page));
      
      // Add Voids Log if uploaded
      if (voidsFile) {
        const voidsArrayBuffer = await voidsFile.arrayBuffer();
        const voidsPdf = await PDFDocument.load(voidsArrayBuffer);
        const voidsPages = await mergedPdf.copyPages(voidsPdf, voidsPdf.getPageIndices());
        voidsPages.forEach((page) => mergedPdf.addPage(page));
      }
      
      // Add Extras if uploaded
      if (extrasFile) {
        const extrasArrayBuffer = await extrasFile.arrayBuffer();
        const extrasPdf = await PDFDocument.load(extrasArrayBuffer);
        const extrasPages = await mergedPdf.copyPages(extrasPdf, extrasPdf.getPageIndices());
        extrasPages.forEach((page) => mergedPdf.addPage(page));
      }
      
      // Save merged PDF
      const mergedPdfBytes = await mergedPdf.save();
      const blob = new Blob([mergedPdfBytes], { type: 'application/pdf' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = mainPdfData.filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      return true;
    } catch (error) {
      console.error('PDF merging error:', error);
      throw new Error(`Failed to merge PDFs: ${error.message}`);
    }
  }

  function generateTipPoolReportHtml() {
    const { cashNeeded } = tipPoolSummary;
    
    // COPY EXACT LOGIC FROM ORIGINAL TIP POOL CALCULATOR LINE 565 (CORRECT LOGIC)
    let cashStatusText = '';
    let cashStatusClass = '';
    if (cashNeeded > 0) {
      // Need additional cash - show positive amount in red
      cashStatusText = 'NEEDED';
      cashStatusClass = 'color: #dc3545';
    } else {
      // Have surplus - show positive amount in green
      cashStatusText = 'SURPLUS';
      cashStatusClass = 'color: #28a745';
    }
    
    return `
      <div style="font-family: Arial, sans-serif; padding: 20px; background: white;">
        <div style="text-align: center; margin-bottom: 30px; border-bottom: 3px solid #1e3c72; padding-bottom: 20px;">
          <h1 style="margin: 0; color: #1e3c72; font-size: 24px;">JAYNA GYRO TIP POOL DISTRIBUTION</h1>
          <h2 style="margin: 10px 0 0 0; color: #666; font-size: 14px; font-weight: normal;">
            Period: ${tipPoolSummary.dateRange || 'Not specified'}
          </h2>
        </div>
        
        <!-- Summary Section -->
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 30px;">
          <div style="background: #f8f9fa; padding: 15px; border: 2px solid #007bff; border-radius: 0; text-align: center;">
            <h4 style="margin: 0 0 8px 0; color: #007bff; font-size: 12px;">CREDIT TIPS</h4>
            <p style="font-size: 18px; font-weight: bold; margin: 0; color: #007bff;">$${tipPoolSummary.creditTips.toFixed(2)}</p>
          </div>
          
          <div style="background: #f8f9fa; padding: 15px; border: 2px solid #28a745; border-radius: 0; text-align: center;">
            <h4 style="margin: 0 0 8px 0; color: #28a745; font-size: 12px;">CASH TIPS</h4>
            <p style="font-size: 18px; font-weight: bold; margin: 0; color: #28a745;">$${tipPoolSummary.cashTips.toFixed(2)}</p>
          </div>
          
          <div style="background: #f8f9fa; padding: 15px; border: 2px solid #f57c00; border-radius: 0; text-align: center;">
            <h4 style="margin: 0 0 8px 0; color: #f57c00; font-size: 12px;">EZCATER TIPS</h4>
            <p style="font-size: 18px; font-weight: bold; margin: 0; color: #f57c00;">$${tipPoolSummary.ezcaterTips.toFixed(2)}</p>
          </div>
        </div>
        
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 30px;">
          <div style="background: #f8f9fa; padding: 15px; border: 2px solid #1e3c72; border-radius: 0; text-align: center;">
            <h4 style="margin: 0 0 8px 0; color: #1e3c72; font-size: 12px;">TOTAL POOL</h4>
            <p style="font-size: 20px; font-weight: bold; margin: 0; color: #1e3c72;">$${tipPoolSummary.pool.toFixed(2)}</p>
          </div>
          
          <div style="background: #f8f9fa; padding: 15px; border: 2px solid #6c757d; border-radius: 0; text-align: center;">
            <h4 style="margin: 0 0 8px 0; color: #6c757d; font-size: 12px;">HOURLY RATE</h4>
            <p style="font-size: 18px; font-weight: bold; margin: 0; color: #6c757d;">$${tipPoolSummary.hourlyRate.toFixed(2)}</p>
          </div>
          
          <div style="background: #f8f9fa; padding: 15px; border: 2px solid ${cashNeeded > 0 ? '#dc3545' : '#28a745'}; border-radius: 0; text-align: center;">
            <h4 style="margin: 0 0 8px 0; ${cashStatusClass}; font-size: 12px;">CASH ${cashStatusText}</h4>
            <p style="font-size: 18px; font-weight: bold; margin: 0; ${cashStatusClass};">$${Math.abs(cashNeeded).toFixed(2)}</p>
          </div>
        </div>
        
        <!-- Employee Distribution Table -->
        <div style="margin-bottom: 30px;">
          <h3 style="color: #1e3c72; margin-bottom: 15px; border-bottom: 2px solid #1e3c72; padding-bottom: 5px;">
            EMPLOYEE TIP DISTRIBUTION
          </h3>
          
          <table style="width: 100%; border-collapse: collapse; border: 2px solid #000;">
            <thead>
              <tr style="background: #1e3c72; color: white;">
                <th style="padding: 12px; text-align: left; border: 1px solid #000; font-size: 12px;">EMPLOYEE</th>
                <th style="padding: 12px; text-align: center; border: 1px solid #000; font-size: 12px;">HOURS</th>
                <th style="padding: 12px; text-align: center; border: 1px solid #000; font-size: 12px;">EQUITY</th>
                <th style="padding: 12px; text-align: center; border: 1px solid #000; font-size: 12px;">WEIGHTED HOURS</th>
                <th style="padding: 12px; text-align: center; border: 1px solid #000; font-size: 12px;">TIPS DUE</th>
              </tr>
            </thead>
            <tbody>
    `;
    
    tipPoolRecords.forEach((record, index) => {
      const rowBg = index % 2 === 0 ? '#f8f9fa' : 'white';
      return `
        <tr style="background: ${rowBg};">
          <td style="padding: 10px; border: 1px solid #000; font-weight: bold;">${record.first} ${record.last}</td>
          <td style="padding: 10px; text-align: center; border: 1px solid #000;">${record.hours.toFixed(1)}</td>
          <td style="padding: 10px; text-align: center; border: 1px solid #000;">${record.equity.toFixed(2)}</td>
          <td style="padding: 10px; text-align: center; border: 1px solid #000;">${record.weighted.toFixed(1)}</td>
          <td style="padding: 10px; text-align: center; border: 1px solid #000; font-weight: bold; color: #28a745; font-size: 16px;">$${record.due.toFixed(2)}</td>
        </tr>
      `;
    }).join('') + `
            </tbody>
          </table>
        </div>
        
        <!-- Footer -->
        <div style="text-align: center; margin-top: 30px; padding-top: 20px; border-top: 2px solid #ddd; color: #666; font-size: 12px;">
          <p style="margin: 0;">Tips calculated by: <strong>${tipPoolSummary.calculatedByName}</strong></p>
          <p style="margin: 5px 0 0 0;">Generated: ${tipPoolSummary.generatedAt}</p>
          <p style="margin: 5px 0 0 0;">Jayna Gyro Cash Counter & Tip Pool System v2.86</p>
        </div>
      </div>
    `;
  }

  async function generateCombinedReport() {
    const startDate = document.getElementById('combinedStartDate').value;
    const endDate = document.getElementById('combinedEndDate').value;
    const realEnvelopeAmount = parseFloat(document.getElementById('combinedRealEnvelope').value) || null;

    console.log('generateCombinedReport called with auto-populated data:', { startDate, endDate, realEnvelopeAmount });

    if (!startDate || !endDate) {
      showErrorMessage('Please select both start and end dates for the cash report period.');
      return;
    }

    if (!tipPoolRecords || tipPoolRecords.length === 0) {
      showErrorMessage('Please calculate tip pool first before generating combined report.');
      return;
    }

    // Get cashbox count from tip pool form (optional feature)
    const cashboxData = getTipPoolCashboxData();
    const cashboxTotal = cashboxData ? cashboxData.total : null; // CRITICAL FIX: Extract total

    console.log('📦 Cashbox data from form:', cashboxData);

    try {
      showLoading('Generating Combined Report', 'Fetching cash count data and combining with tip pool...');

      // Save cashbox count to database if provided
      if (cashboxData !== null) {
        console.log('💾 Saving cashbox count to database...');
        await saveCashboxCountFromTipPool(cashboxData);
      } else {
        console.log('⚠️ No cashbox count provided - reconciliation will be skipped');
      }

      // Fetch cash count data for the date range (reusing existing logic)
      const start = new Date(startDate + 'T12:00:00');
      const end = new Date(endDate + 'T12:00:00');

      if (start > end) {
        throw new Error('Start date must be before end date');
      }

      const diffTime = Math.abs(end - start);
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      
      if (diffDays > 7) {
        throw new Error('Date range cannot exceed 7 days');
      }

      // Copy exact working query from generateDateRangePDF
      const { data: rangeData } = await supabase
        .from('cash_counts')
        .select('*')
        .gte('date', startDate)
        .lte('date', endDate)
        .not('pm_total', 'is', null)
        .order('date', { ascending: true });

      if (!rangeData || rangeData.length === 0) {
        throw new Error('No cash count data found for this date range');
      }

      // Store cash data for potential re-generation
      window.lastCombinedCashData = rangeData;
      
      // Save combined report data for persistence
      saveCombinedReportData();

      // Generate the HTML content first
      const cashReportHtml = generateDateRangeReportHtml(startDate, endDate, rangeData, realEnvelopeAmount);
      
      // Get tip pool HTML and clean ONLY for saving (don't modify the original DOM)
      let tipPoolHtml = document.getElementById('tipPoolResults').innerHTML;
      
      // Create a clean copy for saving without affecting the live DOM
      let cleanTipPoolHtml = tipPoolHtml;
      cleanTipPoolHtml = cleanTipPoolHtml.replace(/<div[^>]*id="combinedReportSection"[^>]*>.*?<\/div>/gs, '');
      cleanTipPoolHtml = cleanTipPoolHtml.replace(/Weekly Combined Report[\s\S]*?Generate Combined Weekly Report/g, '');
      cleanTipPoolHtml = cleanTipPoolHtml.replace(/Download PDF Back to Menu/g, '');
      
      // SAVE TIP VARIANCE TO DATABASE (for compliance tracking)
      if (tipPoolRecords && tipPoolRecords.length > 0) {
        try {
          // Recalculate variance based on FINAL tip distribution (after any equity adjustments)
          const totalPaidOut = tipPoolRecords.reduce((sum, rec) => sum + rec.due, 0);
          const currentVariance = tipPoolSummary.pool - totalPaidOut;

          console.log(`💾 Saving final variance record for week ${startDate} to ${endDate}:`);
          console.log(`   Pool Total: $${tipPoolSummary.pool.toFixed(2)}`);
          console.log(`   Paid Out: $${totalPaidOut.toFixed(2)}`);
          console.log(`   Variance to carry forward: $${currentVariance.toFixed(2)}`);
          console.log(`   Previous variance included: $${(tipPoolSummary.previousVariance || 0).toFixed(2)}`);

          const varianceRecord = {
            week_ending_date: endDate,
            calculated_total: tipPoolSummary.pool,
            actual_paid_total: totalPaidOut,
            variance_amount: currentVariance,
            previous_variance: tipPoolSummary.previousVariance || 0,
            carried_from_date: tipPoolSummary.carriedFromDate || null
          };

          const { data: savedVariance, error: saveError } = await supabase
            .from('tip_variance')
            .upsert(varianceRecord, { onConflict: 'week_ending_date' })
            .select()
            .single();

          if (saveError) {
            console.error('❌ Error saving variance record:', saveError);
          } else {
            console.log(`✅ Variance record saved successfully!`);
            console.log(`   Record ID: ${savedVariance.id}`);
            console.log(`   Week ending: ${savedVariance.week_ending_date}`);
            console.log(`   Variance amount: $${savedVariance.variance_amount.toFixed(2)}`);
            console.log(`   This variance will be added to next week's tip pool (week after ${endDate})`);
          }
        } catch (varianceErr) {
          console.error('❌ Exception saving variance:', varianceErr);
        }
      }

      // SAVE ALL DATA TO DATABASE BEFORE PDF GENERATION
      console.log('Saving comprehensive weekly report data to database...');
      try {
        const savedReportId = await saveWeeklyCombinedReportData(startDate, endDate, rangeData, realEnvelopeAmount, cashboxTotal, cashReportHtml, cleanTipPoolHtml);
        console.log(`Weekly report data saved successfully with ID: ${savedReportId}`);
      } catch (saveError) {
        console.error('Warning: Failed to save report data to database:', saveError);
        // Don't stop PDF generation if database save fails
      }

      // Check for uploaded PDF attachments
      const voidsLogFile = document.getElementById('voidsLogUpload').files[0];
      const extrasFile = document.getElementById('extrasUpload').files[0];
      
      // Generate main PDF report
      const mainPdfData = await generateCombinedReportPDF(startDate, endDate, rangeData, realEnvelopeAmount, cashboxTotal);
      
      // If attachments exist, merge them; otherwise save main PDF directly
      if (voidsLogFile || extrasFile) {
        await mergePDFsWithAttachments(mainPdfData, voidsLogFile, extrasFile);
        
        let attachmentInfo = '';
        if (voidsLogFile && extrasFile) {
          attachmentInfo = ' (with Voids Log and Extras attached)';
        } else if (voidsLogFile) {
          attachmentInfo = ' (with Voids Log attached)';
        } else if (extrasFile) {
          attachmentInfo = ' (with Extras attached)';
        }
        
        showSuccessMessage(`Combined weekly report generated successfully${attachmentInfo}! You can modify data and generate again.`);
      } else {
        // No attachments, save main PDF directly
        mainPdfData.doc.save(mainPdfData.filename);
        showSuccessMessage('Combined weekly report generated successfully! You can modify data and generate again.');
      }
      
      hideLoading();
      
      // Return to tip pool section for easy re-editing
      showTipPool();
      
      // Return to tip pool section for easy re-editing
      showTipPool();
      
    } catch (error) {
      hideLoading();
      showErrorMessage('Error generating combined report: ' + error.message);
      console.error('Combined report generation error:', error);
    }
  }

  function generateCombinedReportHtml(startDate, endDate, cashData, realEnvelopeAmount = null) {
    // Calculate cash report totals using EXACT same logic as generateDateRangePDF
    let totalToastSalesReported = 0;
    let totalActualCashIn = 0;
    let totalDiscrepancy = 0;
    let totalEnvelopeDeposits = 0;
    let totalBackToCashbox = 0;

    cashData.forEach(day => {
      totalToastSalesReported += day.pm_toast_sales || 0;
      totalActualCashIn += (day.pm_total - day.am_total) || 0;  // Fixed: PM minus AM, not PM + AM
      totalDiscrepancy += day.pm_discrepancy || 0;              // Fixed: Use stored discrepancy
      totalEnvelopeDeposits += day.pm_deposit_amount || 0;      // Fixed: Use correct column name
      totalBackToCashbox += (day.pm_amount_to_keep - day.am_total) || 0;
    });

    const { cashNeeded } = tipPoolSummary;
    
    // COPY EXACT LOGIC FROM ORIGINAL TIP POOL CALCULATOR LINE 565 (CORRECT LOGIC)
    let cashStatusText = '';
    let cashStatusClass = '';
    if (cashNeeded > 0) {
      // Need additional cash - show positive amount in red
      cashStatusText = 'NEEDED';
      cashStatusClass = 'color: #dc3545';
    } else {
      // Have surplus - show positive amount in green
      cashStatusText = 'SURPLUS';
      cashStatusClass = 'color: #28a745';
    }

    return `
      <div style="font-family: Arial, sans-serif; padding: 20px; background: white;">
        <!-- Header matching tip pool calculator style -->
        <div style="text-align: center; margin-bottom: 30px; border-bottom: 3px solid #1e3c72; padding-bottom: 20px;">
          <h1 style="margin: 0; color: #1e3c72; font-size: 24px;">JAYNA GYRO COMBINED WEEKLY REPORT</h1>
          <h2 style="margin: 10px 0 0 0; color: #666; font-size: 16px; font-weight: normal;">CASH COUNT & TIP POOL DISTRIBUTION</h2>
          <h3 style="margin: 10px 0 0 0; color: #666; font-size: 14px; font-weight: normal;">PERIOD: ${startDate.toUpperCase()} TO ${endDate.toUpperCase()} | GENERATED: ${new Date().toLocaleString().toUpperCase()}</h3>
        </div>

        <!-- Cash Count Summary Section -->
        <div style="margin-bottom: 30px;">
          <h3 style="color: #1e3c72; margin-bottom: 15px; border-bottom: 2px solid #1e3c72; padding-bottom: 5px;">
            CASH COUNT SUMMARY
          </h3>
          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px;">
            <div style="background: #f8f9fa; padding: 15px; border: 2px solid #007bff; border-radius: 0; text-align: center;">
              <h4 style="margin: 0 0 8px 0; color: #007bff; font-size: 12px;">TOTAL TOAST SALES</h4>
              <p style="font-size: 18px; font-weight: bold; margin: 0; color: #007bff;">$${totalToastSalesReported.toFixed(2)}</p>
            </div>
            <div style="background: #f8f9fa; padding: 15px; border: 2px solid #28a745; border-radius: 0; text-align: center;">
              <h4 style="margin: 0 0 8px 0; color: #28a745; font-size: 12px;">ACTUAL CASH IN</h4>
              <p style="font-size: 18px; font-weight: bold; margin: 0; color: #28a745;">$${totalActualCashIn.toFixed(2)}</p>
            </div>
            <div style="background: #f8f9fa; padding: 15px; border: 2px solid #dc3545; border-radius: 0; text-align: center;">
              <h4 style="margin: 0 0 8px 0; color: #dc3545; font-size: 12px;">TOTAL DISCREPANCY</h4>
              <p style="font-size: 18px; font-weight: bold; margin: 0; color: #dc3545;">$${totalDiscrepancy.toFixed(2)}</p>
            </div>
          </div>
          <div style="display: grid; grid-template-columns: repeat(${realEnvelopeAmount !== null ? '3' : '2'}, 1fr); gap: 15px;">
            <div style="background: #f8f9fa; padding: 15px; border: 2px solid #6c757d; border-radius: 0; text-align: center;">
              <h4 style="margin: 0 0 8px 0; color: #6c757d; font-size: 12px;">ENVELOPE DEPOSITS</h4>
              <p style="font-size: 18px; font-weight: bold; margin: 0; color: #6c757d;">$${totalEnvelopeDeposits.toFixed(2)}</p>
            </div>
            <div style="background: #f8f9fa; padding: 15px; border: 2px solid #f57c00; border-radius: 0; text-align: center;">
              <h4 style="margin: 0 0 8px 0; color: #f57c00; font-size: 12px;">EXCESS BACK TO CASH BOX</h4>
              <p style="font-size: 18px; font-weight: bold; margin: 0; color: #f57c00;">$${totalBackToCashbox.toFixed(2)}</p>
            </div>
            ${realEnvelopeAmount !== null ? `
            <div style="background: #f8f9fa; padding: 15px; border: 2px solid #9c27b0; border-radius: 0; text-align: center;">
              <h4 style="margin: 0 0 8px 0; color: #9c27b0; font-size: 12px;">REAL ENVELOPE AMOUNT</h4>
              <p style="font-size: 18px; font-weight: bold; margin: 0; color: #9c27b0;">$${realEnvelopeAmount.toFixed(2)}</p>
            </div>
            ` : ''}
          </div>
        </div>

        <!-- Tip Pool Summary Section -->
        <div style="margin-bottom: 30px;">
          <h3 style="color: #1e3c72; margin-bottom: 15px; border-bottom: 2px solid #1e3c72; padding-bottom: 5px;">
            TIP POOL SUMMARY
          </h3>
          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px;">
            <div style="background: #f8f9fa; padding: 15px; border: 2px solid #007bff; border-radius: 0; text-align: center;">
              <h4 style="margin: 0 0 8px 0; color: #007bff; font-size: 12px;">CREDIT TIPS</h4>
              <p style="font-size: 18px; font-weight: bold; margin: 0; color: #007bff;">$${tipPoolSummary.creditTips.toFixed(2)}</p>
            </div>
            <div style="background: #f8f9fa; padding: 15px; border: 2px solid #28a745; border-radius: 0; text-align: center;">
              <h4 style="margin: 0 0 8px 0; color: #28a745; font-size: 12px;">CASH TIPS</h4>
              <p style="font-size: 18px; font-weight: bold; margin: 0; color: #28a745;">$${tipPoolSummary.cashTips.toFixed(2)}</p>
            </div>
            <div style="background: #f8f9fa; padding: 15px; border: 2px solid #f57c00; border-radius: 0; text-align: center;">
              <h4 style="margin: 0 0 8px 0; color: #f57c00; font-size: 12px;">EZCATER TIPS</h4>
              <p style="font-size: 18px; font-weight: bold; margin: 0; color: #f57c00;">$${tipPoolSummary.ezcaterTips.toFixed(2)}</p>
            </div>
          </div>
          <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px;">
            <div style="background: #f8f9fa; padding: 15px; border: 2px solid #e91e63; border-radius: 0; text-align: center;">
              <h4 style="margin: 0 0 8px 0; color: #e91e63; font-size: 12px;">TDS DRIVER</h4>
              <p style="font-size: 18px; font-weight: bold; margin: 0; color: #e91e63;">$${tipPoolSummary.tdsDriverTips.toFixed(2)}</p>
            </div>
            <div style="background: #f8f9fa; padding: 15px; border: 2px solid #17a2b8; border-radius: 0; text-align: center;">
              <h4 style="margin: 0 0 8px 0; color: #17a2b8; font-size: 12px;">CASH SALES</h4>
              <p style="font-size: 18px; font-weight: bold; margin: 0; color: #17a2b8;">$${tipPoolSummary.toastCashSales.toFixed(2)}</p>
            </div>
            <div style="background: #f8f9fa; padding: 15px; border: 2px solid #1e3c72; border-radius: 0; text-align: center;">
              <h4 style="margin: 0 0 8px 0; color: #1e3c72; font-size: 12px;">TOTAL POOL</h4>
              <p style="font-size: 20px; font-weight: bold; margin: 0; color: #1e3c72;">$${tipPoolSummary.pool.toFixed(2)}</p>
            </div>
            <div style="background: #f8f9fa; padding: 15px; border: 2px solid #6c757d; border-radius: 0; text-align: center;">
              <h4 style="margin: 0 0 8px 0; color: #6c757d; font-size: 12px;">HOURLY RATE</h4>
              <p style="font-size: 18px; font-weight: bold; margin: 0; color: #6c757d;">$${tipPoolSummary.hourlyRate.toFixed(2)}</p>
            </div>
          </div>
        </div>

        <!-- Cash Status Line (prominent display matching tip pool calculator) -->
        <div style="text-align: center; margin-bottom: 30px; background: #f8f9fa; padding: 15px; border: 2px solid ${cashNeeded > 0 ? '#dc3545' : '#28a745'}; border-radius: 0;">
          <h4 style="margin: 0 0 8px 0; ${cashStatusClass}; font-size: 14px; font-weight: bold;">
            ${cashNeeded > 0 ? 'CASH NEEDED TO PAY OUT TIPS' : 'ZERO CASH NEEDED TO PAY OUT TIPS THIS WEEK. EXCESS CASH ON HAND'}
          </h4>
          <p style="font-size: 24px; font-weight: bold; margin: 0; ${cashStatusClass};">$${Math.abs(cashNeeded).toFixed(2)}</p>
        </div>

        <!-- Employee Distribution Table -->
        <div style="margin-bottom: 30px;">
          <h3 style="color: #1e3c72; margin-bottom: 15px; border-bottom: 2px solid #1e3c72; padding-bottom: 5px;">
            EMPLOYEE TIP DISTRIBUTION
          </h3>
          <table style="width: 100%; border-collapse: collapse; border: 2px solid #000;">
            <thead>
              <tr style="background: #1e3c72; color: white;">
                <th style="padding: 12px; text-align: left; border: 1px solid #000; font-size: 12px;">EMPLOYEE</th>
                <th style="padding: 12px; text-align: center; border: 1px solid #000; font-size: 12px;">HOURS</th>
                <th style="padding: 12px; text-align: center; border: 1px solid #000; font-size: 12px;">EQUITY (%)</th>
                <th style="padding: 12px; text-align: center; border: 1px solid #000; font-size: 12px;">WEIGHTED</th>
                <th style="padding: 12px; text-align: center; border: 1px solid #000; font-size: 12px;">DUE</th>
              </tr>
            </thead>
            <tbody>
              ${tipPoolRecords.map((record, index) => {
                const rowBg = index % 2 === 0 ? '#f8f9fa' : 'white';
                return `
                  <tr style="background: ${rowBg};">
                    <td style="padding: 10px; border: 1px solid #000; font-weight: bold; font-size: 11px;">${record.first.toUpperCase()} ${record.last.toUpperCase()}</td>
                    <td style="padding: 10px; text-align: center; border: 1px solid #000; font-size: 11px;">${record.hours.toFixed(1)}</td>
                    <td style="padding: 10px; text-align: center; border: 1px solid #000; font-size: 11px;">${(record.equity * 100).toFixed(0)}</td>
                    <td style="padding: 10px; text-align: center; border: 1px solid #000; font-size: 11px;">${record.weighted.toFixed(1)}</td>
                    <td style="padding: 10px; text-align: center; border: 1px solid #000; font-weight: bold; font-size: 14px; color: #28a745;">$${record.due.toFixed(2)}</td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        </div>

        <!-- Daily Cash Breakdown -->
        <div style="border: 2px solid #000; margin: 30px 0; border-radius: 0; overflow: hidden;">
          <div style="background: #f0f0f0; padding: 10px; border-bottom: 2px solid #000;">
            <h4 style="margin: 0; text-align: center; font-size: 14px; color: #1e3c72;">DAILY CASH BREAKDOWN</h4>
          </div>
          
          <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
              <thead>
                <tr style="background: #f8f9fa;">
                  <th style="border: 1px solid #000; padding: 8px; text-align: left; font-weight: bold;">Date</th>
                  <th style="border: 1px solid #000; padding: 8px; text-align: center; font-weight: bold;">Counter</th>
                  <th style="border: 1px solid #000; padding: 8px; text-align: right; font-weight: bold;">Toast Sales</th>
                  <th style="border: 1px solid #000; padding: 8px; text-align: right; font-weight: bold;">Actual Cash In</th>
                  <th style="border: 1px solid #000; padding: 8px; text-align: right; font-weight: bold;">Discrepancy</th>
                  <th style="border: 1px solid #000; padding: 8px; text-align: right; font-weight: bold;">Envelope</th>
                  <th style="border: 1px solid #000; padding: 8px; text-align: right; font-weight: bold;">Cashbox</th>
                </tr>
              </thead>
              <tbody>
                ${cashData.map(day => {
                  const actualCashIn = day.pm_total - day.am_total;
                  const discrepancySign = day.pm_discrepancy >= 0 ? '+' : '';
                  return `
                    <tr>
                      <td style="border: 1px solid #000; padding: 6px; font-weight: bold;">
                        ${new Date(day.date + 'T12:00:00').toLocaleDateString()}
                      </td>
                      <td style="border: 1px solid #000; padding: 6px; text-align: center;">
                        ${day.pm_counter || 'N/A'}
                      </td>
                      <td style="border: 1px solid #000; padding: 6px; text-align: right;">
                        $${(day.pm_toast_sales || 0).toFixed(2)}
                      </td>
                      <td style="border: 1px solid #000; padding: 6px; text-align: right;">
                        $${actualCashIn.toFixed(2)}
                      </td>
                      <td style="border: 1px solid #000; padding: 6px; text-align: right; color: ${day.pm_discrepancy >= 0 ? '#28a745' : '#dc3545'};">
                        ${discrepancySign}$${Math.abs(day.pm_discrepancy || 0).toFixed(2)}
                      </td>
                      <td style="border: 1px solid #000; padding: 6px; text-align: right;">
                        $${day.pm_deposit_amount || 0}
                      </td>
                      <td style="border: 1px solid #000; padding: 6px; text-align: right;">
                        $${(day.pm_amount_to_keep || 0).toFixed(2)}
                      </td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          </div>
        </div>

        <!-- Footer -->
        <div style="text-align: center; margin-top: 30px; padding: 15px; border-top: 2px solid #1e3c72; font-size: 10px; background: #f8f9fa;">
          <div style="margin-bottom: 5px; font-weight: bold; color: #1e3c72;">Cash counts verified and tips calculated by: ${tipPoolSummary.ranBy || 'SYSTEM'}</div>
          <div style="margin-bottom: 5px; color: #666;">Generated: ${new Date().toLocaleString()}</div>
          <div style="color: #1e3c72; font-weight: bold;">Jayna Gyro Combined Weekly Report System v2.86</div>
        </div>
      </div>
    `;
  }

  // ====================================
  // ORDERING SYSTEM - START
  // ====================================

  /**
   * @typedef {Object} InventoryItem
   * @property {number} id - Database ID
   * @property {string} itemName - Full name with packaging
   * @property {string} vendor - Vendor name
   * @property {number} parLevel - Target stock level
   * @property {number} currentStock - Current on-hand quantity
   * @property {string} unit - Unit of measurement (CS, EA, LB, etc.)
   * @property {string} [lastCountedDate] - Last stock count date
   */

  /**
   * @typedef {Object} CalculatedOrder
   * @property {string} vendor - Vendor name
   * @property {Date} orderDate - When to place order
   * @property {string} cutoffTime - Order deadline
   * @property {Date} deliveryDate - Expected delivery
   * @property {OrderItem[]} items - Items to order
   * @property {string} [notes] - Special instructions
   */

  /**
   * @typedef {Object} OrderItem
   * @property {string} itemName - Item name
   * @property {number} quantity - Quantity to order
   * @property {string} unit - Unit of measurement
   * @property {number} parLevel - Par level for reference
   * @property {number} currentStock - Current stock for reference
   */

  /**
   * Global state for ordering system
   */
  const orderingSystemState = {
    items: [],
    calculatedOrders: [],
    currentTab: 'upcomingOrders',
    lastUpdated: null,
    pendingStockUpdates: new Map(), // Track unsaved stock updates
    currentCountSession: 'morning_prep', // Track current prep count session
    previousCounts: new Map(), // Track previous counts for consumption calculation (itemId -> {count, session})
    prepRecommendations: [], // Store current prep recommendations for print/PDF
    // Invoice system state
    currentInvoiceImage: null,
    extractedInvoiceItems: [],
    invoiceType: 'invoice', // 'invoice' or 'order'
    selectedPendingOrderId: null, // For reconciliation against pending order
    // Price history drill-down state
    priceHistory: {
      selectedItemIds: new Set(),
      results: [],
      lastFetchParams: null,
      cache: new Map(),
      initialized: false
    }
  };

  /**
   * Print Ordering Guide PDF for vendors (sends to printer via email)
   */
  async function downloadOrderingGuide(vendor) {
    try {
      // Ensure inventory data is loaded
      if (!orderingSystemState.items || orderingSystemState.items.length === 0) {
        showMessage('Loading inventory data...', 'info');
        await loadInventoryData();
      }

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'letter' });

      const vendorNames = {
        'greenleaf': 'Greenleaf',
        'performance': 'Performance',
        'mani': 'Mani'
      };

      const vendorName = vendorNames[vendor] || vendor;
      const today = new Date().toLocaleDateString('en-US', {
        month: 'long',
        day: 'numeric',
        year: 'numeric'
      });

      // Header
      doc.setFontSize(18);
      doc.setFont('helvetica', 'bold');
      doc.text(`${vendorName} Ordering Guide`, 40, 40);

      doc.setFontSize(10);
      doc.setFont('helvetica', 'normal');
      doc.text(`Date: ${today}`, 40, 60);
      doc.text('Jayna Gyro - Internal Use Only', 40, 75);

      // Table with ordering columns
      const tableData = [];
      for (let i = 0; i < 35; i++) {
        tableData.push(['', '', '', '']); // Empty rows for manual filling
      }

      doc.autoTable({
        head: [['QTY NEEDED', 'QTY ON HAND', 'ITEM NAME', 'ITEM #']],
        body: tableData,
        startY: 95,
        theme: 'grid',
        styles: {
          fontSize: 10,
          cellPadding: 8,
          lineColor: [200, 200, 200],
          lineWidth: 0.5
        },
        headStyles: {
          fillColor: [74, 74, 74],
          textColor: 255,
          fontStyle: 'bold',
          halign: 'center'
        },
        columnStyles: {
          0: { cellWidth: 80, halign: 'center' },  // QTY NEEDED
          1: { cellWidth: 80, halign: 'center' },  // QTY ON HAND
          2: { cellWidth: 280 },                   // ITEM NAME
          3: { cellWidth: 80, halign: 'center' }   // ITEM #
        },
        margin: { left: 40, right: 40 }
      });

      // PAGE 2: Complete Inventory Reference List
      doc.addPage();

      doc.setFontSize(14);
      doc.setFont('helvetica', 'bold');
      doc.text(`${vendorName} - Complete Inventory Reference`, 40, 40);

      doc.setFontSize(8);
      doc.setFont('helvetica', 'normal');
      doc.text('Quick reference list of all items in inventory', 40, 55);

      // Filter inventory items by vendor
      const vendorItems = orderingSystemState.items.filter(item => {
        const itemVendor = (item.vendor || '').toLowerCase();
        const targetVendor = vendor.toLowerCase();
        return itemVendor === targetVendor || itemVendor.includes(targetVendor);
      });

      // Sort by item name
      vendorItems.sort((a, b) => (a.itemName || '').localeCompare(b.itemName || ''));

      // Prepare table data with very compact info
      const inventoryTableData = vendorItems.map(item => {
        const lastCounted = item.lastCountedDate
          ? new Date(item.lastCountedDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: '2-digit' })
          : 'Never';

        return [
          item.itemName || 'N/A',
          `${item.currentStock || 0} ${item.unit || ''}`,
          item.parLevel || 0,
          lastCounted
        ];
      });

      // If no items found, show message
      if (inventoryTableData.length === 0) {
        doc.setFontSize(10);
        doc.text(`No inventory items found for ${vendorName}`, 40, 80);
      } else {
        doc.autoTable({
          head: [['ITEM NAME', 'CURRENT STOCK', 'PAR', 'LAST COUNT']],
          body: inventoryTableData,
          startY: 70,
          theme: 'grid',
          styles: {
            fontSize: 7,
            cellPadding: 3,
            lineColor: [200, 200, 200],
            lineWidth: 0.3
          },
          headStyles: {
            fillColor: [100, 100, 100],
            textColor: 255,
            fontStyle: 'bold',
            fontSize: 7,
            halign: 'center'
          },
          columnStyles: {
            0: { cellWidth: 280 },                    // ITEM NAME
            1: { cellWidth: 90, halign: 'center' },   // CURRENT STOCK
            2: { cellWidth: 50, halign: 'center' },   // PAR
            3: { cellWidth: 80, halign: 'center' }    // LAST COUNT
          },
          margin: { left: 40, right: 40, bottom: 40 }
        });

        // Add item count at bottom of page 2
        const finalY = doc.lastAutoTable.finalY || 500;
        doc.setFontSize(8);
        doc.setFont('helvetica', 'italic');
        doc.text(
          `Total: ${inventoryTableData.length} items in inventory`,
          40,
          finalY + 15
        );
      }

      // Footer for all pages
      const pageCount = doc.internal.getNumberOfPages();
      for (let i = 1; i <= pageCount; i++) {
        doc.setPage(i);
        doc.setFontSize(8);
        doc.setFont('helvetica', 'normal');
        doc.text(
          `Page ${i} of ${pageCount}`,
          doc.internal.pageSize.width / 2,
          doc.internal.pageSize.height - 20,
          { align: 'center' }
        );
      }

      // Convert PDF to base64 for email attachment
      const pdfBase64 = doc.output('datauristring').split(',')[1];
      const filename = `${vendorName}_Ordering_Guide_${new Date().toISOString().split('T')[0]}.pdf`;

      // Show loading message
      showMessage('Sending to printer...', 'info');

      // Send to printer via backend API (nodemailer + Gmail)
      const response = await fetch('/api/send-ordering-guide-email', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          pdfBase64: pdfBase64,
          filename: filename
        })
      });

      const result = await response.json();

      if (!response.ok) {
        throw new Error(result.error || 'Failed to send to printer');
      }

      showMessage(`✅ ${vendorName} ordering guide sent to printer!`, 'success');
      console.log(`✓ Sent ${vendorName} ordering guide to printer`);

    } catch (error) {
      console.error('Error sending ordering guide to printer:', error);
      showMessage(`Error sending to printer: ${error.message}`, 'error');
    }
  }

  /**
   * Start the ordering system
   */
  async function startOrderingSystem() {
    // Keep main menu visible at top
    hideAllSections();
    document.getElementById('orderingSystemForm').classList.add('active');

    // Load data AFTER form is visible (same pattern as startPMCount)
    try {
      await loadInventoryData();
      calculateUpcomingOrders();
      await refreshUpcomingOrdersUI();
      await refreshUpcomingOrdersUI();
      renderInventoryList();
      renderStockCountList();
      renderPrepCountList(); // Render PREP items in PREP tab
      await updateCountSessionDisplay(); // Auto-detect and display current count session
    } catch (error) {
      console.error('Error loading ordering system data:', error);
      showMessage(`Error: ${error.message}`, 'error');
    }
  }

  /**
   * Switch between tabs
   */
  function openOrderTab(event, tabName) {
    console.log('openOrderTab:', tabName);

    // Hide all tab contents
    const tabContents = document.querySelectorAll('.tab-content');
    tabContents.forEach(content => content.style.display = 'none');

    // Remove active class from all tab links
    const tabLinks = document.querySelectorAll('.tab-link');
    tabLinks.forEach(link => {
      link.style.background = 'var(--gray-100)';
      link.style.color = 'var(--gray-700)';
    });

    // Show selected tab and mark button as active
    document.getElementById(tabName).style.display = 'block';
    if (event && event.target) {
      event.target.style.background = 'var(--gray-700)';
      event.target.style.color = 'white';
    }

    orderingSystemState.currentTab = tabName;

    // Auto-refresh prep sheet and count session when tab is opened
    if (tabName === 'prepSheet') {
      checkAutoPrintStatus(); // Check if prep list was auto-printed at 4am
      refreshPrepSheet();
      updateCountSessionDisplay(); // Update session info each time PREP tab is opened
    }

    // Load both pending orders AND AI suggestions when ORDERS tab is opened
    if (tabName === 'upcomingOrders') {
      renderOrdersTab();
    }

    if (tabName === 'priceHistory') {
      if (!orderingSystemState.priceHistory.initialized) {
        initializePriceHistoryTab();
      } else {
        refreshPriceHistoryControls();
      }
    }

    // Load orders due today alert when CHECK-IN tab is opened
  if (tabName === 'checkInInvoice') {
    loadOrdersDueTodayAlert();
    renderReceivePendingOrders();
  }
  }

  /**
   * Render complete ORDERS tab (pending orders + AI suggestions)
   */
async function renderOrdersTab() {
  const container = document.getElementById('upcomingOrders');
  container.innerHTML = '<div style="text-align: center; padding: 40px;"><p style="color: var(--gray-500);">Loading...</p></div>';

    // Create wrapper for both sections
    const wrapper = document.createElement('div');

    // Section 1: Pending Orders
    const pendingSection = document.createElement('div');
    pendingSection.id = 'pendingOrdersSection';
    wrapper.appendChild(pendingSection);

    // Section 2: AI Suggestions
    const aiSection = document.createElement('div');
    aiSection.id = 'aiSuggestionsSection';
    aiSection.style.cssText = 'margin-top: 40px;';
    wrapper.appendChild(aiSection);

    // Replace container content
    container.innerHTML = '';
    container.appendChild(wrapper);

    // Load both sections
    await renderPendingOrders(pendingSection);
    calculateUpcomingOrders();
    await refreshUpcomingOrdersUI(aiSection); // Ensure price snapshots before rendering suggestions
  }

  /**
   * Render pending orders section
   */
  async function renderPendingOrders(targetContainer) {
    const container = targetContainer || document.getElementById('pendingOrdersSection');
    console.log('Rendering pending orders...');

    // Show loading state (only if no target container provided)
    container.innerHTML = '<div style="text-align: center; padding: 40px;"><p style="color: var(--gray-500);">Loading pending orders...</p></div>';

    try {
      // Fetch all pending orders
      const { data: orders, error } = await supabase
        .from('pending_orders')
        .select(`
          *,
          pending_order_items (
            id,
            inventory_item_id,
            quantity_ordered,
            unit,
            item_name,
            quantity_received,
            variance
          )
        `)
        .in('status', ['pending', 'partial'])
        .order('expected_delivery_date', { ascending: true });

      if (error) throw error;

      console.log('Loaded pending orders:', orders?.length || 0);

      const priceItemIds = [];
      (orders || []).forEach(order => {
        (order.pending_order_items || []).forEach(item => {
          if (item && item.inventory_item_id != null) {
            priceItemIds.push(item.inventory_item_id);
          }
        });
      });
      if (priceItemIds.length) {
        await ensurePriceSnapshotsForItems(priceItemIds);
      }

      // Clear container
      container.innerHTML = '';

      // Add section header
      const header = document.createElement('div');
      header.style.cssText = 'margin-bottom: 20px; padding-bottom: 12px; border-bottom: 3px solid var(--gray-300);';

      const title = document.createElement('h3');
      title.textContent = 'PENDING ORDERS';
      title.style.cssText = 'color: var(--gray-900); margin: 0; font-size: 18px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;';
      header.appendChild(title);

      const subtitle = document.createElement('p');
      subtitle.textContent = 'Orders you\'ve created that are awaiting delivery';
      subtitle.style.cssText = 'color: var(--gray-600); font-size: 12px; margin: 8px 0 0 0;';
      header.appendChild(subtitle);

      container.appendChild(header);

      // Add action buttons for PDF and Email
      const buttonsDiv = document.createElement('div');
      buttonsDiv.style.cssText = 'display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap;';
      buttonsDiv.innerHTML = `
        <button class="submit-btn" onclick="generatePendingOrdersPDF()" style="background: #808080; color: white; flex: 1; min-width: 150px; padding: 12px; font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; border: none; cursor: pointer;">
          DOWNLOAD PDF
        </button>
        <button class="submit-btn" onclick="emailPendingOrdersToPrinter()" style="background: #808080; color: white; flex: 1; min-width: 150px; padding: 12px; font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; border: none; cursor: pointer;">
          EMAIL TO PRINTER
        </button>
      `;
      container.appendChild(buttonsDiv);

      // Group orders by delivery status
      const today = getPacificDate(); // Pacific Time, not UTC
      const ordersToday = orders?.filter(o => o.expected_delivery_date === today) || [];
      const ordersUpcoming = orders?.filter(o => o.expected_delivery_date > today) || [];
      const ordersPast = orders?.filter(o => o.expected_delivery_date < today) || [];

      // Alert for orders due today
      if (ordersToday.length > 0) {
        const alert = document.createElement('div');
        alert.style.cssText = 'background: #fef3c7; border: 2px solid #f59e0b; padding: 16px; margin-bottom: 24px;';

        const alertTitle = document.createElement('h4');
        alertTitle.textContent = `⚠️ ${ordersToday.length} ORDER(S) DUE TODAY`;
        alertTitle.style.cssText = 'color: #92400e; margin: 0 0 8px 0; font-size: 14px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;';
        alert.appendChild(alertTitle);

        const alertText = document.createElement('p');
        alertText.textContent = 'Check in these orders in the CHECK-IN tab when they arrive.';
        alertText.style.cssText = 'color: #78350f; margin: 0; font-size: 12px;';
        alert.appendChild(alertText);

        container.appendChild(alert);
      }

      // Alert for overdue orders
      if (ordersPast.length > 0) {
        const alert = document.createElement('div');
        alert.style.cssText = 'background: #fee2e2; border: 2px solid #ef4444; padding: 16px; margin-bottom: 24px;';

        const alertTitle = document.createElement('h4');
        alertTitle.textContent = `🚨 ${ordersPast.length} OVERDUE ORDER(S)`;
        alertTitle.style.cssText = 'color: #7f1d1d; margin: 0 0 8px 0; font-size: 14px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;';
        alert.appendChild(alertTitle);

        const alertText = document.createElement('p');
        alertText.textContent = 'These orders were expected but have not been checked in yet.';
        alertText.style.cssText = 'color: #991b1b; margin: 0; font-size: 12px;';
        alert.appendChild(alertText);

        container.appendChild(alert);
      }

      // Display all orders
      const allOrders = [...ordersPast, ...ordersToday, ...ordersUpcoming];

      if (allOrders.length === 0) {
        const emptyState = document.createElement('div');
        emptyState.style.cssText = 'text-align: center; padding: 60px 20px;';

        const emptyIcon = document.createElement('div');
        emptyIcon.textContent = '📦';
        emptyIcon.style.cssText = 'font-size: 48px; margin-bottom: 16px;';
        emptyState.appendChild(emptyIcon);

        const emptyText = document.createElement('p');
        emptyText.textContent = 'No pending orders';
        emptyText.style.cssText = 'color: var(--gray-500); font-size: 14px; margin: 0;';
        emptyState.appendChild(emptyText);

        const emptyHint = document.createElement('p');
        emptyHint.textContent = 'Create an order in the CHECK-IN tab by selecting "ORDER" type';
        emptyHint.style.cssText = 'color: var(--gray-400); font-size: 12px; margin-top: 8px;';
        emptyState.appendChild(emptyHint);

        container.appendChild(emptyState);
        return;
      }

      // Render each order
      allOrders.forEach(order => {
        const card = document.createElement('div');
        card.style.cssText = 'background: white; border: 2px solid var(--gray-300); padding: 16px; margin-bottom: 16px;';

        // Header row
        const header = document.createElement('div');
        header.style.cssText = 'display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;';

        const leftSide = document.createElement('div');

        const vendor = document.createElement('h4');
        vendor.textContent = order.vendor;
        vendor.style.cssText = 'color: var(--gray-900); margin: 0 0 4px 0; font-size: 16px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;';
        leftSide.appendChild(vendor);

        const orderDateElement = document.createElement('div');
        const orderDatePacific = parsePacificDate(order.order_date);
        orderDateElement.textContent = `Ordered: ${
          orderDatePacific
            ? formatPacificDateDisplay(orderDatePacific, { month: 'short', day: 'numeric', year: 'numeric' })
            : 'Unknown'
        }`;
        orderDateElement.style.cssText = 'color: var(--gray-600); font-size: 11px;';
        leftSide.appendChild(orderDateElement);

        header.appendChild(leftSide);

        const rightSide = document.createElement('div');
        rightSide.style.textAlign = 'right';

        const deliveryDate = document.createElement('div');
        const expectedDatePacific = parsePacificDate(order.expected_delivery_date);
        const todayPacific = parsePacificDate(today);
        const dayDifference = (expectedDatePacific && todayPacific)
          ? Math.round((expectedDatePacific.getTime() - todayPacific.getTime()) / 86400000)
          : null;

        let dateText = 'Expected: ';
        dateText += expectedDatePacific
          ? formatPacificDateDisplay(expectedDatePacific, { month: 'short', day: 'numeric', year: 'numeric' })
          : 'Unknown';

        if (dayDifference === 0) dateText += ' (TODAY)';
        else if (dayDifference === 1) dateText += ' (Tomorrow)';
        else if (typeof dayDifference === 'number') {
          if (dayDifference < 0) {
            const overdueDays = Math.abs(dayDifference);
            dateText += ` (${overdueDays} day${overdueDays === 1 ? '' : 's'} overdue)`;
          } else if (dayDifference <= 7) {
            dateText += ` (in ${dayDifference} days)`;
          }
        }

        const deliveryStyle = dayDifference === 0
          ? 'color: #f59e0b; font-size: 11px; font-weight: 700;'
          : (typeof dayDifference === 'number' && dayDifference < 0
            ? 'color: #ef4444; font-size: 11px; font-weight: 700;'
            : 'color: var(--gray-600); font-size: 11px;');

        deliveryDate.textContent = dateText;
        deliveryDate.style.cssText = deliveryStyle;
        rightSide.appendChild(deliveryDate);

        const itemCount = document.createElement('div');
        itemCount.textContent = `${order.total_items} item(s)`;
        itemCount.style.cssText = 'color: var(--gray-500); font-size: 10px; margin-top: 4px;';
        rightSide.appendChild(itemCount);

        header.appendChild(rightSide);
        card.appendChild(header);

        // Items list (collapsible)
        if (order.pending_order_items && order.pending_order_items.length > 0) {
          const itemsList = document.createElement('div');
          itemsList.style.cssText = 'border-top: 1px solid var(--gray-200); padding-top: 12px; margin-top: 8px;';

          order.pending_order_items.forEach(item => {
            const itemRow = document.createElement('div');
            itemRow.style.cssText = 'padding: 6px 0; font-size: 12px; border-bottom: 1px dashed var(--gray-200);';

            const topRow = document.createElement('div');
            topRow.style.cssText = 'display: flex; justify-content: space-between; align-items: center; gap: 12px;';

            const itemName = document.createElement('span');
            itemName.textContent = item.item_name;
            itemName.style.cssText = 'color: var(--gray-700); font-weight: 600;';
            topRow.appendChild(itemName);

            const itemQty = document.createElement('span');
            itemQty.textContent = `${item.quantity_ordered} ${item.unit}`;
            itemQty.style.cssText = 'color: var(--gray-500); font-weight: 700; font-size: 12px;';
            topRow.appendChild(itemQty);

            itemRow.appendChild(topRow);

            if (item.inventory_item_id != null) {
              const localItem = orderingSystemState.items.find(i => i.id === item.inventory_item_id);
              const priceInfo = getPriceInfoForInventoryId(
                item.inventory_item_id,
                localItem?.currentUnitCost,
                localItem?.lastCostUpdate
              );

              const priceDiv = document.createElement('div');
              priceDiv.style.cssText = 'margin-top: 4px; font-size: 11px;';
              priceDiv.innerHTML = renderPriceTrendHtml(priceInfo);
              itemRow.appendChild(priceDiv);
            }

            itemsList.appendChild(itemRow);
          });

          card.appendChild(itemsList);
        }

        // Notes if any
        if (order.notes) {
          const notes = document.createElement('div');
          notes.textContent = `Notes: ${order.notes}`;
          notes.style.cssText = 'color: var(--gray-500); font-size: 11px; margin-top: 12px; font-style: italic;';
          card.appendChild(notes);
        }

        container.appendChild(card);
      });

    } catch (error) {
      console.error('Error loading pending orders:', error);
      container.innerHTML = `<div style="text-align: center; padding: 40px;"><p style="color: #ef4444;">Error loading orders: ${error.message}</p></div>`;
    }
  }

  /**
   * Load and display orders due today alert on CHECK-IN tab
   */
  async function loadOrdersDueTodayAlert() {
    const container = document.getElementById('ordersDueTodayAlert');
    if (!container) return;

    // Clear previous alert
    container.innerHTML = '';

    try {
      // Fetch orders due today
      const today = getPacificDate(); // Pacific Time, not UTC
      const { data: orders, error } = await supabase
        .from('pending_orders')
        .select(`
          *,
          pending_order_items (
            id,
            inventory_item_id,
            quantity_ordered,
            unit,
            item_name
          )
        `)
        .eq('expected_delivery_date', today)
        .eq('status', 'pending');

      if (error) throw error;

      if (!orders || orders.length === 0) {
        // No orders due today - don't show anything
        return;
      }

      console.log(`Found ${orders.length} order(s) due today`);

      // Create alert box
      const alert = document.createElement('div');
      alert.style.cssText = 'background: #fef3c7; border: 2px solid #f59e0b; padding: 16px; margin-bottom: 24px;';

      const header = document.createElement('div');
      header.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;';

      const title = document.createElement('h4');
      title.textContent = `⚠️ ${orders.length} ORDER(S) DUE TODAY`;
      title.style.cssText = 'color: #92400e; margin: 0; font-size: 14px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;';
      header.appendChild(title);

      alert.appendChild(header);

      const description = document.createElement('p');
      description.textContent = 'Select the order below when checking in delivery:';
      description.style.cssText = 'color: #78350f; margin: 0 0 12px 0; font-size: 12px;';
      alert.appendChild(description);

      // List each order
      orders.forEach(order => {
        const orderCard = document.createElement('div');
        orderCard.style.cssText = 'background: white; border: 2px solid #f59e0b; padding: 12px; margin-top: 8px; cursor: pointer; transition: background 0.2s;';
        orderCard.onmouseover = () => orderCard.style.background = '#fffbeb';
        orderCard.onmouseout = () => orderCard.style.background = 'white';

        const vendorName = document.createElement('div');
        vendorName.textContent = order.vendor;
        vendorName.style.cssText = 'color: #92400e; font-size: 14px; font-weight: 700; margin-bottom: 4px;';
        orderCard.appendChild(vendorName);

        const itemCount = document.createElement('div');
        itemCount.textContent = `${order.total_items} item(s) ordered`;
        itemCount.style.cssText = 'color: #78350f; font-size: 11px;';
        orderCard.appendChild(itemCount);

        // Store order ID and show check-in interface
        orderCard.onclick = () => {
          // Highlight selected
          document.querySelectorAll('#ordersDueTodayAlert > div > div').forEach(card => {
            card.style.borderColor = '#f59e0b';
            card.style.background = 'white';
          });
          orderCard.style.borderColor = '#92400e';
          orderCard.style.background = '#fffbeb';

          // Show check-in interface for this order
          showPendingOrderForCheckIn(order.id);
        };

        alert.appendChild(orderCard);
      });

      container.appendChild(alert);

    } catch (error) {
      console.error('Error loading orders due today:', error);
    }
  }

  /**
   * ============================================
   * MANAGE PENDING ORDERS (PASSWORD PROTECTED)
   * ============================================
   */

  /**
   * Open Manage Orders tab with password protection
   */
  function openManageOrdersTab(event) {
    requirePasswordFor('Manage Pending Orders', async () => {
      // Password correct - proceed to open tab
      openOrderTab(event, 'manageOrders');

      // Load all pending orders
      await loadAllPendingOrders();
    });
  }

  /**
   * Load ALL pending orders (not just today's)
   */
  async function loadAllPendingOrders() {
    console.log('📥 Loading all pending orders...');

    const container = document.getElementById('managePendingOrdersList');
    if (!container) return;

    showLoading('Loading Orders', 'Fetching all pending orders...');

    try {
      const { data: orders, error } = await supabase
        .from('pending_orders')
        .select(`
          id,
          vendor,
          order_date,
          expected_delivery_date,
          status,
          total_items,
          notes,
          created_at,
          pending_order_items (
            id,
            inventory_item_id,
            quantity_ordered,
            unit,
            item_name,
            vendor,
            quantity_received,
            variance,
            unit_price,
            receiving_notes
          )
        `)
        .order('expected_delivery_date', { ascending: true });

      if (error) throw error;

      hideLoading();

      if (!orders || orders.length === 0) {
        container.innerHTML = `
          <div style="background: var(--gray-100); padding: 40px; text-align: center; border-radius: 0; border: 2px solid var(--gray-300);">
            <p style="color: var(--gray-600); font-size: 14px; margin: 0;">No pending orders found</p>
          </div>
        `;
        return;
      }

      renderManagePendingOrdersList(orders);

    } catch (error) {
      hideLoading();
      console.error('Error loading pending orders:', error);
      showMessage('Failed to load pending orders: ' + error.message, 'error');
    }
  }

  /**
   * Render all pending orders in a table
   */
  function renderManagePendingOrdersList(orders) {
    console.log('🎨 Rendering', orders.length, 'pending orders');

    const container = document.getElementById('managePendingOrdersList');
    if (!container) {
      console.error('❌ Container managePendingOrdersList not found!');
      return;
    }

    container.innerHTML = '';

    // Summary stats bar
    const summary = document.createElement('div');
    summary.style.cssText = 'background: white; border: 2px solid var(--gray-300); padding: 16px 20px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;';

    const totalOrders = orders.length;
    const todayPacific = getPacificMidday();
    const overdueCount = orders.filter(o => {
      const deliveryDatePacific = parsePacificDate(o.expected_delivery_date);
      return deliveryDatePacific && deliveryDatePacific < todayPacific;
    }).length;
    const todayCount = orders.filter(o => {
      const deliveryDatePacific = parsePacificDate(o.expected_delivery_date);
      return deliveryDatePacific && deliveryDatePacific.getTime() === todayPacific.getTime();
    }).length;

    summary.innerHTML = `
      <div style="display: flex; gap: 24px; align-items: center; flex-wrap: wrap;">
        <div>
          <div style="font-size: 24px; font-weight: 700; color: var(--gray-900); line-height: 1;">${totalOrders}</div>
          <div style="font-size: 11px; font-weight: 700; color: var(--gray-600); text-transform: uppercase; letter-spacing: 0.5px; margin-top: 4px;">Total Orders</div>
        </div>
        ${overdueCount > 0 ? `
        <div style="padding: 8px 12px; background: #fee2e2; border: 2px solid #dc2626;">
          <div style="font-size: 20px; font-weight: 700; color: #991b1b; line-height: 1;">${overdueCount}</div>
          <div style="font-size: 10px; font-weight: 700; color: #991b1b; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 4px;">Overdue</div>
        </div>
        ` : ''}
        ${todayCount > 0 ? `
        <div style="padding: 8px 12px; background: #fef3c7; border: 2px solid #f59e0b;">
          <div style="font-size: 20px; font-weight: 700; color: #92400e; line-height: 1;">${todayCount}</div>
          <div style="font-size: 10px; font-weight: 700; color: #92400e; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 4px;">Due Today</div>
        </div>
        ` : ''}
      </div>
    `;
    container.appendChild(summary);

    // Desktop Table (hidden on mobile)
    const tableContainer = document.createElement('div');
    tableContainer.style.cssText = 'display: block; overflow-x: auto; border: 2px solid #e5e7eb; background: white;';
    tableContainer.className = 'desktop-table';

    const tableHTML = `
      <table style="width: 100%; border-collapse: collapse; background: white;">
        <thead>
          <tr style="background: #1a1a1a; border-bottom: 2px solid #4a4a4a;">
            <th style="padding: 10px 12px; text-align: left; font-size: 11px; font-weight: 700; color: white; text-transform: uppercase; letter-spacing: 0.5px;">Vendor</th>
            <th style="padding: 10px 12px; text-align: left; font-size: 11px; font-weight: 700; color: white; text-transform: uppercase; letter-spacing: 0.5px;">Order Date</th>
            <th style="padding: 10px 12px; text-align: left; font-size: 11px; font-weight: 700; color: white; text-transform: uppercase; letter-spacing: 0.5px;">Delivery Date</th>
            <th style="padding: 10px 8px; text-align: center; font-size: 11px; font-weight: 700; color: white; text-transform: uppercase; letter-spacing: 0.5px; width: 60px;">Items</th>
            <th style="padding: 10px 8px; text-align: center; font-size: 11px; font-weight: 700; color: white; text-transform: uppercase; letter-spacing: 0.5px; width: 100px;">Actions</th>
          </tr>
        </thead>
        <tbody id="pendingOrdersTableBody">
        </tbody>
      </table>
    `;

    tableContainer.innerHTML = tableHTML;
    container.appendChild(tableContainer);

    const tbody = document.getElementById('pendingOrdersTableBody');

    console.log('📊 Creating table rows for orders...');

    orders.forEach((order, index) => {
      console.log(`Row ${index + 1}/${orders.length}: ${order.vendor} (ID: ${order.id})`);

      const row = document.createElement('tr');
      row.style.cssText = 'border-bottom: 1px solid #f3f4f6; transition: background 0.15s ease;';
      row.onmouseover = () => row.style.background = '#f9fafb';
      row.onmouseout = () => row.style.background = 'white';

      const orderDatePacific = parsePacificDate(order.order_date);
      const deliveryDatePacific = parsePacificDate(order.expected_delivery_date);
      const formattedOrderDate = orderDatePacific
        ? formatPacificDateDisplay(orderDatePacific, { month: 'short', day: 'numeric', year: 'numeric' })
        : 'Unknown';
      const formattedDeliveryDate = deliveryDatePacific
        ? formatPacificDateDisplay(deliveryDatePacific, { month: 'short', day: 'numeric', year: 'numeric' })
        : 'Unknown';

      // Determine if delivery date is in the past, today, or future (Pacific time)
      const todayPacific = getPacificMidday();

      let deliveryDateColor = 'var(--gray-900)';
      let deliveryDateBg = 'transparent';
      if (deliveryDatePacific && deliveryDatePacific < todayPacific) {
        deliveryDateColor = '#991b1b'; // Dark red text
        deliveryDateBg = '#fee2e2'; // Light red background
      } else if (deliveryDatePacific && deliveryDatePacific.getTime() === todayPacific.getTime()) {
        deliveryDateColor = '#92400e'; // Dark orange text
        deliveryDateBg = '#fef3c7'; // Light orange background
      } else if (deliveryDatePacific) {
        deliveryDateColor = '#065f46'; // Dark green text
        deliveryDateBg = '#d1fae5'; // Light green background
      }

      // Vendor
      const vendorCell = document.createElement('td');
      vendorCell.style.cssText = 'padding: 10px 12px; font-size: 13px; font-weight: 700; color: #1a1a1a;';
      vendorCell.textContent = order.vendor;
      row.appendChild(vendorCell);

      // Order Date
      const orderDateCell = document.createElement('td');
      orderDateCell.style.cssText = 'padding: 10px 12px; font-size: 12px; color: #6b6b6b;';
      orderDateCell.textContent = formattedOrderDate;
      row.appendChild(orderDateCell);

      // Delivery Date
      const deliveryCell = document.createElement('td');
      deliveryCell.style.cssText = 'padding: 10px 12px;';
      const deliveryBadge = document.createElement('div');
      deliveryBadge.style.cssText = `display: inline-block; padding: 4px 8px; background: ${deliveryDateBg}; border: 2px solid ${deliveryDateColor};`;
      const deliveryText = document.createElement('span');
      deliveryText.style.cssText = `font-size: 12px; font-weight: 700; color: ${deliveryDateColor};`;
      deliveryText.textContent = formattedDeliveryDate;
      deliveryBadge.appendChild(deliveryText);
      deliveryCell.appendChild(deliveryBadge);
      row.appendChild(deliveryCell);

      // Items
      const itemsCell = document.createElement('td');
      itemsCell.style.cssText = 'padding: 10px 8px; text-align: center; width: 60px;';
      const itemsBadge = document.createElement('span');
      itemsBadge.style.cssText = 'display: inline-block; padding: 4px 8px; background: #f9fafb; border: 2px solid #e5e7eb; font-size: 13px; font-weight: 700; color: #1a1a1a;';
      itemsBadge.textContent = order.total_items;
      itemsCell.appendChild(itemsBadge);
      row.appendChild(itemsCell);

      // Actions - EVENT DELEGATION PATTERN with data attributes
      const actionsCell = document.createElement('td');
      actionsCell.style.cssText = 'padding: 10px 8px; text-align: center; font-size: 13px; white-space: nowrap; width: 100px;';

      const editLink = document.createElement('a');
      editLink.href = '#';
      editLink.className = 'edit-order-btn';
      editLink.setAttribute('data-order-id', order.id);
      editLink.style.cssText = 'color: #4a4a4a; text-decoration: underline; cursor: pointer; font-weight: 600; font-size: 13px;';
      editLink.textContent = 'edit';

      const separator = document.createElement('span');
      separator.style.cssText = 'margin: 0 8px; color: #d1d5db; font-size: 13px;';
      separator.textContent = '|';

      const deleteLink = document.createElement('a');
      deleteLink.href = '#';
      deleteLink.className = 'delete-order-btn';
      deleteLink.setAttribute('data-order-id', order.id);
      deleteLink.setAttribute('data-vendor-name', order.vendor);
      deleteLink.style.cssText = 'color: #dc2626; text-decoration: underline; cursor: pointer; font-weight: 600; font-size: 13px;';
      deleteLink.textContent = 'delete';

      actionsCell.appendChild(editLink);
      actionsCell.appendChild(separator);
      actionsCell.appendChild(deleteLink);
      row.appendChild(actionsCell);

      tbody.appendChild(row);
      console.log(`✅ Row ${index + 1} appended with EDIT and DELETE buttons`);
    });

    console.log('✅ All rows rendered successfully!');

    // EVENT DELEGATION - Add click listener to container (not individual buttons)
    container.removeEventListener('click', handleOrderActions); // Remove old listener
    container.addEventListener('click', handleOrderActions); // Add new listener
  }

  /**
   * Handle all edit/delete button clicks via event delegation
   */
  function handleOrderActions(event) {
    const editLink = event.target.closest('.edit-order-btn');
    if (editLink) {
      event.preventDefault();
      const orderId = parseInt(editLink.getAttribute('data-order-id'));
      console.log('🖱️ EDIT clicked for order ID:', orderId);
      try {
        editPendingOrder(orderId);
      } catch (err) {
        console.error('❌ Error calling editPendingOrder:', err);
      }
      return;
    }

    const deleteLink = event.target.closest('.delete-order-btn');
    if (deleteLink) {
      event.preventDefault();
      const orderId = parseInt(deleteLink.getAttribute('data-order-id'));
      const vendorName = deleteLink.getAttribute('data-vendor-name');
      console.log('🖱️ DELETE clicked for order ID:', orderId, 'Vendor:', vendorName);
      console.log('🔧 About to call deletePendingOrder...');
      try {
        deletePendingOrder(orderId, vendorName);
        console.log('✅ deletePendingOrder called successfully');
      } catch (err) {
        console.error('❌ Error calling deletePendingOrder:', err);
      }
      return;
    }
  }

  /**
   * Edit pending order (delivery date, items, etc.)
   */
  async function editPendingOrder(orderId) {
    console.log('Editing order:', orderId);

    showLoading('Loading Order', 'Fetching order details...');

    try {
      const { data: order, error } = await supabase
        .from('pending_orders')
        .select(`
          *,
          pending_order_items (
            id,
            inventory_item_id,
            quantity_ordered,
            unit,
            item_name,
            vendor
          )
        `)
        .eq('id', orderId)
        .single();

      if (error) throw error;

      hideLoading();

      // Create modal
      const modal = document.createElement('div');
      modal.id = 'editOrderModal';
      modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10000; overflow-y: auto; padding: 20px;';

      const content = document.createElement('div');
      content.style.cssText = 'background: white; padding: 24px; max-width: 800px; width: 100%; max-height: 90vh; overflow-y: auto; border: 3px solid var(--gray-700);';

      // Header
      const header = document.createElement('h3');
      header.textContent = `EDIT ORDER: ${order.vendor}`;
      header.style.cssText = 'margin: 0 0 20px 0; font-size: 16px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: var(--gray-900);';
      content.appendChild(header);

      // Delivery Date Input
      const dateLabel = document.createElement('label');
      dateLabel.textContent = 'DELIVERY DATE';
      dateLabel.style.cssText = 'display: block; margin-bottom: 8px; font-size: 11px; font-weight: 700; color: var(--gray-700); text-transform: uppercase; letter-spacing: 0.5px;';
      content.appendChild(dateLabel);

      const dateInput = document.createElement('input');
      dateInput.type = 'date';
      dateInput.id = 'editDeliveryDate';
      dateInput.value = order.expected_delivery_date;
      dateInput.style.cssText = 'width: 100%; padding: 12px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 14px; margin-bottom: 20px; box-sizing: border-box;';
      content.appendChild(dateInput);

      // Items list
      const itemsLabel = document.createElement('h4');
      itemsLabel.textContent = 'ORDER ITEMS';
      itemsLabel.style.cssText = 'margin: 20px 0 12px 0; font-size: 13px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: var(--gray-900);';
      content.appendChild(itemsLabel);

      const itemsContainer = document.createElement('div');
      itemsContainer.id = 'editOrderItems';
      itemsContainer.style.cssText = 'max-height: 300px; overflow-y: auto; border: 2px solid var(--gray-300); padding: 12px; margin-bottom: 20px;';

      order.pending_order_items.forEach(item => {
        const itemDiv = document.createElement('div');
        itemDiv.style.cssText = 'display: grid; grid-template-columns: 3fr 1fr 1fr 40px; gap: 8px; margin-bottom: 12px; align-items: center; padding-bottom: 12px; border-bottom: 1px solid #e5e7eb;';

        const nameDiv = document.createElement('div');
        nameDiv.style.cssText = 'font-size: 13px; font-weight: 600; color: #1a1a1a;';
        nameDiv.textContent = item.item_name;

        const qtyInput = document.createElement('input');
        qtyInput.type = 'number';
        qtyInput.id = `editQty_${item.id}`;
        qtyInput.value = item.quantity_ordered;
        qtyInput.min = '0';
        qtyInput.step = '0.1';
        qtyInput.style.cssText = 'padding: 8px; border: 2px solid #d1d5db; border-radius: 0; font-size: 13px; text-align: center;';

        const unitDiv = document.createElement('div');
        unitDiv.style.cssText = 'font-size: 12px; color: #6b6b6b; text-align: center;';
        unitDiv.textContent = item.unit;

        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'delete-order-item-btn';
        deleteBtn.setAttribute('data-item-id', item.id);
        deleteBtn.setAttribute('data-order-id', orderId);
        deleteBtn.style.cssText = 'padding: 6px; background: #dc2626; color: white; border: none; cursor: pointer; font-size: 11px; font-weight: 700;';
        deleteBtn.textContent = '✕';

        itemDiv.appendChild(nameDiv);
        itemDiv.appendChild(qtyInput);
        itemDiv.appendChild(unitDiv);
        itemDiv.appendChild(deleteBtn);
        itemsContainer.appendChild(itemDiv);
      });

      // EVENT DELEGATION for delete buttons in modal
      itemsContainer.addEventListener('click', function(event) {
        if (event.target.classList.contains('delete-order-item-btn')) {
          const itemId = parseInt(event.target.getAttribute('data-item-id'));
          const orderId = parseInt(event.target.getAttribute('data-order-id'));
          console.log('🖱️ DELETE ITEM clicked:', itemId, 'from order:', orderId);
          deleteOrderItem(itemId, orderId);
        }
      });

      content.appendChild(itemsContainer);

      // Buttons
      const buttonsDiv = document.createElement('div');
      buttonsDiv.style.cssText = 'display: flex; gap: 12px; justify-content: flex-end;';

      const cancelBtn = document.createElement('button');
      cancelBtn.textContent = 'CANCEL';
      cancelBtn.style.cssText = 'padding: 12px 24px; background: var(--gray-100); border: 2px solid var(--gray-300); color: var(--gray-900); font-size: 13px; font-weight: 700; cursor: pointer; text-transform: uppercase; letter-spacing: 0.5px;';
      cancelBtn.onclick = () => modal.remove();
      buttonsDiv.appendChild(cancelBtn);

      const saveBtn = document.createElement('button');
      saveBtn.textContent = 'SAVE CHANGES';
      saveBtn.style.cssText = 'padding: 12px 24px; background: var(--gray-900); border: 2px solid var(--gray-900); color: white; font-size: 13px; font-weight: 700; cursor: pointer; text-transform: uppercase; letter-spacing: 0.5px;';
      saveBtn.onclick = () => saveOrderEdits(orderId, order);
      buttonsDiv.appendChild(saveBtn);

      content.appendChild(buttonsDiv);

      modal.appendChild(content);
      document.body.appendChild(modal);

    } catch (error) {
      hideLoading();
      console.error('Error loading order for edit:', error);
      showMessage('Failed to load order: ' + error.message, 'error');
    }
  }

  /**
   * Save edits to pending order
   */
  async function saveOrderEdits(orderId, originalOrder) {
    const newDeliveryDate = document.getElementById('editDeliveryDate').value;

    showLoading('Saving Changes', 'Updating order...');

    try {
      // Update delivery date
      const { error: orderError } = await supabase
        .from('pending_orders')
        .update({
          expected_delivery_date: newDeliveryDate,
          updated_at: new Date().toISOString()
        })
        .eq('id', orderId);

      if (orderError) throw orderError;

      // Update item quantities
      for (const item of originalOrder.pending_order_items) {
        const qtyInput = document.getElementById(`editQty_${item.id}`);
        if (qtyInput) {
          const newQty = parseFloat(qtyInput.value) || 0;

          if (newQty !== item.quantity_ordered) {
            const { error: itemError } = await supabase
              .from('pending_order_items')
              .update({ quantity_ordered: newQty })
              .eq('id', item.id);

            if (itemError) throw itemError;
          }
        }
      }

      hideLoading();
      showMessage('✅ Order updated successfully!', 'success');

      // Close modal
      const modal = document.getElementById('editOrderModal');
      if (modal) modal.remove();

      // Reload orders list
      await loadAllPendingOrders();

      // Reload orders due today alert
      await loadOrdersDueTodayAlert();

    } catch (error) {
      hideLoading();
      console.error('Error saving order edits:', error);
      showMessage('Failed to save changes: ' + error.message, 'error');
    }
  }

  window.editPendingOrder = editPendingOrder;

  /**
   * Delete an item from a pending order
   */
  async function deleteOrderItem(itemId, orderId) {
    showLoading('Deleting Item', 'Removing item from order...');

    try {
      const { error } = await supabase
        .from('pending_order_items')
        .delete()
        .eq('id', itemId);

      if (error) throw error;

      hideLoading();
      showMessage('✅ Item deleted', 'success');

      // Re-open the edit modal
      const modal = document.getElementById('editOrderModal');
      if (modal) modal.remove();

      await editPendingOrder(orderId);

    } catch (error) {
      hideLoading();
      console.error('Error deleting item:', error);
      showMessage('Failed to delete item: ' + error.message, 'error');
    }
  }
  window.deleteOrderItem = deleteOrderItem;

  /**
   * Delete entire pending order - SIMPLIFIED VERSION
   */
  async function deletePendingOrder(orderId, vendorName) {
    if (!orderId) {
      showMessage('Order ID missing. Unable to delete.', 'error');
      return;
    }

    const overlay = document.createElement('div');
    overlay.id = 'deleteOrderModal';
    overlay.style.cssText = `
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.55);
      z-index: 11000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    `;

    const modal = document.createElement('div');
    modal.style.cssText = `
      background: white;
      border: 2px solid #b91c1c;
      max-width: 420px;
      width: 100%;
      padding: 24px 24px 20px 24px;
      box-shadow: 0 12px 24px rgba(0,0,0,0.18);
    `;

    modal.innerHTML = `
      <div style="color: #7f1d1d; font-weight: 700; text-transform: uppercase; letter-spacing: 0.6px; margin-bottom: 12px;">Confirm delete</div>
      <p style="margin: 0 0 18px 0; color: #4b5563; font-size: 13px; line-height: 1.5;">
        Permanently delete the pending order for <strong>${vendorName || 'this vendor'}</strong>?<br>
        This will remove all associated items and cannot be undone.
      </p>
      <div style="display: flex; gap: 12px;">
        <button type="button" id="cancelDeleteOrder" style="flex: 1; padding: 12px; background: white; border: 2px solid var(--gray-300); color: var(--gray-700); font-weight: 700; text-transform: uppercase; letter-spacing: 0.6px; cursor: pointer;">Cancel</button>
        <button type="button" id="confirmDeleteOrder" style="flex: 1; padding: 12px; background: #b91c1c; border: 2px solid #991b1b; color: white; font-weight: 700; text-transform: uppercase; letter-spacing: 0.6px; cursor: pointer;">Delete</button>
      </div>
    `;

    overlay.appendChild(modal);
    document.body.appendChild(overlay);

    const removeOverlay = () => {
      if (overlay && overlay.parentNode) {
        overlay.parentNode.removeChild(overlay);
      }
    };

    modal.querySelector('#cancelDeleteOrder').onclick = removeOverlay;
    overlay.onclick = (evt) => {
      if (evt.target === overlay) removeOverlay();
    };

    modal.querySelector('#confirmDeleteOrder').onclick = async () => {
      await performPendingOrderDeletion(orderId, vendorName, overlay);
    };
  }

  async function performPendingOrderDeletion(orderId, vendorName, overlay) {
    showLoading('Deleting Order', `Removing ${vendorName || 'order'}...`);

    try {
      const { data: orderItems, error: fetchItemsError } = await supabase
        .from('pending_order_items')
        .select('inventory_item_id')
        .eq('order_id', orderId);

      if (fetchItemsError) throw new Error(fetchItemsError.message);

      const itemIds = (orderItems || [])
        .map(row => row.inventory_item_id)
        .filter(id => id !== null && id !== undefined);

      const { error: itemsError } = await supabase
        .from('pending_order_items')
        .delete()
        .eq('order_id', orderId);

      if (itemsError) throw new Error(itemsError.message);

      const { error: orderError } = await supabase
        .from('pending_orders')
        .delete()
        .eq('id', orderId);

      if (orderError) throw new Error(orderError.message);

      const cache = getPriceCache();
      itemIds.forEach(id => cache.delete(id));
      if (itemIds.length) {
        await ensurePriceSnapshotsForItems(itemIds);
      }

      hideLoading();
      if (overlay) overlay.remove();

      await loadAllPendingOrders();
      await loadOrdersDueTodayAlert();
      calculateUpcomingOrders();
      await refreshUpcomingOrdersUI();

      showMessage(`✅ Deleted pending order for ${vendorName || 'vendor'}`, 'success');
    } catch (error) {
      hideLoading();
      if (overlay) overlay.remove();
      console.error('Failed to delete order:', error);
      showMessage(`Failed to delete order: ${error.message}`, 'error');
    }
  }
  window.deletePendingOrder = deletePendingOrder;

  // Define loadPendingOrderForCheckIn as wrapper function
  async function loadPendingOrderForCheckIn(orderId) {
    return showPendingOrderForCheckIn(orderId);
  }
  window.loadPendingOrderForCheckIn = loadPendingOrderForCheckIn;

  /**
   * Display pending order items for manual check-in
   */
  async function showPendingOrderForCheckIn(orderId) {
    console.log('showPendingOrderForCheckIn called with order ID:', orderId);

    const container = document.getElementById('pendingOrderCheckInView');
    if (!container) return;

    showLoading('Loading Order', 'Fetching order details...');

    try {
      // Fetch pending order with all items
      const { data: orderData, error: orderError } = await supabase
        .from('pending_orders')
        .select(`
          *,
          pending_order_items (
            id,
            inventory_item_id,
            quantity_ordered,
            unit,
            item_name,
            vendor
          )
        `)
        .eq('id', orderId)
        .single();

      if (orderError) throw orderError;
      if (!orderData) throw new Error('Order not found');

      hideLoading();

      // Store order ID for later
      orderingSystemState.selectedPendingOrderId = orderId;
      orderingSystemState.currentCheckInOrder = orderData;

      // Clear and show container
      container.innerHTML = '';
      container.style.display = 'block';

      // Scroll to this section
      container.scrollIntoView({ behavior: 'smooth', block: 'start' });

      // Header
      const header = document.createElement('div');
      header.style.cssText = 'background: #fef3c7; border: 2px solid #f59e0b; padding: 16px; margin-bottom: 20px;';

      const title = document.createElement('h3');
      title.textContent = `CHECK IN: ${orderData.vendor}`;
      title.style.cssText = 'color: #92400e; margin: 0 0 8px 0; font-size: 16px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;';
      header.appendChild(title);

      const orderInfo = document.createElement('div');
      orderInfo.style.cssText = 'display: flex; gap: 20px; flex-wrap: wrap;';

      const date = document.createElement('div');
      const expectedDatePacific = parsePacificDate(orderData.expected_delivery_date);
      date.innerHTML = `<strong>Expected:</strong> ${
        expectedDatePacific
          ? formatPacificDateDisplay(expectedDatePacific, { month: 'short', day: 'numeric', year: 'numeric', weekday: 'long' })
          : 'Unknown'
      }`;
      date.style.cssText = 'font-size: 12px; color: #78350f;';
      orderInfo.appendChild(date);

      const itemCount = document.createElement('div');
      itemCount.innerHTML = `<strong>Total Items:</strong> ${orderData.total_items}`;
      itemCount.style.cssText = 'font-size: 12px; color: #78350f;';
      orderInfo.appendChild(itemCount);

      header.appendChild(orderInfo);
      container.appendChild(header);

      // Instructions
      const instructions = document.createElement('p');
      instructions.textContent = 'Update received quantities, enter prices (required), add notes, then click CONFIRM ORDER to finalize.';
      instructions.style.cssText = 'color: var(--gray-600); font-size: 13px; margin-bottom: 16px;';
      container.appendChild(instructions);

      // Items table
      const table = document.createElement('div');
      table.style.cssText = 'border: 2px solid var(--gray-300); margin-bottom: 20px;';

      // Table header
      const thead = document.createElement('div');
      thead.style.cssText = 'display: grid; grid-template-columns: 2fr 1fr 1fr 1fr 1fr 2fr 120px; gap: 8px; padding: 10px; background: var(--gray-900); color: white; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;';

      ['Item', 'Ordered', 'Received', 'Unit', 'Price', 'Notes', 'Action'].forEach(label => {
        const th = document.createElement('div');
        th.textContent = label;
        thead.appendChild(th);
      });

      table.appendChild(thead);

      // Items (stored for later updates)
      orderingSystemState.checkInItems = {};

      // Table body
      orderData.pending_order_items.forEach((item, index) => {
        // Initialize item state
        const inventoryItem = orderingSystemState.items?.find(i => i.id === item.inventory_item_id);
        const defaultPrice = item.unit_price != null
          ? parseFloat(item.unit_price)
          : inventoryItem?.currentUnitCost != null
            ? parseFloat(inventoryItem.currentUnitCost)
            : null;

        orderingSystemState.checkInItems[item.id] = {
          id: item.id,
          inventoryItemId: item.inventory_item_id,
          itemName: item.item_name,
          ordered: Number(item.quantity_ordered) || 0,
          received: item.quantity_received != null ? Number(item.quantity_received) : Number(item.quantity_ordered) || 0,
          unit: item.unit,
          price: defaultPrice,
          notes: item.receiving_notes || ''
        };

        const row = document.createElement('div');
        row.id = `checkInRow${item.id}`;
        row.style.cssText = 'display: grid; grid-template-columns: 2fr 1fr 1fr 1fr 1fr 2fr 120px; gap: 8px; padding: 12px; border-top: 1px solid var(--gray-300); background: white;';

        // Item name
        const nameCell = document.createElement('div');
        nameCell.textContent = item.item_name;
        nameCell.style.cssText = 'font-size: 12px; font-weight: 600; color: var(--gray-900);';
        row.appendChild(nameCell);

        // Ordered quantity (read-only)
        const orderedCell = document.createElement('div');
        orderedCell.textContent = item.quantity_ordered;
        orderedCell.style.cssText = 'font-size: 12px; font-weight: 700; color: var(--gray-700);';
        row.appendChild(orderedCell);

        // Received quantity (editable input)
        const receivedCell = document.createElement('div');
        const receivedInput = document.createElement('input');
        receivedInput.type = 'number';
        receivedInput.min = '0';
        receivedInput.step = '0.25';
        receivedInput.value = orderingSystemState.checkInItems[item.id].received;
        receivedInput.id = `receivedQty${item.id}`;
        receivedInput.style.cssText = 'width: 100%; padding: 6px; border: 2px solid var(--gray-300); font-size: 12px; font-weight: 600; text-align: center;';
        receivedInput.onchange = function() {
          orderingSystemState.checkInItems[item.id].received = parseFloat(this.value) || 0;
          // Highlight if different from ordered
          if (parseFloat(this.value) !== item.quantity_ordered) {
            this.style.borderColor = '#f59e0b';
            this.style.background = '#fffbeb';
          } else {
            this.style.borderColor = 'var(--gray-300)';
            this.style.background = 'white';
          }
        };
        receivedCell.appendChild(receivedInput);
        row.appendChild(receivedCell);

        // Unit
        const unitCell = document.createElement('div');
        unitCell.textContent = item.unit;
        unitCell.style.cssText = 'font-size: 11px; color: var(--gray-600);';
        row.appendChild(unitCell);

        // Price input
        const priceCell = document.createElement('div');
        const priceInput = document.createElement('input');
        priceInput.type = 'number';
        priceInput.min = '0';
        priceInput.step = '0.01';
        priceInput.id = `price${item.id}`;
        priceInput.value = defaultPrice != null ? formatCurrencyInput(defaultPrice) : '';
        priceInput.placeholder = '0.00';
        priceInput.style.cssText = 'width: 100%; padding: 6px; border: 2px solid var(--gray-300); font-size: 12px; font-weight: 600; text-align: center;';
        if (defaultPrice == null) {
          priceInput.style.borderColor = '#dc2626';
          priceInput.style.background = '#fee2e2';
        }
        priceInput.onchange = function() {
          const value = parseFloat(this.value);
          if (Number.isFinite(value) && value > 0) {
            orderingSystemState.checkInItems[item.id].price = value;
            this.value = formatCurrencyInput(value);
            this.style.borderColor = 'var(--gray-300)';
            this.style.background = 'white';
          } else {
            orderingSystemState.checkInItems[item.id].price = null;
            this.style.borderColor = '#dc2626';
            this.style.background = '#fee2e2';
          }
        };
        priceCell.appendChild(priceInput);
        row.appendChild(priceCell);

        // Notes (editable input)
        const notesCell = document.createElement('div');
        const notesInput = document.createElement('input');
        notesInput.type = 'text';
        notesInput.placeholder = 'Add notes...';
        notesInput.id = `notes${item.id}`;
        notesInput.style.cssText = 'width: 100%; padding: 6px; border: 2px solid var(--gray-300); font-size: 11px;';
        if (orderingSystemState.checkInItems[item.id].notes) {
          notesInput.value = orderingSystemState.checkInItems[item.id].notes;
        }
        notesInput.onchange = function() {
          orderingSystemState.checkInItems[item.id].notes = this.value;
        };
        notesCell.appendChild(notesInput);
        row.appendChild(notesCell);

        // Actions (delete)
        const actionCell = document.createElement('div');
        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = 'DELETE';
        deleteBtn.style.cssText = 'width: 100%; padding: 8px 6px; background: #dc2626; color: white; border: none; font-size: 10px; font-weight: 700; letter-spacing: 0.8px; cursor: pointer; text-transform: uppercase;';
        deleteBtn.onclick = () => deleteCheckInItem(item.id, orderId);
        actionCell.appendChild(deleteBtn);
        row.appendChild(actionCell);

        table.appendChild(row);
      });

      container.appendChild(table);

      // Bulk actions
      const bulkActions = document.createElement('div');
      bulkActions.style.cssText = 'display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 20px;';

      // Auto-fill all button
      const autoFillBtn = document.createElement('button');
      autoFillBtn.textContent = 'AUTO-FILL: ALL RECEIVED AS ORDERED';
      autoFillBtn.style.cssText = 'flex: 1; padding: 14px; background: var(--gray-100); color: var(--gray-900); border: 2px solid var(--gray-300); font-size: 11px; font-weight: 700; letter-spacing: 1px; cursor: pointer; text-transform: uppercase;';
      autoFillBtn.onclick = () => {
        orderData.pending_order_items.forEach(item => {
          const input = document.getElementById(`receivedQty${item.id}`);
          if (input) {
            input.value = item.quantity_ordered;
            input.style.borderColor = 'var(--gray-300)';
            input.style.background = 'white';
            orderingSystemState.checkInItems[item.id].received = item.quantity_ordered;
          }
        });
        showMessage('✓ All quantities set to ordered amounts', 'success');
      };
      bulkActions.appendChild(autoFillBtn);

      // Check in all button
      const confirmBtn = document.createElement('button');
      confirmBtn.textContent = 'CONFIRM ORDER';
      confirmBtn.style.cssText = 'flex: 1; padding: 14px; background: var(--gray-700); color: white; border: 2px solid var(--gray-700); font-size: 11px; font-weight: 700; letter-spacing: 1px; cursor: pointer; text-transform: uppercase;';
      confirmBtn.onclick = () => confirmPendingOrder(orderId);
      bulkActions.appendChild(confirmBtn);

      container.appendChild(bulkActions);

      // Close button
      const closeBtn = document.createElement('button');
      closeBtn.textContent = 'CANCEL';
      closeBtn.style.cssText = 'width: 100%; padding: 12px; background: var(--gray-300); color: var(--gray-700); border: 2px solid var(--gray-400); font-size: 11px; font-weight: 700; letter-spacing: 1px; cursor: pointer; text-transform: uppercase;';
      closeBtn.onclick = () => {
        container.style.display = 'none';
        container.innerHTML = '';
        orderingSystemState.selectedPendingOrderId = null;
        orderingSystemState.currentCheckInOrder = null;
        orderingSystemState.checkInItems = {};
      };
      container.appendChild(closeBtn);

    } catch (error) {
      hideLoading();
      console.error('Error loading pending order:', error);
      showMessage('Failed to load order: ' + error.message, 'error');
    }
  }

  async function deleteCheckInItem(itemId, orderId) {
    showLoading('Removing Item', 'Deleting item from pending order...');

    try {
      const { error } = await supabase
        .from('pending_order_items')
        .delete()
        .eq('id', itemId);

      if (error) throw error;

      delete orderingSystemState.checkInItems[itemId];

      hideLoading();
      showMessage('Item removed from pending order', 'success');

      await loadPendingOrderForCheckIn(orderId);
    } catch (error) {
      hideLoading();
      console.error('Failed to delete check-in item:', error);
      showMessage('Failed to delete item: ' + error.message, 'error');
    }
  }

  async function confirmPendingOrder(orderId) {
    const items = Object.values(orderingSystemState.checkInItems || {});

    if (!items.length) {
      showMessage('No items left to receive for this order.', 'error');
      return;
    }

    let hasPriceError = false;
    items.forEach(item => {
      const priceInput = document.getElementById(`price${item.id}`);
      const value = Number(item.price);
      if (!Number.isFinite(value) || value <= 0) {
        hasPriceError = true;
        if (priceInput) {
          priceInput.style.borderColor = '#dc2626';
          priceInput.style.background = '#fee2e2';
        }
      }
    });

    if (hasPriceError) {
      showMessage('Enter a valid price for every item before confirming.', 'error');
      return;
    }

    showLoading('Confirming Order', 'Updating inventory and closing order...');

    try {
      for (const item of items) {
        const receivedQty = Number(item.received) || 0;
        const orderedQty = Number(item.ordered) || 0;

        const { error: updateItemError } = await supabase
          .from('pending_order_items')
          .update({
            quantity_received: receivedQty,
            variance: receivedQty - orderedQty,
            unit_price: item.price,
            receiving_notes: item.notes || null
          })
          .eq('id', item.id);

        if (updateItemError) throw updateItemError;

        if (item.inventoryItemId && receivedQty > 0) {
          const { data: currentItem, error: fetchError } = await supabase
            .from('inventory_items')
            .select('current_stock')
            .eq('id', item.inventoryItemId)
            .single();

          if (fetchError) throw fetchError;

          const currentStock = Number(currentItem?.current_stock) || 0;
          const newStock = currentStock + receivedQty;

          const { error: inventoryError } = await supabase
            .from('inventory_items')
            .update({
              current_stock: newStock,
              last_counted_date: getPacificDate(),
              current_unit_cost: item.price,
              last_cost_update: new Date().toISOString()
            })
            .eq('id', item.inventoryItemId);

          if (inventoryError) throw inventoryError;
        }
      }

      const allReceived = items.every(item => (Number(item.received) || 0) >= (Number(item.ordered) || 0));
      const anyReceived = items.some(item => (Number(item.received) || 0) > 0);

      const { error: orderError } = await supabase
        .from('pending_orders')
        .update({
          status: anyReceived ? (allReceived ? 'completed' : 'partial') : 'pending',
          received_date: anyReceived ? getPacificDate() : null,
          updated_at: new Date().toISOString()
        })
        .eq('id', orderId);

      if (orderError) throw orderError;

      hideLoading();
      showMessage('🎉 Order confirmed and inventory updated!', 'success');

      const container = document.getElementById('pendingOrderCheckInView');
      if (container) {
        container.style.display = 'none';
        container.innerHTML = '';
      }

      orderingSystemState.selectedPendingOrderId = null;
      orderingSystemState.currentCheckInOrder = null;
      orderingSystemState.checkInItems = {};

      await loadInventoryData();
      await loadAllPendingOrders();
      await loadOrdersDueTodayAlert();
      calculateUpcomingOrders();
      renderReceivePendingOrders();

    } catch (error) {
      hideLoading();
      console.error('Failed to confirm order:', error);
      showMessage('Failed to confirm order: ' + error.message, 'error');
    }
  }

  /**
   * Load inventory data from database
   */
  async function loadInventoryData() {
    if (!supabase) {
      console.error('Supabase is not initialized!');
      throw new Error('Database not connected');
    }

    console.log('showLoading called...');
    showLoading('Loading Inventory', 'Fetching items from database...');

    try {
      console.log('Querying inventory_items table...');
      const { data, error } = await supabase
        .from('inventory_items')
        .select('*')
        .order('vendor', { ascending: true })
        .order('item_name', { ascending: true });

      console.log('Query result - error:', error);
      console.log('Query result - data:', data);
      console.log('Number of items loaded:', data?.length || 0);

      if (error) throw error;

      orderingSystemState.items = (data || []).map(item => ({
        id: item.id,
        itemName: item.item_name,
        vendor: item.vendor,
        parLevel: item.par_level || 0,
        currentStock: item.current_stock || 0,
        unit: item.unit,
        lastCountedDate: item.last_counted_date,
        currentUnitCost: item.current_unit_cost,
        lastCostUpdate: item.last_cost_update,
        itemType: item.item_type || 'ingredient', // Track if item is 'prep' or 'ingredient'
        urgent: item.urgent || false, // Track urgent flag for MAKE FIRST category
        lineCooksPrep: item.line_cooks_prep || false, // Track line cooks prep items
        notMadeDaily: item.not_made_daily || false, // Track items not made daily
        batchLifespan: item.batch_lifespan_hours,
        storageLocation: item.storage_location,
        lastInvoiceQty: item.last_invoice_qty, // Track quantity added from latest invoice
        lastInvoiceDate: item.last_invoice_date // Track when latest invoice was received
      }));

      console.log('orderingSystemState.items:', orderingSystemState.items);
      console.log('orderingSystemState.items.length:', orderingSystemState.items.length);

      // LEARNING: Load aliases from past successful matches with intelligence
      // Prioritize manual matches (100% confidence) and frequent matches
      console.log('Loading learned aliases from invoice history...');
      const { data: aliasData, error: aliasError } = await supabase
        .from('invoice_items')
        .select('detected_item_name, inventory_item_id, match_confidence, checked_in_at')
        .eq('checked_in', true)
        .not('detected_item_name', 'is', null)
        .not('inventory_item_id', 'is', null)
        .order('checked_in_at', { ascending: false }); // Most recent first

      if (!aliasError && aliasData) {
        orderingSystemState.aliases = {};
        
        // Build frequency map to prioritize common matches
        const aliasFrequency = {};
        aliasData.forEach(alias => {
          const normalized = alias.detected_item_name.toLowerCase().replace(/[^a-z0-9\s]/g, '');
          const key = `${normalized}:${alias.inventory_item_id}`;
          aliasFrequency[key] = (aliasFrequency[key] || 0) + 1;
        });

        // Process aliases with intelligent prioritization
        aliasData.forEach(alias => {
          const normalized = alias.detected_item_name.toLowerCase().replace(/[^a-z0-9\s]/g, '');
          const key = `${normalized}:${alias.inventory_item_id}`;
          const frequency = aliasFrequency[key];
          const isManualMatch = alias.match_confidence === 1.0;
          
          // Only store if:
          // 1. Not already stored (keeps most recent)
          // 2. OR this is a manual match (100% confidence) overriding auto-match
          // 3. OR this match appears frequently (3+ times)
          if (!orderingSystemState.aliases[normalized] || 
              isManualMatch || 
              frequency >= 3) {
            orderingSystemState.aliases[normalized] = {
              inventory_item_id: alias.inventory_item_id,
              detected_name: alias.detected_item_name,
              confidence: alias.match_confidence,
              frequency: frequency,
              is_manual: isManualMatch
            };
          }
        });
        
        console.log('✅ Loaded', Object.keys(orderingSystemState.aliases).length, 'learned aliases');
        console.log('📊 Manual matches:', Object.values(orderingSystemState.aliases).filter(a => a.is_manual).length);
        console.log('📊 Frequent matches (3+):', Object.values(orderingSystemState.aliases).filter(a => a.frequency >= 3).length);
      }

      orderingSystemState.lastUpdated = new Date();
      refreshPriceHistoryControls();
      hideLoading();
      console.log('hideLoading called');
    } catch (error) {
      hideLoading();
      console.error('loadInventoryData error:', error);
      throw new Error(`Failed to load inventory: ${error.message}`);
    }
  }

  /**
   * Calculate upcoming orders for next 7 days
   */
  function calculateUpcomingOrders() {
    console.log('calculateUpcomingOrders() called');
    const now = getPacificMidday();
    const orders = [];

    // Check next 7 days
    for (let i = 0; i < 7; i++) {
      const checkDate = addPacificDays(now, i);
      const dayName = formatPacificWeekday(checkDate);

      // Greenleaf - Daily orders (except Saturday)
      if (dayName !== 'Saturday') {
        const greenleafOrder = calculateGreenleafOrder(checkDate, dayName);
        if (greenleafOrder) orders.push(greenleafOrder);
      }

      // Performance - Sunday and Wednesday
      if (dayName === 'Sunday' || dayName === 'Wednesday') {
        const performanceOrder = calculatePerformanceOrder(checkDate, dayName);
        if (performanceOrder) orders.push(performanceOrder);
      }

      // Mani Imports - Tuesday and Thursday
      if (dayName === 'Tuesday' || dayName === 'Thursday') {
        const maniOrder = calculateManiOrder(checkDate, dayName);
        if (maniOrder) orders.push(maniOrder);
      }

      // Eatopia - Any Wednesday for Thursday delivery
      if (dayName === 'Wednesday') {
        const eatopiaOrder = calculateEatopiaOrder(checkDate);
        if (eatopiaOrder) orders.push(eatopiaOrder);
      }
    }

    // Filter to only show NEXT order per vendor (not all 7 days)
    const nextOrdersByVendor = {};
    orders.forEach(order => {
      if (!nextOrdersByVendor[order.vendor] || order.orderDate < nextOrdersByVendor[order.vendor].orderDate) {
        nextOrdersByVendor[order.vendor] = order;
      }
    });

    orderingSystemState.calculatedOrders = Object.values(nextOrdersByVendor);
    console.log('Filtered to next order per vendor:', orderingSystemState.calculatedOrders.length, 'orders');

    // Load any saved edits from previous sessions
    orderingSystemState.calculatedOrders.forEach(order => {
      loadOrderEditsFromStorage(order);
    });
  }

  /**
   * Calculate Greenleaf order
   */
  function calculateGreenleafOrder(orderDate, dayName) {
    const isFriday = dayName === 'Friday';
    const multiplier = isFriday ? 2 : 1; // Friday covers Sat + Sun

    const items = orderingSystemState.items
      .filter(item => item.vendor === 'Greenleaf')
      .map(item => ({
        id: item.id,
        itemName: item.itemName,
        quantity: Math.max(0, Math.ceil((item.parLevel - item.currentStock) * multiplier)),
        unit: item.unit,
        parLevel: item.parLevel,
        currentStock: item.currentStock,
        lastCountedDate: item.lastCountedDate,
        currentUnitCost: item.currentUnitCost,
        lastCostUpdate: item.lastCostUpdate
      }))
      .filter(item => item.quantity > 0);

    if (items.length === 0) return null;

    const deliveryDate = addPacificDays(orderDate, 1);

    return {
      vendor: 'Greenleaf',
      orderDate: orderDate,
      cutoffTime: '10:00 PM',
      deliveryDate: deliveryDate,
      items: items,
      notes: isFriday ? '🚨 2-DAY SUPPLY for Saturday and Sunday' : null
    };
  }

  /**
   * Calculate Performance order
   */
  function calculatePerformanceOrder(orderDate, dayName) {
    const items = orderingSystemState.items
      .filter(item => item.vendor === 'Performance')
      .map(item => ({
        id: item.id,
        itemName: item.itemName,
        quantity: Math.max(0, item.parLevel - item.currentStock),
        unit: item.unit,
        parLevel: item.parLevel,
        currentStock: item.currentStock,
        lastCountedDate: item.lastCountedDate,
        currentUnitCost: item.currentUnitCost,
        lastCostUpdate: item.lastCostUpdate
      }))
      .filter(item => item.quantity > 0);

    if (items.length === 0) return null;

    const deliveryDate = addPacificDays(orderDate, 1);

    return {
      vendor: 'Performance',
      orderDate: orderDate,
      cutoffTime: '3:00 PM',
      deliveryDate: deliveryDate,
      items: items,
      notes: dayName === 'Sunday' ? 'Delivery Monday morning' : 'Delivery Thursday morning'
    };
  }

  /**
   * Calculate Mani Imports order
   */
  function calculateManiOrder(orderDate, dayName) {
    const isThursday = dayName === 'Thursday';
    const multiplier = isThursday ? 5 : 3; // Thursday = 5 days, Tuesday = 3 days

    const items = orderingSystemState.items
      .filter(item => item.vendor === 'Mani Imports')
      .map(item => ({
        id: item.id,
        itemName: item.itemName,
        quantity: Math.max(0, Math.ceil((item.parLevel - item.currentStock) * (multiplier / 7))),
        unit: item.unit,
        parLevel: item.parLevel,
        currentStock: item.currentStock,
        lastCountedDate: item.lastCountedDate,
        currentUnitCost: item.currentUnitCost,
        lastCostUpdate: item.lastCostUpdate
      }))
      .filter(item => item.quantity > 0);

    if (items.length === 0) return null;

    const deliveryDate = addPacificDays(orderDate, 1);

    return {
      vendor: 'Mani Imports',
      orderDate: orderDate,
      cutoffTime: '3:00 PM',
      deliveryDate: deliveryDate,
      items: items,
      notes: isThursday ? '🚨 LARGE ORDER - 5-day supply covering weekend' : 'Small order - 3-day supply'
    };
  }

  /**
   * Calculate Eatopia order
   */
  function calculateEatopiaOrder(orderDate) {
    const items = orderingSystemState.items
      .filter(item => item.vendor === 'Eatopia Foods')
      .map(item => ({
        id: item.id,
        itemName: item.itemName,
        quantity: Math.max(0, item.parLevel - item.currentStock),
        unit: item.unit,
        parLevel: item.parLevel,
        currentStock: item.currentStock,
        lastCountedDate: item.lastCountedDate,
        currentUnitCost: item.currentUnitCost,
        lastCostUpdate: item.lastCostUpdate
      }))
      .filter(item => item.quantity > 0);

    if (items.length === 0) return null;

    const deliveryDate = addPacificDays(orderDate, 1); // Thursday delivery

    return {
      vendor: 'Eatopia Foods',
      orderDate: orderDate,
      cutoffTime: 'Flexible',
      deliveryDate: deliveryDate,
      items: items,
      notes: 'Delivery always on Thursday'
    };
  }

  /**
   * Format timestamp as relative time with precise hours and minutes
   * Examples: "32m ago", "1hr and 32m ago", "5d ago"
   */
function formatRelativeTime(dateStr) {
  if (!dateStr) return 'Never';

  // Use actual timestamps, NOT midday-normalized dates (that loses hour/minute precision!)
  const date = parsePacificDate(dateStr) || new Date(dateStr);
  const now = new Date();
  
  // Calculate difference in milliseconds using actual timestamps
  const diffMs = now - date;
  const diffMinutes = Math.floor(diffMs / (1000 * 60));
  const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
  const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

  // Format: "15 mins ago", "1 hour ago", "1 hour and 32 mins ago", "1 day ago", "1 day, 4 hours, 34 minutes ago"
  if (diffMinutes < 60) {
    const minutes = Math.max(diffMinutes, 0);
    return `${minutes} min${minutes === 1 ? '' : 's'} ago`;
  }

  if (diffHours < 24) {
    const hours = diffHours;
    const minutes = diffMinutes % 60;
    if (minutes > 0) {
      return `${hours} hour${hours === 1 ? '' : 's'} and ${minutes} min${minutes === 1 ? '' : 's'} ago`;
    } else {
      return `${hours} hour${hours === 1 ? '' : 's'} ago`;
    }
  }

  // More than 24 hours: Always show detailed breakdown
  const days = diffDays;
  const remainingHours = diffHours % 24;
  const remainingMinutes = diffMinutes % 60;
  
  let result = `${days} day${days === 1 ? '' : 's'}`;
  
  // Always add hours and minutes if present (removed the shortcut for "1 day ago")
  if (remainingHours > 0) {
    result += `, ${remainingHours} hour${remainingHours === 1 ? '' : 's'}`;
  }
  if (remainingMinutes > 0) {
    result += `, ${remainingMinutes} minute${remainingMinutes === 1 ? '' : 's'}`;
  }
  
  return result + ' ago';
}

async function renderReceivePendingOrders() {
  const container = document.getElementById('pendingOrderCheckInView');
  if (!container || !container.parentNode) return;

  let pendingSection = document.getElementById('receivePendingOrdersSection');
  if (!pendingSection) {
    pendingSection = document.createElement('div');
    pendingSection.id = 'receivePendingOrdersSection';
    pendingSection.style.cssText = 'margin-top: 32px; border: 2px solid var(--gray-300); background: white;';
    container.parentNode.insertBefore(pendingSection, container.nextSibling);
  }

  pendingSection.innerHTML = `
    <div style="padding: 16px 20px; border-bottom: 2px solid var(--gray-300); background: var(--gray-100);">
      <h3 style="margin: 0 0 6px 0; color: var(--gray-900); text-transform: uppercase; letter-spacing: 1px; font-size: 16px;">Pending Orders to Check In</h3>
      <p style="margin: 0; color: var(--gray-600); font-size: 12px;">Select an order to review received quantities, enter prices, and confirm delivery.</p>
    </div>
    <div id="receiveOrdersList" style="padding: 0 20px 20px 20px;">Loading...</div>
  `;

  let listContainer = document.getElementById('receiveOrdersList');

  try {
    const { data: orders, error } = await supabase
      .from('pending_orders')
      .select(`
        id,
        vendor,
        order_date,
        expected_delivery_date,
        status,
        total_items,
        notes,
        pending_order_items (
          id,
          inventory_item_id,
          quantity_ordered,
          quantity_received,
          variance,
          unit,
          item_name,
          unit_price,
          receiving_notes
        )
      `)
      .order('expected_delivery_date', { ascending: true });

    if (error) throw error;

    if (!orders || orders.length === 0) {
      listContainer.innerHTML = '<p style="padding: 20px; color: var(--gray-600); font-size: 13px;">No pending orders found.</p>';
      return;
    }

    const today = getPacificDate();

    listContainer.innerHTML = orders.map(order => {
      const deliveryDate = parsePacificDate(order.expected_delivery_date);
      let badgeColor = '#d1fae5';
      let badgeBorder = '#059669';
      let badgeText = '#064e3b';
      let badgeLabel = 'Future Delivery';

      if (deliveryDate) {
        const deliveryDateStr = formatPacificDate(deliveryDate);
        if (deliveryDateStr === today) {
          badgeColor = '#fef3c7';
          badgeBorder = '#f59e0b';
          badgeText = '#92400e';
          badgeLabel = 'Due Today';
        } else if (deliveryDate < parsePacificDate(today)) {
          badgeColor = '#fee2e2';
          badgeBorder = '#b91c1c';
          badgeText = '#7f1d1d';
          badgeLabel = 'Past Due';
        }
      }

      const deliveryDisplay = deliveryDate
        ? formatPacificDateDisplay(deliveryDate, { month: 'short', day: 'numeric', year: 'numeric', weekday: 'long' })
        : 'Unknown';

      const previewItems = (order.pending_order_items || []).slice(0, 3).map(item => {
        const priceText = item.unit_price != null ? `$${Number(item.unit_price).toFixed(2)}` : 'No price';
        return `<div style="display:flex;justify-content:space-between;font-size:11px;color:var(--gray-600);margin-top:6px;">
                  <span style="font-weight:600;color:var(--gray-700);">${item.item_name}</span>
                  <span>${item.quantity_ordered} ${item.unit || ''} • ${priceText}</span>
                </div>`;
      }).join('');

      const remainingCount = Math.max(0, (order.pending_order_items || []).length - 3);
      const remainingText = remainingCount > 0
        ? `<div style='font-size:11px;color:var(--gray-500);margin-top:6px;'>+${remainingCount} more items</div>`
        : '';

      return `
        <div class="receive-order-card" data-order-id="${order.id}" style="border:2px solid var(--gray-300);margin-top:16px;background:white;cursor:pointer;">
          <div style="display:flex;justify-content:space-between;align-items:flex-start;padding:16px 18px;gap:18px;">
            <div style="flex:1;">
              <h4 style="margin:0 0 6px 0;color:var(--gray-900);font-size:15px;">${order.vendor}</h4>
              <div style="font-size:12px;color:var(--gray-600);">Ordered: ${order.order_date || 'Unknown'}</div>
              <div style="font-size:12px;color:var(--gray-600);">Expected: ${deliveryDisplay}</div>
              <div style="font-size:12px;color:var(--gray-600);">${order.total_items || 0} item(s)</div>
            </div>
            <div style="min-width:140px;">
              <span style="display:inline-block;padding:6px 10px;background:${badgeColor};border:2px solid ${badgeBorder};color:${badgeText};font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.8px;">${badgeLabel}</span>
            </div>
          </div>
          <div style="padding:0 18px 14px 18px;">
            ${previewItems}
            ${remainingText}
          </div>
        </div>`;
    }).join('');

    listContainer.querySelectorAll('.receive-order-card').forEach(card => {
      card.addEventListener('click', () => {
        const orderId = Number(card.dataset.orderId);
        loadPendingOrderForCheckIn(orderId);
        listContainer.querySelectorAll('.receive-order-card').forEach(el => el.style.borderColor = 'var(--gray-300)');
        card.style.borderColor = '#2563eb';
      });
    });

  } catch (error) {
    console.error('Failed to load pending orders for receive view:', error);
    listContainer = document.getElementById('receiveOrdersList');
    if (listContainer) {
      listContainer.innerHTML = `<p style="padding:20px;color:#dc2626;font-size:13px;">Failed to load pending orders: ${error.message}</p>`;
    }
  }
}

function formatCurrency(value) {
  if (value === null || value === undefined || Number.isNaN(Number(value))) return '--';
  return `$${Number(value).toFixed(2)}`;
}

function formatPercentage(value) {
  if (value === null || value === undefined || Number.isNaN(Number(value))) return '';
  return `${Number(value).toFixed(1)}%`;
}

function getPriceCache() {
  if (!orderingSystemState.priceHistory.cache) {
    orderingSystemState.priceHistory.cache = new Map();
  }
  return orderingSystemState.priceHistory.cache;
}

function formatPriceDateLabel(date) {
  if (!date) return '';
  const dateObj = date instanceof Date ? date : (parsePacificDate(date) || new Date(date));
  return formatPacificDateDisplay(dateObj, { month: 'short', day: 'numeric' });
}

// Load latest + previous invoice prices for the requested inventory items and cache results
async function ensurePriceSnapshotsForItems(itemIds) {
  if (!itemIds || itemIds.length === 0) return;

  const cache = getPriceCache();
  const uniqueIds = Array.from(new Set(
    itemIds
      .map(id => parseInt(id, 10))
      .filter(id => !Number.isNaN(id))
  ));

  const missing = uniqueIds.filter(id => !cache.has(id));
  if (missing.length === 0) return;

  try {
    const { data, error } = await supabase
      .from('invoice_items')
      .select('inventory_item_id, invoice_id, unit_price, detected_price, created_at')
      .in('inventory_item_id', missing)
      .order('created_at', { ascending: false })
      .limit(missing.length * 40);

    if (error) {
      console.warn('Failed to load price snapshots:', error);
      return;
    }

    const invoiceIds = Array.from(new Set((data || []).map(row => row.invoice_id).filter(id => id != null)));
    const invoiceMap = new Map();
    if (invoiceIds.length) {
      const { data: invoiceRows, error: invoiceError } = await supabase
        .from('invoices')
        .select('id, invoice_date, vendor_name, vendor')
        .in('id', invoiceIds);

      if (!invoiceError && invoiceRows) {
        invoiceRows.forEach(row => {
          invoiceMap.set(row.id, row);
        });
      }
    }

    const grouped = new Map();
    (data || []).forEach(row => {
      const itemId = row.inventory_item_id;
      if (!itemId) return;

      const priceValue = row.unit_price ?? row.detected_price;
      if (priceValue === null || priceValue === undefined) return;

      const invoice = row.invoice_id != null ? invoiceMap.get(row.invoice_id) : null;
      const invoiceDate = invoice?.invoice_date || row.created_at;
      const invoiceDateObj = parsePacificDate(invoiceDate) || new Date(invoiceDate);

      const entry = {
        price: Number(priceValue),
        invoiceDate,
        invoiceDateObj,
        vendor: invoice?.vendor_name || invoice?.vendor || null,
        invoiceId: invoice?.id || row.invoice_id || null,
        createdAt: row.created_at
      };

      if (!grouped.has(itemId)) grouped.set(itemId, []);
      grouped.get(itemId).push(entry);
    });

    grouped.forEach((entries, itemId) => {
      entries.sort((a, b) => {
        const aTime = a.invoiceDateObj ? a.invoiceDateObj.getTime() : 0;
        const bTime = b.invoiceDateObj ? b.invoiceDateObj.getTime() : 0;
        return bTime - aTime;
      });

      const latest = entries[0] || null;
      const previous = entries.find(entry => entry !== latest) || null;

      cache.set(itemId, {
        history: entries,
        latest,
        previous,
        fetchedAt: new Date()
      });
    });

    missing.forEach(id => {
      if (!cache.has(id)) {
        cache.set(id, {
          history: [],
          latest: null,
          previous: null,
          fetchedAt: new Date()
        });
      }
    });
  } catch (err) {
    console.warn('Error fetching price snapshots:', err);
  }
}

function getPriceInfoForInventoryId(itemId, fallbackPrice, fallbackDate) {
  if (!itemId && itemId !== 0) return {
    latestPrice: fallbackPrice != null ? Number(fallbackPrice) : null,
    latestDate: fallbackDate || null,
    previousPrice: null,
    previousDate: null,
    diff: null,
    diffPct: null
  };

  const cache = getPriceCache();
  const snapshot = cache.get(Number(itemId));

  const latestPrice = snapshot?.latest?.price ?? (fallbackPrice != null ? Number(fallbackPrice) : null);
  const latestDate = snapshot?.latest?.invoiceDate || fallbackDate || null;
  const previousPrice = snapshot?.previous?.price ?? null;
  const previousDate = snapshot?.previous?.invoiceDate || null;
  const diff = latestPrice != null && previousPrice != null ? latestPrice - previousPrice : null;
  const diffPct = diff != null && previousPrice !== 0 ? (diff / previousPrice) * 100 : null;

  return {
    latestPrice,
    latestDate,
    previousPrice,
    previousDate,
    diff,
    diffPct
  };
}

function getPriceInfoForItem(item) {
  if (!item) return getPriceInfoForInventoryId(null, null, null);
  return getPriceInfoForInventoryId(item.id, item.currentUnitCost, item.lastCostUpdate);
}

// Render a compact price summary (current value + arrow delta) for table display
function renderPriceTrendHtml(info) {
  const latest = info.latestPrice != null ? formatCurrency(info.latestPrice) : '--';
  const latestDateLabel = info.latestDate ? ` (${formatPriceDateLabel(info.latestDate)})` : '';

  let trendHtml = '';
  if (info.diff != null && info.previousPrice != null) {
    const arrow = info.diff > 0 ? '▲' : info.diff < 0 ? '▼' : '•';
    const color = info.diff > 0 ? '#c62828' : info.diff < 0 ? '#2e7d32' : 'var(--gray-500)';
    const diffAbs = formatCurrency(Math.abs(info.diff));
    const pct = info.diffPct != null ? formatPercentage(Math.abs(info.diffPct)) : '';
    const prevDate = info.previousDate ? formatPriceDateLabel(info.previousDate) : '';
    trendHtml = `<span style="color: ${color}; font-weight: 600; font-size: 11px;">${arrow} ${diffAbs}${pct ? ` (${pct})` : ''}${prevDate ? ` vs ${prevDate}` : ''}</span>`;
  } else if (info.previousPrice == null) {
    trendHtml = '<span style="color: var(--gray-500); font-size: 11px;">No prior price</span>';
  } else {
    trendHtml = '<span style="color: var(--gray-500); font-size: 11px;">No change</span>';
  }

  return `
    <div style="display: flex; flex-direction: column; gap: 2px;">
      <span style="font-weight: 700; color: var(--gray-900);">${latest}${latestDateLabel}</span>
      ${trendHtml}
    </div>
  `;
}

// Render price comparison for a new invoice price against cached historical values
function renderIncomingPriceHtml(itemId, incomingPrice, invoiceDate) {
  if (incomingPrice === null || incomingPrice === undefined || Number.isNaN(Number(incomingPrice))) {
    return '<span style="color: var(--gray-500); font-size: 11px;">No price on invoice</span>';
  }

  const cache = getPriceCache();
  const snapshot = cache.get(Number(itemId));
  const previousEntry = snapshot?.latest || snapshot?.previous || null;
  const previousPrice = previousEntry?.price ?? null;
  const info = {
    latestPrice: Number(incomingPrice),
    latestDate: invoiceDate || null,
    previousPrice,
    previousDate: previousEntry?.invoiceDate || null,
    diff: previousPrice != null ? Number(incomingPrice) - previousPrice : null,
    diffPct: previousPrice != null && previousPrice !== 0 ? ((Number(incomingPrice) - previousPrice) / previousPrice) * 100 : null
  };

  return renderPriceTrendHtml(info);
}

// Ensure price snapshots are loaded before rendering upcoming AI suggestions
async function refreshUpcomingOrdersUI(targetContainer) {
  const orders = orderingSystemState.calculatedOrders || [];
  const itemIds = [];
  orders.forEach(order => {
    (order.items || []).forEach(item => {
      if (item && item.id != null) {
        itemIds.push(item.id);
      }
    });
  });

  if (itemIds.length) {
    await ensurePriceSnapshotsForItems(itemIds);
  }

  orderingSystemState.lastUpdated = new Date();
  renderUpcomingOrders(targetContainer);
}

  /**
   * Format price with date (e.g., "$24.38 (9/22/25)")
   * Matches email format
   */
  function formatPriceWithDate(price, dateStr) {
    if (!price) return '';

    const formattedPrice = '$' + parseFloat(price).toFixed(2);

    if (!dateStr) return formattedPrice;

    const pacificDate = parsePacificDate(dateStr) || new Date(dateStr);
    const formattedDate = pacificDate
      ? formatPacificDateDisplay(pacificDate, { month: 'numeric', day: 'numeric', year: '2-digit' })
      : '';

    return `${formattedPrice} (${formattedDate})`;
  }

  /**
   * Render upcoming orders (AI suggestions)
   */
  function renderUpcomingOrders(targetContainer) {
    const container = targetContainer || document.getElementById('upcomingOrders');

    // Exit early if container doesn't exist (prevents errors when called from other tabs)
    if (!container) {
      console.warn('renderUpcomingOrders: Container not found, skipping render');
      return;
    }

    // Add section header
    let html = `
      <div style="margin-bottom: 20px; padding-bottom: 12px; border-bottom: 3px solid var(--gray-300);">
        <h3 style="color: var(--gray-900); margin: 0; font-size: 18px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;">AI-SUGGESTED ORDERS</h3>
        <p style="color: var(--gray-600); font-size: 12px; margin: 8px 0 0 0;">Based on current stock levels and par requirements</p>
      </div>
    `;

    if (orderingSystemState.calculatedOrders.length === 0) {
      html += `
        <div style="text-align: center; padding: 40px; background: #f0f4f8; border-radius: 4px;">
          <p style="font-size: 16px; color: #666;">✅ No orders needed in the next 7 days!</p>
          <p style="font-size: 14px; color: #999; margin-top: 10px;">All inventory levels are sufficient.</p>
        </div>
      `;
      container.innerHTML = html;
      return;
    }

    html += `
      <div style="font-size: 12px; color: #666; margin-bottom: 20px;">
        Last updated: ${
          orderingSystemState.lastUpdated
            ? formatPacificDateDisplay(orderingSystemState.lastUpdated, {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
              })
            : 'Never'
        }
      </div>
    `;

    orderingSystemState.calculatedOrders.forEach((order, index) => {
      const orderDateStr = formatPacificDateDisplay(order.orderDate, {
        weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
      });
      const deliveryDateStr = formatPacificDateDisplay(order.deliveryDate, {
        weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
      });

      html += `
        <div class="order-card" id="order-${index}" style="
          border: 2px solid var(--gray-300);
          margin-bottom: 16px;
          padding: 14px;
          border-radius: 0;
          background: white;
          box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        ">
          <h3 style="color: var(--gray-900); margin-bottom: 12px; font-size: 14px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.8px;">
            ${order.vendor} - ORDER #${index + 1}
          </h3>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px; padding: 10px; background: var(--gray-100); border-radius: 0; border: 1px solid var(--gray-300);">
            <div>
              <div style="font-weight: 700; color: var(--gray-600); font-size: 9px; text-transform: uppercase; letter-spacing: 0.5px;">Order Date</div>
              <div style="font-size: 12px; margin-top: 3px; color: var(--gray-900);">${orderDateStr}</div>
            </div>
            <div>
              <div style="font-weight: 700; color: var(--gray-600); font-size: 9px; text-transform: uppercase; letter-spacing: 0.5px;">Cutoff</div>
              <div style="font-size: 12px; margin-top: 3px; color: var(--gray-900);">${order.cutoffTime}</div>
            </div>
            <div>
              <div style="font-weight: 700; color: var(--gray-600); font-size: 9px; text-transform: uppercase; letter-spacing: 0.5px;">Delivery</div>
              <div style="font-size: 12px; margin-top: 3px; color: var(--gray-900);">${deliveryDateStr}</div>
            </div>
            <div>
              <div style="font-weight: 700; color: var(--gray-600); font-size: 9px; text-transform: uppercase; letter-spacing: 0.5px;">Items</div>
              <div style="font-size: 12px; margin-top: 3px; color: var(--gray-900);">${order.items.length} items</div>
            </div>
          </div>

          ${order.notes ? `
            <div style="background: var(--light-blue); border-left: 3px solid var(--primary-blue); padding: 8px; margin-bottom: 12px; border-radius: 0; font-size: 11px;">
              <strong style="color: var(--gray-900);">Note:</strong> <span style="color: var(--gray-700);">${order.notes}</span>
            </div>
          ` : ''}

          <table style="width: 100%; border-collapse: collapse; margin-top: 12px; font-size: 12px;">
            <thead>
              <tr style="background: var(--gray-900); color: var(--white);">
                <th style="padding: 8px 6px; text-align: left; border: 1px solid var(--gray-300); font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">Item</th>
                <th style="padding: 8px 4px; text-align: center; border: 1px solid var(--gray-300); font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">Qty</th>
                <th style="padding: 8px 4px; text-align: center; border: 1px solid var(--gray-300); font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">Unit</th>
                <th style="padding: 8px 4px; text-align: center; border: 1px solid var(--gray-300); font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">Price</th>
                <th style="padding: 8px 4px; text-align: center; border: 1px solid var(--gray-300); font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">Par</th>
                <th style="padding: 8px 4px; text-align: center; border: 1px solid var(--gray-300); font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">Stock</th>
              </tr>
            </thead>
            <tbody>
              ${order.items.map((item, i) => {
                // Calculate reasoning text (matches email format)
                const isFriday = formatPacificWeekday(order.orderDate) === 'Friday';
                const isThursday = formatPacificWeekday(order.orderDate) === 'Thursday';
                let reasoningText = '';

                if (order.vendor === 'Greenleaf' && isFriday) {
                  // Friday Greenleaf = 2-day coverage
                  reasoningText = `AI: (Par ${item.parLevel} - Stock ${item.currentStock}) × 2 days = ${item.quantity} to order`;
                } else if (order.vendor === 'Mani Imports' && isThursday) {
                  // Thursday Mani = 5-day coverage
                  const calc = Math.ceil((item.parLevel - item.currentStock) * (5 / 7));
                  reasoningText = `AI: (Par ${item.parLevel} - Stock ${item.currentStock}) × 5/7 days = ${calc} to order`;
                } else if (order.vendor === 'Mani Imports') {
                  // Tuesday Mani = 3-day coverage
                  const calc = Math.ceil((item.parLevel - item.currentStock) * (3 / 7));
                  reasoningText = `AI: (Par ${item.parLevel} - Stock ${item.currentStock}) × 3/7 days = ${calc} to order`;
                } else {
                  // Simple par-based calculation
                  reasoningText = `AI: Par ${item.parLevel} - Stock ${item.currentStock} = ${item.quantity} to order`;
                }

                // Format last count and price trends
                const lastCountStr = item.lastCountedDate ? `Last count: ${formatRelativeTime(item.lastCountedDate)}` : '';
                const priceInfo = getPriceInfoForItem(item);
                const priceTrendHtml = renderPriceTrendHtml(priceInfo);

                return `
                <tr style="background: ${i % 2 === 0 ? 'var(--gray-100)' : 'white'};">
                  <td style="padding: 8px 6px; border: 1px solid var(--gray-300); font-size: 13px;">
                    <strong>${item.itemName}</strong>
                    ${lastCountStr ? `<div style="font-size: 10px; color: var(--gray-500); margin-top: 3px;">${lastCountStr}</div>` : ''}
                    <div style="font-size: 9px; color: var(--gray-400); margin-top: 3px; font-style: italic;">${reasoningText}</div>
                  </td>
                  <td style="padding: 6px 4px; text-align: center; border: 1px solid var(--gray-300);">
                    <input
                      type="number"
                      value="${item.quantity}"
                      data-order-index="${index}"
                      data-item-id="${item.id}"
                      onchange="updateOrderItemQuantity(${index}, ${item.id}, this.value)"
                      style="width: 60px; padding: 5px 4px; text-align: center; border: 2px solid var(--gray-600); border-radius: 0; font-size: 13px; font-weight: 700; color: var(--gray-900);"
                      min="0"
                      step="0.25"
                    />
                  </td>
                  <td style="padding: 6px 4px; text-align: center; border: 1px solid var(--gray-300);">
                    <input
                      type="text"
                      value="${item.unit}"
                      data-order-index="${index}"
                      data-item-id="${item.id}"
                      onchange="updateOrderItemUnit(${index}, ${item.id}, this.value)"
                      style="width: 65px; padding: 5px 4px; text-align: center; border: 2px solid var(--gray-300); border-radius: 0; font-size: 11px;"
                      placeholder="CS"
                    />
                  </td>
                  <td style="padding: 6px 6px; border: 1px solid var(--gray-300); vertical-align: middle;">${priceTrendHtml}</td>
                  <td style="padding: 6px 4px; text-align: center; border: 1px solid var(--gray-300); font-size: 12px; font-weight: 600;">${item.parLevel}</td>
                  <td style="padding: 6px 4px; text-align: center; border: 1px solid var(--gray-300); font-size: 12px; font-weight: 600;">${item.currentStock}</td>
                </tr>
                `;
              }).join('')}
            </tbody>
          </table>

          <div style="margin-top: 12px; margin-bottom: 20px;">
            <button class="submit-btn" onclick="addItemToAISuggestion(${index})" style="width: 100%; background: var(--gray-700); color: white; font-weight: 700; padding: 12px; font-size: 12px; text-transform: uppercase; letter-spacing: 1px;">
              + ADD ITEM
            </button>
          </div>

          <div style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
            <button class="submit-btn" onclick="generatePDFAndCreateOrder(${index})" style="flex: 1; min-width: 200px; background: #212121; color: white; font-weight: 700; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; padding: 14px;">
              📄 CREATE ORDER & DOWNLOAD PDF
            </button>
          </div>
        </div>
      `;
    });

    container.innerHTML = html;
  }

  /**
   * Update item quantity in AI suggestion
   */
  function updateOrderItemQuantity(orderIndex, itemId, newQuantity) {
    const order = orderingSystemState.calculatedOrders[orderIndex];
    if (!order) return;

    const item = order.items.find(i => i.id === itemId);
    if (item) {
      item.quantity = parseFloat(newQuantity) || 0;
      // Save immediately to persist edits
      saveOrderEditsToStorage(orderIndex);
    }
  }

  /**
   * Update item unit in AI suggestion (does NOT save to database, only updates order)
   */
  function updateOrderItemUnit(orderIndex, itemId, newUnit) {
    const order = orderingSystemState.calculatedOrders[orderIndex];
    if (!order) return;

    const item = order.items.find(i => i.id === itemId);
    if (item) {
      item.unit = newUnit.trim().toUpperCase();
      // Save immediately to persist edits
      saveOrderEditsToStorage(orderIndex);
    }
  }

  /**
   * Add item to AI suggestion
   */
  async function addItemToAISuggestion(orderIndex) {
    const order = orderingSystemState.calculatedOrders[orderIndex];
    if (!order) {
      showMessage('Order not found', 'error');
      return;
    }

    // Get current item IDs already in the order
    const currentItemIds = order.items.map(item => item.id);

    // Get available items from this vendor that aren't already in the order
    const availableItems = orderingSystemState.items
      .filter(item => item.vendor === order.vendor && !currentItemIds.includes(item.id))
      .sort((a, b) => a.itemName.localeCompare(b.itemName));

    if (availableItems.length === 0) {
      showMessage('No more items available for this vendor', 'warning');
      return;
    }

    // Create modal
    const overlay = document.createElement('div');
    overlay.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px;';

    const modal = document.createElement('div');
    modal.style.cssText = 'background: white; max-width: 600px; width: 100%; border: 2px solid var(--gray-400); max-height: 90vh; display: flex; flex-direction: column;';

    // Header
    const header = document.createElement('div');
    header.style.cssText = 'background: var(--gray-600); color: white; padding: 16px 20px;';

    const title = document.createElement('h3');
    title.textContent = `ADD ITEM - ${order.vendor}`;
    title.style.cssText = 'margin: 0; font-size: 16px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;';
    header.appendChild(title);

    modal.appendChild(header);

    // Content
    const content = document.createElement('div');
    content.style.cssText = 'padding: 20px; overflow-y: auto; flex: 1;';

    const instructions = document.createElement('p');
    instructions.textContent = 'Select an item to add to this order:';
    instructions.style.cssText = 'color: var(--gray-600); font-size: 13px; margin-bottom: 16px;';
    content.appendChild(instructions);

    // Search input
    const searchInput = document.createElement('input');
    searchInput.type = 'text';
    searchInput.placeholder = 'Search items...';
    searchInput.style.cssText = 'width: 100%; padding: 10px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 13px; margin-bottom: 16px;';
    content.appendChild(searchInput);

    // Items list container
    const itemsList = document.createElement('div');
    itemsList.style.cssText = 'display: flex; flex-direction: column; gap: 8px; max-height: 400px; overflow-y: auto;';

    function renderItemsList(items) {
      itemsList.innerHTML = '';

      items.forEach(item => {
        const itemBtn = document.createElement('button');
        itemBtn.style.cssText = 'padding: 12px; border: 2px solid var(--gray-300); background: white; text-align: left; cursor: pointer; transition: all 0.2s;';

        const itemName = document.createElement('div');
        itemName.textContent = item.itemName;
        itemName.style.cssText = 'font-weight: 700; font-size: 13px; color: var(--gray-900); margin-bottom: 4px;';
        itemBtn.appendChild(itemName);

        const itemDetails = document.createElement('div');
        itemDetails.textContent = `Par: ${item.parLevel} | Current: ${item.currentStock} | Unit: ${item.unit}`;
        itemDetails.style.cssText = 'font-size: 11px; color: var(--gray-600);';
        itemBtn.appendChild(itemDetails);

        itemBtn.onmouseover = () => {
          itemBtn.style.background = 'var(--gray-100)';
          itemBtn.style.borderColor = 'var(--gray-900)';
        };
        itemBtn.onmouseout = () => {
          itemBtn.style.background = 'white';
          itemBtn.style.borderColor = 'var(--gray-300)';
        };

        itemBtn.onclick = () => {
          // Show quantity input modal
          showQuantityInputModal(order, orderIndex, item, overlay);
        };

        itemsList.appendChild(itemBtn);
      });
    }

    renderItemsList(availableItems);

    // Search filter
    searchInput.oninput = (e) => {
      const searchTerm = e.target.value.toLowerCase();
      const filtered = availableItems.filter(item =>
        item.itemName.toLowerCase().includes(searchTerm)
      );
      renderItemsList(filtered);
    };

    content.appendChild(itemsList);
    modal.appendChild(content);

    // Footer
    const footer = document.createElement('div');
    footer.style.cssText = 'padding: 16px 20px; background: white; border-top: 2px solid var(--gray-300);';

    const cancelBtn = document.createElement('button');
    cancelBtn.textContent = 'CANCEL';
    cancelBtn.style.cssText = 'width: 100%; padding: 14px; background: white; color: var(--gray-700); border: 2px solid var(--gray-300); border-radius: 0; font-size: 12px; font-weight: 700; letter-spacing: 1px; cursor: pointer;';
    cancelBtn.onclick = () => document.body.removeChild(overlay);
    footer.appendChild(cancelBtn);

    modal.appendChild(footer);
    overlay.appendChild(modal);
    document.body.appendChild(overlay);
  }

  /**
   * Show quantity input modal for adding item
   */
  function showQuantityInputModal(order, orderIndex, item, previousOverlay) {
    // Remove previous modal
    document.body.removeChild(previousOverlay);

    // Create new modal for quantity input
    const overlay = document.createElement('div');
    overlay.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px;';

    const modal = document.createElement('div');
    modal.style.cssText = 'background: white; max-width: 500px; width: 100%; border: 2px solid var(--gray-400);';

    // Header
    const header = document.createElement('div');
    header.style.cssText = 'background: var(--gray-600); color: white; padding: 16px 20px;';

    const title = document.createElement('h3');
    title.textContent = 'ENTER QUANTITY';
    title.style.cssText = 'margin: 0; font-size: 16px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;';
    header.appendChild(title);

    modal.appendChild(header);

    // Content
    const content = document.createElement('div');
    content.style.cssText = 'padding: 20px;';

    const itemLabel = document.createElement('div');
    itemLabel.textContent = item.itemName;
    itemLabel.style.cssText = 'font-weight: 700; font-size: 14px; color: var(--gray-900); margin-bottom: 16px;';
    content.appendChild(itemLabel);

    const qtyLabel = document.createElement('label');
    qtyLabel.textContent = 'QUANTITY:';
    qtyLabel.style.cssText = 'display: block; color: var(--gray-700); font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;';
    content.appendChild(qtyLabel);

    const qtyInput = document.createElement('input');
    qtyInput.type = 'number';
    qtyInput.min = '0';
    qtyInput.step = '0.25';
    qtyInput.value = Math.max(0, item.parLevel - item.currentStock);
    qtyInput.style.cssText = 'width: 100%; padding: 10px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 13px;';
    content.appendChild(qtyInput);

    modal.appendChild(content);

    // Footer
    const footer = document.createElement('div');
    footer.style.cssText = 'padding: 16px 20px; background: white; border-top: 2px solid var(--gray-300); display: flex; gap: 12px;';

    const cancelBtn = document.createElement('button');
    cancelBtn.textContent = 'CANCEL';
    cancelBtn.style.cssText = 'flex: 1; padding: 14px; background: white; color: var(--gray-700); border: 2px solid var(--gray-300); border-radius: 0; font-size: 12px; font-weight: 700; letter-spacing: 1px; cursor: pointer;';
    cancelBtn.onclick = () => document.body.removeChild(overlay);
    footer.appendChild(cancelBtn);

    const confirmBtn = document.createElement('button');
    confirmBtn.textContent = 'ADD ITEM';
    confirmBtn.style.cssText = 'flex: 2; padding: 14px; background: var(--gray-600); color: white; border: 2px solid var(--gray-600); border-radius: 0; font-size: 12px; font-weight: 700; letter-spacing: 1px; cursor: pointer;';
    confirmBtn.onclick = async () => {
      const quantity = parseFloat(qtyInput.value) || 0;
      if (quantity <= 0) {
        showMessage('Please enter a quantity greater than 0', 'warning');
        return;
      }

      // Add item to the order
      order.items.push({
        id: item.id,
        itemName: item.itemName,
        quantity: quantity,
        unit: item.unit,
        parLevel: item.parLevel,
        currentStock: item.currentStock,
        lastCountedDate: item.lastCountedDate,
        currentUnitCost: item.currentUnitCost,
        lastCostUpdate: item.lastCostUpdate
      });

      // Close modal
      document.body.removeChild(overlay);

      // Re-render the order card to show the new item
      await ensurePriceSnapshotsForItems([item.id]);
      await refreshUpcomingOrdersUI();

      showMessage(`Added ${item.itemName} (${quantity} ${item.unit})`, 'success');
    };
    footer.appendChild(confirmBtn);

    modal.appendChild(footer);
    overlay.appendChild(modal);
    document.body.appendChild(overlay);

    // Focus quantity input
    setTimeout(() => qtyInput.focus(), 100);
  }

  /**
   * Create pending order from AI suggestion
   */
  async function createOrderForReceiving(orderIndex) {
    const order = orderingSystemState.calculatedOrders[orderIndex];
    if (!order) {
      showMessage('Order not found', 'error');
      return Promise.reject('Order not found');
    }

    console.log('Creating order for receiving:', order);

    // Return a promise that resolves when user confirms or rejects when cancelled
    return new Promise((resolve, reject) => {
      // Create confirmation modal
      const overlay = document.createElement('div');
      overlay.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px;';

      const modal = document.createElement('div');
      modal.style.cssText = 'background: white; max-width: 600px; width: 100%; border: 2px solid var(--gray-400); max-height: 90vh; overflow-y: auto;';

      // Header
      const header = document.createElement('div');
      header.style.cssText = 'background: #212121; color: white; padding: 16px 20px;';

      const title = document.createElement('h3');
      title.textContent = `CREATE ORDER - ${order.vendor}`;
      title.style.cssText = 'margin: 0; font-size: 16px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;';
      header.appendChild(title);

      modal.appendChild(header);

      // Content
      const content = document.createElement('div');
      content.style.cssText = 'padding: 20px;';

      const instructions = document.createElement('p');
      instructions.textContent = 'Review the order details and confirm. After saving, a PDF will be generated with your final quantities.';
      instructions.style.cssText = 'color: var(--gray-600); font-size: 13px; margin-bottom: 20px;';
      content.appendChild(instructions);

      // Order details
      const detailsBox = document.createElement('div');
      detailsBox.style.cssText = 'background: #f9fafb; padding: 16px; border: 2px solid var(--gray-300); margin-bottom: 20px;';

      const orderDateLabel = document.createElement('div');
      orderDateLabel.textContent = 'Order Date:';
      orderDateLabel.style.cssText = 'font-size: 11px; font-weight: 700; color: var(--gray-700); margin-bottom: 4px; text-transform: uppercase;';
      detailsBox.appendChild(orderDateLabel);

      const orderDateValue = document.createElement('div');
      orderDateValue.textContent = formatPacificDateDisplay(order.orderDate, {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        weekday: 'long'
      });
      orderDateValue.style.cssText = 'font-size: 14px; color: var(--gray-900); margin-bottom: 12px;';
      detailsBox.appendChild(orderDateValue);

      const itemsLabel = document.createElement('div');
      itemsLabel.textContent = 'Items:';
      itemsLabel.style.cssText = 'font-size: 11px; font-weight: 700; color: var(--gray-700); margin-bottom: 4px; text-transform: uppercase;';
      detailsBox.appendChild(itemsLabel);

      const itemsValue = document.createElement('div');
      itemsValue.textContent = `${order.items.length} item(s) to order`;
      itemsValue.style.cssText = 'font-size: 14px; color: var(--gray-900);';
      detailsBox.appendChild(itemsValue);

      content.appendChild(detailsBox);

      // Delivery date input
      const dateLabel = document.createElement('label');
      dateLabel.textContent = 'EXPECTED DELIVERY DATE:';
      dateLabel.style.cssText = 'display: block; color: var(--gray-700); font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;';
      content.appendChild(dateLabel);

      const dateInput = document.createElement('input');
      dateInput.type = 'date';
      dateInput.id = 'createOrderDeliveryDate';
      dateInput.value = formatPacificDate(order.deliveryDate);
      dateInput.min = getPacificDate(); // Pacific Time, not UTC
      dateInput.style.cssText = 'width: 100%; padding: 10px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 13px; margin-bottom: 20px;';
      content.appendChild(dateInput);

      // Notes
      const notesLabel = document.createElement('label');
      notesLabel.textContent = 'NOTES (OPTIONAL):';
      notesLabel.style.cssText = 'display: block; color: var(--gray-700); font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;';
      content.appendChild(notesLabel);

      const notesInput = document.createElement('textarea');
      notesInput.id = 'createOrderNotes';
      notesInput.placeholder = 'Add any special instructions...';
      notesInput.style.cssText = 'width: 100%; padding: 10px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 13px; min-height: 80px; font-family: inherit;';
      if (order.notes) notesInput.value = order.notes;
      content.appendChild(notesInput);

      modal.appendChild(content);

      // Footer
      const footer = document.createElement('div');
      footer.style.cssText = 'padding: 16px 20px; background: white; border-top: 2px solid var(--gray-300); display: flex; gap: 12px;';

      const cancelBtn = document.createElement('button');
      cancelBtn.textContent = 'CANCEL';
      cancelBtn.style.cssText = 'flex: 1; padding: 14px; background: white; color: var(--gray-700); border: 2px solid var(--gray-300); border-radius: 0; font-size: 12px; font-weight: 700; letter-spacing: 1px; cursor: pointer;';
      cancelBtn.onclick = () => {
        document.body.removeChild(overlay);
        reject('User cancelled');
      };
      footer.appendChild(cancelBtn);

      const confirmBtn = document.createElement('button');
      confirmBtn.textContent = 'SAVE & CONTINUE';
      confirmBtn.style.cssText = 'flex: 2; padding: 14px; background: #212121; color: white; border: 2px solid #212121; border-radius: 0; font-size: 12px; font-weight: 700; letter-spacing: 1px; cursor: pointer;';
      confirmBtn.onclick = async () => {
        // Update order object with modal inputs BEFORE saving and generating PDF
      order.deliveryDate = parsePacificDate(dateInput.value);
        order.notes = notesInput.value;

        const success = await saveAIPendingOrder(order, dateInput.value, notesInput.value, overlay);
        if (success) {
          // Order object is now updated with latest notes and delivery date
          // PDF will use these updated values
          resolve();
        } else {
          reject('Failed to save order');
        }
      };
      footer.appendChild(confirmBtn);

      modal.appendChild(footer);
      overlay.appendChild(modal);
      document.body.appendChild(overlay);
    });
  }

  /**
   * Save AI-suggested order as pending order
   */
  async function saveAIPendingOrder(order, deliveryDate, notes, modalOverlay) {
    if (!deliveryDate) {
      showMessage('Please select a delivery date', 'warning');
      return false;
    }

    // Normalize delivery date to Pacific YYYY-MM-DD for Supabase storage.
    const deliveryDatePacific = parsePacificDate(deliveryDate);
    if (!deliveryDatePacific) {
      showMessage('Delivery date is invalid', 'error');
      return false;
    }
    const deliveryDateStr = formatPacificDate(deliveryDatePacific);
    order.deliveryDate = deliveryDatePacific;

    showLoading('Creating Order', 'Saving order for receiving...');

    try {
      // Create pending order record
      const { data: orderData, error: orderError } = await supabase
        .from('pending_orders')
        .insert({
          vendor: order.vendor,
          order_date: formatPacificDate(order.orderDate),
          expected_delivery_date: deliveryDateStr,
          status: 'pending',
          created_by: 'System (AI Suggestion)',
          notes: notes || `Cutoff: ${order.cutoffTime}`,
          total_items: order.items.length
        })
        .select()
        .single();

      if (orderError) throw orderError;

      const orderId = orderData.id;
      console.log('Created pending order from AI suggestion:', orderId);

      // Create order items
      const orderItems = order.items.map(item => ({
        order_id: orderId,
        inventory_item_id: item.id,
        quantity_ordered: item.quantity,
        unit: item.unit,
        item_name: item.itemName,
        vendor: order.vendor
      }));

      const { error: itemsError } = await supabase
        .from('pending_order_items')
        .insert(orderItems);

      if (itemsError) throw itemsError;

      hideLoading();

      // Close modal
      document.body.removeChild(modalOverlay);

      showMessage(`✅ Order saved! Generating PDF...`, 'success');

      // Refresh the ORDERS tab to show the new pending order
      renderOrdersTab();

      console.log('✅ AI order converted to pending order successfully');

      return true; // Success

    } catch (error) {
      hideLoading();
      console.error('Error creating pending order:', error);
      showMessage('Failed to create order: ' + error.message, 'error');
      return false; // Failure
    }
  }

  /**
   * Sort vendors with PREP first, then alphabetically
   */
  function sortVendorsWithPrepFirst(vendors) {
    return vendors.sort((a, b) => {
      if (a === 'PREP') return -1;
      if (b === 'PREP') return 1;
      return a.localeCompare(b);
    });
  }

  // Bulk edit state
  let bulkEditMode = false;
  let selectedItemsForBulkEdit = new Set();

  /**
   * Toggle bulk edit mode
   */
  function toggleBulkEditMode() {
    bulkEditMode = !bulkEditMode;
    selectedItemsForBulkEdit.clear();
    renderInventoryList();
  }

  /**
   * Toggle item selection for bulk edit
   */
  function toggleItemSelection(itemId) {
    if (selectedItemsForBulkEdit.has(itemId)) {
      selectedItemsForBulkEdit.delete(itemId);
    } else {
      selectedItemsForBulkEdit.add(itemId);
    }
    renderInventoryList();
  }

  /**
   * Toggle selection for all items in a vendor
   */
  function toggleVendorSelection(vendor) {
    const vendorItems = orderingSystemState.items.filter(item => item.vendor === vendor);
    const allSelected = vendorItems.every(item => selectedItemsForBulkEdit.has(item.id));
    
    if (allSelected) {
      // Deselect all items in this vendor
      vendorItems.forEach(item => selectedItemsForBulkEdit.delete(item.id));
    } else {
      // Select all items in this vendor
      vendorItems.forEach(item => selectedItemsForBulkEdit.add(item.id));
    }
    
    renderInventoryList();
  }

  /**
   * Open bulk edit modal for selected items
   */
  async function openBulkEditModal() {
    if (selectedItemsForBulkEdit.size === 0) {
      showMessage('Please select at least one item to edit', 'warning');
      return;
    }

    const selectedItems = orderingSystemState.items.filter(item =>
      selectedItemsForBulkEdit.has(item.id)
    );

    // Create modal
    const overlay = document.createElement('div');
    overlay.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px;';

    const modal = document.createElement('div');
    modal.style.cssText = 'background: white; max-width: 900px; width: 100%; max-height: 90vh; display: flex; flex-direction: column; border: 2px solid var(--gray-400);';

    // Header
    const header = document.createElement('div');
    header.style.cssText = 'background: #212121; color: white; padding: 16px 20px; display: flex; justify-content: space-between; align-items: center;';

    const title = document.createElement('h3');
    title.textContent = `BULK EDIT - ${selectedItems.length} ITEMS SELECTED`;
    title.style.cssText = 'margin: 0; font-size: 16px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;';
    header.appendChild(title);

    modal.appendChild(header);

    // Content
    const content = document.createElement('div');
    content.style.cssText = 'padding: 20px; overflow-y: auto; flex: 1;';

    // Render each selected item with editable fields
    selectedItems.forEach((item, index) => {
      const itemCard = document.createElement('div');
      itemCard.style.cssText = 'border: 2px solid var(--gray-300); padding: 16px; margin-bottom: 16px; background: var(--gray-50);';

      const itemHeader = document.createElement('div');
      itemHeader.textContent = item.itemName;
      itemHeader.style.cssText = 'font-weight: 700; font-size: 14px; color: var(--gray-900); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px;';
      itemCard.appendChild(itemHeader);

      // Create editable fields grid
      const fieldsGrid = document.createElement('div');
      fieldsGrid.style.cssText = 'display: grid; grid-template-columns: 1fr 1fr; gap: 12px;';

      // Item Name
      const nameField = document.createElement('div');
      nameField.style.cssText = 'grid-column: 1 / -1;';
      const nameLabel = document.createElement('label');
      nameLabel.textContent = 'ITEM NAME';
      nameLabel.style.cssText = 'display: block; color: var(--gray-700); font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px;';
      const nameInput = document.createElement('input');
      nameInput.type = 'text';
      nameInput.value = item.itemName;
      nameInput.dataset.itemId = item.id;
      nameInput.dataset.field = 'item_name';
      nameInput.style.cssText = 'width: 100%; padding: 8px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 13px; box-sizing: border-box;';
      nameField.appendChild(nameLabel);
      nameField.appendChild(nameInput);
      fieldsGrid.appendChild(nameField);

      // Vendor
      const vendorField = document.createElement('div');
      const vendorLabel = document.createElement('label');
      vendorLabel.textContent = 'VENDOR';
      vendorLabel.style.cssText = 'display: block; color: var(--gray-700); font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px;';
      
      // Get unique vendors from all items
      const allVendors = [...new Set(orderingSystemState.items.map(i => i.vendor).filter(v => v))].sort();
      
      const vendorInput = document.createElement('select');
      vendorInput.dataset.itemId = item.id;
      vendorInput.dataset.field = 'vendor';
      vendorInput.style.cssText = 'width: 100%; padding: 8px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 13px; box-sizing: border-box; background: white; cursor: pointer;';
      
      // Add options for each vendor
      allVendors.forEach(vendor => {
        const option = document.createElement('option');
        option.value = vendor;
        option.textContent = vendor;
        option.selected = vendor === item.vendor;
        vendorInput.appendChild(option);
      });
      
      vendorField.appendChild(vendorLabel);
      vendorField.appendChild(vendorInput);
      fieldsGrid.appendChild(vendorField);

      // Unit
      const unitField = document.createElement('div');
      const unitLabel = document.createElement('label');
      unitLabel.textContent = 'UNIT';
      unitLabel.style.cssText = 'display: block; color: var(--gray-700); font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px;';
      const unitInput = document.createElement('input');
      unitInput.type = 'text';
      unitInput.value = item.unit;
      unitInput.dataset.itemId = item.id;
      unitInput.dataset.field = 'unit';
      unitInput.style.cssText = 'width: 100%; padding: 8px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 13px; box-sizing: border-box;';
      unitField.appendChild(unitLabel);
      unitField.appendChild(unitInput);
      fieldsGrid.appendChild(unitField);

      // Par Level
      const parField = document.createElement('div');
      const parLabel = document.createElement('label');
      parLabel.textContent = 'PAR LEVEL';
      parLabel.style.cssText = 'display: block; color: var(--gray-700); font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px;';
      const parInput = document.createElement('input');
      parInput.type = 'number';
      parInput.value = item.parLevel;
      parInput.step = '0.25';
      parInput.dataset.itemId = item.id;
      parInput.dataset.field = 'par_level';
      parInput.style.cssText = 'width: 100%; padding: 8px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 13px; box-sizing: border-box;';
      parField.appendChild(parLabel);
      parField.appendChild(parInput);
      fieldsGrid.appendChild(parField);

      // Current Stock (read-only)
      const stockField = document.createElement('div');
      const stockLabel = document.createElement('label');
      stockLabel.textContent = 'CURRENT STOCK (READ-ONLY)';
      stockLabel.style.cssText = 'display: block; color: var(--gray-600); font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px;';
      const stockInput = document.createElement('input');
      stockInput.type = 'number';
      stockInput.value = item.currentStock || 0;
      stockInput.readOnly = true;
      stockInput.style.cssText = 'width: 100%; padding: 8px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 13px; box-sizing: border-box; background: var(--gray-100); color: var(--gray-600);';
      stockField.appendChild(stockLabel);
      stockField.appendChild(stockInput);
      fieldsGrid.appendChild(stockField);

      // Item Type (if exists)
      if (item.itemType || item.vendor === 'PREP') {
        const typeField = document.createElement('div');
        const typeLabel = document.createElement('label');
        typeLabel.textContent = 'ITEM TYPE';
        typeLabel.style.cssText = 'display: block; color: var(--gray-700); font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px;';
        const typeInput = document.createElement('input');
        typeInput.type = 'text';
        typeInput.value = item.itemType || 'prep';
        typeInput.dataset.itemId = item.id;
        typeInput.dataset.field = 'item_type';
        typeInput.style.cssText = 'width: 100%; padding: 8px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 13px; box-sizing: border-box;';
        typeField.appendChild(typeLabel);
        typeField.appendChild(typeInput);
        fieldsGrid.appendChild(typeField);

        // Batch Lifespan
        const lifespanField = document.createElement('div');
        const lifespanLabel = document.createElement('label');
        lifespanLabel.textContent = 'BATCH LIFESPAN (HOURS)';
        lifespanLabel.style.cssText = 'display: block; color: var(--gray-700); font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px;';
        const lifespanInput = document.createElement('input');
        lifespanInput.type = 'number';
        lifespanInput.value = item.batchLifespan || '';
        lifespanInput.placeholder = 'e.g., 24';
        lifespanInput.dataset.itemId = item.id;
        lifespanInput.dataset.field = 'batch_lifespan_hours';
        lifespanInput.style.cssText = 'width: 100%; padding: 8px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 13px; box-sizing: border-box;';
        lifespanField.appendChild(lifespanLabel);
        lifespanField.appendChild(lifespanInput);
        fieldsGrid.appendChild(lifespanField);
      }

      itemCard.appendChild(fieldsGrid);
      
      // Add compact checkboxes section
      const checkboxSection = document.createElement('div');
      checkboxSection.style.cssText = 'margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--gray-200); display: grid; grid-template-columns: 1fr 1fr; gap: 6px;';
      
      // Checkbox helper function
      const createCheckbox = (id, label, checked, field) => {
        const wrapper = document.createElement('label');
        wrapper.style.cssText = 'display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 10px; font-weight: 600; color: var(--gray-600); text-transform: uppercase; letter-spacing: 0.3px;';
        
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.checked = checked;
        checkbox.dataset.itemId = item.id;
        checkbox.dataset.field = field;
        checkbox.style.cssText = 'width: 12px; height: 12px; cursor: pointer; margin: 0;';
        
        const text = document.createElement('span');
        text.textContent = label;
        
        wrapper.appendChild(checkbox);
        wrapper.appendChild(text);
        return wrapper;
      };
      
      // Add all checkboxes
      checkboxSection.appendChild(createCheckbox(`urgent-${item.id}`, 'Make First', item.urgent, 'urgent'));
      checkboxSection.appendChild(createCheckbox(`line-cooks-${item.id}`, 'Line Cooks', item.lineCooksPrep, 'line_cooks_prep'));
      checkboxSection.appendChild(createCheckbox(`not-daily-${item.id}`, 'Not Daily', item.notMadeDaily, 'not_made_daily'));
      checkboxSection.appendChild(createCheckbox(`bottle-${item.id}`, 'Bottle Count', item.showInBottleCount, 'show_in_bottle_count'));
      
      itemCard.appendChild(checkboxSection);
      content.appendChild(itemCard);
    });

    modal.appendChild(content);

    // Footer with buttons
    const footer = document.createElement('div');
    footer.style.cssText = 'padding: 16px 20px; background: white; border-top: 2px solid var(--gray-300); display: flex; gap: 12px;';

    const cancelBtn = document.createElement('button');
    cancelBtn.textContent = 'CANCEL';
    cancelBtn.style.cssText = 'flex: 1; padding: 14px; background: white; color: var(--gray-700); border: 2px solid var(--gray-300); border-radius: 0; font-size: 12px; font-weight: 700; letter-spacing: 1px; cursor: pointer;';
    cancelBtn.onclick = () => document.body.removeChild(overlay);
    footer.appendChild(cancelBtn);

    const saveBtn = document.createElement('button');
    saveBtn.textContent = `SAVE ${selectedItems.length} ITEMS`;
    saveBtn.style.cssText = 'flex: 2; padding: 14px; background: #212121; color: white; border: 2px solid #212121; border-radius: 0; font-size: 12px; font-weight: 700; letter-spacing: 1px; cursor: pointer;';
    saveBtn.onclick = async () => {
      await saveBulkEdits(modal, overlay);
    };
    footer.appendChild(saveBtn);

    modal.appendChild(footer);
    overlay.appendChild(modal);
    document.body.appendChild(overlay);
  }

  /**
   * Save bulk edits for all selected items
   */
  async function saveBulkEdits(modal, overlay) {
    const inputs = modal.querySelectorAll('input[data-item-id], select[data-item-id]');
    const updates = {};

    // Group updates by item ID
    inputs.forEach(input => {
      const itemId = parseInt(input.dataset.itemId);
      const field = input.dataset.field;
      
      if (!updates[itemId]) {
        updates[itemId] = {};
      }

      // Handle checkboxes
      if (input.type === 'checkbox') {
        updates[itemId][field] = input.checked;
      }
      // Handle number fields
      else if (field === 'par_level' || field === 'batch_lifespan_hours') {
        const value = input.value.trim();
        if (value !== '') {
          updates[itemId][field] = parseFloat(value) || 0;
        }
      }
      // Handle unit (uppercase)
      else if (field === 'unit') {
        const value = input.value.trim();
        if (value !== '') {
          updates[itemId][field] = value.toUpperCase();
        }
      }
      // Handle all other text fields - only if not empty
      else {
        const value = input.value.trim();
        if (value !== '') {
          updates[itemId][field] = value;
        }
      }
    });

    document.body.removeChild(overlay);
    showLoading('Saving Bulk Edits', `Updating ${Object.keys(updates).length} items...`);

    try {
      let successCount = 0;
      let errorCount = 0;

      // Update each item
      for (const [itemId, data] of Object.entries(updates)) {
        try {
          console.log(`Updating item ${itemId} with data:`, data);
          
          // Add last_counted_date to mark item as counted
          data.last_counted_date = new Date().toISOString();
          
          const { error } = await supabase
            .from('inventory_items')
            .update(data)
            .eq('id', parseInt(itemId));

          if (error) {
            console.error(`Supabase error for item ${itemId}:`, error);
            throw error;
          }

          // Update local state
          const localItem = orderingSystemState.items.find(i => i.id === parseInt(itemId));
          if (localItem) {
            if (data.item_name) localItem.itemName = data.item_name;
            if (data.vendor) localItem.vendor = data.vendor;
            if (data.unit) localItem.unit = data.unit;
            if (data.par_level !== undefined) localItem.parLevel = data.par_level;
            if (data.item_type) localItem.itemType = data.item_type;
            if (data.batch_lifespan_hours !== undefined) localItem.batchLifespan = data.batch_lifespan_hours;
            if (data.urgent !== undefined) localItem.urgent = data.urgent;
            if (data.line_cooks_prep !== undefined) localItem.lineCooksPrep = data.line_cooks_prep;
            if (data.not_made_daily !== undefined) localItem.notMadeDaily = data.not_made_daily;
            if (data.show_in_bottle_count !== undefined) localItem.showInBottleCount = data.show_in_bottle_count;
            if (data.last_counted_date) localItem.lastCountedDate = data.last_counted_date;
          }

          successCount++;
        } catch (error) {
          console.error(`Error updating item ${itemId}:`, error);
          errorCount++;
        }
      }

      hideLoading();

      if (errorCount === 0) {
        showMessage(`✅ Successfully updated ${successCount} items!`, 'success');
      } else {
        showMessage(`⚠️ Updated ${successCount} items, ${errorCount} failed`, 'warning');
      }

      // Exit bulk edit mode and refresh
      bulkEditMode = false;
      selectedItemsForBulkEdit.clear();
      renderInventoryList();
      renderStockCountList();
      renderPrepCountList();
      calculateUpcomingOrders();
      await refreshUpcomingOrdersUI();
      await refreshUpcomingOrdersUI();
      await refreshUpcomingOrdersUI();

    } catch (error) {
      hideLoading();
      showMessage('Error saving bulk edits: ' + error.message, 'error');
    }
  }

  /**
   * Render inventory list for managing par levels
   */
  function renderInventoryList() {
    const container = document.getElementById('inventoryList');

    if (orderingSystemState.items.length === 0) {
      container.innerHTML = '<p style="text-align: center; padding: 20px;">No inventory items found. Add items using the form above.</p>';
      return;
    }

    // Add bulk edit toggle button at top
    let html = `
      <div style="margin-bottom: 20px; display: flex; gap: 12px; align-items: center;">
        <button
          onclick="toggleBulkEditMode()"
          style="
            padding: 12px 20px;
            background: ${bulkEditMode ? '#212121' : 'var(--gray-700)'};
            color: white;
            border: none;
            border-radius: 0;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
          "
        >
          ${bulkEditMode ? 'EXIT BULK EDIT' : 'BULK EDIT'}
        </button>
        ${bulkEditMode && selectedItemsForBulkEdit.size > 0 ? `
          <button
            onclick="openBulkEditModal()"
            style="
              padding: 12px 20px;
              background: #2e7d32;
              color: white;
              border: none;
              border-radius: 0;
              font-size: 12px;
              font-weight: 700;
              text-transform: uppercase;
              letter-spacing: 1px;
              cursor: pointer;
            "
          >
            EDIT ${selectedItemsForBulkEdit.size} SELECTED
          </button>
        ` : ''}
        ${bulkEditMode ? `
          <span style="color: var(--gray-600); font-size: 12px; font-weight: 600;">
            SELECT ITEMS TO BULK EDIT
          </span>
        ` : ''}
      </div>
    `;

    // Group by vendor
    const itemsByVendor = {};
    orderingSystemState.items.forEach(item => {
      if (!itemsByVendor[item.vendor]) {
        itemsByVendor[item.vendor] = [];
      }
      itemsByVendor[item.vendor].push(item);
    });

    sortVendorsWithPrepFirst(Object.keys(itemsByVendor)).forEach(vendor => {
      const items = itemsByVendor[vendor];
      const isPrepCategory = vendor === 'PREP';
      const headerColor = isPrepCategory ? '#212121' : 'var(--gray-700)';
      
      // Check if all items in this vendor are selected
      const allSelected = items.every(item => selectedItemsForBulkEdit.has(item.id));

      html += `
        <div style="margin-bottom: 24px;">
          <div style="background: ${headerColor}; color: white; padding: 12px 16px; border-radius: 0; margin-bottom: 0; display: flex; justify-content: space-between; align-items: center;">
            <h4 style="margin: 0; font-size: 14px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;">
              ${vendor} <span style="opacity: 0.7; font-weight: 400; font-size: 12px;">(${items.length})</span>
            </h4>
            ${bulkEditMode ? `
              <button
                onclick="toggleVendorSelection('${vendor.replace(/'/g, "\\'")}')"
                style="
                  background: ${allSelected ? 'rgba(255, 255, 255, 0.2)' : 'rgba(255, 255, 255, 0.15)'};
                  border: 2px solid rgba(255, 255, 255, 0.4);
                  border-radius: 4px;
                  color: white;
                  padding: 6px 12px;
                  font-size: 11px;
                  font-weight: 700;
                  text-transform: uppercase;
                  letter-spacing: 0.5px;
                  cursor: pointer;
                  transition: all 0.2s;
                "
                onmouseover="this.style.background='rgba(255, 255, 255, 0.3)'"
                onmouseout="this.style.background='${allSelected ? 'rgba(255, 255, 255, 0.2)' : 'rgba(255, 255, 255, 0.15)'}'"
              >
                ${allSelected ? '✓ DESELECT ALL' : 'SELECT ALL'}
              </button>
            ` : ''}
          </div>
          <div style="background: white; border: 2px solid var(--gray-300); border-top: none;">
            ${items.map((item, i) => {
              const isSelected = selectedItemsForBulkEdit.has(item.id);
              return `
              <div
                style="
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  padding: 12px 16px;
                  border-bottom: 1px solid var(--gray-200);
                  transition: background 0.2s;
                  background: ${isSelected ? '#e3f2fd' : (i % 2 === 0 ? 'white' : '#f9fafb')};
                "
                ${!bulkEditMode ? `
                  onmouseover="this.style.background='#f3f4f6'"
                  onmouseout="this.style.background='${i % 2 === 0 ? 'white' : '#f9fafb'}'"
                ` : ''}
              >
                ${bulkEditMode ? `
                  <label style="display: flex; align-items: center; gap: 12px; flex: 1; cursor: pointer;">
                    <input
                      type="checkbox"
                      ${isSelected ? 'checked' : ''}
                      onchange="toggleItemSelection(${item.id})"
                      style="width: 18px; height: 18px; cursor: pointer;"
                    />
                    <span style="font-size: 14px; font-weight: 600; color: var(--gray-900);">
                      ${item.itemName}
                    </span>
                  </label>
                ` : `
                  <div style="flex: 1; font-size: 14px; font-weight: 600; color: var(--gray-900);">
                    ${item.itemName}
                  </div>
                  <button
                    onclick="openEditItemModal(${item.id}); return false;"
                    style="
                      background: var(--gray-100);
                      border: 2px solid var(--gray-300);
                      border-radius: 4px;
                      padding: 8px 12px;
                      cursor: pointer;
                      display: flex;
                      align-items: center;
                      gap: 6px;
                      color: var(--gray-700);
                      font-size: 12px;
                      font-weight: 700;
                      text-transform: uppercase;
                      letter-spacing: 0.5px;
                      transition: all 0.2s;
                    "
                    onmouseover="this.style.background='var(--gray-700)'; this.style.color='var(--white)'; this.style.borderColor='var(--gray-700)';"
                    onmouseout="this.style.background='var(--gray-100)'; this.style.color='var(--gray-700)'; this.style.borderColor='var(--gray-300)';"
                  >
                    <span style="font-size: 16px;">✏️</span>
                    <span>Edit</span>
                  </button>
                `}
              </div>
              `;
            }).join('')}
          </div>
        </div>
      `;
    });

    container.innerHTML = html;
  }

  /**
   * Render stock count list for updating inventory
   * Mobile-first card-based design with large touch targets
   */
  function renderStockCountList() {
    const container = document.getElementById('stockCountList');

    if (orderingSystemState.items.length === 0) {
      container.innerHTML = '<p style="text-align: center; padding: 20px;">No inventory items found.</p>';
      return;
    }

    // Group by vendor (exclude PREP items - they go in PREP tab)
    const itemsByVendor = {};
    orderingSystemState.items.forEach(item => {
      // Skip PREP items - they belong in PREP tab
      if (item.vendor === 'PREP' || item.itemType === 'prep') {
        return;
      }
      if (!itemsByVendor[item.vendor]) {
        itemsByVendor[item.vendor] = [];
      }
      itemsByVendor[item.vendor].push(item);
    });

    // Helper function to get stock status
    function getStockStatus(currentStock, parLevel) {
      if (parLevel === 0) return { label: 'N/A', color: 'var(--gray-600)', bg: 'var(--gray-100)' };
      const percentage = (currentStock / parLevel) * 100;
      if (percentage < 30) return { label: 'LOW', color: '#d32f2f', bg: '#ffebee' }; // Keep red for warnings
      if (percentage < 70) return { label: 'MEDIUM', color: 'var(--gray-700)', bg: 'var(--gray-200)' };
      return { label: 'GOOD', color: '#2e7d32', bg: '#e8f5e9' }; // Keep green for success
    }

    // Helper function to format last counted date
    function formatLastCounted(dateStr) {
      if (!dateStr) return 'Never';
      const date = new Date(dateStr);
      const now = new Date();
      const diffMs = now - date;
      const diffMinutes = Math.floor(diffMs / (1000 * 60));
      const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
      const diffDays = Math.floor(diffHours / 24);

      // Less than 1 hour: show minutes
      if (diffMinutes < 60) {
        return `${diffMinutes} minute${diffMinutes === 1 ? '' : 's'} ago`;
      }
      
      // Less than 24 hours: show hours and minutes
      if (diffHours < 24) {
        const remainingMinutes = diffMinutes % 60;
        if (remainingMinutes === 0) {
          return `${diffHours} hour${diffHours === 1 ? '' : 's'} ago`;
        }
        return `${diffHours} hour${diffHours === 1 ? '' : 's'} and ${remainingMinutes} minute${remainingMinutes === 1 ? '' : 's'} ago`;
      }
      
      // Less than 7 days: show days, hours, and minutes
      if (diffDays < 7) {
        const remainingHours = diffHours % 24;
        const remainingMinutes = diffMinutes % 60;
        let result = `${diffDays} day${diffDays === 1 ? '' : 's'}`;
        if (remainingHours > 0) {
          result += `, ${remainingHours} hour${remainingHours === 1 ? '' : 's'}`;
        }
        if (remainingMinutes > 0) {
          result += `, ${remainingMinutes} minute${remainingMinutes === 1 ? '' : 's'}`;
        }
        return result + ' ago';
      }
      
      // 7+ days: show date
      return date.toLocaleDateString('en-US', { month: 'numeric', day: 'numeric', year: '2-digit' });
    }

    let html = '';
    sortVendorsWithPrepFirst(Object.keys(itemsByVendor)).forEach(vendor => {
      const items = itemsByVendor[vendor];
      const isPrepCategory = vendor === 'PREP';
      const headerColor = isPrepCategory ? '#212121' : 'var(--gray-700)'; // Grayscale throughout
      html += `
        <div style="margin-bottom: 30px;">
          <h4 style="background: ${headerColor}; color: white; padding: 12px 16px; border-radius: 0; margin-bottom: 12px; font-size: 14px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;">
            ${vendor} <span style="opacity: 0.7; font-weight: 400; font-size: 12px;">(${items.length})</span>
          </h4>

          <!-- Single column layout for all screens -->
          <div style="display: flex; flex-direction: column; gap: ${isCompactMode ? '8px' : '10px'};">
            ${items.map((item) => {
              const status = getStockStatus(item.currentStock, item.parLevel);
              const lastCounted = formatLastCounted(item.lastCountedDate);

              return `
                <div style="
                  background: white;
                  border: 1px solid #e0e0e0;
                  border-radius: ${isCompactMode ? '6px' : '8px'};
                  padding: ${isCompactMode ? '10px' : '14px'};
                  box-shadow: 0 1px 3px rgba(0,0,0,0.08);
                  transition: box-shadow 0.2s;
                "
                onmouseover="this.style.boxShadow='0 2px 8px rgba(0,0,0,0.12)'"
                onmouseout="this.style.boxShadow='0 1px 3px rgba(0,0,0,0.08)'">

                  <!-- Header: Item Name + Status Badge -->
                  <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: ${isCompactMode ? '8px' : '12px'}; gap: 8px;">
                    <div style="flex: 1; font-weight: 600; font-size: ${isCompactMode ? '14px' : '15px'}; line-height: 1.3; color: #333;">
                      ${item.itemName}
                    </div>
                    <div style="
                      background: ${status.bg};
                      color: ${status.color};
                      padding: ${isCompactMode ? '3px 8px' : '4px 10px'};
                      border-radius: 12px;
                      font-size: ${isCompactMode ? '10px' : '11px'};
                      font-weight: 700;
                      white-space: nowrap;
                      letter-spacing: 0.3px;
                    ">
                      ${status.label}
                    </div>
                  </div>

                  <!-- Metadata Row -->
                  <div style="
                    display: flex;
                    gap: ${isCompactMode ? '12px' : '16px'};
                    margin-bottom: ${isCompactMode ? '8px' : '12px'};
                    font-size: ${isCompactMode ? '12px' : '13px'};
                    color: #666;
                  ">
                    <div>
                      <span style="color: #999;">Unit:</span> <strong>${item.unit}</strong>
                    </div>
                    <div>
                      <span style="color: #999;">Par:</span> <strong>${item.parLevel}</strong>
                    </div>
                    <div style="margin-left: auto; color: #999; font-size: ${isCompactMode ? '11px' : '12px'};">
                      ${lastCounted}
                    </div>
                  </div>

                  ${item.lastInvoiceQty && item.lastInvoiceDate ? `
                  <!-- Invoice Addition Info -->
                  <div style="
                    margin-top: 8px;
                    margin-bottom: 12px;
                    padding: 8px 10px;
                    background: var(--blue-bg);
                    border-left: 3px solid var(--blue-text);
                    border-radius: 0;
                    font-size: ${isCompactMode ? '11px' : '12px'};
                    color: var(--blue-text);
                    font-weight: 600;
                    font-style: italic;
                  ">
                    ${item.lastInvoiceQty} ADDED VIA INVOICE ON ${formatPacificDateDisplay(new Date(item.lastInvoiceDate), {
                      month: 'short',
                      day: 'numeric',
                      year: 'numeric',
                      hour: 'numeric',
                      minute: '2-digit',
                      hour12: true
                    })}
                  </div>
                  ` : ''}

                  <!-- Stock Input with Quick Adjustments (Mobile-Optimized) -->
                  <div>
                    <label style="display: block; font-size: 12px; color: #666; margin-bottom: 6px; font-weight: 500;">
                      Current Stock
                    </label>
                    <!-- Input with Stepper Buttons -->
                    <div style="display: flex; gap: 5px; align-items: stretch;">
                      <!-- Decrement Button -->
                      <button
                        type="button"
                        onclick="quickAdjustStock(${item.id}, -0.25)"
                        style="
                          flex: 0 0 40px;
                          padding: 0;
                          font-size: 22px;
                          font-weight: 700;
                          background: #f5f5f5;
                          border: 2px solid #e0e0e0;
                          border-radius: 6px;
                          color: #666;
                          cursor: pointer;
                          transition: all 0.2s;
                          min-height: 48px;
                          display: flex;
                          align-items: center;
                          justify-content: center;
                        "
                        onmousedown="this.style.background='#e0e0e0'; this.style.transform='scale(0.95)';"
                        onmouseup="this.style.background='#f5f5f5'; this.style.transform='scale(1)';"
                        onmouseleave="this.style.background='#f5f5f5'; this.style.transform='scale(1)';"
                      >−</button>

                      <!-- Stock Input Field -->
                      <input
                        type="number"
                        inputmode="decimal"
                        id="stock-${item.id}"
                        value="${item.currentStock}"
                        min="0"
                        step="0.25"
                        onblur="autoSaveStockCount(${item.id}, this.value, this)"
                        onchange="autoSaveStockCount(${item.id}, this.value, this)"
                        style="
                          flex: 1;
                          padding: 12px 6px;
                          font-size: 20px;
                          font-weight: 700;
                          text-align: center;
                          border: 2px solid #2e7d32;
                          border-radius: 6px;
                          background: #f9fdf9;
                          color: #2e7d32;
                          box-sizing: border-box;
                          -webkit-appearance: none;
                          -moz-appearance: textfield;
                          min-height: 48px;
                          transition: all 0.2s;
                        "
                        onfocus="this.style.borderColor='#1b5e20'; this.style.background='#ffffff'; this.select();"
                        onblur="this.style.borderColor='#2e7d32'; this.style.background='#f9fdf9';"
                      />

                      <!-- Increment Button -->
                      <button
                        type="button"
                        onclick="quickAdjustStock(${item.id}, 0.25)"
                        style="
                          flex: 0 0 40px;
                          padding: 0;
                          font-size: 22px;
                          font-weight: 700;
                          background: #2e7d32;
                          border: 2px solid #2e7d32;
                          border-radius: 6px;
                          color: white;
                          cursor: pointer;
                          transition: all 0.2s;
                          min-height: 48px;
                          display: flex;
                          align-items: center;
                          justify-content: center;
                        "
                        onmousedown="this.style.background='#1b5e20'; this.style.transform='scale(0.95)';"
                        onmouseup="this.style.background='#2e7d32'; this.style.transform='scale(1)';"
                        onmouseleave="this.style.background='#2e7d32'; this.style.transform='scale(1)';"
                      >+</button>
                    </div>

                    <!-- Save Status Indicator -->
                    <div
                      id="save-status-${item.id}"
                      style="
                        margin-top: 6px;
                        font-size: 11px;
                        text-align: center;
                        min-height: 16px;
                        font-weight: 600;
                        opacity: 0;
                        transition: opacity 0.2s;
                      "
                    ></div>
                  </div>

                  <!-- Par Level Editor -->
                  <div style="margin-top: 14px;">
                    <label style="display: block; font-size: 11px; color: #666; margin-bottom: 6px; font-weight: 500;">
                      Par Level
                    </label>
                    <p style="margin: 0 0 6px 0; font-size: 9px; color: #999; font-style: italic;">
                      ⚠️ Warning: Only edit par level if it is incorrect!
                    </p>
                    <div style="display: flex; gap: 4px; align-items: stretch; max-width: 35%;">
                      <!-- Decrement Button (Smaller) -->
                      <button
                        type="button"
                        onclick="quickAdjustParLevel(${item.id}, -0.25)"
                        style="
                          flex: 0 0 28px;
                          padding: 0;
                          font-size: 16px;
                          font-weight: 700;
                          background: #f5f5f5;
                          border: 2px solid #e0e0e0;
                          border-radius: 6px;
                          color: #666;
                          cursor: pointer;
                          transition: all 0.2s;
                          min-height: 32px;
                          display: flex;
                          align-items: center;
                          justify-content: center;
                        "
                        onmousedown="this.style.background='#e0e0e0'; this.style.transform='scale(0.95)';"
                        onmouseup="this.style.background='#f5f5f5'; this.style.transform='scale(1)';"
                        onmouseleave="this.style.background='#f5f5f5'; this.style.transform='scale(1)';"
                      >−</button>

                      <!-- Par Level Input Field (Smaller) -->
                      <input
                        type="number"
                        inputmode="decimal"
                        id="par-${item.id}"
                        value="${item.parLevel}"
                        min="0"
                        step="0.25"
                        onblur="autoSaveParLevel(${item.id}, this.value, this)"
                        onchange="autoSaveParLevel(${item.id}, this.value, this)"
                        style="
                          flex: 1;
                          padding: 6px 4px;
                          font-size: 14px;
                          font-weight: 600;
                          text-align: center;
                          border: 2px solid #999;
                          border-radius: 6px;
                          background: #ffffff;
                          color: #333;
                          box-sizing: border-box;
                          -webkit-appearance: none;
                          -moz-appearance: textfield;
                          min-height: 32px;
                          transition: all 0.2s;
                        "
                        onfocus="this.style.borderColor='#1976d2'; this.style.background='#f0f9ff'; this.select();"
                        onblur="this.style.borderColor='#999'; this.style.background='#ffffff';"
                      />

                      <!-- Increment Button (Smaller) -->
                      <button
                        type="button"
                        onclick="quickAdjustParLevel(${item.id}, 0.25)"
                        style="
                          flex: 0 0 28px;
                          padding: 0;
                          font-size: 16px;
                          font-weight: 700;
                          background: #1976d2;
                          border: 2px solid #1976d2;
                          border-radius: 6px;
                          color: white;
                          cursor: pointer;
                          transition: all 0.2s;
                          min-height: 32px;
                          display: flex;
                          align-items: center;
                          justify-content: center;
                        "
                        onmousedown="this.style.background='#1565c0'; this.style.transform='scale(0.95)';"
                        onmouseup="this.style.background='#1976d2'; this.style.transform='scale(1)';"
                        onmouseleave="this.style.background='#1976d2'; this.style.transform='scale(1)';"
                      >+</button>
                    </div>

                    <!-- Par Save Status Indicator -->
                    <div
                      id="par-save-status-${item.id}"
                      style="
                        margin-top: 4px;
                        font-size: 10px;
                        text-align: left;
                        min-height: 14px;
                        font-weight: 600;
                        opacity: 0;
                        transition: opacity 0.2s;
                        max-width: 35%;
                      "
                    ></div>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        </div>
      `;
    });

    container.innerHTML = html;
  }

  /**
   * Render PREP items count list (for PREP tab)
   * Shows only PREP category items
   */
  function renderPrepCountList() {
    const container = document.getElementById('prepCountList');
    if (!container) return;

    // Filter to only PREP items
    const prepItems = orderingSystemState.items.filter(item =>
      item.vendor === 'PREP' || item.itemType === 'prep'
    );

    if (prepItems.length === 0) {
      container.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--gray-500); font-size: 13px;">No prep items found. Add prep items using the form above.</p>';
      return;
    }

    // Group items by storage location
    const groupedItems = {};
    prepItems.forEach(item => {
      const area = item.storageLocation || 'No Defined Area';
      if (!groupedItems[area]) {
        groupedItems[area] = [];
      }
      groupedItems[area].push(item);
    });

    // Sort areas alphabetically, but put "No Defined Area" last
    const sortedAreas = Object.keys(groupedItems).sort((a, b) => {
      if (a === 'No Defined Area') return 1;
      if (b === 'No Defined Area') return -1;
      return a.localeCompare(b);
    });

    // Helper functions
    function getStockStatus(currentStock, parLevel) {
      if (parLevel === 0) return { label: 'N/A', color: '#999', bg: '#f5f5f5' };
      const percentage = (currentStock / parLevel) * 100;
      if (percentage < 30) return { label: 'LOW', color: '#d32f2f', bg: '#ffebee' };
      if (percentage < 70) return { label: 'MEDIUM', color: '#f57c00', bg: '#fff3e0' };
      return { label: 'GOOD', color: '#388e3c', bg: '#e8f5e9' };
    }

    function formatLastCounted(dateStr) {
      if (!dateStr) return 'Never';
      const date = new Date(dateStr);
      const now = new Date();
      const diffMs = now - date;
      const diffMinutes = Math.floor(diffMs / (1000 * 60));
      const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
      const diffDays = Math.floor(diffHours / 24);

      // Less than 1 hour: show minutes
      if (diffMinutes < 60) {
        return `${diffMinutes} minute${diffMinutes === 1 ? '' : 's'} ago`;
      }
      
      // Less than 24 hours: show hours and minutes
      if (diffHours < 24) {
        const remainingMinutes = diffMinutes % 60;
        if (remainingMinutes === 0) {
          return `${diffHours} hour${diffHours === 1 ? '' : 's'} ago`;
        }
        return `${diffHours} hour${diffHours === 1 ? '' : 's'} and ${remainingMinutes} minute${remainingMinutes === 1 ? '' : 's'} ago`;
      }
      
      // Less than 7 days: show days, hours, and minutes
      if (diffDays < 7) {
        const remainingHours = diffHours % 24;
        const remainingMinutes = diffMinutes % 60;
        let result = `${diffDays} day${diffDays === 1 ? '' : 's'}`;
        if (remainingHours > 0) {
          result += `, ${remainingHours} hour${remainingHours === 1 ? '' : 's'}`;
        }
        if (remainingMinutes > 0) {
          result += `, ${remainingMinutes} minute${remainingMinutes === 1 ? '' : 's'}`;
        }
        return result + ' ago';
      }
      
      // 7+ days: show date
      return date.toLocaleDateString('en-US', { month: 'numeric', day: 'numeric', year: '2-digit' });
    }

    let html = '';

    // Render each area group
    sortedAreas.forEach((area, areaIndex) => {
      const areaItems = groupedItems[area];

      html += `
        <div style="margin-bottom: ${areaIndex < sortedAreas.length - 1 ? '32px' : '20px'};">
          <h4 style="background: var(--gray-700); color: var(--white); padding: 12px 16px; border-radius: 0; margin-bottom: 12px; font-size: 14px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;">
            ${area.toUpperCase()} <span style="opacity: 0.85; font-weight: 400; font-size: 12px;">(${areaItems.length})</span>
          </h4>

          <!-- Single column layout for all screens -->
          <div style="display: flex; flex-direction: column; gap: ${isCompactMode ? '8px' : '10px'};">
            ${areaItems.map((item) => {
            const status = getStockStatus(item.currentStock, item.parLevel);
            const lastCounted = formatLastCounted(item.lastCountedDate);

            return `
              <div style="
                background: var(--white);
                border: 2px solid var(--gray-300);
                border-radius: 0;
                padding: ${isCompactMode ? '10px' : '14px'};
                box-shadow: 0 1px 3px rgba(0,0,0,0.08);
                transition: box-shadow 0.2s;
              "
              onmouseover="this.style.boxShadow='0 2px 8px rgba(0,0,0,0.12)'"
              onmouseout="this.style.boxShadow='0 1px 3px rgba(0,0,0,0.08)'">

                <!-- Header: Item Name + Status Badge -->
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: ${isCompactMode ? '4px' : '6px'}; gap: 8px;">
                  <div style="flex: 1;">
                    <div style="font-weight: 700; font-size: ${isCompactMode ? '14px' : '15px'}; line-height: 1.3; color: var(--gray-900); text-transform: uppercase; letter-spacing: 0.5px;">
                      ${item.itemName}
                    </div>
                    <div style="margin-top: 4px;">
                      <a href="javascript:void(0)"
                         onclick="showAreaSelector(${item.id}, '${(item.storageLocation || '').replace(/'/g, "\\'")}', event)"
                         style="
                           color: #1976d2;
                           font-size: 10px;
                           font-style: italic;
                           text-decoration: none;
                           cursor: pointer;
                           opacity: 0.85;
                         "
                         onmouseover="this.style.opacity='1'; this.style.textDecoration='underline'"
                         onmouseout="this.style.opacity='0.85'; this.style.textDecoration='none'">
                        ${item.storageLocation || 'No defined area'}
                      </a>
                    </div>
                  </div>
                  <div style="
                    background: ${status.bg};
                    color: ${status.color};
                    padding: ${isCompactMode ? '3px 8px' : '4px 10px'};
                    border-radius: 0;
                    font-size: ${isCompactMode ? '10px' : '11px'};
                    font-weight: 700;
                    white-space: nowrap;
                    letter-spacing: 0.3px;
                  ">
                    ${status.label}
                  </div>
                </div>

                <!-- Metadata Row -->
                <div style="
                  display: flex;
                  gap: ${isCompactMode ? '12px' : '16px'};
                  margin-bottom: ${isCompactMode ? '8px' : '12px'};
                  font-size: ${isCompactMode ? '12px' : '13px'};
                  color: var(--gray-600);
                ">
                  <div>
                    <span style="color: var(--gray-500);">Unit:</span> <strong>${item.unit}</strong>
                  </div>
                  <div>
                    <span style="color: var(--gray-500);">Par:</span> <strong>${item.parLevel}</strong>
                  </div>
                  ${item.batchLifespan ? `<div><span style="color: var(--gray-500);">Life:</span> <strong>${item.batchLifespan}h</strong></div>` : ''}
                  <div style="margin-left: auto; color: var(--gray-500); font-size: ${isCompactMode ? '11px' : '12px'};">
                    ${lastCounted}
                  </div>
                </div>

                <!-- Stock Input with Quick Adjustments -->
                <div>
                  <label style="display: block; font-size: 12px; color: var(--gray-600); margin-bottom: 6px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">
                    Current Stock
                  </label>
                  <div style="display: flex; gap: 5px; align-items: stretch;">
                    <!-- Decrement Button -->
                    <button
                      type="button"
                      onclick="quickAdjustStock(${item.id}, -0.25)"
                      style="
                        flex: 0 0 40px;
                        padding: 0;
                        font-size: 22px;
                        font-weight: 700;
                        background: var(--gray-100);
                        border: 2px solid var(--gray-300);
                        border-radius: 0;
                        color: var(--gray-700);
                        cursor: pointer;
                        transition: all 0.2s;
                        min-height: 48px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                      "
                      onmousedown="this.style.background='var(--gray-300)'; this.style.transform='scale(0.95)';"
                      onmouseup="this.style.background='var(--gray-100)'; this.style.transform='scale(1)';"
                      onmouseleave="this.style.background='var(--gray-100)'; this.style.transform='scale(1)';"
                    >−</button>

                    <!-- Stock Input Field -->
                    <input
                      type="number"
                      inputmode="decimal"
                      id="stock-${item.id}"
                      value="${item.currentStock}"
                      min="0"
                      step="0.25"
                      onblur="autoSaveStockCount(${item.id}, this.value, this)"
                      onchange="autoSaveStockCount(${item.id}, this.value, this)"
                      style="
                        flex: 1;
                        padding: 12px 6px;
                        font-size: 20px;
                        font-weight: 700;
                        text-align: center;
                        border: 2px solid var(--gray-700);
                        border-radius: 0;
                        background: var(--gray-100);
                        color: var(--gray-900);
                        box-sizing: border-box;
                        -webkit-appearance: none;
                        -moz-appearance: textfield;
                        min-height: 48px;
                        transition: all 0.2s;
                      "
                      onfocus="this.style.borderColor='var(--gray-900)'; this.style.background='var(--white)'; this.select();"
                      onblur="this.style.borderColor='var(--gray-700)'; this.style.background='var(--gray-100)';"
                    />

                    <!-- Increment Button -->
                    <button
                      type="button"
                      onclick="quickAdjustStock(${item.id}, 0.25)"
                      style="
                        flex: 0 0 40px;
                        padding: 0;
                        font-size: 22px;
                        font-weight: 700;
                        background: var(--gray-700);
                        border: 2px solid var(--gray-700);
                        border-radius: 0;
                        color: var(--white);
                        cursor: pointer;
                        transition: all 0.2s;
                        min-height: 48px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                      "
                      onmousedown="this.style.background='var(--gray-900)'; this.style.transform='scale(0.95)';"
                      onmouseup="this.style.background='var(--gray-700)'; this.style.transform='scale(1)';"
                      onmouseleave="this.style.background='var(--gray-700)'; this.style.transform='scale(1)';"
                    >+</button>
                  </div>

                  <!-- Save Status Indicator -->
                  <div
                    id="save-status-${item.id}"
                    style="
                      margin-top: 6px;
                      font-size: 11px;
                      text-align: center;
                      min-height: 16px;
                      font-weight: 600;
                      opacity: 0;
                      transition: opacity 0.2s;
                    "
                  ></div>
                </div>

                <!-- Par Level Editor -->
                <div style="margin-top: 16px;">
                  <label style="display: block; font-size: 11px; color: var(--gray-600); margin-bottom: 6px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">
                    Par Level
                  </label>
                  <p style="margin: 0 0 6px 0; font-size: 9px; color: var(--gray-500); font-style: italic;">
                    ⚠️ Warning: Only edit par level if it is incorrect!
                  </p>
                  <div style="display: flex; gap: 4px; align-items: stretch; max-width: 35%;">
                    <!-- Decrement Button (Smaller) -->
                    <button
                      type="button"
                      onclick="quickAdjustParLevel(${item.id}, -0.25)"
                      style="
                        flex: 0 0 28px;
                        padding: 0;
                        font-size: 16px;
                        font-weight: 700;
                        background: var(--gray-100);
                        border: 2px solid var(--gray-300);
                        border-radius: 0;
                        color: var(--gray-700);
                        cursor: pointer;
                        transition: all 0.2s;
                        min-height: 32px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                      "
                      onmousedown="this.style.background='var(--gray-300)'; this.style.transform='scale(0.95)';"
                      onmouseup="this.style.background='var(--gray-100)'; this.style.transform='scale(1)';"
                      onmouseleave="this.style.background='var(--gray-100)'; this.style.transform='scale(1)';"
                    >−</button>

                    <!-- Par Level Input Field (Smaller) -->
                    <input
                      type="number"
                      inputmode="decimal"
                      id="par-${item.id}"
                      value="${item.parLevel}"
                      min="0"
                      step="0.25"
                      onblur="autoSaveParLevel(${item.id}, this.value, this)"
                      onchange="autoSaveParLevel(${item.id}, this.value, this)"
                      style="
                        flex: 1;
                        padding: 6px 4px;
                        font-size: 14px;
                        font-weight: 600;
                        text-align: center;
                        border: 2px solid var(--gray-400);
                        border-radius: 0;
                        background: var(--white);
                        color: var(--gray-900);
                        box-sizing: border-box;
                        -webkit-appearance: none;
                        -moz-appearance: textfield;
                        min-height: 32px;
                        transition: all 0.2s;
                      "
                      onfocus="this.style.borderColor='var(--gray-900)'; this.style.background='#f0f9ff'; this.select();"
                      onblur="this.style.borderColor='var(--gray-400)'; this.style.background='var(--white)';"
                    />

                    <!-- Increment Button (Smaller) -->
                    <button
                      type="button"
                      onclick="quickAdjustParLevel(${item.id}, 0.25)"
                      style="
                        flex: 0 0 28px;
                        padding: 0;
                        font-size: 16px;
                        font-weight: 700;
                        background: var(--gray-600);
                        border: 2px solid var(--gray-600);
                        border-radius: 0;
                        color: var(--white);
                        cursor: pointer;
                        transition: all 0.2s;
                        min-height: 32px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                      "
                      onmousedown="this.style.background='var(--gray-800)'; this.style.transform='scale(0.95)';"
                      onmouseup="this.style.background='var(--gray-600)'; this.style.transform='scale(1)';"
                      onmouseleave="this.style.background='var(--gray-600)'; this.style.transform='scale(1)';"
                    >+</button>
                  </div>

                  <!-- Par Save Status Indicator -->
                  <div
                    id="par-save-status-${item.id}"
                    style="
                      margin-top: 4px;
                      font-size: 10px;
                      text-align: left;
                      min-height: 14px;
                      font-weight: 600;
                      opacity: 0;
                      transition: opacity 0.2s;
                      max-width: 35%;
                    "
                  ></div>
                </div>

                <!-- Urgent Checkbox -->
                <div style="margin-top: 10px; padding-top: 10px; border-top: 2px solid var(--gray-200); display: flex; align-items: center; gap: 6px;">
                  <input
                    type="checkbox"
                    id="urgent-${item.id}"
                    ${item.urgent ? 'checked' : ''}
                    onchange="toggleUrgent(${item.id}, this.checked)"
                    style="width: 14px; height: 14px; cursor: pointer;"
                  />
                  <label for="urgent-${item.id}" style="font-size: 11px; font-weight: 600; color: var(--gray-600); text-transform: uppercase; letter-spacing: 0.3px; cursor: pointer;">
                    MAKE FIRST (URGENT)
                  </label>
                </div>

                <!-- Line Cooks Prep Checkbox -->
                <div style="margin-top: 6px; display: flex; align-items: center; gap: 6px;">
                  <input
                    type="checkbox"
                    id="line-cooks-prep-${item.id}"
                    ${item.lineCooksPrep ? 'checked' : ''}
                    onchange="toggleLineCooksPrep(${item.id}, this.checked)"
                    style="width: 14px; height: 14px; cursor: pointer;"
                  />
                  <label for="line-cooks-prep-${item.id}" style="font-size: 11px; font-weight: 600; color: var(--gray-600); text-transform: uppercase; letter-spacing: 0.3px; cursor: pointer;">
                    LINE COOKS PREP
                  </label>
                </div>

                <!-- Not Made Daily Checkbox -->
                <div style="margin-top: 6px; display: flex; align-items: center; gap: 6px;">
                  <input
                    type="checkbox"
                    id="not-made-daily-${item.id}"
                    ${item.notMadeDaily ? 'checked' : ''}
                    onchange="toggleNotMadeDaily(${item.id}, this.checked)"
                    style="width: 14px; height: 14px; cursor: pointer;"
                  />
                  <label for="not-made-daily-${item.id}" style="font-size: 11px; font-weight: 600; color: var(--gray-600); text-transform: uppercase; letter-spacing: 0.3px; cursor: pointer;">
                    NOT MADE DAILY
                  </label>
                </div>

                <!-- Show in Bottle Count Checkbox -->
                <div style="margin-top: 6px; display: flex; align-items: center; gap: 6px;">
                  <input
                    type="checkbox"
                    id="bottle-count-${item.id}"
                    ${item.showInBottleCount ? 'checked' : ''}
                    onchange="toggleBottleCount(${item.id}, this.checked)"
                    style="width: 14px; height: 14px; cursor: pointer;"
                  />
                  <label for="bottle-count-${item.id}" style="font-size: 11px; font-weight: 600; color: var(--gray-600); text-transform: uppercase; letter-spacing: 0.3px; cursor: pointer;">
                    SHOW IN BOTTLE COUNT
                  </label>
                </div>
              </div>
            `;
            }).join('')}
          </div>
        </div>
      `;
    });

    container.innerHTML = html;
  }

  /**
   * Filter inventory list based on search and vendor
   */
  function filterInventoryList() {
    const searchTerm = document.getElementById('inventorySearchInput').value.toLowerCase();
    const selectedVendor = document.getElementById('inventoryVendorFilter').value;

    // Filter items
    const filteredItems = orderingSystemState.items.filter(item => {
      const matchesSearch = item.itemName.toLowerCase().includes(searchTerm);
      const matchesVendor = !selectedVendor || item.vendor === selectedVendor;
      return matchesSearch && matchesVendor;
    });

    // Re-render with filtered items
    renderFilteredInventoryList(filteredItems);
  }

  /**
   * Render filtered inventory list (SAME CLEAN FORMAT AS UNFILTERED)
   */
  function renderFilteredInventoryList(filteredItems) {
    const container = document.getElementById('inventoryList');

    if (filteredItems.length === 0) {
      container.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--gray-500);">No items match your search.</p>';
      return;
    }

    // Group by vendor
    const itemsByVendor = {};
    filteredItems.forEach(item => {
      if (!itemsByVendor[item.vendor]) {
        itemsByVendor[item.vendor] = [];
      }
      itemsByVendor[item.vendor].push(item);
    });

    let html = '';
    sortVendorsWithPrepFirst(Object.keys(itemsByVendor)).forEach(vendor => {
      const items = itemsByVendor[vendor];
      const isPrepCategory = vendor === 'PREP';
      const headerColor = isPrepCategory ? '#212121' : 'var(--gray-700)';

      html += `
        <div style="margin-bottom: 24px;">
          <h4 style="background: ${headerColor}; color: white; padding: 12px 16px; border-radius: 0; margin-bottom: 0; font-size: 14px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;">
            ${vendor} <span style="opacity: 0.7; font-weight: 400; font-size: 12px;">(${items.length})</span>
          </h4>
          <div style="background: white; border: 2px solid var(--gray-300); border-top: none;">
            ${items.map((item, i) => `
              <div
                style="
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  padding: 12px 16px;
                  border-bottom: 1px solid var(--gray-200);
                  transition: background 0.2s;
                  background: ${i % 2 === 0 ? 'white' : '#f9fafb'};
                "
                onmouseover="this.style.background='#f3f4f6'"
                onmouseout="this.style.background='${i % 2 === 0 ? 'white' : '#f9fafb'}'"
              >
                <div style="flex: 1; font-size: 14px; font-weight: 600; color: var(--gray-900);">
                  ${item.itemName}
                </div>
                <button
                  onclick="openEditItemModal(${item.id}); return false;"
                  style="
                    background: var(--gray-100);
                    border: 2px solid var(--gray-300);
                    border-radius: 4px;
                    padding: 8px 12px;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    gap: 6px;
                    color: var(--gray-700);
                    font-size: 12px;
                    font-weight: 700;
                    text-transform: uppercase;
                    letter-spacing: 0.5px;
                    transition: all 0.2s;
                  "
                  onmouseover="this.style.background='var(--gray-700)'; this.style.color='var(--white)'; this.style.borderColor='var(--gray-700)';"
                  onmouseout="this.style.background='var(--gray-100)'; this.style.color='var(--gray-700)'; this.style.borderColor='var(--gray-300)';"
                >
                  <span style="font-size: 16px;">✏️</span>
                  <span>Edit</span>
                </button>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    });

    container.innerHTML = html;
  }

  /**
   * Filter stock count list based on search and vendor
   */
  function filterStockCountList() {
    const searchTerm = document.getElementById('stockCountSearchInput').value.toLowerCase();
    const selectedVendor = document.getElementById('stockCountVendorFilter').value;

    // Filter items
    const filteredItems = orderingSystemState.items.filter(item => {
      const matchesSearch = item.itemName.toLowerCase().includes(searchTerm);
      const matchesVendor = !selectedVendor || item.vendor === selectedVendor;
      return matchesSearch && matchesVendor;
    });

    // Re-render with filtered items
    renderFilteredStockCountList(filteredItems);
  }

  /**
   * Render filtered stock count list
   */
  function renderFilteredStockCountList(filteredItems) {
    const container = document.getElementById('stockCountList');

    if (filteredItems.length === 0) {
      container.innerHTML = '<p style="text-align: center; padding: 20px; color: #999;">No items match your search.</p>';
      return;
    }

    // Helper function to get stock status
    function getStockStatus(currentStock, parLevel) {
      if (parLevel === 0) return { label: 'N/A', color: 'var(--gray-600)', bg: 'var(--gray-100)' };
      const percentage = (currentStock / parLevel) * 100;
      if (percentage < 30) return { label: 'LOW', color: '#d32f2f', bg: '#ffebee' }; // Keep red for warnings
      if (percentage < 70) return { label: 'MEDIUM', color: 'var(--gray-700)', bg: 'var(--gray-200)' };
      return { label: 'GOOD', color: '#2e7d32', bg: '#e8f5e9' }; // Keep green for success
    }

    // Helper function to format last counted date
    function formatLastCounted(dateStr) {
      if (!dateStr) return 'Never';
      const date = new Date(dateStr);
      const now = new Date();
      const diffMs = now - date;
      const diffMinutes = Math.floor(diffMs / (1000 * 60));
      const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
      const diffDays = Math.floor(diffHours / 24);

      // Less than 1 hour: show minutes
      if (diffMinutes < 60) {
        return `${diffMinutes} minute${diffMinutes === 1 ? '' : 's'} ago`;
      }
      
      // Less than 24 hours: show hours and minutes
      if (diffHours < 24) {
        const remainingMinutes = diffMinutes % 60;
        if (remainingMinutes === 0) {
          return `${diffHours} hour${diffHours === 1 ? '' : 's'} ago`;
        }
        return `${diffHours} hour${diffHours === 1 ? '' : 's'} and ${remainingMinutes} minute${remainingMinutes === 1 ? '' : 's'} ago`;
      }
      
      // Less than 7 days: show days, hours, and minutes
      if (diffDays < 7) {
        const remainingHours = diffHours % 24;
        const remainingMinutes = diffMinutes % 60;
        let result = `${diffDays} day${diffDays === 1 ? '' : 's'}`;
        if (remainingHours > 0) {
          result += `, ${remainingHours} hour${remainingHours === 1 ? '' : 's'}`;
        }
        if (remainingMinutes > 0) {
          result += `, ${remainingMinutes} minute${remainingMinutes === 1 ? '' : 's'}`;
        }
        return result + ' ago';
      }
      
      // 7+ days: show date
      return date.toLocaleDateString('en-US', { month: 'numeric', day: 'numeric', year: '2-digit' });
    }

    // Group by vendor
    const itemsByVendor = {};
    filteredItems.forEach(item => {
      if (!itemsByVendor[item.vendor]) {
        itemsByVendor[item.vendor] = [];
      }
      itemsByVendor[item.vendor].push(item);
    });

    let html = '';
    sortVendorsWithPrepFirst(Object.keys(itemsByVendor)).forEach(vendor => {
      const items = itemsByVendor[vendor];
      const isPrepCategory = vendor === 'PREP';
      const headerColor = isPrepCategory ? '#212121' : 'var(--gray-700)'; // Grayscale throughout
      html += `
        <div style="margin-bottom: 30px;">
          <h4 style="background: ${headerColor}; color: white; padding: 12px 16px; border-radius: 0; margin-bottom: 12px; font-size: 14px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;">
            ${vendor} <span style="opacity: 0.7; font-weight: 400; font-size: 12px;">(${items.length})</span>
          </h4>

          <!-- Single column layout for all screens -->
          <div style="display: flex; flex-direction: column; gap: ${isCompactMode ? '8px' : '10px'};">
            ${items.map((item) => {
              const status = getStockStatus(item.currentStock, item.parLevel);
              const lastCounted = formatLastCounted(item.lastCountedDate);

              return `
                <div style="
                  background: white;
                  border: 1px solid #e0e0e0;
                  border-radius: ${isCompactMode ? '6px' : '8px'};
                  padding: ${isCompactMode ? '10px' : '14px'};
                  box-shadow: 0 1px 3px rgba(0,0,0,0.08);
                  transition: box-shadow 0.2s;
                "
                onmouseover="this.style.boxShadow='0 2px 8px rgba(0,0,0,0.12)'"
                onmouseout="this.style.boxShadow='0 1px 3px rgba(0,0,0,0.08)'">

                  <!-- Header: Item Name + Status Badge -->
                  <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: ${isCompactMode ? '8px' : '12px'}; gap: 8px;">
                    <div style="flex: 1; font-weight: 600; font-size: ${isCompactMode ? '14px' : '15px'}; line-height: 1.3; color: #333;">
                      ${item.itemName}
                    </div>
                    <div style="
                      background: ${status.bg};
                      color: ${status.color};
                      padding: ${isCompactMode ? '3px 8px' : '4px 10px'};
                      border-radius: 12px;
                      font-size: ${isCompactMode ? '10px' : '11px'};
                      font-weight: 700;
                      white-space: nowrap;
                      letter-spacing: 0.3px;
                    ">
                      ${status.label}
                    </div>
                  </div>

                  <!-- Metadata Row -->
                  <div style="
                    display: flex;
                    gap: ${isCompactMode ? '12px' : '16px'};
                    margin-bottom: ${isCompactMode ? '8px' : '12px'};
                    font-size: ${isCompactMode ? '12px' : '13px'};
                    color: #666;
                  ">
                    <div>
                      <span style="color: #999;">Unit:</span> <strong>${item.unit}</strong>
                    </div>
                    <div>
                      <span style="color: #999;">Par:</span> <strong>${item.parLevel}</strong>
                    </div>
                    <div style="margin-left: auto; color: #999; font-size: ${isCompactMode ? '11px' : '12px'};">
                      ${lastCounted}
                    </div>
                  </div>

                  ${item.lastInvoiceQty && item.lastInvoiceDate ? `
                  <!-- Invoice Addition Info -->
                  <div style="
                    margin-top: 8px;
                    margin-bottom: 12px;
                    padding: 8px 10px;
                    background: var(--blue-bg);
                    border-left: 3px solid var(--blue-text);
                    border-radius: 0;
                    font-size: ${isCompactMode ? '11px' : '12px'};
                    color: var(--blue-text);
                    font-weight: 600;
                    font-style: italic;
                  ">
                    ${item.lastInvoiceQty} ADDED VIA INVOICE ON ${formatPacificDateDisplay(new Date(item.lastInvoiceDate), {
                      month: 'short',
                      day: 'numeric',
                      year: 'numeric',
                      hour: 'numeric',
                      minute: '2-digit',
                      hour12: true
                    })}
                  </div>
                  ` : ''}

                  <!-- Stock Input with Quick Adjustments (Mobile-Optimized) -->
                  <div>
                    <label style="display: block; font-size: 12px; color: #666; margin-bottom: 6px; font-weight: 500;">
                      Current Stock
                    </label>
                    <!-- Input with Stepper Buttons -->
                    <div style="display: flex; gap: 5px; align-items: stretch;">
                      <!-- Decrement Button -->
                      <button
                        type="button"
                        onclick="quickAdjustStock(${item.id}, -0.25)"
                        style="
                          flex: 0 0 40px;
                          padding: 0;
                          font-size: 22px;
                          font-weight: 700;
                          background: #f5f5f5;
                          border: 2px solid #e0e0e0;
                          border-radius: 6px;
                          color: #666;
                          cursor: pointer;
                          transition: all 0.2s;
                          min-height: 48px;
                          display: flex;
                          align-items: center;
                          justify-content: center;
                        "
                        onmousedown="this.style.background='#e0e0e0'; this.style.transform='scale(0.95)';"
                        onmouseup="this.style.background='#f5f5f5'; this.style.transform='scale(1)';"
                        onmouseleave="this.style.background='#f5f5f5'; this.style.transform='scale(1)';"
                      >−</button>

                      <!-- Stock Input Field -->
                      <input
                        type="number"
                        inputmode="decimal"
                        id="stock-${item.id}"
                        value="${item.currentStock}"
                        min="0"
                        step="0.25"
                        onblur="autoSaveStockCount(${item.id}, this.value, this)"
                        onchange="autoSaveStockCount(${item.id}, this.value, this)"
                        style="
                          flex: 1;
                          padding: 12px 6px;
                          font-size: 20px;
                          font-weight: 700;
                          text-align: center;
                          border: 2px solid #2e7d32;
                          border-radius: 6px;
                          background: #f9fdf9;
                          color: #2e7d32;
                          box-sizing: border-box;
                          -webkit-appearance: none;
                          -moz-appearance: textfield;
                          min-height: 48px;
                          transition: all 0.2s;
                        "
                        onfocus="this.style.borderColor='#1b5e20'; this.style.background='#ffffff'; this.select();"
                        onblur="this.style.borderColor='#2e7d32'; this.style.background='#f9fdf9';"
                      />

                      <!-- Increment Button -->
                      <button
                        type="button"
                        onclick="quickAdjustStock(${item.id}, 0.25)"
                        style="
                          flex: 0 0 40px;
                          padding: 0;
                          font-size: 22px;
                          font-weight: 700;
                          background: #2e7d32;
                          border: 2px solid #2e7d32;
                          border-radius: 6px;
                          color: white;
                          cursor: pointer;
                          transition: all 0.2s;
                          min-height: 48px;
                          display: flex;
                          align-items: center;
                          justify-content: center;
                        "
                        onmousedown="this.style.background='#1b5e20'; this.style.transform='scale(0.95)';"
                        onmouseup="this.style.background='#2e7d32'; this.style.transform='scale(1)';"
                        onmouseleave="this.style.background='#2e7d32'; this.style.transform='scale(1)';"
                      >+</button>
                    </div>

                    <!-- Save Status Indicator -->
                    <div
                      id="save-status-${item.id}"
                      style="
                        margin-top: 6px;
                        font-size: 11px;
                        text-align: center;
                        min-height: 16px;
                        font-weight: 600;
                        opacity: 0;
                        transition: opacity 0.2s;
                      "
                    ></div>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        </div>
      `;
    });

    container.innerHTML = html;
  }

  /**
   * Update current count session and create/update session record
   */
  /**
   * Automatically detect current count session based on time of day
   * Before 3pm = Morning Prep
   * 3pm-8pm = Afternoon Prep
   * After 8pm = Closing Line
   */
  function getAutomaticCountSession() {
    const now = new Date();
    const hour = getPacificHour(now);
    const effectiveHour = (hour === null || Number.isNaN(hour)) ? now.getHours() : hour;

    if (effectiveHour < 15) { // Before 3pm Pacific
      return {
        value: 'morning_prep',
        name: 'Morning Prep',
        icon: '🌅',
        time: '7:00 AM - 3:00 PM'
      };
    } else if (effectiveHour < 20) { // 3pm-8pm Pacific
      return {
        value: 'afternoon_prep',
        name: 'Afternoon Prep',
        icon: '☀️',
        time: '3:00 PM - 8:00 PM'
      };
    } else { // After 8pm
      return {
        value: 'closing_line',
        name: 'Closing Line',
        icon: '🌙',
        time: 'After 8:00 PM'
      };
    }
  }

  /**
   * Update count session display and fetch completion stats
   */
  async function updateCountSessionDisplay() {
    const session = getAutomaticCountSession();

    // Update current session display
    document.getElementById('currentSessionIcon').textContent = session.icon;
    document.getElementById('currentSessionName').textContent = session.name;
    document.getElementById('currentSessionTime').textContent = session.time;

    // Update orderingSystemState
    orderingSystemState.currentCountSession = session.value;

    // Fetch and display completion stats
    await fetchAndDisplaySessionStats(session.value);

    // Update session record in database
    const today = getPacificDate();
    try {
      await supabase
        .from('prep_count_sessions')
        .upsert({
          count_date: today,
          session_type: session.value,
          session_timestamp: new Date().toISOString(),
          notes: 'Auto-detected session'
        }, {
          onConflict: 'count_date,session_type'
        });
    } catch (error) {
      console.error('Failed to update session record:', error);
    }
  }

  /**
   * Fetch and display completion stats for previous count sessions
   */
  async function fetchAndDisplaySessionStats(currentSession) {
    const today = getPacificDate();
    const yesterday = formatPacificDate(addPacificDays(getPacificMidday(new Date()), -1));
    const statsContainer = document.getElementById('sessionCompletionStats');

    try {
      // Fetch PREP items with their names and stock levels for detail view
      const { data: prepItems, error } = await supabase
        .from('inventory_items')
        .select('id, item_name, last_counted_date, current_stock, item_type, vendor')
        .or('item_type.eq.prep,vendor.eq.PREP');

      if (error) throw error;

      // Group items by session (with full details for expandable view)
      const yesterdayClosingItems = prepItems.filter(item => {
        if (!item.last_counted_date) return false;
        const lastCounted = new Date(item.last_counted_date);
        const countDate = formatPacificDate(lastCounted);
        const hour = getPacificHour(lastCounted);
        return countDate === yesterday && hour !== null && hour >= 20; // Yesterday after 8pm
      });

      const morningItems = prepItems.filter(item => {
        if (!item.last_counted_date) return false;
        const lastCounted = new Date(item.last_counted_date);
        const isToday = formatPacificDate(lastCounted) === today;
        const hour = getPacificHour(lastCounted);
        return isToday && hour !== null && hour < 15; // Before 3pm Pacific
      });

      const afternoonItems = prepItems.filter(item => {
        if (!item.last_counted_date) return false;
        const lastCounted = new Date(item.last_counted_date);
        const isToday = formatPacificDate(lastCounted) === today;
        const hour = getPacificHour(lastCounted);
        return isToday && hour !== null && hour >= 15 && hour < 20; // 3pm-8pm Pacific
      });

      const closingItems = prepItems.filter(item => {
        if (!item.last_counted_date) return false;
        const lastCounted = new Date(item.last_counted_date);
        const isToday = formatPacificDate(lastCounted) === today;
        const hour = getPacificHour(lastCounted);
        return isToday && hour !== null && hour >= 20; // After 8pm Pacific
      });

      // Build status message based on current session
      let statusHTML = '';

      if (currentSession === 'morning_prep') {
        // Morning: Show yesterday's closing line count
        if (yesterdayClosingItems.length > 0) {
          statusHTML = `
            <div style="cursor: pointer; padding: 8px; background: var(--white); border: 1px solid var(--gray-300); border-radius: 4px; margin-bottom: 4px;" onclick="toggleSessionDetails('yesterday-closing')">
              <strong>${yesterdayClosingItems.length}</strong> prep items counted during Yesterday's Closing Line
              <span id="toggle-yesterday-closing" style="float: right; font-size: 10px;">▼ Show Details</span>
            </div>
            <div id="details-yesterday-closing" style="display: none; padding: 12px; background: var(--gray-50); border: 1px solid var(--gray-200); margin-top: 4px; font-size: 11px; max-height: 200px; overflow-y: auto;">
              ${yesterdayClosingItems.map(item => `
                <div style="display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid var(--gray-200);">
                  <span>${item.item_name}</span>
                  <span style="font-weight: 600;">${item.current_stock || 0} ${orderingSystemState.items.find(i => i.id === item.id)?.unit || ''}</span>
                </div>
              `).join('')}
            </div>
          `;
        } else {
          statusHTML = '<div style="color: var(--gray-500); font-style: italic;">No items counted during yesterday\'s Closing Line</div>';
        }
      } else if (currentSession === 'afternoon_prep') {
        // Afternoon: Show morning count
        if (morningItems.length > 0) {
          statusHTML = `
            <div style="cursor: pointer; padding: 8px; background: var(--white); border: 1px solid var(--gray-300); border-radius: 4px; margin-bottom: 4px;" onclick="toggleSessionDetails('morning')">
              <strong>${morningItems.length}</strong> prep items counted during Morning Prep
              <span id="toggle-morning" style="float: right; font-size: 10px;">▼ Show Details</span>
            </div>
            <div id="details-morning" style="display: none; padding: 12px; background: var(--gray-50); border: 1px solid var(--gray-200); margin-top: 4px; font-size: 11px; max-height: 200px; overflow-y: auto;">
              ${morningItems.map(item => `
                <div style="display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid var(--gray-200);">
                  <span>${item.item_name}</span>
                  <span style="font-weight: 600;">${item.current_stock || 0} ${orderingSystemState.items.find(i => i.id === item.id)?.unit || ''}</span>
                </div>
              `).join('')}
            </div>
          `;
        } else {
          statusHTML = '<div style="color: var(--gray-500); font-style: italic;">No items counted during Morning Prep</div>';
        }
      } else { // closing_line
        // Closing: Show both morning and afternoon
        const sections = [];
        
        if (morningItems.length > 0) {
          sections.push(`
            <div style="cursor: pointer; padding: 8px; background: var(--white); border: 1px solid var(--gray-300); border-radius: 4px; margin-bottom: 4px;" onclick="toggleSessionDetails('morning-closing')">
              <strong>${morningItems.length}</strong> prep items counted during Morning Prep
              <span id="toggle-morning-closing" style="float: right; font-size: 10px;">▼ Show Details</span>
            </div>
            <div id="details-morning-closing" style="display: none; padding: 12px; background: var(--gray-50); border: 1px solid var(--gray-200); margin-top: 4px; margin-bottom: 8px; font-size: 11px; max-height: 200px; overflow-y: auto;">
              ${morningItems.map(item => `
                <div style="display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid var(--gray-200);">
                  <span>${item.item_name}</span>
                  <span style="font-weight: 600;">${item.current_stock || 0} ${orderingSystemState.items.find(i => i.id === item.id)?.unit || ''}</span>
                </div>
              `).join('')}
            </div>
          `);
        }
        
        if (afternoonItems.length > 0) {
          sections.push(`
            <div style="cursor: pointer; padding: 8px; background: var(--white); border: 1px solid var(--gray-300); border-radius: 4px; margin-bottom: 4px;" onclick="toggleSessionDetails('afternoon')">
              <strong>${afternoonItems.length}</strong> prep items counted during Afternoon Prep
              <span id="toggle-afternoon" style="float: right; font-size: 10px;">▼ Show Details</span>
            </div>
            <div id="details-afternoon" style="display: none; padding: 12px; background: var(--gray-50); border: 1px solid var(--gray-200); margin-top: 4px; font-size: 11px; max-height: 200px; overflow-y: auto;">
              ${afternoonItems.map(item => `
                <div style="display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid var(--gray-200);">
                  <span>${item.item_name}</span>
                  <span style="font-weight: 600;">${item.current_stock || 0} ${orderingSystemState.items.find(i => i.id === item.id)?.unit || ''}</span>
                </div>
              `).join('')}
            </div>
          `);
        }
        
        if (sections.length === 0) {
          statusHTML = '<div style="color: var(--gray-500); font-style: italic;">No prep counts completed today</div>';
        } else {
          statusHTML = sections.join('');
        }
      }

      statsContainer.innerHTML = statusHTML;

    } catch (error) {
      console.error('Error fetching session stats:', error);
      statsContainer.innerHTML = '<div style="color: var(--gray-500); font-style: italic;">Unable to load count statistics</div>';
    }
  }

  /**
   * Toggle visibility of session detail items
   */
  function toggleSessionDetails(sessionId) {
    const detailsDiv = document.getElementById(`details-${sessionId}`);
    const toggleSpan = document.getElementById(`toggle-${sessionId}`);
    
    if (detailsDiv && toggleSpan) {
      if (detailsDiv.style.display === 'none') {
        detailsDiv.style.display = 'block';
        toggleSpan.textContent = '▲ Hide Details';
      } else {
        detailsDiv.style.display = 'none';
        toggleSpan.textContent = '▼ Show Details';
      }
    }
  }

  /**
   * Legacy function - kept for compatibility
   */
  async function updateCountSession() {
    // This function is now handled automatically by updateCountSessionDisplay()
    await updateCountSessionDisplay();
  }

  /**
   * Track stock updates before saving (legacy - kept for compatibility)
   */
  function trackStockUpdate(itemId, newValue) {
    orderingSystemState.pendingStockUpdates.set(itemId, parseInt(newValue));
    console.log('Tracked stock update:', itemId, newValue);
  }

  /**
   * Auto-save stock count when input loses focus
   */
  async function autoSaveStockCount(itemId, newValue, inputElement) {
    const stockValue = parseFloat(newValue); // Support decimal counts (0.25, 0.5, 0.75)
    if (isNaN(stockValue)) return;

    // Visual feedback - saving state
    const originalBorder = inputElement.style.borderColor;
    const originalBg = inputElement.style.background;
    const statusDiv = document.getElementById(`save-status-${itemId}`);

    inputElement.style.borderColor = '#ff9800';
    inputElement.style.background = '#fff3e0';
    inputElement.disabled = true;

    // Show "Saving..." status
    if (statusDiv) {
      statusDiv.textContent = '💾 Saving...';
      statusDiv.style.color = '#ff9800';
      statusDiv.style.opacity = '1';
    }

    try {
      const { error } = await supabase
        .from('inventory_items')
        .update({
          current_stock: stockValue,
          last_counted_date: new Date().toISOString()
        })
        .eq('id', itemId);

      if (error) throw error;

      // Update local state
      const item = orderingSystemState.items.find(i => i.id === itemId);
      if (item) {
        item.currentStock = stockValue;
        item.lastCountedDate = new Date().toISOString();
      }

      // PREP CONSUMPTION TRACKING: Track consumption between sessions
      if (item && item.itemType === 'prep') {
        const currentSession = orderingSystemState.currentCountSession;
        const previousData = orderingSystemState.previousCounts.get(itemId);
        const today = getPacificDate(); // YYYY-MM-DD in Pacific time

        // If we have a previous count from a different session, calculate consumption
        if (previousData && previousData.session !== currentSession) {
          const consumption = previousData.count - stockValue;

          // Only log if there was consumption (or waste if negative)
          if (consumption !== 0) {
            try {
              await supabase
                .from('prep_consumption_log')
                .insert({
                  item_id: itemId,
                  count_date: today,
                  from_session: previousData.session,
                  to_session: currentSession,
                  starting_count: previousData.count,
                  ending_count: stockValue,
                  consumption_amount: consumption > 0 ? consumption : 0,
                  waste_amount: consumption < 0 ? Math.abs(consumption) : 0
                });

              console.log(`Consumption tracked: ${item.itemName} - ${consumption} units from ${previousData.session} to ${currentSession}`);
            } catch (err) {
              console.error('Failed to log consumption:', err);
              // Don't block the save if consumption logging fails
            }
          }
        }

        // Update previous counts with current data
        orderingSystemState.previousCounts.set(itemId, {
          count: stockValue,
          session: currentSession
        });
      }

      // Success feedback - green flash
      inputElement.style.borderColor = '#388e3c';
      inputElement.style.background = '#e8f5e9';

      // Show "Saved!" status
      if (statusDiv) {
        statusDiv.textContent = '✓ Saved!';
        statusDiv.style.color = '#388e3c';
      }

      setTimeout(() => {
        inputElement.style.borderColor = '#2e7d32';
        inputElement.style.background = '#f9fdf9';
        inputElement.disabled = false;

        // Fade out status message
        if (statusDiv) {
          statusDiv.style.opacity = '0';
        }
      }, 800);

      // Recalculate orders in background
      calculateUpcomingOrders();
      await refreshUpcomingOrdersUI();

    } catch (error) {
      console.error('Auto-save failed:', error);
      // Error feedback - red flash
      inputElement.style.borderColor = '#d32f2f';
      inputElement.style.background = '#ffebee';

      // Show error status
      if (statusDiv) {
        statusDiv.textContent = '✗ Failed';
        statusDiv.style.color = '#d32f2f';
      }

      setTimeout(() => {
        inputElement.style.borderColor = originalBorder;
        inputElement.style.background = originalBg;
        inputElement.disabled = false;

        // Fade out error message
        if (statusDiv) {
          statusDiv.style.opacity = '0';
        }
      }, 1000);

      showMessage(`Failed to save: ${error.message}`, 'error');
    }
  }

  /**
   * Toggle urgent flag for prep item
   */
  async function toggleUrgent(itemId, isUrgent) {
    const checkbox = document.getElementById(`urgent-${itemId}`);
    const label = checkbox?.nextElementSibling;
    const statusDiv = document.getElementById(`save-status-${itemId}`);

    // Visual feedback - saving state
    if (checkbox) checkbox.disabled = true;
    if (label) label.style.opacity = '0.5';

    // Show saving status
    if (statusDiv) {
      statusDiv.textContent = '💾 Saving...';
      statusDiv.style.color = '#ff9800';
      statusDiv.style.opacity = '1';
    }

    try {
      const { error } = await supabase
        .from('inventory_items')
        .update({ urgent: isUrgent })
        .eq('id', itemId);

      if (error) throw error;

      // Update local state
      const item = orderingSystemState.items.find(i => i.id === itemId);
      if (item) {
        item.urgent = isUrgent;
      }

      // Success feedback
      if (statusDiv) {
        statusDiv.textContent = '✓ Saved';
        statusDiv.style.color = '#4caf50';
      }

      setTimeout(() => {
        if (checkbox) checkbox.disabled = false;
        if (label) label.style.opacity = '1';
        if (statusDiv) statusDiv.style.opacity = '0';
      }, 800);

      // Refresh prep sheet to reorder
      refreshPrepSheet();

    } catch (error) {
      console.error('Failed to toggle urgent:', error);

      // Error feedback
      if (statusDiv) {
        statusDiv.textContent = '✗ Failed';
        statusDiv.style.color = '#d32f2f';
      }

      // Revert checkbox state
      if (checkbox) checkbox.checked = !isUrgent;

      setTimeout(() => {
        if (checkbox) checkbox.disabled = false;
        if (label) label.style.opacity = '1';
        if (statusDiv) statusDiv.style.opacity = '0';
      }, 1000);

      showMessage(`Failed to update urgent status: ${error.message}`, 'error');
    }
  }

  /**
   * Toggle line cooks prep flag for prep item
   */
  async function toggleLineCooksPrep(itemId, isLineCooksPrep) {
    const checkbox = document.getElementById(`line-cooks-prep-${itemId}`);
    const label = checkbox?.nextElementSibling;
    const statusDiv = document.getElementById(`save-status-${itemId}`);

    // Visual feedback - saving state
    if (checkbox) checkbox.disabled = true;
    if (label) label.style.opacity = '0.5';

    // Show saving status
    if (statusDiv) {
      statusDiv.textContent = '💾 Saving...';
      statusDiv.style.color = '#ff9800';
      statusDiv.style.opacity = '1';
    }

    try {
      const { error } = await supabase
        .from('inventory_items')
        .update({ line_cooks_prep: isLineCooksPrep })
        .eq('id', itemId);

      if (error) throw error;

      // Update local state
      const item = orderingSystemState.items.find(i => i.id === itemId);
      if (item) {
        item.lineCooksPrep = isLineCooksPrep;
      }

      // Success feedback
      if (statusDiv) {
        statusDiv.textContent = '✓ Saved';
        statusDiv.style.color = '#4caf50';
      }

      setTimeout(() => {
        if (checkbox) checkbox.disabled = false;
        if (label) label.style.opacity = '1';
        if (statusDiv) statusDiv.style.opacity = '0';
      }, 800);

      // Refresh prep sheet to update categories
      refreshPrepSheet();

    } catch (error) {
      console.error('Failed to toggle line cooks prep:', error);

      // Error feedback
      if (statusDiv) {
        statusDiv.textContent = '✗ Failed';
        statusDiv.style.color = '#d32f2f';
      }

      // Revert checkbox state
      if (checkbox) checkbox.checked = !isLineCooksPrep;

      setTimeout(() => {
        if (checkbox) checkbox.disabled = false;
        if (label) label.style.opacity = '1';
        if (statusDiv) statusDiv.style.opacity = '0';
      }, 1000);

      showMessage(`Failed to update line cooks prep status: ${error.message}`, 'error');
    }
  }

  /**
   * Toggle not made daily flag for prep item
   */
  async function toggleNotMadeDaily(itemId, isNotMadeDaily) {
    const checkbox = document.getElementById(`not-made-daily-${itemId}`);
    const label = checkbox?.nextElementSibling;
    const statusDiv = document.getElementById(`save-status-${itemId}`);

    // Visual feedback - saving state
    if (checkbox) checkbox.disabled = true;
    if (label) label.style.opacity = '0.5';

    // Show saving status
    if (statusDiv) {
      statusDiv.textContent = '💾 Saving...';
      statusDiv.style.color = '#ff9800';
      statusDiv.style.opacity = '1';
    }

    try {
      const { error } = await supabase
        .from('inventory_items')
        .update({ not_made_daily: isNotMadeDaily })
        .eq('id', itemId);

      if (error) throw error;

      // Update local state
      const item = orderingSystemState.items.find(i => i.id === itemId);
      if (item) {
        item.notMadeDaily = isNotMadeDaily;
      }

      // Success feedback
      if (statusDiv) {
        statusDiv.textContent = '✓ Saved';
        statusDiv.style.color = '#4caf50';
      }

      setTimeout(() => {
        if (checkbox) checkbox.disabled = false;
        if (label) label.style.opacity = '1';
        if (statusDiv) statusDiv.style.opacity = '0';
      }, 800);

      // Refresh prep sheet to update recommendations
      refreshPrepSheet();

    } catch (error) {
      console.error('Failed to toggle not made daily:', error);

      // Error feedback
      if (statusDiv) {
        statusDiv.textContent = '✗ Failed';
        statusDiv.style.color = '#d32f2f';
      }

      // Revert checkbox state
      if (checkbox) checkbox.checked = !isNotMadeDaily;

      setTimeout(() => {
        if (checkbox) checkbox.disabled = false;
        if (label) label.style.opacity = '1';
        if (statusDiv) statusDiv.style.opacity = '0';
      }, 1000);

      showMessage(`Failed to update not made daily status: ${error.message}`, 'error');
    }
  }

  /**
   * Toggle show in bottle count checkbox for prep item
   */
  async function toggleBottleCount(itemId, showInBottle) {
    const checkbox = document.getElementById(`bottle-count-${itemId}`);
    const label = checkbox?.nextElementSibling;
    const statusDiv = document.getElementById(`save-status-${itemId}`);

    // Visual feedback - saving state
    if (checkbox) checkbox.disabled = true;
    if (label) label.style.opacity = '0.5';

    // Show saving status
    if (statusDiv) {
      statusDiv.textContent = '💾 Saving...';
      statusDiv.style.color = '#ff9800';
      statusDiv.style.opacity = '1';
    }

    try {
      const { error } = await supabase
        .from('inventory_items')
        .update({ show_in_bottle_count: showInBottle })
        .eq('id', itemId);

      if (error) throw error;

      // Update local state
      const item = orderingSystemState.items.find(i => i.id === itemId);
      if (item) {
        item.showInBottleCount = showInBottle;
      }

      // Success feedback
      if (statusDiv) {
        statusDiv.textContent = '✓ Saved';
        statusDiv.style.color = '#4caf50';
      }

      setTimeout(() => {
        if (checkbox) checkbox.disabled = false;
        if (label) label.style.opacity = '1';
        if (statusDiv) statusDiv.style.opacity = '0';
      }, 800);

      // Refresh prep sheet to update recommendations
      refreshPrepSheet();

    } catch (error) {
      console.error('Failed to toggle bottle count:', error);

      // Error feedback
      if (statusDiv) {
        statusDiv.textContent = '✗ Failed';
        statusDiv.style.color = '#d32f2f';
      }

      // Revert checkbox state
      if (checkbox) checkbox.checked = !showInBottle;

      setTimeout(() => {
        if (checkbox) checkbox.disabled = false;
        if (label) label.style.opacity = '1';
        if (statusDiv) statusDiv.style.opacity = '0';
      }, 1000);

      showMessage(`Failed to update bottle count status: ${error.message}`, 'error');
    }
  }

  /**
   * Quick adjust stock count with +/- buttons (Mobile-Optimized)
   */
  function quickAdjustStock(itemId, adjustment) {
    const inputElement = document.getElementById(`stock-${itemId}`);
    if (!inputElement) return;

    const currentValue = parseFloat(inputElement.value) || 0;
    const newValue = Math.max(0, currentValue + adjustment); // Don't go below 0

    // Round to 2 decimal places to avoid floating point errors
    const roundedValue = Math.round(newValue * 100) / 100;

    inputElement.value = roundedValue;

    // Trigger auto-save
    autoSaveStockCount(itemId, roundedValue, inputElement);
  }

  /**
   * Quick adjust par level with +/- buttons
   */
  function quickAdjustParLevel(itemId, adjustment) {
    const inputElement = document.getElementById(`par-${itemId}`);
    if (!inputElement) return;

    const currentValue = parseFloat(inputElement.value) || 0;
    const newValue = Math.max(0, currentValue + adjustment); // Don't go below 0

    // Round to 2 decimal places to avoid floating point errors
    const roundedValue = Math.round(newValue * 100) / 100;

    inputElement.value = roundedValue;

    // Trigger auto-save
    autoSaveParLevel(itemId, roundedValue, inputElement);
  }

  /**
   * Auto-save par level when input loses focus or +/- buttons clicked
   */
  async function autoSaveParLevel(itemId, newValue, inputElement) {
    const parValue = parseFloat(newValue);
    if (isNaN(parValue)) return;

    // Visual feedback - saving state
    const originalBorder = inputElement.style.borderColor;
    const originalBg = inputElement.style.background;
    const statusDiv = document.getElementById(`par-save-status-${itemId}`);

    inputElement.style.borderColor = '#ff9800';
    inputElement.style.background = '#fff3e0';
    inputElement.disabled = true;

    // Show "Saving..." status
    if (statusDiv) {
      statusDiv.textContent = '💾 Saving...';
      statusDiv.style.color = '#ff9800';
      statusDiv.style.opacity = '1';
    }

    try {
      const { error } = await supabase
        .from('inventory_items')
        .update({
          par_level: parValue
        })
        .eq('id', itemId);

      if (error) throw error;

      // Update local state
      const item = orderingSystemState.items.find(i => i.id === itemId);
      if (item) {
        item.parLevel = parValue;
      }

      // Success feedback - green
      inputElement.style.borderColor = '#2e7d32';
      inputElement.style.background = '#e8f5e9';
      inputElement.disabled = false;

      if (statusDiv) {
        statusDiv.textContent = '✅ Saved';
        statusDiv.style.color = '#2e7d32';
        setTimeout(() => {
          statusDiv.style.opacity = '0';
        }, 2000);
      }

      // Recalculate orders since par level changed
      calculateUpcomingOrders();
      await refreshUpcomingOrdersUI();

    } catch (error) {
      console.error('Error saving par level:', error);
      
      // Error feedback - red
      inputElement.style.borderColor = '#d32f2f';
      inputElement.style.background = '#ffebee';
      inputElement.disabled = false;

      if (statusDiv) {
        statusDiv.textContent = '❌ Failed';
        statusDiv.style.color = '#d32f2f';
        setTimeout(() => {
          statusDiv.style.opacity = '0';
        }, 3000);
      }
    }

    // Reset to original after delay
    setTimeout(() => {
      inputElement.style.borderColor = originalBorder;
      inputElement.style.background = originalBg;
    }, 2500);
  }

  /**
   * Show area selector popup for a prep item
   */
  async function showAreaSelector(itemId, currentArea, event) {
    event.preventDefault();
    event.stopPropagation();

    // Get all unique storage locations from prep items
    const prepItems = orderingSystemState.items.filter(item =>
      item.vendor === 'PREP' || item.itemType === 'prep'
    );

    const uniqueAreas = [...new Set(prepItems
      .map(item => item.storageLocation)
      .filter(loc => loc && loc.trim() !== '')
    )].sort();

    // Create modal
    const modal = document.createElement('div');
    modal.id = 'areaSelectorModal';
    modal.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      padding: 20px;
    `;

    const content = document.createElement('div');
    content.style.cssText = `
      background: white;
      padding: 24px;
      max-width: 400px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      border: 3px solid var(--gray-700);
    `;

    const title = document.createElement('h3');
    title.textContent = 'SELECT STORAGE AREA';
    title.style.cssText = `
      margin: 0 0 16px 0;
      font-size: 16px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--gray-900);
    `;

    const areaList = document.createElement('div');
    areaList.style.cssText = 'margin-bottom: 16px;';

    // Add existing areas
    uniqueAreas.forEach(area => {
      const areaBtn = document.createElement('button');
      areaBtn.textContent = area;
      areaBtn.style.cssText = `
        display: block;
        width: 100%;
        padding: 12px;
        margin-bottom: 8px;
        background: ${area === currentArea ? '#e3f2fd' : 'var(--gray-100)'};
        border: 2px solid ${area === currentArea ? '#1976d2' : 'var(--gray-300)'};
        color: var(--gray-900);
        font-size: 13px;
        font-weight: ${area === currentArea ? '700' : '400'};
        cursor: pointer;
        text-align: left;
        transition: all 0.15s;
      `;
      areaBtn.onmouseover = () => {
        if (area !== currentArea) {
          areaBtn.style.background = '#f5f5f5';
          areaBtn.style.borderColor = 'var(--gray-400)';
        }
      };
      areaBtn.onmouseout = () => {
        if (area !== currentArea) {
          areaBtn.style.background = 'var(--gray-100)';
          areaBtn.style.borderColor = 'var(--gray-300)';
        }
      };
      areaBtn.onclick = () => {
        saveItemArea(itemId, area);
        document.body.removeChild(modal);
      };
      areaList.appendChild(areaBtn);
    });

    content.appendChild(title);
    content.appendChild(areaList);

    // Add "Add New Area" section
    const addNewContainer = document.createElement('div');
    addNewContainer.id = 'addNewAreaContainer';
    addNewContainer.style.cssText = 'margin-top: 16px; padding-top: 16px; border-top: 2px solid var(--gray-300);';

    const addNewBtn = document.createElement('button');
    addNewBtn.textContent = '+ ADD NEW AREA';
    addNewBtn.style.cssText = `
      display: block;
      width: 100%;
      padding: 12px;
      background: var(--gray-700);
      border: 2px solid var(--gray-700);
      color: white;
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      transition: all 0.15s;
    `;
    addNewBtn.onmouseover = () => {
      addNewBtn.style.background = 'var(--gray-900)';
      addNewBtn.style.borderColor = 'var(--gray-900)';
    };
    addNewBtn.onmouseout = () => {
      addNewBtn.style.background = 'var(--gray-700)';
      addNewBtn.style.borderColor = 'var(--gray-700)';
    };
    addNewBtn.onclick = () => {
      showAddNewAreaInput(itemId, addNewContainer);
    };

    addNewContainer.appendChild(addNewBtn);
    content.appendChild(addNewContainer);

    // Close button
    const closeBtn = document.createElement('button');
    closeBtn.textContent = 'CANCEL';
    closeBtn.style.cssText = `
      display: block;
      width: 100%;
      padding: 12px;
      margin-top: 16px;
      background: var(--gray-100);
      border: 2px solid var(--gray-300);
      color: var(--gray-900);
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    `;
    closeBtn.onclick = () => document.body.removeChild(modal);

    content.appendChild(closeBtn);
    modal.appendChild(content);

    // Close on backdrop click
    modal.onclick = (e) => {
      if (e.target === modal) {
        document.body.removeChild(modal);
      }
    };

    document.body.appendChild(modal);
  }

  /**
   * Show input for adding new area
   */
  function showAddNewAreaInput(itemId, container) {
    container.innerHTML = '';

    const inputGroup = document.createElement('div');

    const label = document.createElement('label');
    label.textContent = 'NEW AREA NAME';
    label.style.cssText = `
      display: block;
      margin-bottom: 8px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--gray-700);
    `;

    const input = document.createElement('input');
    input.type = 'text';
    input.placeholder = 'e.g., Walk-in Cooler';
    input.style.cssText = `
      width: 100%;
      padding: 12px;
      border: 2px solid var(--gray-300);
      font-size: 14px;
      margin-bottom: 12px;
      box-sizing: border-box;
    `;

    const saveStatus = document.createElement('div');
    saveStatus.id = 'newAreaSaveStatus';
    saveStatus.style.cssText = `
      text-align: center;
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 12px;
      opacity: 0;
      transition: opacity 0.2s;
    `;

    // Auto-capitalize first letter
    input.oninput = (e) => {
      const value = e.target.value;
      if (value.length > 0) {
        e.target.value = value.charAt(0).toUpperCase() + value.slice(1);
      }
    };

    // Save on Enter key
    input.onkeypress = (e) => {
      if (e.key === 'Enter') {
        saveNewArea(itemId, input.value.trim(), saveStatus);
      }
    };

    const saveBtn = document.createElement('button');
    saveBtn.textContent = 'SAVE NEW AREA';
    saveBtn.style.cssText = `
      display: block;
      width: 100%;
      padding: 12px;
      background: #2e7d32;
      border: 2px solid #2e7d32;
      color: white;
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    `;
    saveBtn.onclick = () => {
      saveNewArea(itemId, input.value.trim(), saveStatus);
    };

    const cancelBtn = document.createElement('button');
    cancelBtn.textContent = 'CANCEL';
    cancelBtn.style.cssText = `
      display: block;
      width: 100%;
      padding: 12px;
      background: var(--gray-100);
      border: 2px solid var(--gray-300);
      color: var(--gray-900);
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    `;
    cancelBtn.onclick = () => {
      const modal = document.getElementById('areaSelectorModal');
      if (modal) document.body.removeChild(modal);
    };

    inputGroup.appendChild(label);
    inputGroup.appendChild(input);
    inputGroup.appendChild(saveStatus);
    inputGroup.appendChild(saveBtn);
    inputGroup.appendChild(cancelBtn);
    container.appendChild(inputGroup);

    // Focus input
    setTimeout(() => input.focus(), 100);
  }

  /**
   * Save new area and assign to item
   */
  async function saveNewArea(itemId, areaName, statusDiv) {
    if (!areaName) {
      alert('Please enter an area name');
      return;
    }

    // Show saving status
    statusDiv.textContent = '💾 Saving...';
    statusDiv.style.color = '#ff9800';
    statusDiv.style.opacity = '1';

    try {
      // Save to database
      const { error } = await supabase
        .from('inventory_items')
        .update({ storage_location: areaName })
        .eq('id', itemId);

      if (error) throw error;

      // Update local state
      const item = orderingSystemState.items.find(i => i.id === itemId);
      if (item) {
        item.storageLocation = areaName;
      }

      // Success feedback
      statusDiv.textContent = '✅ Saved!';
      statusDiv.style.color = '#2e7d32';

      // Close modal after delay
      setTimeout(() => {
        const modal = document.getElementById('areaSelectorModal');
        if (modal) document.body.removeChild(modal);

        // Re-render prep list to show updated area
        renderPrepCountList();
      }, 1000);

    } catch (error) {
      console.error('Error saving area:', error);
      statusDiv.textContent = '❌ Failed to save';
      statusDiv.style.color = '#d32f2f';
      setTimeout(() => {
        statusDiv.style.opacity = '0';
      }, 3000);
    }
  }

  /**
   * Save item area selection
   */
  async function saveItemArea(itemId, areaName) {
    try {
      const { error } = await supabase
        .from('inventory_items')
        .update({ storage_location: areaName })
        .eq('id', itemId);

      if (error) throw error;

      // Update local state
      const item = orderingSystemState.items.find(i => i.id === itemId);
      if (item) {
        item.storageLocation = areaName;
      }

      // Re-render prep list to show updated area
      renderPrepCountList();

    } catch (error) {
      console.error('Error saving area:', error);
      alert('Failed to save area. Please try again.');
    }
  }

  /**
   * Toggle compact mode for Update Counts view
   */
  let isCompactMode = false;
  function toggleCompactMode() {
    isCompactMode = !isCompactMode;
    const icon = document.getElementById('compactModeIcon');

    if (isCompactMode) {
      // Compact mode: smaller cards, tighter spacing
      icon.textContent = '📱';
      // Apply compact styles by re-rendering
      renderStockCountList();
    } else {
      // Normal mode: larger cards, comfortable spacing
      icon.textContent = '📋';
      // Apply normal styles by re-rendering
      renderStockCountList();
    }
  }

  /**
   * Save all pending stock count updates
   */
  async function saveAllStockCounts() {
    if (orderingSystemState.pendingStockUpdates.size === 0) {
      showMessage('No changes to save!', 'info');
      return;
    }

    showLoading('Saving Stock Counts', `Updating ${orderingSystemState.pendingStockUpdates.size} items...`);

    try {
      const updates = [];
      for (const [itemId, newStock] of orderingSystemState.pendingStockUpdates.entries()) {
        updates.push(
          supabase
            .from('inventory_items')
            .update({
              current_stock: newStock,
              last_counted_date: new Date().toISOString()
            })
            .eq('id', itemId)
        );

        // Update local state
        const item = orderingSystemState.items.find(i => i.id === itemId);
        if (item) {
          item.currentStock = newStock;
          item.lastCountedDate = new Date().toISOString();
        }
      }

      await Promise.all(updates);

      // Clear pending updates
      orderingSystemState.pendingStockUpdates.clear();

      // Recalculate orders and refresh UI
      calculateUpcomingOrders();
      await refreshUpcomingOrdersUI();
      renderStockCountList();

      hideLoading();
      showMessage(`✅ Successfully updated ${updates.length} items!`, 'success');
    } catch (error) {
      hideLoading();
      showMessage(`Error saving stock counts: ${error.message}`, 'error');
    }
  }

  /**
   * Update par level for an item
   */
  async function updateParLevel(itemId, newParLevel) {
    showLoading('Updating Par Level', 'Saving changes...');

    try {
      const { error } = await supabase
        .from('inventory_items')
        .update({ par_level: parseInt(newParLevel) })
        .eq('id', itemId);

      if (error) throw error;

      // Update local state
      const item = orderingSystemState.items.find(i => i.id === itemId);
      if (item) {
        item.parLevel = parseInt(newParLevel);
      }

      // Recalculate orders
      calculateUpcomingOrders();
      await refreshUpcomingOrdersUI();

      hideLoading();
      showMessage('✅ Par level updated!', 'success');
    } catch (error) {
      hideLoading();
      showMessage(`Error updating par level: ${error.message}`, 'error');
    }
  }

  /**
   * Update unit type for an inventory item
   */
  async function updateItemUnit(itemId, newUnit) {
    if (!newUnit || newUnit.trim() === '') {
      showMessage('Unit cannot be empty', 'error');
      return;
    }

    showLoading('Updating Unit', 'Saving changes...');

    try {
      const { error } = await supabase
        .from('inventory_items')
        .update({ unit: newUnit.trim().toUpperCase() })
        .eq('id', itemId);

      if (error) throw error;

      // Update local state
      const item = orderingSystemState.items.find(i => i.id === itemId);
      if (item) {
        item.unit = newUnit.trim().toUpperCase();
      }

      hideLoading();
      showMessage('Unit updated', 'success');

      // Re-render to show updated value
      renderInventoryList();
    } catch (error) {
      hideLoading();
      showMessage('Error updating unit: ' + error.message, 'error');
    }
  }

  /**
   * Handle add new item form submission
   */
  async function handleAddItem(event) {
    event.preventDefault();

    const itemName = document.getElementById('newItemName').value.trim();
    let vendor = document.getElementById('newItemVendor').value;
    const unit = document.getElementById('newItemUnit').value.trim();
    const parLevel = parseInt(document.getElementById('newItemPar').value);

    if (!itemName || !vendor || !unit) {
      showMessage('Please fill in all required fields!', 'error');
      return;
    }

    // Handle new vendor creation
    if (vendor === 'OTHER') {
      const newVendor = prompt('Enter new vendor name:');
      if (!newVendor || newVendor.trim() === '') {
        showMessage('Vendor name is required', 'error');
        return;
      }
      vendor = newVendor.trim();
    }

    showLoading('Adding Item', 'Saving to database...');

    try {
      const { data, error } = await supabase
        .from('inventory_items')
        .insert([{
          item_name: itemName,
          vendor: vendor,
          unit: unit,
          par_level: parLevel,
          current_stock: 0,
          created_date: new Date().toISOString()
        }])
        .select();

      if (error) throw error;

      // Add to local state
      orderingSystemState.items.push({
        id: data[0].id,
        itemName: data[0].item_name,
        vendor: data[0].vendor,
        parLevel: data[0].par_level,
        currentStock: data[0].current_stock,
        unit: data[0].unit,
        lastCountedDate: null
      });

      refreshPriceHistoryControls();

      // Reset form
      document.getElementById('addItemForm').reset();

      // Refresh displays
      renderInventoryList();
      renderStockCountList();
      renderPrepCountList();
      refreshPriceHistoryControls();
      calculateUpcomingOrders();
      await refreshUpcomingOrdersUI();

      hideLoading();
      showMessage('✅ Item added successfully!', 'success');
    } catch (error) {
      hideLoading();
      showMessage(`Error adding item: ${error.message}`, 'error');
    }
  }

  /**
   * Handle adding a new prep item
   */
  async function handleAddPrepItem(event) {
    event.preventDefault();

    const itemName = document.getElementById('newPrepItemName').value.trim();
    let vendor = document.getElementById('newPrepItemVendor').value;
    const unit = document.getElementById('newPrepItemUnit').value.trim().toUpperCase();
    const parLevel = parseFloat(document.getElementById('newPrepItemPar').value);
    const batchLifespan = parseInt(document.getElementById('newPrepItemLifespan').value);

    if (!itemName || !vendor || !unit) {
      showMessage('Please fill in all required fields!', 'error');
      return;
    }

    // Handle new vendor creation
    if (vendor === 'OTHER') {
      const newVendor = prompt('Enter new vendor name:');
      if (!newVendor || newVendor.trim() === '') {
        showMessage('Vendor name is required', 'error');
        return;
      }
      vendor = newVendor.trim();
    }

    showLoading('Adding Prep Item', 'Saving to database...');

    try {
      const { data, error } = await supabase
        .from('inventory_items')
        .insert([{
          item_name: itemName,
          vendor: vendor,
          unit: unit,
          par_level: parLevel,
          current_stock: 0,
          item_type: 'prep',
          batch_lifespan_hours: batchLifespan,
          created_date: new Date().toISOString()
        }])
        .select();

      if (error) throw error;

      // Add to local state
      orderingSystemState.items.push({
        id: data[0].id,
        itemName: data[0].item_name,
        vendor: data[0].vendor,
        parLevel: data[0].par_level,
        currentStock: data[0].current_stock,
        unit: data[0].unit,
        itemType: data[0].item_type,
        batchLifespan: data[0].batch_lifespan_hours,
        lastCountedDate: null
      });

      refreshPriceHistoryControls();

      // Reset form
      document.getElementById('addPrepItemForm').reset();

      // Refresh displays
      renderInventoryList();
      renderStockCountList();
      renderPrepCountList();
      refreshPrepSheet(); // Refresh prep recommendations

      hideLoading();
      showMessage('Prep item added successfully!', 'success');
    } catch (error) {
      hideLoading();
      showMessage(`Error adding prep item: ${error.message}`, 'error');
    }
  }

  /**
   * Delete an inventory item
   */
  async function deleteInventoryItem(itemId) {
    if (!confirm('Are you sure you want to delete this item? This action cannot be undone.')) {
      return;
    }

    showLoading('Deleting Item', 'Removing from database...');

    try {
      const { error } = await supabase
        .from('inventory_items')
        .delete()
        .eq('id', itemId);

      if (error) throw error;

      // Remove from local state
      orderingSystemState.items = orderingSystemState.items.filter(i => i.id !== itemId);

      // Refresh displays
      renderInventoryList();
      renderStockCountList();
      renderPrepCountList();
      calculateUpcomingOrders();

      hideLoading();
      showMessage('✅ Item deleted successfully!', 'success');
    } catch (error) {
      hideLoading();
      showMessage(`Error deleting item: ${error.message}`, 'error');
    }
  }

  /**
   * Open modal to edit inventory item
   */
  function openEditItemModal(itemId) {
    // Find the item
    const item = orderingSystemState.items.find(i => i.id === itemId);
    if (!item) {
      showMessage('Item not found', 'error');
      return;
    }

    // Create modal overlay
    const overlay = document.createElement('div');
    overlay.id = 'editItemModal';
    overlay.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      z-index: 10000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
    `;

    // Create modal content container
    const modal = document.createElement('div');
    modal.style.cssText = `
      background: white;
      border: 2px solid #e0e0e0;
      width: 100%;
      height: 100%;
      max-width: 500px;
      max-height: 100vh;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    `;

    // Responsive: full screen on mobile, centered on desktop
    if (window.innerWidth <= 600) {
      modal.style.maxWidth = '100%';
      modal.style.maxHeight = '100%';
      modal.style.border = 'none';
    }

    // Create header
    const header = document.createElement('div');
    header.style.cssText = `
      background: #212121;
      color: white;
      padding: 16px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 10;
    `;

    const headerTitle = document.createElement('h3');
    headerTitle.textContent = 'EDIT ITEM';
    headerTitle.style.cssText = `
      margin: 0;
      font-size: 16px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
    `;

    const closeBtn = document.createElement('button');
    closeBtn.textContent = '✕';
    closeBtn.style.cssText = `
      background: none;
      border: none;
      color: var(--white);
      font-size: 24px;
      cursor: pointer;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
    `;
    closeBtn.onclick = () => overlay.remove();

    header.appendChild(headerTitle);
    header.appendChild(closeBtn);

    // Create form container
    const formContainer = document.createElement('div');
    formContainer.style.cssText = `
      padding: 20px;
      padding-bottom: 100px;
    `;

    // Helper function to create form field
    function createField(label, inputElement) {
      const fieldDiv = document.createElement('div');
      fieldDiv.style.cssText = `
        margin-bottom: 16px;
      `;

      const labelEl = document.createElement('label');
      labelEl.textContent = label;
      labelEl.style.cssText = `
        display: block;
        margin-bottom: 6px;
        font-size: 12px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--gray-700);
      `;

      fieldDiv.appendChild(labelEl);
      fieldDiv.appendChild(inputElement);
      return fieldDiv;
    }

    // Item Name field
    const nameInput = document.createElement('input');
    nameInput.type = 'text';
    nameInput.value = item.itemName || '';
    nameInput.id = 'editItemName';
    nameInput.style.cssText = `
      width: 100%;
      padding: 10px;
      border: 2px solid var(--gray-300);
      border-radius: 0;
      font-size: 14px;
      box-sizing: border-box;
    `;
    formContainer.appendChild(createField('Item Name', nameInput));

    // Vendor dropdown
    const vendorSelect = document.createElement('select');
    vendorSelect.id = 'editItemVendor';
    vendorSelect.style.cssText = `
      width: 100%;
      padding: 10px;
      border: 2px solid var(--gray-300);
      border-radius: 0;
      font-size: 14px;
      box-sizing: border-box;
      background: var(--white);
    `;

    // Get all unique vendors
    const vendors = new Set(['PREP']);
    orderingSystemState.items.forEach(i => {
      if (i.vendor) vendors.add(i.vendor);
    });
    const sortedVendors = Array.from(vendors).sort();

    sortedVendors.forEach(vendor => {
      const option = document.createElement('option');
      option.value = vendor;
      option.textContent = vendor;
      if (vendor === item.vendor) option.selected = true;
      vendorSelect.appendChild(option);
    });

    formContainer.appendChild(createField('Vendor', vendorSelect));

    // Unit field
    const unitInput = document.createElement('input');
    unitInput.type = 'text';
    unitInput.value = item.unit || '';
    unitInput.id = 'editItemUnit';
    unitInput.style.cssText = `
      width: 100%;
      padding: 10px;
      border: 2px solid var(--gray-300);
      border-radius: 0;
      font-size: 14px;
      box-sizing: border-box;
      text-transform: uppercase;
    `;
    formContainer.appendChild(createField('Unit (CS, EA, LB)', unitInput));

    // Par Level field
    const parInput = document.createElement('input');
    parInput.type = 'number';
    parInput.step = '0.25';
    parInput.value = item.parLevel || 0;
    parInput.id = 'editItemPar';
    parInput.style.cssText = `
      width: 100%;
      padding: 10px;
      border: 2px solid var(--gray-300);
      border-radius: 0;
      font-size: 14px;
      box-sizing: border-box;
    `;
    formContainer.appendChild(createField('Par Level', parInput));

    // Current Stock (read-only for display)
    const stockInput = document.createElement('input');
    stockInput.type = 'number';
    stockInput.step = '0.25';
    stockInput.value = item.currentStock || 0;
    stockInput.id = 'editItemStock';
    stockInput.readOnly = true;
    stockInput.style.cssText = `
      width: 100%;
      padding: 10px;
      border: 2px solid var(--gray-300);
      border-radius: 0;
      font-size: 14px;
      box-sizing: border-box;
      background: var(--gray-100);
      color: var(--gray-600);
    `;
    const stockField = createField('Current Stock (update via COUNT tab)', stockInput);
    formContainer.appendChild(stockField);

    // Item Type field (only if PREP)
    if (item.vendor === 'PREP' || item.itemType === 'prep') {
      const itemTypeInput = document.createElement('input');
      itemTypeInput.type = 'text';
      itemTypeInput.value = item.itemType || 'prep';
      itemTypeInput.id = 'editItemType';
      itemTypeInput.style.cssText = `
        width: 100%;
        padding: 10px;
        border: 2px solid var(--gray-300);
        border-radius: 0;
        font-size: 14px;
        box-sizing: border-box;
      `;
      formContainer.appendChild(createField('Item Type', itemTypeInput));

      // Batch Lifespan
      const lifespanInput = document.createElement('input');
      lifespanInput.type = 'number';
      lifespanInput.value = item.batchLifespan || '';
      lifespanInput.id = 'editItemLifespan';
      lifespanInput.placeholder = 'Hours (e.g., 24)';
      lifespanInput.style.cssText = `
        width: 100%;
        padding: 10px;
        border: 2px solid var(--gray-300);
        border-radius: 0;
        font-size: 14px;
        box-sizing: border-box;
      `;
      formContainer.appendChild(createField('Batch Lifespan (Hours)', lifespanInput));

      // Show in Bottle Count checkbox (ONLY for PREP items)
      const bottleCheckboxContainer = document.createElement('div');
      bottleCheckboxContainer.style.cssText = `
        margin-bottom: 16px;
        padding: 12px;
        background: #e3f2fd;
        border: 2px solid #2196f3;
        border-radius: 4px;
      `;

      const bottleCheckboxLabel = document.createElement('label');
      bottleCheckboxLabel.style.cssText = `
        display: flex;
        align-items: center;
        gap: 10px;
        cursor: pointer;
        font-size: 13px;
        font-weight: 600;
        color: var(--gray-900);
      `;

      const bottleCheckbox = document.createElement('input');
      bottleCheckbox.type = 'checkbox';
      bottleCheckbox.id = 'editItemShowInBottle';
      bottleCheckbox.checked = item.showInBottleCount || false;
      bottleCheckbox.style.cssText = `
        width: 18px;
        height: 18px;
        cursor: pointer;
      `;

      const bottleCheckboxText = document.createElement('span');
      bottleCheckboxText.textContent = '📋 Show in "BOTTLED & TO-GO PREP CHECK" section';
      
      const bottleCheckboxHint = document.createElement('div');
      bottleCheckboxHint.textContent = 'Check this to include item in the bottled/to-go PDF section (in addition to items with "BOTTLED" or "TO GO" in the name)';
      bottleCheckboxHint.style.cssText = `
        font-size: 11px;
        color: var(--gray-600);
        margin-left: 28px;
        margin-top: 4px;
        line-height: 1.4;
      `;

      bottleCheckboxLabel.appendChild(bottleCheckbox);
      bottleCheckboxLabel.appendChild(bottleCheckboxText);
      bottleCheckboxContainer.appendChild(bottleCheckboxLabel);
      bottleCheckboxContainer.appendChild(bottleCheckboxHint);
      formContainer.appendChild(bottleCheckboxContainer);
    }

    // Button container
    const btnContainer = document.createElement('div');
    btnContainer.style.cssText = `
      display: flex;
      gap: 10px;
      padding: 16px 20px;
      background: white;
      position: sticky;
      bottom: 0;
      z-index: 10;
      border-top: 2px solid #e0e0e0;
      margin-top: 24px;
    `;

    // Delete button (left side, red)
    const deleteBtn = document.createElement('button');
    deleteBtn.textContent = 'DELETE';
    deleteBtn.style.cssText = `
      flex: 0 0 auto;
      padding: 12px 20px;
      background: #dc3545;
      color: var(--white);
      border: none;
      cursor: pointer;
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      transition: background 0.2s;
    `;
    deleteBtn.onmouseover = () => deleteBtn.style.background = '#c82333';
    deleteBtn.onmouseout = () => deleteBtn.style.background = '#dc3545';
    deleteBtn.onclick = () => {
      overlay.remove();
      deleteInventoryItem(itemId);
    };

    // Spacer
    const spacer = document.createElement('div');
    spacer.style.flex = '1';

    // Cancel button
    const cancelBtn = document.createElement('button');
    cancelBtn.textContent = 'CANCEL';
    cancelBtn.style.cssText = `
      padding: 12px 20px;
      background: var(--gray-300);
      color: var(--gray-700);
      border: none;
      cursor: pointer;
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      transition: background 0.2s;
    `;
    cancelBtn.onmouseover = () => cancelBtn.style.background = 'var(--gray-400)';
    cancelBtn.onmouseout = () => cancelBtn.style.background = 'var(--gray-300)';
    cancelBtn.onclick = () => overlay.remove();

    // Save button
    const saveBtn = document.createElement('button');
    saveBtn.textContent = 'SAVE CHANGES';
    saveBtn.style.cssText = `
      padding: 12px 20px;
      background: var(--gray-700);
      color: var(--white);
      border: none;
      cursor: pointer;
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      transition: background 0.2s;
    `;
    saveBtn.onmouseover = () => saveBtn.style.background = 'var(--gray-900)';
    saveBtn.onmouseout = () => saveBtn.style.background = 'var(--gray-700)';
    saveBtn.onclick = async () => {
      const updatedData = {
        item_name: nameInput.value.trim(),
        vendor: vendorSelect.value,
        unit: unitInput.value.trim().toUpperCase(),
        par_level: parseFloat(parInput.value) || 0
      };

      // Add PREP-specific fields if present
      const itemTypeInput = document.getElementById('editItemType');
      const lifespanInput = document.getElementById('editItemLifespan');
      const bottleCheckbox = document.getElementById('editItemShowInBottle');

      if (itemTypeInput) {
        updatedData.item_type = itemTypeInput.value.trim();
      }
      if (lifespanInput && lifespanInput.value) {
        updatedData.batch_lifespan_hours = parseInt(lifespanInput.value) || null;
      }
      if (bottleCheckbox) {
        updatedData.show_in_bottle_count = bottleCheckbox.checked;
      }

      // Validate
      if (!updatedData.item_name) {
        showMessage('Item name is required', 'error');
        return;
      }

      overlay.remove();
      showLoading('Updating Item', 'Saving changes...');

      try {
        const { error } = await supabase
          .from('inventory_items')
          .update(updatedData)
          .eq('id', itemId);

        if (error) throw error;

        // Update local state
        const localItem = orderingSystemState.items.find(i => i.id === itemId);
        if (localItem) {
          localItem.itemName = updatedData.item_name;
          localItem.vendor = updatedData.vendor;
          localItem.unit = updatedData.unit;
          localItem.parLevel = updatedData.par_level;
          localItem.showInBottleCount = updatedData.show_in_bottle_count;
          if (updatedData.item_type) localItem.itemType = updatedData.item_type;
          if (updatedData.batch_lifespan_hours !== undefined) localItem.batchLifespan = updatedData.batch_lifespan_hours;
        }

        // Refresh displays
        renderInventoryList();
        renderStockCountList();
        renderPrepCountList();
        calculateUpcomingOrders();
        await refreshUpcomingOrdersUI();

        hideLoading();
        showMessage('✅ Item updated successfully!', 'success');
      } catch (error) {
        hideLoading();
        showMessage(`Error updating item: ${error.message}`, 'error');
      }
    };

    btnContainer.appendChild(deleteBtn);
    btnContainer.appendChild(spacer);
    btnContainer.appendChild(cancelBtn);
    btnContainer.appendChild(saveBtn);

    formContainer.appendChild(btnContainer);

    // Assemble modal
    modal.appendChild(header);
    modal.appendChild(formContainer);
    overlay.appendChild(modal);

    // Add to page
    document.body.appendChild(overlay);

    // Focus first input
    nameInput.focus();
  }

  /**
   * Get all unique vendors from inventory
   */
  function getAllVendors() {
    const vendors = new Set();
    orderingSystemState.items.forEach(item => {
      if (item.vendor) vendors.add(item.vendor);
    });
    return Array.from(vendors).sort();
  }

  /**
   * Update item vendor
   */
  async function updateItemVendor(itemId, newVendor) {
    showLoading('Updating Vendor', 'Saving changes...');

    try {
      const { error } = await supabase
        .from('inventory_items')
        .update({ vendor: newVendor })
        .eq('id', itemId);

      if (error) throw error;

      // Update local state
      const item = orderingSystemState.items.find(i => i.id === itemId);
      if (item) {
        item.vendor = newVendor;
      }

      // Refresh displays
      renderInventoryList();
      renderStockCountList();
      renderPrepCountList();
      calculateUpcomingOrders();

      hideLoading();
      showMessage('✅ Vendor updated!', 'success');
    } catch (error) {
      hideLoading();
      showMessage(`Error updating vendor: ${error.message}`, 'error');
    }
  }

  /**
   * Rename vendor (updates all items with that vendor)
   */
  async function renameVendor(oldVendorName, newVendorName) {
    if (!newVendorName || newVendorName.trim() === '') {
      showMessage('Vendor name cannot be empty!', 'error');
      return;
    }

    const itemsWithVendor = orderingSystemState.items.filter(i => i.vendor === oldVendorName);

    if (itemsWithVendor.length === 0) {
      showMessage('No items found for this vendor!', 'error');
      return;
    }

    if (!confirm(`Rename "${oldVendorName}" to "${newVendorName}"? This will update ${itemsWithVendor.length} items.`)) {
      return;
    }

    showLoading('Renaming Vendor', `Updating ${itemsWithVendor.length} items...`);

    try {
      const { error } = await supabase
        .from('inventory_items')
        .update({ vendor: newVendorName })
        .eq('vendor', oldVendorName);

      if (error) throw error;

      // Update local state
      itemsWithVendor.forEach(item => {
        item.vendor = newVendorName;
      });

      // Refresh displays
      renderInventoryList();
      renderStockCountList();
      renderPrepCountList();
      calculateUpcomingOrders();

      hideLoading();
      showMessage(`✅ Renamed "${oldVendorName}" to "${newVendorName}" (${itemsWithVendor.length} items updated)`, 'success');
    } catch (error) {
      hideLoading();
      showMessage(`Error renaming vendor: ${error.message}`, 'error');
    }
  }

  /**
   * Delete vendor (requires moving all items to another vendor first)
   */
  async function deleteVendor(vendorName) {
    const itemsWithVendor = orderingSystemState.items.filter(i => i.vendor === vendorName);

    if (itemsWithVendor.length > 0) {
      showMessage(`Cannot delete vendor "${vendorName}" - ${itemsWithVendor.length} items are still assigned to it. Move them to another vendor first.`, 'error');
      return;
    }

    showMessage(`Vendor "${vendorName}" has no items and can be removed. Simply rename it or ignore it.`, 'info');
  }

  /**
   * Show vendor management modal
   */
  function showVendorManagement() {
    const vendors = getAllVendors();
    const vendorList = vendors.map(vendor => {
      const itemCount = orderingSystemState.items.filter(i => i.vendor === vendor).length;
      return `
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #e0e0e0;">
          <div>
            <strong style="font-size: 15px;">${vendor}</strong>
            <span style="color: #666; font-size: 13px; margin-left: 8px;">(${itemCount} items)</span>
          </div>
          <div style="display: flex; gap: 8px;">
            <button onclick="promptRenameVendor('${vendor.replace(/'/g, "\\'")}')" style="
              background: #1e3c72;
              color: white;
              border: none;
              padding: 6px 12px;
              border-radius: 4px;
              cursor: pointer;
              font-size: 12px;
            ">Rename</button>
          </div>
        </div>
      `;
    }).join('');

    const modalHTML = `
      <div style="
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10000;
      " onclick="closeVendorManagement(event)">
        <div style="
          background: white;
          border-radius: 8px;
          padding: 24px;
          max-width: 600px;
          width: 90%;
          max-height: 80vh;
          overflow-y: auto;
        " onclick="event.stopPropagation()">
          <h2 style="margin: 0 0 20px 0; color: #1e3c72;">Vendor Management</h2>
          <div style="margin-bottom: 20px;">
            ${vendorList}
          </div>
          <button onclick="closeVendorManagement()" class="submit-btn" style="background: #666;">Close</button>
        </div>
      </div>
    `;

    const modalDiv = document.createElement('div');
    modalDiv.id = 'vendorManagementModal';
    modalDiv.innerHTML = modalHTML;
    document.body.appendChild(modalDiv);
  }

  /**
   * Close vendor management modal
   */
  function closeVendorManagement(event) {
    if (event && event.target !== event.currentTarget) return;
    const modal = document.getElementById('vendorManagementModal');
    if (modal) modal.remove();
  }

  /**
   * Prompt to rename vendor
   */
  function promptRenameVendor(vendorName) {
    const newName = prompt(`Rename vendor "${vendorName}" to:`, vendorName);
    if (newName && newName !== vendorName) {
      renameVendor(vendorName, newName);
      closeVendorManagement();
    }
  }

  // ============================================
  // PRICE HISTORY EXPLORER
  // ============================================

  function initializePriceHistoryTab() {
    const startInput = document.getElementById('priceHistoryStartDate');
    const endInput = document.getElementById('priceHistoryEndDate');

    if (startInput && !startInput.value) {
      const defaultStart = formatPacificDate(addPacificDays(getPacificMidday(), -30));
      startInput.value = defaultStart;
    }

    if (endInput && !endInput.value) {
      endInput.value = getPacificDate();
    }

    refreshPriceHistoryControls();
    orderingSystemState.priceHistory.initialized = true;
  }

  function refreshPriceHistoryControls() {
    const vendorSelect = document.getElementById('priceHistoryVendor');
    const itemList = document.getElementById('priceHistoryItemList');
    if (!vendorSelect || !itemList) return;

    const vendors = Array.from(new Set(orderingSystemState.items.map(item => item.vendor || 'Other'))).sort((a, b) => a.localeCompare(b));
    const previouslySelectedVendor = vendorSelect.value || 'ALL';

    vendorSelect.innerHTML = '<option value="ALL">All Vendors</option>' + vendors.map(vendor => `<option value="${vendor}">${vendor}</option>`).join('');
    if ([...vendorSelect.options].some(opt => opt.value === previouslySelectedVendor)) {
      vendorSelect.value = previouslySelectedVendor;
    }

    const selectedIds = orderingSystemState.priceHistory.selectedItemIds;

    itemList.innerHTML = '';
    orderingSystemState.items
      .slice()
      .sort((a, b) => a.itemName.localeCompare(b.itemName))
      .forEach(item => {
        const row = document.createElement('label');
        row.className = 'price-history-item';
        row.dataset.vendor = item.vendor || 'Other';
        row.dataset.name = item.itemName.toLowerCase();
        row.style.cssText = 'display: flex; align-items: center; justify-content: space-between; gap: 8px; padding: 6px 8px; border-bottom: 1px solid var(--gray-200); font-size: 12px; background: white;';

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.value = item.id;
        checkbox.checked = selectedIds.has(item.id);
        checkbox.onchange = () => handlePriceHistoryItemToggle(item.id, checkbox.checked);
        row.appendChild(checkbox);

        const labelSpan = document.createElement('span');
        labelSpan.textContent = `${item.itemName} (${item.vendor || 'Other'})`;
        labelSpan.style.cssText = 'flex: 1; margin-left: 8px; color: var(--gray-800);';
        row.appendChild(labelSpan);

        itemList.appendChild(row);
      });

    handlePriceHistoryVendorChange();
    const searchInput = document.getElementById('priceHistoryItemSearch');
    handlePriceHistorySearch(searchInput ? searchInput.value : '');
  }

  function handlePriceHistoryItemToggle(itemId, checked) {
    const selected = orderingSystemState.priceHistory.selectedItemIds;
    if (checked) {
      selected.add(itemId);
    } else {
      selected.delete(itemId);
    }
  }

  function handlePriceHistoryVendorChange() {
    const vendorSelect = document.getElementById('priceHistoryVendor');
    const vendor = vendorSelect ? vendorSelect.value : 'ALL';
    const searchInput = document.getElementById('priceHistoryItemSearch');
    const query = searchInput ? searchInput.value : '';
    handlePriceHistorySearch(query, vendor);
  }

  function handlePriceHistorySearch(value, vendorOverride) {
    const query = (value || '').trim().toLowerCase();
    const vendorSelect = document.getElementById('priceHistoryVendor');
    const vendor = vendorOverride || (vendorSelect ? vendorSelect.value : 'ALL');

    const rows = document.querySelectorAll('#priceHistoryItemList .price-history-item');
    rows.forEach(row => {
      const matchesVendor = vendor === 'ALL' || row.dataset.vendor === vendor;
      const matchesText = !query || row.dataset.name.includes(query);
      row.style.display = matchesVendor && matchesText ? 'flex' : 'none';
    });
  }

  function priceHistorySelectAll() {
    const rows = document.querySelectorAll('#priceHistoryItemList .price-history-item');
    rows.forEach(row => {
      if (row.style.display === 'none') return;
      const checkbox = row.querySelector('input[type="checkbox"]');
      if (checkbox && !checkbox.checked) {
        checkbox.checked = true;
        handlePriceHistoryItemToggle(Number(checkbox.value), true);
      }
    });
  }

  function priceHistoryClearSelection() {
    const rows = document.querySelectorAll('#priceHistoryItemList .price-history-item input[type="checkbox"]');
    rows.forEach(checkbox => {
      checkbox.checked = false;
    });
    orderingSystemState.priceHistory.selectedItemIds.clear();
  }

  async function loadPriceHistory() {
    const statusEl = document.getElementById('priceHistoryStatus');
    const resultsContainer = document.getElementById('priceHistoryResults');
    if (!resultsContainer) return;

    if (statusEl) statusEl.textContent = 'Loading...';
    resultsContainer.innerHTML = '<p style="font-size: 12px; color: var(--gray-500);">Fetching price data...</p>';

    const startInput = document.getElementById('priceHistoryStartDate');
    const endInput = document.getElementById('priceHistoryEndDate');
    const vendorSelect = document.getElementById('priceHistoryVendor');

    const todayPacific = getPacificMidday();
    const defaultStart = formatPacificDate(addPacificDays(todayPacific, -30));
    const defaultEnd = formatPacificDate(todayPacific);

    const startDate = startInput?.value || defaultStart;
    const endDate = endInput?.value || defaultEnd;

    if (startInput && !startInput.value) startInput.value = startDate;
    if (endInput && !endInput.value) endInput.value = endDate;

    const vendorFilter = vendorSelect ? vendorSelect.value : 'ALL';

    let itemIds = Array.from(orderingSystemState.priceHistory.selectedItemIds);
    if (itemIds.length === 0 && vendorFilter !== 'ALL') {
      itemIds = orderingSystemState.items
        .filter(item => (item.vendor || 'Other') === vendorFilter)
        .map(item => item.id);
    }

    if (itemIds.length === 0) {
      if (statusEl) statusEl.textContent = 'Select at least one item or choose a vendor.';
      resultsContainer.innerHTML = '<p style="color: var(--gray-600); font-size: 12px;">Select inventory items to analyze price history.</p>';
      return;
    }

    try {
      const { data, error } = await supabase
        .from('invoice_items')
        .select('inventory_item_id, invoice_id, item_description, unit_price, detected_price, created_at')
        .in('inventory_item_id', itemIds)
        .order('created_at', { ascending: false })
        .limit(itemIds.length * 200);

      if (error) throw error;

      const startObj = parsePacificDate(startDate);
      const endObj = parsePacificDate(endDate);
      const endInclusive = endObj ? addPacificDays(endObj, 1) : null;

      const itemLookup = new Map(orderingSystemState.items.map(item => [item.id, item]));

      const invoiceIds = Array.from(new Set((data || []).map(row => row.invoice_id).filter(id => id != null)));
      const invoiceMap = new Map();
      if (invoiceIds.length) {
        const { data: invoiceRows, error: invoiceError } = await supabase
          .from('invoices')
          .select('id, invoice_date, vendor_name, vendor')
          .in('id', invoiceIds);

        if (!invoiceError && invoiceRows) {
          invoiceRows.forEach(row => invoiceMap.set(row.id, row));
        }
      }

      const grouped = new Map();
      (data || []).forEach(row => {
        const itemId = row.inventory_item_id;
        if (!itemId) return;

        const priceValue = row.unit_price ?? row.detected_price;
        if (priceValue === null || priceValue === undefined) return;

        const invoice = row.invoice_id != null ? invoiceMap.get(row.invoice_id) : null;
        const invoiceDate = invoice?.invoice_date || row.created_at;
        const invoiceDateObj = parsePacificDate(invoiceDate) || new Date(invoiceDate);

        if (startObj && invoiceDateObj < startObj) return;
        if (endInclusive && invoiceDateObj >= endInclusive) return;

        const entry = {
          price: Number(priceValue),
          invoiceDate,
          invoiceDateObj,
          vendor: invoice?.vendor_name || invoice?.vendor || (itemLookup.get(itemId)?.vendor || 'Unknown'),
          createdAt: row.created_at
        };

        if (!grouped.has(itemId)) grouped.set(itemId, []);
        grouped.get(itemId).push(entry);
      });

      const results = [];
      grouped.forEach((entries, itemId) => {
        entries.sort((a, b) => (b.invoiceDateObj?.getTime() || 0) - (a.invoiceDateObj?.getTime() || 0));
        const computedEntries = entries.map((entry, index) => {
          const prev = entries[index + 1] || null;
          const diff = prev ? entry.price - prev.price : null;
          const diffPct = diff != null && prev.price !== 0 ? (diff / prev.price) * 100 : null;
          return {
            ...entry,
            diff,
            diffPct,
            previousPrice: prev ? prev.price : null,
            previousDate: prev ? prev.invoiceDate : null
          };
        });

        const inventoryItem = itemLookup.get(itemId);
        results.push({
          itemId,
          item: inventoryItem,
          entries: computedEntries
        });
      });

      orderingSystemState.priceHistory.results = results;
      orderingSystemState.priceHistory.lastFetchParams = { startDate, endDate, vendorFilter, itemIds };

      renderPriceHistoryResults(results);

      if (statusEl) {
        const totalEntries = results.reduce((sum, group) => sum + group.entries.length, 0);
        statusEl.textContent = `${totalEntries} price point${totalEntries === 1 ? '' : 's'} across ${results.length} item${results.length === 1 ? '' : 's'}.`;
      }
    } catch (error) {
      console.error('Failed to load price history:', error);
      if (statusEl) statusEl.textContent = 'Failed to load price history.';
      resultsContainer.innerHTML = `<p style="color: #c62828; font-size: 12px;">Error: ${error.message}</p>`;
    }
  }

  function renderPriceHistoryResults(results) {
    const container = document.getElementById('priceHistoryResults');
    if (!container) return;

    if (!results || results.length === 0) {
      container.innerHTML = '<p style="color: var(--gray-600); font-size: 12px;">No pricing data found for the selected filters.</p>';
      return;
    }

    let html = '';
    results.forEach(group => {
      const itemName = group.item ? group.item.itemName : `Item #${group.itemId}`;
      const vendor = group.item ? (group.item.vendor || 'Other') : 'Unknown';

      html += `
        <div style="border: 2px solid var(--gray-300); margin-bottom: 18px; background: white;">
          <div style="padding: 12px 16px; background: var(--gray-900); color: white; display: flex; justify-content: space-between; align-items: center;">
            <div style="font-weight: 700; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;">${itemName}</div>
            <div style="font-size: 12px; color: rgba(255,255,255,0.8);">Vendor: ${vendor}</div>
          </div>
          <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
            <thead>
              <tr style="background: #f5f5f5; color: #444; text-transform: uppercase; font-size: 11px;">
                <th style="padding: 8px; border-bottom: 1px solid #e0e0e0; text-align: left;">Date</th>
                <th style="padding: 8px; border-bottom: 1px solid #e0e0e0; text-align: left;">Vendor</th>
                <th style="padding: 8px; border-bottom: 1px solid #e0e0e0; text-align: right;">Price</th>
                <th style="padding: 8px; border-bottom: 1px solid #e0e0e0; text-align: right;">Δ vs Prev</th>
              </tr>
            </thead>
            <tbody>
              ${group.entries.map((entry, idx) => {
                const rowColor = idx % 2 === 0 ? 'white' : '#fafafa';
                const arrow = entry.diff > 0 ? '▲' : entry.diff < 0 ? '▼' : '•';
                const color = entry.diff > 0 ? '#c62828' : entry.diff < 0 ? '#2e7d32' : 'var(--gray-500)';
                const diffLabel = entry.diff != null ? `${formatCurrency(Math.abs(entry.diff))}${entry.diffPct != null ? ` (${formatPercentage(Math.abs(entry.diffPct))})` : ''}` : '--';
                const diffHtml = entry.diff != null
                  ? `<span style="color: ${color}; font-weight: 600;">${arrow} ${diffLabel}</span>`
                  : '<span style="color: var(--gray-400);">--</span>';
                return `
                  <tr style="background: ${rowColor};">
                    <td style="padding: 8px; border-bottom: 1px solid #f0f0f0;">${formatPacificDateDisplay(entry.invoiceDateObj, { month: 'short', day: 'numeric', year: 'numeric' })}</td>
                    <td style="padding: 8px; border-bottom: 1px solid #f0f0f0;">${entry.vendor || 'Unknown'}</td>
                    <td style="padding: 8px; border-bottom: 1px solid #f0f0f0; text-align: right; font-weight: 600;">${formatCurrency(entry.price)}</td>
                    <td style="padding: 8px; border-bottom: 1px solid #f0f0f0; text-align: right;">${diffHtml}</td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        </div>
      `;
    });

    container.innerHTML = html;
  }

  // ============================================
  // PREP SHEET SYSTEM
  // ============================================

  /**
   * Check auto-print status and update disclaimer
   */
  async function checkAutoPrintStatus() {
    const statusDiv = document.getElementById('autoPrintStatus');
    if (!statusDiv) return;

    try {
      // Calculate 8-hour window (9pm to 4am) based on current time
      const now = new Date();
      const pacificNow = new Date(now.toLocaleString('en-US', { timeZone: 'America/Los_Angeles' }));
      const currentHour = pacificNow.getHours();

      let windowStart, windowEnd;

      if (currentHour >= 21) {
        // After 9pm - check from 9pm today to 4am tomorrow
        windowStart = new Date(pacificNow);
        windowStart.setHours(21, 0, 0, 0);

        windowEnd = new Date(windowStart);
        windowEnd.setDate(windowEnd.getDate() + 1); // Next day
        windowEnd.setHours(4, 0, 0, 0);
      } else if (currentHour < 4) {
        // Before 4am - check from 9pm yesterday to 4am today
        windowEnd = new Date(pacificNow);
        windowEnd.setHours(4, 0, 0, 0);

        windowStart = new Date(windowEnd);
        windowStart.setDate(windowStart.getDate() - 1); // Previous day
        windowStart.setHours(21, 0, 0, 0);
      } else {
        // Between 4am and 9pm - check LAST completed window (9pm yesterday to 4am today)
        windowEnd = new Date(pacificNow);
        windowEnd.setHours(4, 0, 0, 0);

        windowStart = new Date(windowEnd);
        windowStart.setDate(windowStart.getDate() - 1); // Previous day
        windowStart.setHours(21, 0, 0, 0);
      }

      console.log('Checking prep window:', windowStart.toLocaleString(), 'to', windowEnd.toLocaleString());

      // Check if any prep items were counted in the 8-hour window
      const { data: recentCounts, error } = await supabase
        .from('inventory_items')
        .select('item_name, last_counted_date')
        .or('vendor.eq.PREP,item_type.eq.prep')
        .gte('last_counted_date', windowStart.toISOString())
        .lte('last_counted_date', windowEnd.toISOString())
        .limit(5); // Get up to 5 items for display

      if (error) {
        console.error('Error checking auto-print status:', error);
        statusDiv.innerHTML = `
          <p style="text-align: center; padding: 12px; background: var(--gray-100); border-left: 4px solid var(--gray-500); color: var(--gray-700); font-size: 12px; border-radius: 0;">
            ⚠️ Unable to check auto-print status
          </p>
        `;
        return;
      }

      if (!recentCounts || recentCounts.length === 0) {
        // RED disclaimer: No counts detected
        statusDiv.innerHTML = `
          <div style="padding: 14px 16px; background: #fee2e2; border-left: 4px solid #dc2626; border-radius: 0;">
            <p style="color: #991b1b; font-size: 13px; margin: 0 0 8px 0; font-weight: 700;">
              ⚠️ NO AUTO-PRINT AT 4AM
            </p>
            <p style="color: #7f1d1d; font-size: 12px; margin: 0; line-height: 1.6;">
              No prep counts detected between 9pm and 4am. Please update stock counts above and click <strong>EMAIL TO PRINTER</strong> to get today's prep list.
            </p>
          </div>
        `;
      } else {
        // GREEN disclaimer: Auto-print ran successfully
        const itemNames = recentCounts.map(c => c.item_name).join(', ');
        const itemCount = recentCounts.length;

        statusDiv.innerHTML = `
          <div style="padding: 14px 16px; background: #d1fae5; border-left: 4px solid #059669; border-radius: 0;">
            <p style="color: #065f46; font-size: 13px; margin: 0 0 8px 0; font-weight: 700;">
              ✅ PREP LIST AUTO-PRINTED AT 4AM
            </p>
            <p style="color: #047857; font-size: 12px; margin: 0; line-height: 1.6;">
              ${itemCount} prep item${itemCount !== 1 ? 's' : ''} counted overnight (${itemNames}${itemCount === 5 ? ', ...' : ''}). <strong>Check the printer</strong> for today's auto-generated prep list.
            </p>
          </div>
        `;
      }

    } catch (error) {
      console.error('Error in checkAutoPrintStatus:', error);
      statusDiv.innerHTML = `
        <p style="text-align: center; padding: 12px; background: var(--gray-100); border-left: 4px solid var(--gray-500); color: var(--gray-700); font-size: 12px; border-radius: 0;">
          ⚠️ Error checking auto-print status
        </p>
      `;
    }
  }

  /**
   * Refresh prep sheet with current recommendations
   */
  async function refreshPrepSheet() {
    console.log('Refreshing prep sheet...');

    // Check auto-print status when refreshing
    checkAutoPrintStatus();
    const prepItems = orderingSystemState.items.filter(item => item.vendor === 'PREP' || item.itemType === 'prep');

    if (prepItems.length === 0) {
      document.getElementById('prepRecommendationsList').innerHTML = `
        <div style="text-align: center; padding: 40px; background: #f8f9fa; border-radius: 8px;">
          <p style="color: #666; font-size: 16px;">No prep items found. Add prep items to get started!</p>
        </div>
      `;
      return;
    }

    // Fetch consumption data for all prep items
    const todayPacificDate = getPacificMidday();
    const today = formatPacificDate(todayPacificDate);
    const sevenDaysAgoDate = addPacificDays(todayPacificDate, -7);
    const sevenDaysAgo = formatPacificDate(sevenDaysAgoDate);

    try {
      const { data: consumptionData, error } = await supabase
        .from('prep_consumption_log')
        .select('*')
        .gte('count_date', sevenDaysAgo)
        .lte('count_date', today);

      if (error) throw error;

      // Calculate recommendations for each prep item
      const recommendations = prepItems
        .map(item => calculatePrepRecommendation(item, consumptionData))
        .filter(rec => rec !== null); // Filter out null returns (e.g., line cooks prep with good stock)

      // Sort by priority (lowest stock % first, then by consumption rate)
      recommendations.sort((a, b) => {
        if (a.stockPercentage !== b.stockPercentage) {
          return a.stockPercentage - b.stockPercentage;
        }
        return (b.avgConsumptionRate || 0) - (a.avgConsumptionRate || 0);
      });

      // Render summary stats
      renderPrepSummaryStats(recommendations);

      // Render recommendations list
      renderPrepRecommendations(recommendations);

    } catch (error) {
      console.error('Error refreshing prep sheet:', error);
      showMessage(`Error loading prep data: ${error.message}`, 'error');
    }
  }

  /**
   * Calculate recommendation for a single prep item
   */
  function calculatePrepRecommendation(item, consumptionData) {
    // Filter consumption data for this item
    const itemConsumption = consumptionData.filter(c => c.item_id === item.id);

    // Calculate average consumption rate
    let avgConsumptionRate = 0;
    let totalConsumption = 0;
    if (itemConsumption.length > 0) {
      totalConsumption = itemConsumption.reduce((sum, c) => sum + (c.consumption_amount || 0), 0);
      avgConsumptionRate = totalConsumption / itemConsumption.length;
    }

    // Calculate stock percentage (current / par)
    const stockPercentage = item.parLevel > 0 ? (item.currentStock / item.parLevel) * 100 : 0;

    // Check flags from database
    const isLineCooksPrep = item.lineCooksPrep || false;
    const isNotMadeDaily = item.notMadeDaily || false;

    // Determine recommendation amount
    let recommendedAmount = 0;
    let priority = 'low';
    let reasoning = '';

    if (isNotMadeDaily) {
      // Special logic for items not made daily - use percentage-based thresholds
      if (item.currentStock === 0) {
        recommendedAmount = Math.ceil(item.parLevel);
        priority = 'urgent';
        reasoning = `Out of stock - Not made daily, check with manager first`;
      } else if (stockPercentage < 30) {
        // Very low stock - urgent
        recommendedAmount = Math.ceil(item.parLevel - item.currentStock);
        priority = 'urgent';
        reasoning = `Critical low (${stockPercentage.toFixed(0)}%) - Not made daily, check with manager`;
      } else if (stockPercentage < 50) {
        // Low stock - high priority
        recommendedAmount = Math.ceil(item.parLevel - item.currentStock);
        priority = 'high';
        reasoning = `Low stock (${stockPercentage.toFixed(0)}%) - Not made daily, check with manager`;
      } else if (stockPercentage < 70) {
        // Medium stock
        recommendedAmount = Math.ceil(item.parLevel - item.currentStock);
        priority = 'medium';
        reasoning = `Stock at ${stockPercentage.toFixed(0)}% - Not made daily, check with manager`;
      } else {
        // Stock is good
        priority = 'low';
        reasoning = `Stock good (${stockPercentage.toFixed(0)}%) - Not made daily`;
      }
    } else if (isLineCooksPrep) {
      // Special logic for line cooks prep items (Chili Oil, Iskender Sauce)
      // Only show in prep sheet when stock is low
      if (item.currentStock === 0) {
        recommendedAmount = Math.max(item.parLevel, Math.ceil(avgConsumptionRate * 2));
        priority = 'urgent';
        reasoning = 'Out of stock - line cooks need to prep';
      } else if (stockPercentage < 50) {
        recommendedAmount = Math.ceil(item.parLevel - item.currentStock);
        priority = 'high';
        reasoning = `Stock below 50% (${stockPercentage.toFixed(0)}%) - line cooks prep`;
      } else if (stockPercentage < 75) {
        recommendedAmount = Math.ceil(item.parLevel - item.currentStock);
        priority = 'medium';
        reasoning = `Stock at ${stockPercentage.toFixed(0)}% - line cooks prep`;
      } else {
        // Don't show in prep sheet if stock is good
        return null;
      }
    } else {
      // Standard logic for regular prep items
      if (item.currentStock === 0) {
        // Out of stock - urgent
        recommendedAmount = Math.max(item.parLevel, Math.ceil(avgConsumptionRate * 2)); // At least par or 2x consumption
        priority = 'urgent';
        reasoning = 'Out of stock - make immediately';
      } else if (stockPercentage < 50) {
        // Low stock - high priority
        recommendedAmount = Math.ceil(item.parLevel - item.currentStock);
        priority = 'high';
        reasoning = `Stock below 50% (${stockPercentage.toFixed(0)}%)`;
      } else if (stockPercentage < 75 && avgConsumptionRate > 0) {
        // Medium stock but consuming - medium priority
        recommendedAmount = Math.ceil(avgConsumptionRate * 1.5);
        priority = 'medium';
        reasoning = `Stock at ${stockPercentage.toFixed(0)}%, consuming ${avgConsumptionRate.toFixed(1)}/session`;
      } else {
        // Stock is good
        priority = 'low';
        reasoning = `Stock good (${stockPercentage.toFixed(0)}%)`;
      }
    }

    return {
      id: item.id,
      itemName: item.itemName,
      currentStock: item.currentStock,
      parLevel: item.parLevel,
      unit: item.unit,
      stockPercentage,
      avgConsumptionRate,
      recommendedAmount,
      priority,
      reasoning,
      urgent: item.urgent || false,
      lineCooksPrep: item.lineCooksPrep || false,
      notMadeDaily: item.notMadeDaily || false,
      lastCountedDate: item.lastCountedDate
    };
  }

  /**
   * Render summary statistics (grayscale styling)
   */
  function renderPrepSummaryStats(recommendations) {
    const urgent = recommendations.filter(r => r.priority === 'urgent').length;
    const high = recommendations.filter(r => r.priority === 'high').length;
    const medium = recommendations.filter(r => r.priority === 'medium').length;
    const low = recommendations.filter(r => r.priority === 'low').length;

    const totalToPrepare = recommendations.filter(r => r.recommendedAmount > 0).length;

    document.getElementById('prepSummaryStats').innerHTML = `
      <div style="background: #f5f5f5; padding: 16px; border-radius: 0; border: 2px solid #212121;">
        <div style="font-size: 24px; font-weight: 700; color: #212121;">${urgent}</div>
        <div style="font-size: 11px; color: #666; margin-top: 4px; text-transform: uppercase; letter-spacing: 0.5px;">Urgent Items</div>
      </div>
      <div style="background: #f5f5f5; padding: 16px; border-radius: 0; border: 2px solid #424242;">
        <div style="font-size: 24px; font-weight: 700; color: #424242;">${high}</div>
        <div style="font-size: 11px; color: #666; margin-top: 4px; text-transform: uppercase; letter-spacing: 0.5px;">High Priority</div>
      </div>
      <div style="background: #f5f5f5; padding: 16px; border-radius: 0; border: 2px solid #666;">
        <div style="font-size: 24px; font-weight: 700; color: #666;">${medium}</div>
        <div style="font-size: 11px; color: #666; margin-top: 4px; text-transform: uppercase; letter-spacing: 0.5px;">Medium Priority</div>
      </div>
      <div style="background: #f5f5f5; padding: 16px; border-radius: 0; border: 2px solid #2196F3;">
        <div style="font-size: 24px; font-weight: 700; color: #2196F3;">${totalToPrepare}</div>
        <div style="font-size: 11px; color: #666; margin-top: 4px; text-transform: uppercase; letter-spacing: 0.5px;">Total to Prepare</div>
      </div>
    `;
  }

  /**
   * Render prep recommendations list
   */
  function renderPrepRecommendations(recommendations) {
    const container = document.getElementById('prepRecommendationsList');

    // Store recommendations for print/PDF
    orderingSystemState.prepRecommendations = recommendations;

    if (recommendations.length === 0) {
      container.innerHTML = `
        <div style="text-align: center; padding: 40px;">
          <p style="color: #666;">All prep items are well-stocked! 🎉</p>
        </div>
      `;
      return;
    }

    // Group by priority and sort by stock percentage (lowest to highest)
    // FIRST: Filter MAKE FIRST items (urgent flag set)
    const makeFirst = recommendations.filter(r => r.urgent === true)
      .sort((a, b) => a.stockPercentage - b.stockPercentage);

    // SECOND: Filter LINE COOKS PREP items (lineCooksPrep flag set, exclude urgent items)
    const lineCooksPrep = recommendations.filter(r => r.lineCooksPrep === true && r.urgent !== true)
      .sort((a, b) => a.stockPercentage - b.stockPercentage);

    // THEN: Regular priority groups (exclude urgent and lineCooksPrep flagged items)
    const urgent = recommendations.filter(r => r.priority === 'urgent' && r.urgent !== true && r.lineCooksPrep !== true)
      .sort((a, b) => a.stockPercentage - b.stockPercentage);
    const high = recommendations.filter(r => r.priority === 'high' && r.urgent !== true && r.lineCooksPrep !== true)
      .sort((a, b) => a.stockPercentage - b.stockPercentage);
    const medium = recommendations.filter(r => r.priority === 'medium' && r.urgent !== true && r.lineCooksPrep !== true)
      .sort((a, b) => a.stockPercentage - b.stockPercentage);
    const low = recommendations.filter(r => r.priority === 'low' && r.urgent !== true && r.lineCooksPrep !== true)
      .sort((a, b) => a.stockPercentage - b.stockPercentage);

    let html = '';

    // Render MAKE FIRST category at the very top
    if (makeFirst.length > 0) {
      html += renderPriorityGroup('MAKE FIRST', makeFirst, 'makeFirst');
    }

    // Render LINE COOKS PREP category second
    if (lineCooksPrep.length > 0) {
      html += renderPriorityGroup('LINE COOKS PREP', lineCooksPrep, 'lineCooksPrep');
    }

    // Render each priority group with grayscale styling (matching PDF)
    if (urgent.length > 0) {
      html += renderPriorityGroup('URGENT - Out of Stock', urgent, 'urgent');
    }
    if (high.length > 0) {
      html += renderPriorityGroup('HIGH PRIORITY - Low Stock', high, 'high');
    }
    if (medium.length > 0) {
      html += renderPriorityGroup('MEDIUM PRIORITY', medium, 'medium');
    }
    if (low.length > 0) {
      html += renderPriorityGroup('LOW PRIORITY - Stock Good', low, 'low');
    }

    container.innerHTML = html;
  }

  /**
   * Render a priority group of recommendations (matching PDF styling)
   */
  function renderPriorityGroup(title, items, priority) {
    // LOW PRIORITY: compact list format
    if (priority === 'low') {
      const itemList = items.map(item =>
        `<span style="display: inline-block; width: 32%; padding: 4px 6px; font-size: 11px; color: #666;">${item.itemName} (${item.stockPercentage.toFixed(0)}%)</span>`
      ).join('');

      return `
        <div style="margin-bottom: 20px;">
          <div style="
            background: #424242;
            color: white;
            padding: 10px 14px;
            font-size: 13px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            border-radius: 0;
          ">
            ${title} (${items.length} items)
          </div>
          <div style="background: white; border: 2px solid #424242; border-top: none; padding: 12px 14px; display: flex; flex-wrap: wrap;">
            ${itemList}
          </div>
        </div>
      `;
    }

    // URGENT, HIGH, MEDIUM: full table format
    const headerBg = priority === 'makeFirst' ? '#dc0000' : priority === 'lineCooksPrep' ? '#4a148c' : priority === 'urgent' ? '#212121' : '#424242';

    const itemsHTML = items.map(item => {
      const lastCountStr = item.lastCountedDate ? formatRelativeTime(item.lastCountedDate) : 'Never';
      const isOut = item.currentStock === 0;
      const stockStatus = isOut ? 'OUT' : `${item.currentStock} ${item.unit}`;

      return `
        <div style="
          display: grid;
          grid-template-columns: 2fr 1fr 1fr 1fr 0.75fr 2fr;
          gap: 8px;
          padding: 12px 16px;
          border-bottom: 1px solid #e0e0e0;
          align-items: center;
        ">
          <div>
            <div style="font-weight: 700; font-size: 13px; color: #212121; text-transform: uppercase; letter-spacing: 0.3px;">${item.itemName}</div>
            <div style="font-size: 10px; color: #999; margin-top: 2px;">Last count: ${lastCountStr}</div>
          </div>
          <div style="text-align: center;">
            <div style="font-weight: 700; font-size: 14px; color: ${isOut ? '#d32f2f' : '#212121'};">${stockStatus}</div>
            <div style="font-size: 9px; color: #666; text-transform: uppercase; margin-top: 2px;">Current</div>
          </div>
          <div style="text-align: center;">
            <div style="font-weight: 700; font-size: 14px; color: #212121;">${item.parLevel} ${item.unit}</div>
            <div style="font-size: 9px; color: #666; text-transform: uppercase; margin-top: 2px;">Par</div>
          </div>
          <div style="text-align: center;">
            <div style="font-weight: 700; font-size: 16px; color: #2196F3;">${item.recommendedAmount > 0 ? item.recommendedAmount : '—'}</div>
            <div style="font-size: 9px; color: #666; text-transform: uppercase; margin-top: 2px;">Make</div>
          </div>
          <div style="text-align: center;">
            <div style="font-weight: 700; font-size: 14px; color: #666;">${item.unit}</div>
            <div style="font-size: 9px; color: #666; text-transform: uppercase; margin-top: 2px;">Unit</div>
          </div>
          <div style="font-size: 11px; color: #666; font-style: italic;">
            ${item.reasoning}
          </div>
        </div>
      `;
    }).join('');

    return `
      <div style="margin-bottom: 20px;">
        <div style="
          background: ${headerBg};
          color: white;
          padding: 10px 14px;
          font-size: 13px;
          font-weight: 700;
          text-transform: uppercase;
          letter-spacing: 0.8px;
          border-radius: 0;
        ">
          ${title} (${items.length} items)
        </div>
        <div style="background: white; border: 2px solid ${headerBg}; border-top: none;">
          <!-- Header Row -->
          <div style="
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 0.75fr 2fr;
            gap: 8px;
            padding: 8px 16px;
            background: #f5f5f5;
            border-bottom: 2px solid #e0e0e0;
            font-size: 10px;
            font-weight: 700;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
          ">
            <div>ITEM NAME</div>
            <div style="text-align: center;">CURRENT</div>
            <div style="text-align: center;">PAR</div>
            <div style="text-align: center;">MAKE</div>
            <div style="text-align: center;">UNIT</div>
            <div>REASON</div>
          </div>
          ${itemsHTML}
        </div>
      </div>
    `;
  }

  /**
   * Calculate estimated height for all PDF content
   */
  function calculateContentHeight(sections, customNotesHeight) {
    let totalHeight = 0;
    
    // Header: 0.4" (fixed)
    totalHeight += 0.4;
    
    // Custom notes (if any)
    totalHeight += customNotesHeight;
    
    // Each section
    sections.forEach(section => {
      if (!section.items || section.items.length === 0) return;
      
      // Section header: 0.18"
      totalHeight += 0.18;
      
      if (section.isCompact) {
        // Compact format: header gap + (items * lineHeight) + bottom margin
        const itemsPerColumn = Math.ceil(section.items.length / section.columns);
        totalHeight += 0.08 + (itemsPerColumn * 0.20) + 0.08;
      } else {
        // Table format: header + (rows * avgRowHeight) + bottom margin
        const avgRowHeight = 0.21; // 0.18 minCellHeight + 0.03 padding
        totalHeight += (section.items.length * avgRowHeight) + 0.06;
      }
    });
    
    // Footer: 0.4"
    totalHeight += 0.4;
    
    return totalHeight;
  }

  /**
   * Calculate dynamic scale factor to fit content on one page
   */
  function calculateScaleFactor(estimatedHeight) {
    const MAX_PAGE_HEIGHT = 9.5; // Usable page height (0.7" to 10.2")
    
    if (estimatedHeight <= MAX_PAGE_HEIGHT) {
      return 1.0; // No scaling needed
    }
    
    // Calculate scale factor, but don't go below 0.70 (70%) for readability
    const scaleFactor = MAX_PAGE_HEIGHT / estimatedHeight;
    return Math.max(0.70, Math.min(1.0, scaleFactor));
  }

  /**
   * Generate prep sheet PDF with compact grayscale design
   */
  async function generatePrepSheetPDF() {
    const recommendations = orderingSystemState.prepRecommendations;
    if (!recommendations || recommendations.length === 0) {
      showMessage('No prep recommendations to export', 'warning');
      return;
    }

    showMessage('Generating prep sheet PDF...', 'info');

    try {
      // Check if jsPDF is loaded
      if (typeof jspdf === 'undefined' || typeof jspdf.jsPDF === 'undefined') {
        throw new Error('jsPDF library not loaded. Please refresh the page.');
      }

      const { jsPDF } = jspdf;
      const doc = new jsPDF({
        orientation: 'portrait',
        unit: 'in',
        format: 'letter'
      });

      const jaynaBlue = [33, 150, 243]; // #2196F3
      const darkGray = [66, 66, 66]; // #424242
      const black = [33, 33, 33]; // #212121
      const lightGray = [245, 245, 245]; // #f5f5f5

      // Date logic: If after 8pm Pacific, use next day's date
      const now = new Date();
      const currentHour = getPacificHour(now);
      const baseDate = getPacificMidday(now);
      const prepDate = currentHour !== null && currentHour >= 20 ? addPacificDays(baseDate, 1) : baseDate;
      const dateStr = formatPacificDateDisplay(prepDate, { month: '2-digit', day: '2-digit', year: 'numeric' });
      const timeStr = formatPacificDateDisplay(now, { hour: '2-digit', minute: '2-digit' });

      // Calculate custom notes height
      const customNotes = document.getElementById('prepSheetNotes')?.value.trim();
      let customNotesHeight = 0;
      if (customNotes) {
        const notesLines = doc.splitTextToSize(customNotes, 7).length;
        customNotesHeight = 0.6 + (notesLines > 2 ? (notesLines - 2) * 0.1 : 0);
      }

      // Prepare all sections for height calculation
      const bottledItems = recommendations.filter(r => {
        const nameMatch = isBottledOrToGoItem(r.itemName);
        const checkboxMatch = r.showInBottleCount === true;
        return nameMatch || checkboxMatch;
      });

      const prepItems = recommendations.filter(r => {
        const nameMatch = isBottledOrToGoItem(r.itemName);
        const checkboxMatch = r.showInBottleCount === true;
        return !nameMatch && !checkboxMatch;
      });

      const needsToBePrepped = (item) => {
        return item.currentStock === 0 || item.stockPercentage < 100 || item.recommendedAmount > 0;
      };

      const lineCooksPrep = prepItems.filter(r => r.lineCooksPrep === true && needsToBePrepped(r))
        .sort((a, b) => a.stockPercentage - b.stockPercentage);
      
      const makeFirst = prepItems.filter(r => r.urgent === true && !r.lineCooksPrep && needsToBePrepped(r))
        .sort((a, b) => a.stockPercentage - b.stockPercentage);
      
      const markedButNotNeeded = prepItems.filter(r => 
        (r.urgent === true && !r.lineCooksPrep) && !needsToBePrepped(r)
      );
      
      const urgent = prepItems.filter(r => r.priority === 'urgent' && !r.urgent && !r.lineCooksPrep);
      const high = prepItems.filter(r => r.priority === 'high' && !r.urgent && !r.lineCooksPrep);
      const medium = prepItems.filter(r => r.priority === 'medium' && !r.urgent && !r.lineCooksPrep);
      
      const low = [
        ...prepItems.filter(r => r.priority === 'low' && !r.urgent && !r.lineCooksPrep),
        ...markedButNotNeeded
      ];

      // Build sections array for height calculation
      const sections = [
        { items: bottledItems, isCompact: true, columns: 3 },
        { items: makeFirst, isCompact: false },
        { items: urgent, isCompact: false },
        { items: high, isCompact: false },
        { items: medium, isCompact: false },
        { items: low, isCompact: true, columns: 2 },
        { items: lineCooksPrep, isCompact: false }
      ];

      // Calculate total content height and scale factor
      const estimatedHeight = calculateContentHeight(sections, customNotesHeight);
      const scaleFactor = calculateScaleFactor(estimatedHeight);

      console.log(`PDF Content: ${estimatedHeight.toFixed(2)}" estimated, scale factor: ${scaleFactor.toFixed(2)}`);

      // Header
      doc.setFontSize(14 * scaleFactor);
      doc.setFont('helvetica', 'bold');
      doc.setTextColor(black[0], black[1], black[2]);
      doc.text('PREP SHEET - ' + dateStr, 4.25, 0.7, { align: 'center' });

      // Blue underline
      doc.setDrawColor(jaynaBlue[0], jaynaBlue[1], jaynaBlue[2]);
      doc.setLineWidth(0.02);
      doc.line(0.5, 0.78, 8, 0.78);

      // Subtitle
      doc.setFontSize(7 * scaleFactor);
      doc.setFont('helvetica', 'normal');
      doc.setTextColor(102, 102, 102);
      doc.text('Generated ' + timeStr, 4.25, 0.95, { align: 'center' });

      let yPos = 1.1;

      // Custom Notes Section (if provided) with dynamic font size
      if (customNotes) {
        doc.setFillColor(255, 249, 196); // Light yellow background
        doc.rect(0.5, yPos, 7.5, 0.5 * scaleFactor, 'F');
        doc.setDrawColor(jaynaBlue[0], jaynaBlue[1], jaynaBlue[2]);
        doc.setLineWidth(0.02);
        doc.rect(0.5, yPos, 7.5, 0.5 * scaleFactor);

        doc.setFontSize(8 * scaleFactor);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(black[0], black[1], black[2]);
        doc.text('CUSTOM NOTES:', 0.6, yPos + (0.15 * scaleFactor));

        doc.setFont('helvetica', 'normal');
        doc.setFontSize(7 * scaleFactor);
        const notesLines = doc.splitTextToSize(customNotes, 7);
        doc.text(notesLines, 0.6, yPos + (0.3 * scaleFactor));
        yPos += 0.6 * scaleFactor;
      }

      // Render all sections with scale factor (using arrays created above for height calculation)
      if (bottledItems.length > 0) {
        yPos = renderCompactList(doc, 'BOTTLED & TO-GO PREP CHECK', bottledItems, yPos, [33, 150, 243], 3, scaleFactor);
      }

      // Render all sections with scale factor
      if (makeFirst.length > 0) {
        yPos = renderPrepPDFSection(doc, 'MAKE FIRST', makeFirst, yPos, [220, 0, 0], scaleFactor);
      }
      if (urgent.length > 0) {
        yPos = renderPrepPDFSection(doc, 'URGENT - Out of Stock', urgent, yPos, black, scaleFactor);
      }
      if (high.length > 0) {
        yPos = renderPrepPDFSection(doc, 'HIGH PRIORITY - Low Stock', high, yPos, darkGray, scaleFactor);
      }
      if (medium.length > 0) {
        yPos = renderPrepPDFSection(doc, 'MEDIUM PRIORITY', medium, yPos, darkGray, scaleFactor);
      }
      if (low.length > 0) {
        yPos = renderCompactList(doc, 'LOW PRIORITY - Stock Good', low, yPos, darkGray, 2, scaleFactor);
      }
      if (lineCooksPrep.length > 0) {
        yPos = renderPrepPDFSection(doc, 'LINE COOKS PREP', lineCooksPrep, yPos, [75, 0, 130], scaleFactor);
      }

      // Footer with disclaimer (dynamically scaled)
      if (yPos < 10) {
        doc.setDrawColor(224, 224, 224);
        doc.line(0.5, 10.2, 8, 10.2);
        doc.setFontSize(6 * scaleFactor);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(153, 153, 153);
        doc.text('MISTAKES HAPPEN, PLEASE USE YOUR BRAIN WHEN READING THIS LIST AND', 4.25, 10.32, { align: 'center' });
        doc.text('DOUBLE CHECK BY CLARIFYING WITH YOUR MANAGER IF YOU DOUBT ANYTHING.', 4.25, 10.40, { align: 'center' });
        
        // Credit line
        doc.setFontSize(5.5 * scaleFactor);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(170, 170, 170);
        doc.text('PREP GENERATION FLOW CREATED AND DESIGNED BY DEMETRI GREGORAKIS', 4.25, 10.52, { align: 'center' });
      }

      // Save PDF
      const filename = `Prep_Sheet_${dateStr.replace(/\//g, '-')}.pdf`;
      doc.save(filename);

      showMessage('Prep sheet PDF generated successfully!', 'success');

      return doc; // Return for email function

    } catch (error) {
      console.error('PDF generation error:', error);
      showMessage('Failed to generate PDF: ' + error.message, 'error');
      throw error;
    }
  }

  /**
   * Email prep sheet PDF to Epson printer
   */
  async function emailPrepSheetToPrinter() {
    const recommendations = orderingSystemState.prepRecommendations;
    if (!recommendations || recommendations.length === 0) {
      showMessage('No prep recommendations to send', 'warning');
      return;
    }

    showMessage('Generating and sending prep sheet to printer...', 'info');

    try {
      // Check if jsPDF is loaded
      if (typeof jspdf === 'undefined' || typeof jspdf.jsPDF === 'undefined') {
        throw new Error('jsPDF library not loaded. Please refresh the page.');
      }

      const { jsPDF } = jspdf;
      const doc = new jsPDF({
        orientation: 'portrait',
        unit: 'in',
        format: 'letter'
      });

      const jaynaBlue = [33, 150, 243];
      const darkGray = [66, 66, 66];
      const black = [33, 33, 33];
      const lightGray = [245, 245, 245];

      // Date logic: If after 8pm Pacific, use next day's date
      const now = new Date();
      const currentHour = getPacificHour(now);
      const baseDate = getPacificMidday(now);
      const prepDate = currentHour !== null && currentHour >= 20 ? addPacificDays(baseDate, 1) : baseDate;
      const dateStr = formatPacificDateDisplay(prepDate, { month: '2-digit', day: '2-digit', year: 'numeric' });
      const timeStr = formatPacificDateDisplay(now, { hour: '2-digit', minute: '2-digit' });

      // Calculate custom notes height
      const customNotes = document.getElementById('prepSheetNotes')?.value.trim();
      let customNotesHeight = 0;
      if (customNotes) {
        const notesLines = doc.splitTextToSize(customNotes, 7).length;
        customNotesHeight = 0.6 + (notesLines > 2 ? (notesLines - 2) * 0.1 : 0);
      }

      // Prepare all sections for height calculation (same as generatePrepSheetPDF)
      const bottledItems = recommendations.filter(r => {
        const nameMatch = isBottledOrToGoItem(r.itemName);
        const checkboxMatch = r.showInBottleCount === true;
        return nameMatch || checkboxMatch;
      });

      const prepItems = recommendations.filter(r => {
        const nameMatch = isBottledOrToGoItem(r.itemName);
        const checkboxMatch = r.showInBottleCount === true;
        return !nameMatch && !checkboxMatch;
      });

      const needsToBePrepped = (item) => {
        return item.currentStock === 0 || item.stockPercentage < 100 || item.recommendedAmount > 0;
      };

      const lineCooksPrep = prepItems.filter(r => r.lineCooksPrep === true && needsToBePrepped(r))
        .sort((a, b) => a.stockPercentage - b.stockPercentage);
      
      const makeFirst = prepItems.filter(r => r.urgent === true && !r.lineCooksPrep && needsToBePrepped(r))
        .sort((a, b) => a.stockPercentage - b.stockPercentage);
      
      const markedButNotNeeded = prepItems.filter(r => 
        (r.urgent === true && !r.lineCooksPrep) && !needsToBePrepped(r)
      );
      
      const urgent = prepItems.filter(r => r.priority === 'urgent' && !r.urgent && !r.lineCooksPrep);
      const high = prepItems.filter(r => r.priority === 'high' && !r.urgent && !r.lineCooksPrep);
      const medium = prepItems.filter(r => r.priority === 'medium' && !r.urgent && !r.lineCooksPrep);
      
      const low = [
        ...prepItems.filter(r => r.priority === 'low' && !r.urgent && !r.lineCooksPrep),
        ...markedButNotNeeded
      ];

      // Build sections array for height calculation
      const sections = [
        { items: bottledItems, isCompact: true, columns: 3 },
        { items: makeFirst, isCompact: false },
        { items: urgent, isCompact: false },
        { items: high, isCompact: false },
        { items: medium, isCompact: false },
        { items: low, isCompact: true, columns: 2 },
        { items: lineCooksPrep, isCompact: false }
      ];

      // Calculate total content height and scale factor
      const estimatedHeight = calculateContentHeight(sections, customNotesHeight);
      const scaleFactor = calculateScaleFactor(estimatedHeight);

      console.log(`PDF Email Content: ${estimatedHeight.toFixed(2)}" estimated, scale factor: ${scaleFactor.toFixed(2)}`);

      // Header
      doc.setFontSize(14 * scaleFactor);
      doc.setFont('helvetica', 'bold');
      doc.setTextColor(black[0], black[1], black[2]);
      doc.text('PREP SHEET - ' + dateStr, 4.25, 0.7, { align: 'center' });

      doc.setDrawColor(jaynaBlue[0], jaynaBlue[1], jaynaBlue[2]);
      doc.setLineWidth(0.02);
      doc.line(0.5, 0.78, 8, 0.78);

      doc.setFontSize(7 * scaleFactor);
      doc.setFont('helvetica', 'normal');
      doc.setTextColor(102, 102, 102);
      doc.text('Generated ' + timeStr, 4.25, 0.95, { align: 'center' });

      let yPos = 1.1;

      // Custom Notes with dynamic font size
      if (customNotes) {
        doc.setFillColor(255, 249, 196);
        doc.rect(0.5, yPos, 7.5, 0.5 * scaleFactor, 'F');
        doc.setDrawColor(jaynaBlue[0], jaynaBlue[1], jaynaBlue[2]);
        doc.setLineWidth(0.02);
        doc.rect(0.5, yPos, 7.5, 0.5 * scaleFactor);

        doc.setFontSize(8 * scaleFactor);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(black[0], black[1], black[2]);
        doc.text('CUSTOM NOTES:', 0.6, yPos + (0.15 * scaleFactor));

        doc.setFont('helvetica', 'normal');
        doc.setFontSize(7 * scaleFactor);
        const notesLines = doc.splitTextToSize(customNotes, 7);
        doc.text(notesLines, 0.6, yPos + (0.3 * scaleFactor));
        yPos += 0.6 * scaleFactor;
      }

      // Render all sections with scale factor
      if (bottledItems.length > 0) {
        yPos = renderCompactList(doc, 'BOTTLED & TO-GO PREP CHECK', bottledItems, yPos, [33, 150, 243], 3, scaleFactor);
      }
      if (makeFirst.length > 0) {
        yPos = renderPrepPDFSection(doc, 'MAKE FIRST', makeFirst, yPos, [220, 0, 0], scaleFactor);
      }
      if (urgent.length > 0) {
        yPos = renderPrepPDFSection(doc, 'URGENT - Out of Stock', urgent, yPos, black, scaleFactor);
      }
      if (high.length > 0) {
        yPos = renderPrepPDFSection(doc, 'HIGH PRIORITY - Low Stock', high, yPos, darkGray, scaleFactor);
      }
      if (medium.length > 0) {
        yPos = renderPrepPDFSection(doc, 'MEDIUM PRIORITY', medium, yPos, darkGray, scaleFactor);
      }
      if (low.length > 0) {
        yPos = renderCompactList(doc, 'LOW PRIORITY - Stock Good', low, yPos, darkGray, 2, scaleFactor);
      }
      if (lineCooksPrep.length > 0) {
        yPos = renderPrepPDFSection(doc, 'LINE COOKS PREP', lineCooksPrep, yPos, [75, 0, 130], scaleFactor);
      }

      // Footer (dynamically scaled)
      if (yPos < 10) {
        doc.setDrawColor(224, 224, 224);
        doc.line(0.5, 10.2, 8, 10.2);
        doc.setFontSize(6 * scaleFactor);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(153, 153, 153);
        doc.text('MISTAKES HAPPEN, PLEASE USE YOUR BRAIN WHEN READING THIS LIST AND', 4.25, 10.32, { align: 'center' });
        doc.text('DOUBLE CHECK BY CLARIFYING WITH YOUR MANAGER IF YOU DOUBT ANYTHING.', 4.25, 10.40, { align: 'center' });
        
        // Credit line
        doc.setFontSize(5.5 * scaleFactor);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(170, 170, 170);
        doc.text('PREP GENERATION FLOW CREATED AND DESIGNED BY DEMETRI GREGORAKIS', 4.25, 10.52, { align: 'center' });
      }

      // Get PDF as base64
      const pdfBase64 = doc.output('datauristring').split(',')[1];
      const filename = `Prep_Sheet_${dateStr.replace(/\//g, '-')}.pdf`;

      // Send via backend Gmail API
      const response = await fetch('/api/send-prep-sheet-email', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          pdfBase64: pdfBase64,
          filename: filename,
          subject: `Prep Sheet - ${dateStr}`,
          toEmail: 'GSS4168CTJJA73@print.epsonconnect.com'
        })
      });

      const result = await response.json();

      if (!response.ok) {
        throw new Error(result.error || 'Failed to send email');
      }

      showMessage('✅ Prep sheet sent to printer successfully!', 'success');

    } catch (error) {
      console.error('Email send error:', error);
      showMessage('Failed to send to printer: ' + error.message, 'error');
    }
  }

  function buildBottledSauceSummary(recommendations = []) {
    const summary = [];

    // Get all bottled/to-go items from recommendations
    recommendations.forEach((item) => {
      // Check if item should be in bottle section:
      // 1. Has "BOTTLED" in name
      // 2. Has "TO GO" or "TO-GO" in name
      // 3. Has showInBottleCount checkbox checked
      const nameMatch = isBottledOrToGoItem(item.itemName);
      const checkboxMatch = item.showInBottleCount === true;
      
      if (nameMatch || checkboxMatch) {
        const quantitySource = item.currentStock != null ? item.currentStock : item.recommendedAmount;
        summary.push({
          label: item.itemName,
          quantity: formatPrepQuantity(quantitySource),
          lastCounted: formatLastCountedDetail(item.lastCountedDate)
        });
      }
    });

    // Sort alphabetically by label
    summary.sort((a, b) => a.label.localeCompare(b.label));

    return summary;
  }

  function formatPrepQuantity(value) {
    if (value === null || value === undefined) return '—';
    const number = Number(value);
    if (!Number.isFinite(number)) return '—';
    if (Math.abs(number % 1) < 0.01) return number.toString();
    return number.toFixed(2).replace(/\.00$/, '');
  }

  function formatCurrencyInput(value) {
    if (!Number.isFinite(value)) return '';
    return Number(value).toFixed(2);
  }

  function formatLastCountedDetail(dateStr) {
    if (!dateStr) return 'Never';
    const date = new Date(dateStr);
    if (Number.isNaN(date.getTime())) return 'Never';
    const datePart = formatPacificDateDisplay(date, { month: '2-digit', day: '2-digit', year: 'numeric' });
    const timePart = formatPacificDateDisplay(date, { hour: '2-digit', minute: '2-digit' });
    return `${datePart} ${timePart}`;
  }

  /**
   * Generate pending orders PDF (download version - matches email version exactly)
   */
  async function generatePendingOrdersPDF() {
    showMessage('Generating pending orders PDF...', 'info');

    try {
      // Check if jsPDF is loaded
      if (typeof jspdf === 'undefined' || typeof jspdf.jsPDF === 'undefined') {
        throw new Error('jsPDF library not loaded. Please refresh the page.');
      }

      // Fetch pending orders
      const { data: orders, error } = await supabase
        .from('pending_orders')
        .select(`
          *,
          pending_order_items (
            id,
            inventory_item_id,
            quantity_ordered,
            unit,
            item_name,
            quantity_received,
            variance
          )
        `)
        .in('status', ['pending', 'partial'])
        .order('expected_delivery_date', { ascending: true });

      if (error) throw error;

      if (!orders || orders.length === 0) {
        showMessage('No pending orders to export', 'warning');
        return;
      }

      const { jsPDF } = jspdf;
      const doc = new jsPDF({
        orientation: 'portrait',
        unit: 'in',
        format: 'letter'
      });

      const jaynaBlue = [33, 150, 243];
      const black = [33, 33, 33];
      const darkGray = [66, 66, 66];
      const lightGray = [102, 102, 102];

      let isFirstOrder = true;

      // Render each order (each gets its own page)
      for (const order of orders) {
        if (!isFirstOrder) {
          doc.addPage();
        }
        isFirstOrder = false;

        let yPos = 0.7;

        // BIG HEADER: "INCOMING ORDER FROM [VENDOR]"
        doc.setFontSize(16);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(black[0], black[1], black[2]);
        doc.text(`INCOMING ORDER FROM ${order.vendor.toUpperCase()}`, 4.25, yPos, { align: 'center' });
        yPos += 0.25;

        // SUBHEADER: "EXPECTED DELIVERY ON TUESDAY, 10/21/2025"
        const deliveryDate = new Date(order.expected_delivery_date + 'T12:00:00');
        const dayName = deliveryDate.toLocaleDateString('en-US', { weekday: 'long' }).toUpperCase();
        const dateStr = deliveryDate.toLocaleDateString('en-US', { month: '2-digit', day: '2-digit', year: 'numeric' });

        doc.setFontSize(14);
        doc.setFont('helvetica', 'bold');
        doc.text(`EXPECTED DELIVERY ON ${dayName}, ${dateStr}`, 4.25, yPos, { align: 'center' });
        yPos += 0.1;

        // Blue underline
        doc.setDrawColor(jaynaBlue[0], jaynaBlue[1], jaynaBlue[2]);
        doc.setLineWidth(0.02);
        doc.line(0.5, yPos, 8, yPos);
        yPos += 0.25;

        // ORDER METADATA: "Order generated by DEMETRI on Monday, 7:01PM"
        const orderDate = new Date(order.order_date || order.created_at);
        const orderDayName = orderDate.toLocaleDateString('en-US', { weekday: 'long' });
        const orderTime = orderDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
        const createdBy = order.created_by || 'System';

        doc.setFontSize(9);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(lightGray[0], lightGray[1], lightGray[2]);
        doc.text(`Order generated by ${createdBy} on ${orderDayName}, ${orderTime}`, 4.25, yPos, { align: 'center' });
        yPos += 0.15;

        // NOTES SECTION
        const notes = order.notes?.trim();
        if (!notes) {
          doc.text(`${createdBy.toUpperCase()} DID NOT LEAVE ANY NOTES`, 4.25, yPos, { align: 'center' });
          yPos += 0.3;
        } else {
          doc.text(`${createdBy.toUpperCase()} LEFT THESE NOTES:`, 4.25, yPos, { align: 'center' });
          yPos += 0.15;

          // Notes box
          doc.setFillColor(255, 249, 196);  // Light yellow background
          const notesLines = doc.splitTextToSize(notes, 7);
          const notesHeight = (notesLines.length * 0.12) + 0.15;
          doc.rect(0.5, yPos, 7.5, notesHeight, 'F');
          doc.setDrawColor(jaynaBlue[0], jaynaBlue[1], jaynaBlue[2]);
          doc.rect(0.5, yPos, 7.5, notesHeight);

          doc.setFontSize(8);
          doc.setFont('helvetica', 'normal');
          doc.setTextColor(black[0], black[1], black[2]);
          doc.text(notesLines, 0.6, yPos + 0.12);
          yPos += notesHeight + 0.2;
        }

        // ITEMS TABLE HEADER
        doc.setFontSize(10);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(darkGray[0], darkGray[1], darkGray[2]);
        doc.text('✓', 0.65, yPos, { align: 'center' });  // Checkbox column header
        doc.text('ITEM', 1.1, yPos);
        doc.text('QTY', 6.5, yPos);
        doc.text('UNIT', 7.2, yPos);
        yPos += 0.05;

        // Underline
        doc.setDrawColor(darkGray[0], darkGray[1], darkGray[2]);
        doc.setLineWidth(0.01);
        doc.line(0.5, yPos, 8, yPos);
        yPos += 0.2;

        // ITEMS WITH CHECKBOXES
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(9);

        const items = order.pending_order_items || [];
        for (const item of items) {
          if (yPos > 10) {
            doc.addPage();
            yPos = 0.7;
          }

          // Draw checkbox (empty square)
          doc.setDrawColor(black[0], black[1], black[2]);
          doc.setLineWidth(0.015);
          doc.rect(0.55, yPos - 0.12, 0.15, 0.15);  // Big checkbox

          // Item details
          doc.setTextColor(black[0], black[1], black[2]);
          doc.text(item.item_name || 'Unknown Item', 1.1, yPos, { maxWidth: 5 });
          doc.text(String(item.quantity_ordered || 0), 6.5, yPos);
          doc.text(item.unit || '', 7.2, yPos);

          yPos += 0.25;
        }
      }

      // Footer credit
      doc.setFontSize(6);
      doc.setFont('helvetica', 'italic');
      doc.setTextColor(150, 150, 150);
      doc.text('PREP GENERATION FLOW CREATED AND DESIGNED BY DEMETRI GREGORAKIS', 4.25, 10.7, { align: 'center' });

      // Save PDF
      const filename = `Pending_Orders_${getPacificDate()}.pdf`;
      doc.save(filename);

      showMessage('Pending orders PDF generated successfully!', 'success');

    } catch (error) {
      console.error('PDF generation error:', error);
      showMessage('Failed to generate PDF: ' + error.message, 'error');
    }
  }

  /**
   * Email pending orders PDF to printer
   */
  async function emailPendingOrdersToPrinter() {
    showMessage('Generating and sending pending orders to printer...', 'info');

    try {
      // Check if jsPDF is loaded
      if (typeof jspdf === 'undefined' || typeof jspdf.jsPDF === 'undefined') {
        throw new Error('jsPDF library not loaded. Please refresh the page.');
      }

      // Fetch pending orders
      const { data: orders, error } = await supabase
        .from('pending_orders')
        .select(`
          *,
          pending_order_items (
            id,
            inventory_item_id,
            quantity_ordered,
            unit,
            item_name,
            quantity_received,
            variance
          )
        `)
        .in('status', ['pending', 'partial'])
        .order('expected_delivery_date', { ascending: true });

      if (error) throw error;

      if (!orders || orders.length === 0) {
        showMessage('No pending orders to send', 'warning');
        return;
      }

      const { jsPDF } = jspdf;
      const doc = new jsPDF({
        orientation: 'portrait',
        unit: 'in',
        format: 'letter'
      });

      const jaynaBlue = [33, 150, 243];
      const black = [33, 33, 33];
      const darkGray = [66, 66, 66];
      const lightGray = [102, 102, 102];

      let isFirstOrder = true;

      // Render each order (each gets its own page)
      for (const order of orders) {
        if (!isFirstOrder) {
          doc.addPage();
        }
        isFirstOrder = false;

        let yPos = 0.7;

        // BIG HEADER: "INCOMING ORDER FROM [VENDOR]"
        doc.setFontSize(16);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(black[0], black[1], black[2]);
        doc.text(`INCOMING ORDER FROM ${order.vendor.toUpperCase()}`, 4.25, yPos, { align: 'center' });
        yPos += 0.25;

        // SUBHEADER: "EXPECTED DELIVERY ON TUESDAY, 10/21/2025"
        const deliveryDate = new Date(order.expected_delivery_date + 'T12:00:00');
        const dayName = deliveryDate.toLocaleDateString('en-US', { weekday: 'long' }).toUpperCase();
        const dateStr = deliveryDate.toLocaleDateString('en-US', { month: '2-digit', day: '2-digit', year: 'numeric' });

        doc.setFontSize(14);
        doc.setFont('helvetica', 'bold');
        doc.text(`EXPECTED DELIVERY ON ${dayName}, ${dateStr}`, 4.25, yPos, { align: 'center' });
        yPos += 0.1;

        // Blue underline
        doc.setDrawColor(jaynaBlue[0], jaynaBlue[1], jaynaBlue[2]);
        doc.setLineWidth(0.02);
        doc.line(0.5, yPos, 8, yPos);
        yPos += 0.25;

        // ORDER METADATA: "Order generated by DEMETRI on Monday, 7:01PM"
        const orderDate = new Date(order.order_date || order.created_at);
        const orderDayName = orderDate.toLocaleDateString('en-US', { weekday: 'long' });
        const orderTime = orderDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
        const createdBy = order.created_by || 'System';

        doc.setFontSize(9);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(lightGray[0], lightGray[1], lightGray[2]);
        doc.text(`Order generated by ${createdBy} on ${orderDayName}, ${orderTime}`, 4.25, yPos, { align: 'center' });
        yPos += 0.15;

        // NOTES SECTION
        const notes = order.notes?.trim();
        if (!notes) {
          doc.text(`${createdBy.toUpperCase()} DID NOT LEAVE ANY NOTES`, 4.25, yPos, { align: 'center' });
          yPos += 0.3;
        } else {
          doc.text(`${createdBy.toUpperCase()} LEFT THESE NOTES:`, 4.25, yPos, { align: 'center' });
          yPos += 0.15;

          // Notes box
          doc.setFillColor(255, 249, 196);  // Light yellow background
          const notesLines = doc.splitTextToSize(notes, 7);
          const notesHeight = (notesLines.length * 0.12) + 0.15;
          doc.rect(0.5, yPos, 7.5, notesHeight, 'F');
          doc.setDrawColor(jaynaBlue[0], jaynaBlue[1], jaynaBlue[2]);
          doc.rect(0.5, yPos, 7.5, notesHeight);

          doc.setFontSize(8);
          doc.setFont('helvetica', 'normal');
          doc.setTextColor(black[0], black[1], black[2]);
          doc.text(notesLines, 0.6, yPos + 0.12);
          yPos += notesHeight + 0.2;
        }

        // ITEMS TABLE HEADER
        doc.setFontSize(10);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(darkGray[0], darkGray[1], darkGray[2]);
        doc.text('✓', 0.65, yPos, { align: 'center' });  // Checkbox column header
        doc.text('ITEM', 1.1, yPos);
        doc.text('QTY', 6.5, yPos);
        doc.text('UNIT', 7.2, yPos);
        yPos += 0.05;

        // Underline
        doc.setDrawColor(darkGray[0], darkGray[1], darkGray[2]);
        doc.setLineWidth(0.01);
        doc.line(0.5, yPos, 8, yPos);
        yPos += 0.2;

        // ITEMS WITH CHECKBOXES
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(9);

        const items = order.pending_order_items || [];
        for (const item of items) {
          if (yPos > 10) {
            doc.addPage();
            yPos = 0.7;
          }

          // Draw checkbox (empty square)
          doc.setDrawColor(black[0], black[1], black[2]);
          doc.setLineWidth(0.015);
          doc.rect(0.55, yPos - 0.12, 0.15, 0.15);  // Big checkbox

          // Item details
          doc.setTextColor(black[0], black[1], black[2]);
          doc.text(item.item_name || 'Unknown Item', 1.1, yPos, { maxWidth: 5 });
          doc.text(String(item.quantity_ordered || 0), 6.5, yPos);
          doc.text(item.unit || '', 7.2, yPos);

          yPos += 0.25;
        }
      }

      // Footer credit
      doc.setFontSize(6);
      doc.setFont('helvetica', 'italic');
      doc.setTextColor(150, 150, 150);
      doc.text('PREP GENERATION FLOW CREATED AND DESIGNED BY DEMETRI GREGORAKIS', 4.25, 10.7, { align: 'center' });

      // Convert PDF to base64
      const pdfBase64 = doc.output('datauristring').split(',')[1];
      const filename = `Pending_Orders_${getPacificDate()}.pdf`;

      // Send via backend Gmail API (same as prep sheet)
      const response = await fetch('/api/send-prep-sheet-email', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          pdfBase64: pdfBase64,
          filename: filename,
          subject: `Pending Orders - ${getPacificDate()}`,
          toEmail: 'GSS4168CTJJA73@print.epsonconnect.com'  // Epson printer email
        })
      });

      const result = await response.json();

      if (!response.ok) {
        throw new Error(result.error || 'Failed to send email');
      }

      showMessage('✅ Pending orders sent to printer successfully!', 'success');

    } catch (error) {
      console.error('Email error:', error);
      showMessage('Failed to send to printer: ' + error.message, 'error');
    }
  }

  function renderSauceSummaryCard(doc, summary, startY) {
    if (!summary.length) return startY;

    const headerColor = [33, 150, 243];
    const pageTop = 0.7;
    const pageBottom = 10.4;
    const itemColX = 0.6;
    const itemColWidth = 3.8;
    const qtyColX = 4.8;
    const lastColX = 5.7;
    const lastColWidth = 2.2;
    const lineGap = 0.16;

    const drawHeader = (y, continuation = false) => {
      if (y > pageBottom) {
        doc.addPage();
        y = pageTop;
      }

      doc.setFillColor(headerColor[0], headerColor[1], headerColor[2]);
      doc.rect(0.5, y, 7.5, 0.25, 'F');
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(8);
      doc.setTextColor(255, 255, 255);
      doc.text(continuation ? 'BOTTLED & TO-GO PREP CHECK (CONT.)' : 'BOTTLED & TO-GO PREP CHECK', 0.6, y + 0.17);
      
      const columnHeaderY = y + 0.32;
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(5.5);
      doc.setTextColor(102, 102, 102);
      doc.text('ITEM NAME', itemColX, columnHeaderY);
      doc.text('CURRENT', qtyColX, columnHeaderY);
      doc.text('LAST COUNTED', lastColX, columnHeaderY);

      doc.setDrawColor(224, 224, 224);
      doc.setLineWidth(0.01);
      doc.line(0.5, columnHeaderY + 0.05, 8.0, columnHeaderY + 0.05);

      return columnHeaderY + 0.12;
    };

    let yPos = drawHeader(startY);

    summary.forEach((row) => {
      const itemLines = doc.splitTextToSize(row.label.toUpperCase(), itemColWidth);
      const lastLines = doc.splitTextToSize(row.lastCounted, lastColWidth);
      const rowLineCount = Math.max(itemLines.length, lastLines.length);
      const rowHeight = rowLineCount * lineGap + 0.1;

      if (yPos + rowHeight > pageBottom) {
        yPos = drawHeader(pageTop, true);
      }

      doc.setFont('helvetica', 'bold');
      doc.setFontSize(6.4);
      doc.setTextColor(33, 33, 33);
      doc.text(itemLines[0], itemColX, yPos, { maxWidth: itemColWidth });

      doc.setFont('helvetica', 'normal');
      doc.setFontSize(5.4);
      for (let i = 1; i < itemLines.length; i++) {
        doc.text(itemLines[i], itemColX, yPos + (i * lineGap), { maxWidth: itemColWidth });
      }

      doc.setFont('helvetica', 'bold');
      doc.setFontSize(6);
      doc.setTextColor(33, 33, 33);
      doc.text(row.quantity, qtyColX, yPos);

      doc.setFont('helvetica', 'normal');
      doc.setFontSize(5.4);
      doc.setTextColor(102, 102, 102);
      lastLines.forEach((line, idx) => {
        doc.text(line, lastColX, yPos + (idx * lineGap), { maxWidth: lastColWidth });
      });

      const rowBottom = yPos + rowHeight - 0.05;
      doc.setDrawColor(224, 224, 224);
      doc.setLineWidth(0.005);
      doc.line(0.5, rowBottom, 8.0, rowBottom);

      yPos = rowBottom + 0.07;
    });

    return yPos + 0.15;
  }

  /**
   * Render a compact list format (for bottle count and low priority)
   */
  function renderCompactList(doc, title, items, startY, headerColor, columns = 2, scaleFactor = 1.0) {
    const white = [255, 255, 255];
    const darkText = [33, 33, 33];
    const grayText = [102, 102, 102];
    const lightGray = [220, 220, 220];

    // Check if we need a new page
    if (startY > 9.5) {
      doc.addPage();
      startY = 0.7;
    }

    // Section header - sleek and minimal (dynamically scaled)
    const headerHeight = 0.18 * scaleFactor;
    doc.setFillColor(headerColor[0], headerColor[1], headerColor[2]);
    doc.rect(0.5, startY, 7.5, headerHeight, 'F');
    doc.setFontSize(7 * scaleFactor);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(white[0], white[1], white[2]);
    doc.text(`${title} (${items.length})`, 0.6, startY + (0.12 * scaleFactor));

    startY += headerHeight;

    // Add subtle separator line
    doc.setDrawColor(lightGray[0], lightGray[1], lightGray[2]);
    doc.setLineWidth(0.003);
    doc.line(0.5, startY, 8, startY);

    // Reduced spacing - move content closer to header (dynamically scaled)
    startY += 0.08 * scaleFactor;

    // Calculate column width and padding
    const columnWidth = 7.5 / columns;
    const itemsPerColumn = Math.ceil(items.length / columns);
    const lineHeight = 0.20 * scaleFactor; // Dynamically scaled

    // Render items in columns
    let maxY = startY;
    
    for (let i = 0; i < items.length; i++) {
      const item = items[i];
      const columnIndex = Math.floor(i / itemsPerColumn);
      const rowIndex = i % itemsPerColumn;
      const x = 0.5 + (columnIndex * columnWidth) + 0.08;
      const y = startY + (rowIndex * lineHeight);

      // FULL item name (no truncation) with qty and last counted (dynamically scaled fonts)
      doc.setFontSize(5.8 * scaleFactor);
      doc.setFont('helvetica', 'bold');
      doc.setTextColor(darkText[0], darkText[1], darkText[2]);
      
      // Show full name but check if it fits in column width
      const maxWidth = columnWidth - 0.16; // Leave padding
      let itemName = item.itemName;
      
      // If name is too long, wrap to multiple lines or truncate smartly
      const nameWidth = doc.getTextWidth(itemName);
      if (nameWidth > maxWidth * 0.7) { // If name takes more than 70% of column
        // Truncate but show most of the name
        const chars = Math.floor((maxWidth * 0.7) / (nameWidth / itemName.length));
        itemName = itemName.substring(0, chars - 3) + '...';
      }
      
      // Format: "ITEM NAME: Qty - Unit"
      const qtyText = `${item.currentStock || 0} - ${item.unit || ''}`;
      doc.text(itemName + ':', x, y);
      
      // Quantity with dash on same line
      const nameDisplayWidth = doc.getTextWidth(itemName + ':');
      doc.setFont('helvetica', 'normal');
      doc.setFontSize(5.5 * scaleFactor);
      doc.setTextColor(grayText[0], grayText[1], grayText[2]);
      doc.text(` ${qtyText}`, x + nameDisplayWidth, y);

      // Last counted time on second line
      const lastCountStr = item.lastCountedDate ? formatRelativeTime(item.lastCountedDate) : 'Never';
      doc.setFontSize(4.5 * scaleFactor);
      doc.setFont('helvetica', 'italic');
      doc.setTextColor(lightGray[0] - 40, lightGray[1] - 40, lightGray[2] - 40);
      doc.text(`  Last: ${lastCountStr}`, x, y + (0.08 * scaleFactor));

      maxY = Math.max(maxY, y + (0.12 * scaleFactor));
    }

    return maxY + (0.08 * scaleFactor);
  }

  /**
   * Render a priority section in the PDF with clean, well-spaced tables
   */
  function renderPrepPDFSection(doc, title, items, startY, headerColor, scaleFactor = 1.0) {
    const white = [255, 255, 255];
    const darkText = [33, 33, 33];
    const grayText = [102, 102, 102];
    const lightGray = [136, 136, 136];
    const redText = [211, 47, 47];
    const isMakeFirstSection = title === 'MAKE FIRST';

    // Check if we need a new page
    if (startY > 9.5) {
      doc.addPage();
      startY = 0.7;
    }

    // Section header with colored background - sleek and compact (dynamically scaled)
    const headerHeight = 0.18 * scaleFactor;
    doc.setFillColor(headerColor[0], headerColor[1], headerColor[2]);
    doc.rect(0.5, startY, 7.5, headerHeight, 'F');
    doc.setFontSize(7 * scaleFactor);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(white[0], white[1], white[2]);
    doc.text(`${title} (${items.length})`, 0.6, startY + (0.12 * scaleFactor));

    startY += headerHeight;

    // Prepare table data - each item is ONE row with ALL info
    // Order: ITEM, CURRENT, MAKE, PAR, REASON, LAST COUNTED
    const tableData = items.map(item => {
      const lastCountStr = item.lastCountedDate ? formatRelativeTime(item.lastCountedDate) : 'Never';
      const isOut = item.currentStock === 0;
      const stockDisplay = isOut ? 'OUT' : `${item.currentStock} - ${item.unit}`;
      const parDisplay = `${item.parLevel} - ${item.unit}`;
      const recommendValue = item.recommendedAmount > 0 ? `${item.recommendedAmount} - ${item.unit}` : '—';

      return [
        item.itemName,        // ITEM
        stockDisplay,         // CURRENT
        recommendValue,       // MAKE
        parDisplay,           // PAR
        item.reasoning,       // REASON
        lastCountStr          // LAST COUNTED
      ];
    });

    // Render table with compact spacing (dynamically scaled)
    doc.autoTable({
      startY: startY,
      head: [['ITEM', 'CURRENT', 'MAKE', 'PAR', 'REASON', 'LAST COUNTED']],
      body: tableData,
      theme: 'grid',
      margin: { left: 0.5, right: 0.5 },
      tableWidth: 7.5,
      styles: {
        fontSize: 5.8 * scaleFactor,
        cellPadding: 0.03 * scaleFactor,
        lineColor: lightGray,
        lineWidth: 0.003,
        valign: 'middle',
        minCellHeight: 0.18 * scaleFactor,
        halign: 'left',
        textColor: darkText,
        overflow: 'linebreak'
      },
      headStyles: {
        fillColor: [240, 240, 240],
        textColor: grayText,
        fontStyle: 'bold',
        fontSize: 5.2 * scaleFactor,
        cellPadding: 0.03 * scaleFactor,
        halign: 'left',
        valign: 'middle'
      },
      columnStyles: {
        0: { cellWidth: 1.4, fontStyle: 'bold', fontSize: 5.8 * scaleFactor },                                     // ITEM
        1: { cellWidth: 0.65, halign: 'center', fontSize: 5.8 * scaleFactor },                                    // CURRENT
        2: { cellWidth: 0.65, halign: 'center', fontSize: 5.8 * scaleFactor },                                    // MAKE
        3: { cellWidth: 0.65, halign: 'center', fontSize: 5.8 * scaleFactor },                                    // PAR
        4: { cellWidth: 2.5, fontSize: 5.3 * scaleFactor, textColor: grayText, fontStyle: 'italic' },             // REASON
        5: { cellWidth: 1.6, fontSize: 4.8 * scaleFactor, textColor: grayText, halign: 'right' }                  // LAST COUNTED
      },
      didParseCell: function(data) {
        // YELLOW HIGHLIGHT: Items in LINE COOKS PREP that need immediate attention
        // Highlight if: (URGENT + LINE COOKS PREP) OR (OUT of stock + LINE COOKS PREP)
        if (data.section === 'body') {
          const rowIndex = data.row.index;
          const item = items[rowIndex];
          if (item && item.lineCooksPrep === true) {
            // Yellow highlight if urgent OR out of stock
            if (item.urgent === true || item.currentStock === 0) {
              data.cell.styles.fillColor = [255, 255, 200]; // Light yellow highlight
            }
          }
        }
        
        // RED TEXT: CURRENT column in MAKE FIRST section (highest priority - always needs attention)
        if (isMakeFirstSection && data.column.index === 1 && data.section === 'body') {
          data.cell.styles.textColor = redText;
          data.cell.styles.fontStyle = 'bold';
          data.cell.styles.fontSize = 6.5 * scaleFactor;
        }
        // Highlight OUT items in red in other sections (column index 1 for CURRENT)
        else if (!isMakeFirstSection && data.column.index === 1 && data.section === 'body') {
          const cellText = data.cell.text[0];
          if (cellText && cellText.includes('OUT')) {
            data.cell.styles.textColor = redText;
            data.cell.styles.fontStyle = 'bold';
            data.cell.styles.fontSize = 7 * scaleFactor;
          }
        }
      }
    });

    return doc.lastAutoTable.finalY + (0.06 * scaleFactor);
  }

  /**
   * Send prep sheet PDF to printer via email
   */
  function printPrepSheet() {
    // Print button now emails PDF to printer
    emailPrepSheetToPrinter();

    let html = `
<!DOCTYPE html>
<html>
<head>
  <title>Prep Sheet - ${dateStr}</title>
  <style>
    @page {
      margin: 0.5in;
    }
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      color: #212121;
      font-size: 9pt;
      line-height: 1.3;
    }
    .header {
      text-align: center;
      margin-bottom: 16pt;
      border-bottom: 2px solid #2196F3;
      padding-bottom: 8pt;
    }
    .header h1 {
      font-size: 16pt;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1.2px;
      color: #212121;
      margin-bottom: 4pt;
    }
    .header .subtitle {
      font-size: 9pt;
      color: #666;
      font-weight: 400;
    }
    .section {
      margin-bottom: 14pt;
      page-break-inside: avoid;
    }
    .section-header {
      background: #424242;
      color: white;
      padding: 6pt 8pt;
      font-size: 10pt;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      border: 2px solid #424242;
    }
    .section-header.urgent {
      background: #212121;
      border-color: #212121;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      border: 2px solid #424242;
      border-top: none;
    }
    th {
      background: #f5f5f5;
      padding: 5pt 6pt;
      font-size: 8pt;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #666;
      border-bottom: 2px solid #e0e0e0;
      text-align: left;
    }
    td {
      padding: 5pt 6pt;
      border-bottom: 1px solid #e0e0e0;
      font-size: 8pt;
      vertical-align: top;
    }
    tr:last-child td {
      border-bottom: none;
    }
    .item-name {
      font-weight: 700;
      color: #212121;
      text-transform: uppercase;
      font-size: 9pt;
      letter-spacing: 0.3px;
    }
    .last-count {
      font-size: 7pt;
      color: #999;
      margin-top: 1pt;
    }
    .stock-value {
      font-weight: 700;
      font-size: 10pt;
      color: #212121;
    }
    .stock-value.out {
      color: #d32f2f;
      text-transform: uppercase;
      font-size: 9pt;
      letter-spacing: 0.5px;
    }
    .stock-label {
      font-size: 7pt;
      color: #666;
      text-transform: uppercase;
      margin-top: 1pt;
    }
    .recommend-value {
      font-weight: 700;
      font-size: 11pt;
      color: #2196F3;
    }
    .reasoning {
      font-size: 7pt;
      color: #666;
      font-style: italic;
      line-height: 1.2;
    }
    .col-name { width: 28%; }
    .col-current { width: 15%; text-align: center; }
    .col-par { width: 15%; text-align: center; }
    .col-recommend { width: 12%; text-align: center; }
    .col-reasoning { width: 30%; }
    .footer {
      margin-top: 16pt;
      padding-top: 8pt;
      border-top: 1px solid #e0e0e0;
      font-size: 7pt;
      color: #999;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>Prep Sheet - ${dateStr}</h1>
    <div class="subtitle">Generated ${new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}</div>
  </div>
`;

    // Render each priority group
    if (urgent.length > 0) {
      html += renderPrintPriorityGroup('URGENT - Out of Stock', urgent, 'urgent');
    }
    if (high.length > 0) {
      html += renderPrintPriorityGroup('HIGH PRIORITY - Low Stock', high, 'high');
    }
    if (medium.length > 0) {
      html += renderPrintPriorityGroup('MEDIUM PRIORITY', medium, 'medium');
    }
    if (low.length > 0) {
      html += renderPrintPriorityGroup('LOW PRIORITY - Stock Good', low, 'low');
    }

    html += `
  <div class="footer">
    Jayna Organic Eatery | Prep Recommendations
  </div>
</body>
</html>`;

    printWindow.document.write(html);
    printWindow.document.close();
    printWindow.print();
  }

  /**
   * Render a priority group for printing
   */
  function renderPrintPriorityGroup(title, items, priority) {
    // LOW PRIORITY items: use compact list format
    if (priority === 'low') {
      const itemList = items.map(item =>
        `<span style="display: inline-block; width: 32%; padding: 2pt 4pt; font-size: 6pt; color: #666;">${item.itemName} (${item.stockPercentage.toFixed(0)}%)</span>`
      ).join('');

      return `
        <div class="section">
          <div class="section-header ${priority}">${title} (${items.length} items)</div>
          <div style="background: white; border: 2px solid #424242; border-top: none; padding: 6pt 8pt; display: flex; flex-wrap: wrap;">
            ${itemList}
          </div>
        </div>
      `;
    }

    // URGENT, HIGH, MEDIUM: use full table format
    const itemRows = items.map(item => {
      const lastCountStr = item.lastCountedDate ? formatRelativeTime(item.lastCountedDate) : 'Never';
      const isOut = item.currentStock === 0;
      const stockDisplay = isOut ? 'OUT' : `${item.currentStock} ${item.unit}`;
      const recommendValue = item.recommendedAmount > 0 ? item.recommendedAmount : '—';

      return `
        <tr>
          <td class="col-name">
            <div class="item-name">${item.itemName}</div>
            <div class="last-count">Last count: ${lastCountStr}</div>
          </td>
          <td class="col-current">
            <div class="stock-value ${isOut ? 'out' : ''}">${stockDisplay}</div>
            <div class="stock-label">Current</div>
          </td>
          <td class="col-par">
            <div class="stock-value">${item.parLevel} ${item.unit}</div>
            <div class="stock-label">Par</div>
          </td>
          <td class="col-recommend">
            <div class="recommend-value">${recommendValue}</div>
            <div class="stock-label">To Make</div>
          </td>
          <td class="col-reasoning">
            <div class="reasoning">${item.reasoning}</div>
          </td>
        </tr>
      `;
    }).join('');

    return `
      <div class="section">
        <div class="section-header ${priority}">${title} (${items.length} items)</div>
        <table>
          <thead>
            <tr>
              <th class="col-name">ITEM NAME</th>
              <th class="col-current">CURRENT</th>
              <th class="col-par">PAR</th>
              <th class="col-recommend">RECOMMEND</th>
              <th class="col-reasoning">REASONING</th>
            </tr>
          </thead>
          <tbody>
            ${itemRows}
          </tbody>
        </table>
      </div>
    `;
  }

  // ===================================================================
  // INVOICE CHECK-IN SYSTEM - DOM-BASED MODAL APPROACH (SAFE)
  // ===================================================================

  /**
   * Select invoice type (invoice vs order)
   */
  function selectInvoiceType(type) {
    console.log('Selected invoice type:', type);
    orderingSystemState.invoiceType = type;

    const description = document.getElementById('invoiceTypeDescription');
    const uploadSection = document.getElementById('uploadSection');
    const pendingOrderMetadata = document.getElementById('pendingOrderMetadata');
    const pendingOrderDate = document.getElementById('pendingOrderDate');

    if (type === 'invoice') {
      description.innerHTML = '<strong>INVOICE MODE:</strong> Items will be checked in immediately and inventory quantities will be UPDATED (qty += received amount).';

      // Enable upload section
      uploadSection.style.opacity = '1';
      uploadSection.style.pointerEvents = 'auto';
      uploadSection.querySelector('h4').textContent = 'Upload Invoice Image';
      uploadSection.querySelector('p').textContent = 'Take a photo or select an image from your device';

      // Hide pending order fields
      pendingOrderMetadata.style.display = 'none';

    } else if (type === 'order') {
      description.innerHTML = '<strong>PENDING ORDER MODE:</strong> Enter order details below, then upload the order document. Inventory will NOT be updated until you check in the order on delivery day.';

      // Show pending order metadata fields
      pendingOrderMetadata.style.display = 'block';

      // Set min date to today
      if (pendingOrderDate) {
        pendingOrderDate.min = getPacificDate();
      }

      // Enable upload section
      uploadSection.style.opacity = '1';
      uploadSection.style.pointerEvents = 'auto';
      uploadSection.querySelector('h4').textContent = 'Upload Order Document';
      uploadSection.querySelector('p').textContent = 'Upload the order document or CSV';

    } else {
      // No type selected - gray out upload
      description.textContent = 'Select whether this is an invoice from a delivery you\'re receiving now, or a pending order for a future date.';
      uploadSection.style.opacity = '0.5';
      uploadSection.style.pointerEvents = 'none';
      uploadSection.querySelector('p').textContent = 'Select document type above first';
      pendingOrderMetadata.style.display = 'none';
    }
  }

  /**
   * Handle invoice/order image upload
   */
  function handleInvoiceUpload(event) {
    const file = event.target.files[0];
    if (!file) return;

    // REQUIRED: Check if document type is selected
    if (!orderingSystemState.invoiceType) {
      showMessage('❌ Please select DOCUMENT TYPE first (Invoice or Pending Order)', 'error');
      // Reset file input
      event.target.value = '';
      return;
    }

    // REQUIRED: If pending order, validate metadata fields are filled
    if (orderingSystemState.invoiceType === 'order') {
      const nameInput = document.getElementById('pendingOrderName');
      const dateInput = document.getElementById('pendingOrderDate');

      if (!nameInput || !nameInput.value.trim()) {
        showMessage('❌ Please enter YOUR NAME for the pending order', 'error');
        event.target.value = '';
        if (nameInput) nameInput.focus();
        return;
      }

      if (!dateInput || !dateInput.value) {
        showMessage('❌ Please select EXPECTED DELIVERY DATE for the pending order', 'error');
        event.target.value = '';
        if (dateInput) dateInput.focus();
        return;
      }

      // Store metadata in orderingSystemState for use when creating the order
      orderingSystemState.pendingOrderMetadata = {
        createdBy: nameInput.value.trim(),
        expectedDeliveryDate: dateInput.value,
        notes: document.getElementById('pendingOrderNotes')?.value.trim() || ''
      };

      console.log('📋 Pending order metadata stored:', orderingSystemState.pendingOrderMetadata);
    }

    // Validate file type (accept images, PDFs, CSV, and Excel)
    const isImage = file.type.startsWith('image/');
    const isPDF = file.type === 'application/pdf';
    const isCSV = file.name.endsWith('.csv') || file.type === 'text/csv';
    const isExcel = file.name.endsWith('.xlsx') || file.name.endsWith('.xls') ||
                    file.type === 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' ||
                    file.type === 'application/vnd.ms-excel';

    if (!isImage && !isPDF && !isCSV && !isExcel) {
      showMessage('Please upload an image, PDF, CSV, or Excel file', 'error');
      return;
    }

    // Handle CSV files (Auto-detect vendor format)
    if (isCSV) {
      detectVendorAndParseCSV(file);
      return;
    }

    // Handle Excel files (Invoice Insights)
    if (isExcel) {
      handlePFGInsightsExcel(file);
      return;
    }

    /**
     * Detect Vendor from CSV Headers and Route to Appropriate Parser
     */
    async function detectVendorAndParseCSV(file) {
      const reader = new FileReader();
      reader.onload = async function(e) {
        const csvText = e.target.result;

        // Parse just the header row to detect vendor
        Papa.parse(csvText, {
          header: true,
          preview: 1, // Just read first row to get headers
          complete: async function(results) {
            const headers = results.meta.fields || [];
            console.log('📋 Detected CSV headers:', headers);

            // Detect vendor by header columns
            const hasPFGHeaders = headers.includes('Product #') && headers.includes('Manufacturer Product #') && headers.includes('GTIN');
            const hasGreenleafHeaders = headers.includes('Product No.') && headers.includes('Description') && headers.includes('Receiving Date');
            const hasManiHeaders = headers.includes('Item Code') && headers.includes('Item Name') && headers.includes('Order Qty');

            if (hasPFGHeaders) {
              console.log('✅ Detected PFG Invoice format');
              showMessage('Detected PFG Invoice - Processing...', 'success');
              handlePFGInvoiceCSV(file);
            } else if (hasGreenleafHeaders) {
              console.log('✅ Detected Greenleaf Invoice format');
              showMessage('Detected Greenleaf Invoice - Processing...', 'success');
              handleGreenleafInvoiceCSV(file);
            } else if (hasManiHeaders) {
              console.log('✅ Detected Mani Invoice format');
              showMessage('Detected Mani Invoice - Processing...', 'success');
              handleManiInvoiceCSV(file);
            } else {
              console.log('🤖 Unknown vendor format - Using SMART UNIVERSAL parser');
              showMessage('Unknown vendor - Using smart parser...', 'success');
              handleUniversalSmartCSV(file, headers);
            }
          }
        });
      };
      reader.readAsText(file);
    }

    /**
     * Handle Greenleaf Invoice CSV Upload
     * Parses Greenleaf order CSV format
     * Columns: Product No., Description, Order Date, Receiving Date, Unit Price, Quantity
     */
    async function handleGreenleafInvoiceCSV(file) {
      console.log('🥬 Handling Greenleaf Invoice CSV:', file.name);
      console.log('📋 Document type:', orderingSystemState.invoiceType);
      showMessage('Processing Greenleaf CSV...', 'success');

      // Type already set by selectInvoiceType - DO NOT override

      const reader = new FileReader();
      reader.onload = async function(e) {
        const csvText = e.target.result;

        // Parse CSV with PapaParse
        Papa.parse(csvText, {
          header: true,
          skipEmptyLines: true,
          complete: async function(results) {
            console.log('✅ CSV parsed:', results.data.length, 'rows');

            if (results.errors.length > 0) {
              console.warn('CSV parsing errors:', results.errors);
            }

            // Clear existing extracted items
            orderingSystemState.extractedInvoiceItems = [];

            // Load ALL inventory items if not loaded
            if (orderingSystemState.items.length === 0) {
              console.log('Loading inventory items...');
              await loadInventoryItemsForOrdering();
            }

            // Extract items from CSV
            let itemsMatched = 0;
            let itemsNotMatched = 0;

            for (const row of results.data) {
              // Parse Greenleaf columns
              const productNo = row['Product No.']?.trim();
              const description = row['Description']?.trim();
              const quantity = parseFloat(row['Quantity']) || 0;
              const unitPrice = parseFloat(row['Unit Price']) || 0;
              const receivingDate = row['Receiving Date']?.trim();

              if (!description || quantity === 0) {
                console.warn('Skipping row with no description or 0 quantity');
                continue;
              }

              // Extract item name from description (everything before pack size info)
              // Example: "WILD ARUGULA                        4#/CS" -> "WILD ARUGULA"
              // Remove pack size patterns like "4#/CS", "24ct/CS", "1bunch/EA", "25#", "90ct"
              let itemName = description.replace(/\s+\d+(\.\d+)?(#|ct|bunch|lb|oz|g|kg)(\/[A-Z]+)?/gi, '').trim();
              itemName = itemName.replace(/\s+/g, ' ').trim(); // Normalize whitespace

              console.log(`\n🥬 Processing: ${itemName} (Greenleaf #${productNo})`);
              console.log(`   Description: ${description}`);
              console.log(`   Quantity: ${quantity}, Price: $${unitPrice}`);

              // Try to match with existing inventory using fuzzy matching
              let matchedItem = null;
              let matchConfidence = 0;

              // PRIORITY 1: Match by item_number (Greenleaf Product No.)
              matchedItem = orderingSystemState.items.find(inv =>
                inv.item_number && inv.item_number.toLowerCase() === productNo.toLowerCase()
              );

              if (matchedItem) {
                matchConfidence = 1.0;
                console.log(`✅ MATCHED by item_number: ${matchedItem.item_name} (100%)`);
              } else {
                // PRIORITY 2: Fuzzy match by name
                const fuzzyResult = fuzzyMatchInventoryItem(itemName, 'Greenleaf');
                if (fuzzyResult) {
                  // fuzzyResult has: {id, itemName, vendor, unit, confidence}
                  matchedItem = {
                    id: fuzzyResult.id,
                    item_name: fuzzyResult.itemName,
                    vendor: fuzzyResult.vendor,
                    unit: fuzzyResult.unit
                  };
                  matchConfidence = fuzzyResult.confidence;
                  console.log(`✅ FUZZY MATCHED: "${itemName}" -> "${matchedItem.item_name}" (${(matchConfidence * 100).toFixed(1)}%)`);
                }
              }

              if (matchedItem && matchConfidence >= 0.7) {
                // Matched successfully
                orderingSystemState.extractedInvoiceItems.push({
                  id: Date.now() + Math.random(),
                  detectedName: itemName,
                  detectedQuantity: quantity,
                  detectedPrice: unitPrice,
                  detectedUnit: matchedItem.unit || 'case',
                  matchedInventoryId: matchedItem.id,
                  matchedItemName: matchedItem.item_name,
                  matchedVendor: matchedItem.vendor,
                  matchConfidence: matchConfidence,
                  skipped: false,
                  flaggedAsNew: false,
                  greenleafData: {
                    productNo: productNo,
                    description: description,
                    receivingDate: receivingDate,
                    vendor: 'Greenleaf'
                  }
                });
                itemsMatched++;
              } else {
                // No match - add to extracted items for manual review
                orderingSystemState.extractedInvoiceItems.push({
                  id: Date.now() + Math.random(),
                  detectedName: itemName,
                  detectedQuantity: quantity,
                  detectedPrice: unitPrice,
                  detectedUnit: 'case',
                  matchedInventoryId: null,
                  matchedItemName: null,
                  matchedVendor: null,
                  matchConfidence: 0,
                  skipped: false,
                  flaggedAsNew: true,
                  greenleafData: {
                    productNo: productNo,
                    description: description,
                    receivingDate: receivingDate,
                    vendor: 'Greenleaf'
                  }
                });
                itemsNotMatched++;
                console.warn(`⚠️ NO MATCH FOUND for: ${itemName}`);
              }
            }

            console.log(`\n✅ Greenleaf CSV processed:`);
            console.log(`   - Items matched: ${itemsMatched}`);
            console.log(`   - Items not matched: ${itemsNotMatched}`);
            console.log(`   - Total items: ${orderingSystemState.extractedInvoiceItems.length}`);

            // Show extracted items section
            document.getElementById('extractedItemsSection').style.display = 'block';
            renderExtractedItems();
            showMessage(`✅ Greenleaf CSV processed! ${itemsMatched} items matched, ${itemsNotMatched} need review.`, 'success');
          }
        });
      };
      reader.readAsText(file);
    }

    /**
     * Handle Mani Invoice CSV Upload
     * Parses Mani order CSV format
     * Columns: Item Code, Item Name, Order Qty, Unit Price, etc.
     */
    async function handleManiInvoiceCSV(file) {
      console.log('🍚 Handling Mani CSV:', file.name);
      console.log('📋 Document type:', orderingSystemState.invoiceType);
      showMessage('Processing Mani CSV...', 'success');

      // Type already set by selectInvoiceType - DO NOT override

      const reader = new FileReader();
      reader.onload = async function(e) {
        const csvText = e.target.result;

        Papa.parse(csvText, {
          header: true,
          skipEmptyLines: true,
          complete: async function(results) {
            console.log('✅ CSV parsed:', results.data.length, 'rows');

            if (results.errors.length > 0) {
              console.warn('CSV parsing errors:', results.errors);
            }

            orderingSystemState.extractedInvoiceItems = [];

            if (orderingSystemState.items.length === 0) {
              console.log('Loading inventory items...');
              await loadInventoryItemsForOrdering();
            }

            let itemsMatched = 0;
            let itemsNotMatched = 0;

            for (const row of results.data) {
              const itemCode = row['Item Code']?.trim();
              const itemName = row['Item Name']?.trim();
              const quantity = parseFloat(row['Order Qty'] || row['Quantity']) || 0;
              const unitPrice = parseFloat(row['Unit Price'] || row['Price']) || 0;

              if (!itemName || quantity === 0) {
                console.warn('Skipping row with no item name or 0 quantity');
                continue;
              }

              console.log(`\n🍚 Processing: ${itemName} (Mani #${itemCode})`);
              console.log(`   Quantity: ${quantity}, Price: $${unitPrice}`);

              let matchedItem = null;
              let matchConfidence = 0;

              // PRIORITY 1: Match by item_number (Mani Item Code)
              matchedItem = orderingSystemState.items.find(inv =>
                inv.item_number && inv.item_number.toLowerCase() === itemCode?.toLowerCase()
              );

              if (matchedItem) {
                matchConfidence = 1.0;
                console.log(`✅ MATCHED by item_number: ${matchedItem.item_name} (100%)`);
              } else {
                // PRIORITY 2: Fuzzy match by name
                const fuzzyResult = fuzzyMatchInventoryItem(itemName, 'Mani');
                if (fuzzyResult) {
                  // fuzzyResult has: {id, itemName, vendor, unit, confidence}
                  matchedItem = {
                    id: fuzzyResult.id,
                    item_name: fuzzyResult.itemName,
                    vendor: fuzzyResult.vendor,
                    unit: fuzzyResult.unit
                  };
                  matchConfidence = fuzzyResult.confidence;
                  console.log(`✅ FUZZY MATCHED: "${itemName}" -> "${matchedItem.item_name}" (${(matchConfidence * 100).toFixed(1)}%)`);
                }
              }

              if (matchedItem && matchConfidence >= 0.7) {
                orderingSystemState.extractedInvoiceItems.push({
                  id: Date.now() + Math.random(),
                  detectedName: itemName,
                  detectedQuantity: quantity,
                  detectedPrice: unitPrice,
                  detectedUnit: matchedItem.unit || 'case',
                  matchedInventoryId: matchedItem.id,
                  matchedItemName: matchedItem.item_name,
                  matchedVendor: matchedItem.vendor,
                  matchConfidence: matchConfidence,
                  skipped: false,
                  flaggedAsNew: false,
                  maniData: {
                    itemCode: itemCode,
                    vendor: 'Mani'
                  }
                });
                itemsMatched++;
              } else {
                orderingSystemState.extractedInvoiceItems.push({
                  id: Date.now() + Math.random(),
                  detectedName: itemName,
                  detectedQuantity: quantity,
                  detectedPrice: unitPrice,
                  detectedUnit: 'case',
                  matchedInventoryId: null,
                  matchedItemName: null,
                  matchedVendor: null,
                  matchConfidence: 0,
                  skipped: false,
                  flaggedAsNew: true,
                  maniData: {
                    itemCode: itemCode,
                    vendor: 'Mani'
                  }
                });
                itemsNotMatched++;
                console.warn(`⚠️ NO MATCH FOUND for: ${itemName}`);
              }
            }

            console.log(`\n✅ Mani CSV processed:`);
            console.log(`   - Items matched: ${itemsMatched}`);
            console.log(`   - Items not matched: ${itemsNotMatched}`);

            // Show extracted items section
            document.getElementById('extractedItemsSection').style.display = 'block';
            renderExtractedItems();
            showMessage(`✅ Mani CSV processed! ${itemsMatched} items matched, ${itemsNotMatched} need review.`, 'success');
          }
        });
      };
      reader.readAsText(file);
    }

    /**
     * UNIVERSAL SMART CSV Parser
     * Intelligently detects columns and parses ANY CSV format
     * Uses AI-like column detection to figure out item names, quantities, prices
     */
    async function handleUniversalSmartCSV(file, detectedHeaders) {
      console.log('🤖 SMART UNIVERSAL CSV Parser activated');
      console.log('📋 Document type:', orderingSystemState.invoiceType);
      console.log('🧠 Analyzing CSV structure...');

      // Type already set by selectInvoiceType - DO NOT override

      const reader = new FileReader();
      reader.onload = async function(e) {
        const csvText = e.target.result;

        Papa.parse(csvText, {
          header: true,
          skipEmptyLines: true,
          complete: async function(results) {
            console.log('✅ CSV parsed:', results.data.length, 'rows');

            const headers = results.meta.fields || detectedHeaders;
            console.log('📋 Available columns:', headers);

            // INTELLIGENT COLUMN DETECTION
            const columnMap = detectColumns(headers);
            console.log('🧠 Smart column detection:', columnMap);

            if (!columnMap.itemName) {
              showMessage('❌ Could not detect item name column. Please use a supported vendor format.', 'error');
              return;
            }

            orderingSystemState.extractedInvoiceItems = [];

            if (orderingSystemState.items.length === 0) {
              console.log('Loading inventory items...');
              await loadInventoryItemsForOrdering();
            }

            let itemsMatched = 0;
            let itemsNotMatched = 0;

            for (const row of results.data) {
              const itemName = row[columnMap.itemName]?.trim();
              const quantity = parseFloat(row[columnMap.quantity] || 1) || 1;
              const unitPrice = parseFloat(row[columnMap.price] || 0) || 0;
              const itemCode = columnMap.itemCode ? row[columnMap.itemCode]?.trim() : null;

              if (!itemName) {
                console.warn('Skipping row with no item name');
                continue;
              }

              console.log(`\n🤖 Processing: ${itemName}${itemCode ? ` (Code: ${itemCode})` : ''}`);
              console.log(`   Quantity: ${quantity}, Price: $${unitPrice}`);

              let matchedItem = null;
              let matchConfidence = 0;

              // PRIORITY 1: Match by item_number/code
              if (itemCode) {
                matchedItem = orderingSystemState.items.find(inv =>
                  inv.item_number && inv.item_number.toLowerCase() === itemCode.toLowerCase()
                );
                if (matchedItem) {
                  matchConfidence = 1.0;
                  console.log(`✅ MATCHED by item_number: ${matchedItem.item_name} (100%)`);
                }
              }

              // PRIORITY 2: Fuzzy match by name
              if (!matchedItem) {
                const fuzzyResult = fuzzyMatchInventoryItem(itemName, null);
                if (fuzzyResult) {
                  // fuzzyResult has: {id, itemName, vendor, unit, confidence}
                  matchedItem = {
                    id: fuzzyResult.id,
                    item_name: fuzzyResult.itemName,
                    vendor: fuzzyResult.vendor,
                    unit: fuzzyResult.unit
                  };
                  matchConfidence = fuzzyResult.confidence;
                  console.log(`✅ FUZZY MATCHED: "${itemName}" -> "${matchedItem.item_name}" (${(matchConfidence * 100).toFixed(1)}%)`);
                }
              }

              if (matchedItem && matchConfidence >= 0.7) {
                orderingSystemState.extractedInvoiceItems.push({
                  id: Date.now() + Math.random(),
                  detectedName: itemName,
                  detectedQuantity: quantity,
                  detectedPrice: unitPrice,
                  detectedUnit: matchedItem.unit || 'case',
                  matchedInventoryId: matchedItem.id,
                  matchedItemName: matchedItem.item_name,
                  matchedVendor: matchedItem.vendor,
                  matchConfidence: matchConfidence,
                  skipped: false,
                  flaggedAsNew: false,
                  universalData: {
                    itemCode: itemCode,
                    vendor: 'Unknown',
                    detectedColumns: columnMap
                  }
                });
                itemsMatched++;
              } else {
                orderingSystemState.extractedInvoiceItems.push({
                  id: Date.now() + Math.random(),
                  detectedName: itemName,
                  detectedQuantity: quantity,
                  detectedPrice: unitPrice,
                  detectedUnit: 'case',
                  matchedInventoryId: null,
                  matchedItemName: null,
                  matchedVendor: null,
                  matchConfidence: 0,
                  skipped: false,
                  flaggedAsNew: true,
                  universalData: {
                    itemCode: itemCode,
                    vendor: 'Unknown',
                    detectedColumns: columnMap
                  }
                });
                itemsNotMatched++;
                console.warn(`⚠️ NO MATCH FOUND for: ${itemName}`);
              }
            }

            console.log(`\n✅ Smart CSV processed:`);
            console.log(`   - Items matched: ${itemsMatched}`);
            console.log(`   - Items not matched: ${itemsNotMatched}`);

            // Show extracted items section
            document.getElementById('extractedItemsSection').style.display = 'block';
            renderExtractedItems();
            showMessage(`🤖 Smart parser processed ${itemsMatched} matches, ${itemsNotMatched} need review.`, 'success');
          }
        });
      };
      reader.readAsText(file);
    }

    /**
     * Intelligent Column Detection
     * Analyzes CSV headers and detects which columns contain item names, quantities, prices
     */
    function detectColumns(headers) {
      const columnMap = {
        itemName: null,
        quantity: null,
        price: null,
        itemCode: null
      };

      // ITEM NAME detection (product, item, description, name)
      const nameKeywords = ['name', 'description', 'product', 'item', 'desc'];
      for (const header of headers) {
        const lower = header.toLowerCase();
        if (nameKeywords.some(kw => lower.includes(kw))) {
          columnMap.itemName = header;
          break;
        }
      }

      // QUANTITY detection (qty, quantity, amount, count, ordered, shipped)
      const qtyKeywords = ['qty', 'quantity', 'amount', 'count', 'order', 'ship'];
      for (const header of headers) {
        const lower = header.toLowerCase();
        if (qtyKeywords.some(kw => lower.includes(kw))) {
          columnMap.quantity = header;
          break;
        }
      }

      // PRICE detection (price, cost, unit price, each)
      const priceKeywords = ['price', 'cost', 'unit', 'each'];
      for (const header of headers) {
        const lower = header.toLowerCase();
        if (priceKeywords.some(kw => lower.includes(kw)) && !lower.includes('total')) {
          columnMap.price = header;
          break;
        }
      }

      // ITEM CODE detection (code, number, sku, id, #)
      const codeKeywords = ['code', 'number', 'sku', 'id', '#', 'no'];
      for (const header of headers) {
        const lower = header.toLowerCase();
        if (codeKeywords.some(kw => lower.includes(kw)) && !lower.includes('phone') && !lower.includes('order')) {
          columnMap.itemCode = header;
          break;
        }
      }

      return columnMap;
    }

    /**
     * Handle PFG Invoice CSV Upload
     * Parses PFG Customer First Invoice Export CSV format
     * Auto-creates missing items with full PFG data tracking
     */
    async function handlePFGInvoiceCSV(file) {
      console.log('📋 Handling PFG CSV:', file.name);
      console.log('📋 Document type:', orderingSystemState.invoiceType);
      showMessage('Processing PFG CSV...', 'success');

      // Type already set by selectInvoiceType - DO NOT override

      const reader = new FileReader();
      reader.onload = async function(e) {
        const csvText = e.target.result;

        // Parse CSV with PapaParse
        Papa.parse(csvText, {
          header: true,
          skipEmptyLines: true,
          complete: async function(results) {
            console.log('✅ CSV parsed:', results.data.length, 'rows');

            if (results.errors.length > 0) {
              console.warn('CSV parsing errors:', results.errors);
            }

            // Clear existing extracted items
            orderingSystemState.extractedInvoiceItems = [];

            // Load ALL inventory items if not loaded
            if (orderingSystemState.items.length === 0) {
              console.log('Loading inventory items...');
              await loadInventoryItemsForOrdering();
            }

            // Extract items from CSV
            let itemsCreated = 0;
            let itemsMatched = 0;

            for (const row of results.data) {
              // Skip rows with no quantity shipped
              const qtyShipped = parseFloat(row['Qty Shipped']) || 0;
              if (qtyShipped === 0) {
                console.log('Skipping item with 0 qty shipped:', row['Product Description']);
                continue;
              }

              const itemName = row['Product Description']?.trim();
              const pfgItemNumber = row['Product #']?.trim();
              const manufacturerItemNumber = row['Manufacturer Product #']?.trim();
              const gtin = row['GTIN']?.trim();
              const category = row['Category/Class']?.trim();
              const brand = row['Brand']?.trim();
              const manufacturerName = row['Manufacturer Name']?.trim();
              const packSize = row['Pack Size']?.trim();
              const uom = row['UOM']?.trim();
              const unitPrice = parseFloat(row['Unit Price']) || 0;

              if (!itemName) {
                console.warn('Skipping row with no product description');
                continue;
              }

              console.log(`\n📦 Processing: ${itemName} (PFG #${pfgItemNumber})`);

              // Try to match with existing inventory
              // PRIORITY 1: Match by item_number (PFG Product #)
              let matchedItem = null;
              let matchConfidence = 0;

              if (pfgItemNumber) {
                matchedItem = orderingSystemState.items.find(item => item.item_number === pfgItemNumber);
                if (matchedItem) {
                  matchConfidence = 1.0;
                  console.log(`✅ Matched by item_number: ${matchedItem.itemName}`);
                }
              }

              // PRIORITY 2: Fuzzy match by name if no item_number match
              if (!matchedItem) {
                const fuzzyMatch = fuzzyMatchInventoryItem(itemName, null);
                if (fuzzyMatch && fuzzyMatch.confidence >= 0.7) {
                  const item = orderingSystemState.items.find(i => i.id === fuzzyMatch.id);
                  if (item) {
                    matchedItem = item;
                    matchConfidence = fuzzyMatch.confidence;
                    console.log(`🔍 Fuzzy matched: ${matchedItem.itemName} (${Math.round(matchConfidence * 100)}%)`);
                  }
                }
              }

              // Create extracted item object
              const extractedItem = {
                id: Date.now() + Math.random(),
                detectedName: itemName,
                detectedQuantity: qtyShipped,
                detectedQuantityShipped: qtyShipped,
                detectedUnit: uom === 'CS' ? 'case' : uom?.toLowerCase(),
                detectedPrice: unitPrice,
                matchedInventoryId: matchedItem ? matchedItem.id : null,
                matchConfidence: matchConfidence,
                matchedItemName: matchedItem ? matchedItem.itemName : null,
                matchedVendor: matchedItem ? matchedItem.vendor : null,
                skipped: false,
                flaggedAsNew: !matchedItem, // Flag as new if no match found

                // Store PFG data for auto-create and price tracking
                pfgData: {
                  itemNumber: pfgItemNumber,
                  manufacturerItemNumber: manufacturerItemNumber,
                  gtin: gtin,
                  category: category,
                  brand: brand,
                  manufacturerName: manufacturerName,
                  packSize: packSize,
                  invoiceNumber: row['Invoice Number']?.trim(),
                  invoiceDate: row['Invoice Date']?.trim(),
                  vendor: 'PFG' // Always PFG for these invoices
                }
              };

              orderingSystemState.extractedInvoiceItems.push(extractedItem);

              if (matchedItem) {
                itemsMatched++;
              } else {
                itemsCreated++;
                console.log(`🆕 Will auto-create: ${itemName}`);
              }
            }

            console.log(`\n📊 PFG CSV Processing Complete:`);
            console.log(`   - Total items: ${orderingSystemState.extractedInvoiceItems.length}`);
            console.log(`   - Matched: ${itemsMatched}`);
            console.log(`   - New items to create: ${itemsCreated}`);

            // Show extracted items section
            document.getElementById('extractedItemsSection').style.display = 'block';
            renderExtractedItems();

            showMessage(`✅ Processed ${orderingSystemState.extractedInvoiceItems.length} items! ${itemsMatched} matched, ${itemsCreated} new.`, 'success');
          },
          error: function(error) {
            console.error('CSV parsing error:', error);
            showMessage('Failed to parse CSV: ' + error.message, 'error');
          }
        });
      };

      reader.readAsText(file);
    }

    /**
     * Handle PFG Invoice Insights Excel Upload (ONE-TIME IMPORT)
     * This is for initial data seeding, not ongoing system feature
     */
    async function handlePFGInsightsExcel(file) {
      console.log('📊 Handling PFG Invoice Insights Excel (one-time import):', file.name);
      showMessage('Processing Invoice Insights Excel (this may take a moment)...', 'success');

      const reader = new FileReader();
      reader.onload = async function(e) {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });

          // Read first sheet
          const sheetName = workbook.SheetNames[0];
          const sheet = workbook.Sheets[sheetName];
          const rows = XLSX.utils.sheet_to_json(sheet);

          console.log('✅ Excel parsed:', rows.length, 'rows');

          // Process rows and update existing inventory items with item numbers and price history
          let itemsUpdated = 0;
          let itemsNotFound = 0;

          for (const row of rows) {
            const itemName = row['Product Description']?.trim();
            const pfgItemNumber = row['Product #']?.toString()?.trim();
            const manufacturerItemNumber = row['Manufacturer Product #']?.trim();
            const gtin = row['GTIN']?.toString()?.trim();
            const category = row['Category/Class']?.trim();
            const brand = row['Brand']?.trim();
            const manufacturerName = row['Manufacturer Name']?.trim();
            const unitPrice = parseFloat(row['Unit Price']) || 0;

            if (!itemName || !pfgItemNumber) {
              continue;
            }

            // Find matching inventory item by fuzzy name match
            const fuzzyMatch = fuzzyMatchInventoryItem(itemName, null);
            if (fuzzyMatch && fuzzyMatch.confidence >= 0.7) {
              const inventoryItem = orderingSystemState.items.find(i => i.id === fuzzyMatch.id);
              if (inventoryItem) {
                // Update item in database with PFG tracking data
                const { error } = await supabase
                  .from('inventory_items')
                  .update({
                    item_number: pfgItemNumber,
                    manufacturer_item_number: manufacturerItemNumber,
                    gtin: gtin,
                    category: category,
                    brand: brand,
                    manufacturer_name: manufacturerName
                  })
                  .eq('id', inventoryItem.id);

                if (error) {
                  console.error('Failed to update item:', inventoryItem.itemName, error);
                } else {
                  itemsUpdated++;
                  console.log(`✅ Updated: ${inventoryItem.itemName} → PFG #${pfgItemNumber}`);
                }
              }
            } else {
              itemsNotFound++;
              console.log(`⚠️ No match found for: ${itemName}`);
            }
          }

          console.log(`\n📊 Insights Excel Import Complete:`);
          console.log(`   - Items updated: ${itemsUpdated}`);
          console.log(`   - Items not matched: ${itemsNotFound}`);

          showMessage(`✅ Imported data for ${itemsUpdated} items! ${itemsNotFound} not matched.`, 'success');

          // Reload inventory to reflect changes
          await loadInventoryItemsForOrdering();

        } catch (error) {
          console.error('Excel processing error:', error);
          showMessage('Failed to process Excel: ' + error.message, 'error');
        }
      };

      reader.readAsArrayBuffer(file);
    }

    // Handle PDF files
    if (isPDF) {
      showMessage('PDF uploaded! Processing with OCR...', 'success');
      const reader = new FileReader();
      reader.onload = async function(e) {
        // Store the PDF data
        orderingSystemState.currentInvoiceImage = e.target.result;

        // Show preview section (show PDF icon placeholder)
        document.getElementById('invoicePreviewSection').style.display = 'block';
        const previewImg = document.getElementById('invoicePreviewImage');

        // Create PDF preview indicator
        previewImg.style.display = 'none';
        let pdfPreview = document.getElementById('pdfPreviewIndicator');
        if (!pdfPreview) {
          pdfPreview = document.createElement('div');
          pdfPreview.id = 'pdfPreviewIndicator';
          pdfPreview.style.cssText = 'padding: 40px; text-align: center; background: var(--gray-100); border: 2px dashed var(--gray-400); border-radius: 0;';
          previewImg.parentNode.insertBefore(pdfPreview, previewImg);
        }
        pdfPreview.innerHTML = `
          <div style="font-size: 48px; margin-bottom: 12px;">📄</div>
          <div style="font-size: 14px; font-weight: 700; color: var(--gray-700); text-transform: uppercase; letter-spacing: 1px;">PDF UPLOADED</div>
          <div style="font-size: 11px; color: var(--gray-600); margin-top: 6px;">${file.name}</div>
        `;
        pdfPreview.style.display = 'block';

        // Hide other sections
        document.getElementById('ocrProcessingStatus').style.display = 'none';
        document.getElementById('extractedItemsSection').style.display = 'none';
      };
      reader.readAsDataURL(file);
      return;
    }

    // Handle image files
    const reader = new FileReader();
    reader.onload = function(e) {
      orderingSystemState.currentInvoiceImage = e.target.result;

      // Show preview section
      document.getElementById('invoicePreviewSection').style.display = 'block';
      const previewImg = document.getElementById('invoicePreviewImage');
      previewImg.src = e.target.result;
      previewImg.style.display = 'block';

      // Hide PDF preview if exists
      const pdfPreview = document.getElementById('pdfPreviewIndicator');
      if (pdfPreview) pdfPreview.style.display = 'none';

      // Hide other sections
      document.getElementById('ocrProcessingStatus').style.display = 'none';
      document.getElementById('extractedItemsSection').style.display = 'none';
    };
    reader.readAsDataURL(file);
  }

  /**
   * Clear uploaded invoice and reset
   */
  function clearInvoiceUpload() {
    orderingSystemState.currentInvoiceImage = null;
    orderingSystemState.extractedInvoiceItems = [];

    document.getElementById('invoiceFileInput').value = '';
    document.getElementById('invoiceCameraInput').value = '';
    document.getElementById('invoicePreviewSection').style.display = 'none';
    document.getElementById('ocrProcessingStatus').style.display = 'none';
    document.getElementById('extractedItemsSection').style.display = 'none';
  }

  /**
   * Convert PDF to images (one per page) for OCR processing
   */
  async function convertPdfToImages(pdfDataUrl) {
    console.log('📄 Converting PDF to images...');

    // Extract base64 data
    const base64Data = pdfDataUrl.split(',')[1];
    const binaryData = atob(base64Data);
    const uint8Array = new Uint8Array(binaryData.length);
    for (let i = 0; i < binaryData.length; i++) {
      uint8Array[i] = binaryData.charCodeAt(i);
    }

    // Load PDF with PDF.js
    const loadingTask = pdfjsLib.getDocument({ data: uint8Array });
    const pdf = await loadingTask.promise;

    console.log(`📄 PDF loaded: ${pdf.numPages} page(s)`);

    const images = [];

    // Process ALL pages
    for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
      console.log(`📄 Processing page ${pageNum}/${pdf.numPages}...`);

      const page = await pdf.getPage(pageNum);

      // Set scale for good quality (2 = 2x resolution)
      const scale = 2.0;
      const viewport = page.getViewport({ scale });

      // Create canvas for this page
      const canvas = document.createElement('canvas');
      const context = canvas.getContext('2d');
      canvas.width = viewport.width;
      canvas.height = viewport.height;

      // Render PDF page to canvas
      await page.render({
        canvasContext: context,
        viewport: viewport
      }).promise;

      console.log(`✅ Page ${pageNum} rendered:`, canvas.width, 'x', canvas.height);

      // Convert canvas to image data URL
      const imageDataUrl = canvas.toDataURL('image/png');
      images.push(imageDataUrl);
    }

    console.log(`✅ All ${pdf.numPages} pages converted to images`);

    return images;
  }

  /**
   * ============================================
   * VENDOR FORMAT LEARNING SYSTEM
   * ============================================
   */

  /**
   * Load custom vendor formats from database and populate dropdown
   */
  async function loadCustomVendorFormats() {
    try {
      const { data: formats, error } = await supabase
        .from('vendor_formats')
        .select('*')
        .eq('active', true)
        .order('format_name');

      if (error) throw error;

      if (formats && formats.length > 0) {
        const dropdown = document.getElementById('ocrVendorFormat');
        const addNewOption = dropdown.querySelector('option[value="__ADD_NEW__"]');

        // Add custom formats before "ADD NEW" option
        formats.forEach(format => {
          const option = document.createElement('option');
          option.value = format.format_id;
          option.textContent = format.format_name;
          option.dataset.customFormat = 'true';
          dropdown.insertBefore(option, addNewOption);
        });

        console.log('✅ Loaded', formats.length, 'custom vendor formats');
      }
    } catch (error) {
      console.warn('Failed to load custom formats:', error);
    }
  }

  /**
   * Handle vendor format dropdown change
   */
  async function handleVendorFormatChange(value) {
    if (value === '__ADD_NEW__') {
      showCreateFormatModal();
    } else {
      // Store selected format for later use
      orderingSystemState.selectedVendorFormat = value;
      console.log('Selected vendor format:', value);

      // If this is a custom format (not hardcoded), fetch its database ID
      const dropdown = document.getElementById('ocrVendorFormat');
      const selectedOption = dropdown.querySelector(`option[value="${value}"]`);

      if (selectedOption && selectedOption.dataset.customFormat === 'true') {
        // Fetch format ID from database
        const { data, error } = await supabase
          .from('vendor_formats')
          .select('id')
          .eq('format_id', value)
          .single();

        if (!error && data) {
          orderingSystemState.currentVendorFormatId = data.id;
          console.log('✅ Format ID loaded:', data.id);
        }
      } else {
        // Hardcoded formats don't have DB IDs yet
        orderingSystemState.currentVendorFormatId = null;
      }
    }
  }

  /**
   * Show modal to create new vendor format
   */
  function showCreateFormatModal() {
    const modal = document.createElement('div');
    modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10000;';

    const content = document.createElement('div');
    content.style.cssText = 'background: white; padding: 24px; max-width: 500px; width: 90%; border: 3px solid var(--gray-700);';

    content.innerHTML = `
      <h3 style="margin: 0 0 16px 0; font-size: 16px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;">
        🧠 CREATE NEW VENDOR FORMAT
      </h3>
      <p style="margin: 0 0 20px 0; font-size: 13px; color: var(--gray-600); line-height: 1.5;">
        Give this format a name (e.g., "Greenleaf Order", "Sysco Invoice").
        The system will learn from your manual corrections and improve accuracy next time!
      </p>

      <label style="display: block; margin-bottom: 8px; font-size: 11px; font-weight: 700; text-transform: uppercase; color: var(--gray-700); letter-spacing: 0.5px;">
        FORMAT NAME
      </label>
      <input
        type="text"
        id="newFormatName"
        placeholder="e.g., Greenleaf Order"
        style="width: 100%; padding: 12px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 14px; margin-bottom: 20px; box-sizing: border-box;"
        autofocus
      />

      <div style="display: flex; gap: 12px; justify-content: flex-end;">
        <button
          onclick="closeCreateFormatModal()"
          style="padding: 12px 24px; background: var(--gray-100); border: 2px solid var(--gray-300); color: var(--gray-900); font-size: 13px; font-weight: 700; cursor: pointer; text-transform: uppercase; letter-spacing: 0.5px;"
        >
          CANCEL
        </button>
        <button
          onclick="saveNewVendorFormat()"
          style="padding: 12px 24px; background: var(--gray-900); border: 2px solid var(--gray-900); color: white; font-size: 13px; font-weight: 700; cursor: pointer; text-transform: uppercase; letter-spacing: 0.5px;"
        >
          CREATE
        </button>
      </div>
    `;

    modal.appendChild(content);
    document.body.appendChild(modal);
    modal.id = 'createFormatModal';

    // Focus input
    setTimeout(() => document.getElementById('newFormatName').focus(), 100);

    // Allow Enter key to submit
    document.getElementById('newFormatName').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') saveNewVendorFormat();
    });
  }

  /**
   * Close create format modal
   */
  function closeCreateFormatModal() {
    const modal = document.getElementById('createFormatModal');
    if (modal) modal.remove();

    // Reset dropdown to previously selected format
    const dropdown = document.getElementById('ocrVendorFormat');
    dropdown.value = orderingSystemState.selectedVendorFormat || 'auto';
  }

  /**
   * Save new vendor format
   */
  async function saveNewVendorFormat() {
    const nameInput = document.getElementById('newFormatName');
    const formatName = nameInput.value.trim();

    if (!formatName) {
      nameInput.style.borderColor = 'red';
      return;
    }

    // Generate format_id from name (e.g., "Greenleaf Order" → "greenleaf-order")
    const formatId = formatName.toLowerCase().replace(/[^a-z0-9]+/g, '-');

    showLoading('Creating Format', `Saving "${formatName}"...`);

    try {
      const { data, error } = await supabase
        .from('vendor_formats')
        .insert({
          format_name: formatName,
          format_id: formatId,
          parsing_rules: {}, // Empty initially, will be populated from corrections
          sample_corrections: [],
          confidence_score: 0,
          created_by: 'User',
          notes: 'Created via OCR interface'
        })
        .select()
        .single();

      if (error) throw error;

      hideLoading();
      closeCreateFormatModal();

      // Add to dropdown
      const dropdown = document.getElementById('ocrVendorFormat');
      const addNewOption = dropdown.querySelector('option[value="__ADD_NEW__"]');
      const option = document.createElement('option');
      option.value = formatId;
      option.textContent = formatName;
      option.dataset.customFormat = 'true';
      dropdown.insertBefore(option, addNewOption);

      // Select the new format
      dropdown.value = formatId;
      orderingSystemState.selectedVendorFormat = formatId;
      orderingSystemState.currentVendorFormatId = data.id; // Store DB ID for corrections

      showMessage(`✅ Created format "${formatName}"! System will learn from your corrections.`, 'success');
    } catch (error) {
      hideLoading();
      console.error('Error creating format:', error);
      showMessage('Failed to create format: ' + error.message, 'error');
    }
  }

  /**
   * Track OCR correction for learning
   * Call this when user manually edits item name, quantity, or price
   */
  async function trackOCRCorrection(originalItem, correctedData) {
    if (!orderingSystemState.currentVendorFormatId) return; // No format selected

    try {
      const correction = {
        format_id: orderingSystemState.currentVendorFormatId,
        invoice_id: orderingSystemState.currentInvoiceId || null,
        original_text: originalItem.detectedName,
        corrected_item_name: correctedData.itemName,
        corrected_quantity: correctedData.quantity,
        corrected_price: correctedData.price,
        full_line_text: originalItem.fullLineText || originalItem.detectedName,
        correction_type: determineCorrectionType(originalItem, correctedData)
      };

      const { error } = await supabase
        .from('ocr_corrections')
        .insert(correction);

      if (error) throw error;

      console.log('📝 Logged correction for learning:', correction);

      // Update format's sample_corrections for pattern learning
      await updateFormatPatterns(orderingSystemState.currentVendorFormatId, correction);

    } catch (error) {
      console.warn('Failed to track correction:', error);
    }
  }

  /**
   * Determine what type of correction was made
   */
  function determineCorrectionType(original, corrected) {
    const itemChanged = original.detectedName !== corrected.itemName;
    const qtyChanged = original.detectedQuantity !== corrected.quantity;
    const priceChanged = original.detectedPrice !== corrected.price;

    if (itemChanged && qtyChanged && priceChanged) return 'all';
    if (itemChanged) return 'item_name';
    if (qtyChanged) return 'quantity';
    if (priceChanged) return 'price';
    return 'none';
  }

  /**
   * Update format patterns based on correction
   */
  async function updateFormatPatterns(formatId, correction) {
    try {
      // Fetch current format
      const { data: format, error: fetchError } = await supabase
        .from('vendor_formats')
        .select('sample_corrections, parsing_rules')
        .eq('id', formatId)
        .single();

      if (fetchError) throw fetchError;

      // Add this correction to samples (keep last 50)
      const samples = format.sample_corrections || [];
      samples.push({
        original: correction.original_text,
        corrected_name: correction.corrected_item_name,
        corrected_qty: correction.corrected_quantity,
        corrected_price: correction.corrected_price,
        timestamp: new Date().toISOString()
      });

      // Keep only last 50 corrections
      const recentSamples = samples.slice(-50);

      // Analyze patterns (simple pattern detection for now)
      const patterns = analyzeCorrections(recentSamples);

      // Update format
      const { error: updateError } = await supabase
        .from('vendor_formats')
        .update({
          sample_corrections: recentSamples,
          parsing_rules: patterns,
          updated_at: new Date().toISOString()
        })
        .eq('id', formatId);

      if (updateError) throw updateError;

      console.log('🧠 Updated format patterns:', patterns);

    } catch (error) {
      console.warn('Failed to update patterns:', error);
    }
  }

  /**
   * Detect vendor from OCR text
   * Looks for known vendor names in the header of the invoice
   */
  function detectVendorFromText(text) {
    if (!text) return null;

    // Check first 500 characters (vendor info usually at top)
    const header = text.substring(0, 500).toLowerCase();
    
    // Known vendor patterns (add more as needed)
    const vendorPatterns = [
      { pattern: /greenleaf|green\s*leaf/i, vendor: 'Greenleaf' },
      { pattern: /performance\s*food|pfg/i, vendor: 'Performance' },
      { pattern: /mani\s*imports?/i, vendor: 'Mani Imports' },
      { pattern: /eatopia/i, vendor: 'Eatopia' },
      { pattern: /restaurant\s*depot/i, vendor: 'Restaurant Depot' },
      { pattern: /alsco/i, vendor: 'Alsco' },
      { pattern: /src\s*pumping/i, vendor: 'SRC Pumping' },
      { pattern: /southern\s*glazer/i, vendor: 'Southern Glazer\'s' },
      { pattern: /breakthru\s*bev/i, vendor: 'Breakthru Beverage' },
      { pattern: /sysco/i, vendor: 'Sysco' },
      { pattern: /us\s*foods/i, vendor: 'US Foods' }
    ];

    for (const { pattern, vendor } of vendorPatterns) {
      if (pattern.test(header)) {
        console.log('✅ Vendor detected:', vendor, 'from pattern:', pattern);
        return vendor;
      }
    }

    console.log('⚠️ No vendor detected from text');
    return null;
  }

  /**
   * Analyze corrections to detect patterns
   * This is a simple version - can be enhanced with ML
   */
  function analyzeCorrections(samples) {
    if (!samples || samples.length < 3) return {}; // Need at least 3 samples

    const patterns = {
      common_price_positions: [],
      common_quantity_patterns: [],
      item_name_length_avg: 0,
      detected_at: new Date().toISOString()
    };

    // Analyze where prices typically appear
    const priceMatches = samples.map(s => {
      const match = s.original.match(/\$?\d+\.\d{2}/);
      return match ? match.index : -1;
    }).filter(i => i !== -1);

    if (priceMatches.length > 0) {
      patterns.common_price_positions = [Math.round(priceMatches.reduce((a,b) => a+b) / priceMatches.length)];
    }

    // Analyze average item name length
    const nameLengths = samples.map(s => s.corrected_name?.length || 0).filter(l => l > 0);
    if (nameLengths.length > 0) {
      patterns.item_name_length_avg = Math.round(nameLengths.reduce((a,b) => a+b) / nameLengths.length);
    }

    return patterns;
  }

  /**
   * Process invoice with Tesseract OCR
   */
  async function processInvoiceOCR() {
    if (!orderingSystemState.currentInvoiceImage) {
      showMessage('No image uploaded', 'error');
      return;
    }

    // Show processing status
    document.getElementById('ocrProcessingStatus').style.display = 'block';
    document.getElementById('ocrProgressText').textContent = 'Initializing OCR engine...';
    document.getElementById('processOCRButton').disabled = true;

    try {
      // Check if Tesseract is loaded
      if (typeof Tesseract === 'undefined') {
        throw new Error('Tesseract OCR library not loaded. Please refresh the page.');
      }

      console.log('Starting OCR process...');
      console.log('Image data:', orderingSystemState.currentInvoiceImage?.substring(0, 50));

      // Check if this is a PDF file
      const isPDF = orderingSystemState.currentInvoiceImage.startsWith('data:application/pdf');
      let extractedText = '';

      if (isPDF) {
        console.log('📄 PDF detected - converting to images and processing all pages...');
        document.getElementById('ocrProgressText').textContent = 'Converting PDF to images...';

        // Check if PDF.js is loaded
        if (typeof pdfjsLib === 'undefined') {
          throw new Error('PDF.js library not loaded. Please refresh the page.');
        }

        // Convert PDF to multiple images (one per page)
        const images = await convertPdfToImages(orderingSystemState.currentInvoiceImage);
        console.log('✅ PDF converted to', images.length, 'image(s)');

        // Process each page with OCR
        for (let i = 0; i < images.length; i++) {
          const pageNum = i + 1;
          console.log(`🔍 OCR processing page ${pageNum}/${images.length}...`);
          document.getElementById('ocrProgressText').textContent = `Extracting text from page ${pageNum}/${images.length}...`;

          const result = await Tesseract.recognize(
            images[i],
            'eng',
            {
              logger: (m) => {
                if (m.status === 'recognizing text') {
                  const progress = Math.round(m.progress * 100);
                  document.getElementById('ocrProgressText').textContent = `Page ${pageNum}/${images.length}: ${progress}%`;
                }
              }
            }
          );

          const pageText = result?.data?.text || '';
          console.log(`✅ Page ${pageNum} OCR completed: ${pageText.length} characters`);

          // Combine text from all pages
          extractedText += pageText + '\n\n'; // Add spacing between pages
        }

        console.log('✅ All pages processed. Total text length:', extractedText.length);

      } else {
        // Process single image
        document.getElementById('ocrProgressText').textContent = 'Loading OCR engine...';

        const result = await Tesseract.recognize(
          orderingSystemState.currentInvoiceImage,
          'eng',
          {
            logger: (m) => {
              console.log('Tesseract progress:', m);
              if (m.status === 'recognizing text') {
                document.getElementById('ocrProgressText').textContent = `Extracting text: ${Math.round(m.progress * 100)}%`;
              }
            }
          }
        );

        console.log('OCR completed, result:', result);
        extractedText = result?.data?.text || '';
      }
      console.log('Extracted text length:', extractedText.length);
      console.log('First 200 chars:', extractedText.substring(0, 200));

      // Update progress
      document.getElementById('ocrProgressText').textContent = 'Parsing extracted text...';

      // Parse the extracted text to find items
      const extractedItems = parseInvoiceText(extractedText);
      console.log('Parsed items:', extractedItems.length);

      // Detect vendor from OCR text for better matching
      const detectedVendor = detectVendorFromText(extractedText);
      console.log('🏢 Detected vendor from invoice:', detectedVendor || 'none');

      // Update progress
      document.getElementById('ocrProgressText').textContent = 'Matching items with inventory...';

      // Ensure inventory items are loaded
      if (!orderingSystemState.items || orderingSystemState.items.length === 0) {
        console.warn('No inventory items loaded for matching');
      }

      // Match items with inventory using advanced fuzzy matching (only if items were found)
      if (extractedItems.length > 0) {
        for (const item of extractedItems) {
          const match = fuzzyMatchInventoryItem(item.detectedName, detectedVendor);
          if (match) {
            item.matchedInventoryId = match.id;
            item.matchConfidence = match.confidence;
            item.matchedItemName = match.itemName;
            item.matchedVendor = match.vendor; // NEW: Get vendor from matched inventory item
            
            // If unit wasn't detected, use inventory item's unit
            if (!item.detectedUnit && match.unit) {
              item.detectedUnit = match.unit;
            }
          }
        }
        
        // NEW: Determine the most likely vendor from matched items
        const vendorCounts = {};
        extractedItems.forEach(item => {
          if (item.matchedVendor) {
            vendorCounts[item.matchedVendor] = (vendorCounts[item.matchedVendor] || 0) + 1;
          }
        });
        
        // Get vendor with most matches
        let determinedVendor = null;
        let maxCount = 0;
        for (const [vendor, count] of Object.entries(vendorCounts)) {
          if (count > maxCount) {
            maxCount = count;
            determinedVendor = vendor;
          }
        }
        
        if (determinedVendor) {
          console.log(`🏢 Vendor determined from item matching: ${determinedVendor} (${maxCount}/${extractedItems.length} items matched)`);
          // Store for later use
          orderingSystemState.determinedVendor = determinedVendor;
        }
      }

      // Store extracted items (even if empty array - user can add manually)
      orderingSystemState.extractedInvoiceItems = extractedItems;

      // Hide processing, show results
      document.getElementById('ocrProcessingStatus').style.display = 'none';
      document.getElementById('extractedItemsSection').style.display = 'block';

      // Render extracted items (will show "add manually" button if empty)
      renderExtractedItems();

      // Re-enable button
      document.getElementById('processOCRButton').disabled = false;

      // Show appropriate message
      if (extractedItems.length === 0) {
        showMessage('No items auto-detected. You can add items manually below.', 'info');
      } else {
        showMessage(`Successfully extracted ${extractedItems.length} items from invoice!`, 'success');
      }

    } catch (error) {
      console.error('OCR processing error:', error);
      const errorMsg = error?.message || error?.toString() || 'Unknown error occurred';
      showMessage('Failed to process invoice: ' + errorMsg, 'error');
      document.getElementById('ocrProcessingStatus').style.display = 'none';
      document.getElementById('processOCRButton').disabled = false;
    }
  }

  /**
   * Parse extracted OCR text to find line items
   * Simple pattern matching for common invoice formats
   */
  function parseInvoiceText(text) {
    if (!text) {
      console.warn('No text provided to parseInvoiceText');
      return [];
    }

    const items = [];

    // CRITICAL: Filter out blank lines (OCR creates double newlines)
    const allLines = text.split('\n');
    const lines = allLines.map(l => l.trim()).filter(l => l.length > 0);

    console.log('🔍 Parsing OCR text - Total lines (after removing blanks):', lines.length);
    console.log('📄 Invoice type:', orderingSystemState.invoiceType || 'invoice');

    // ==== PERFORMANCE ORDER FORMAT ====
    // Format from image:
    // WATER DRINKING
    // 543845 HILTON (6-digit SKU + Brand)
    // 24/16.9 OZ    Confirmed: 2    Qty: 2
    // CS            $5.12           $10.24

    const vendorFormat = document.getElementById('ocrVendorFormat')?.value || 'auto';

    if (orderingSystemState.invoiceType === 'order' || vendorFormat === 'performance-order') {
      console.log('🔍 Trying Performance Order format...');
      console.log('📄 Vendor format selected:', vendorFormat);
      console.log('📄 First 15 OCR lines:');
      for (let i = 0; i < Math.min(15, lines.length); i++) {
        console.log(`  Line ${i}: "${lines[i]}"`);
      }

      for (let i = 0; i < lines.length - 3; i++) {
        const currentLine = lines[i].trim();
        const nextLine = lines[i + 1].trim();
        const line3 = lines[i + 2].trim();
        const line4 = lines[i + 3].trim();

        // Look for SKU pattern: Line starts with 6 digits followed by brand name
        // Example: "543845 HILTON" or "276375 COKE ZERO"
        const skuMatch = nextLine.match(/^(\d{6})\s+(.+)$/);

        if (skuMatch) {
          const itemName = currentLine; // Line BEFORE SKU is the item name
          const sku = skuMatch[1];
          const brand = skuMatch[2];

          console.log(`  ✓ Found SKU pattern: "${sku} ${brand}" at line ${i+1}`);
          console.log(`  → Item name (line ${i}): "${itemName}"`);

          // Skip if item name is junk (too short, just numbers, etc.)
          if (itemName.length < 3 || itemName.match(/^[\d\s\-\/]+$/)) {
            console.log(`  ✗ Skipping - item name is junk`);
            continue;
          }

          // Extract quantity from "Confirmed: X" in line3
          let quantity = 1;
          const confirmedMatch = line3.match(/confirmed:?\s*(\d+)/i);
          if (confirmedMatch) {
            quantity = parseInt(confirmedMatch[1]);
            console.log(`  ✓ Extracted quantity: ${quantity} from line ${i+2}`);
          }

          // Extract price from line4 or nearby lines
          // Performance orders show: "CS $35.55 $70.22" (unit price, then total)
          // We want the FIRST price (unit price per case)
          let price = null;

          // Try to find price in next 5 lines after item
          for (let j = i + 2; j < Math.min(i + 7, lines.length); j++) {
            const priceLine = lines[j];

            // Pattern 1: "CS $XX.XX" or "CS $XX.XX $YYY.YY" (unit price first)
            const csWithPrice = priceLine.match(/cs\s+\$(\d+\.\d{2})/i);
            if (csWithPrice) {
              price = parseFloat(csWithPrice[1]);
              console.log(`  ✓ Found CS unit price: $${price} at line ${j} [${priceLine.trim()}]`);
              break;
            }

            // Pattern 2: Just "$XX.XX" anywhere in line (first occurrence)
            const dollarMatch = priceLine.match(/\$(\d+\.\d{2})/);
            if (dollarMatch && !price) {  // Only if we haven't found CS price yet
              const foundPrice = parseFloat(dollarMatch[1]);
              // Reasonable price range check (avoid order numbers like $55229235)
              if (foundPrice > 0.01 && foundPrice < 1000) {
                price = foundPrice;
                console.log(`  ✓ Found $ price: $${price} at line ${j} [${priceLine.trim()}]`);
                break;
              }
            }

            // Pattern 3: Numbers that look like prices (without $, OCR might miss it)
            // Look for XX.XX pattern after "CS" or "Confirmed"
            if (!price) {
              const numericPrice = priceLine.match(/(?:cs|confirmed:?\s+\d+).*?(\d+\.\d{2})/i);
              if (numericPrice) {
                const foundPrice = parseFloat(numericPrice[1]);
                if (foundPrice > 0.50 && foundPrice < 1000) {
                  price = foundPrice;
                  console.log(`  ✓ Found numeric price: $${price} at line ${j} [${priceLine.trim()}]`);
                  break;
                }
              }
            }
          }

          if (!price) {
            console.log(`  ⚠️ No price found for "${itemName}"`);
          }

          // Extract unit from nearby lines (CS, EA, LB, etc.)
          let detectedUnit = null;
          for (let j = Math.max(0, i - 1); j < Math.min(i + 5, lines.length); j++) {
            const unitLine = lines[j];
            const unitMatch = unitLine.match(/\b(cs|case|ea|each|lb|lbs|pound|kg|oz|gallon|gal|bt|bottle)\b/i);
            if (unitMatch) {
              detectedUnit = unitMatch[1].toUpperCase();
              if (detectedUnit === 'CASE') detectedUnit = 'CS';
              if (detectedUnit === 'EACH') detectedUnit = 'EA';
              if (detectedUnit === 'POUND' || detectedUnit === 'LBS') detectedUnit = 'LB';
              if (detectedUnit === 'GALLON') detectedUnit = 'GAL';
              if (detectedUnit === 'BOTTLE') detectedUnit = 'BT';
              console.log(`  ✓ Detected unit: ${detectedUnit} from line ${j}`);
              break;
            }
          }

          // Try to extract Qty Shipped (if different from Qty Ordered)
          // Look for patterns like "Shipped: X" or "Ship Qty: X"
          let qtyShipped = null;
          for (let j = i; j < Math.min(i + 5, lines.length); j++) {
            const shippedMatch = lines[j].match(/(?:shipped|ship\s*qty|qty\s*ship):?\s*(\d+)/i);
            if (shippedMatch) {
              qtyShipped = parseInt(shippedMatch[1]);
              if (qtyShipped !== quantity) {
                console.log(`  ✓ Qty Shipped: ${qtyShipped} (different from ordered: ${quantity})`);
              }
              break;
            }
          }

          items.push({
            id: Date.now() + Math.random() + i,
            detectedName: itemName,
            detectedQuantity: quantity,
            detectedQuantityShipped: qtyShipped, // NEW: Track shipped vs ordered
            detectedUnit: detectedUnit,          // NEW: Unit detection
            detectedPrice: price,
            matchedInventoryId: null,
            matchConfidence: 0,
            matchedItemName: null,
            matchedVendor: null                   // NEW: Will be set after matching
          });

          console.log(`✅ Added item: "${itemName}" | Ordered: ${quantity}${qtyShipped && qtyShipped !== quantity ? ` | Shipped: ${qtyShipped}` : ''} | Unit: ${detectedUnit || 'N/A'} | Price: ${price ? '$' + price : 'N/A'}`);

          // Skip the lines we just processed
          // Instead of fixed skip, find the next item by looking for the next SKU
          // This handles variable spacing (Information lines, blank lines, etc.)
          let skipCount = 0;
          for (let j = i + 2; j < lines.length; j++) {
            skipCount++;
            const nextLine = lines[j];

            // Stop if we find the next SKU pattern (6 digits)
            if (nextLine.match(/^\d{6}\s+/)) {
              skipCount--; // Back up one so loop will land on item name before SKU
              break;
            }

            // Safety: max skip 10 lines
            if (skipCount >= 10) break;
          }

          console.log(`  → Skipping ${skipCount} lines to next item`);
          i += skipCount;
        }
      }

      console.log('📊 Performance Order format matched items:', items.length);

      if (items.length > 0) {
        return items; // Success!
      }
    }

    // ==== STANDARD INVOICE FORMAT ====
    // Pattern to match: quantity, item name, unit, price
    // Example: "2 Arugula 4# CS 12.50" or "1.5 Fresh Basil Bunch EA 8.99"
    const itemPattern = /^[\s]*([0-9]+\.?[0-9]*)\s+(.+?)\s+([0-9]+\.[0-9]{2})[\s]*$/;
    
    // Enhanced pattern to catch unit in the line
    const itemWithUnitPattern = /^[\s]*([0-9]+\.?[0-9]*)\s+(.+?)\s+(CS|EA|LB|KG|OZ|GAL|BT|CASE|EACH|POUND)\s+([0-9]+\.[0-9]{2})[\s]*$/i;

    // Try pattern matching first
    let patternMatchCount = 0;
    for (const line of lines) {
      const trimmed = line.trim();
      if (trimmed.length < 5) continue; // Skip short lines

      // Try unit-aware pattern first
      let match = trimmed.match(itemWithUnitPattern);
      let detectedUnit = null;
      
      if (match) {
        const quantity = parseFloat(match[1]);
        const name = match[2].trim();
        detectedUnit = match[3].toUpperCase();
        const price = parseFloat(match[4]);
        
        // Normalize unit names
        if (detectedUnit === 'CASE') detectedUnit = 'CS';
        if (detectedUnit === 'EACH') detectedUnit = 'EA';
        if (detectedUnit === 'POUND') detectedUnit = 'LB';

        // Only add if quantity is reasonable (0.25 to 1000)
        if (quantity >= 0.25 && quantity <= 1000 && name.length > 2) {
          items.push({
            id: Date.now() + Math.random(),
            detectedName: name,
            detectedQuantity: quantity,
            detectedQuantityShipped: null,
            detectedUnit: detectedUnit,
            detectedPrice: price,
            matchedInventoryId: null,
            matchConfidence: 0,
            matchedItemName: null,
            matchedVendor: null
          });
          patternMatchCount++;
        }
      } else {
        // Try standard pattern (no unit in line)
        match = trimmed.match(itemPattern);
        if (match) {
          const quantity = parseFloat(match[1]);
          const name = match[2].trim();
          const price = parseFloat(match[3]);

          // Only add if quantity is reasonable (0.25 to 1000)
          if (quantity >= 0.25 && quantity <= 1000 && name.length > 2) {
            items.push({
              id: Date.now() + Math.random(),
              detectedName: name,
              detectedQuantity: quantity,
              detectedQuantityShipped: null,
              detectedUnit: null,
              detectedPrice: price,
              matchedInventoryId: null,
              matchConfidence: 0,
              matchedItemName: null,
              matchedVendor: null
            });
            patternMatchCount++;
          }
        }
      }
    }

    console.log('📊 Standard format matched items:', patternMatchCount);

    // If no pattern matches found, show ALL lines for manual matching
    if (items.length === 0) {
      console.log('⚠️ No pattern matches - showing ALL lines for manual review');

      // Skip common header/footer lines
      const skipPatterns = [
        /^(order|invoice|po#|est\.|qty|total|subtotal|tax|page)/i,
        /^[0-9]{10,}$/, // Long numbers (order IDs)
        /^[0-9\/\-]+$/, // Just dates
        /^\s*$/  // Empty
      ];

      for (let i = 0; i < lines.length; i++) {
        const trimmed = lines[i].trim();

        // Skip very short or very long lines
        if (trimmed.length < 3 || trimmed.length > 100) continue;

        // Skip header/footer patterns
        let shouldSkip = false;
        for (const pattern of skipPatterns) {
          if (pattern.test(trimmed)) {
            shouldSkip = true;
            break;
          }
        }

        if (shouldSkip) continue;

        // Add as potential item (user can skip/match manually)
        items.push({
          id: Date.now() + Math.random() + i, // Temporary ID
          detectedName: trimmed,
          detectedQuantity: 1, // Default quantity
          detectedQuantityShipped: null,
          detectedUnit: null,
          detectedPrice: null, // No price detected
          matchedInventoryId: null,
          matchConfidence: 0,
          matchedItemName: null,
          matchedVendor: null
        });
      }

      console.log('📋 Created', items.length, 'potential items from OCR lines for manual review');
    }

    return items;
  }

  /**
   * Fuzzy match detected item name with inventory items
   * Returns {id, itemName, confidence} or null
   */
  /**
   * Calculate Levenshtein distance between two strings
   * Industry-standard algorithm for string similarity
   */
  function levenshteinDistance(str1, str2) {
    const len1 = str1.length;
    const len2 = str2.length;
    const matrix = Array(len2 + 1).fill(null).map(() => Array(len1 + 1).fill(0));

    for (let i = 0; i <= len1; i++) matrix[0][i] = i;
    for (let j = 0; j <= len2; j++) matrix[j][0] = j;

    for (let j = 1; j <= len2; j++) {
      for (let i = 1; i <= len1; i++) {
        const cost = str1[i - 1] === str2[j - 1] ? 0 : 1;
        matrix[j][i] = Math.min(
          matrix[j][i - 1] + 1,     // deletion
          matrix[j - 1][i] + 1,     // insertion
          matrix[j - 1][i - 1] + cost // substitution
        );
      }
    }

    return matrix[len2][len1];
  }

  /**
   * Advanced normalization for better matching
   * Handles common OCR errors and variations
   */
  function normalizeForMatching(text) {
    return text
      .toLowerCase()
      .replace(/\b(case|cs|pack|pk|box|bx|ea|each|lb|lbs|pound|oz|ounce)\b/gi, '') // Remove unit words
      .replace(/[^\w\s]/g, ' ')  // Replace special chars with space
      .replace(/\s+/g, ' ')      // Collapse multiple spaces
      .trim();
  }

  /**
   * Generate character n-grams for fuzzy matching
   * Helps catch OCR errors and misspellings
   */
  function getNgrams(text, n = 2) {
    const ngrams = new Set();
    for (let i = 0; i <= text.length - n; i++) {
      ngrams.add(text.substring(i, i + n));
    }
    return ngrams;
  }

  /**
   * Calculate n-gram similarity between two strings
   * More robust than simple word matching
   */
  function ngramSimilarity(str1, str2, n = 2) {
    const ngrams1 = getNgrams(str1, n);
    const ngrams2 = getNgrams(str2, n);
    
    const intersection = new Set([...ngrams1].filter(x => ngrams2.has(x)));
    const union = new Set([...ngrams1, ...ngrams2]);
    
    return union.size > 0 ? intersection.size / union.size : 0;
  }

  /**
   * Advanced fuzzy matching with multiple strategies
   * Based on industry best practices for OCR and user input matching
   */
  function fuzzyMatchInventoryItem(detectedName, contextVendor = null) {
    console.log('🔍 fuzzyMatchInventoryItem called with:', detectedName, 'vendor:', contextVendor);
    console.log('📦 Total inventory items:', orderingSystemState.items.length);
    console.log('📚 Total learned aliases:', orderingSystemState.aliases ? Object.keys(orderingSystemState.aliases).length : 0);
    
    if (!detectedName || orderingSystemState.items.length === 0) {
      console.log('❌ No detected name or empty inventory, returning null');
      return null;
    }

    const normalizedDetected = normalizeForMatching(detectedName);
    console.log('🔤 Normalized detected name:', normalizedDetected);

    // PRIORITY 1: Check learned aliases (exact match from past manual selections)
    const simpleNormalized = detectedName.toLowerCase().replace(/[^a-z0-9\s]/g, '');
    if (orderingSystemState.aliases && orderingSystemState.aliases[simpleNormalized]) {
      const aliasMatch = orderingSystemState.aliases[simpleNormalized];
      console.log('💡 Found alias match:', aliasMatch);
      const item = orderingSystemState.items.find(i => i.id === aliasMatch.inventory_item_id);
      if (item) {
        console.log('✅ LEARNED MATCH:', detectedName, '→', item.itemName, '(ID:', item.id, ')');
        return {
          id: item.id,
          itemName: item.itemName,
          vendor: item.vendor,
          unit: item.unit,
          confidence: 1.0 // 100% confidence from learned alias
        };
      }
    }

    // PRIORITY 2: Advanced fuzzy matching with multiple algorithms
    console.log('🔎 No alias match, starting multi-strategy fuzzy matching...');
    let bestMatch = null;
    let bestScore = 0;
    let allScores = [];

    const detectedWords = normalizedDetected.split(/\s+/).filter(w => w.length > 2);
    const detectedBigrams = getNgrams(normalizedDetected, 2);
    const detectedTrigrams = getNgrams(normalizedDetected, 3);

    for (const item of orderingSystemState.items) {
      const normalizedItem = normalizeForMatching(item.itemName);
      const itemWords = normalizedItem.split(/\s+/).filter(w => w.length > 2);

      // Strategy 1: Token-based matching (word overlap with better logic)
      let tokenScore = 0;
      let matchedWords = 0;
      for (const detWord of detectedWords) {
        let bestWordMatch = 0;
        for (const itemWord of itemWords) {
          // Check both substring containment and similarity
          if (itemWord.includes(detWord) || detWord.includes(itemWord)) {
            bestWordMatch = 1.0;
          } else {
            // Use Levenshtein for near-matches
            const maxLen = Math.max(detWord.length, itemWord.length);
            const dist = levenshteinDistance(detWord, itemWord);
            const similarity = 1 - (dist / maxLen);
            if (similarity > 0.7) { // 70% similar words count
              bestWordMatch = Math.max(bestWordMatch, similarity);
            }
          }
        }
        if (bestWordMatch > 0) {
          matchedWords++;
          tokenScore += bestWordMatch;
        }
      }
      tokenScore = detectedWords.length > 0 ? tokenScore / detectedWords.length : 0;

      // Strategy 2: Character n-gram similarity (catches OCR errors)
      const bigramScore = ngramSimilarity(normalizedDetected, normalizedItem, 2);
      const trigramScore = ngramSimilarity(normalizedDetected, normalizedItem, 3);
      const ngramScore = (bigramScore * 0.6 + trigramScore * 0.4);

      // Strategy 3: Levenshtein distance (normalized)
      const maxLen = Math.max(normalizedDetected.length, normalizedItem.length);
      const levDist = levenshteinDistance(normalizedDetected, normalizedItem);
      const levScore = 1 - (levDist / maxLen);

      // Strategy 4: Exact substring bonus
      let substringBonus = 0;
      if (normalizedItem.includes(normalizedDetected) || normalizedDetected.includes(normalizedItem)) {
        substringBonus = 0.3;
      }

      // Strategy 5: Vendor context bonus (if vendor is known from invoice)
      let vendorBonus = 0;
      if (contextVendor && item.vendor.toLowerCase().includes(contextVendor.toLowerCase())) {
        vendorBonus = 0.15;
      }

      // Weighted combination of all strategies
      // Token matching is most important (40%), then n-grams (25%), then Levenshtein (20%)
      // Bonuses add to the final score
      const combinedScore = (
        tokenScore * 0.40 +
        ngramScore * 0.25 +
        levScore * 0.20 +
        (matchedWords / Math.max(detectedWords.length, itemWords.length, 1)) * 0.15
      ) + substringBonus + vendorBonus;

      // Store detailed score for debugging
      if (combinedScore > 0.15) { // Only log meaningful scores
        allScores.push({
          itemName: item.itemName,
          itemId: item.id,
          vendor: item.vendor,
          finalScore: combinedScore.toFixed(3),
          breakdown: {
            token: tokenScore.toFixed(3),
            ngram: ngramScore.toFixed(3),
            levenshtein: levScore.toFixed(3),
            substring: substringBonus.toFixed(3),
            vendor: vendorBonus.toFixed(3)
          }
        });
      }

      if (combinedScore > bestScore) {
        bestScore = combinedScore;
        bestMatch = {
          id: item.id,
          itemName: item.itemName,
          vendor: item.vendor,        // NEW: Include vendor from inventory item
          unit: item.unit,            // NEW: Include unit from inventory item
          confidence: Math.min(combinedScore, 0.99) // Cap at 99% (only learned aliases get 100%)
        };
      }
    }

    // Sort and log top matches
    allScores.sort((a, b) => parseFloat(b.finalScore) - parseFloat(a.finalScore));
    console.log('📊 Top 10 fuzzy match candidates:', allScores.slice(0, 10));
    console.log('🏆 Best match:', bestMatch, 'Final score:', bestScore.toFixed(3));

    // Adaptive threshold based on match quality
    // Use lower threshold (0.35) if we have high token matches
    // Use higher threshold (0.50) for low-quality matches
    const threshold = bestScore > 0.6 ? 0.35 : 0.50;
    console.log('📏 Using threshold:', threshold);

    if (bestScore >= threshold) {
      console.log('✅ Match found above threshold:', bestMatch.itemName, '(ID:', bestMatch.id, 'Vendor:', bestMatch.vendor, 'Unit:', bestMatch.unit, ')');
      return bestMatch;
    } else {
      console.log('❌ No match found above threshold (best score:', bestScore.toFixed(3), ')');
      return null;
    }
  }

  /**
   * Render extracted invoice items with matched inventory
   * Uses DOM manipulation to avoid template literal issues
   */
  function renderExtractedItems() {
    const container = document.getElementById('extractedItemsList');
    if (!container) return;

    // Clear existing items
    container.innerHTML = '';

    if (orderingSystemState.extractedInvoiceItems.length === 0) {
      // Show message that no items were extracted
      const emptyMessage = document.createElement('div');
      emptyMessage.style.cssText = 'background: var(--gray-100); border: 2px dashed var(--gray-400); padding: 40px 20px; text-align: center; border-radius: 0; margin-bottom: 20px;';

      const icon = document.createElement('div');
      icon.textContent = '📋';
      icon.style.cssText = 'font-size: 48px; margin-bottom: 16px;';
      emptyMessage.appendChild(icon);

      const title = document.createElement('div');
      title.textContent = 'NO TEXT DETECTED';
      title.style.cssText = 'font-size: 14px; font-weight: 700; color: var(--gray-900); margin-bottom: 8px; letter-spacing: 1px;';
      emptyMessage.appendChild(title);

      const desc = document.createElement('div');
      desc.textContent = 'OCR could not extract any text from the image. Please try a clearer photo.';
      desc.style.cssText = 'font-size: 12px; color: var(--gray-600);';
      emptyMessage.appendChild(desc);

      container.appendChild(emptyMessage);
      return; // No items to display
    }

    // Create a card for each extracted item
    orderingSystemState.extractedInvoiceItems.forEach((item, index) => {
      const card = document.createElement('div');
      card.style.cssText = 'background: var(--white); border: 2px solid var(--gray-300); border-radius: 0; padding: 12px; margin-bottom: 10px;';

      // Header row with detected name and quantity
      const headerRow = document.createElement('div');
      headerRow.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; gap: 12px;';

      const detectedName = document.createElement('strong');
      detectedName.textContent = item.detectedName;
      detectedName.style.cssText = 'font-size: 14px; color: var(--gray-900); text-transform: uppercase; letter-spacing: 0.5px; flex: 1;';

      // Editable quantity input
      const qtyContainer = document.createElement('div');
      qtyContainer.style.cssText = 'display: flex; align-items: center; gap: 6px;';

      const qtyLabel = document.createElement('span');
      qtyLabel.textContent = 'QTY:';
      qtyLabel.style.cssText = 'font-size: 11px; font-weight: 700; color: var(--gray-700); letter-spacing: 0.5px;';
      qtyContainer.appendChild(qtyLabel);

      const qtyInput = document.createElement('input');
      qtyInput.type = 'number';
      qtyInput.min = '0';
      qtyInput.step = '1';
      qtyInput.value = item.detectedQuantity;
      qtyInput.style.cssText = 'width: 60px; padding: 6px 8px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 13px; font-weight: 700; text-align: center; background: white;';
      qtyInput.onchange = function() {
        item.detectedQuantity = parseInt(this.value) || 1;
        console.log('✏️ Updated quantity for', item.detectedName, '→', item.detectedQuantity);
      };
      qtyContainer.appendChild(qtyInput);

      headerRow.appendChild(detectedName);
      headerRow.appendChild(qtyContainer);
      card.appendChild(headerRow);

      // Match confidence indicator
      const matchRow = document.createElement('div');
      matchRow.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;';

      const matchInfo = document.createElement('div');
      matchInfo.style.flex = '1';

      if (item.matchedInventoryId) {
        // Has a match
        const matchLabel = document.createElement('div');
        matchLabel.textContent = 'Matched: ' + item.matchedItemName;
        matchLabel.style.cssText = 'font-size: 12px; color: var(--gray-700); margin-bottom: 4px;';

        const confidenceBadge = document.createElement('span');
        const confidence = Math.round(item.matchConfidence * 100);
        confidenceBadge.textContent = confidence + '%';
        confidenceBadge.style.cssText = 'font-size: 10px; padding: 2px 6px; border-radius: 0; font-weight: 700; letter-spacing: 0.5px;';

        // Grayscale based on confidence (darker = higher confidence)
        if (item.matchConfidence >= 0.7) {
          confidenceBadge.style.background = 'var(--gray-700)';
          confidenceBadge.style.color = 'var(--white)';
        } else if (item.matchConfidence >= 0.5) {
          confidenceBadge.style.background = 'var(--gray-400)';
          confidenceBadge.style.color = 'var(--gray-900)';
        } else {
          confidenceBadge.style.background = 'var(--gray-300)';
          confidenceBadge.style.color = 'var(--gray-700)';
        }

        matchInfo.appendChild(matchLabel);
        matchInfo.appendChild(confidenceBadge);
      } else {
        // No match found
        const noMatchLabel = document.createElement('div');
        noMatchLabel.textContent = 'NO MATCH FOUND';
        noMatchLabel.style.cssText = 'font-size: 11px; color: var(--gray-500); font-weight: 700; letter-spacing: 0.5px;';
        matchInfo.appendChild(noMatchLabel);
      }

      matchRow.appendChild(matchInfo);

      // Button container for MATCH, ADD NEW, and SKIP
      // ALWAYS show these buttons - user needs control even on 100% matches!
      const btnContainer = document.createElement('div');
      btnContainer.style.cssText = 'display: flex; gap: 6px;';

      // MATCH/CHANGE button (always visible)
      const manualMatchBtn = document.createElement('button');
      manualMatchBtn.textContent = item.matchedInventoryId ? 'CHANGE' : 'MATCH';
      manualMatchBtn.style.cssText = 'background: var(--gray-100); color: var(--gray-900); border: 2px solid var(--gray-300); padding: 6px 12px; border-radius: 0; cursor: pointer; font-size: 10px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase;';
      manualMatchBtn.onclick = function() {
        console.log('🖱️ MATCH/CHANGE button clicked! Index:', index);
        showManualMatchModal(index);
      };
      btnContainer.appendChild(manualMatchBtn);

      // ADD NEW button (always visible)
      const addNewBtn = document.createElement('button');
      addNewBtn.textContent = item.flaggedAsNew ? '✓ NEW' : 'ADD NEW';
      addNewBtn.style.cssText = item.flaggedAsNew
        ? 'background: #212121; color: white; border: 2px solid #212121; padding: 6px 12px; border-radius: 0; cursor: pointer; font-size: 10px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase;'
        : 'background: white; color: #212121; border: 2px solid #212121; padding: 6px 12px; border-radius: 0; cursor: pointer; font-size: 10px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase;';
      addNewBtn.onclick = function() {
        item.flaggedAsNew = !item.flaggedAsNew;
        if (item.flaggedAsNew) {
          item.matchedInventoryId = null; // Clear any existing match
          item.skipped = false; // Clear skipped if flagging as new
        }
        renderExtractedItems();
      };
      btnContainer.appendChild(addNewBtn);

      // SKIP button (always visible)
      const skipBtn = document.createElement('button');
      skipBtn.textContent = item.skipped ? '✓ SKIP' : 'SKIP';
      skipBtn.style.cssText = item.skipped
        ? 'background: var(--gray-700); color: white; border: 2px solid var(--gray-700); padding: 6px 12px; border-radius: 0; cursor: pointer; font-size: 10px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase;'
        : 'background: var(--gray-300); color: var(--gray-700); border: 2px solid var(--gray-400); padding: 6px 12px; border-radius: 0; cursor: pointer; font-size: 10px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase;';
      skipBtn.onclick = function() {
        item.skipped = !item.skipped;
        if (item.skipped) {
          item.matchedInventoryId = null; // Clear any existing match
          item.flaggedAsNew = false; // Clear flagged as new
        }
        renderExtractedItems();
      };
      btnContainer.appendChild(skipBtn);

      // Always append buttons (no conditional check)
      matchRow.appendChild(btnContainer);

      card.appendChild(matchRow);

      // Editable price input (optional for orders)
      const priceRow = document.createElement('div');
      priceRow.style.cssText = 'display: flex; align-items: center; gap: 8px; margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--gray-200);';

      const priceLabel = document.createElement('span');
      priceLabel.textContent = orderingSystemState.invoiceType === 'order' ? 'PRICE (per case - optional):' : 'PRICE:';
      priceLabel.style.cssText = 'font-size: 11px; font-weight: 700; color: var(--gray-600); letter-spacing: 0.5px;';
      priceRow.appendChild(priceLabel);

      const priceInputContainer = document.createElement('div');
      priceInputContainer.style.cssText = 'display: flex; align-items: center;';

      const dollarSign = document.createElement('span');
      dollarSign.textContent = '$';
      dollarSign.style.cssText = 'font-size: 13px; font-weight: 700; color: var(--gray-700); margin-right: 4px;';
      priceInputContainer.appendChild(dollarSign);

      const priceInput = document.createElement('input');
      priceInput.type = 'number';
      priceInput.min = '0';
      priceInput.step = '0.01';
      priceInput.placeholder = '0.00';
      priceInput.value = item.detectedPrice ? item.detectedPrice.toFixed(2) : '';
      priceInput.style.cssText = 'width: 80px; padding: 6px 8px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 13px; font-weight: 600; text-align: right; background: white;';
      priceInput.onchange = function() {
        item.detectedPrice = parseFloat(this.value) || null;
        console.log('✏️ Updated price for', item.detectedName, '→', item.detectedPrice);
      };
      priceInputContainer.appendChild(priceInput);

      priceRow.appendChild(priceInputContainer);
      card.appendChild(priceRow);

      container.appendChild(card);
    });

    // Add vendor selector if type is 'order' (for vendor detection from items)
    if (orderingSystemState.invoiceType === 'order') {
      // Show detected vendor from items
      const vendorSection = document.createElement('div');
      vendorSection.style.cssText = 'margin-top: 24px; padding: 16px; background: white; border: 2px solid var(--gray-300);';

      const vendorLabel = document.createElement('label');
      vendorLabel.textContent = 'VENDOR (Auto-detected from items):';
      vendorLabel.style.cssText = 'display: block; color: var(--gray-700); font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;';
      vendorSection.appendChild(vendorLabel);

      const vendorSelect = document.createElement('select');
      vendorSelect.id = 'orderVendorSelect';
      vendorSelect.style.cssText = 'width: 100%; padding: 10px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 13px; background: white;';

      // Get unique vendors from matched items
      const matchedVendors = [...new Set(
        orderingSystemState.extractedInvoiceItems
          .filter(item => item.matchedVendor)
          .map(item => item.matchedVendor)
      )];

      // If only one vendor detected, auto-select it
      if (matchedVendors.length === 1) {
        const option = document.createElement('option');
        option.value = matchedVendors[0];
        option.textContent = matchedVendors[0];
        option.selected = true;
        vendorSelect.appendChild(option);
      } else {
        // Multiple vendors or none - show dropdown
        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = matchedVendors.length === 0 ? 'No vendor detected - enter manually' : 'Select vendor...';
        vendorSelect.appendChild(defaultOption);

        const vendors = [...new Set(orderingSystemState.items.map(item => item.vendor).filter(v => v))];
        vendors.sort();

        vendors.forEach(vendor => {
          const option = document.createElement('option');
          option.value = vendor;
          option.textContent = vendor;
          if (matchedVendors.includes(vendor)) {
            option.textContent += ' ✓';
          }
          vendorSelect.appendChild(option);
        });
      }

      vendorSection.appendChild(vendorSelect);
      container.appendChild(vendorSection);
    }

    // Add action button at the bottom
    const actionButton = document.createElement('button');
    actionButton.className = 'submit-btn';
    actionButton.style.cssText = 'width: 100%; padding: 14px; background: var(--gray-100); color: var(--gray-900); border: 2px solid var(--gray-300); border-radius: 0; font-size: 12px; font-weight: 700; letter-spacing: 1.2px; text-transform: uppercase; cursor: pointer; margin-top: 20px;';

    if (orderingSystemState.invoiceType === 'order') {
      actionButton.textContent = 'SAVE ORDER';
      actionButton.onclick = savePendingOrder;
    } else {
      actionButton.textContent = 'CHECK IN ALL ITEMS';
      actionButton.onclick = checkInInvoiceItems;
    }

    container.appendChild(actionButton);
  }

  /**
   * Show manual matching modal using DOM manipulation (Option 1 - safest)
   * Avoids template literals that caused previous crash
   */
  function showManualMatchModal(itemIndex) {
    console.log('🔍 showManualMatchModal called with itemIndex:', itemIndex);
    const item = orderingSystemState.extractedInvoiceItems[itemIndex];
    console.log('📦 Extracted item:', item);
    if (!item) {
      console.error('❌ No item found at index:', itemIndex);
      return;
    }

    // Create modal overlay
    const overlay = document.createElement('div');
    overlay.id = 'manualMatchModal';
    overlay.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 10000;';

    // Create modal content container
    const modal = document.createElement('div');
    modal.style.cssText = 'background: var(--white); border-radius: 0; padding: 20px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; border: 2px solid var(--gray-400);';

    // Header
    const header = document.createElement('h3');
    header.textContent = 'MANUAL ITEM MATCHING';
    header.style.cssText = 'margin: 0 0 16px 0; font-size: 14px; color: var(--gray-900); font-weight: 700; text-transform: uppercase; letter-spacing: 1px;';
    modal.appendChild(header);

    // Detected item info
    const detectedInfo = document.createElement('div');
    detectedInfo.style.cssText = 'background: var(--gray-100); padding: 12px; border-radius: 0; margin-bottom: 16px; border: 1px solid var(--gray-300);';

    const detectedLabel = document.createElement('div');
    detectedLabel.textContent = 'DETECTED ITEM:';
    detectedLabel.style.cssText = 'font-size: 10px; color: var(--gray-500); margin-bottom: 4px; font-weight: 700; letter-spacing: 0.5px;';
    detectedInfo.appendChild(detectedLabel);

    const detectedName = document.createElement('div');
    detectedName.textContent = item.detectedName;
    detectedName.style.cssText = 'font-size: 14px; font-weight: 700; color: var(--gray-900); text-transform: uppercase; letter-spacing: 0.5px;';
    detectedInfo.appendChild(detectedName);

    modal.appendChild(detectedInfo);

    // Search box
    const searchLabel = document.createElement('label');
    searchLabel.textContent = 'SEARCH INVENTORY:';
    searchLabel.style.cssText = 'display: block; font-size: 11px; margin-bottom: 8px; color: var(--gray-700); font-weight: 700; letter-spacing: 0.5px;';
    modal.appendChild(searchLabel);

    const searchInput = document.createElement('input');
    searchInput.type = 'text';
    searchInput.placeholder = 'Type to search...';
    searchInput.style.cssText = 'width: 100%; padding: 10px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 13px; margin-bottom: 16px; box-sizing: border-box;';
    modal.appendChild(searchInput);

    // Items list container
    const itemsList = document.createElement('div');
    itemsList.id = 'manualMatchItemsList';
    itemsList.style.cssText = 'max-height: 300px; overflow-y: auto; border: 2px solid var(--gray-300); border-radius: 0; margin-bottom: 16px;';
    modal.appendChild(itemsList);

    // Function to render inventory items
    function renderInventoryItems(filter = '') {
      itemsList.innerHTML = '';

      const filterLower = filter.toLowerCase();
      const filteredItems = orderingSystemState.items.filter(invItem =>
        invItem.itemName.toLowerCase().includes(filterLower) ||
        invItem.vendor.toLowerCase().includes(filterLower)
      );

      if (filteredItems.length === 0) {
        const noResults = document.createElement('div');
        noResults.textContent = 'No items found';
        noResults.style.cssText = 'padding: 20px; text-align: center; color: #666;';
        itemsList.appendChild(noResults);
        return;
      }

      // Group by vendor
      const byVendor = {};
      filteredItems.forEach(invItem => {
        if (!byVendor[invItem.vendor]) byVendor[invItem.vendor] = [];
        byVendor[invItem.vendor].push(invItem);
      });

      // Render each vendor group
      Object.keys(byVendor).sort().forEach(vendor => {
        const vendorHeader = document.createElement('div');
        vendorHeader.textContent = vendor;
        vendorHeader.style.cssText = 'background: var(--gray-300); padding: 8px 12px; font-weight: 700; font-size: 11px; color: var(--gray-900); position: sticky; top: 0; text-transform: uppercase; letter-spacing: 1px;';
        itemsList.appendChild(vendorHeader);

        byVendor[vendor].forEach(invItem => {
          const itemRow = document.createElement('div');
          itemRow.style.cssText = 'padding: 10px 12px; border-bottom: 1px solid var(--gray-300); cursor: pointer; display: flex; justify-content: space-between; align-items: center; background: var(--white);';
          itemRow.onmouseover = function() { this.style.background = 'var(--gray-100)'; };
          itemRow.onmouseout = function() { this.style.background = 'var(--white)'; };
          itemRow.onclick = function() {
            // Update the matched item
            orderingSystemState.extractedInvoiceItems[itemIndex].matchedInventoryId = invItem.id;
            orderingSystemState.extractedInvoiceItems[itemIndex].matchedItemName = invItem.itemName;
            orderingSystemState.extractedInvoiceItems[itemIndex].matchConfidence = 1.0; // Manual match = 100%

            // Close modal and re-render
            document.body.removeChild(overlay);
            renderExtractedItems();
            showMessage('Item matched successfully!', 'success');
          };

          const itemName = document.createElement('div');
          itemName.textContent = invItem.itemName;
          itemName.style.cssText = 'font-size: 13px; color: var(--gray-900); font-weight: 600;';
          itemRow.appendChild(itemName);

          const itemUnit = document.createElement('div');
          itemUnit.textContent = invItem.unit;
          itemUnit.style.cssText = 'font-size: 10px; color: var(--gray-700); padding: 2px 6px; background: var(--gray-100); border-radius: 0; font-weight: 700; letter-spacing: 0.5px;';
          itemRow.appendChild(itemUnit);

          itemsList.appendChild(itemRow);
        });
      });
    }

    // Initial render
    renderInventoryItems();

    // Search handler
    searchInput.addEventListener('input', function() {
      renderInventoryItems(this.value);
    });

    // Button row
    const buttonRow = document.createElement('div');
    buttonRow.style.cssText = 'display: flex; gap: 8px;';

    const cancelBtn = document.createElement('button');
    cancelBtn.textContent = 'CANCEL';
    cancelBtn.style.cssText = 'flex: 1; padding: 12px; background: var(--gray-100); color: var(--gray-900); border: 2px solid var(--gray-300); border-radius: 0; font-size: 11px; font-weight: 700; letter-spacing: 1px; cursor: pointer;';
    cancelBtn.onclick = function() {
      document.body.removeChild(overlay);
    };
    buttonRow.appendChild(cancelBtn);

    const createNewBtn = document.createElement('button');
    createNewBtn.textContent = 'CREATE NEW';
    createNewBtn.style.cssText = 'flex: 1; padding: 12px; background: var(--gray-700); color: var(--white); border: 2px solid var(--gray-700); border-radius: 0; font-size: 11px; font-weight: 700; letter-spacing: 1px; cursor: pointer;';
    createNewBtn.onclick = async function() {
      // Prompt for new item details
      const newItemName = prompt('Enter item name:', item.detectedName || '');
      if (!newItemName || newItemName.trim() === '') {
        showMessage('Item name is required', 'error');
        return;
      }

      const vendorOptions = ['Greenleaf', 'Performance', 'Mani Imports', 'Eatopia', 'Restaurant Depot', 'Alsco', 'SRC Pumping', 'Southern Glazer\'s', 'Breakthru Beverage', 'PREP'];
      const vendorChoice = prompt('Enter vendor name (or choose from: ' + vendorOptions.join(', ') + '):', '');
      if (!vendorChoice || vendorChoice.trim() === '') {
        showMessage('Vendor is required', 'error');
        return;
      }

      const unit = prompt('Enter unit (e.g., CS, EA, LB):', '');
      if (!unit || unit.trim() === '') {
        showMessage('Unit is required', 'error');
        return;
      }

      const parLevel = prompt('Enter par level (default 0):', '0');
      const isPrep = confirm('Is this a PREP item? (OK = Yes, Cancel = No)');
      const itemType = isPrep ? 'prep' : 'ingredient';

      // Create the item
      document.body.removeChild(overlay);
      showLoading('Creating New Item', 'Saving to database...');

      try {
        const insertData = {
          item_name: newItemName.trim(),
          vendor: vendorChoice.trim(),
          unit: unit.trim().toUpperCase(),
          par_level: parseFloat(parLevel) || 0,
          current_stock: 0,
          item_type: itemType,
          created_date: new Date().toISOString()
        };

        // Add prep-specific fields if PREP item
        if (isPrep) {
          const batchLifespan = prompt('Enter batch lifespan in hours (default 48):', '48');
          insertData.batch_lifespan_hours = parseInt(batchLifespan) || 48;
        }

        const { data, error } = await supabase
          .from('inventory_items')
          .insert([insertData])
          .select();

        if (error) throw error;

        // Add to local state
        orderingSystemState.items.push({
          id: data[0].id,
          itemName: data[0].item_name,
          vendor: data[0].vendor,
          parLevel: data[0].par_level,
          currentStock: data[0].current_stock,
          unit: data[0].unit,
          itemType: data[0].item_type,
          batchLifespan: data[0].batch_lifespan_hours,
          lastCountedDate: null
        });

        // Auto-match the newly created item
        orderingSystemState.extractedInvoiceItems[itemIndex].matchedInventoryId = data[0].id;
        orderingSystemState.extractedInvoiceItems[itemIndex].matchedItemName = data[0].item_name;
        orderingSystemState.extractedInvoiceItems[itemIndex].matchConfidence = 1.0;

        hideLoading();
        renderExtractedItems();
        showMessage('New item created and matched!', 'success');
      } catch (error) {
        hideLoading();
        showMessage('Error creating item: ' + error.message, 'error');
      }
    };
    buttonRow.appendChild(createNewBtn);

    const skipBtn = document.createElement('button');
    skipBtn.textContent = 'SKIP';
    skipBtn.style.cssText = 'flex: 1; padding: 12px; background: var(--gray-100); color: var(--gray-900); border: 2px solid var(--gray-300); border-radius: 0; font-size: 11px; font-weight: 700; letter-spacing: 1px; cursor: pointer;';
    skipBtn.onclick = function() {
      // Mark as skipped
      orderingSystemState.extractedInvoiceItems[itemIndex].matchedInventoryId = null;
      orderingSystemState.extractedInvoiceItems[itemIndex].matchConfidence = 0;
      document.body.removeChild(overlay);
      renderExtractedItems();
      showMessage('Item skipped', 'info');
    };
    buttonRow.appendChild(skipBtn);

    modal.appendChild(buttonRow);

    // Assemble modal
    overlay.appendChild(modal);
    console.log('✅ Modal created, appending to body...');
    console.log('📍 Overlay element:', overlay);
    console.log('📍 Modal element:', modal);
    document.body.appendChild(overlay);
    console.log('✅ Modal appended to body successfully!');
    console.log('📊 document.body children count:', document.body.children.length);

    // Check if modal is actually in DOM
    const modalCheck = document.getElementById('manualMatchModal');
    console.log('🔍 Modal found in DOM:', modalCheck ? 'YES' : 'NO');
    if (modalCheck) {
      console.log('📐 Modal computed style:', window.getComputedStyle(modalCheck).display);
      console.log('📐 Modal z-index:', window.getComputedStyle(modalCheck).zIndex);
    }

    // Focus search input
    searchInput.focus();
  }

  /**
   * Save order as pending order for future delivery check-in
   */
  async function savePendingOrder() {
    console.log('savePendingOrder called');
    const items = orderingSystemState.extractedInvoiceItems;

    if (items.length === 0) {
      showMessage('No items to save', 'warning');
      return;
    }

    // Get vendor from auto-detected dropdown
    const vendorSelect = document.getElementById('orderVendorSelect');

    if (!vendorSelect || !vendorSelect.value) {
      showMessage('Please select a vendor', 'warning');
      return;
    }

    const vendor = vendorSelect.value;

    // Get delivery date from metadata collected BEFORE upload
    const metadata = orderingSystemState.pendingOrderMetadata || {};
    const deliveryDate = metadata.expectedDeliveryDate;

    if (!deliveryDate) {
      showMessage('❌ Expected delivery date is missing. Please go back and fill in the required fields.', 'error');
      return;
    }

    // Filter matched items (exclude skipped and flagged as new)
    const matchedItems = items.filter(item => item.matchedInventoryId && !item.flaggedAsNew && !item.skipped);

    // Get items flagged as NEW to create inventory items
    const newItems = items.filter(item => item.flaggedAsNew && !item.skipped);

    console.log('Matched items to save:', matchedItems.length);
    console.log('New items to create:', newItems.length);

    if (matchedItems.length === 0 && newItems.length === 0) {
      showMessage('Please match items or flag as new', 'warning');
      return;
    }

    // ✅ CREATE NEW INVENTORY ITEMS IMMEDIATELY
    if (newItems.length > 0) {
      showLoading('Creating New Items', `Adding ${newItems.length} new inventory items...`);

      try {
        for (const item of newItems) {
          const { data: newInvItem, error: createError } = await supabase
            .from('inventory_items')
            .insert({
              item_name: item.detectedName,
              vendor: vendor,
              unit: 'EA', // Default unit
              par_level: 0,
              current_stock: 0,
              item_type: 'ingredient',
              created_date: new Date().toISOString()
            })
            .select()
            .single();

          if (createError) {
            console.error('Failed to create item:', item.detectedName, createError);
            continue;
          }

          console.log('✅ Created new inventory item:', newInvItem.item_name, 'ID:', newInvItem.id);

          // Add to local state
          orderingSystemState.items.push({
            id: newInvItem.id,
            itemName: newInvItem.item_name,
            vendor: newInvItem.vendor,
            parLevel: newInvItem.par_level,
            currentStock: newInvItem.current_stock,
            unit: newInvItem.unit,
            itemType: newInvItem.item_type,
            lastCountedDate: null
          });

          // Convert to matched item for order
          item.matchedInventoryId = newInvItem.id;
          item.matchedItemName = newInvItem.item_name;
          item.matchConfidence = 1.0;
          matchedItems.push(item);
        }

        console.log('✅ Created', newItems.length, 'new inventory items!');
      } catch (error) {
        console.error('Error creating new items:', error);
        showMessage('Some items failed to create: ' + error.message, 'warning');
      }
    }

    if (matchedItems.length === 0) {
      hideLoading();
      showMessage('No items were successfully matched or created', 'warning');
      return;
    }

    showLoading('Saving Order', 'Creating pending order...');

    try {
      // Use metadata from form if available, otherwise fall back to existing fields
      const metadata = orderingSystemState.pendingOrderMetadata || {};
      const createdBy = metadata.createdBy || 'System';
      const notes = metadata.notes || '';  // Empty string if no notes, don't show fallback
      const expectedDate = metadata.expectedDeliveryDate || deliveryDate;

      // Create pending order record
      const { data: orderData, error: orderError } = await supabase
        .from('pending_orders')
        .insert({
          vendor: vendor,
          order_date: getPacificDate(),
          expected_delivery_date: expectedDate,
          status: 'pending',
          created_by: createdBy,
          notes: notes,
          total_items: matchedItems.length
        })
        .select()
        .single();

      if (orderError) throw orderError;

      const orderId = orderData.id;
      console.log('Created pending order:', orderId);

      // Create order items
      const orderItems = matchedItems.map(item => ({
        order_id: orderId,
        inventory_item_id: item.matchedInventoryId,
        quantity_ordered: item.detectedQuantity || 0,
        unit: orderingSystemState.items.find(i => i.id === item.matchedInventoryId)?.unit || 'EA',
        item_name: item.matchedItemName,
        vendor: vendor
      }));

      const { error: itemsError } = await supabase
        .from('pending_order_items')
        .insert(orderItems);

      if (itemsError) throw itemsError;

      // ✅ LEARNING: Save matches to invoice_items immediately for future auto-matching
      console.log('💾 Saving matches to invoice_items for learning...');

      // Create a temporary invoice record for learning purposes
      const { data: invoiceData, error: invoiceError } = await supabase
        .from('invoices')
        .insert({
          invoice_date: getPacificDate(),
          vendor_name: vendor,
          invoice_type: 'order', // Added by migration
          entered_by: 'System',
          processed: true,
          notes: `Pending order #${orderId} - saved for learning`
        })
        .select()
        .single();

      if (!invoiceError && invoiceData) {
        // Save each match for learning
        const learningItems = matchedItems.map(item => {
          const inventoryItem = orderingSystemState.items.find(i => i.id === item.matchedInventoryId);
          const quantity = item.detectedQuantity || 0;
          const unitPrice = item.detectedPrice || 0;
          const totalPrice = quantity * unitPrice;

          return {
            invoice_id: invoiceData.id,
            inventory_item_id: item.matchedInventoryId,

            // Required fields from invoice_items schema
            item_description: item.detectedName,
            quantity: quantity,
            unit: inventoryItem?.unit || 'EA',
            unit_price: unitPrice,
            total_price: totalPrice,
            matched: true,

            // Learning/tracking fields (added via migrations)
            detected_item_name: item.detectedName,
            detected_quantity: quantity,
            detected_price: unitPrice,
            match_confidence: item.matchConfidence,
            matched_at: new Date().toISOString(),
            checked_in: true,
            checked_in_at: new Date().toISOString()
          };
        });

        const { error: learningError } = await supabase
          .from('invoice_items')
          .insert(learningItems);

        if (learningError) {
          console.warn('Failed to save learning data:', learningError);
        } else {
          console.log('✅ Saved', learningItems.length, 'matches for learning!');
        }
      }

      hideLoading();
      showMessage(`✅ Order saved! ${matchedItems.length} items ordered from ${vendor}. Matches saved for future auto-detection!`, 'success');

      // Clear state
      orderingSystemState.extractedInvoiceItems = [];
      orderingSystemState.currentInvoiceImage = null;

      // Clear the extracted items display
      const container = document.getElementById('extractedInvoiceItems');
      if (container) {
        container.innerHTML = '';
      }

      // Clear the image preview
      const preview = document.getElementById('invoiceImagePreview');
      if (preview) {
        preview.innerHTML = '';
      }

      console.log('✅ Pending order saved successfully');

    } catch (error) {
      hideLoading();
      console.error('Error saving pending order:', error);
      showMessage('Failed to save order: ' + error.message, 'error');
    }
  }

  /**
   * Show reconciliation view comparing ordered vs received items
   */
  async function showReconciliationView(pendingOrderId, receivedItems) {
    console.log('Loading pending order for reconciliation...', pendingOrderId);
    showLoading('Loading Order', 'Fetching order details...');

    try {
      // Fetch pending order with items
      const { data: orderData, error: orderError } = await supabase
        .from('pending_orders')
        .select(`
          *,
          pending_order_items (
            id,
            inventory_item_id,
            quantity_ordered,
            unit,
            item_name,
            vendor
          )
        `)
        .eq('id', pendingOrderId)
        .single();

      if (orderError) throw orderError;
      if (!orderData) throw new Error('Order not found');

      hideLoading();

      console.log('Loaded pending order:', orderData);

      // Match received items to ordered items
      const reconciliationData = orderData.pending_order_items.map(orderedItem => {
        // Find matching received item
        const receivedItem = receivedItems.find(r => r.matchedInventoryId === orderedItem.inventory_item_id);

        return {
          orderItemId: orderedItem.id,
          inventoryItemId: orderedItem.inventory_item_id,
          itemName: orderedItem.item_name,
          unit: orderedItem.unit,
          quantityOrdered: orderedItem.quantity_ordered,
          quantityReceived: receivedItem ? receivedItem.detectedQuantity : 0,
          variance: receivedItem ? (receivedItem.detectedQuantity - orderedItem.quantity_ordered) : -orderedItem.quantity_ordered,
          hasReceived: !!receivedItem,
          invoicePrice: receivedItem && receivedItem.detectedPrice != null ? Number(receivedItem.detectedPrice) : null
        };
      });

      const reconciliationItemIds = reconciliationData
        .map(item => item.inventoryItemId)
        .filter(id => id !== null && id !== undefined);
      if (reconciliationItemIds.length) {
        await ensurePriceSnapshotsForItems(reconciliationItemIds);
      }

      // Create modal
      const overlay = document.createElement('div');
      overlay.id = 'reconciliationModal';
      overlay.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 10000; padding: 0; overflow-y: auto;';

      const modal = document.createElement('div');
      modal.style.cssText = 'background: white; max-width: 800px; width: 100%; margin: 20px auto; border: 2px solid var(--gray-400);';

      // Responsive: full screen on mobile
      if (window.innerWidth <= 600) {
        modal.style.maxWidth = '100%';
        modal.style.margin = '0';
        modal.style.minHeight = '100vh';
      }

      // Header (sticky)
      const header = document.createElement('div');
      header.style.cssText = 'background: #212121; color: white; padding: 16px 20px; position: sticky; top: 0; z-index: 10;';

      const title = document.createElement('h3');
      title.textContent = `RECONCILE ORDER - ${orderData.vendor}`;
      title.style.cssText = 'margin: 0 0 4px 0; font-size: 16px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;';
      header.appendChild(title);

      const subtitle = document.createElement('p');
      const expectedReconciliationDate = parsePacificDate(orderData.expected_delivery_date);
      subtitle.textContent = `Expected: ${
        expectedReconciliationDate
          ? formatPacificDateDisplay(expectedReconciliationDate, { month: 'short', day: 'numeric', year: 'numeric', weekday: 'long' })
          : 'Unknown'
      } | ${reconciliationData.length} item(s)`;
      subtitle.style.cssText = 'margin: 0; font-size: 11px; color: #b0b0b0;';
      header.appendChild(subtitle);

      modal.appendChild(header);

      // Content (scrollable)
      const content = document.createElement('div');
      content.style.cssText = 'padding: 20px; max-height: calc(100vh - 200px); overflow-y: auto;';

      // Instructions
      const instructions = document.createElement('p');
      instructions.textContent = 'Review the quantities below. Update received amounts if needed, then confirm to complete check-in.';
      instructions.style.cssText = 'color: var(--gray-600); font-size: 12px; margin-bottom: 20px; padding: 12px; background: #f3f4f6; border-left: 3px solid var(--gray-400);';
      content.appendChild(instructions);

      // Table
      const table = document.createElement('div');
      table.style.cssText = 'border: 2px solid var(--gray-300);';

      // Table header
      const headerRow = document.createElement('div');
      headerRow.style.cssText = 'display: grid; grid-template-columns: 2fr 1fr 1fr 1fr 1.6fr; gap: 8px; padding: 10px; background: var(--gray-100); border-bottom: 2px solid var(--gray-300); font-weight: 700; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--gray-700);';

      ['ITEM', 'ORDERED', 'RECEIVED', 'VARIANCE', 'PRICE'].forEach(label => {
        const cell = document.createElement('div');
        cell.textContent = label;
        cell.style.textAlign = label === 'ITEM' ? 'left' : 'center';
        headerRow.appendChild(cell);
      });
      table.appendChild(headerRow);

      // Table rows
      reconciliationData.forEach((item, index) => {
        const row = document.createElement('div');
        row.style.cssText = `display: grid; grid-template-columns: 2fr 1fr 1fr 1fr 1.6fr; gap: 8px; padding: 12px 10px; background: ${index % 2 === 0 ? 'white' : '#f9fafb'}; border-bottom: 1px solid var(--gray-200); align-items: center;`;

        // Item name
        const nameCell = document.createElement('div');
        nameCell.textContent = item.itemName;
        nameCell.style.cssText = 'font-size: 13px; font-weight: 600; color: var(--gray-900);';
        row.appendChild(nameCell);

        // Ordered quantity
        const orderedCell = document.createElement('div');
        orderedCell.textContent = `${item.quantityOrdered} ${item.unit}`;
        orderedCell.style.cssText = 'text-align: center; font-size: 13px; color: var(--gray-700);';
        row.appendChild(orderedCell);

        // Received quantity (editable)
        const receivedCell = document.createElement('div');
        receivedCell.style.cssText = 'text-align: center;';

        const receivedInput = document.createElement('input');
        receivedInput.type = 'number';
        receivedInput.value = item.quantityReceived;
        receivedInput.step = '0.25';
        receivedInput.min = '0';
        receivedInput.id = `received-${item.orderItemId}`;
        receivedInput.style.cssText = 'width: 70px; padding: 6px; border: 2px solid var(--gray-300); border-radius: 0; text-align: center; font-size: 13px; font-weight: 600;';
        receivedInput.onchange = () => {
          // Recalculate variance
          const newReceived = parseFloat(receivedInput.value) || 0;
          const newVariance = newReceived - item.quantityOrdered;
          varianceCell.textContent = newVariance >= 0 ? `+${newVariance.toFixed(2)}` : newVariance.toFixed(2);

          // Update color
          if (newVariance < 0) {
            varianceCell.style.color = '#ef4444'; // Red
          } else if (newVariance > 0) {
            varianceCell.style.color = '#10b981'; // Green
          } else {
            varianceCell.style.color = 'var(--gray-600)'; // Gray
          }

          // Update item data
          item.quantityReceived = newReceived;
          item.variance = newVariance;
        };
        receivedCell.appendChild(receivedInput);
        row.appendChild(receivedCell);

        // Variance
        const varianceCell = document.createElement('div');
        varianceCell.textContent = item.variance >= 0 ? `+${item.variance.toFixed(2)}` : item.variance.toFixed(2);
        varianceCell.style.cssText = 'text-align: center; font-size: 13px; font-weight: 700;';
        if (item.variance < 0) {
          varianceCell.style.color = '#ef4444'; // Red - short
        } else if (item.variance > 0) {
          varianceCell.style.color = '#10b981'; // Green - over
        } else {
          varianceCell.style.color = 'var(--gray-600)'; // Gray - exact
        }
        row.appendChild(varianceCell);

        const priceCell = document.createElement('div');
        priceCell.style.cssText = 'text-align: center; font-size: 11px;';
        priceCell.innerHTML = item.inventoryItemId ? renderIncomingPriceHtml(item.inventoryItemId, item.invoicePrice, orderData.expected_delivery_date) : '<span style="color: var(--gray-500); font-size: 11px;">N/A</span>';
        row.appendChild(priceCell);

        table.appendChild(row);
      });

      content.appendChild(table);
      modal.appendChild(content);

      // Footer buttons (sticky)
      const footer = document.createElement('div');
      footer.style.cssText = 'padding: 16px 20px; background: white; border-top: 2px solid var(--gray-300); display: flex; gap: 12px; position: sticky; bottom: 0;';

      const cancelBtn = document.createElement('button');
      cancelBtn.textContent = 'CANCEL';
      cancelBtn.style.cssText = 'flex: 1; padding: 14px; background: white; color: var(--gray-700); border: 2px solid var(--gray-300); border-radius: 0; font-size: 12px; font-weight: 700; letter-spacing: 1px; cursor: pointer;';
      cancelBtn.onclick = () => document.body.removeChild(overlay);
      footer.appendChild(cancelBtn);

      const confirmBtn = document.createElement('button');
      confirmBtn.textContent = 'CONFIRM RECONCILIATION';
      confirmBtn.style.cssText = 'flex: 2; padding: 14px; background: #212121; color: white; border: 2px solid #212121; border-radius: 0; font-size: 12px; font-weight: 700; letter-spacing: 1px; cursor: pointer;';
      confirmBtn.onclick = async () => {
        await completeReconciliation(pendingOrderId, orderData, reconciliationData, overlay);
      };
      footer.appendChild(confirmBtn);

      modal.appendChild(footer);
      overlay.appendChild(modal);
      document.body.appendChild(overlay);

    } catch (error) {
      hideLoading();
      console.error('Error loading order for reconciliation:', error);
      showMessage('Failed to load order: ' + error.message, 'error');
    }
  }

  /**
   * Complete reconciliation and update database
   */
  async function completeReconciliation(pendingOrderId, orderData, reconciliationData, modalOverlay) {
    showLoading('Reconciling Order', 'Updating inventory and order status...');

    try {
      // Update each order item with received quantities
      for (const item of reconciliationData) {
        const { error: updateError } = await supabase
          .from('pending_order_items')
          .update({
            quantity_received: item.quantityReceived,
            variance: item.variance
          })
          .eq('id', item.orderItemId);

        if (updateError) throw updateError;

        // Update inventory stock with received amount
        if (item.quantityReceived > 0) {
          const { data: currentItem, error: fetchError } = await supabase
            .from('inventory_items')
            .select('current_stock')
            .eq('id', item.inventoryItemId)
            .single();

          if (fetchError) throw fetchError;

          const newStock = (parseFloat(currentItem.current_stock) || 0) + item.quantityReceived;

          const { error: stockError } = await supabase
            .from('inventory_items')
            .update({
              current_stock: newStock,
              last_counted_date: getPacificDate(),
              last_invoice_qty: item.quantityReceived,
              last_invoice_date: new Date().toISOString()
            })
            .eq('id', item.inventoryItemId);

          if (stockError) throw stockError;
        }
      }

      // Determine order status (delivered or partial)
      const allReceived = reconciliationData.every(item => item.variance === 0);
      const noneReceived = reconciliationData.every(item => item.quantityReceived === 0);
      const newStatus = noneReceived ? 'pending' : (allReceived ? 'delivered' : 'partial');

      // Update pending order status
      const { error: orderError } = await supabase
        .from('pending_orders')
        .update({
          status: newStatus,
          reconciled: true,
          reconciled_at: new Date().toISOString(),
          reconciled_by: 'System'
        })
        .eq('id', pendingOrderId);

      if (orderError) throw orderError;

      // Create invoice record linked to this order
      const { data: invoiceData, error: invoiceError } = await supabase
        .from('invoices')
        .insert({
          vendor: orderData.vendor,
          invoice_date: getPacificDate(),
          invoice_type: 'invoice',
          pending_order_id: pendingOrderId,
          total_items: reconciliationData.filter(i => i.quantityReceived > 0).length,
          processed_by: 'System',
          notes: 'Reconciled against pending order'
        })
        .select()
        .single();

      if (invoiceError) throw invoiceError;

      const reconciledItemIds = reconciliationData
        .map(item => item.inventoryItemId)
        .filter(id => id !== null && id !== undefined);

      const priceCache = getPriceCache();
      reconciledItemIds.forEach(id => priceCache.delete(id));
      if (reconciledItemIds.length) {
        await ensurePriceSnapshotsForItems(reconciledItemIds);
      }

      hideLoading();

      // Close modal
      document.body.removeChild(modalOverlay);

      // Clear state
      orderingSystemState.extractedInvoiceItems = [];
      orderingSystemState.currentInvoiceImage = null;
      orderingSystemState.selectedPendingOrderId = null;

      // Clear displays
      const container = document.getElementById('extractedInvoiceItems');
      if (container) container.innerHTML = '';

      const preview = document.getElementById('invoiceImagePreview');
      if (preview) preview.innerHTML = '';

      // Reload inventory
      await loadInventoryData();
      calculateUpcomingOrders();
      await refreshUpcomingOrdersUI();

      showMessage(`✅ Order reconciled! Status: ${newStatus.toUpperCase()}`, 'success');

      console.log('✅ Reconciliation completed successfully');

    } catch (error) {
      hideLoading();
      console.error('Error completing reconciliation:', error);
      showMessage('Failed to complete reconciliation: ' + error.message, 'error');
    }
  }

  /**
   * Check in invoice items and update inventory
   * Handles both invoice reconciliation and order receiving flows
   */
  async function checkInInvoiceItems() {
    console.log('checkInInvoiceItems called');
    const items = orderingSystemState.extractedInvoiceItems;

    if (items.length === 0) {
      showMessage('No items to check in', 'warning');
      return;
    }

    // Split items: matched (auto + manual) vs flagged as new (EXCLUDING skipped items)
    const matchedItems = items.filter(item => item.matchedInventoryId && !item.flaggedAsNew && !item.skipped);
    const newItems = items.filter(item => item.flaggedAsNew && !item.skipped);
    const skippedItems = items.filter(item => item.skipped);

    console.log('Matched items (to check in):', matchedItems.length);
    console.log('Flagged as new (to add):', newItems.length);
    console.log('Skipped items (ignored):', skippedItems.length);

    if (matchedItems.length === 0 && newItems.length === 0) {
      showMessage('Please match items, flag as new, or skip unwanted items', 'warning');
      return;
    }

    if (matchedItems.length === 0) {
      // No matched items, just show add new items modal
      showAddNewItemsModal(newItems);
      return;
    }

    // Check if reconciliation against pending order is needed
    if (orderingSystemState.selectedPendingOrderId) {
      console.log('Reconciliation mode: pending order ID', orderingSystemState.selectedPendingOrderId);
      showReconciliationView(orderingSystemState.selectedPendingOrderId, matchedItems);
      return;
    }

    showLoading('Checking In Items', 'Updating inventory...');

    try {
      // Create invoice record
      const { data: invoiceData, error: invoiceError } = await supabase
        .from('invoices')
        .insert({
          invoice_date: getPacificDate(),
          vendor: 'MIXED', // Could be enhanced to detect vendor from items
          invoice_type: orderingSystemState.invoiceType || 'invoice',
          total_items: matchedItems.length,
          processed_by: 'System',
          notes: 'Auto-processed via OCR'
        })
        .select()
        .single();

      if (invoiceError) throw invoiceError;

      const invoiceId = invoiceData.id;

      // Process each matched item
      let successCount = 0;
      let errorCount = 0;

      for (const item of matchedItems) {
        try {
          // LEARNING: Save to invoice_items table - this creates the learning data
          console.log('💾 SAVING LEARNING DATA:', {
            detected_name: item.detectedName,
            inventory_item_id: item.matchedInventoryId,
            confidence: item.matchConfidence
          });

          const quantity = parseFloat(item.detectedQuantity) || 0;
          const unitPrice = parseFloat(item.detectedPrice) || 0;
          const totalPrice = quantity * unitPrice;

          const { error: itemError } = await supabase
            .from('invoice_items')
            .insert({
              invoice_id: invoiceId,
              inventory_item_id: item.matchedInventoryId,

              // Required fields from invoice_items schema
              item_description: item.detectedName,
              quantity: quantity,
              unit: 'case', // Default for PFG items
              unit_price: unitPrice,
              total_price: totalPrice,
              matched: true,

              // Learning/tracking fields
              detected_item_name: item.detectedName,
              detected_quantity: quantity,
              detected_price: unitPrice,
              match_confidence: item.matchConfidence,
              matched_at: new Date().toISOString(),
              checked_in: true,
              checked_in_at: new Date().toISOString()
            });

          if (itemError) {
            console.error('❌ Failed to save learning data:', itemError);
            throw itemError;
          }
          console.log('✅ Learning data saved successfully!');

          // Update inventory stock and PFG tracking data
          // Get current item data
          const { data: currentItem, error: fetchError } = await supabase
            .from('inventory_items')
            .select('current_stock, item_name, last_price, item_number, manufacturer_item_number, gtin, category, brand, manufacturer_name')
            .eq('id', item.matchedInventoryId)
            .single();

          if (fetchError) throw fetchError;

          const newStock = (parseFloat(currentItem.current_stock) || 0) + (parseFloat(item.detectedQuantity) || 0);

          // Prepare update object
          const updateData = {
            current_stock: newStock,
            last_counted_date: new Date().toISOString()
          };

          // Update PFG tracking fields if this item has PFG data and fields are empty
          if (item.pfgData) {
            console.log('📦 PFG data detected for', currentItem.item_name);

            if (item.pfgData.itemNumber && !currentItem.item_number) {
              updateData.item_number = item.pfgData.itemNumber;
              console.log('  → Adding item_number:', item.pfgData.itemNumber);
            }
            if (item.pfgData.manufacturerItemNumber && !currentItem.manufacturer_item_number) {
              updateData.manufacturer_item_number = item.pfgData.manufacturerItemNumber;
            }
            if (item.pfgData.gtin && !currentItem.gtin) {
              updateData.gtin = item.pfgData.gtin;
            }
            if (item.pfgData.category && !currentItem.category) {
              updateData.category = item.pfgData.category;
            }
            if (item.pfgData.brand && !currentItem.brand) {
              updateData.brand = item.pfgData.brand;
            }
            if (item.pfgData.manufacturerName && !currentItem.manufacturer_name) {
              updateData.manufacturer_name = item.pfgData.manufacturerName;
            }

            // Track price changes if price is provided
            if (item.detectedPrice && item.detectedPrice > 0) {
              const oldPrice = parseFloat(currentItem.last_price) || 0;
              const newPrice = parseFloat(item.detectedPrice);

              if (oldPrice !== newPrice && oldPrice > 0) {
                const priceChange = newPrice - oldPrice;
                const priceChangePercent = ((priceChange / oldPrice) * 100).toFixed(2);

                console.log(`  💰 Price change: $${oldPrice} → $${newPrice} (${priceChangePercent > 0 ? '+' : ''}${priceChangePercent}%)`);

                // Save to price_history table
                const { error: priceHistoryError } = await supabase
                  .from('price_history')
                  .insert({
                    inventory_item_id: item.matchedInventoryId,
                    item_number: item.pfgData.itemNumber,
                    old_price: oldPrice,
                    new_price: newPrice,
                    price_change: priceChange,
                    price_change_percent: parseFloat(priceChangePercent),
                    invoice_number: item.pfgData.invoiceNumber,
                    invoice_date: item.pfgData.invoiceDate,
                    vendor: item.pfgData.vendor
                  });

                if (priceHistoryError) {
                  console.error('Failed to save price history:', priceHistoryError);
                } else {
                  console.log('  ✅ Price history saved!');
                }
              }

              // Update last_price regardless
              updateData.last_price = newPrice;
            }
          }

          // Update the inventory item
          const { error: updateError } = await supabase
            .from('inventory_items')
            .update(updateData)
            .eq('id', item.matchedInventoryId);

          if (updateError) throw updateError;

          successCount++;

        } catch (itemError) {
          console.error('Error processing item:', item.detectedName, itemError);
          errorCount++;
        }
      }

      hideLoading();

      // Show success message
      if (errorCount === 0) {
        showMessage('✅ Checked in ' + successCount + ' matched items!', 'success');
      } else {
        showMessage(
          'Checked in ' + successCount + ' items with ' + errorCount + ' errors. Check console for details.',
          'warning'
        );
      }

      // Reload inventory to show updated counts
      await loadInventoryData();

      // Clear the checked-in items
      orderingSystemState.extractedInvoiceItems = [];
      orderingSystemState.currentInvoiceImage = null;

      // Reset UI
      document.getElementById('extractedItemsSection').style.display = 'none';
      document.getElementById('invoicePreviewSection').style.display = 'none';
      document.getElementById('invoicePreviewImage').src = '';
      document.getElementById('invoiceFileInput').value = '';
      document.getElementById('invoiceCameraInput').value = '';

      // If there are flagged new items, auto-create them with PFG data or show modal
      if (newItems.length > 0) {
        // Separate items with PFG data (auto-create) from items without (manual entry)
        const itemsWithPFG = newItems.filter(item => item.pfgData && item.pfgData.itemNumber);
        const itemsWithoutPFG = newItems.filter(item => !item.pfgData || !item.pfgData.itemNumber);

        // Auto-create items with PFG data
        if (itemsWithPFG.length > 0) {
          console.log(`🆕 Auto-creating ${itemsWithPFG.length} new items with PFG data...`);

          showLoading('Creating New Items', `Adding ${itemsWithPFG.length} item(s) to inventory...`);

          setTimeout(async () => {
            try {
              const itemsToCreate = itemsWithPFG.map(item => ({
                item_name: item.detectedName,
                vendor: item.pfgData.vendor || 'PFG',
                unit: item.detectedUnit || 'case',
                par_level: item.detectedQuantity || 1,
                current_stock: item.detectedQuantity || 0,
                last_price: item.detectedPrice || 0,
                item_number: item.pfgData.itemNumber,
                manufacturer_item_number: item.pfgData.manufacturerItemNumber,
                gtin: item.pfgData.gtin,
                category: item.pfgData.category,
                brand: item.pfgData.brand,
                manufacturer_name: item.pfgData.manufacturerName,
                item_type: 'regular',
                last_counted_date: new Date().toISOString()
              }));

              const { data: createdItems, error: createError } = await supabase
                .from('inventory_items')
                .insert(itemsToCreate)
                .select();

              if (createError) throw createError;

              hideLoading();
              showMessage(`✅ Auto-created ${createdItems.length} new item(s) with PFG tracking data!`, 'success');
              console.log('✅ Created items:', createdItems.map(i => i.item_name).join(', '));

              // Reload inventory
              await loadInventoryData();

              // If there are items without PFG data, show modal for manual entry
              if (itemsWithoutPFG.length > 0) {
                setTimeout(() => {
                  showAddNewItemsModal(itemsWithoutPFG);
                }, 500);
              }

            } catch (error) {
              hideLoading();
              console.error('Error auto-creating items:', error);
              showMessage('Failed to auto-create items: ' + error.message, 'error');

              // Fallback: show modal for all new items (including PFG ones)
              setTimeout(() => {
                showAddNewItemsModal(newItems);
              }, 500);
            }
          }, 100);

        } else if (itemsWithoutPFG.length > 0) {
          // No PFG data, show modal for manual entry
          setTimeout(() => {
            showAddNewItemsModal(itemsWithoutPFG);
          }, 500);
        }
      }

    } catch (error) {
      hideLoading();
      console.error('Check-in error:', error);
      showMessage('Failed to check in items: ' + error.message, 'error');
    }
  }

  /**
   * Show modal to add new items (unmatched items from invoice)
   */
  function showAddNewItemsModal(newItems) {
    if (!newItems || newItems.length === 0) return;

    // Create overlay
    const overlay = document.createElement('div');
    overlay.id = 'addNewItemsModal';
    overlay.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 10000; overflow-y: auto; padding: 20px;';

    // Create modal
    const modal = document.createElement('div');
    modal.style.cssText = 'background: white; max-width: 600px; margin: 0 auto; padding: 20px; border-radius: 0; border: 2px solid #212121;';

    // Header
    const header = document.createElement('h3');
    header.textContent = 'ADD NEW ITEMS TO INVENTORY';
    header.style.cssText = 'margin: 0 0 16px 0; color: #212121; font-size: 16px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;';
    modal.appendChild(header);

    const desc = document.createElement('p');
    desc.textContent = 'Fill in details for ' + newItems.length + ' new item(s):';
    desc.style.cssText = 'margin: 0 0 20px 0; color: #666; font-size: 13px;';
    modal.appendChild(desc);

    // Form for each item
    newItems.forEach((item, index) => {
      const itemCard = document.createElement('div');
      itemCard.style.cssText = 'background: #f5f5f5; padding: 16px; margin-bottom: 16px; border: 2px solid #e0e0e0;';

      const itemTitle = document.createElement('div');
      itemTitle.textContent = 'FROM INVOICE: ' + item.detectedName;
      itemTitle.style.cssText = 'font-weight: 700; margin-bottom: 12px; color: #212121; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;';
      itemCard.appendChild(itemTitle);

      // Item Name
      const nameLabel = document.createElement('label');
      nameLabel.textContent = 'ITEM NAME:';
      nameLabel.style.cssText = 'display: block; margin-bottom: 4px; font-size: 11px; font-weight: 700; color: #666; letter-spacing: 0.5px;';
      itemCard.appendChild(nameLabel);

      const nameInput = document.createElement('input');
      nameInput.type = 'text';
      nameInput.value = item.detectedName;
      nameInput.style.cssText = 'width: 100%; padding: 8px; border: 2px solid #e0e0e0; margin-bottom: 12px; font-size: 13px;';
      nameInput.dataset.index = index;
      nameInput.dataset.field = 'name';
      itemCard.appendChild(nameInput);

      // Vendor
      const vendorLabel = document.createElement('label');
      vendorLabel.textContent = 'VENDOR:';
      vendorLabel.style.cssText = 'display: block; margin-bottom: 4px; font-size: 11px; font-weight: 700; color: #666; letter-spacing: 0.5px;';
      itemCard.appendChild(vendorLabel);

      const vendorInput = document.createElement('input');
      vendorInput.type = 'text';
      vendorInput.placeholder = 'e.g., Greenleaf';
      vendorInput.style.cssText = 'width: 100%; padding: 8px; border: 2px solid #e0e0e0; margin-bottom: 12px; font-size: 13px;';
      vendorInput.dataset.index = index;
      vendorInput.dataset.field = 'vendor';
      itemCard.appendChild(vendorInput);

      // Unit
      const unitLabel = document.createElement('label');
      unitLabel.textContent = 'UNIT:';
      unitLabel.style.cssText = 'display: block; margin-bottom: 4px; font-size: 11px; font-weight: 700; color: #666; letter-spacing: 0.5px;';
      itemCard.appendChild(unitLabel);

      const unitInput = document.createElement('input');
      unitInput.type = 'text';
      unitInput.placeholder = 'e.g., CS, EA, LB';
      unitInput.style.cssText = 'width: 100%; padding: 8px; border: 2px solid #e0e0e0; margin-bottom: 12px; font-size: 13px; text-transform: uppercase;';
      unitInput.dataset.index = index;
      unitInput.dataset.field = 'unit';
      itemCard.appendChild(unitInput);

      // Par Level
      const parLabel = document.createElement('label');
      parLabel.textContent = 'PAR LEVEL:';
      parLabel.style.cssText = 'display: block; margin-bottom: 4px; font-size: 11px; font-weight: 700; color: #666; letter-spacing: 0.5px;';
      itemCard.appendChild(parLabel);

      const parInput = document.createElement('input');
      parInput.type = 'number';
      parInput.step = '0.25';
      parInput.value = item.detectedQuantity || 1;
      parInput.style.cssText = 'width: 100%; padding: 8px; border: 2px solid #e0e0e0; font-size: 13px;';
      parInput.dataset.index = index;
      parInput.dataset.field = 'par';
      itemCard.appendChild(parInput);

      modal.appendChild(itemCard);
    });

    // Buttons
    const btnRow = document.createElement('div');
    btnRow.style.cssText = 'display: flex; gap: 10px; margin-top: 20px;';

    const cancelBtn = document.createElement('button');
    cancelBtn.textContent = 'SKIP';
    cancelBtn.style.cssText = 'flex: 1; padding: 12px; background: #e0e0e0; color: #212121; border: none; cursor: pointer; font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;';
    cancelBtn.onclick = () => overlay.remove();
    btnRow.appendChild(cancelBtn);

    const saveBtn = document.createElement('button');
    saveBtn.textContent = 'ADD TO INVENTORY';
    saveBtn.style.cssText = 'flex: 2; padding: 12px; background: #212121; color: white; border: none; cursor: pointer; font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;';
    saveBtn.onclick = async () => {
      const inputs = modal.querySelectorAll('input');
      const itemsToAdd = [];

      newItems.forEach((item, index) => {
        const name = modal.querySelector(`input[data-index="${index}"][data-field="name"]`).value.trim();
        const vendor = modal.querySelector(`input[data-index="${index}"][data-field="vendor"]`).value.trim();
        const unit = modal.querySelector(`input[data-index="${index}"][data-field="unit"]`).value.trim().toUpperCase();
        const par = parseFloat(modal.querySelector(`input[data-index="${index}"][data-field="par"]`).value) || 0;

        if (!name) {
          showMessage('Item name required for all items', 'error');
          return;
        }

        itemsToAdd.push({
          item_name: name,
          vendor: vendor || 'Unknown',
          unit: unit || 'EA',
          par_level: par,
          current_stock: item.detectedQuantity || 0
        });
      });

      if (itemsToAdd.length === 0) return;

      overlay.remove();
      showLoading('Adding Items', 'Creating inventory items...');

      try {
        const { error } = await supabase.from('inventory_items').insert(itemsToAdd);
        if (error) throw error;

        hideLoading();
        showMessage(`✅ Added ${itemsToAdd.length} new item(s) to inventory!`, 'success');
        await loadInventoryData();
      } catch (error) {
        hideLoading();
        showMessage('Error adding items: ' + error.message, 'error');
      }
    };
    btnRow.appendChild(saveBtn);

    modal.appendChild(btnRow);
    overlay.appendChild(modal);
    document.body.appendChild(overlay);
  }

  /**
   * Print a specific order
   */
  function printOrder(orderIndex) {
    const order = orderingSystemState.calculatedOrders[orderIndex];
    if (!order) return;

    const printWindow = window.open('', '', 'height=800,width=800');
    printWindow.document.write('<html><head><title>Order - ' + order.vendor + '</title>');
    printWindow.document.write(`<style>
      @page { margin: 0.5in; }
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
        padding: 0;
        margin: 0;
        color: #1a1a1a;
        font-size: 9pt;
        line-height: 1.3;
      }
      .header {
        border-bottom: 2px solid #2196F3;
        padding-bottom: 8px;
        margin-bottom: 12px;
      }
      .company {
        font-size: 16pt;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: #1a1a1a;
        margin: 0 0 4px 0;
      }
      .order-title {
        font-size: 12pt;
        font-weight: 600;
        color: #424242;
        margin: 0;
      }
      .order-details {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 6px;
        margin: 12px 0;
        padding: 8px;
        background: #f5f5f5;
        font-size: 8pt;
      }
      .detail-label {
        font-weight: 600;
        color: #616161;
        text-transform: uppercase;
        font-size: 7pt;
        letter-spacing: 0.5px;
      }
      .detail-value {
        color: #1a1a1a;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 12px;
        font-size: 8pt;
      }
      th {
        background: #424242;
        color: white;
        padding: 6px 8px;
        text-align: left;
        font-weight: 600;
        font-size: 7pt;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      td {
        border-bottom: 1px solid #e0e0e0;
        padding: 6px 8px;
        vertical-align: top;
      }
      tr:hover { background: #fafafa; }
      .item-name {
        font-weight: 600;
        color: #1a1a1a;
        font-size: 8pt;
      }
      .item-meta {
        font-size: 7pt;
        color: #757575;
        margin-top: 2px;
      }
      .item-reasoning {
        font-size: 6pt;
        color: #9e9e9e;
        font-style: italic;
        margin-top: 2px;
      }
      .qty-cell {
        font-weight: 700;
        color: #2196F3;
        text-align: center;
      }
      .notes-box {
        background: #e3f2fd;
        border-left: 3px solid #2196F3;
        padding: 8px;
        margin: 12px 0;
        font-size: 8pt;
      }
      .footer {
        margin-top: 16px;
        padding-top: 8px;
        border-top: 1px solid #e0e0e0;
        font-size: 7pt;
        color: #757575;
        text-align: center;
      }
    </style>`);
    printWindow.document.write('</head><body>');

    // Header
    printWindow.document.write(`
      <div class="header">
        <div class="company">JAYNA GYRO</div>
        <div class="order-title">${order.vendor} - Order #${orderIndex + 1}</div>
      </div>
    `);

    // Order details
    const orderDateStr = formatPacificDateDisplay(order.orderDate, { month: 'short', day: 'numeric', year: 'numeric' });
    const deliveryDateStr = formatPacificDateDisplay(order.deliveryDate, { month: 'short', day: 'numeric', year: 'numeric' });

    printWindow.document.write(`
      <div class="order-details">
        <div><span class="detail-label">Order Date:</span> <span class="detail-value">${orderDateStr}</span></div>
        <div><span class="detail-label">Cutoff:</span> <span class="detail-value">${order.cutoffTime}</span></div>
        <div><span class="detail-label">Delivery:</span> <span class="detail-value">${deliveryDateStr}</span></div>
        <div><span class="detail-label">Items:</span> <span class="detail-value">${order.items.length}</span></div>
      </div>
    `);

    // Notes
    if (order.notes) {
      printWindow.document.write(`<div class="notes-box"><strong>Note:</strong> ${order.notes}</div>`);
    }

    // Table
    printWindow.document.write('<table><thead><tr><th>Item</th><th style="text-align:center;">Qty</th><th style="text-align:center;">Unit</th><th style="text-align:center;">Par</th><th style="text-align:center;">Current</th></tr></thead><tbody>');

    const isFriday = formatPacificWeekday(order.orderDate) === 'Friday';
    const isThursday = formatPacificWeekday(order.orderDate) === 'Thursday';

    order.items.forEach(item => {
      let reasoningText = '';
      if (order.vendor === 'Greenleaf' && isFriday) {
        reasoningText = `AI: (Par ${item.parLevel} - Stock ${item.currentStock}) × 2 days = ${item.quantity}`;
      } else if (order.vendor === 'Mani Imports' && isThursday) {
        const calc = Math.ceil((item.parLevel - item.currentStock) * (5 / 7));
        reasoningText = `AI: (Par ${item.parLevel} - Stock ${item.currentStock}) × 5/7 = ${calc}`;
      } else if (order.vendor === 'Mani Imports') {
        const calc = Math.ceil((item.parLevel - item.currentStock) * (3 / 7));
        reasoningText = `AI: (Par ${item.parLevel} - Stock ${item.currentStock}) × 3/7 = ${calc}`;
      } else {
        reasoningText = `AI: Par ${item.parLevel} - Stock ${item.currentStock} = ${item.quantity}`;
      }

      const lastCountStr = item.lastCountedDate ? `Last count: ${formatRelativeTime(item.lastCountedDate)}` : '';
      const lastPriceStr = item.currentUnitCost ? `Last price: ${formatPriceWithDate(item.currentUnitCost, item.lastCostUpdate)}` : '';

      printWindow.document.write(`
        <tr>
          <td>
            <div class="item-name">${item.itemName}</div>
            ${lastCountStr ? `<div class="item-meta">${lastCountStr}</div>` : ''}
            ${lastPriceStr ? `<div class="item-meta">${lastPriceStr}</div>` : ''}
            <div class="item-reasoning">${reasoningText}</div>
          </td>
          <td class="qty-cell">${item.quantity}</td>
          <td style="text-align:center;">${item.unit}</td>
          <td style="text-align:center;">${item.parLevel}</td>
          <td style="text-align:center;">${item.currentStock}</td>
        </tr>
      `);
    });

    printWindow.document.write('</tbody></table>');
    printWindow.document.write(`<div class="footer">Generated: ${new Date().toLocaleString()}</div>`);
    printWindow.document.write('</body></html>');
    printWindow.document.close();
    printWindow.print();
  }

  /**
   * Generate PDF for a specific order
   */
  async function generateOrderPDF(orderIndex) {
    const order = orderingSystemState.calculatedOrders[orderIndex];
    if (!order) return;

    showLoading('Generating PDF', 'Creating order document...');

    try {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      // Blue accent color (Jayna blue)
      const jaynaBlue = [33, 150, 243]; // #2196F3
      const darkGray = [66, 66, 66]; // #424242
      const mediumGray = [117, 117, 117]; // #757575
      const lightGray = [158, 158, 158]; // #9e9e9e

      // Header with blue underline
      doc.setFontSize(14);
      doc.setFont('helvetica', 'bold');
      doc.setTextColor(26, 26, 26);
      doc.text('JAYNA GYRO', 105, 15, { align: 'center' });

      doc.setFontSize(10);
      doc.setFont('helvetica', 'normal');
      doc.setTextColor(darkGray[0], darkGray[1], darkGray[2]);
      doc.text(`${order.vendor} - Order #${orderIndex + 1}`, 105, 22, { align: 'center' });

      // Blue line
      doc.setDrawColor(jaynaBlue[0], jaynaBlue[1], jaynaBlue[2]);
      doc.setLineWidth(0.5);
      doc.line(20, 25, 190, 25);

      // Order details in compact grid
      const orderDateStr = formatPacificDateDisplay(order.orderDate, { month: 'short', day: 'numeric', year: 'numeric' });
      const deliveryDateStr = formatPacificDateDisplay(order.deliveryDate, { month: 'short', day: 'numeric', year: 'numeric' });

      doc.setFillColor(245, 245, 245);
      doc.rect(20, 28, 170, 16, 'F');

      doc.setFontSize(7);
      doc.setFont('helvetica', 'bold');
      doc.setTextColor(mediumGray[0], mediumGray[1], mediumGray[2]);
      doc.text('ORDER DATE', 25, 33);
      doc.text('CUTOFF', 75, 33);
      doc.text('DELIVERY', 125, 33);
      doc.text('ITEMS', 165, 33);

      doc.setFontSize(8);
      doc.setFont('helvetica', 'normal');
      doc.setTextColor(26, 26, 26);
      doc.text(orderDateStr, 25, 40);
      doc.text(order.cutoffTime, 75, 40);
      doc.text(deliveryDateStr, 125, 40);
      doc.text(order.items.length.toString(), 165, 40);

      let startY = 47;

      // Notes box if present
      if (order.notes) {
        doc.setFillColor(227, 242, 253); // Light blue
        doc.rect(20, startY, 170, 10, 'F');
        doc.setDrawColor(jaynaBlue[0], jaynaBlue[1], jaynaBlue[2]);
        doc.setLineWidth(1);
        doc.line(20, startY, 20, startY + 10);

        doc.setFontSize(7);
        doc.setTextColor(26, 26, 26);
        doc.text(`Note: ${order.notes}`, 25, startY + 6);
        startY += 13;
      }

      // Table with compact styling
      const isFriday = formatPacificWeekday(order.orderDate) === 'Friday';
      const isThursday = formatPacificWeekday(order.orderDate) === 'Thursday';

      const tableData = order.items.map(item => {
        let reasoningText = '';
        if (order.vendor === 'Greenleaf' && isFriday) {
          reasoningText = `AI: (${item.parLevel} - ${item.currentStock}) × 2 = ${item.quantity}`;
        } else if (order.vendor === 'Mani Imports' && isThursday) {
          const calc = Math.ceil((item.parLevel - item.currentStock) * (5 / 7));
          reasoningText = `AI: (${item.parLevel} - ${item.currentStock}) × 5/7 = ${calc}`;
        } else if (order.vendor === 'Mani Imports') {
          const calc = Math.ceil((item.parLevel - item.currentStock) * (3 / 7));
          reasoningText = `AI: (${item.parLevel} - ${item.currentStock}) × 3/7 = ${calc}`;
        } else {
          reasoningText = `AI: ${item.parLevel} - ${item.currentStock} = ${item.quantity}`;
        }

        const lastCountStr = item.lastCountedDate ? `Count: ${formatRelativeTime(item.lastCountedDate)}` : '';
        const lastPriceStr = item.currentUnitCost ? `Price: ${formatPriceWithDate(item.currentUnitCost, item.lastCostUpdate)}` : '';

        let itemNameWithMetadata = item.itemName;
        if (lastCountStr) itemNameWithMetadata += '\n' + lastCountStr;
        if (lastPriceStr) itemNameWithMetadata += '\n' + lastPriceStr;
        itemNameWithMetadata += '\n' + reasoningText;

        return [
          itemNameWithMetadata,
          item.quantity.toString(),
          item.unit,
          item.parLevel.toString(),
          item.currentStock.toString()
        ];
      });

      doc.autoTable({
        head: [['Item', 'Qty', 'Unit', 'Par', 'Stock']],
        body: tableData,
        startY: startY,
        theme: 'plain',
        headStyles: {
          fillColor: darkGray,
          textColor: [255, 255, 255],
          fontSize: 7,
          fontStyle: 'bold',
          halign: 'left',
          cellPadding: { top: 3, right: 4, bottom: 3, left: 4 }
        },
        styles: {
          fontSize: 7,
          cellPadding: { top: 3, right: 4, bottom: 3, left: 4 },
          lineColor: [224, 224, 224],
          lineWidth: 0.1
        },
        columnStyles: {
          0: { cellWidth: 90 },
          1: { halign: 'center', textColor: jaynaBlue, fontStyle: 'bold' },
          2: { halign: 'center', cellWidth: 20 },
          3: { halign: 'center', cellWidth: 20 },
          4: { halign: 'center', cellWidth: 25 }
        },
        alternateRowStyles: {
          fillColor: [250, 250, 250]
        },
        willDrawCell: function(data) {
          if (data.column.index === 0 && data.cell.section === 'body' && data.cell.text.length > 1) {
            data.cell.text = [];
          }
        },
        didDrawCell: function(data) {
          if (data.column.index === 0 && data.cell.section === 'body') {
            const rowData = tableData[data.row.index];
            if (!rowData) {
              return;
            }
            const cellData = rowData[0];
            if (!cellData) {
              return;
            }
            const lines = cellData.split('\n');

            if (lines.length > 1) {
              let yPos = data.cell.y + 4;
              const lineHeight = 3.5;

              lines.forEach((line, index) => {
                if (index === 0) {
                  doc.setFontSize(7);
                  doc.setFont('helvetica', 'bold');
                  doc.setTextColor(26, 26, 26);
                  doc.text(line, data.cell.x + 4, yPos);
                } else if (line.startsWith('Count:') || line.startsWith('Price:')) {
                  doc.setFontSize(6);
                  doc.setFont('helvetica', 'normal');
                  doc.setTextColor(mediumGray[0], mediumGray[1], mediumGray[2]);
                  doc.text(line, data.cell.x + 4, yPos);
                } else if (line.startsWith('AI:')) {
                  doc.setFontSize(5.5);
                  doc.setFont('helvetica', 'italic');
                  doc.setTextColor(lightGray[0], lightGray[1], lightGray[2]);
                  doc.text(line, data.cell.x + 4, yPos);
                  doc.setFont('helvetica', 'normal');
                }
                yPos += lineHeight;
              });

              doc.setFont('helvetica', 'normal');
              doc.setTextColor(26, 26, 26);
            }
          }
        }
      });

      // Footer
      const pageCount = doc.internal.getNumberOfPages();
      for (let i = 1; i <= pageCount; i++) {
        doc.setPage(i);
        doc.setDrawColor(224, 224, 224);
        doc.setLineWidth(0.1);
        doc.line(20, 282, 190, 282);

        doc.setFontSize(6);
        doc.setTextColor(mediumGray[0], mediumGray[1], mediumGray[2]);
        doc.text(`Generated: ${new Date().toLocaleString()}`, 20, 287);
        doc.text(`Page ${i} of ${pageCount}`, 190, 287, { align: 'right' });
      }

      doc.save(`${order.vendor}_Order_${formatPacificDate(order.orderDate)}.pdf`);

      hideLoading();
      showMessage('✅ PDF generated successfully!', 'success');
    } catch (error) {
      hideLoading();
      console.error('PDF generation error:', error);
      showMessage(`Error generating PDF: ${error.message}`, 'error');
    }
  }

  /**
   * Save order edits to localStorage (persist across sessions)
   */
  function saveOrderEditsToStorage(orderIndex) {
    const order = orderingSystemState.calculatedOrders[orderIndex];
    if (!order) return;

    const storageKey = `orderEdits_${order.vendor}_${formatPacificDate(order.orderDate)}`;
    const edits = {};

    order.items.forEach(item => {
      edits[item.id] = {
        quantity: item.quantity,
        unit: item.unit
      };
    });

    localStorage.setItem(storageKey, JSON.stringify(edits));
  }

  /**
   * Load order edits from localStorage
   */
  function loadOrderEditsFromStorage(order) {
    const storageKey = `orderEdits_${order.vendor}_${formatPacificDate(order.orderDate)}`;
    const saved = localStorage.getItem(storageKey);

    if (saved) {
      try {
        const edits = JSON.parse(saved);
        order.items.forEach(item => {
          if (edits[item.id]) {
            item.quantity = edits[item.id].quantity;
            item.unit = edits[item.id].unit;
          }
        });
      } catch (e) {
        console.error('Failed to load saved edits:', e);
      }
    }
  }

  /**
   * Capture all current input field values before PDF generation
   */
  function captureAllOrderEdits(orderIndex) {
    const order = orderingSystemState.calculatedOrders[orderIndex];
    if (!order) return;

    // Get the specific order card
    const orderCard = document.getElementById(`order-${orderIndex}`);
    if (!orderCard) return;

    // Find all quantity inputs WITHIN this specific order card
    const qtyInputs = orderCard.querySelectorAll('input[type="number"]');
    qtyInputs.forEach(input => {
      const itemId = parseInt(input.getAttribute('data-item-id'));
      const newQty = parseFloat(input.value) || 0;
      const item = order.items.find(i => i.id === itemId);
      if (item) {
        item.quantity = newQty;
      }
    });

    // Find all unit inputs WITHIN this specific order card
    const unitInputs = orderCard.querySelectorAll('input[type="text"]');
    unitInputs.forEach(input => {
      const itemId = parseInt(input.getAttribute('data-item-id'));
      const newUnit = input.value.trim().toUpperCase();
      const item = order.items.find(i => i.id === itemId);
      if (item) {
        item.unit = newUnit;
      }
    });

    // Save to localStorage so edits persist
    saveOrderEditsToStorage(orderIndex);
  }

  /**
   * Generate PDF and create order for receiving (combined action)
   */
  async function generatePDFAndCreateOrder(orderIndex) {
    try {
      // FIRST: Capture any unsaved edits from input fields
      captureAllOrderEdits(orderIndex);

      // SECOND: Show the create order modal to save
      await createOrderForReceiving(orderIndex);

      // THIRD: Generate the PDF with the final edited quantities
      await generateOrderPDF(orderIndex);
    } catch (error) {
      // User cancelled or error occurred - do nothing
      console.log('Order creation cancelled or failed:', error);
    }
  }

  /**
   * Generate combined PDF with all orders
   */
  async function generateAllPDFs() {
    if (orderingSystemState.calculatedOrders.length === 0) {
      showMessage('No orders to generate!', 'info');
      return;
    }

    showLoading('Generating Combined PDF', 'Creating document with all orders...');

    try {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      // Cover page
      doc.setFontSize(24);
      doc.setFont('helvetica', 'bold');
      doc.text('JAYNA GYRO', 105, 40, { align: 'center' });

      doc.setFontSize(18);
      doc.text('Weekly Order Summary', 105, 55, { align: 'center' });

      doc.setFontSize(12);
      doc.setFont('helvetica', 'normal');
      doc.text(`Generated: ${new Date().toLocaleString()}`, 105, 70, { align: 'center' });
      doc.text(`Total Orders: ${orderingSystemState.calculatedOrders.length}`, 105, 80, { align: 'center' });

      // Add each order
      orderingSystemState.calculatedOrders.forEach((order, index) => {
        doc.addPage();

        // Header
        doc.setFontSize(18);
        doc.setFont('helvetica', 'bold');
        doc.text(`${order.vendor} - Order #${index + 1}`, 105, 20, { align: 'center' });

        // Order details
        doc.setFontSize(10);
        doc.setFont('helvetica', 'normal');
        doc.text(`Order Date: ${formatPacificDateDisplay(order.orderDate, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}`, 20, 35);
        doc.text(`Cutoff Time: ${order.cutoffTime}`, 20, 42);
        doc.text(`Delivery Date: ${order.deliveryDate.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}`, 20, 49);

        if (order.notes) {
          doc.setFont('helvetica', 'bold');
          doc.text(`Notes: ${order.notes}`, 20, 56);
        }

        // Table with AI reasoning
        const isFriday = formatPacificWeekday(order.orderDate) === 'Friday';
        const isThursday = formatPacificWeekday(order.orderDate) === 'Thursday';

        const tableData = order.items.map(item => {
          // Calculate reasoning text (matches email format)
          let reasoningText = '';
          if (order.vendor === 'Greenleaf' && isFriday) {
            reasoningText = `AI: (Par ${item.parLevel} - Stock ${item.currentStock}) × 2 days = ${item.quantity} to order`;
          } else if (order.vendor === 'Mani Imports' && isThursday) {
            const calc = Math.ceil((item.parLevel - item.currentStock) * (5 / 7));
            reasoningText = `AI: (Par ${item.parLevel} - Stock ${item.currentStock}) × 5/7 days = ${calc} to order`;
          } else if (order.vendor === 'Mani Imports') {
            const calc = Math.ceil((item.parLevel - item.currentStock) * (3 / 7));
            reasoningText = `AI: (Par ${item.parLevel} - Stock ${item.currentStock}) × 3/7 days = ${calc} to order`;
          } else {
            reasoningText = `AI: Par ${item.parLevel} - Stock ${item.currentStock} = ${item.quantity} to order`;
          }

          // Format last count and last price (matches email format)
          const lastCountStr = item.lastCountedDate ? `Last count: ${formatRelativeTime(item.lastCountedDate)}` : '';
          const lastPriceStr = item.currentUnitCost ? `Last price: ${formatPriceWithDate(item.currentUnitCost, item.lastCostUpdate)}` : '';

          // Combine all metadata
          let itemNameWithMetadata = item.itemName;
          if (lastCountStr) itemNameWithMetadata += '\n' + lastCountStr;
          if (lastPriceStr) itemNameWithMetadata += '\n' + lastPriceStr;
          itemNameWithMetadata += '\n' + reasoningText;

          return [
            itemNameWithMetadata,
            item.quantity.toString(),
            item.unit,
            item.parLevel.toString(),
            item.currentStock.toString()
          ];
        });

        doc.autoTable({
          head: [['Item', 'Qty', 'Unit', 'Par', 'Stock']],
          body: tableData,
          startY: order.notes ? 65 : 58,
          theme: 'grid',
          headStyles: { fillColor: [30, 60, 114] },
          styles: { fontSize: 9, cellPadding: 3 },
          columnStyles: {
            0: { cellWidth: 80 } // Wider first column for multi-line content
          },
          willDrawCell: function(data) {
            // Prevent default text rendering for Item column - clear BEFORE drawing
            if (data.column.index === 0 && data.cell.section === 'body' && data.cell.text.length > 1) {
              data.cell.text = []; // This prevents the default rendering
            }
          },
          didDrawCell: function(data) {
            // Custom rendering for Item column with metadata
            if (data.column.index === 0 && data.cell.section === 'body') {
              const cellData = tableData[data.row.index][0];
              const lines = cellData.split('\n');

              if (lines.length > 1) {
                let yPos = data.cell.y + 5;
                const lineHeight = 4;

                // Draw each line with appropriate styling
                lines.forEach((line, index) => {
                  if (index === 0) {
                    // Item name - normal size, black
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(0, 0, 0);
                    doc.text(line, data.cell.x + 2, yPos);
                  } else if (line.startsWith('Last count:') || line.startsWith('Last price:')) {
                    // Metadata - smaller, gray
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(120, 120, 120);
                    doc.text(line, data.cell.x + 2, yPos);
                  } else if (line.startsWith('AI:')) {
                    // Reasoning - smallest, light gray, italic
                    doc.setFontSize(7);
                    doc.setFont('helvetica', 'italic');
                    doc.setTextColor(170, 170, 170);
                    doc.text(line, data.cell.x + 2, yPos);
                    doc.setFont('helvetica', 'normal');
                  }
                  yPos += lineHeight;
                });

                // Reset to defaults
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(0, 0, 0);
              }
            }
          }
        });
      });

      // Footer on all pages
      const pageCount = doc.internal.getNumberOfPages();
      for (let i = 1; i <= pageCount; i++) {
        doc.setPage(i);
        doc.setFontSize(8);
        doc.setFont('helvetica', 'normal');
        doc.text(`Jayna Gyro Ordering System`, 20, 285);
        doc.text(`Page ${i} of ${pageCount}`, 190, 285, { align: 'right' });
      }

      const filename = `Jayna_All_Orders_${getPacificDate()}.pdf`;
      doc.save(filename);

      hideLoading();
      showMessage('✅ Combined PDF generated successfully!', 'success');
    } catch (error) {
      hideLoading();
      showMessage(`Error generating PDF: ${error.message}`, 'error');
    }
  }

  // ====================================
  // ADD ITEM MODALS
  // ====================================

  /**
   * Show Add Inventory Modal
   */
  function showAddInventoryModal() {
    const modalHTML = `
      <div id="addInventoryModal" style="
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10000;
        padding: 20px;
      ">
        <div style="
          background: var(--white);
          border-radius: 0;
          padding: 24px;
          max-width: 600px;
          width: 100%;
          max-height: 90vh;
          overflow-y: auto;
          border: 2px solid var(--gray-300);
        ">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 style="margin: 0; color: var(--gray-900); font-size: 16px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;">Add New Inventory Item</h3>
            <button onclick="closeAddInventoryModal()" style="
              background: none;
              border: none;
              font-size: 24px;
              cursor: pointer;
              color: var(--gray-500);
              padding: 0;
              line-height: 1;
            ">&times;</button>
          </div>

          <form id="addItemFormModal" onsubmit="handleAddItemModal(event)" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div class="form-group">
              <label for="newItemNameModal" style="display: block; margin-bottom: 6px; color: var(--gray-700); font-size: 12px; font-weight: 700; text-transform: uppercase;">Item Name:</label>
              <input type="text" id="newItemNameModal" class="form-input" placeholder="e.g., Wild Arugula 4#/CS" required style="width: 100%; padding: 10px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 13px;">
            </div>
            <div class="form-group">
              <label for="newItemVendorModal" style="display: block; margin-bottom: 6px; color: var(--gray-700); font-size: 12px; font-weight: 700; text-transform: uppercase;">Vendor:</label>
              <select id="newItemVendorModal" class="form-select" required style="width: 100%; padding: 10px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 13px; background: var(--white);">
                <option value="">Select Vendor</option>
                <option value="Greenleaf">Greenleaf</option>
                <option value="Performance">Performance</option>
                <option value="Mani Imports">Mani Imports</option>
                <option value="Eatopia">Eatopia</option>
                <option value="Restaurant Depot">Restaurant Depot</option>
                <option value="Alsco">Alsco</option>
                <option value="SRC Pumping">SRC Pumping</option>
                <option value="Southern Glazer's">Southern Glazer's</option>
                <option value="Breakthru Beverage">Breakthru Beverage</option>
                <option value="Ecolab">Ecolab</option>
                <option value="OTHER">OTHER (Add New Vendor)</option>
              </select>
            </div>
            <div class="form-group">
              <label for="newItemUnitModal" style="display: block; margin-bottom: 6px; color: var(--gray-700); font-size: 12px; font-weight: 700; text-transform: uppercase;">Unit:</label>
              <input type="text" id="newItemUnitModal" class="form-input" placeholder="e.g., CS, EA, LB" required style="width: 100%; padding: 10px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 13px;">
            </div>
            <div class="form-group">
              <label for="newItemParModal" style="display: block; margin-bottom: 6px; color: var(--gray-700); font-size: 12px; font-weight: 700; text-transform: uppercase;">Par Level:</label>
              <input type="number" id="newItemParModal" class="form-input" min="0" value="0" required style="width: 100%; padding: 10px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 13px;">
            </div>
            <div style="grid-column: 1 / -1; display: flex; gap: 10px; margin-top: 10px;">
              <button type="button" onclick="closeAddInventoryModal()" style="
                flex: 1;
                background: var(--gray-300);
                color: var(--gray-900);
                border: none;
                padding: 12px 24px;
                cursor: pointer;
                font-size: 13px;
                font-weight: 700;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                border-radius: 0;
              ">Cancel</button>
              <button type="submit" style="
                flex: 1;
                background: var(--gray-700);
                color: var(--white);
                border: none;
                padding: 12px 24px;
                cursor: pointer;
                font-size: 13px;
                font-weight: 700;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                border-radius: 0;
              ">Add Item</button>
            </div>
          </form>
        </div>
      </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modalHTML);
  }

  function closeAddInventoryModal() {
    const modal = document.getElementById('addInventoryModal');
    if (modal) modal.remove();
  }

  async function handleAddItemModal(event) {
    event.preventDefault();

    const itemName = document.getElementById('newItemNameModal').value.trim();
    let vendor = document.getElementById('newItemVendorModal').value;
    const unit = document.getElementById('newItemUnitModal').value.trim().toUpperCase();
    const parLevel = parseFloat(document.getElementById('newItemParModal').value);

    if (!itemName || !vendor || !unit) {
      showMessage('Please fill in all required fields!', 'error');
      return;
    }

    if (vendor === 'OTHER') {
      const newVendor = prompt('Enter new vendor name:');
      if (!newVendor || newVendor.trim() === '') {
        showMessage('Vendor name is required', 'error');
        return;
      }
      vendor = newVendor.trim();
    }

    closeAddInventoryModal();
    showLoading('Adding Item', 'Saving to database...');

    try {
      const { data, error } = await supabase
        .from('inventory_items')
        .insert([{
          item_name: itemName,
          vendor: vendor,
          unit: unit,
          par_level: parLevel,
          current_stock: 0,
          item_type: 'ingredient',
          created_date: new Date().toISOString()
        }])
        .select();

      if (error) throw error;

      orderingSystemState.items.push({
        id: data[0].id,
        itemName: data[0].item_name,
        vendor: data[0].vendor,
        parLevel: data[0].par_level,
        currentStock: data[0].current_stock,
        unit: data[0].unit,
        itemType: data[0].item_type,
        lastCountedDate: null
      });

      renderInventoryList();
      hideLoading();
      showMessage(`✅ ${itemName} added successfully!`, 'success');
    } catch (error) {
      hideLoading();
      showMessage(`Error adding item: ${error.message}`, 'error');
    }
  }

  /**
   * Show Add Prep Item Modal
   */
  function showAddPrepModal() {
    const modalHTML = `
      <div id="addPrepModal" style="
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10000;
        padding: 20px;
      ">
        <div style="
          background: var(--white);
          border-radius: 0;
          padding: 24px;
          max-width: 700px;
          width: 100%;
          max-height: 90vh;
          overflow-y: auto;
          border: 2px solid var(--gray-300);
        ">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 style="margin: 0; color: var(--gray-900); font-size: 16px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;">Add New Prep Item</h3>
            <button onclick="closeAddPrepModal()" style="
              background: none;
              border: none;
              font-size: 24px;
              cursor: pointer;
              color: var(--gray-500);
              padding: 0;
              line-height: 1;
            ">&times;</button>
          </div>

          <form id="addPrepItemFormModal" onsubmit="handleAddPrepItemModal(event)" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div class="form-group">
              <label for="newPrepItemNameModal" style="display: block; margin-bottom: 6px; color: var(--gray-700); font-size: 12px; font-weight: 700; text-transform: uppercase;">Item Name:</label>
              <input type="text" id="newPrepItemNameModal" class="form-input" placeholder="e.g., Marinated Tomatoes" required style="width: 100%; padding: 10px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 13px;">
            </div>
            <div class="form-group">
              <label for="newPrepItemUnitModal" style="display: block; margin-bottom: 6px; color: var(--gray-700); font-size: 12px; font-weight: 700; text-transform: uppercase;">Unit:</label>
              <input type="text" id="newPrepItemUnitModal" class="form-input" placeholder="e.g., CAMBRO, PIECE" required style="width: 100%; padding: 10px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 13px;">
            </div>
            <div class="form-group">
              <label for="newPrepItemParModal" style="display: block; margin-bottom: 6px; color: var(--gray-700); font-size: 12px; font-weight: 700; text-transform: uppercase;">Par Level:</label>
              <input type="number" id="newPrepItemParModal" class="form-input" min="0" step="0.25" value="0" required style="width: 100%; padding: 10px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 13px;">
            </div>
            <div class="form-group">
              <label for="newPrepItemLifespanModal" style="display: block; margin-bottom: 6px; color: var(--gray-700); font-size: 12px; font-weight: 700; text-transform: uppercase;">Batch Lifespan (hours):</label>
              <input type="number" id="newPrepItemLifespanModal" class="form-input" min="0" value="48" required style="width: 100%; padding: 10px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 13px;">
            </div>
            <div class="form-group">
              <label for="newPrepItemStorageModal" style="display: block; margin-bottom: 6px; color: var(--gray-700); font-size: 12px; font-weight: 700; text-transform: uppercase;">Storage Location:</label>
              <input type="text" id="newPrepItemStorageModal" class="form-input" placeholder="e.g., Walk-in Cooler, Freezer, Dry Storage" style="width: 100%; padding: 10px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 13px;">
            </div>
            <div style="grid-column: 1 / -1; display: flex; gap: 10px; margin-top: 10px;">
              <button type="button" onclick="closeAddPrepModal()" style="
                flex: 1;
                background: var(--gray-300);
                color: var(--gray-900);
                border: none;
                padding: 12px 24px;
                cursor: pointer;
                font-size: 13px;
                font-weight: 700;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                border-radius: 0;
              ">Cancel</button>
              <button type="submit" style="
                flex: 1;
                background: var(--gray-700);
                color: var(--white);
                border: none;
                padding: 12px 24px;
                cursor: pointer;
                font-size: 13px;
                font-weight: 700;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                border-radius: 0;
              ">Add Prep Item</button>
            </div>
          </form>
        </div>
      </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modalHTML);
  }

  function closeAddPrepModal() {
    const modal = document.getElementById('addPrepModal');
    if (modal) modal.remove();
  }

  async function handleAddPrepItemModal(event) {
    event.preventDefault();

    const itemName = document.getElementById('newPrepItemNameModal').value.trim();
    const vendor = 'PREP';  // All prep items are vendor "PREP"
    const unit = document.getElementById('newPrepItemUnitModal').value.trim().toUpperCase();
    const parLevel = parseFloat(document.getElementById('newPrepItemParModal').value);
    const batchLifespan = parseInt(document.getElementById('newPrepItemLifespanModal').value);
    const storageLocation = document.getElementById('newPrepItemStorageModal').value;

    if (!itemName || !unit) {
      showMessage('Please fill in all required fields!', 'error');
      return;
    }

    closeAddPrepModal();
    showLoading('Adding Prep Item', 'Saving to database...');

    try {
      const { data, error } = await supabase
        .from('inventory_items')
        .insert([{
          item_name: itemName,
          vendor: vendor,
          unit: unit,
          par_level: parLevel,
          current_stock: 0,
          item_type: 'prep',
          batch_lifespan_hours: batchLifespan,
          storage_location: storageLocation,
          created_date: new Date().toISOString()
        }])
        .select();

      if (error) throw error;

      orderingSystemState.items.push({
        id: data[0].id,
        itemName: data[0].item_name,
        vendor: data[0].vendor,
        parLevel: data[0].par_level,
        currentStock: data[0].current_stock,
        unit: data[0].unit,
        itemType: data[0].item_type,
        batchLifespan: data[0].batch_lifespan_hours,
        storageLocation: data[0].storage_location,
        lastCountedDate: null
      });

      renderPrepCountList();
      refreshPrepSheet();
      hideLoading();
      showMessage(`✅ ${itemName} added successfully!`, 'success');
    } catch (error) {
      hideLoading();
      showMessage(`Error adding prep item: ${error.message}`, 'error');
    }
  }

  // ====================================
  // ORDERING SYSTEM - END
  // ====================================

  // ====================================
  // ====================================
</script>
</body>
</html>
