<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, viewport-fit=cover">
  <title>Jayna Gyro Cash Counter</title>
  
  <link rel="apple-touch-icon" href="https://static.spotapps.co/website_images/ab_websites/229800_website_v1/logo.png">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#667eea">
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
      min-height: 100vh; 
      padding: 5px;
      /* Google Sites full page embed optimizations */
      overflow-x: hidden;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    .container { 
      max-width: 600px; 
      margin: 0 auto; 
      background: white; 
      border-radius: 20px; 
      overflow: visible; /* Changed from hidden to allow scrolling */
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
      /* Ensure container doesn't get cut off in Google Sites */
      min-height: auto;
      max-height: none;
    }
    .header { background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: white; text-align: center; padding: 20px; } /* Reduced from 30px 20px */
    .header h1 { font-size: 24px; font-weight: 700; margin-bottom: 5px; } /* Reduced font size and margin */
    .header p { opacity: 0.9; font-size: 14px; } /* Reduced font size */
    /* Mobile-First Responsive Design */
    .content { 
      padding: 15px; 
      /* Google Sites full page embed optimization */
      max-height: none;
      overflow: visible;
    }
    .main-menu { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; } /* Reduced gaps */
    .main-menu.show-report { grid-template-columns: 1fr 1fr 1fr; }
    .menu-btn { padding: 25px 20px; border: 3px solid #e0e0e0; border-radius: 15px; background: white; font-size: 18px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; text-align: center; min-height: 70px; display: flex; align-items: center; justify-content: center; } /* Reduced from 80px */
    .menu-btn:hover { border-color: #667eea; transform: translateY(-2px); }
    .menu-btn.active { border-color: #667eea; background: #667eea; color: white; transform: translateY(-2px); }
    .menu-btn.report { background: #28a745; color: white; border-color: #28a745; }
    .form-section { 
      display: none; 
      /* Ensure sections don't get cut off */
      min-height: auto;
      overflow: visible;
    }
    .form-section.active { 
      display: block; 
      /* Force visibility in Google Sites */
      position: relative;
      z-index: 1;
    }
    .form-group { margin-bottom: 20px; } /* Reduced from 25px */
    .form-group label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 16px; color: #333; } /* Reduced margin */
    
    /* Enhanced Mobile-Friendly Inputs */
    .form-input, .form-select { 
      width: 100%; 
      padding: 18px 20px; 
      border: 2px solid #e0e0e0; 
      border-radius: 12px; 
      font-size: 18px; 
      min-height: 56px;
      box-sizing: border-box;
      -webkit-appearance: none;
      appearance: none;
    }
    .form-input:focus, .form-select:focus { 
      outline: none; 
      border-color: #667eea; 
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    /* Number inputs with mobile optimization */
    input[type="number"] {
      -webkit-appearance: none;
      -moz-appearance: textfield;
      appearance: none;
      /* Remove number input arrows */
    }
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    
    .drawer-section { margin: 20px 0; border: 2px solid #f0f0f0; border-radius: 15px; overflow: hidden; } /* Reduced margin */
    .drawer-header { background: #f8f9fa; padding: 15px 20px; font-weight: 600; display: flex; justify-content: space-between; align-items: center; font-size: 16px; } /* Reduced padding */
    .skip-toggle { display: flex; align-items: center; gap: 12px; font-size: 16px; color: #666; }
    .skip-toggle input[type="checkbox"] { width: 20px; height: 20px; }
    .drawer-content { padding: 20px; } /* Reduced from 25px */
    .denom-row { display: flex; justify-content: space-between; align-items: center; padding: 14px 0; border-bottom: 1px solid #f0f0f0; } /* Reduced padding */
    .denom-row:last-child { border-bottom: none; }
    .denom-label { font-weight: 600; font-size: 18px; color: #333; }
    .denom-value { font-size: 16px; color: #666; margin-top: 4px; }
    
    /* Mobile-Optimized Quantity Inputs */
    .qty-input { 
      width: 100px; 
      height: 56px; 
      text-align: center; 
      border: 2px solid #e0e0e0; 
      border-radius: 12px; 
      font-size: 20px; 
      font-weight: 600;
      -webkit-appearance: none;
      -moz-appearance: textfield;
      appearance: none;
      /* Force numeric keyboard on mobile */
      inputmode: numeric;
      pattern: "[0-9]*";
    }
    .qty-input:focus { 
      outline: none; 
      border-color: #667eea; 
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    /* Remove number arrows */
    .qty-input::-webkit-outer-spin-button,
    .qty-input::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    
    /* Disabled denomination inputs */
    .qty-input:disabled {
      background-color: #f5f5f5;
      color: #999;
      border-color: #d0d0d0;
      cursor: not-allowed;
    }
    
    .denom-row.disabled {
      opacity: 0.6;
    }
    
    .drawer-total { margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 12px; text-align: center; font-size: 20px; font-weight: 600; } /* Reduced margins and padding */
    .grand-total { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 15px; text-align: center; margin: 20px 0; } /* Reduced margin */
    .grand-total h3 { font-size: 20px; margin-bottom: 8px; }
    .grand-total .amount { font-size: 36px; font-weight: 700; }
    .notes-area { width: 100%; min-height: 100px; padding: 18px; border: 2px solid #e0e0e0; border-radius: 12px; font-size: 16px; resize: vertical; box-sizing: border-box; } /* Reduced min-height */
    .notes-area:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
    .submit-btn { width: 100%; padding: 18px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 15px; font-size: 20px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; margin-top: 20px; min-height: 56px; } /* Reduced padding and margin */
    .submit-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3); }
    .submit-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
    .am-total-display { background: #e7f3ff; padding: 20px; border-radius: 12px; margin: 20px 0; }
    .am-total-display h4 { margin-bottom: 8px; color: #1976d2; font-size: 16px; }
    .am-total-display .amount { font-size: 28px; font-weight: bold; color: #1565c0; }
    
    /* Enhanced Currency Inputs */
    .currency-input { 
      width: 100%; 
      padding: 20px; 
      border: 2px solid #e0e0e0; 
      border-radius: 12px; 
      font-size: 22px; 
      text-align: center; 
      min-height: 60px;
      box-sizing: border-box;
      -webkit-appearance: none;
      -moz-appearance: textfield;
      appearance: none;
      inputmode: decimal;
    }
    .currency-input:focus { 
      outline: none; 
      border-color: #667eea; 
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    /* Remove number arrows from currency inputs */
    .currency-input::-webkit-outer-spin-button,
    .currency-input::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    
    .confirmation-screen { text-align: center; padding: 40px 20px; }
    .confirmation-screen h2 { color: #28a745; margin-bottom: 30px; font-size: 32px; }
    .deposit-instruction { background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; padding: 30px; border-radius: 15px; margin: 25px 0; font-size: 24px; font-weight: bold; }
    .return-instruction { background: linear-gradient(135deg, #fd7e14 0%, #e83e8c 100%); color: white; padding: 30px; border-radius: 15px; margin: 25px 0; font-size: 24px; font-weight: bold; }
    .thank-you { font-size: 22px; color: #28a745; margin: 30px 0; font-weight: 600; }
    .confirm-btn { background: #28a745; margin-top: 30px; }
    .loading { text-align: center; padding: 40px; }
    .loading-spinner { width: 60px; height: 60px; border: 6px solid #f3f3f3; border-top: 6px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .message { padding: 18px; border-radius: 12px; margin: 20px 0; text-align: center; font-size: 16px; }
    .message.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .message.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    .message.info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
    
    /* Tip Pool Calculator Styles */
    .cash-needed { color: #dc3545; font-weight: bold; }
    .cash-surplus { color: #28a745; font-weight: bold; }
    .hidden { display: none; }
    .skip-content { padding: 25px; }
    .skip-reason { width: 100%; padding: 18px; border: 2px solid #e0e0e0; border-radius: 12px; font-size: 16px; min-height: 56px; box-sizing: border-box; }
    
    /* Mobile responsive adjustments */
    @media (max-width: 768px) {
      .container { margin: 0; border-radius: 0; }
      .header { padding: 20px; }
      .header h1 { font-size: 24px; }
      .content { padding: 15px; }
      .main-menu { gap: 12px; }
      .menu-btn { padding: 25px 15px; font-size: 16px; min-height: 70px; }
      .denom-row { flex-direction: column; align-items: flex-start; gap: 12px; padding: 20px 0; }
      .qty-input { width: 120px; margin-top: 8px; }
      .grand-total .amount { font-size: 32px; }
      .confirmation-screen h2 { font-size: 28px; }
      .deposit-instruction, .return-instruction { font-size: 20px; padding: 25px; }
    }
    
    @media (max-width: 480px) {
      .header h1 { font-size: 20px; }
      .main-menu { grid-template-columns: 1fr; }
      .main-menu.show-report { grid-template-columns: 1fr; }
      .menu-btn { padding: 20px 15px; min-height: 60px; }
      .denom-label { font-size: 16px; }
      .qty-input { width: 100px; height: 50px; font-size: 18px; }
      .grand-total .amount { font-size: 28px; }
      .deposit-instruction, .return-instruction { font-size: 18px; padding: 20px; }
    }
    
    /* Google Sites Full Page Embed Optimizations */
    @media screen {
      html {
        /* Force proper viewport handling in Google Sites */
        height: auto !important;
        min-height: 100% !important;
        overflow-y: auto !important;
      }
      
      body {
        /* Ensure body can scroll properly in Google Sites iframe */
        height: auto !important;
        min-height: 100% !important;
        position: relative !important;
        overflow-y: auto !important;
        padding-bottom: 50px !important; /* Extra space at bottom */
      }
      
      .container {
        /* Ensure container doesn't get viewport-locked */
        position: relative !important;
        height: auto !important;
        min-height: auto !important;
        max-height: none !important;
        overflow: visible !important;
        margin-bottom: 50px !important; /* Extra bottom margin */
      }
      
      .submit-btn {
        /* Ensure submit buttons are always accessible */
        position: relative !important;
        z-index: 10 !important;
        margin-bottom: 30px !important;
      }
      
      /* Force visibility of bottom elements in Google Sites */
      .form-section:last-child,
      .form-section .submit-btn:last-child {
        margin-bottom: 100px !important;
      }
    }
    
    /* Elegant Loading Overlay */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      z-index: 9999;
      display: flex;
      justify-content: center;
      align-items: center;
      transition: opacity 0.3s ease;
    }
    .loading-overlay.hidden {
      display: none;
    }
    .loading-content {
      text-align: center;
      padding: 40px;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    .loading-spinner-elegant {
      width: 60px;
      height: 60px;
      border: 4px solid rgba(102, 126, 234, 0.1);
      border-top: 4px solid #667eea;
      border-radius: 50%;
      animation: spin-elegant 1.2s linear infinite;
      margin: 0 auto 20px;
    }
    @keyframes spin-elegant {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .loading-content h3 {
      margin: 0 0 10px 0;
      font-size: 24px;
      color: #333;
      font-weight: 600;
    }
    .loading-content p {
      margin: 0;
      font-size: 16px;
      color: #666;
      opacity: 0.8;
    }
    
    /* Success Screens */
    .success-screen {
      text-align: center;
      padding: 40px 20px;
      max-width: 600px;
      margin: 0 auto;
    }
    .success-icon {
      font-size: 80px;
      margin-bottom: 20px;
      animation: success-bounce 0.6s ease;
    }
    @keyframes success-bounce {
      0% { transform: scale(0.3); opacity: 0; }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); opacity: 1; }
    }
    .success-screen h2 {
      color: #28a745;
      margin-bottom: 15px;
      font-size: 32px;
      font-weight: 700;
    }
    .success-message {
      font-size: 18px;
      color: #666;
      margin-bottom: 30px;
      line-height: 1.5;
    }
    .success-details {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 25px;
      margin: 25px 0;
      border-left: 4px solid #28a745;
    }
    .detail-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      font-size: 16px;
    }
    .detail-row:not(:last-child) {
      border-bottom: 1px solid #e9ecef;
    }
    .detail-row span:first-child {
      color: #666;
      font-weight: 500;
    }
    .detail-row span:last-child {
      color: #333;
      font-weight: 600;
    }
    .success-btn {
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
      margin-top: 30px;
      font-size: 18px;
      padding: 20px 40px;
      border-radius: 12px;
      transition: all 0.3s ease;
    }
    .success-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(40, 167, 69, 0.3);
    }
  </style>
  
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
  <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
  <!-- Tip Pool Calculator Dependencies -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>JAYNA GYRO CASH COUNTER</h1>
      <p>App created by Demetri Gregorakis</p>
    </div>
    
    <div class="content">
      <div id="messageArea"></div>
      
      <!-- Main Menu -->
      <div id="mainMenu" class="main-menu">
        <button class="menu-btn" onclick="startAMCount()">AM Count</button>
        <button class="menu-btn" onclick="startPMCount()">PM Close</button>
        <button class="menu-btn report" onclick="showReports()">Generate Report</button>
        <button class="menu-btn" onclick="showTipPool()" style="background: #28a745;">Tip Pool Calculator</button>
        <button class="menu-btn" onclick="showCashbox()" style="background: #6f42c1;">üí∞ Weekly Cashbox Count</button>
      </div>
      
      <!-- AM Count Form -->
      <div id="amForm" class="form-section">
        <h2 style="margin-bottom: 20px; color: #1e3c72;">Morning Cash Count</h2>
        
        <div class="form-group">
          <label for="amDate">Date:</label>
          <input type="date" id="amDate" class="form-input" required>
        </div>
        
        <div class="form-group">
          <label for="amCounter">Counted by:</label>
          <select id="amCounter" class="form-select" onchange="toggleDenominationInputs('am')" required>
            <option value="">Choose Name</option>
            <option value="Demetri Gregorakis">Demetri Gregorakis</option>
            <option value="Ahmet Can Guler">Ahmet Can Guler</option>
            <option value="Bryan Cox">Bryan Cox</option>
            <option value="Kayla Mccullough">Kayla Mccullough</option>
            <option value="Dilan Uzum">Dilan Uzum</option>
          </select>
        </div>
        
        <!-- Drawer 1 -->
        <div class="drawer-section">
          <div class="drawer-header">
            <span>Drawer 1</span>
            <label class="skip-toggle">
              <input type="checkbox" id="amDrawer1Skip" onchange="toggleSkip('am', 1)">
              Skip Drawer
            </label>
          </div>
          <div id="amDrawer1Content" class="drawer-content">
            <div id="amDrawer1Denoms"></div>
            <div class="drawer-total" id="amDrawer1Total">$0.00</div>
          </div>
          <div id="amDrawer1SkipContent" class="skip-content hidden">
            <input type="text" class="skip-reason" id="amDrawer1Reason" placeholder="Reason for skipping drawer 1">
          </div>
        </div>
        
        <!-- Drawer 2 -->
        <div class="drawer-section">
          <div class="drawer-header">
            <span>Drawer 2</span>
            <label class="skip-toggle">
              <input type="checkbox" id="amDrawer2Skip" onchange="toggleSkip('am', 2)">
              Skip Drawer
            </label>
          </div>
          <div id="amDrawer2Content" class="drawer-content">
            <div id="amDrawer2Denoms"></div>
            <div class="drawer-total" id="amDrawer2Total">$0.00</div>
          </div>
          <div id="amDrawer2SkipContent" class="skip-content hidden">
            <input type="text" class="skip-reason" id="amDrawer2Reason" placeholder="Reason for skipping drawer 2">
          </div>
        </div>
        
        <div class="grand-total">
          <h3>Total Cash Count</h3>
          <div class="amount" id="amGrandTotal">$0.00</div>
        </div>
        
        <div class="form-group">
          <label for="amNotes">Notes (Optional):</label>
          <textarea id="amNotes" class="notes-area" placeholder="Any notes for the PM shift..."></textarea>
        </div>
        
        <button class="submit-btn" onclick="submitAM()">Submit AM Count</button>
        <button class="submit-btn" onclick="goHome()" style="background: #6c757d; margin-top: 10px;">Back to Menu</button>
      </div>
      
      <!-- PM Count Form -->
      <div id="pmForm" class="form-section">
        <h2 style="margin-bottom: 20px; color: #1e3c72;">Evening Cash Close</h2>
        
        <div class="form-group">
          <label for="pmDate">Date:</label>
          <input type="date" id="pmDate" class="form-input" required>
        </div>
        
        <div class="form-group">
          <label for="pmCounter">Counted by:</label>
          <select id="pmCounter" class="form-select" onchange="toggleDenominationInputs('pm')" required>
            <option value="">Choose Name</option>
            <option value="Demetri Gregorakis">Demetri Gregorakis</option>
            <option value="Ahmet Can Guler">Ahmet Can Guler</option>
            <option value="Bryan Cox">Bryan Cox</option>
            <option value="Kayla Mccullough">Kayla Mccullough</option>
            <option value="Dilan Uzum">Dilan Uzum</option>
          </select>
        </div>
        
        <!-- AM Total Display -->
        <div id="amTotalDisplay" class="am-total-display">
          <h4>Morning Count Information:</h4>
          <div style="display: flex; justify-content: space-between; margin: 10px 0; font-size: 14px;">
            <span><strong>Counted by:</strong> <span id="amCounterName">Loading...</span></span>
            <span><strong>Time:</strong> <span id="amCountTime">Loading...</span></span>
          </div>
          <div style="text-align: center; margin: 15px 0;">
            <strong>Starting Amount:</strong>
            <div class="amount" id="pmAmTotal" style="font-size: 28px; margin: 5px 0;">Loading...</div>
          </div>
          <div id="amNotesDisplay" style="background: #fff3cd; padding: 12px; border-radius: 6px; margin-top: 15px; border-left: 4px solid #ffc107; display: none;">
            <strong style="color: #856404;">Morning Notes:</strong>
            <div id="amNotes" style="margin-top: 5px; color: #856404;"></div>
          </div>
        </div>
        
        <!-- Drawer 1 -->
        <div class="drawer-section">
          <div class="drawer-header">
            <span>Drawer 1</span>
            <label class="skip-toggle">
              <input type="checkbox" id="pmDrawer1Skip" onchange="toggleSkip('pm', 1)">
              Skip Drawer
            </label>
          </div>
          <div id="pmDrawer1Content" class="drawer-content">
            <div id="pmDrawer1Denoms"></div>
            <div class="drawer-total" id="pmDrawer1Total">$0.00</div>
          </div>
          <div id="pmDrawer1SkipContent" class="skip-content hidden">
            <input type="text" class="skip-reason" id="pmDrawer1Reason" placeholder="Reason for skipping drawer 1">
          </div>
        </div>
        
        <!-- Drawer 2 -->
        <div class="drawer-section">
          <div class="drawer-header">
            <span>Drawer 2</span>
            <label class="skip-toggle">
              <input type="checkbox" id="pmDrawer2Skip" onchange="toggleSkip('pm', 2)">
              Skip Drawer
            </label>
          </div>
          <div id="pmDrawer2Content" class="drawer-content">
            <div id="pmDrawer2Denoms"></div>
            <div class="drawer-total" id="pmDrawer2Total">$0.00</div>
          </div>
          <div id="pmDrawer2SkipContent" class="skip-content hidden">
            <input type="text" class="skip-reason" id="pmDrawer2Reason" placeholder="Reason for skipping drawer 2">
          </div>
        </div>
        
        <div class="grand-total">
          <h3>Total Cash Count</h3>
          <div class="amount" id="pmGrandTotal">$0.00</div>
        </div>
        
        <div class="form-group">
          <label for="toastSales">Toast Cash Sales (exact amount):</label>
          <input type="number" id="toastSales" class="currency-input" placeholder="0.00" step="0.01" min="0" inputmode="decimal" onfocus="this.select()">
        </div>
        
        <div class="form-group">
          <label for="cashTips">Cash Tips (whole number):</label>
          <input type="number" id="cashTips" class="currency-input" placeholder="0" step="1" min="0" inputmode="numeric" pattern="[0-9]*" onfocus="this.select()">
        </div>
        
        <div class="form-group">
          <label for="pmNotes">Notes (Optional):</label>
          <textarea id="pmNotes" class="notes-area" placeholder="Any notes about the day..."></textarea>
        </div>
        
        <button class="submit-btn" onclick="submitPM()">Submit PM Close</button>
        <button class="submit-btn" onclick="goHome()" style="background: #6c757d; margin-top: 10px;">Back to Menu</button>
      </div>
      
      <!-- Elegant Loading Overlay -->
      <div id="loadingOverlay" class="loading-overlay hidden">
        <div class="loading-content">
          <div class="loading-spinner-elegant"></div>
          <h3 id="loadingTitle">Processing...</h3>
          <p id="loadingMessage">Please wait while we process your request</p>
        </div>
      </div>
      
      <!-- AM Success Screen -->
      <div id="amSuccessScreen" class="form-section">
        <div class="success-screen">
          <div class="success-icon">‚úÖ</div>
          <h2>AM Count Submitted!</h2>
          <p class="success-message">Your morning cash count has been successfully recorded and stored.</p>
          <div class="success-details">
            <div class="detail-row">
              <span>Total Counted:</span>
              <span id="amSuccessTotal">$0.00</span>
            </div>
            <div class="detail-row">
              <span>Time Submitted:</span>
              <span id="amSuccessTime">--</span>
            </div>
          </div>
          <button class="submit-btn success-btn" onclick="goHome()">Return to Menu</button>
        </div>
      </div>

      <!-- PM Success Screen -->
      <div id="pmSuccessScreen" class="form-section">
        <div class="success-screen">
          <div class="success-icon">‚úÖ</div>
          <h2>PM Close Completed!</h2>
          <p class="success-message">Evening close successful! Report sent to management.</p>
          
          <div class="deposit-instruction">
            DEPOSIT <span id="depositAmount">$0</span> INTO ENVELOPE
          </div>
          
          <div class="return-instruction">
            RETURN <span id="returnAmount">$0.00</span> TO CASH BOX AND LOCK IN SAFE
          </div>
          
          <button class="submit-btn success-btn" onclick="goHome()">Confirm and Close</button>
        </div>
      </div>

      <!-- Report Success Screen -->
      <div id="reportSuccessScreen" class="form-section">
        <div class="success-screen">
          <div class="success-icon">üìß</div>
          <h2>Report Sent Successfully!</h2>
          <p class="success-message">Daily cash report has been emailed to management.</p>
          <div class="success-details">
            <div class="detail-row">
              <span>Report Date:</span>
              <span id="reportSuccessDate">--</span>
            </div>
            <div class="detail-row">
              <span>Sent At:</span>
              <span id="reportSuccessTime">--</span>
            </div>
          </div>
          <button class="submit-btn success-btn" onclick="goHome()">Return to Menu</button>
        </div>
      </div>
      
      <!-- Reports Section -->
      <div id="reportsForm" class="form-section">
        <h2 style="margin-bottom: 20px; color: #1e3c72;">üìä Historical Reports</h2>
        
        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #1e3c72;">
          <h4 style="margin: 0 0 10px 0; color: #1e3c72;">üìà Business Intelligence Reports</h4>
          <p style="margin: 5px 0; font-size: 14px;">Generate comprehensive reports from your saved weekly data including tip pools, cash reconciliation, and employee performance.</p>
          <p style="margin: 5px 0; font-size: 12px; color: #666;"><strong>Note:</strong> Historical reports can only show data from dates that have been processed in weekly combined reports. Generate a weekly report first to save data to the database.</p>
        </div>
        
        <div class="form-group">
          <label>Report Type:</label>
          <div style="display: flex; gap: 15px; margin: 10px 0;">
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="radio" name="reportType" value="single" checked onchange="toggleReportType()">
              <span>üìÖ Single Day Report</span>
            </label>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="radio" name="reportType" value="weekly" onchange="toggleReportType()">
              <span>üìã Weekly Report (7 days)</span>
            </label>
          </div>
        </div>
        
        <div id="singleDateGroup" class="form-group">
          <label for="reportDate">Select Date:</label>
          <input type="date" id="reportDate" class="form-input" required>
          <div style="margin-top: 5px; font-size: 12px; color: #666;">
            Generate a detailed report for a specific day including cash reconciliation and employee data.
          </div>
        </div>
        
        <div id="weeklyRangeGroup" class="form-group" style="display: none;">
          <label for="savedWeeksDropdown">Select Saved Weekly Report:</label>
          <select id="savedWeeksDropdown" class="form-input" required>
            <option value="">Loading saved reports...</option>
          </select>
          <div style="margin-top: 10px; font-size: 14px; color: #666;">
            <strong>üìã Saved Weekly Reports:</strong> Select from previously generated weekly reports to view the complete summary.
          </div>
        </div>
        
        <button type="button" class="submit-btn" onclick="generateHistoricalReport()" style="background: #1e3c72;">üìÑ Generate Historical Report</button>
        
        <button class="submit-btn" onclick="goHome()" style="background: #6c757d; margin-top: 10px;">Back to Menu</button>
        
        <!-- Report Display Area -->
        <div id="reportDisplay" style="display: none; margin-top: 30px; padding: 20px; border: 2px solid #1e3c72; border-radius: 12px; background: #f8f9fa;">
          <div id="reportContent"></div>
        </div>
      </div>
      
      <!-- Tip Pool Calculator Section -->
      <div id="tipPoolForm" class="form-section">
        <h2 style="margin-bottom: 20px; color: #1e3c72;">Tip Pool Calculator</h2>
        
        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #007bff;">
          <h4 style="margin: 0 0 10px 0; color: #007bff;">Instructions:</h4>
          <p style="margin: 5px 0; font-size: 14px;">1. Upload Labor Summary CSV and Sales Summary ZIP files from Toast</p>
          <p style="margin: 5px 0; font-size: 14px;">2. Select the date range matching your tip pool period</p>
          <p style="margin: 5px 0; font-size: 14px;">3. Enter the actual cash amount counted from envelopes</p>
          <p style="margin: 5px 0; font-size: 14px;">4. System will auto-calculate cash tips (Real Envelope - Toast Cash Sales)</p>
          <p style="margin: 5px 0; font-size: 14px;">5. Enter EZ Cater tips, TDS Driver tips, and your name</p>
          <p style="margin: 5px 0; font-size: 14px; color: #dc3545;"><strong>Note:</strong> This integrates with your weekly cash reports</p>
        </div>
        
        <div class="form-group">
          <label for="laborFile">Labor Summary CSV File:</label>
          <input type="file" id="laborFile" class="form-input" accept=".csv" style="padding: 8px;">
        </div>
        
        <div class="form-group">
          <label for="salesFile">Sales Summary ZIP File:</label>
          <input type="file" id="salesFile" class="form-input" accept=".zip" style="padding: 8px;">
        </div>
        
        <div class="form-group">
          <label for="tipPoolDateRange">Date Range for Cash Sales Calculation:</label>
          <div style="display: flex; gap: 15px; margin: 10px 0;">
            <div style="flex: 1;">
              <label for="tipPoolStartDate" style="font-size: 12px; color: #666;">Start Date:</label>
              <input type="date" id="tipPoolStartDate" class="form-input" onchange="calculateCashTips()">
            </div>
            <div style="flex: 1;">
              <label for="tipPoolEndDate" style="font-size: 12px; color: #666;">End Date:</label>
              <input type="date" id="tipPoolEndDate" class="form-input" onchange="calculateCashTips()">
            </div>
          </div>
          <div style="font-size: 12px; color: #dc3545; margin-top: 5px;">
            <strong>Note:</strong> Should match your tip pool period (max 7 days)
          </div>
        </div>
        
        <div class="form-group">
          <label for="realEnvelopeDeposit">Real Envelope Deposit ($):</label>
          <input type="number" id="realEnvelopeDeposit" class="form-input" step="0.01" placeholder="e.g., 550.23" onchange="calculateCashTips()">
          <div style="font-size: 12px; color: #666; margin-top: 5px;">
            Actual cash amount counted from envelopes
          </div>
        </div>
        
        <div class="form-group">
          <label for="calculatedCashTips">Cash Tips (Auto-Calculated):</label>
          <input type="number" id="calculatedCashTips" class="form-input" step="0.01" readonly style="background: #f8f9fa; color: #666;">
          <div style="font-size: 12px; color: #007bff; margin-top: 5px;">
            <strong>Formula:</strong> Real Envelope Deposit - Toast Cash Sales
          </div>
        </div>
        
        <div class="form-group">
          <label for="ezcaterTips">EZ Cater Tips for the Week ($):</label>
          <input type="number" id="ezcaterTips" class="form-input" step="0.01" placeholder="e.g., 40.00">
        </div>
        
        <div class="form-group">
          <label for="tdsDriverTips">TDS Driver Tips for the Week ($):</label>
          <input type="number" id="tdsDriverTips" class="form-input" step="0.01" placeholder="e.g., 617.69">
        </div>
        
        <div class="form-group">
          <label for="calculatedByName">Tips Calculated By:</label>
          <input type="text" id="calculatedByName" class="form-input" placeholder="Your Full Name">
        </div>
        
        <button class="submit-btn" onclick="calculateTipPool()" style="background: #28a745;">Calculate Tip Pool</button>
        <button class="submit-btn" onclick="downloadTipPoolPDF()" id="tipPoolPdfBtn" style="background: #007bff; margin-left: 10px; display: none;">Download Tip Pool PDF</button>
        <button class="submit-btn" onclick="clearSavedData()" style="background: #dc3545; margin-left: 10px;" title="Clear all saved data and start fresh">Clear Saved Data</button>
        

        
        <!-- Tip Pool Results Display -->
        <div id="tipPoolResults" style="display: none; margin-top: 20px;">
          <div id="tipPoolSummary"></div>
          <div id="tipPoolTable"></div>
          
          <!-- Combined Report Section - Auto-populated -->
          <div id="combinedReportSection" style="display: none; margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px; border: 2px solid #6f42c1;">
            <h4 style="margin: 0 0 15px 0; color: #6f42c1;">üìä Weekly Combined Report</h4>
            <p style="margin: 0 0 15px 0; font-size: 14px; color: #666;">
              Generate a comprehensive weekly summary combining your tip pool calculations with cash count reports.
            </p>
            
            <!-- PDF Upload Options -->
            <div style="margin-bottom: 20px; padding: 15px; background: white; border-radius: 6px; border: 1px solid #ddd;">
              <h5 style="margin: 0 0 10px 0; color: #333;">üìé Attach Additional PDFs (Optional)</h5>
              
              <div style="display: flex; gap: 15px; margin-bottom: 10px;">
                <div style="flex: 1;">
                  <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #555;">üóÇÔ∏è Add Weekly Voids Log:</label>
                  <input type="file" id="voidsLogUpload" accept=".pdf" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <div style="flex: 1;">
                  <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #555;">üìÑ Add Extras:</label>
                  <input type="file" id="extrasUpload" accept=".pdf" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
              </div>
              
              <p style="margin: 5px 0 0 0; font-size: 12px; color: #666;">
                üí° Upload PDFs to include in your weekly report. Order: Generated Report ‚Üí Voids Log ‚Üí Extras
              </p>
            </div>
            
            <div style="display: flex; gap: 15px; align-items: center;">
              <button class="submit-btn" onclick="generateCombinedReport()" style="background: #6f42c1; flex: 1;">üìÑ Generate Combined Weekly Report</button>
            </div>
            
            <!-- Hidden inputs for auto-populated data -->
            <input type="hidden" id="combinedStartDate">
            <input type="hidden" id="combinedEndDate">
            <input type="hidden" id="combinedRealEnvelope">
          </div>
        </div>
        
        <!-- Hidden Tip Pool Report Display for PDF generation -->
        <div id="tipPoolReportDisplay" style="display: none; position: fixed; top: 0; left: 0; width: 800px; background: white; z-index: 9999; opacity: 0; pointer-events: none;">
          <div id="tipPoolReportContent"></div>
        </div>
        
        <!-- Historical Report Results Section -->
        <div id="reportResults" style="display: none; margin-top: 20px;">
          <div id="reportContent"></div>
        </div>
        
        <button class="submit-btn" onclick="goHome()" style="background: #6c757d; margin-top: 10px;">Back to Menu</button>
      </div>
    </div>
  </div>

  <!-- Cashbox Count Section -->
  <div id="cashboxSection" class="form-section main-section">
    <div class="container">
      <div class="form-container" style="max-width: 600px;">
        <h2 style="text-align: center; margin-bottom: 30px; color: #6f42c1;">
          üí∞ Weekly Cashbox Count
        </h2>
        <p style="text-align: center; margin-bottom: 30px; color: #666; font-size: 14px;">
          Count all cash and coins in the cashbox. This will be used for weekly reconciliation.
        </p>

        <div class="form-group">
          <label for="cashboxCounter">Counted by:</label>
          <select id="cashboxCounter" class="form-select" onchange="toggleCashboxDenominationInputs()" required>
            <option value="">Choose Name</option>
            <option value="Demetri Gregorakis">Demetri Gregorakis</option>
            <option value="Ahmet Can Guler">Ahmet Can Guler</option>
            <option value="Bryan Cox">Bryan Cox</option>
            <option value="Kayla Mccullough">Kayla Mccullough</option>
            <option value="Dilan Uzum">Dilan Uzum</option>
            <option value="Other">Other</option>
          </select>
        </div>

        <div class="form-group" id="cashboxOtherNameGroup" style="display: none;">
          <label for="cashboxOtherName">Enter your name:</label>
          <input type="text" id="cashboxOtherName" class="form-input" placeholder="Full Name">
        </div>

        <!-- Denomination Input Section -->
        <div id="cashboxDenominationInputs" style="display: none; margin-top: 20px;">
          <h4 style="color: #6f42c1; margin-bottom: 15px;">üíµ Count by Denomination</h4>
          
          <!-- Bills Section -->
          <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
            <h5 style="color: #495057; margin-bottom: 10px;">Bills</h5>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px;">
              <div class="denomination-group">
                <label>$100 bills:</label>
                <input type="number" id="cashbox_hundreds" class="form-input" min="0" value="0" onchange="calculateCashboxTotal()">
              </div>
              <div class="denomination-group">
                <label>$50 bills:</label>
                <input type="number" id="cashbox_fifties" class="form-input" min="0" value="0" onchange="calculateCashboxTotal()">
              </div>
              <div class="denomination-group">
                <label>$20 bills:</label>
                <input type="number" id="cashbox_twenties" class="form-input" min="0" value="0" onchange="calculateCashboxTotal()">
              </div>
              <div class="denomination-group">
                <label>$10 bills:</label>
                <input type="number" id="cashbox_tens" class="form-input" min="0" value="0" onchange="calculateCashboxTotal()">
              </div>
              <div class="denomination-group">
                <label>$5 bills:</label>
                <input type="number" id="cashbox_fives" class="form-input" min="0" value="0" onchange="calculateCashboxTotal()">
              </div>
              <div class="denomination-group">
                <label>$1 bills:</label>
                <input type="number" id="cashbox_ones" class="form-input" min="0" value="0" onchange="calculateCashboxTotal()">
              </div>
            </div>
          </div>

          <!-- Coins Section -->
          <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
            <h5 style="color: #495057; margin-bottom: 10px;">Coins</h5>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px;">
              <div class="denomination-group">
                <label>Quarters:</label>
                <input type="number" id="cashbox_quarters" class="form-input" min="0" value="0" onchange="calculateCashboxTotal()">
              </div>
              <div class="denomination-group">
                <label>Dimes:</label>
                <input type="number" id="cashbox_dimes" class="form-input" min="0" value="0" onchange="calculateCashboxTotal()">
              </div>
              <div class="denomination-group">
                <label>Nickels:</label>
                <input type="number" id="cashbox_nickels" class="form-input" min="0" value="0" onchange="calculateCashboxTotal()">
              </div>
              <div class="denomination-group">
                <label>Pennies:</label>
                <input type="number" id="cashbox_pennies" class="form-input" min="0" value="0" onchange="calculateCashboxTotal()">
              </div>
            </div>
          </div>

          <!-- Total Display -->
          <div style="background: #e6f3ff; padding: 20px; border-radius: 8px; text-align: center; border: 2px solid #007bff;">
            <h4 style="margin: 0 0 10px 0; color: #007bff;">Total Cashbox Amount</h4>
            <div id="cashboxTotal" style="font-size: 24px; font-weight: bold; color: #007bff;">$0.00</div>
          </div>

          <!-- Reconciliation Section -->
          <div id="cashboxReconciliation" style="margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 8px; border: 2px solid #ffc107; display: none;">
            <h5 style="color: #856404; margin-bottom: 10px;">üìä Weekly Reconciliation</h5>
            <div id="reconciliationDetails"></div>
          </div>

          <button class="submit-btn" onclick="saveCashboxCount()" style="background: #6f42c1; margin-top: 20px;">Save Cashbox Count</button>
        </div>

        <button class="submit-btn" onclick="goHome()" style="background: #6c757d; margin-top: 20px;">Back to Menu</button>
      </div>
    </div>
  </div>

<script>
  // Configuration
   const SUPABASE_URL = 'https://gaawtbqpnnbbnsyswqwv.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdhYXd0YnFwbm5iYm5zeXN3cXd2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1MDE1NTAsImV4cCI6MjA3MjA3NzU1MH0.F-y7AIQTWaUe7DRT4OnIZVn94mhXxfhpBbng2aJ8nXg';  
  const EMAILJS_CONFIG = {
    PUBLIC_KEY: 'LHbq8j4mlt49O75eo',
    SERVICE_ID: 'service_xm62z73',
    TEMPLATE_ID: 'template_cash_report',
    MANAGER_EMAIL: 'smanager@jaynagyro.com, GSS4168CTJJA73@PRINT.EPSONCONNECT.COM'
  };

  // Elegant Loading and Success Functions
  function showLoading(title, message) {
    const overlay = document.getElementById('loadingOverlay');
    document.getElementById('loadingTitle').textContent = title;
    document.getElementById('loadingMessage').textContent = message;
    overlay.classList.remove('hidden');
    hideAllSections();
  }

  function hideLoading() {
    document.getElementById('loadingOverlay').classList.add('hidden');
  }

  function showAMSuccess(total) {
    hideLoading();
    hideAllSections();
    document.getElementById('amSuccessTotal').textContent = `$${total.toFixed(2)}`;
    document.getElementById('amSuccessTime').textContent = new Date().toLocaleString();
    document.getElementById('amSuccessScreen').classList.add('active');
  }

  function showPMSuccess(depositAmount, returnAmount, discrepancy) {
    hideLoading();
    hideAllSections();
    document.getElementById('depositAmount').textContent = `$${depositAmount}`;
    document.getElementById('returnAmount').textContent = `$${returnAmount.toFixed(2)}`;
    document.getElementById('pmSuccessScreen').classList.add('active');
  }

  function showReportSuccess(date) {
    hideLoading();
    hideAllSections();
    document.getElementById('reportSuccessDate').textContent = date;
    document.getElementById('reportSuccessTime').textContent = new Date().toLocaleString();
    document.getElementById('reportSuccessScreen').classList.add('active');
  }
  
  const DENOMINATIONS = [
    { label: '$100', value: 100.00 },
    { label: '$50', value: 50.00 },
    { label: '$20', value: 20.00 },
    { label: '$10', value: 10.00 },
    { label: '$5', value: 5.00 },
    { label: '$1', value: 1.00 },
    { label: '$0.25', value: 0.25 },
    { label: '$0.10', value: 0.10 },
    { label: '$0.05', value: 0.05 },
    { label: '$0.01', value: 0.01 }
  ];
  
  // Password protection for date changes (only Demetri knows this)
  const ADMIN_PASSWORD = 'JaynaGyro2025!';
  
  let supabase = null;
  let currentAMData = null;
  
  // Initialize app
  document.addEventListener('DOMContentLoaded', function() {
    initializeSupabase();
    initializeEmailJS();
    setTodayDate();
    
    // Load saved data
    loadTipPoolData();
    loadCombinedReportData();
    
    // Removed "App ready" message to prevent page bouncing
  });
  
  function initializeSupabase() {
    if (SUPABASE_URL === 'YOUR_SUPABASE_URL_HERE' || SUPABASE_ANON_KEY === 'YOUR_SUPABASE_ANON_KEY_HERE') {
      showMessage('Please configure Supabase credentials', 'error');
      return;
    }
    try {
      supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      console.log('Supabase initialized');
    } catch (error) {
      console.error('Supabase init failed:', error);
      showMessage('Database connection failed', 'error');
    }
  }
  
  function initializeEmailJS() {
    if (typeof emailjs !== 'undefined') {
      emailjs.init(EMAILJS_CONFIG.PUBLIC_KEY);
    }
  }
  
  function setTodayDate() {
    const today = getPacificDate();
    document.getElementById('amDate').value = today;
    document.getElementById('pmDate').value = today;
    document.getElementById('reportDate').value = today;
    
    // Add password protection to date inputs
    document.getElementById('amDate').addEventListener('change', function() {
      const result = validateDateChange(this);
      if (result instanceof Promise) {
        // Handle async validation - input value already reset if needed
        return;
      }
    });
    
    document.getElementById('pmDate').addEventListener('change', function() {
      const result = validateDateChange(this);
      if (result instanceof Promise) {
        result.then((success) => {
          if (success) {
            // Only load AM data if date change was authorized
            loadAMData();
          }
        });
      } else if (result) {
        // Synchronous case (current date selected)
        loadAMData();
      }
    });
    
    document.getElementById('reportDate').addEventListener('change', function() {
      const result = validateDateChange(this);
      if (result instanceof Promise) {
        // Handle async validation - input value already reset if needed
        return;
      }
    });
  }
  
  function getPacificDate() {
    const now = new Date();
    const pacific = new Date(now.toLocaleString("en-US", {timeZone: "America/Los_Angeles"}));
    const year = pacific.getFullYear();
    const month = String(pacific.getMonth() + 1).padStart(2, '0');
    const day = String(pacific.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
  }
  
  function showMessage(text, type) {
    // Only show popups for important messages (errors), ignore info/success
    if (type === 'error') {
      showPopupMessage(text, type);
    }
    // Silently ignore info and success messages to prevent bouncing
  }
  
  function showPopupMessage(text, type) {
    const messageType = type === 'error' ? 'Error' : type === 'success' ? 'Success' : 'Notice';
    const backgroundColor = type === 'error' ? '#f44336' : '#4CAF50';
    const iconEmoji = type === 'error' ? '‚ùå' : '‚úÖ';
    
    const modalHTML = `
      <div id="messageModal" style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.7);
        z-index: 10000;
        display: flex;
        justify-content: center;
        align-items: center;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      ">
        <div style="
          background: white;
          padding: 30px;
          border-radius: 12px;
          box-shadow: 0 10px 30px rgba(0,0,0,0.3);
          max-width: 400px;
          width: 90%;
          text-align: center;
        ">
          <h3 style="margin: 0 0 20px 0; color: ${backgroundColor};">${iconEmoji} ${messageType}</h3>
          <p style="margin: 0 0 25px 0; line-height: 1.4; font-size: 16px;">
            ${text}
          </p>
          <button onclick="closeMessageModal()" style="
            background: ${backgroundColor};
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
          ">OK</button>
        </div>
      </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
  }
  
  function closeMessageModal() {
    const modal = document.getElementById('messageModal');
    if (modal) {
      modal.remove();
    }
  }
  
  function validateDateChange(inputElement) {
    const selectedDate = inputElement.value;
    const currentDate = getPacificDate();
    
    // If user selects current date, allow it
    if (selectedDate === currentDate) {
      return true;
    }
    
    // If user selects different date, require password using custom modal
    return new Promise((resolve) => {
      showPasswordModal(selectedDate, currentDate, (success) => {
        if (!success) {
          inputElement.value = currentDate;
        }
        resolve(success);
      });
    });
  }
  
  function showPasswordModal(selectedDate, currentDate, callback) {
    // Create modal HTML
    const modalHTML = `
      <div id="passwordModal" style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.7);
        z-index: 10000;
        display: flex;
        justify-content: center;
        align-items: center;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      ">
        <div style="
          background: white;
          padding: 30px;
          border-radius: 12px;
          box-shadow: 0 10px 30px rgba(0,0,0,0.3);
          max-width: 400px;
          width: 90%;
          text-align: center;
        ">
          <h3 style="margin: 0 0 20px 0; color: #d32f2f;">‚ö†Ô∏è Date Change Warning</h3>
          <p style="margin: 0 0 15px 0; line-height: 1.4;">
            You are trying to change the date from<br>
            <strong>TODAY (${currentDate})</strong> to <strong>${selectedDate}</strong>
          </p>
          <p style="margin: 0 0 20px 0; color: #d32f2f; font-weight: bold;">
            This could overwrite existing data!
          </p>
          <p style="margin: 0 0 15px 0;">Enter admin password to continue:</p>
          <input type="password" id="passwordInput" style="
            width: 80%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            text-align: center;
            margin-bottom: 20px;
          " placeholder="Password">
          <div>
            <button onclick="submitPassword()" style="
              background: #4CAF50;
              color: white;
              border: none;
              padding: 10px 20px;
              border-radius: 6px;
              margin: 0 10px;
              cursor: pointer;
              font-size: 16px;
            ">Continue</button>
            <button onclick="cancelPassword()" style="
              background: #f44336;
              color: white;
              border: none;
              padding: 10px 20px;
              border-radius: 6px;
              margin: 0 10px;
              cursor: pointer;
              font-size: 16px;
            ">Cancel</button>
          </div>
        </div>
      </div>
    `;
    
    // Add modal to page
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // Focus password input
    document.getElementById('passwordInput').focus();
    
    // Store callback for button handlers
    window.passwordModalCallback = callback;
    
    // Add enter key support
    document.getElementById('passwordInput').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        submitPassword();
      }
    });
  }
  
  function submitPassword() {
    const password = document.getElementById('passwordInput').value;
    const modal = document.getElementById('passwordModal');
    
    if (password === ADMIN_PASSWORD) {
      // Silent success - no bouncing message
      modal.remove();
      window.passwordModalCallback(true);
    } else {
      showMessage('Incorrect password. Date has been reset to today for safety.', 'error');
      modal.remove();
      window.passwordModalCallback(false);
    }
  }
  
  function cancelPassword() {
    const modal = document.getElementById('passwordModal');
    modal.remove();
    window.passwordModalCallback(false);
  }
  
  function hideAllSections() {
    console.log('hideAllSections() called - this might be hiding tip pool results!');
    console.trace('hideAllSections call stack');
    document.querySelectorAll('.form-section').forEach(section => section.classList.remove('active'));
  }
  
  function goHome() {
    console.log('goHome() called - this will hide tip pool results!');
    console.trace('goHome call stack');
    hideAllSections();
    document.getElementById('mainMenu').style.display = 'grid';
    
    // Reset container width
    const container = document.querySelector('.container');
    if (container) {
      container.style.maxWidth = '600px';
    }
  }
  
  function startAMCount() {
    document.getElementById('mainMenu').style.display = 'none';
    hideAllSections();
    document.getElementById('amForm').classList.add('active');
    setupDenominations('am');
  }
  
  async function startPMCount() {
    // Keep main menu visible at top
    hideAllSections();
    document.getElementById('pmForm').classList.add('active');
    setupDenominations('pm');
    
    await loadAMData();
  }
  
  function showReports() {
    // Keep main menu visible at top
    hideAllSections();
    document.getElementById('reportsForm').classList.add('active');
  }
  
  function showTipPool() {
    // Keep main menu visible at top
    hideAllSections();
    document.getElementById('tipPoolForm').classList.add('active');
    
    // Show results if we have loaded data
    if (tipPoolRecords.length > 0) {
      document.getElementById('tipPoolResults').style.display = 'block';
      document.getElementById('tipPoolPdfBtn').style.display = 'inline-block';
      document.getElementById('combinedReportSection').style.display = 'block';
    }
  }
  
  // ===== CASHBOX FUNCTIONS =====
  
  function showCashbox() {
    // Keep main menu visible at top
    hideAllSections();
    document.getElementById('cashboxSection').classList.add('active');
    loadPreviousCashboxData();
  }
  
  function toggleCashboxDenominationInputs() {
    const counterSelect = document.getElementById('cashboxCounter');
    const otherNameGroup = document.getElementById('cashboxOtherNameGroup');
    const denominationInputs = document.getElementById('cashboxDenominationInputs');
    
    if (counterSelect.value === 'Other') {
      otherNameGroup.style.display = 'block';
    } else {
      otherNameGroup.style.display = 'none';
    }
    
    if (counterSelect.value && counterSelect.value !== '') {
      denominationInputs.style.display = 'block';
    } else {
      denominationInputs.style.display = 'none';
    }
  }
  
  function calculateCashboxTotal() {
    const denominations = [
      { id: 'cashbox_hundreds', value: 100 },
      { id: 'cashbox_fifties', value: 50 },
      { id: 'cashbox_twenties', value: 20 },
      { id: 'cashbox_tens', value: 10 },
      { id: 'cashbox_fives', value: 5 },
      { id: 'cashbox_ones', value: 1 },
      { id: 'cashbox_quarters', value: 0.25 },
      { id: 'cashbox_dimes', value: 0.10 },
      { id: 'cashbox_nickels', value: 0.05 },
      { id: 'cashbox_pennies', value: 0.01 }
    ];
    
    let total = 0;
    denominations.forEach(denom => {
      const count = parseInt(document.getElementById(denom.id).value) || 0;
      total += count * denom.value;
    });
    
    document.getElementById('cashboxTotal').textContent = `$${total.toFixed(2)}`;
    return total;
  }
  
  async function loadPreviousCashboxData() {
    try {
      // Get the most recent cashbox count for reconciliation
      const { data, error } = await supabase
        .from('cashbox_counts')
        .select('*')
        .order('date', { ascending: false })
        .limit(1);
      
      if (error) throw error;
      
      if (data && data.length > 0) {
        const lastCount = data[0];
        showReconciliation(lastCount);
      }
    } catch (error) {
      console.error('Error loading previous cashbox data:', error);
    }
  }
  
  function showReconciliation(lastCount) {
    const reconciliationSection = document.getElementById('cashboxReconciliation');
    const reconciliationDetails = document.getElementById('reconciliationDetails');
    
    const lastDate = new Date(lastCount.date).toLocaleDateString();
    const lastAmount = lastCount.total;
    
    reconciliationDetails.innerHTML = `
      <div style="margin-bottom: 10px;">
        <strong>Previous Cashbox Count:</strong> ${lastDate} - $${lastAmount.toFixed(2)}
      </div>
      <div style="margin-bottom: 10px; font-size: 12px; color: #856404;">
        <strong>Reconciliation Logic:</strong><br>
        Expected This Week = Previous Week + Daily Discrepancies<br>
        <em>Note: AM register loading amounts do not affect total cashbox reconciliation</em>
      </div>
      <div style="font-size: 12px; color: #856404;">
        After entering your count, we'll calculate discrepancies and verify reconciliation.
      </div>
    `;
    
    reconciliationSection.style.display = 'block';
  }
  
  async function saveCashboxCount() {
    try {
      const counterSelect = document.getElementById('cashboxCounter');
      const otherName = document.getElementById('cashboxOtherName').value;
      
      let counterName = counterSelect.value;
      if (counterName === 'Other') {
        counterName = otherName;
      }
      
      if (!counterName) {
        throw new Error('Please select or enter a name');
      }
      
      const total = calculateCashboxTotal();
      if (total === 0) {
        throw new Error('Please enter denomination counts');
      }
      
      const denominations = {
        hundreds: parseInt(document.getElementById('cashbox_hundreds').value) || 0,
        fifties: parseInt(document.getElementById('cashbox_fifties').value) || 0,
        twenties: parseInt(document.getElementById('cashbox_twenties').value) || 0,
        tens: parseInt(document.getElementById('cashbox_tens').value) || 0,
        fives: parseInt(document.getElementById('cashbox_fives').value) || 0,
        ones: parseInt(document.getElementById('cashbox_ones').value) || 0,
        quarters: parseInt(document.getElementById('cashbox_quarters').value) || 0,
        dimes: parseInt(document.getElementById('cashbox_dimes').value) || 0,
        nickels: parseInt(document.getElementById('cashbox_nickels').value) || 0,
        pennies: parseInt(document.getElementById('cashbox_pennies').value) || 0
      };
      
      const { data, error } = await supabase
        .from('cashbox_counts')
        .insert([{
          date: new Date().toISOString().split('T')[0],
          counter: counterName,
          denominations: denominations,
          total: total,
          timestamp: new Date().toISOString()
        }]);
      
      if (error) throw error;
      
      showMessage(`Cashbox count saved successfully! Total: $${total.toFixed(2)}`, 'success');
      
      // Reset form
      document.getElementById('cashboxCounter').value = '';
      document.getElementById('cashboxOtherName').value = '';
      toggleCashboxDenominationInputs();
      
      // Reset all denomination inputs
      Object.keys(denominations).forEach(key => {
        document.getElementById(`cashbox_${key}`).value = '0';
      });
      calculateCashboxTotal();
      
    } catch (error) {
      showMessage(error.message, 'error');
    }
  }
  
  async function saveCashboxCountFromReport(total) {
    try {
      const counterName = tipPoolSummary.calculatedByName || 'Unknown';
      
      const { data, error } = await supabase
        .from('cashbox_counts')
        .insert([{
          date: new Date().toISOString().split('T')[0],
          counter: counterName,
          denominations: { manual_entry: true }, // Mark as manual entry from report
          total: total,
          timestamp: new Date().toISOString(),
          notes: 'Entered during combined report generation'
        }]);
      
      if (error) throw error;
      
      console.log('Cashbox count saved from report:', total);
      
    } catch (error) {
      console.error('Error saving cashbox count from report:', error);
    }
  }
  
  async function getCashboxReconciliation(currentTotal) {
    try {
      // Get the two most recent cashbox counts for comparison
      const { data, error } = await supabase
        .from('cashbox_counts')
        .select('*')
        .order('date', { ascending: false })
        .limit(2);
      
      if (error) throw error;
      
      if (!data || data.length === 0) {
        return {
          isFirstCount: true,
          currentTotal: currentTotal,
          message: 'First cashbox count recorded - baseline established'
        };
      }
      
      if (data.length === 1) {
        return {
          isFirstCount: true,
          currentTotal: currentTotal,
          previousTotal: null,
          message: 'Second cashbox count - reconciliation will begin next week'
        };
      }
      
      const current = data[0]; // Most recent (just saved)
      const previous = data[1]; // Previous week
      
      // Get date range for daily discrepancies between the two cashbox counts
      const startDate = new Date(previous.date);
      const endDate = new Date(current.date);
      
      // Fetch daily discrepancies for the period
      const { data: discrepancyData, error: discrepancyError } = await supabase
        .from('cash_counts')
        .select('pm_discrepancy, date')
        .gte('date', previous.date)
        .lt('date', current.date) // Use < to exclude current date
        .not('pm_discrepancy', 'is', null)
        .order('date', { ascending: true });
      
      if (discrepancyError) throw discrepancyError;
      
      // Calculate total discrepancies for the period
      const totalDiscrepancies = discrepancyData ? 
        discrepancyData.reduce((sum, day) => sum + (day.pm_discrepancy || 0), 0) : 0;
      
      // CORRECT RECONCILIATION FORMULA:
      // Week_N_Ending_Cashbox = Week_N_Starting_Cashbox + Sum(Daily_Discrepancies)
      const expectedEnding = previous.total + totalDiscrepancies;
      const actualVariance = currentTotal - expectedEnding;
      
      return {
        isFirstCount: false,
        currentTotal: currentTotal,
        currentDate: new Date(current.date).toLocaleDateString(),
        previousTotal: previous.total,
        previousDate: new Date(previous.date).toLocaleDateString(),
        totalDiscrepancies: totalDiscrepancies,
        expectedEnding: expectedEnding,
        actualVariance: actualVariance,
        discrepancyDays: discrepancyData ? discrepancyData.length : 0,
        reconciliationStatus: Math.abs(actualVariance) < 0.01 ? 'BALANCED' : 
                             actualVariance > 0 ? 'OVERAGE' : 'SHORTAGE',
        message: Math.abs(actualVariance) < 0.01 ? 
                'Perfect reconciliation! Cashbox balances correctly.' :
                actualVariance > 0 ? 
                `Unexplained overage of $${actualVariance.toFixed(2)}` :
                `Unexplained shortage of $${Math.abs(actualVariance).toFixed(2)}`
      };
      
    } catch (error) {
      console.error('Error getting cashbox reconciliation:', error);
      return null;
    }
  }
  
  function setupDenominations(shift) {
    [1, 2].forEach(drawer => {
      const container = document.getElementById(`${shift}Drawer${drawer}Denoms`);
      container.innerHTML = '';
      
      DENOMINATIONS.forEach((denom, index) => {
        const row = document.createElement('div');
        row.className = 'denom-row';
        row.innerHTML = `
          <div>
            <div class="denom-label">${denom.label}</div>
            <div class="denom-value" id="${shift}D${drawer}V${index}">0 √ó $${denom.value.toFixed(2)} = $0.00</div>
          </div>
          <input type="number" class="qty-input" id="${shift}D${drawer}Q${index}" 
                 min="0" step="1" value="0" 
                 inputmode="numeric" pattern="[0-9]*"
                 oninput="updateCalculations('${shift}', ${drawer})" 
                 onfocus="this.select()">
        `;
        container.appendChild(row);
      });
    });
    
    // Apply disabled state based on current name selection
    toggleDenominationInputs(shift);
  }
  
  function toggleSkip(shift, drawer) {
    const skipBox = document.getElementById(`${shift}Drawer${drawer}Skip`);
    const content = document.getElementById(`${shift}Drawer${drawer}Content`);
    const skipContent = document.getElementById(`${shift}Drawer${drawer}SkipContent`);
    
    if (skipBox.checked) {
      content.classList.add('hidden');
      skipContent.classList.remove('hidden');
    } else {
      content.classList.remove('hidden');
      skipContent.classList.add('hidden');
    }
    updateCalculations(shift, drawer);
  }
  
  function toggleDenominationInputs(shift) {
    const counterSelect = document.getElementById(`${shift}Counter`);
    if (!counterSelect) return; // Safety check
    
    const hasName = counterSelect.value.trim() !== '';
    
    // Toggle denomination inputs for both drawers
    for (let drawer = 1; drawer <= 2; drawer++) {
      DENOMINATIONS.forEach((denom, index) => {
        const qtyInput = document.getElementById(`${shift}D${drawer}Q${index}`);
        if (!qtyInput) return; // Safety check
        
        const denomRow = qtyInput.closest('.denom-row');
        if (!denomRow) return; // Safety check
        
        if (hasName) {
          qtyInput.disabled = false;
          denomRow.classList.remove('disabled');
        } else {
          qtyInput.disabled = true;
          qtyInput.value = ''; // Clear any existing values
          denomRow.classList.add('disabled');
        }
      });
      
      // Update calculations after enabling/disabling
      updateCalculations(shift, drawer);
    }
  }
  
  function updateCalculations(shift, drawer) {
    const skipBox = document.getElementById(`${shift}Drawer${drawer}Skip`);
    let drawerTotal = 0;
    
    if (!skipBox.checked) {
      DENOMINATIONS.forEach((denom, index) => {
        const qtyInput = document.getElementById(`${shift}D${drawer}Q${index}`);
        const qty = parseInt(qtyInput.value) || 0;
        const value = qty * denom.value;
        
        document.getElementById(`${shift}D${drawer}V${index}`).textContent = 
          `${qty} √ó $${denom.value.toFixed(2)} = $${value.toFixed(2)}`;
        
        drawerTotal += value;
      });
    }
    
    document.getElementById(`${shift}Drawer${drawer}Total`).textContent = `$${drawerTotal.toFixed(2)}`;
    updateGrandTotal(shift);
  }
  
  function updateGrandTotal(shift) {
    const drawer1Skip = document.getElementById(`${shift}Drawer1Skip`).checked;
    const drawer2Skip = document.getElementById(`${shift}Drawer2Skip`).checked;
    
    const drawer1Total = drawer1Skip ? 0 : parseFloat(document.getElementById(`${shift}Drawer1Total`).textContent.replace('$', ''));
    const drawer2Total = drawer2Skip ? 0 : parseFloat(document.getElementById(`${shift}Drawer2Total`).textContent.replace('$', ''));
    
    const grandTotal = drawer1Total + drawer2Total;
    document.getElementById(`${shift}GrandTotal`).textContent = `$${grandTotal.toFixed(2)}`;
  }
  
  async function loadAMData() {
    const date = document.getElementById('pmDate').value;
    console.log('Loading AM data for date:', date);
    
    if (!date) {
      document.getElementById('pmAmTotal').textContent = 'Please select a date';
      document.getElementById('amCounterName').textContent = 'Please select a date';
      document.getElementById('amCountTime').textContent = 'Please select a date';
      return;
    }
    
    // Show loading state
    document.getElementById('pmAmTotal').textContent = 'Loading...';
    document.getElementById('amCounterName').textContent = 'Loading...';
    document.getElementById('amCountTime').textContent = 'Loading...';
    
    try {
      if (!supabase) {
        throw new Error('Database not connected');
      }
      
      console.log('Querying Supabase for AM data...');
      const amData = await getAMData(date);
      console.log('AM data result:', amData);
      
      if (amData && amData.total > 0) {
        currentAMData = amData;
        document.getElementById('pmAmTotal').textContent = `$${amData.total.toFixed(2)}`;
        
        // FIX: Set AM counter name and timestamp
        document.getElementById('amCounterName').textContent = amData.counter || 'N/A';
        document.getElementById('amCountTime').textContent = amData.timestamp ? new Date(amData.timestamp).toLocaleString() : 'N/A';
        
        // Handle AM notes display
        const amNotesDisplay = document.getElementById('amNotesDisplay');
        const amNotesEl = document.getElementById('amNotes');
        if (amData.notes && amData.notes.trim()) {
          amNotesEl.textContent = amData.notes;
          amNotesDisplay.style.display = 'block';
        } else {
          amNotesDisplay.style.display = 'none';
        }
        
        // Removed "AM data loaded successfully" message to prevent bouncing
      } else {
        currentAMData = null;
        document.getElementById('pmAmTotal').textContent = 'No AM data found';
        document.getElementById('amCounterName').textContent = 'No AM data found';
        document.getElementById('amCountTime').textContent = 'No AM data found';
        const amNotesDisplay = document.getElementById('amNotesDisplay');
        if (amNotesDisplay) amNotesDisplay.style.display = 'none';
        showMessage(`No AM count found for ${date}`, 'error');
      }
    } catch (error) {
      console.error('Error loading AM data:', error);
      document.getElementById('pmAmTotal').textContent = 'Error loading AM data';
      document.getElementById('amCounterName').textContent = 'Error loading AM data';
      document.getElementById('amCountTime').textContent = 'Error loading AM data';
      showMessage(`Error: ${error.message}`, 'error');
    }
  }
  
  function collectFormData(shift) {
    const counter = document.getElementById(`${shift}Counter`).value;
    const date = document.getElementById(`${shift}Date`).value;
    const notes = document.getElementById(`${shift}Notes`).value.trim();
    
    if (!counter) throw new Error('Please select a name');
    if (!date) throw new Error('Please select a date');
    
    const drawer1Skip = document.getElementById(`${shift}Drawer1Skip`).checked;
    const drawer2Skip = document.getElementById(`${shift}Drawer2Skip`).checked;
    
    const drawer1Data = collectDrawerData(shift, 1, drawer1Skip);
    const drawer2Data = collectDrawerData(shift, 2, drawer2Skip);
    
    const data = {
      shift: shift,
      counter: counter,
      date: date,
      timestamp: new Date().toISOString(),
      drawer1: drawer1Data,
      drawer2: drawer2Data,
      drawer1Total: drawer1Data.total, // Add individual drawer totals for email template
      drawer2Total: drawer2Data.total,
      notes: notes || null,
      total: drawer1Data.total + drawer2Data.total
    };
    
    if (shift === 'pm') {
      const toastSales = parseFloat(document.getElementById('toastSales').value) || 0;
      const cashTips = parseInt(document.getElementById('cashTips').value) || 0;
      
      data.toastSales = toastSales;
      data.cashTips = cashTips;
      data.amTotal = currentAMData ? currentAMData.total : 0;
    }
    
    return data;
  }
  
  function collectDrawerData(shift, drawer, skipped) {
    if (skipped) {
      const reason = document.getElementById(`${shift}Drawer${drawer}Reason`).value.trim();
      return {
        skipped: true,
        skipReason: reason || 'No reason provided',
        counts: {},
        total: 0
      };
    }
    
    const counts = {};
    let total = 0;
    
    // Map denomination labels to email template keys
    const denominationKeys = [
      'hundreds',    // $100
      'fifties',     // $50
      'twenties',    // $20
      'tens',        // $10
      'fives',       // $5
      'ones',        // $1
      'quarters',    // $0.25
      'dimes',       // $0.10
      'nickels',     // $0.05
      'pennies'      // $0.01
    ];
    
    DENOMINATIONS.forEach((denom, index) => {
      const qty = parseInt(document.getElementById(`${shift}D${drawer}Q${index}`).value) || 0;
      // Store with both the original label and the email template key
      counts[denom.label] = qty;
      counts[denominationKeys[index]] = qty;
      total += qty * denom.value;
    });
    
    return {
      skipped: false,
      skipReason: null,
      counts: counts,
      total: Math.round(total * 100) / 100
    };
  }
  
  async function submitAM() {
    try {
      showLoading('Submitting AM Count', 'Recording your morning cash count...');
      
      const data = collectFormData('am');
      await storeAMData(data);
      
      // Show elegant success screen
      showAMSuccess(data.total);
      resetForm('am');
      
    } catch (error) {
      hideLoading();
      console.error('AM submission error:', error);
      showMessage(`Error: ${error.message}`, 'error');
    }
  }
  
  async function submitPM() {
    try {
      showLoading('Processing PM Close', 'Calculating totals and sending report to management...');
      
      const data = collectFormData('pm');
      const calculations = calculatePMAmounts(data);
      
      await storePMData(data, calculations);
      await sendEmailReport(data, calculations);
      
      // Show elegant success screen with deposit/return instructions
      showPMSuccess(calculations.depositAmount, calculations.returnAmount, calculations.discrepancy);
      
    } catch (error) {
      hideLoading();
      console.error('PM submission error:', error);
      
      // Check if it's a validation error (these shouldn't reset the form)
      const isValidationError = error.message.includes('Please select') || 
                               error.message.includes('required') ||
                               error.message.includes('name') ||
                               error.message.includes('date');
      
      showMessage(`Error: ${error.message}`, 'error');
      
      // Only redirect home for non-validation errors (like network issues)
      if (!isValidationError) {
        goHome();
      }
    }
  }
  
  function calculatePMAmounts(data) {
    const amTotal = data.amTotal;
    const pmTotal = data.total;
    const toastSales = data.toastSales;
    const cashTips = data.cashTips;
    
    // Drawer change = PM - AM
    const drawerChange = pmTotal - amTotal;
    
    // Actual cash in
    const actualCashIn = drawerChange;
    
    // Expected vs actual (Toast sales vs actual cash in)
    const discrepancy = actualCashIn - toastSales;
    
    // Step 1: Calculate raw deposit amount
    const rawDepositAmount = toastSales + cashTips;
    
    // Step 2: Round deposit to whole dollars (what staff actually deposits)
    const depositAmount = Math.round(rawDepositAmount);
    
    // Step 3: Calculate deposit rounding adjustment needed
    const depositRoundingAdjustment = depositAmount - rawDepositAmount;
    
    // Step 4: Handle deposit rounding with whole dollar tip adjustments
    let depositTipAdjustment = 0;
    let depositExcessToCashbox = 0;
    
    if (depositRoundingAdjustment > 0) {
      // Need extra money for rounding - take whole dollars from tips
      depositTipAdjustment = Math.ceil(depositRoundingAdjustment);
      depositExcessToCashbox = depositTipAdjustment - depositRoundingAdjustment;
    } else if (depositRoundingAdjustment < 0) {
      // Deposit rounded down - staff keeps the rounding benefit
      depositExcessToCashbox = Math.abs(depositRoundingAdjustment);
    }
    
    // Step 5: Handle shortage/overage adjustments with whole dollars
    let shortageTipAdjustment = 0;
    let shortageExcessToCashbox = 0;
    
    if (discrepancy < 0) {
      // SHORTAGE: Take whole dollars from tips to cover shortage
      const shortageAmount = Math.abs(discrepancy);
      shortageTipAdjustment = Math.ceil(shortageAmount);
      shortageExcessToCashbox = shortageTipAdjustment - shortageAmount;
    }
    
    // Step 6: Calculate final tip amounts
    const totalTipAdjustment = depositTipAdjustment + shortageTipAdjustment;
    let finalCashTips = cashTips - totalTipAdjustment;
    
    // Ensure tips don't go negative
    if (finalCashTips < 0) {
      const shortfall = Math.abs(finalCashTips);
      finalCashTips = 0;
      // Add shortfall to what business owes staff (tracked but not paid)
    }
    
    // Final tips are always whole dollars (floor any remaining decimals)
    const adjustedTips = Math.floor(finalCashTips);
    const tipDecimalRemainder = finalCashTips - adjustedTips;
    
    // Step 7: Calculate return amount to cashbox
    let returnAmount = amTotal;
    
    // Add overage to cashbox
    if (discrepancy > 0) {
      returnAmount += discrepancy;
    }
    
    // Add all excess amounts to cashbox
    returnAmount += depositExcessToCashbox + shortageExcessToCashbox + tipDecimalRemainder;
    
    return {
      amTotal,
      pmTotal,
      drawerChange,
      actualCashIn,
      toastSales,
      cashTips, // Original tips reported
      discrepancy,
      tipAdjustment: totalTipAdjustment, // Total amount taken from tips
      adjustedTips, // Final whole dollar tips
      depositAmount, // Rounded deposit amount (what staff deposits)
      returnAmount, // What goes back to cashbox
      drawerOver: discrepancy > 0 ? discrepancy : 0,
      drawerShort: discrepancy < 0 ? Math.abs(discrepancy) : 0,
      restaurantOwed: toastSales, // Exact Toast sales amount
      staffOwed: adjustedTips, // Final tips after adjustment
      // New fields for tracking the logic
      rawDepositAmount, // Original exact deposit amount
      depositRoundingAdjustment, // How much rounding was needed
      depositTipAdjustment, // Whole dollars taken from tips for rounding
      depositExcessToCashbox, // Excess from deposit rounding adjustments
      shortageTipAdjustment, // Whole dollars taken from tips for shortage
      shortageExcessToCashbox, // Excess from shortage adjustments
      tipDecimalRemainder // Decimal remainder from final tip flooring
    };
  }
  
  async function storeAMData(data) {
    if (!supabase) throw new Error('Database not connected');
    
    const { error } = await supabase
      .from('cash_counts')
      .upsert({
        date: data.date,
        am_counter: data.counter,
        am_timestamp: data.timestamp,
        am_total: data.total,
        am_drawer1_total: data.drawer1.total,
        am_drawer1_skip: data.drawer1.skipped,
        am_drawer1_skip_reason: data.drawer1.skipReason,
        am_drawer1_data: data.drawer1.counts,
        am_drawer2_total: data.drawer2.total,
        am_drawer2_skip: data.drawer2.skipped,
        am_drawer2_skip_reason: data.drawer2.skipReason,
        am_drawer2_data: data.drawer2.counts,
        am_notes: data.notes
      });
    
    if (error) throw new Error(`Database error: ${error.message}`);
  }
  
  async function storePMData(data, calculations) {
    if (!supabase) throw new Error('Database not connected');
    
    const { error } = await supabase
      .from('cash_counts')
      .update({
        pm_counter: data.counter,
        pm_timestamp: data.timestamp,
        pm_total: data.total,
        pm_cash_tips: data.cashTips,
        pm_toast_sales: data.toastSales,
        pm_drawer1_total: data.drawer1.total,
        pm_drawer1_skip: data.drawer1.skipped,
        pm_drawer1_skip_reason: data.drawer1.skipReason,
        pm_drawer1_data: data.drawer1.counts,
        pm_drawer2_total: data.drawer2.total,
        pm_drawer2_skip: data.drawer2.skipped,
        pm_drawer2_skip_reason: data.drawer2.skipReason,
        pm_drawer2_data: data.drawer2.counts,
        pm_notes: data.notes,
        pm_discrepancy: calculations.discrepancy,
        pm_adjusted_tips: calculations.adjustedTips,
        pm_drawer_over_amount: calculations.drawerOver,
        pm_deposit_amount: calculations.depositAmount,
        pm_amount_to_keep: calculations.returnAmount
      })
      .eq('date', data.date);
    
    if (error) throw new Error(`Database error: ${error.message}`);
  }
  
  async function getAMData(date) {
    if (!supabase) return null;
    
    const { data, error } = await supabase
      .from('cash_counts')
      .select('*')
      .eq('date', date)
      .single();
    
    if (error || !data || !data.am_total) return null;
    
    return {
      date: data.date,
      counter: data.am_counter,
      timestamp: data.am_timestamp,
      total: data.am_total,
      drawer1: {
        total: data.am_drawer1_total,
        skipped: data.am_drawer1_skip,
        skipReason: data.am_drawer1_skip_reason,
        counts: data.am_drawer1_data
      },
      drawer2: {
        total: data.am_drawer2_total,
        skipped: data.am_drawer2_skip,
        skipReason: data.am_drawer2_skip_reason,
        counts: data.am_drawer2_data
      },
      notes: data.am_notes
    };
  }
  
  async function sendEmailReport(data, calculations) {
    // Format date with day of the week
    const dateObj = new Date(data.date + 'T00:00:00');
    const dayOfWeek = dateObj.toLocaleDateString('en-US', { weekday: 'long' }).toUpperCase();
    const formattedDate = dateObj.toLocaleDateString('en-US', { 
      year: 'numeric', 
      month: 'long', 
      day: 'numeric' 
    }).toUpperCase();
    
    const templateParams = {
      to_email: EMAILJS_CONFIG.MANAGER_EMAIL,
      date: data.date,
      day_of_week: dayOfWeek,
      formatted_date: formattedDate,
      am_counter: currentAMData ? currentAMData.counter : 'N/A',
      counter: data.counter, // PM counter (was pm_counter)
      am_timestamp: currentAMData ? new Date(currentAMData.timestamp).toLocaleString() : 'N/A',
      pm_timestamp: new Date(data.timestamp).toLocaleString(),
      am_total: calculations.amTotal.toFixed(2),
      pm_total: calculations.pmTotal.toFixed(2),
      total_cash: calculations.pmTotal.toFixed(2), // Template expects total_cash
      drawer_change: calculations.drawerChange.toFixed(2),
      actual_cash_in: calculations.actualCashIn.toFixed(2),
      toast_sales: calculations.toastSales.toFixed(2),
      original_tips: calculations.cashTips.toFixed(2),
      discrepancy: Math.abs(calculations.discrepancy).toFixed(2),
      discrepancy_direction: calculations.discrepancy >= 0 ? 'Over' : 'Short',
      discrepancy_sign: calculations.discrepancy >= 0 ? '+' : '-',
      large_discrepancy_flag: Math.abs(calculations.discrepancy) > 10 ? ' ‚ö†Ô∏è LARGE DISCREPANCY!' : '',
      tip_adjustment: (calculations.shortageTipAdjustment || 0) > 0 ? (calculations.shortageTipAdjustment || 0).toFixed(2) : null,
      adjusted_tips: calculations.adjustedTips.toString(), // Whole dollars only
      deposit_amount: calculations.depositAmount.toString(), // Already rounded to whole dollar
      amount_to_keep: calculations.returnAmount.toFixed(2), // Template expects amount_to_keep
      return_breakdown: (calculations.returnAmount - calculations.amTotal).toFixed(2),
      drawer_over: calculations.drawerOver.toFixed(2),
      drawer_short: calculations.drawerShort.toFixed(2),
      am_notes: currentAMData ? (currentAMData.notes || '') : '',
      notes: data.notes || '', // Template expects notes (not pm_notes)
      has_discrepancy: calculations.discrepancy !== 0 ? 'true' : 'false',
      // Add drawer breakdown for comparison table
      has_am_comparison: currentAMData ? 'true' : 'false',
      am_drawer1_total: currentAMData ? currentAMData.drawer1.total.toFixed(2) : '0.00',
      am_drawer2_total: currentAMData ? currentAMData.drawer2.total.toFixed(2) : '0.00',
      pm_drawer1_total: data.drawer1Total.toFixed(2),
      pm_drawer2_total: data.drawer2Total.toFixed(2),
      am_grand_total: calculations.amTotal.toFixed(2),
      pm_grand_total: calculations.pmTotal.toFixed(2),
      // Manager breakdown fields
      restaurant_owed: calculations.toastSales.toFixed(2),
      staff_owed: calculations.adjustedTips.toString(), // Whole dollars only
      total_accounted: (calculations.toastSales + calculations.adjustedTips).toFixed(2),
      
      // Deposit rounding breakdown fields
      raw_deposit_amount: calculations.rawDepositAmount ? calculations.rawDepositAmount.toFixed(2) : null,
      deposit_rounding_adjustment: calculations.depositRoundingAdjustment ? calculations.depositRoundingAdjustment.toFixed(2) : null,
      deposit_tip_adjustment: calculations.depositTipAdjustment ? calculations.depositTipAdjustment.toFixed(2) : null,
      deposit_excess_to_cashbox: calculations.depositExcessToCashbox ? calculations.depositExcessToCashbox.toFixed(2) : null,
      has_deposit_rounding: (calculations.depositRoundingAdjustment && Math.abs(calculations.depositRoundingAdjustment) > 0) ? 'true' : 'false',
      
      // AM Drawer 1 denomination breakdown
      am_drawer1_100: currentAMData ? (currentAMData.drawer1.counts.hundreds || 0) : 0,
      am_drawer1_100_total: currentAMData ? ((currentAMData.drawer1.counts.hundreds || 0) * 100).toFixed(2) : '0.00',
      am_drawer1_50: currentAMData ? (currentAMData.drawer1.counts.fifties || 0) : 0,
      am_drawer1_50_total: currentAMData ? ((currentAMData.drawer1.counts.fifties || 0) * 50).toFixed(2) : '0.00',
      am_drawer1_20: currentAMData ? (currentAMData.drawer1.counts.twenties || 0) : 0,
      am_drawer1_20_total: currentAMData ? ((currentAMData.drawer1.counts.twenties || 0) * 20).toFixed(2) : '0.00',
      am_drawer1_10: currentAMData ? (currentAMData.drawer1.counts.tens || 0) : 0,
      am_drawer1_10_total: currentAMData ? ((currentAMData.drawer1.counts.tens || 0) * 10).toFixed(2) : '0.00',
      am_drawer1_5: currentAMData ? (currentAMData.drawer1.counts.fives || 0) : 0,
      am_drawer1_5_total: currentAMData ? ((currentAMData.drawer1.counts.fives || 0) * 5).toFixed(2) : '0.00',
      am_drawer1_1: currentAMData ? (currentAMData.drawer1.counts.ones || 0) : 0,
      am_drawer1_1_total: currentAMData ? ((currentAMData.drawer1.counts.ones || 0) * 1).toFixed(2) : '0.00',
      am_drawer1_quarter: currentAMData ? (currentAMData.drawer1.counts.quarters || 0) : 0,
      am_drawer1_quarter_total: currentAMData ? ((currentAMData.drawer1.counts.quarters || 0) * 0.25).toFixed(2) : '0.00',
      am_drawer1_dime: currentAMData ? (currentAMData.drawer1.counts.dimes || 0) : 0,
      am_drawer1_dime_total: currentAMData ? ((currentAMData.drawer1.counts.dimes || 0) * 0.10).toFixed(2) : '0.00',
      am_drawer1_nickel: currentAMData ? (currentAMData.drawer1.counts.nickels || 0) : 0,
      am_drawer1_nickel_total: currentAMData ? ((currentAMData.drawer1.counts.nickels || 0) * 0.05).toFixed(2) : '0.00',
      am_drawer1_penny: currentAMData ? (currentAMData.drawer1.counts.pennies || 0) : 0,
      am_drawer1_penny_total: currentAMData ? ((currentAMData.drawer1.counts.pennies || 0) * 0.01).toFixed(2) : '0.00',
      
      // AM Drawer 2 denomination breakdown
      am_drawer2_100: currentAMData ? (currentAMData.drawer2.counts.hundreds || 0) : 0,
      am_drawer2_100_total: currentAMData ? ((currentAMData.drawer2.counts.hundreds || 0) * 100).toFixed(2) : '0.00',
      am_drawer2_50: currentAMData ? (currentAMData.drawer2.counts.fifties || 0) : 0,
      am_drawer2_50_total: currentAMData ? ((currentAMData.drawer2.counts.fifties || 0) * 50).toFixed(2) : '0.00',
      am_drawer2_20: currentAMData ? (currentAMData.drawer2.counts.twenties || 0) : 0,
      am_drawer2_20_total: currentAMData ? ((currentAMData.drawer2.counts.twenties || 0) * 20).toFixed(2) : '0.00',
      am_drawer2_10: currentAMData ? (currentAMData.drawer2.counts.tens || 0) : 0,
      am_drawer2_10_total: currentAMData ? ((currentAMData.drawer2.counts.tens || 0) * 10).toFixed(2) : '0.00',
      am_drawer2_5: currentAMData ? (currentAMData.drawer2.counts.fives || 0) : 0,
      am_drawer2_5_total: currentAMData ? ((currentAMData.drawer2.counts.fives || 0) * 5).toFixed(2) : '0.00',
      am_drawer2_1: currentAMData ? (currentAMData.drawer2.counts.ones || 0) : 0,
      am_drawer2_1_total: currentAMData ? ((currentAMData.drawer2.counts.ones || 0) * 1).toFixed(2) : '0.00',
      am_drawer2_quarter: currentAMData ? (currentAMData.drawer2.counts.quarters || 0) : 0,
      am_drawer2_quarter_total: currentAMData ? ((currentAMData.drawer2.counts.quarters || 0) * 0.25).toFixed(2) : '0.00',
      am_drawer2_dime: currentAMData ? (currentAMData.drawer2.counts.dimes || 0) : 0,
      am_drawer2_dime_total: currentAMData ? ((currentAMData.drawer2.counts.dimes || 0) * 0.10).toFixed(2) : '0.00',
      am_drawer2_nickel: currentAMData ? (currentAMData.drawer2.counts.nickels || 0) : 0,
      am_drawer2_nickel_total: currentAMData ? ((currentAMData.drawer2.counts.nickels || 0) * 0.05).toFixed(2) : '0.00',
      am_drawer2_penny: currentAMData ? (currentAMData.drawer2.counts.pennies || 0) : 0,
      am_drawer2_penny_total: currentAMData ? ((currentAMData.drawer2.counts.pennies || 0) * 0.01).toFixed(2) : '0.00',
      
      // PM Drawer 1 denomination breakdown
      pm_drawer1_100: data.drawer1.counts.hundreds || 0,
      pm_drawer1_100_total: ((data.drawer1.counts.hundreds || 0) * 100).toFixed(2),
      pm_drawer1_50: data.drawer1.counts.fifties || 0,
      pm_drawer1_50_total: ((data.drawer1.counts.fifties || 0) * 50).toFixed(2),
      pm_drawer1_20: data.drawer1.counts.twenties || 0,
      pm_drawer1_20_total: ((data.drawer1.counts.twenties || 0) * 20).toFixed(2),
      pm_drawer1_10: data.drawer1.counts.tens || 0,
      pm_drawer1_10_total: ((data.drawer1.counts.tens || 0) * 10).toFixed(2),
      pm_drawer1_5: data.drawer1.counts.fives || 0,
      pm_drawer1_5_total: ((data.drawer1.counts.fives || 0) * 5).toFixed(2),
      pm_drawer1_1: data.drawer1.counts.ones || 0,
      pm_drawer1_1_total: ((data.drawer1.counts.ones || 0) * 1).toFixed(2),
      pm_drawer1_quarter: data.drawer1.counts.quarters || 0,
      pm_drawer1_quarter_total: ((data.drawer1.counts.quarters || 0) * 0.25).toFixed(2),
      pm_drawer1_dime: data.drawer1.counts.dimes || 0,
      pm_drawer1_dime_total: ((data.drawer1.counts.dimes || 0) * 0.10).toFixed(2),
      pm_drawer1_nickel: data.drawer1.counts.nickels || 0,
      pm_drawer1_nickel_total: ((data.drawer1.counts.nickels || 0) * 0.05).toFixed(2),
      pm_drawer1_penny: data.drawer1.counts.pennies || 0,
      pm_drawer1_penny_total: ((data.drawer1.counts.pennies || 0) * 0.01).toFixed(2),
      
      // PM Drawer 2 denomination breakdown
      pm_drawer2_100: data.drawer2.counts.hundreds || 0,
      pm_drawer2_100_total: ((data.drawer2.counts.hundreds || 0) * 100).toFixed(2),
      pm_drawer2_50: data.drawer2.counts.fifties || 0,
      pm_drawer2_50_total: ((data.drawer2.counts.fifties || 0) * 50).toFixed(2),
      pm_drawer2_20: data.drawer2.counts.twenties || 0,
      pm_drawer2_20_total: ((data.drawer2.counts.twenties || 0) * 20).toFixed(2),
      pm_drawer2_10: data.drawer2.counts.tens || 0,
      pm_drawer2_10_total: ((data.drawer2.counts.tens || 0) * 10).toFixed(2),
      pm_drawer2_5: data.drawer2.counts.fives || 0,
      pm_drawer2_5_total: ((data.drawer2.counts.fives || 0) * 5).toFixed(2),
      pm_drawer2_1: data.drawer2.counts.ones || 0,
      pm_drawer2_1_total: ((data.drawer2.counts.ones || 0) * 1).toFixed(2),
      pm_drawer2_quarter: data.drawer2.counts.quarters || 0,
      pm_drawer2_quarter_total: ((data.drawer2.counts.quarters || 0) * 0.25).toFixed(2),
      pm_drawer2_dime: data.drawer2.counts.dimes || 0,
      pm_drawer2_dime_total: ((data.drawer2.counts.dimes || 0) * 0.10).toFixed(2),
      pm_drawer2_nickel: data.drawer2.counts.nickels || 0,
      pm_drawer2_nickel_total: ((data.drawer2.counts.nickels || 0) * 0.05).toFixed(2),
      pm_drawer2_penny: data.drawer2.counts.pennies || 0,
      pm_drawer2_penny_total: ((data.drawer2.counts.pennies || 0) * 0.01).toFixed(2)
    };
    
    const response = await emailjs.send(
      EMAILJS_CONFIG.SERVICE_ID,
      EMAILJS_CONFIG.TEMPLATE_ID,
      templateParams
    );
    
    if (!response.status === 200) {
      throw new Error('Email send failed');
    }
  }
  
  async function generateReport() {
    const date = document.getElementById('reportDate').value;
    if (!date) {
      showMessage('Please select a date', 'error');
      return;
    }

    try {
      showLoading('Generating Report', 'Creating email report for management...');
      
      const amData = await getAMData(date);
      if (!amData) {
        throw new Error('No data found for this date');
      }
      
      // For report generation, we'll use stored PM data or create a basic report
      const { data: fullData } = await supabase
        .from('cash_counts')
        .select('*')
        .eq('date', date)
        .single();
      
      if (fullData && fullData.pm_total) {
        // Full day report - recalculate using the same logic as PM flow
        const reportData = {
          date: date,
          counter: fullData.pm_counter,
          total: fullData.pm_total,
          toastSales: fullData.pm_toast_sales,
          cashTips: fullData.pm_cash_tips,
          amTotal: fullData.am_total,
          notes: fullData.pm_notes
        };
        
        // Use same calculation function as PM flow for consistency
        const calculations = calculatePMAmounts({
          amTotal: fullData.am_total,
          total: fullData.pm_total,
          toastSales: fullData.pm_toast_sales,
          cashTips: fullData.pm_cash_tips
        });
        
        currentAMData = amData;
        await sendEmailReport(reportData, calculations);
      } else {
        throw new Error('Incomplete data for this date');
      }
      
      // Show elegant success screen
      showReportSuccess(date);
      
    } catch (error) {
      hideLoading();
      console.error('Report generation error:', error);
      showMessage(`Error: ${error.message}`, 'error');
    }
  }
  
  // New Report Functions
  function toggleReportType() {
    const reportType = document.querySelector('input[name="reportType"]:checked').value;
    const singleGroup = document.getElementById('singleDateGroup');
    const weeklyGroup = document.getElementById('weeklyRangeGroup');
    
    if (reportType === 'single') {
      singleGroup.style.display = 'block';
      weeklyGroup.style.display = 'none';
    } else {
      singleGroup.style.display = 'none';
      weeklyGroup.style.display = 'block';
      // Load saved weeks when weekly report is selected
      loadSavedWeeks();
    }
  }

  // Load Saved Weekly Reports for Dropdown
  async function loadSavedWeeks() {
    const dropdown = document.getElementById('savedWeeksDropdown');
    
    try {
      dropdown.innerHTML = '<option value="">Loading saved reports...</option>';
      
      if (!supabase) {
        dropdown.innerHTML = '<option value="">Database connection not available</option>';
        return;
      }

      const { data: savedReports, error } = await supabase
        .from('weekly_combined_reports')
        .select('id, week_start_date, week_end_date, generated_by, generated_at')
        .order('week_start_date', { ascending: false });

      if (error) {
        console.error('Error loading saved reports:', error);
        dropdown.innerHTML = '<option value="">Error loading reports</option>';
        return;
      }

      if (!savedReports || savedReports.length === 0) {
        dropdown.innerHTML = '<option value="">No saved weekly reports found. Generate a weekly combined report first.</option>';
        return;
      }

      // Populate dropdown with saved reports
      dropdown.innerHTML = '<option value="">Select a saved weekly report...</option>';
      
      savedReports.forEach(report => {
        const startDate = new Date(report.week_start_date).toLocaleDateString();
        const endDate = new Date(report.week_end_date).toLocaleDateString();
        const generatedDate = new Date(report.generated_at).toLocaleDateString();
        
        const option = document.createElement('option');
        option.value = report.id;
        option.textContent = `Week of ${startDate} - ${endDate} (Generated: ${generatedDate})`;
        dropdown.appendChild(option);
      });

    } catch (error) {
      console.error('Error in loadSavedWeeks:', error);
      dropdown.innerHTML = '<option value="">Error loading reports</option>';
    }
  }

  // Generate Historical Report from Database
  async function generateHistoricalReport() {
    const reportTypeElement = document.querySelector('input[name="reportType"]:checked');
    
    if (!reportTypeElement) {
      alert('Please select a report type (Daily or Weekly)');
      return;
    }
    
    const reportType = reportTypeElement.value;
    console.log('Generate Historical Report - Report type:', reportType);
    
    try {
      showLoading('Generating Historical Report', 'Retrieving data from database...');
      
      if (reportType === 'single') {
        await generateSingleDayHistoricalReport();
      } else {
        await generateWeeklyHistoricalReport();
      }
      
      hideLoading();
      showSuccessMessage('Historical report generated successfully!', 'reportsForm');
      
    } catch (error) {
      hideLoading();
      showErrorMessage('Error generating historical report: ' + error.message, 'reportsForm');
      console.error('Historical report error:', error);
    }
  }

  // Generate Single Day Historical Report
  async function generateSingleDayHistoricalReport() {
    const reportDate = document.getElementById('reportDate').value;
    
    if (!reportDate) {
      throw new Error('Please select a date for the report');
    }
    
    if (!supabase) {
      throw new Error('Database connection not available');
    }
    
    // Query for daily breakdown data
    const { data: dailyData, error: dailyError } = await supabase
      .from('weekly_daily_breakdown')
      .select(`
        *,
        weekly_combined_reports!inner(
          week_start_date,
          week_end_date,
          generated_by,
          total_toast_sales,
          actual_cash_in,
          total_discrepancy
        )
      `)
      .eq('date', reportDate);
    
    if (dailyError) {
      console.error('Database error details:', dailyError);
      throw new Error(`Database query failed: ${dailyError.message}`);
    }
    
    if (!dailyData || dailyData.length === 0) {
      throw new Error(`No data found for ${reportDate}. You need to generate a weekly combined report that includes this date first. The historical reports can only show data from dates that have been processed in weekly reports.`);
    }
    
    // Generate PDF for single day
    await generateSingleDayPDF(dailyData[0], reportDate);
  }

  // Generate Weekly Historical Report
  async function generateWeeklyHistoricalReport() {
    const reportId = document.getElementById('savedWeeksDropdown').value;
    
    console.log('Selected report ID:', reportId);
    
    if (!reportId) {
      throw new Error('Please select a saved weekly report from the dropdown');
    }
    
    if (!supabase) {
      throw new Error('Database connection not available');
    }
    
    // Get the saved report data including the generated HTML content
    const { data: reportData, error: reportError } = await supabase
      .from('weekly_combined_reports')
      .select('*')
      .eq('id', reportId)
      .single();
    
    if (reportError) {
      console.error('Report query error:', reportError);
      throw new Error(`Failed to load report: ${reportError.message}`);
    }
    
    if (!reportData) {
      throw new Error('Report not found');
    }
    
    console.log('Retrieved report data:', reportData);
    console.log('Has cash HTML:', !!reportData.generated_cash_report_html);
    console.log('Has tip pool HTML:', !!reportData.generated_tip_pool_html);
    
    // Display the saved HTML content directly
    const reportContent = document.getElementById('reportContent');
    
    console.log('About to set report content...');
    console.log('Report data keys:', Object.keys(reportData));
    console.log('Cash HTML length:', reportData.generated_cash_report_html?.length || 0);
    console.log('Tip pool HTML length:', reportData.generated_tip_pool_html?.length || 0);
    
    if (reportData.generated_cash_report_html && reportData.generated_tip_pool_html) {
      // We have saved HTML content - display it in the main content area like tip pool results!
      const mainContentHtml = `
        <div style="max-width: 1200px; margin: 0 auto; padding: 20px;">
          <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #28a745;">
            <h3 style="margin: 0 0 10px 0; color: #28a745;">üìÑ Historical Report Retrieved</h3>
            <p style="margin: 0; font-size: 14px;">Report for: ${new Date(reportData.week_start_date).toLocaleDateString()} - ${new Date(reportData.week_end_date).toLocaleDateString()}</p>
            <p style="margin: 0; font-size: 14px;">Generated by: ${reportData.generated_by} on ${new Date(reportData.generated_at).toLocaleDateString()}</p>
            <div style="text-align: center; margin-top: 15px;">
              <button class="submit-btn" onclick="downloadHistoricalReportPDF('${reportData.week_start_date}', '${reportData.week_end_date}')" style="background: #28a745; margin-right: 10px;">üìÑ Download PDF</button>
              <button class="submit-btn" onclick="goHome()" style="background: #6c757d;">Back to Menu</button>
            </div>
          </div>
          
          <div style="margin-bottom: 30px;">
            <h3 style="color: #1e3c72; margin-bottom: 15px; border-bottom: 2px solid #1e3c72; padding-bottom: 5px;">WEEKLY CASH REPORT</h3>
            ${reportData.generated_cash_report_html}
          </div>
          
          <div>
            <h3 style="color: #1e3c72; margin-bottom: 15px; border-bottom: 2px solid #1e3c72; padding-bottom: 5px;">TIP POOL DISTRIBUTION</h3>
            ${reportData.generated_tip_pool_html}
          </div>
          
          <div style="text-align: center; margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
            <button class="submit-btn" onclick="downloadHistoricalReportPDF('${reportData.week_start_date}', '${reportData.week_end_date}')" style="background: #28a745; margin-right: 10px;">üìÑ Download PDF</button>
            <button class="submit-btn" onclick="goHome()" style="background: #6c757d;">Back to Menu</button>
          </div>
        </div>
      `;
      
      console.log('Setting main content HTML...');
      console.log('HTML length:', mainContentHtml.length);
      
      // Use the proven working method - set content and show like tip pool results
      reportContent.innerHTML = mainContentHtml;
      
      // Store the report data globally for PDF generation
      window.currentHistoricalReport = reportData;
      
      // Hide all sections and show the results (copy exact pattern from tip pool)
      hideAllSections();
      
      console.log('Looking for reportResults element...');
      const reportResultsElement = document.getElementById('reportResults');
      console.log('reportResults element found:', !!reportResultsElement);
      console.log('reportResults element:', reportResultsElement);
      
      if (reportResultsElement) {
        reportResultsElement.style.display = 'block';
        console.log('Set reportResults to display: block');
        console.log('reportResults final style.display:', reportResultsElement.style.display);
        console.log('reportResults computed style:', window.getComputedStyle(reportResultsElement).display);
      } else {
        console.error('reportResults element not found!');
      }
      
      console.log('Historical report content should now be visible');
      
    } else {
      // Fallback: no HTML content saved, show basic info
      const legacyContentHtml = `
        <div style="max-width: 800px; margin: 0 auto; padding: 20px;">
          <div style="background: #fff3cd; padding: 20px; border-radius: 8px; border-left: 4px solid #ffc107;">
            <h3 style="margin: 0 0 10px 0; color: #856404;">‚ö†Ô∏è Legacy Report Format</h3>
            <p style="margin: 0 0 10px 0; font-size: 14px;">This report was generated before HTML content saving was implemented.</p>
            <p style="margin: 0; font-size: 14px;"><strong>Report Details:</strong></p>
            <ul style="margin: 10px 0 0 20px;">
              <li>Week: ${new Date(reportData.week_start_date).toLocaleDateString()} - ${new Date(reportData.week_end_date).toLocaleDateString()}</li>
              <li>Generated by: ${reportData.generated_by}</li>
              <li>Generated on: ${new Date(reportData.generated_at).toLocaleDateString()}</li>
              <li>Total Tips: $${reportData.total_tips || 0}</li>
              <li>Tip Pool Total: $${reportData.tip_pool_total || 0}</li>
            </ul>
            <div style="text-align: center; margin-top: 20px;">
              <button class="submit-btn" onclick="goHome()" style="background: #6c757d;">Back to Menu</button>
            </div>
          </div>
        </div>
      `;
      
      console.log('Setting legacy content HTML...');
      reportContent.innerHTML = legacyContentHtml;
      
      hideAllSections();
      
      console.log('Looking for reportResults element (legacy)...');
      const reportResultsElement = document.getElementById('reportResults');
      console.log('reportResults element found (legacy):', !!reportResultsElement);
      
      if (reportResultsElement) {
        reportResultsElement.style.display = 'block';
        console.log('Set reportResults to display: block (legacy)');
      } else {
        console.error('reportResults element not found (legacy)!');
      }
    }
  }

  // Generate Single Day PDF Report
  async function generateSingleDayPDF(dayData, reportDate) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'letter' });
    
    const pageWidth = doc.internal.pageSize.getWidth();
    const margin = 40;
    let currentY = margin;
    
    // Header
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(16);
    doc.setTextColor(0, 0, 0);
    doc.text('JAYNA GYRO DAILY REPORT', margin, currentY + 12);
    
    currentY += 30;
    doc.setFontSize(9);
    doc.setFont('helvetica', 'normal');
    doc.text(`DATE: ${reportDate.toUpperCase()}`, margin, currentY);
    doc.text(`NIGHT COUNTER: ${(dayData.night_counter || 'N/A').toUpperCase()}`, margin, currentY + 12);
    doc.text(`GENERATED: ${new Date().toLocaleString().toUpperCase()}`, margin, currentY + 24);
    
    // Cash reconciliation summary
    currentY += 50;
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(12);
    doc.text('DAILY CASH RECONCILIATION', margin, currentY);
    
    currentY += 20;
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(10);
    
    const summaryData = [
      ['TOAST SALES REPORTED:', `$${dayData.toast_sales.toFixed(2)}`],
      ['ACTUAL CASH IN:', `$${dayData.actual_cash_in.toFixed(2)}`],
      ['DISCREPANCY:', `$${dayData.discrepancy.toFixed(2)}`],
      ['EXCESS:', `$${dayData.excess.toFixed(2)}`]
    ];
    
    summaryData.forEach((row, index) => {
      doc.text(row[0], margin, currentY + (index * 15));
      doc.text(row[1], margin + 200, currentY + (index * 15));
    });
    
    // Add explanatory notes
    currentY += 100;
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(8);
    doc.setTextColor(80, 80, 80);
    doc.text('DAILY REPORT NOTES', margin, currentY);
    
    currentY += 15;
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(7);
    doc.setTextColor(100, 100, 100);
    
    const notes = [
      'This daily report shows cash reconciliation for a single day.',
      'DISCREPANCY: Actual Cash In - Expected Toast Sales (negative = short, positive = over)',
      'EXCESS: Cash taken from tips to balance operations and account for discrepancies'
    ];
    
    notes.forEach((note, index) => {
      doc.text(note, margin, currentY + (index * 10));
    });
    
    // Developer credit
    currentY += 50;
    if (currentY < 700) {
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(8);
      doc.setTextColor(0, 0, 0);
      const creditText = 'Report Generation App designed and coded by Demetri Gregorakis';
      const emailText = 'demetri_gregorakis@icloud.com for troubleshooting';
      
      const creditWidth = doc.getTextWidth(creditText);
      const emailWidth = doc.getTextWidth(emailText);
      const centerXCredit = (pageWidth - creditWidth) / 2;
      const centerXEmail = (pageWidth - emailWidth) / 2;
      
      doc.text(creditText, centerXCredit, currentY);
      doc.setFont('helvetica', 'normal');
      doc.setFontSize(7);
      doc.text(emailText, centerXEmail, currentY + 12);
    }
    
    // Save PDF
    const filename = `Daily_Report_${reportDate.replace(/-/g, '_')}.pdf`;
    doc.save(filename);
  }

  // Generate Weekly Historical PDF Report
  async function generateWeeklyHistoricalPDF(weeklyData, startDate, endDate) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'letter' });
    
    const pageWidth = doc.internal.pageSize.getWidth();
    const margin = 40;
    let currentY = margin;
    
    // Header
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(16);
    doc.setTextColor(0, 0, 0);
    doc.text('JAYNA GYRO HISTORICAL WEEKLY REPORT', margin, currentY + 12);
    
    currentY += 30;
    doc.setFontSize(9);
    doc.setFont('helvetica', 'normal');
    const dateRange = `${startDate.toUpperCase()} TO ${endDate.toUpperCase()}`;
    doc.text(`WEEK OF: ${dateRange}`, margin, currentY);
    doc.text(`GENERATED BY: ${(weeklyData.generated_by || 'N/A').toUpperCase()}`, margin, currentY + 12);
    doc.text(`GENERATED: ${new Date().toLocaleString().toUpperCase()}`, margin, currentY + 24);
    
    // Summary section
    currentY += 50;
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(12);
    doc.text('WEEKLY SUMMARY', margin, currentY);
    
    currentY += 20;
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(9);
    
    const summaryLines = [
      `TOAST CASH SALES REPORTED: $${weeklyData.total_toast_sales.toFixed(2)}`,
      `ACTUAL CASH IN: $${weeklyData.actual_cash_in.toFixed(2)}`,
      `TOTAL DISCREPANCY: $${weeklyData.total_discrepancy.toFixed(2)}`,
      `ENVELOPE DEPOSITS: $${weeklyData.envelope_deposits.toFixed(2)}`,
      `CREDIT TIPS: $${weeklyData.credit_tips.toFixed(2)}`,
      `CASH TIPS: $${weeklyData.cash_tips.toFixed(2)}`,
      `EZCATER TIPS: $${weeklyData.ezcater_tips.toFixed(2)}`,
      `TOTAL TIPS: $${weeklyData.total_tips.toFixed(2)}`,
      `TDS DRIVER: $${weeklyData.tds_driver_tips.toFixed(2)}`,
      `TIP POOL TOTAL (MINUS TDS): $${weeklyData.tip_pool_total.toFixed(2)}`,
      `HOURLY RATE: $${weeklyData.hourly_rate.toFixed(2)}`,
      `CASH NEEDED: $${weeklyData.cash_needed.toFixed(2)}`
    ];
    
    summaryLines.forEach((line, index) => {
      if (index % 2 === 0) {
        doc.text(line, margin, currentY + Math.floor(index / 2) * 15);
      } else {
        doc.text(line, margin + 280, currentY + Math.floor(index / 2) * 15);
      }
    });
    
    // Employee tips table
    if (weeklyData.weekly_employee_tips && weeklyData.weekly_employee_tips.length > 0) {
      currentY += Math.ceil(summaryLines.length / 2) * 15 + 30;
      
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(12);
      doc.text('EMPLOYEE TIP DISTRIBUTION', margin, currentY);
      
      currentY += 20;
      
      const employeeTableData = weeklyData.weekly_employee_tips.map(emp => [
        `${emp.employee_first_name} ${emp.employee_last_name}`,
        emp.hours_worked.toFixed(1),
        emp.equity_percentage.toFixed(0),
        emp.weighted_hours.toFixed(1),
        `$${emp.tips_due.toFixed(2)}`
      ]);
      
      doc.autoTable({
        head: [['EMPLOYEE', 'HOURS', 'EQUITY (%)', 'WEIGHTED', 'DUE']],
        body: employeeTableData,
        startY: currentY,
        margin: { left: margin, right: margin },
        styles: { font: 'helvetica', fontSize: 8, textColor: [0, 0, 0] },
        headStyles: { font: 'helvetica', fontStyle: 'bold', fillColor: [245, 245, 245] }
      });
      
      currentY = doc.autoTable.previous.finalY + 20;
    }
    
    // Daily breakdown table
    if (weeklyData.weekly_daily_breakdown && weeklyData.weekly_daily_breakdown.length > 0) {
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(12);
      doc.text('DAILY CASH BREAKDOWN', margin, currentY);
      
      currentY += 15;
      doc.setFont('helvetica', 'normal');
      doc.setFontSize(8);
      doc.text(`* Only showing ${weeklyData.weekly_daily_breakdown.length} days with PM cash count data`, margin, currentY);
      
      currentY += 15;
      
      // Filter and format the data better
      const dailyTableData = weeklyData.weekly_daily_breakdown
        .filter(day => day.toast_sales > 0 || day.actual_cash_in > 0) // Only show days with actual data
        .map(day => [
          day.date,
          day.night_counter || 'N/A',
          day.toast_sales > 0 ? `$${day.toast_sales.toFixed(2)}` : 'No Data',
          day.actual_cash_in > 0 ? `$${day.actual_cash_in.toFixed(2)}` : 'No Data', 
          Math.abs(day.discrepancy) > 0.01 ? `${day.discrepancy >= 0 ? '+' : ''}$${day.discrepancy.toFixed(2)}` : '$0.00',
          day.excess > 0 ? `$${day.excess.toFixed(2)}` : '$0.00'
        ]);
      
      doc.autoTable({
        head: [['DATE', 'NIGHT COUNTER', 'TOAST SALES', 'ACTUAL CASH IN', 'DISCREPANCY', 'EXCESS']],
        body: dailyTableData,
        startY: currentY,
        margin: { left: margin, right: margin },
        styles: { font: 'helvetica', fontSize: 7, textColor: [0, 0, 0] },
        headStyles: { font: 'helvetica', fontStyle: 'bold', fillColor: [245, 245, 245] },
        didParseCell: function(data) {
          // Color discrepancy column
          if (data.column.index === 4 && data.row.index < dailyTableData.length) {
            const cellValue = data.cell.text[0];
            if (cellValue && cellValue.includes('-')) {
              data.cell.styles.textColor = [139, 69, 19]; // Dark red
              data.cell.styles.fontStyle = 'italic';
            } else if (cellValue && cellValue.includes('+')) {
              data.cell.styles.textColor = [34, 139, 34]; // Dark green
            }
          }
        }
      });
    }
    
    // Save PDF
    const filename = `Historical_Weekly_Report_${startDate.replace(/-/g, '_')}_to_${endDate.replace(/-/g, '_')}.pdf`;
    doc.save(filename);
  }
  
  async function generateAndDownloadReport() {
    const reportType = document.querySelector('input[name="reportType"]:checked').value;
    
    try {
      showLoading('Generating PDF Report', 'Creating your report...');
      
      if (reportType === 'single') {
        await generateSingleDayPDF();
      } else {
        await generateDateRangePDF();
      }
      
      hideLoading();
      showPDFSuccessMessage();
      
    } catch (error) {
      hideLoading();
      console.error('Report generation error:', error);
      showMessage(`Error: ${error.message}`, 'error');
    }
  }
  
  function showPDFSuccessMessage() {
    const modalHTML = `
      <div id="pdfSuccessModal" style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.7);
        z-index: 10000;
        display: flex;
        justify-content: center;
        align-items: center;
      ">
        <div style="
          background: white;
          padding: 40px;
          border-radius: 12px;
          text-align: center;
          max-width: 400px;
          width: 90%;
          box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        ">
          <div style="font-size: 48px; margin-bottom: 20px;">üìÑ</div>
          <h2 style="color: #28a745; margin-bottom: 15px; font-size: 24px;">PDF Downloaded Successfully!</h2>
          <p style="color: #666; margin-bottom: 30px; font-size: 16px;">Your cash report has been generated and downloaded.</p>
          <button onclick="closePDFSuccessModal(); goHome();" style="
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 16px;
            border-radius: 6px;
            cursor: pointer;
            margin-right: 10px;
          ">Return to Menu</button>
          <button onclick="closePDFSuccessModal();" style="
            background: #6c757d;
            color: white;
            border: none;
            padding: 12px 20px;
            font-size: 16px;
            border-radius: 6px;
            cursor: pointer;
          ">Stay Here</button>
        </div>
      </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
  }
  
  function closePDFSuccessModal() {
    const modal = document.getElementById('pdfSuccessModal');
    if (modal) {
      modal.remove();
    }
  }

  function showTipPoolSuccessMessage() {
    const modalHTML = `
      <div id="tipPoolSuccessModal" style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.7);
        z-index: 10000;
        display: flex;
        justify-content: center;
        align-items: center;
      ">
        <div style="
          background: white;
          padding: 40px;
          border-radius: 12px;
          text-align: center;
          max-width: 400px;
          width: 90%;
          box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        ">
          <div style="font-size: 48px; margin-bottom: 20px;">üí∞</div>
          <h2 style="color: #28a745; margin-bottom: 15px; font-size: 24px;">Tip Pool PDF Downloaded Successfully!</h2>
          <p style="color: #666; margin-bottom: 30px; font-size: 16px;">Your tip pool distribution report has been generated and downloaded.</p>
          <button onclick="closeTipPoolSuccessModal(); goHome();" style="
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 16px;
            border-radius: 6px;
            cursor: pointer;
            margin-right: 10px;
          ">Return to Menu</button>
          <button onclick="closeTipPoolSuccessModal();" style="
            background: #6c757d;
            color: white;
            border: none;
            padding: 12px 20px;
            font-size: 16px;
            border-radius: 6px;
            cursor: pointer;
          ">Stay Here</button>
        </div>
      </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
  }
  
  function closeTipPoolSuccessModal() {
    const modal = document.getElementById('tipPoolSuccessModal');
    if (modal) {
      modal.remove();
    }
  }
  
  async function generateSingleDayPDF() {
    const date = document.getElementById('reportDate').value;
    console.log('generateSingleDayPDF called with date:', date);
    
    if (!date) {
      throw new Error('Please select a date');
    }
    
    console.log('Getting AM data for date:', date);
    const amData = await getAMData(date);
    console.log('AM data retrieved:', amData);
    
    if (!amData) {
      throw new Error('No AM data found for this date');
    }
    
    console.log('Getting PM data for date:', date);
    const { data: fullData, error } = await supabase
      .from('cash_counts')
      .select('*')
      .eq('date', date)
      .single();
    
    console.log('PM data retrieved:', fullData, 'Error:', error);
    
    if (!fullData || !fullData.pm_total) {
      throw new Error('No PM data found for this date');
    }
    
    console.log('Generating report HTML...');
    
    // Calculate PM amounts using same logic as PM flow for consistency
    const calculations = calculatePMAmounts({
      amTotal: amData.total,
      total: fullData.pm_total,
      toastSales: fullData.pm_toast_sales,
      cashTips: fullData.pm_cash_tips
    });
    
    console.log('Calculations for report:', calculations);
    
    // Create enhanced pmData with calculation results
    const enhancedPmData = {
      ...fullData,
      // Add calculated fields for deposit rounding breakdown
      raw_deposit_amount: calculations.rawDepositAmount ? calculations.rawDepositAmount.toFixed(2) : null,
      deposit_rounding_adjustment: calculations.depositRoundingAdjustment ? calculations.depositRoundingAdjustment.toFixed(2) : null,
      deposit_tip_adjustment: calculations.depositTipAdjustment ? calculations.depositTipAdjustment.toFixed(2) : null,
      deposit_excess_to_cashbox: calculations.depositExcessToCashbox ? calculations.depositExcessToCashbox.toFixed(2) : null,
      // Only show deposit rounding breakdown if:
      // 1. There's actually a meaningful rounding adjustment (> 0.001)
      // 2. This data was processed with the new logic (stored amount matches rounded amount)
      has_deposit_rounding: (
        calculations.depositRoundingAdjustment && 
        Math.abs(calculations.depositRoundingAdjustment) > 0.001 &&
        Math.abs(fullData.pm_deposit_amount - calculations.depositAmount) < 0.001
      ) ? 'true' : 'false',
      deposit_amount: calculations.depositAmount.toString()
    };
    
    console.log('Enhanced PM Data:', enhancedPmData);
    
    // Generate full single day report (same format as email)
    const reportHtml = generateSingleDayReportHtml(date, amData, enhancedPmData);
    console.log('Report HTML generated, creating PDF...');
    
    // Set the content in the hidden div
    const reportContent = document.getElementById('reportContent');
    if (reportContent) {
      reportContent.innerHTML = reportHtml;
      
      // Generate PDF
      const filename = `jayna-gyro-daily-report-${date}.pdf`;
      await generatePDF(reportContent, filename);
      
    } else {
      throw new Error('Report content element not found');
    }
  }
  
  async function generateDateRangePDF() {
    const startDate = document.getElementById('reportStartDate').value;
    const endDate = document.getElementById('reportEndDate').value;
    const realEnvelopeAmount = parseFloat(document.getElementById('realEnvelopeAmount').value) || null;
    
    if (!startDate || !endDate) {
      throw new Error('Please select both start and end dates');
    }
    
    // Handle dates properly with timezone-safe parsing (like AM/PM flows)
    const start = new Date(startDate + 'T12:00:00');
    const end = new Date(endDate + 'T12:00:00');
    
    if (start > end) {
      throw new Error('Start date must be before end date');
    }
    
    // Check if date range exceeds 7 days
    const daysDiff = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
    if (daysDiff > 7) {
      throw new Error('Date range cannot exceed 7 days');
    }
    
    console.log('Date range query:', { startDate, endDate, daysDiff });
    
    const { data: rangeData } = await supabase
      .from('cash_counts')
      .select('*')
      .gte('date', startDate)
      .lte('date', endDate)
      .not('pm_total', 'is', null)
      .order('date', { ascending: true });
    
    if (!rangeData || rangeData.length === 0) {
      throw new Error('No data found for this date range');
    }
    
    // Generate date range summary report
    const reportHtml = generateDateRangeReportHtml(startDate, endDate, rangeData, realEnvelopeAmount);
    
    // Set the content in the hidden div
    const reportContent = document.getElementById('reportContent');
    if (reportContent) {
      reportContent.innerHTML = reportHtml;
      
      // Generate PDF
      const filename = `jayna-gyro-range-report-${startDate}-to-${endDate}.pdf`;
      await generatePDF(reportContent, filename);
      
    } else {
      throw new Error('Report content element not found');
    }
  }
  
  async function generatePDF(element, filename) {
    console.log('Generating PDF with filename:', filename);
    
    // Extract only the body content, skipping the CSS
    const fullHTML = element.innerHTML;
    
    // Find the start of the actual content (after </style> tag)
    const contentStart = fullHTML.indexOf('</style>') + 8;
    const contentEnd = fullHTML.lastIndexOf('</html>');
    
    let bodyContent = '';
    if (contentStart > 7 && contentEnd > contentStart) {
      // Extract content between </style> and </html>
      bodyContent = fullHTML.substring(contentStart, contentEnd);
      // Remove any remaining head/body tags and just keep the content
      bodyContent = bodyContent.replace(/<\/head>|<body>|<\/body>/g, '').trim();
    } else {
      // Fallback: try to find content starting with "JAYNA GYRO"
      const jaynaStart = fullHTML.indexOf('JAYNA GYRO DAILY CASH REPORT');
      if (jaynaStart > 0) {
        bodyContent = fullHTML.substring(jaynaStart);
        bodyContent = bodyContent.replace(/<\/html>|<\/body>/g, '').trim();
      } else {
        bodyContent = element.innerHTML;
      }
    }
    
    // Create a temporary element with just the clean content and basic styling
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = `
      <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 8px; font-size: 9px; line-height: 1.1; }
        .header { text-align: center; font-weight: bold; font-size: 16px; margin-bottom: 2px; border-bottom: 2px solid #000; padding-bottom: 4px; }
        .date-header { text-align: center; font-weight: bold; font-size: 14px; margin-bottom: 8px; padding-bottom: 4px; }
        .section { border: 1px solid #000; margin: 4px 0; padding: 6px; }
        .section-title { font-weight: bold; font-size: 12px; text-align: center; margin-bottom: 4px; border-bottom: 1px solid #000; padding-bottom: 2px; }
        .two-column { display: table; width: 100%; }
        .column { display: table-cell; width: 50%; vertical-align: top; padding: 0 4px; }
        .column:first-child { border-right: 1px solid #ccc; }
        .data-row { display: flex; justify-content: space-between; margin: 1px 0; max-width: 150px; }
        .label { font-weight: bold; text-align: right; padding-right: 8px; }
        .value { text-align: left; font-weight: bold; }
        .deposit-box { background-color: #e6ffe6; border: 2px solid #000; padding: 6px; text-align: center; font-weight: bold; font-size: 11px; margin: 4px 0; }
        .keep-box { background-color: #fff0e6; border: 2px solid #000; padding: 6px; text-align: center; font-weight: bold; font-size: 11px; margin: 4px 0; }
        .notes-section { display: table; width: 100%; margin: 4px 0; }
        .notes-column { display: table-cell; width: 50%; padding: 4px; border: 1px solid #000; vertical-align: top; text-align: center; font-weight: bold; }
        .notes-column:first-child { border-right: none; }
        .breakdown-grid { display: table; width: 100%; }
        .breakdown-row { display: table-row; }
        .breakdown-cell { display: table-cell; padding: 2px 4px; border-bottom: 1px dotted #ccc; }
        .breakdown-label { font-weight: bold; width: 50%; text-align: right; padding-right: 8px; }
        .breakdown-value { text-align: left; font-weight: bold; width: 50%; padding-left: 8px; }
        .cash-count { font-size: 7px; line-height: 1.0; }
        .drawer-total { font-weight: bold; border-top: 1px solid #000; margin-top: 2px; padding-top: 2px; }
        .shift-total { font-weight: bold; text-align: center; padding: 3px; border: 2px solid #000; margin-top: 4px; font-size: 8px; }
        .am-bg { background-color: #e6f3ff; }
        .pm-bg { background-color: #fff8f0; }
      </style>
      ${bodyContent}
    `;
    
    // Hide the original element and show the temp one
    const originalParent = element.parentNode;
    const originalDisplay = element.style.display;
    
    // Insert temp div and hide original
    document.body.appendChild(tempDiv);
    element.style.display = 'none';
    
    // Configure PDF options for better output
    const opt = {
      margin: 0.5,
      filename: filename,
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { 
        scale: 2,
        useCORS: true,
        backgroundColor: '#ffffff',
        width: 800,
        height: tempDiv.scrollHeight,
        logging: false
      },
      jsPDF: { 
        unit: 'in', 
        format: 'letter', 
        orientation: 'portrait' 
      }
    };
    
    try {
      // Generate PDF from the clean temp element
      await html2pdf().set(opt).from(tempDiv).save();
      console.log('PDF generated and downloaded successfully');
    } catch (pdfError) {
      console.error('PDF generation error:', pdfError);
      throw pdfError;
    } finally {
      // Clean up: remove temp div and restore original
      try {
        if (tempDiv && tempDiv.parentNode) {
          document.body.removeChild(tempDiv);
        }
        if (element) {
          element.style.display = originalDisplay;
        }
      } catch (cleanupError) {
        console.error('Cleanup error:', cleanupError);
      }
    }
  }
  
  // Download Historical Report as PDF
  async function downloadHistoricalReportPDF(startDate, endDate) {
    try {
      console.log('Downloading historical report PDF...');
      
      if (!window.currentHistoricalReport) {
        throw new Error('No historical report data available');
      }
      
      const reportData = window.currentHistoricalReport;
      const reportContent = document.getElementById('reportContent');
      
      if (!reportContent) {
        throw new Error('Report content not found');
      }
      
      // Generate PDF from the displayed content
      const filename = `jayna-gyro-historical-report-${startDate}-to-${endDate}.pdf`;
      await generatePDF(reportContent, filename);
      
      console.log('Historical report PDF downloaded successfully');
      
    } catch (error) {
      console.error('Error downloading historical report PDF:', error);
      showErrorMessage('Failed to download PDF: ' + error.message, 'reportResults');
    }
  }
  
  function generateSingleDayReportHtml(date, amData, pmData) {
    console.log('generateSingleDayReportHtml called with:');
    console.log('date:', date);
    console.log('amData:', amData);
    console.log('pmData:', pmData);
    
    // Validate data exists
    if (!amData || !pmData) {
      console.error('Missing data - amData:', !!amData, 'pmData:', !!pmData);
      return '<div style="padding: 20px; color: red; font-size: 18px;">Error: Missing report data</div>';
    }
    
    const dayOfWeek = new Date(date + 'T12:00:00').toLocaleDateString('en-US', { weekday: 'long' }).toUpperCase();
    const formattedDate = new Date(date + 'T12:00:00').toLocaleDateString('en-US', { 
      year: 'numeric', 
      month: 'long', 
      day: 'numeric' 
    }).toUpperCase();
    
    const actualCashIn = pmData.pm_total - amData.total;
    const discrepancySign = pmData.pm_discrepancy >= 0 ? '+' : '';
    const tipAdjustment = pmData.pm_discrepancy < 0 ? Math.abs(pmData.pm_discrepancy) : 0;
    
    // Helper function to get denomination counts and totals
    function getDenomData(drawerData, denomKey) {
      if (!drawerData || !drawerData) return { count: 0, total: 0 };
      
      // Map display format to stored format
      const denomMapping = {
        '$100': 'hundreds',
        '$50': 'fifties', 
        '$20': 'twenties',
        '$10': 'tens',
        '$5': 'fives',
        '$1': 'ones',
        '¬¢25': 'quarters',
        '¬¢10': 'dimes', 
        '¬¢5': 'nickels',
        '¬¢1': 'pennies'
      };
      
      const dataKey = denomMapping[denomKey];
      if (!dataKey) return { count: 0, total: 0 };
      
      const count = parseInt(drawerData[dataKey]) || 0;
      const denomValues = {
        '$100': 100, '$50': 50, '$20': 20, '$10': 10, '$5': 5, '$1': 1,
        '¬¢25': 0.25, '¬¢10': 0.10, '¬¢5': 0.05, '¬¢1': 0.01
      };
      const value = denomValues[denomKey] || 0;
      return { count, total: (count * value).toFixed(2) };
    }
    
    const htmlContent = `
    <!DOCTYPE html>
    <html>
    <head>
        <style>
            body {
                font-family: Arial, sans-serif;
                margin: 0;
                padding: 8px;
                font-size: 9px;
                line-height: 1.1;
            }
            .header {
                text-align: center;
                font-weight: bold;
                font-size: 16px;
                margin-bottom: 2px;
                border-bottom: 2px solid #000;
                padding-bottom: 4px;
            }
            .date-header {
                text-align: center;
                font-weight: bold;
                font-size: 14px;
                margin-bottom: 8px;
                padding-bottom: 4px;
            }
            .section {
                border: 1px solid #000;
                margin: 4px 0;
                padding: 6px;
            }
            .section-title {
                font-weight: bold;
                font-size: 12px;
                text-align: center;
                margin-bottom: 4px;
                border-bottom: 1px solid #000;
                padding-bottom: 2px;
            }
            .two-column {
                display: table;
                width: 100%;
            }
            .column {
                display: table-cell;
                width: 50%;
                vertical-align: top;
                padding: 0 4px;
            }
            .column:first-child {
                border-right: 1px solid #ccc;
            }
            .data-row {
                display: flex;
                justify-content: space-between;
                margin: 1px 0;
                max-width: 150px;
            }
            .label {
                font-weight: bold;
                text-align: right;
                padding-right: 8px;
            }
            .value {
                text-align: left;
                font-weight: bold;
            }
            .deposit-box {
                background-color: #e6ffe6;
                border: 2px solid #000;
                padding: 6px;
                text-align: center;
                font-weight: bold;
                font-size: 11px;
                margin: 4px 0;
            }
            .keep-box {
                background-color: #fff0e6;
                border: 2px solid #000;
                padding: 6px;
                text-align: center;
                font-weight: bold;
                font-size: 11px;
                margin: 4px 0;
            }
            .notes-section {
                display: table;
                width: 100%;
                margin: 4px 0;
            }
            .notes-column {
                display: table-cell;
                width: 50%;
                padding: 4px;
                border: 1px solid #000;
                vertical-align: top;
                text-align: center;
                font-weight: bold;
            }
            .notes-column:first-child {
                border-right: none;
            }
            .breakdown-grid {
                display: table;
                width: 100%;
            }
            .breakdown-row {
                display: table-row;
            }
            .breakdown-cell {
                display: table-cell;
                padding: 2px 4px;
                border-bottom: 1px dotted #ccc;
            }
            .breakdown-label {
                font-weight: bold;
                width: 50%;
                text-align: right;
                padding-right: 8px;
            }
            .breakdown-value {
                text-align: left;
                font-weight: bold;
                width: 50%;
                padding-left: 8px;
            }
            .cash-count {
                font-size: 7px;
                line-height: 1.0;
            }
            .drawer-total {
                font-weight: bold;
                border-top: 1px solid #000;
                margin-top: 2px;
                padding-top: 2px;
            }
            .shift-total {
                font-weight: bold;
                text-align: center;
                padding: 3px;
                border: 2px solid #000;
                margin-top: 4px;
                font-size: 8px;
            }
            .am-bg { background-color: #e6f3ff; }
            .pm-bg { background-color: #fff8f0; }
        </style>
    </head>
    <body>
        <div class="header">
            JAYNA GYRO DAILY CASH REPORT
        </div>
        <div class="date-header">
            ${dayOfWeek} ${formattedDate}
        </div>
        <div style="text-align: center; font-size: 8px; color: #666; margin-bottom: 8px; border-bottom: 1px dotted #ccc; padding-bottom: 4px;">
            Report Generated: ${new Date().toLocaleString()}
        </div>

        <!-- Staff and Timing Info -->
        <div class="section">
            <div class="two-column">
                <div class="column">
                    <div class="data-row">
                        <span class="label">AM Counter:</span>
                        <span class="value">${amData.counter}</span>
                    </div>
                    <div class="data-row">
                        <span class="label">AM Time:</span>
                        <span class="value">${new Date(amData.timestamp).toLocaleTimeString()}</span>
                    </div>
                </div>
                <div class="column">
                    <div class="data-row">
                        <span class="label">PM Counter:</span>
                        <span class="value">${pmData.pm_counter}</span>
                    </div>
                    <div class="data-row">
                        <span class="label">PM Time:</span>
                        <span class="value">${new Date(pmData.pm_timestamp).toLocaleTimeString()}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Cash Summary -->
        <div class="section">
            <div class="section-title">CASH FLOW SUMMARY</div>
            <div class="two-column">
                <div class="column">
                    <div class="data-row">
                        <span class="label">Starting Cash (AM):</span>
                        <span class="value">$${amData.total.toFixed(2)}</span>
                    </div>
                    <div class="data-row">
                        <span class="label">Ending Cash (PM):</span>
                        <span class="value">$${pmData.pm_total.toFixed(2)}</span>
                    </div>
                    <div class="data-row">
                        <span class="label">Actual Cash In:</span>
                        <span class="value">$${actualCashIn.toFixed(2)}</span>
                    </div>
                </div>
                <div class="column">
                    <div class="data-row">
                        <span class="label">Toast Sales:</span>
                        <span class="value">$${pmData.pm_toast_sales.toFixed(2)}</span>
                    </div>
                    <div class="data-row">
                        <span class="label">Original Tips:</span>
                        <span class="value">$${pmData.pm_cash_tips.toFixed(2)}</span>
                    </div>
                    <div class="data-row">
                        <span class="label">Discrepancy:</span>
                        <span class="value">${discrepancySign}$${Math.abs(pmData.pm_discrepancy).toFixed(2)}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Deposit Instructions -->
        <div class="deposit-box">
            DEPOSIT IN ENVELOPE: $${pmData.pm_deposit_amount}
            <div style="font-size: 8px;">(Toast Sales $${pmData.pm_toast_sales.toFixed(2)} + Original Tips $${pmData.pm_cash_tips.toFixed(2)})</div>
        </div>
        <div class="keep-box">
            RETURN TO CASHBOX/SAFE: $${pmData.pm_amount_to_keep.toFixed(2)}
        </div>

        <!-- Notes Section -->
        <div class="notes-section">
            <div class="notes-column am-bg">
                <div style="font-weight: bold; text-align: center; margin-bottom: 3px;">AM NOTES</div>
                <div style="text-align: center; font-weight: bold;">
                    ${amData.notes || 'No AM Notes'}
                </div>
            </div>
            <div class="notes-column pm-bg">
                <div style="font-weight: bold; text-align: center; margin-bottom: 3px;">PM NOTES</div>
                <div style="text-align: center; font-weight: bold;">
                    ${pmData.pm_notes || 'No PM Notes'}
                </div>
            </div>
        </div>

        <!-- Manager Breakdown -->
        <div class="section">
            <div class="section-title">MANAGER BREAKDOWN</div>
            <div class="breakdown-grid">
                <div class="breakdown-row">
                    <div class="breakdown-cell breakdown-label">Starting Cash Total:</div>
                    <div class="breakdown-cell breakdown-value">$${amData.total.toFixed(2)}</div>
                </div>
                <div class="breakdown-row">
                    <div class="breakdown-cell breakdown-label">Ending Cash Total:</div>
                    <div class="breakdown-cell breakdown-value">$${pmData.pm_total.toFixed(2)}</div>
                </div>
                <div class="breakdown-row">
                    <div class="breakdown-cell breakdown-label">Actual Cash In:</div>
                    <div class="breakdown-cell breakdown-value">$${actualCashIn.toFixed(2)}</div>
                </div>
                <div class="breakdown-row">
                    <div class="breakdown-cell breakdown-label">Toast Sales Reported:</div>
                    <div class="breakdown-cell breakdown-value">$${pmData.pm_toast_sales.toFixed(2)}</div>
                </div>
                <div class="breakdown-row">
                    <div class="breakdown-cell breakdown-label">Tips Reported by Staff:</div>
                    <div class="breakdown-cell breakdown-value">$${pmData.pm_cash_tips.toFixed(2)}</div>
                </div>
                <div class="breakdown-row">
                    <div class="breakdown-cell breakdown-label">Discrepancy (Drawers vs Toast):</div>
                    <div class="breakdown-cell breakdown-value">${discrepancySign}$${Math.abs(pmData.pm_discrepancy).toFixed(2)}</div>
                </div>
                ${tipAdjustment > 0 ? `
                <div class="breakdown-row">
                    <div class="breakdown-cell breakdown-label">Cash Tip Adjustment:</div>
                    <div class="breakdown-cell breakdown-value">-$${tipAdjustment.toFixed(2)}</div>
                </div>` : ''}
                ${pmData.has_deposit_rounding === 'true' ? `
                <div class="breakdown-row" style="background-color: #fff3cd;">
                    <div class="breakdown-cell breakdown-label">Raw Deposit Amount:</div>
                    <div class="breakdown-cell breakdown-value">$${pmData.raw_deposit_amount}</div>
                </div>
                <div class="breakdown-row" style="background-color: #fff3cd;">
                    <div class="breakdown-cell breakdown-label">Rounded Deposit Amount:</div>
                    <div class="breakdown-cell breakdown-value">$${pmData.deposit_amount}</div>
                </div>
                <div class="breakdown-row" style="background-color: #fff3cd;">
                    <div class="breakdown-cell breakdown-label">Rounding Adjustment Needed:</div>
                    <div class="breakdown-cell breakdown-value">$${pmData.deposit_rounding_adjustment}</div>
                </div>
                <div class="breakdown-row" style="background-color: #fff3cd;">
                    <div class="breakdown-cell breakdown-label">Taken from Tips (Whole $):</div>
                    <div class="breakdown-cell breakdown-value">-$${pmData.deposit_tip_adjustment}</div>
                </div>
                <div class="breakdown-row" style="background-color: #fff3cd;">
                    <div class="breakdown-cell breakdown-label">Excess to Cashbox:</div>
                    <div class="breakdown-cell breakdown-value">+$${pmData.deposit_excess_to_cashbox}</div>
                </div>` : ''}
                <div class="breakdown-row">
                    <div class="breakdown-cell breakdown-label">Owed to Restaurant:</div>
                    <div class="breakdown-cell breakdown-value">$${pmData.pm_toast_sales.toFixed(2)}</div>
                </div>
                <div class="breakdown-row">
                    <div class="breakdown-cell breakdown-label">Cash Tips Owed to Staff:</div>
                    <div class="breakdown-cell breakdown-value">$${pmData.pm_adjusted_tips.toFixed(2)}</div>
                </div>
                <div class="breakdown-row">
                    <div class="breakdown-cell breakdown-label">Returned to Cashbox:</div>
                    <div class="breakdown-cell breakdown-value">$${(pmData.pm_amount_to_keep - amData.total).toFixed(2)} + AM Total</div>
                </div>
            </div>
        </div>

        <!-- Complete Cash Count Breakdown -->
        <div class="section">
            <div class="section-title">COMPLETE CASH COUNT BREAKDOWN</div>
            <div class="two-column">
                <!-- AM Counts -->
                <div class="column">
                    <div style="text-align: center; font-weight: bold; font-size: 8px; margin-bottom: 3px; background-color: #e6f3ff; padding: 2px;">AM COUNTS</div>
                    
                    <div class="cash-count">
                        <div style="font-weight: bold; text-decoration: underline; margin-bottom: 2px;">DRAWER 1</div>
                        ${['$100', '$50', '$20', '$10', '$5', '$1', '¬¢25', '¬¢10', '¬¢5', '¬¢1'].map(denom => {
                          const data = getDenomData(amData.drawer1.counts, denom);
                          return `<div>${denom}: ${data.count} = $${data.total}</div>`;
                        }).join('')}
                        <div class="drawer-total">TOTAL: $${amData.drawer1.total.toFixed(2)}</div>
                    </div>
                    
                    <div class="cash-count" style="margin-top: 4px;">
                        <div style="font-weight: bold; text-decoration: underline; margin-bottom: 2px;">DRAWER 2</div>
                        ${['$100', '$50', '$20', '$10', '$5', '$1', '¬¢25', '¬¢10', '¬¢5', '¬¢1'].map(denom => {
                          const data = getDenomData(amData.drawer2.counts, denom);
                          return `<div>${denom}: ${data.count} = $${data.total}</div>`;
                        }).join('')}
                        <div class="drawer-total">TOTAL: $${amData.drawer2.total.toFixed(2)}</div>
                    </div>
                    
                    <div class="shift-total am-bg">TOTAL AM: $${amData.total.toFixed(2)}</div>
                </div>
                
                <!-- PM Counts -->
                <div class="column">
                    <div style="text-align: center; font-weight: bold; font-size: 8px; margin-bottom: 3px; background-color: #fff8f0; padding: 2px;">PM COUNTS</div>
                    
                    <div class="cash-count">
                        <div style="font-weight: bold; text-decoration: underline; margin-bottom: 2px;">DRAWER 1</div>
                        ${['$100', '$50', '$20', '$10', '$5', '$1', '¬¢25', '¬¢10', '¬¢5', '¬¢1'].map(denom => {
                          const data = getDenomData(pmData.pm_drawer1_data, denom);
                          return `<div>${denom}: ${data.count} = $${data.total}</div>`;
                        }).join('')}
                        <div class="drawer-total">TOTAL: $${pmData.pm_drawer1_total.toFixed(2)}</div>
                    </div>
                    
                    <div class="cash-count" style="margin-top: 4px;">
                        <div style="font-weight: bold; text-decoration: underline; margin-bottom: 2px;">DRAWER 2</div>
                        ${['$100', '$50', '$20', '$10', '$5', '$1', '¬¢25', '¬¢10', '¬¢5', '¬¢1'].map(denom => {
                          const data = getDenomData(pmData.pm_drawer2_data, denom);
                          return `<div>${denom}: ${data.count} = $${data.total}</div>`;
                        }).join('')}
                        <div class="drawer-total">TOTAL: $${pmData.pm_drawer2_total.toFixed(2)}</div>
                    </div>
                    
                    <div class="shift-total pm-bg">TOTAL PM: $${pmData.pm_total.toFixed(2)}</div>
                </div>
            </div>
            
            <!-- Overall Drawer Totals Summary -->
            <div style="margin-top: 8px; padding-top: 8px; border-top: 2px solid #000;">
                <div style="text-align: center; font-weight: bold; font-size: 10px; margin-bottom: 6px;">DRAWER TOTALS SUMMARY</div>
                <div class="two-column">
                    <div class="column">
                        <div style="font-size: 8px; font-weight: bold; text-align: center; margin-bottom: 3px;">DRAWER 1 TOTALS</div>
                        <div style="font-size: 8px;">
                            <div style="display: flex; justify-content: space-between; margin: 1px 0;">
                                <span>AM:</span>
                                <span>$${amData.drawer1.total.toFixed(2)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin: 1px 0;">
                                <span>PM:</span>
                                <span>$${pmData.pm_drawer1_total.toFixed(2)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin: 1px 0; border-top: 1px solid #000; padding-top: 1px; font-weight: bold;">
                                <span>Change:</span>
                                <span>$${(pmData.pm_drawer1_total - amData.drawer1.total).toFixed(2)}</span>
                            </div>
                        </div>
                    </div>
                    <div class="column">
                        <div style="font-size: 8px; font-weight: bold; text-align: center; margin-bottom: 3px;">DRAWER 2 TOTALS</div>
                        <div style="font-size: 8px;">
                            <div style="display: flex; justify-content: space-between; margin: 1px 0;">
                                <span>AM:</span>
                                <span>$${amData.drawer2.total.toFixed(2)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin: 1px 0;">
                                <span>PM:</span>
                                <span>$${pmData.pm_drawer2_total.toFixed(2)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin: 1px 0; border-top: 1px solid #000; padding-top: 1px; font-weight: bold;">
                                <span>Change:</span>
                                <span>$${(pmData.pm_drawer2_total - amData.drawer2.total).toFixed(2)}</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div style="text-align: center; font-weight: bold; font-size: 9px; margin-top: 6px; padding: 4px; border: 2px solid #000; background-color: #f0f0f0;">
                    COMBINED DRAWER CHANGE: $${(actualCashIn).toFixed(2)}
                </div>
            </div>
        </div>
    </body>
    </html>
    `;
    
    console.log('Generated HTML length:', htmlContent.length);
    return htmlContent;
  }
  
  function generateDateRangeReportHtml(startDate, endDate, data, realEnvelopeAmount = null) {
    // Calculate totals according to requirements
    let totalToastSalesReported = 0;
    let totalActualCashIn = 0;
    let totalDiscrepancy = 0;
    let totalOriginalCashTips = 0;
    let totalAdjustedCashTips = 0;
    let totalEnvelopeDeposits = 0;
    let totalBackToCashbox = 0;
    
    data.forEach(day => {
      totalToastSalesReported += day.pm_toast_sales || 0;
      totalActualCashIn += (day.pm_total - day.am_total) || 0;
      totalDiscrepancy += day.pm_discrepancy || 0;
      totalOriginalCashTips += day.pm_cash_tips || 0;
      totalAdjustedCashTips += day.pm_adjusted_tips || 0;
      totalEnvelopeDeposits += day.pm_deposit_amount || 0;
      // Fix: Calculate actual excess returned to cashbox (not total amount)
      totalBackToCashbox += (day.pm_amount_to_keep - day.am_total) || 0;
    });
    
    return `
      <div style="font-family: Arial, sans-serif; max-width: 900px; margin: 0 auto; font-size: 14px; line-height: 1.3;">
        <!-- Title with Confidential -->
        <div style="text-align: center; margin-bottom: 25px; padding: 15px; background: #f0f0f0; border-radius: 8px; border: 2px solid #000;">
          <h2 style="margin: 0; color: #333; font-size: 18px; font-weight: bold;">**CONFIDENTIAL**</h2>
          <h2 style="margin: 5px 0; color: #333; font-size: 16px;">JAYNA GYRO MULTI-DAY CASH REPORT</h2>
          <p style="margin: 5px 0; font-size: 14px; color: #666; font-weight: bold;">
            ${new Date(startDate + 'T12:00:00').toLocaleDateString()} - ${new Date(endDate + 'T12:00:00').toLocaleDateString()}
          </p>
          <p style="margin: 5px 0; font-size: 12px; color: #888;">${data.length} days included</p>
        </div>
        
        <!-- Key Totals Grid -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px;">
          
          <div style="background: #e6f3ff; padding: 15px; border: 2px solid #000; border-radius: 8px; text-align: center;">
            <h4 style="margin: 0 0 8px 0; color: #1e3c72; font-size: 12px;">TOTAL TOAST CASH SALES REPORTED</h4>
            <p style="font-size: 20px; font-weight: bold; margin: 0; color: #1e3c72;">$${totalToastSalesReported.toFixed(2)}</p>
          </div>
          
          <div style="background: #f0f8ff; padding: 15px; border: 2px solid #000; border-radius: 8px; text-align: center;">
            <h4 style="margin: 0 0 8px 0; color: #28a745; font-size: 12px;">TOTAL ACTUAL CASH IN</h4>
            <p style="font-size: 20px; font-weight: bold; margin: 0; color: #28a745;">$${totalActualCashIn.toFixed(2)}</p>
            <p style="font-size: 10px; margin: 5px 0 0 0; color: #666;">(Based on PM-AM counts for each day)</p>
          </div>
          
          <div style="background: #ffe6e6; padding: 15px; border: 2px solid #000; border-radius: 8px; text-align: center;">
            <h4 style="margin: 0 0 8px 0; color: #dc3545; font-size: 12px;">TOTAL DISCREPANCY</h4>
            <p style="font-size: 20px; font-weight: bold; margin: 0; color: #dc3545;">
              ${totalDiscrepancy >= 0 ? '+' : ''}$${totalDiscrepancy.toFixed(2)}
            </p>
            <p style="font-size: 10px; margin: 5px 0 0 0; color: #666;">(Between Toast and Count)</p>
          </div>
          
          <div style="background: #fff3e0; padding: 15px; border: 2px solid #000; border-radius: 8px; text-align: center;">
            <h4 style="margin: 0 0 8px 0; color: #ff9800; font-size: 12px;">TOTAL CASH TIPS ORIGINALLY REPORTED</h4>
            <p style="font-size: 20px; font-weight: bold; margin: 0; color: #ff9800;">$${totalOriginalCashTips.toFixed(2)}</p>
          </div>
          
          <div style="background: #f3e5f5; padding: 15px; border: 2px solid #000; border-radius: 8px; text-align: center;">
            <h4 style="margin: 0 0 8px 0; color: #9c27b0; font-size: 12px;">TOTAL ADJUSTED CASH TIPS</h4>
            <p style="font-size: 20px; font-weight: bold; margin: 0; color: #9c27b0;">$${totalAdjustedCashTips.toFixed(2)}</p>
            <p style="font-size: 10px; margin: 5px 0 0 0; color: #666;">(Adjusted to make up for discrepancies)</p>
          </div>
          
          <div style="background: #e8f5e8; padding: 15px; border: 2px solid #000; border-radius: 8px; text-align: center;">
            <h4 style="margin: 0 0 8px 0; color: #2e7d32; font-size: 12px;">TOTAL ENVELOPE DEPOSITS</h4>
            <p style="font-size: 20px; font-weight: bold; margin: 0; color: #2e7d32;">$${totalEnvelopeDeposits}</p>
          </div>
          
          <div style="background: #fff8e1; padding: 15px; border: 2px solid #000; border-radius: 8px; text-align: center;">
            <h4 style="margin: 0 0 8px 0; color: #f57c00; font-size: 12px;">TOTAL "BACK TO CASHBOX"</h4>
            <p style="font-size: 20px; font-weight: bold; margin: 0; color: #f57c00;">$${totalBackToCashbox.toFixed(2)}</p>
          </div>
          
          ${realEnvelopeAmount !== null ? `
          <div style="background: #f3e5f5; padding: 15px; border: 2px solid #000; border-radius: 8px; text-align: center;">
            <h4 style="margin: 0 0 8px 0; color: #7b1fa2; font-size: 12px;">REAL ENVELOPE AMOUNT</h4>
            <p style="font-size: 20px; font-weight: bold; margin: 0; color: #7b1fa2;">$${realEnvelopeAmount.toFixed(2)}</p>
          </div>
          
          <div style="background: #e8f5e8; padding: 15px; border: 2px solid #000; border-radius: 8px; text-align: center;">
            <h4 style="margin: 0 0 8px 0; color: #2e7d32; font-size: 12px;">ENVELOPE DIFFERENCE</h4>
            <p style="font-size: 20px; font-weight: bold; margin: 0; color: ${(realEnvelopeAmount - totalEnvelopeDeposits) >= 0 ? '#2e7d32' : '#d32f2f'};">
              $${(realEnvelopeAmount - totalEnvelopeDeposits).toFixed(2)}
            </p>
          </div>
          ` : ''}
          
        </div>
        
        <!-- Daily Breakdown Table -->
        <div style="border: 2px solid #000; margin: 20px 0; border-radius: 8px; overflow: hidden;">
          <div style="background: #f0f0f0; padding: 10px; border-bottom: 2px solid #000;">
            <h4 style="margin: 0; text-align: center; font-size: 14px;">DAILY BREAKDOWN</h4>
          </div>
          
          <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
              <thead>
                <tr style="background: #f8f9fa;">
                  <th style="border: 1px solid #000; padding: 8px; text-align: left;">Date</th>
                  <th style="border: 1px solid #000; padding: 8px; text-align: center;">Counter</th>
                  <th style="border: 1px solid #000; padding: 8px; text-align: right;">Toast Sales</th>
                  <th style="border: 1px solid #000; padding: 8px; text-align: right;">Actual Cash In</th>
                  <th style="border: 1px solid #000; padding: 8px; text-align: right;">Discrepancy</th>
                  <th style="border: 1px solid #000; padding: 8px; text-align: right;">Envelope</th>
                  <th style="border: 1px solid #000; padding: 8px; text-align: right;">Cashbox</th>
                </tr>
              </thead>
              <tbody>
                ${data.map(day => {
                  const actualCashIn = day.pm_total - day.am_total;
                  const discrepancySign = day.pm_discrepancy >= 0 ? '+' : '';
                  return `
                    <tr>
                      <td style="border: 1px solid #000; padding: 6px; font-weight: bold;">
                        ${new Date(day.date + 'T12:00:00').toLocaleDateString()}
                      </td>
                      <td style="border: 1px solid #000; padding: 6px; text-align: center;">
                        ${day.pm_counter || 'N/A'}
                      </td>
                      <td style="border: 1px solid #000; padding: 6px; text-align: right;">
                        $${(day.pm_toast_sales || 0).toFixed(2)}
                      </td>
                      <td style="border: 1px solid #000; padding: 6px; text-align: right;">
                        $${actualCashIn.toFixed(2)}
                      </td>
                      <td style="border: 1px solid #000; padding: 6px; text-align: right; color: ${day.pm_discrepancy >= 0 ? '#28a745' : '#dc3545'};">
                        ${discrepancySign}$${Math.abs(day.pm_discrepancy || 0).toFixed(2)}
                      </td>
                      <td style="border: 1px solid #000; padding: 6px; text-align: right;">
                        $${day.pm_deposit_amount || 0}
                      </td>
                      <td style="border: 1px solid #000; padding: 6px; text-align: right;">
                        $${(day.pm_amount_to_keep || 0).toFixed(2)}
                      </td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    `;
  }
  
  function resetForm(shift) {
    document.getElementById(`${shift}Counter`).value = '';
    document.getElementById(`${shift}Notes`).value = '';
    
    // Reset drawer skips
    document.getElementById(`${shift}Drawer1Skip`).checked = false;
    document.getElementById(`${shift}Drawer2Skip`).checked = false;
    toggleSkip(shift, 1);
    toggleSkip(shift, 2);
    
    // Reset all denomination inputs
    DENOMINATIONS.forEach((denom, index) => {
      document.getElementById(`${shift}D1Q${index}`).value = '0';
      document.getElementById(`${shift}D2Q${index}`).value = '0';
    });
    
    if (shift === 'pm') {
      document.getElementById('toastSales').value = '';
      document.getElementById('cashTips').value = '';
    }
    
    updateCalculations(shift, 1);
    updateCalculations(shift, 2);
  }

  // ===== TIP POOL CALCULATOR FUNCTIONS =====
  
  // Global state for tip pool calculations
  let tipPoolRecords = [];
  let tipPoolSummary = {};
  
  // Predefined equity mapping - can be extended as needed
  const defaultEquity = {
    'Dokcu, Huseyin': 2/3,
    'Morales, Emilio': 0.5
  };

  // Helper function to show error messages
  function showErrorMessage(message, targetSectionId = null) {
    const errorMsg = document.createElement('div');
    errorMsg.className = 'message error';
    errorMsg.innerHTML = `<strong>‚ùå Error:</strong> ${message}`;
    
    let targetSection;
    
    if (targetSectionId) {
      // Use specified target section
      targetSection = document.getElementById(targetSectionId);
    } else {
      // Find the currently active section
      targetSection = document.querySelector('.form-section.active');
    }
    
    if (targetSection) {
      // Insert at the top of the target section
      const firstChild = targetSection.firstElementChild;
      targetSection.insertBefore(errorMsg, firstChild.nextSibling);
    } else {
      // Fallback to tip pool form if no target section found
      const tipPoolForm = document.getElementById('tipPoolForm');
      const firstChild = tipPoolForm.firstElementChild;
      tipPoolForm.insertBefore(errorMsg, firstChild.nextSibling);
    }
    
    // Remove message after 8 seconds (longer for historical report errors)
    setTimeout(() => {
      if (errorMsg.parentNode) {
        errorMsg.remove();
      }
    }, 8000);
  }

  // Helper function to show success messages
  function showSuccessMessage(message, targetSectionId = 'tipPoolForm') {
    console.log('showSuccessMessage called with:', message);
    const successMsg = document.createElement('div');
    successMsg.className = 'message success';
    successMsg.innerHTML = `<strong>‚úÖ Success:</strong> ${message}`;
    
    // Insert at the top of the specified form
    const targetForm = document.getElementById(targetSectionId);
    console.log(`${targetSectionId} form found:`, targetForm);
    const firstChild = targetForm.firstElementChild;
    targetForm.insertBefore(successMsg, firstChild.nextSibling);
    console.log('Success message inserted');
    
    // Remove message after 5 seconds
    setTimeout(() => {
      if (successMsg.parentNode) {
        successMsg.remove();
      }
    }, 5000);
    console.log('showSuccessMessage completed');
  }

  // ===== DATA PERSISTENCE FUNCTIONS =====
  
  // Save tip pool data to localStorage
  function saveTipPoolData() {
    try {
      const tipPoolData = {
        tipPoolRecords: tipPoolRecords,
        tipPoolSummary: tipPoolSummary,
        formData: {
          startDate: document.getElementById('tipPoolStartDate').value,
          endDate: document.getElementById('tipPoolEndDate').value,
          realEnvelopeDeposit: document.getElementById('realEnvelopeDeposit').value,
          ezcaterTips: document.getElementById('ezcaterTips').value,
          tdsDriverTips: document.getElementById('tdsDriverTips').value,
          calculatedByName: document.getElementById('calculatedByName').value,
          calculatedCashTips: document.getElementById('calculatedCashTips').value
        },
        timestamp: new Date().toISOString()
      };
      localStorage.setItem('jaynaGyroCashCounter_tipPoolData', JSON.stringify(tipPoolData));
      console.log('Tip pool data saved to localStorage');
    } catch (error) {
      console.error('Error saving tip pool data:', error);
    }
  }
  
  // Load tip pool data from localStorage
  function loadTipPoolData() {
    try {
      const saved = localStorage.getItem('jaynaGyroCashCounter_tipPoolData');
      if (!saved) return false;
      
      const tipPoolData = JSON.parse(saved);
      
      // Check if data is older than 1 hour (3600000 ms)
      if (tipPoolData.timestamp) {
        const saveTime = new Date(tipPoolData.timestamp);
        const now = new Date();
        const ageInMs = now - saveTime;
        const oneHourInMs = 60 * 60 * 1000; // 1 hour = 3600000 ms
        
        if (ageInMs > oneHourInMs) {
          console.log(`Tip pool data is ${Math.round(ageInMs / (1000 * 60))} minutes old - clearing expired data`);
          localStorage.removeItem('jaynaGyroCashCounter_tipPoolData');
          return false;
        }
        
        console.log(`Tip pool data is ${Math.round(ageInMs / (1000 * 60))} minutes old - still valid`);
      }
      
      // Restore global state
      tipPoolRecords = tipPoolData.tipPoolRecords || [];
      tipPoolSummary = tipPoolData.tipPoolSummary || {};
      
      // Restore form data
      if (tipPoolData.formData) {
        const form = tipPoolData.formData;
        document.getElementById('tipPoolStartDate').value = form.startDate || '';
        document.getElementById('tipPoolEndDate').value = form.endDate || '';
        document.getElementById('realEnvelopeDeposit').value = form.realEnvelopeDeposit || '';
        document.getElementById('ezcaterTips').value = form.ezcaterTips || '';
        document.getElementById('tdsDriverTips').value = form.tdsDriverTips || '';
        document.getElementById('calculatedByName').value = form.calculatedByName || '';
        document.getElementById('calculatedCashTips').value = form.calculatedCashTips || '';
      }
      
      // Prepare results but don't auto-show form
      if (tipPoolRecords.length > 0) {
        renderTipPoolSummary();
        renderTipPoolTable();
        // Results will be shown when user manually opens tip pool section
        
        // Auto-populate combined report data for when user opens reports
        document.getElementById('combinedStartDate').value = tipPoolData.formData?.startDate || '';
        document.getElementById('combinedEndDate').value = tipPoolData.formData?.endDate || '';
        document.getElementById('combinedRealEnvelope').value = tipPoolData.formData?.realEnvelopeDeposit || '';
        
        console.log(`Tip pool data loaded from ${new Date(tipPoolData.timestamp).toLocaleString()} - ready when user opens tip pool`);
      }
      
      console.log('Tip pool data loaded from localStorage');
      return true;
    } catch (error) {
      console.error('Error loading tip pool data:', error);
      return false;
    }
  }
  
  // Save combined report data to localStorage
  function saveCombinedReportData() {
    try {
      const combinedData = {
        formData: {
          startDate: document.getElementById('combinedStartDate').value,
          endDate: document.getElementById('combinedEndDate').value,
          realEnvelope: document.getElementById('combinedRealEnvelope').value
        },
        lastCashData: window.lastCombinedCashData || null,
        timestamp: new Date().toISOString()
      };
      localStorage.setItem('jaynaGyroCashCounter_combinedReportData', JSON.stringify(combinedData));
      console.log('Combined report data saved to localStorage');
    } catch (error) {
      console.error('Error saving combined report data:', error);
    }
  }
  
  // Load combined report data from localStorage
  function loadCombinedReportData() {
    try {
      const saved = localStorage.getItem('jaynaGyroCashCounter_combinedReportData');
      if (!saved) return false;
      
      const combinedData = JSON.parse(saved);
      
      // Restore form data
      if (combinedData.formData) {
        const form = combinedData.formData;
        document.getElementById('combinedStartDate').value = form.startDate || '';
        document.getElementById('combinedEndDate').value = form.endDate || '';
        document.getElementById('combinedRealEnvelope').value = form.realEnvelope || '';
      }
      
      // Restore cash data for re-generation
      if (combinedData.lastCashData) {
        window.lastCombinedCashData = combinedData.lastCashData;
      }
      
      console.log('Combined report data loaded from localStorage');
      return true;
    } catch (error) {
      console.error('Error loading combined report data:', error);
      return false;
    }
  }
  
  // Clear all saved data
  function clearSavedData() {
    try {
      localStorage.removeItem('jaynaGyroCashCounter_tipPoolData');
      localStorage.removeItem('jaynaGyroCashCounter_combinedReportData');
      
      // Reset tip pool state
      tipPoolRecords = [];
      tipPoolSummary = {};
      
      // Reset forms
      document.getElementById('tipPoolForm').reset();
      document.getElementById('combinedReportForm').reset();
      
      // Hide results
      document.getElementById('tipPoolResults').style.display = 'none';
      document.getElementById('tipPoolPdfBtn').style.display = 'none';
      document.getElementById('combinedReportSection').style.display = 'none';
      document.getElementById('tipPoolForm').classList.remove('active');
      
      showSuccessMessage('All saved data cleared. You can start fresh.');
      console.log('All saved data cleared');
    } catch (error) {
      console.error('Error clearing saved data:', error);
      showErrorMessage('Error clearing saved data: ' + error.message);
    }
  }

  async function calculateCashTips() {
    const startDate = document.getElementById('tipPoolStartDate').value;
    const endDate = document.getElementById('tipPoolEndDate').value;
    const realEnvelopeDeposit = parseFloat(document.getElementById('realEnvelopeDeposit').value) || 0;

    if (!startDate || !endDate) {
      document.getElementById('calculatedCashTips').value = '';
      return;
    }

    if (!realEnvelopeDeposit) {
      document.getElementById('calculatedCashTips').value = '';
      return;
    }

    try {
      // Copy exact working query from generateDateRangePDF
      const { data: rangeData } = await supabase
        .from('cash_counts')
        .select('*')
        .gte('date', startDate)
        .lte('date', endDate)
        .not('pm_total', 'is', null)
        .order('date', { ascending: true });

      if (!rangeData || rangeData.length === 0) {
        document.getElementById('calculatedCashTips').value = '';
        return;
      }

      // Calculate total Toast cash sales using correct column name
      let totalToastCashSales = 0;
      totalToastCashSales = rangeData.reduce((sum, day) => sum + (day.pm_toast_sales || 0), 0);

      // Calculate cash tips: Real Envelope Deposit - Toast Cash Sales
      const calculatedCashTips = realEnvelopeDeposit - totalToastCashSales;
      
      // Update the display
      document.getElementById('calculatedCashTips').value = calculatedCashTips.toFixed(2);

    } catch (error) {
      console.error('Error calculating cash tips:', error);
      document.getElementById('calculatedCashTips').value = '';
    }
  }

  async function calculateTipPool() {
    const laborFile = document.getElementById('laborFile').files[0];
    const salesFile = document.getElementById('salesFile').files[0];
    const startDate = document.getElementById('tipPoolStartDate').value;
    const endDate = document.getElementById('tipPoolEndDate').value;
    const realEnvelopeDeposit = parseFloat(document.getElementById('realEnvelopeDeposit').value) || 0;
    const ezcaterTips = parseFloat(document.getElementById('ezcaterTips').value) || 0;
    const tdsDriverTips = parseFloat(document.getElementById('tdsDriverTips').value) || 0;
    const calculatedByName = document.getElementById('calculatedByName').value.trim();

    if (!laborFile || !salesFile) {
      showErrorMessage('Please select both Labor Summary CSV and Sales Summary ZIP files.');
      return;
    }

    if (!startDate || !endDate) {
      showErrorMessage('Please select both start and end dates for cash sales calculation.');
      return;
    }

    if (!realEnvelopeDeposit) {
      showErrorMessage('Please enter the Real Envelope Deposit amount.');
      return;
    }

    if (!calculatedByName) {
      showErrorMessage('Please enter your name in the "Tips Calculated By" field.');
      return;
    }

    try {
      showLoading('Calculating Tip Pool', 'Processing payroll, sales data, and fetching cash sales...');

      // First, get Toast Cash Sales from Supabase for the date range
      const start = new Date(startDate + 'T12:00:00');
      const end = new Date(endDate + 'T12:00:00');

      if (start > end) {
        throw new Error('Start date must be before end date');
      }

      const diffTime = Math.abs(end - start);
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      
      if (diffDays > 7) {
        throw new Error('Date range cannot exceed 7 days');
      }

      // Copy exact working query from generateDateRangePDF
      const { data: rangeData } = await supabase
        .from('cash_counts')
        .select('*')
        .gte('date', startDate)
        .lte('date', endDate)
        .not('pm_total', 'is', null)
        .order('date', { ascending: true });

      if (!rangeData || rangeData.length === 0) {
        throw new Error('No cash count data found for this date range');
      }

      // Calculate total Toast cash sales using correct column name
      let totalToastCashSales = 0;
      totalToastCashSales = rangeData.reduce((sum, day) => sum + (day.pm_toast_sales || 0), 0);

      // Calculate cash tips: Real Envelope Deposit - Toast Cash Sales
      const calculatedCashTips = realEnvelopeDeposit - totalToastCashSales;
      
      // Update the cash tips display
      document.getElementById('calculatedCashTips').value = calculatedCashTips.toFixed(2);

      // Parse files
      const payrollData = await parsePayrollCSV(laborFile);
      const { creditTips, cashSales } = await parseSalesZip(salesFile);

      // Compute tip pool using calculated cash tips
      const result = computeTipPool(
        payrollData,
        creditTips,
        calculatedCashTips,
        ezcaterTips,
        tdsDriverTips,
        cashSales
      );

      // Store global state
      tipPoolRecords = result.records;
      
      // Parse date range from filename
      const dateRange = parseDateRange(laborFile.name) || parseDateRange(salesFile.name);
      
      tipPoolSummary = {
        creditTips: creditTips,
        cashSales: cashSales,
        cashTips: calculatedCashTips,
        realEnvelopeDeposit: realEnvelopeDeposit,
        toastCashSales: totalToastCashSales,
        ezcaterTips: ezcaterTips,
        tdsDriverTips: tdsDriverTips,
        totalTips: result.totalTips,
        pool: result.pool,
        totalWeightedHours: result.totalWeightedHours,
        hourlyRate: result.rate,
        cashNeeded: result.cashNeeded,
        dateRange: dateRange,
        calculatedByName: calculatedByName,
        generatedAt: new Date().toLocaleString()
      };

      // Display results for user to review
      console.log('About to render tip pool summary and table...');
      renderTipPoolSummary();
      console.log('Tip pool summary rendered');
      renderTipPoolTable();
      console.log('Tip pool table rendered');
      
      console.log('About to show tip pool results div...');
      document.getElementById('tipPoolResults').style.display = 'block';
      document.getElementById('tipPoolPdfBtn').style.display = 'inline-block';
      document.getElementById('combinedReportSection').style.display = 'block';
      
      // Auto-populate combined report data from tip pool inputs
      document.getElementById('combinedStartDate').value = startDate;
      document.getElementById('combinedEndDate').value = endDate;
      document.getElementById('combinedRealEnvelope').value = realEnvelopeDeposit.toString();
      console.log('Auto-populated combined report data:', { startDate, endDate, realEnvelopeDeposit });
      
      // Save tip pool data for persistence
      saveTipPoolData();
      
      // Ensure tip pool form stays active
      document.getElementById('tipPoolForm').classList.add('active');
      console.log('Tip pool results div should now be visible');

      hideLoading();
      
      // Show success message with instruction to review equity
      showSuccessMessage('Tip pool calculated successfully! Please review and adjust equity percentages if needed, then click "Download Tip Pool PDF".');
      
      // Debug: Check if elements are still visible after success message
      setTimeout(() => {
        const resultsDiv = document.getElementById('tipPoolResults');
        const formDiv = document.getElementById('tipPoolForm');
        console.log('FINAL CHECK - Results div display:', resultsDiv.style.display);
        console.log('FINAL CHECK - Form div classes:', formDiv.className);
        console.log('FINAL CHECK - Form div active?', formDiv.classList.contains('active'));
        console.log('FINAL CHECK - Results div visible?', resultsDiv.offsetHeight > 0);
        console.log('FINAL CHECK - Form div visible?', formDiv.offsetHeight > 0);
      }, 100);
      
      console.log('calculateTipPool function completed successfully');
      
    } catch (error) {
      hideLoading();
      console.error('Tip pool calculation error:', error);
      showErrorMessage(`Error: ${error.message}`);
    }
  }

  async function downloadTipPoolPDF() {
    try {
      showLoading('Generating PDF', 'Creating tip pool distribution report...');
      
      await generateTipPoolPDF();
      
      hideLoading();
      showTipPoolSuccessMessage();
      
    } catch (error) {
      hideLoading();
      console.error('PDF generation error:', error);
      showErrorMessage(`Error generating PDF: ${error.message}`);
    }
  }

  async function downloadCombinedReportPDF() {
    try {
      const startDate = document.getElementById('combinedStartDate').value;
      const endDate = document.getElementById('combinedEndDate').value;
      const realEnvelopeAmount = parseFloat(document.getElementById('combinedRealEnvelope').value) || null;

      if (!startDate || !endDate) {
        showErrorMessage('Please select both start and end dates for the cash report period.');
        return;
      }

      if (!tipPoolRecords || tipPoolRecords.length === 0) {
        showErrorMessage('Please calculate tip pool first before generating combined report.');
        return;
      }

      showLoading('Generating Combined PDF', 'Creating combined weekly report...');

      // Fetch cash count data for the date range
      const start = new Date(startDate + 'T12:00:00');
      const end = new Date(endDate + 'T12:00:00');

      if (start > end) {
        throw new Error('Start date must be before end date');
      }

      const diffTime = Math.abs(end - start);
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      
      if (diffDays > 7) {
        throw new Error('Date range cannot exceed 7 days');
      }

      // Get cash data
      const { data: rangeData } = await supabase
        .from('cash_counts')
        .select('*')
        .gte('date', startDate)
        .lte('date', endDate)
        .not('pm_total', 'is', null)
        .order('date', { ascending: true });

      if (!rangeData || rangeData.length === 0) {
        throw new Error('No cash count data found for this date range');
      }

      // Store cash data for potential re-generation
      window.lastCombinedCashData = rangeData;
      
      // Save combined report data for persistence
      saveCombinedReportData();

      // Generate clean PDF using jsPDF (like tip pool report)
      await generateCombinedReportPDF(startDate, endDate, rangeData, realEnvelopeAmount);
      
      hideLoading();
      showSuccessMessage('Combined weekly report generated successfully!');
      
    } catch (error) {
      hideLoading();
      console.error('Combined PDF generation error:', error);
      showErrorMessage(`Error generating combined report: ${error.message}`);
    }
  }

  function parseDateRange(filename) {
    const re = /(\d{4})[_-](\d{2})[_-](\d{2})[-_](\d{4})[_-](\d{2})[_-](\d{2})/;
    const match = filename.match(re);
    if (!match) return '';
    
    const [, y1, m1, d1, y2, m2, d2] = match;
    const startMonth = parseInt(m1, 10).toString();
    const startDay = parseInt(d1, 10).toString();
    const endMonth = parseInt(m2, 10).toString();
    const endDay = parseInt(d2, 10).toString();
    
    return `${startMonth}/${startDay}‚Äî${endMonth}/${endDay} ${y2}`;
  }

  function parsePayrollCSV(file) {
    return new Promise((resolve, reject) => {
      Papa.parse(file, {
        header: true,
        skipEmptyLines: true,
        complete: function(results) {
          const data = results.data;
          const employeeMap = {};
          
          data.forEach(row => {
            const emp = row['Employee'];
            if (!emp) return;
            
            const regHours = parseFloat(row['Regular Hours']) || 0;
            const otHours = parseFloat(row['Overtime Hours']) || 0;
            const total = regHours + otHours;
            
            if (!employeeMap[emp]) {
              employeeMap[emp] = { hours: 0 };
            }
            employeeMap[emp].hours += total;
          });
          
          const result = [];
          for (const emp in employeeMap) {
            const parts = emp.split(',');
            const last = parts[0].trim();
            const first = parts.slice(1).join(',').trim();
            result.push({ 
              employee: emp, 
              first: first, 
              last: last, 
              hours: employeeMap[emp].hours 
            });
          }
          
          resolve(result);
        },
        error: function(err) {
          reject(err);
        }
      });
    });
  }

  async function parseSalesZip(file) {
    const arrayBuffer = await file.arrayBuffer();
    const zip = await JSZip.loadAsync(arrayBuffer);
    
    // Find Payments summary CSV
    let paymentsFile = null;
    zip.forEach((relativePath, zipEntry) => {
      if (relativePath.endsWith('Payments summary.csv')) {
        paymentsFile = zipEntry;
      }
    });
    
    if (!paymentsFile) {
      return { creditTips: 0, cashSales: 0 };
    }
    
    const paymentsCsv = await paymentsFile.async('string');
    const parsed = Papa.parse(paymentsCsv, { header: true, skipEmptyLines: true });
    
    let creditTips = 0;
    let cashSales = 0;
    
    parsed.data.forEach(row => {
      const paymentType = row['Payment type'] ? row['Payment type'].trim() : '';
      const paymentSubType = row['Payment sub type'];
      
      // Credit tips from detailed card types only
      if (paymentType === 'Credit/debit' && paymentSubType && paymentSubType.trim() !== '') {
        creditTips += parseFloat(row['Tips']) || 0;
      }
      
      if (paymentType === 'Cash') {
        cashSales += parseFloat(row['Amount']) || 0;
      }
    });
    
    return { creditTips, cashSales };
  }

  function computeTipPool(payrollData, creditTips, cashTips, ezcaterTips, tdsDriverTips, cashSales) {
    // Build equity mapping
    const equityMap = {};
    payrollData.forEach(rec => {
      equityMap[rec.employee] = defaultEquity.hasOwnProperty(rec.employee) 
        ? defaultEquity[rec.employee] 
        : 1.0;
    });
    
    // Compute weighted hours
    let totalWeightedHours = 0;
    const records = payrollData.map(rec => {
      const equity = equityMap[rec.employee];
      const weighted = rec.hours * equity;
      totalWeightedHours += weighted;
      
      return {
        employee: rec.employee,
        first: rec.first,
        last: rec.last,
        hours: rec.hours,
        equity: equity,
        weighted: weighted,
        due: 0
      };
    });
    
    // Calculate pool
    const totalTips = creditTips + cashTips + ezcaterTips;
    const rawPool = totalTips - tdsDriverTips;
    const pool = Math.floor(rawPool); // Floor to whole dollar
    
    // Calculate hourly rate
    const rate = totalWeightedHours ? pool / totalWeightedHours : 0;
    
    // Calculate due amounts (floored to whole dollars)
    records.forEach(r => {
      const rawDue = r.weighted * rate;
      r.due = Math.floor(rawDue);
    });
    
    // Calculate cash needed
    const cashNeeded = creditTips - tdsDriverTips + ezcaterTips - cashSales;
    
    return { records, rate, totalWeightedHours, totalTips, pool, cashNeeded };
  }

  function renderTipPoolSummary() {
    console.log('renderTipPoolSummary called, tipPoolSummary:', tipPoolSummary);
    const summaryDiv = document.getElementById('tipPoolSummary');
    const { cashNeeded } = tipPoolSummary;
    
    // COPY EXACT LOGIC FROM ORIGINAL TIP POOL CALCULATOR LINE 565 (CORRECT LOGIC)
    let cashStatusHtml = '';
    if (cashNeeded > 0) {
      // Need additional cash - show positive amount in red
      cashStatusHtml = `<p><strong>Cash needed to pay out tips:</strong> <span class="cash-needed">$${cashNeeded.toFixed(2)}</span></p>`;
    } else {
      // Have surplus - show positive amount in green
      cashStatusHtml = `<p><strong>Zero cash needed to pay out tips this week. Excess cash on hand:</strong> <span class="cash-surplus">$${Math.abs(cashNeeded).toFixed(2)}</span></p>`;
    }
    
    summaryDiv.innerHTML = `
      <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0;">
        <h3 style="margin: 0 0 15px 0; color: #1e3c72;">Tip Pool Summary</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
          
          <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #ddd;">
            <h4 style="margin: 0 0 8px 0; color: #666; font-size: 12px;">CREDIT TIPS</h4>
            <p style="margin: 0; font-size: 18px; font-weight: bold; color: #007bff;">$${tipPoolSummary.creditTips.toFixed(2)}</p>
          </div>
          
          <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #ddd;">
            <h4 style="margin: 0 0 8px 0; color: #666; font-size: 12px;">REAL ENVELOPE DEPOSIT</h4>
            <p style="margin: 0; font-size: 18px; font-weight: bold; color: #28a745;">$${tipPoolSummary.realEnvelopeDeposit.toFixed(2)}</p>
          </div>
          
          <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #ddd;">
            <h4 style="margin: 0 0 8px 0; color: #666; font-size: 12px;">TOAST CASH SALES</h4>
            <p style="margin: 0; font-size: 18px; font-weight: bold; color: #dc3545;">$${tipPoolSummary.toastCashSales.toFixed(2)}</p>
          </div>
          
          <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #ddd;">
            <h4 style="margin: 0 0 8px 0; color: #666; font-size: 12px;">CASH TIPS (CALCULATED)</h4>
            <p style="margin: 0; font-size: 18px; font-weight: bold; color: #28a745;">$${tipPoolSummary.cashTips.toFixed(2)}</p>
            <p style="margin: 5px 0 0 0; font-size: 10px; color: #666;">($${tipPoolSummary.realEnvelopeDeposit.toFixed(2)} - $${tipPoolSummary.toastCashSales.toFixed(2)})</p>
          </div>
          
          <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #ddd;">
            <h4 style="margin: 0 0 8px 0; color: #666; font-size: 12px;">TOTAL POOL</h4>
            <p style="margin: 0; font-size: 18px; font-weight: bold; color: #1e3c72;">$${tipPoolSummary.pool.toFixed(2)}</p>
          </div>
          
          <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #ddd;">
            <h4 style="margin: 0 0 8px 0; color: #666; font-size: 12px;">HOURLY RATE</h4>
            <p style="margin: 0; font-size: 18px; font-weight: bold; color: #f57c00;">$${tipPoolSummary.hourlyRate.toFixed(2)}</p>
          </div>
          
        </div>
        
        <!-- Cash Status from Original Logic -->
        <div style="margin-top: 15px; padding: 15px; background: white; border-radius: 8px; border: 1px solid #ddd; text-align: center;">
          ${cashStatusHtml}
        </div>
        
        <div style="margin-top: 15px; padding: 10px; background: #e3f2fd; border-radius: 8px; border-left: 4px solid #2196f3;">
          <p style="margin: 0; font-size: 14px;"><strong>Period:</strong> ${tipPoolSummary.dateRange || 'Not specified'}</p>
          <p style="margin: 5px 0 0 0; font-size: 14px;"><strong>Calculated by:</strong> ${tipPoolSummary.calculatedByName}</p>
        </div>
      </div>
    `;
  }

  function renderTipPoolTable() {
    console.log('renderTipPoolTable called, tipPoolRecords:', tipPoolRecords);
    const tableDiv = document.getElementById('tipPoolTable');
    
    let tableHtml = `
      <div style="margin: 20px 0;">
        <h3 style="color: #1e3c72; margin-bottom: 15px;">Employee Tip Distribution</h3>
        <p style="color: #666; margin-bottom: 15px; font-style: italic;">You can adjust equity percentages below. Changes will save when you click outside the input box or press Enter.</p>
        <div style="overflow-x: auto;">
          <table id="tipPoolRecordsTable" style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <thead>
              <tr style="background: #1e3c72; color: white;">
                <th style="padding: 12px; text-align: left; font-size: 14px;">#</th>
                <th style="padding: 12px; text-align: left; font-size: 14px;">First</th>
                <th style="padding: 12px; text-align: left; font-size: 14px;">Last</th>
                <th style="padding: 12px; text-align: center; font-size: 14px;">Hours</th>
                <th style="padding: 12px; text-align: center; font-size: 14px;">Equity (%)</th>
                <th style="padding: 12px; text-align: center; font-size: 14px;">Weighted Hours</th>
                <th style="padding: 12px; text-align: center; font-size: 14px;">Tips Due</th>
              </tr>
            </thead>
            <tbody>
    `;
    
    // Sort records by last name like original
    tipPoolRecords.sort((a, b) => a.last.localeCompare(b.last));
    
    tipPoolRecords.forEach((record, index) => {
      const rowBg = index % 2 === 0 ? '#f8f9fa' : 'white';
      const equityPercent = record.equity * 100;
      tableHtml += `
        <tr data-employee="${record.employee}" style="background: ${rowBg};">
          <td style="padding: 12px; border-bottom: 1px solid #ddd;">${index + 1}</td>
          <td style="padding: 12px; border-bottom: 1px solid #ddd;">${record.first}</td>
          <td style="padding: 12px; border-bottom: 1px solid #ddd;">${record.last}</td>
          <td style="padding: 12px; text-align: center; border-bottom: 1px solid #ddd;">${record.hours.toFixed(2)}</td>
          <td style="padding: 12px; text-align: center; border-bottom: 1px solid #ddd;">
            <input type="number" name="equity" step="1" min="1" max="100" value="${equityPercent.toFixed(0)}" 
                   style="width: 60px; text-align: center; border: 1px solid #ccc; border-radius: 4px; padding: 4px;" />
          </td>
          <td style="padding: 12px; text-align: center; border-bottom: 1px solid #ddd;">${record.weighted.toFixed(3)}</td>
          <td style="padding: 12px; text-align: center; border-bottom: 1px solid #ddd; font-weight: bold; color: #28a745;">$${record.due.toFixed(2)}</td>
        </tr>
      `;
    });
    
    tableHtml += `
            </tbody>
          </table>
        </div>
      </div>
    `;
    
    tableDiv.innerHTML = tableHtml;
    
    // Attach change listeners to equity inputs - use 'blur' to prevent cursor jumping
    const inputs = tableDiv.querySelectorAll('input[name="equity"]');
    inputs.forEach(inp => {
      inp.addEventListener('blur', () => {
        recomputeTipPoolFromTable();
      });
      // Also listen for Enter key to update immediately
      inp.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          inp.blur(); // Trigger blur event
        }
      });
    });
  }

  // Recompute the tip pool when equity values are changed in the table
  function recomputeTipPoolFromTable() {
    // Read equity inputs from DOM
    const rows = document.querySelectorAll('#tipPoolRecordsTable tbody tr');
    const updatedEquity = {};
    
    rows.forEach(row => {
      const emp = row.getAttribute('data-employee');
      const eqInput = row.querySelector('input[name="equity"]');
      // The equity input represents a whole percentage (1‚Äî100). Convert it
      // to a fractional equity by dividing by 100. Use 0 if parsing fails.
      const eqPercent = parseFloat(eqInput.value);
      const eqFraction = isNaN(eqPercent) ? 0 : eqPercent / 100.0;
      updatedEquity[emp] = eqFraction;
    });
    
    // Recalculate
    let totalWeightedHours = 0;
    tipPoolRecords.forEach(r => {
      r.equity = updatedEquity[r.employee];
      r.weighted = r.hours * r.equity;
      totalWeightedHours += r.weighted;
    });
    
    // Compute the raw pool and then floor it to meet business rules
    const rawPool = tipPoolSummary.totalTips - tipPoolSummary.tdsDriverTips;
    const pool = Math.floor(rawPool);
    const rate = totalWeightedHours ? pool / totalWeightedHours : 0;
    
    tipPoolRecords.forEach(r => {
      const rawDue = r.weighted * rate;
      // Round each individual's due down to the nearest whole dollar
      r.due = Math.floor(rawDue);
    });
    
    // Update summary
    tipPoolSummary.pool = pool;
    tipPoolSummary.totalWeightedHours = totalWeightedHours;
    tipPoolSummary.hourlyRate = rate;
    tipPoolSummary.cashNeeded = tipPoolSummary.creditTips - tipPoolSummary.tdsDriverTips + tipPoolSummary.ezcaterTips - tipPoolSummary.cashSales;
    
    // Auto-save updated data
    saveTipPoolData();
    
    // Rerender summary and table
    renderTipPoolSummary();
    renderTipPoolTable();
  }

  async function generateTipPoolPDF() {
    try {
      // Create jsPDF instance
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'letter' });
      
      const pageWidth = doc.internal.pageSize.getWidth();
      const pageHeight = doc.internal.pageSize.getHeight();
      const margin = 40;
      
      // Set default font to a modern sans-serif and black text
      doc.setFont('helvetica', 'normal');
      doc.setTextColor(0, 0, 0);
      
      let currentY = margin;
      
      // Header text
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(18);
      doc.text('JAYNA SAC WEEKLY TIP POOL REPORT', margin, currentY + 15);
      doc.setFontSize(10);
      doc.setFont('helvetica', 'normal');
      
      // Use uppercase labels and values for header metadata
      const dateRange = (tipPoolSummary.dateRange || '').toUpperCase();
      doc.text(`WEEK OF: ${dateRange}`, margin, currentY + 32);
      const reporter = (tipPoolSummary.calculatedByName || '').toUpperCase();
      doc.text(`RAN BY: ${reporter}`, margin, currentY + 44);
      const timestamp = (tipPoolSummary.generatedAt || '').toUpperCase();
      doc.text(`GENERATED: ${timestamp}`, margin, currentY + 56);
      
      // Draw a thin horizontal line below header for separation
      doc.setLineWidth(0.5);
      doc.line(margin, currentY + 70, pageWidth - margin, currentY + 70);
      
      // Summary section: arrange entries in two columns
      doc.setFontSize(10);
      doc.setFont('helvetica', 'normal');
      
      // Build an array of [label, value] pairs
      const entries = [
        ['Cash tips', `$${tipPoolSummary.cashTips.toFixed(2)}`],
        ['EZCater tips', `$${tipPoolSummary.ezcaterTips.toFixed(2)}`],
        ['Credit tips', `$${tipPoolSummary.creditTips.toFixed(2)}`],
        ['TDS driver', `$${tipPoolSummary.tdsDriverTips.toFixed(2)}`],
        ['Cash sales', `$${tipPoolSummary.cashSales.toFixed(2)}`],
        ['Total tips', `$${tipPoolSummary.totalTips.toFixed(2)}`],
        ['Pool (minus TDS driver)', `$${tipPoolSummary.pool.toFixed(2)}`],
        ['Total weighted hours', `${tipPoolSummary.totalWeightedHours.toFixed(3)}`],
        ['Hourly rate', `$${tipPoolSummary.hourlyRate.toFixed(2)}`]
      ].map(([label, value]) => [label.toUpperCase(), value.toUpperCase()]);
      
      // Define fixed x offsets for values within each column
      const colValueOffset = 200; // points from the left edge of the column
      let summaryY = currentY + 86;
      const lineHeight = 14;
      const colSplitIndex = Math.ceil(entries.length / 2);
      const col2X = pageWidth / 2;
      
      // Render first column
      for (let i = 0; i < colSplitIndex; i++) {
        const [label, value] = entries[i];
        doc.setFont('helvetica', 'bold');
        doc.text(`${label}:`, margin, summaryY + i * lineHeight);
        doc.setFont('helvetica', 'normal');
        doc.text(value, margin + colValueOffset, summaryY + i * lineHeight);
      }
      
      // Render second column
      for (let i = colSplitIndex; i < entries.length; i++) {
        const [label, value] = entries[i];
        const rowIdx = i - colSplitIndex;
        doc.setFont('helvetica', 'bold');
        doc.text(`${label}:`, col2X, summaryY + rowIdx * lineHeight);
        doc.setFont('helvetica', 'normal');
        doc.text(value, col2X + colValueOffset, summaryY + rowIdx * lineHeight);
      }
      
      // Cash needed line with color coding
      const cashNeeded = tipPoolSummary.cashNeeded;
      let needLabel, needValue, textColor;
      
      if (cashNeeded > 0) {
        // Need additional cash - show positive number in red
        needLabel = 'CASH NEEDED TO PAY OUT TIPS';
        needValue = `$${cashNeeded.toFixed(2)}`;
        textColor = [220, 53, 69]; // Red color
      } else {
        // Have surplus - show positive number in green
        needLabel = 'ZERO CASH NEEDED TO PAY OUT TIPS THIS WEEK. EXCESS CASH ON HAND';
        needValue = `$${Math.abs(cashNeeded).toFixed(2)}`;
        textColor = [40, 167, 69]; // Green color
      }
      
      const summaryLines = Math.max(colSplitIndex, entries.length - colSplitIndex);
      const cashY = summaryY + summaryLines * lineHeight + 10;
      
      // Set label in bold black
      doc.setFont('helvetica', 'bold');
      doc.setTextColor(0, 0, 0);
      doc.text(`${needLabel}:`, margin, cashY);
      
      // Calculate proper positioning for the value
      let valueX = margin + colValueOffset;
      let valueY = cashY;
      
      if (needLabel.length > 35) { // Long label - put value on next line
        valueX = margin;
        valueY = cashY + lineHeight;
      }
      
      // Set value in colored italic
      doc.setFont('helvetica', 'italic');
      doc.setTextColor(textColor[0], textColor[1], textColor[2]);
      doc.text(needValue, valueX, valueY);
      
      // Reset text color back to black for the rest of the document
      doc.setTextColor(0, 0, 0);
      
      // Draw a horizontal separator before the table
      const tableStartY = cashY + 25;
      doc.setFont('helvetica', 'normal');
      doc.setLineWidth(0.5);
      doc.line(margin, tableStartY - 5, pageWidth - margin, tableStartY - 5);
      
      // Prepare table data (convert names to uppercase)
      const tableBody = tipPoolRecords.map(r => [
        r.first.toUpperCase(),
        r.last.toUpperCase(),
        r.hours.toFixed(2),
        (r.equity * 100).toFixed(0),
        r.weighted.toFixed(3),
        '$' + r.due.toFixed(2)
      ]);
      
      // Generate the table
      doc.autoTable({
        head: [['FIRST', 'LAST', 'HOURS', 'EQUITY (%)', 'WEIGHTED', 'DUE']],
        body: tableBody,
        startY: tableStartY,
        margin: { left: margin, right: margin },
        styles: { font: 'helvetica', fontSize: 8, textColor: [0, 0, 0], lineColor: [0, 0, 0], lineWidth: 0.1 },
        headStyles: { font: 'helvetica', fontStyle: 'bold', textColor: [0, 0, 0], fillColor: null },
        bodyStyles: { font: 'helvetica', textColor: [0, 0, 0], fillColor: null },
        tableWidth: 'auto'
      });
      
      // Generate filename and save
      const dateStr = tipPoolSummary.dateRange || new Date().toLocaleDateString().replace(/\//g, '-');
      const filename = `Tip_Pool_Distribution_${dateStr}.pdf`;
      doc.save(filename);
      
    } catch (error) {
      console.error('PDF generation error:', error);
      throw error;
    }
  }

  async function generateCombinedReportPDF(startDate, endDate, cashData, realEnvelopeAmount = null, cashboxTotal = null) {
    try {
      // Fetch cashbox reconciliation data
      let cashboxReconciliation = null;
      if (cashboxTotal !== null) {
        cashboxReconciliation = await getCashboxReconciliation(cashboxTotal);
      }
      
      // Create jsPDF instance
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'letter' });
      
      const pageWidth = doc.internal.pageSize.getWidth();
      const pageHeight = doc.internal.pageSize.getHeight();
      const margin = 40;
      
      // Set default font to a modern sans-serif and black text
      doc.setFont('helvetica', 'normal');
      doc.setTextColor(0, 0, 0);
      
      let currentY = margin;
      
      // Header text with tighter spacing
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(16);  // Reduced from 18
      doc.text('JAYNA GYRO COMBINED WEEKLY REPORT', margin, currentY + 12);
      doc.setFontSize(9);   // Reduced from 10
      doc.setFont('helvetica', 'normal');
      
      // Use uppercase labels and values for header metadata with tighter spacing
      const dateRange = `${startDate.toUpperCase()} TO ${endDate.toUpperCase()}`;
      doc.text(`WEEK OF: ${dateRange}`, margin, currentY + 26);  // Reduced spacing
      const reporter = (tipPoolSummary.calculatedByName || '').toUpperCase();
      doc.text(`RAN BY: ${reporter}`, margin, currentY + 36);     // Reduced spacing
      const timestamp = new Date().toLocaleString().toUpperCase();
      doc.text(`GENERATED: ${timestamp}`, margin, currentY + 46); // Reduced spacing
      
      // Draw a thin horizontal line below header for separation
      doc.setLineWidth(0.5);
      doc.line(margin, currentY + 56, pageWidth - margin, currentY + 56); // Reduced spacing
      
      // Calculate cash report totals using same logic
      let totalToastSalesReported = 0;
      let totalActualCashIn = 0;
      let totalDiscrepancy = 0;
      let totalEnvelopeDeposits = 0;
      let totalBackToCashbox = 0;

      cashData.forEach(day => {
        totalToastSalesReported += day.pm_toast_sales || 0;
        totalActualCashIn += (day.pm_total - day.am_total) || 0;
        totalDiscrepancy += day.pm_discrepancy || 0;
        totalEnvelopeDeposits += day.pm_deposit_amount || 0;
        totalBackToCashbox += (day.pm_amount_to_keep - day.am_total) || 0;
      });

      // Summary section: arrange entries in two columns with tighter spacing
      doc.setFontSize(9);   // Reduced from 10
      doc.setFont('helvetica', 'normal');
      
      // Create separate left and right column entries
      const leftColumnEntries = [
        ['Toast Cash Sales Reported', `$${totalToastSalesReported.toFixed(2)}`],
        ['Actual Cash In', `$${totalActualCashIn.toFixed(2)}`],
        ['Total Discrepancy', `$${totalDiscrepancy.toFixed(2)}`],
        ['Envelope Deposits', `$${totalEnvelopeDeposits.toFixed(2)}`]
      ];
      
      // Add cashbox reconciliation if available
      if (cashboxReconciliation) {
        leftColumnEntries.push(['Current Cashbox Total', `$${cashboxReconciliation.currentTotal.toFixed(2)}`]);
        
        if (!cashboxReconciliation.isFirstCount && cashboxReconciliation.expectedEnding !== undefined) {
          leftColumnEntries.push(['Expected Based on Discrepancies', `$${cashboxReconciliation.expectedEnding.toFixed(2)}`]);
          leftColumnEntries.push(['Total Period Discrepancies', `$${cashboxReconciliation.totalDiscrepancies.toFixed(2)}`]);
          
          if (Math.abs(cashboxReconciliation.actualVariance) >= 0.01) {
            const varianceLabel = cashboxReconciliation.actualVariance >= 0 ? 'Unexplained Overage' : 'Unexplained Shortage';
            leftColumnEntries.push([varianceLabel, `$${Math.abs(cashboxReconciliation.actualVariance).toFixed(2)}`]);
          } else {
            leftColumnEntries.push(['Reconciliation Status', 'BALANCED']);
          }
        } else if (!cashboxReconciliation.isFirstCount) {
          // Fallback for old logic
          const varianceLabel = cashboxReconciliation.variance >= 0 ? 'Cashbox Increase' : 'Cashbox Decrease';
          leftColumnEntries.push([varianceLabel, `$${Math.abs(cashboxReconciliation.variance).toFixed(2)}`]);
        }
      } else {
        // Fallback when no cashbox data is available yet
        leftColumnEntries.push(['Cashbox Reconciliation', 'N/A - New Feature']);
      }
      
      const leftColumnMapped = leftColumnEntries.map(([label, value]) => [label.toUpperCase(), value.toUpperCase()]);
      
      const rightColumnEntries = [
        ['Credit Tips', `$${tipPoolSummary.creditTips.toFixed(2)}`],
        ['Cash Tips', `$${tipPoolSummary.cashTips.toFixed(2)}`],
        ['EZCater Tips', `$${tipPoolSummary.ezcaterTips.toFixed(2)}`],
        ['Total Tips', `$${tipPoolSummary.totalTips.toFixed(2)}`],
        ['TDS Driver', `$${tipPoolSummary.tdsDriverTips.toFixed(2)}`],
        ['Tip Pool Total (Minus TDS)', `$${tipPoolSummary.pool.toFixed(2)}`],
        ['Hourly Rate', `$${tipPoolSummary.hourlyRate.toFixed(2)}`]
      ].map(([label, value]) => [label.toUpperCase(), value.toUpperCase()]);
      
      // Define fixed x offsets for values within each column
      const colValueOffset = 170;  // Reduced from 200
      let summaryY = currentY + 66; // Reduced from 86
      const lineHeight = 11;        // Reduced from 14
      const col2X = pageWidth / 2;
      
      // Draw left column (cash data)
      let leftColumnY = summaryY;
      for (const [label, value] of leftColumnMapped) {
        doc.setFont('helvetica', 'bold');
        doc.text(`${label}:`, margin, leftColumnY);
        doc.setFont('helvetica', 'normal');
        doc.text(value, margin + colValueOffset, leftColumnY);
        leftColumnY += lineHeight;
      }
      
      // Draw right column (tip data)
      let rightColumnY = summaryY;
      for (const [label, value] of rightColumnEntries) {
        doc.setFont('helvetica', 'bold');
        doc.text(`${label}:`, col2X + 6, rightColumnY);
        doc.setFont('helvetica', 'normal');
        doc.text(value, col2X + 6 + colValueOffset, rightColumnY);
        rightColumnY += lineHeight;
      }
      
      // Add centered Cash Needed/Surplus line below both columns with larger italic font
      const cashNeededY = Math.max(leftColumnY, rightColumnY) + 8;
      const cashNeededLabel = tipPoolSummary.cashNeeded > 0 ? 'CASH NEEDED' : 'CASH SURPLUS';
      const cashNeededValue = `$${Math.abs(tipPoolSummary.cashNeeded).toFixed(2)}`;
      const cashNeededText = `${cashNeededLabel}: ${cashNeededValue}`;
      
      // Set color and font for cash needed line
      if (tipPoolSummary.cashNeeded > 0) {
        doc.setTextColor(220, 53, 69); // Red for cash needed
      } else {
        doc.setTextColor(40, 167, 69); // Green for surplus
      }
      
      doc.setFont('helvetica', 'italic');
      doc.setFontSize(12); // 2pts bigger than normal 10pt text
      
      // Center the text between the margins
      const textWidth = doc.getTextWidth(cashNeededText);
      const centerX = (pageWidth / 2) - (textWidth / 2);
      doc.text(cashNeededText, centerX, cashNeededY);
      
      // Reset font and color
      doc.setTextColor(0, 0, 0);
      doc.setFont('helvetica', 'normal');
      doc.setFontSize(9);
      
      // Add note about cashbox reconciliation if not available
      if (!cashboxReconciliation || cashboxReconciliation.isFirstCount) {
        const noteY = cashNeededY + 8;
        doc.setFont('helvetica', 'italic');
        doc.setFontSize(7);
        doc.setTextColor(128, 128, 128); // Light gray
        
        const noteText = cashboxReconciliation ? 
          'Weekly cashbox reconciliation will be available after multiple counts are recorded.' :
          'Weekly cashbox reconciliation feature coming soon - track total cash on hand vs. daily discrepancies.';
        
        const noteWidth = doc.getTextWidth(noteText);
        const noteCenterX = (pageWidth / 2) - (noteWidth / 2);
        doc.text(noteText, noteCenterX, noteY);
        
        // Reset font and color
        doc.setTextColor(0, 0, 0);
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(9);
      }
      
      // Draw a horizontal line after summary with reduced spacing
      const postSummaryY = cashNeededY + ((!cashboxReconciliation || cashboxReconciliation.isFirstCount) ? 20 : 12); // Account for note if present
      doc.setLineWidth(0.5);
      doc.line(margin, postSummaryY, pageWidth - margin, postSummaryY);
      
      // Employee distribution table with reduced spacing
      if (tipPoolRecords && tipPoolRecords.length > 0) {
        currentY = postSummaryY + 12; // Reduced from 20
        
        const tableData = tipPoolRecords.map(record => [
          `${record.first.toUpperCase()} ${record.last.toUpperCase()}`,
          record.hours.toFixed(1),
          (record.equity * 100).toFixed(0),
          record.weighted.toFixed(1),
          `$${record.due.toFixed(2)}`
        ]);
        
        // Calculate totals for the employee table
        const totalHours = tipPoolRecords.reduce((sum, record) => sum + record.hours, 0);
        const totalWeighted = tipPoolRecords.reduce((sum, record) => sum + record.weighted, 0);
        const totalDue = tipPoolRecords.reduce((sum, record) => sum + record.due, 0);
        
        // Add totals row
        const totalsRow = [
          'TOTALS',
          totalHours.toFixed(1),
          '', // Skip equity column as it doesn't make sense to total percentages
          totalWeighted.toFixed(1),
          `$${totalDue.toFixed(2)}`
        ];
        
        const tableDataWithTotals = [...tableData, totalsRow];
        
        doc.autoTable({
          startY: currentY,
          head: [['EMPLOYEE', 'HOURS', 'EQUITY (%)', 'WEIGHTED', 'DUE']],
          body: tableDataWithTotals,
          margin: { left: margin, right: margin },
          theme: 'grid',
          headStyles: { 
            font: 'helvetica', 
            fontStyle: 'bold', 
            textColor: [0, 0, 0], 
            fillColor: [245, 245, 245],
            fontSize: 8,        // Reduced font size
            cellPadding: 3      // Reduced padding
          },
          bodyStyles: { 
            font: 'helvetica', 
            textColor: [0, 0, 0], 
            fillColor: null,
            fontSize: 8,        // Reduced font size
            cellPadding: 3      // Reduced padding
          },
          didParseCell: function(data) {
            // Apply bold styling to totals row (last row)
            if (data.row.index === tableDataWithTotals.length - 1) {
              data.cell.styles.fontStyle = 'bold';
              data.cell.styles.fillColor = [240, 240, 240]; // Light gray background for totals
            }
            
            // Color formatting for DISCREPANCY column (column index 4)
            if (data.column.index === 4 && data.row.index < tableDataWithTotals.length - 1) {
              const cellValue = data.cell.text[0];
              if (cellValue && cellValue.includes('-')) {
                // Negative discrepancy - dark pastel red and italic
                data.cell.styles.textColor = [139, 69, 19]; // Dark red
                data.cell.styles.fontStyle = 'italic';
              } else if (cellValue && cellValue.includes('+')) {
                // Positive discrepancy - dark pastel green
                data.cell.styles.textColor = [34, 139, 34]; // Dark green
              }
            }
          },
          tableWidth: 'auto'
        });
        
        currentY = doc.lastAutoTable.finalY + 10; // Reduced from 20
      }
      
      // Daily cash breakdown table
      if (cashData && cashData.length > 0) {
        const dailyTableData = cashData.map(day => {
          const actualCashIn = day.pm_total - day.am_total;
          const discrepancy = day.pm_discrepancy || 0;
          const discrepancyFormatted = discrepancy >= 0 ? `+$${discrepancy.toFixed(2)}` : `-$${Math.abs(discrepancy).toFixed(2)}`;
          const actualExcess = (day.pm_amount_to_keep || 0) - (day.am_total || 0); // Actual excess returned to cashbox
          return [
            new Date(day.date + 'T12:00:00').toLocaleDateString(),
            day.pm_counter || 'N/A',
            `$${(day.pm_toast_sales || 0).toFixed(2)}`,
            `$${actualCashIn.toFixed(2)}`,
            discrepancyFormatted,
            `$${actualExcess.toFixed(2)}`
          ];
        });
        
        // Calculate totals for numerical columns (skip DATE and NIGHT COUNTER columns)
        const totalsRow = ['TOTALS', '', '', '', '', ''];
        
        // Calculate totals for columns 2-5 (TOAST SALES, ACTUAL CASH IN, DISCREPANCY, EXCESS)
        for (let col = 2; col < 6; col++) {
          let total = 0;
          dailyTableData.forEach(row => {
            let value = row[col].replace('$', '').replace('+', '').replace('-', '').replace(',', '');
            const isNegative = row[col].includes('-');
            const numValue = parseFloat(value) || 0;
            total += isNegative ? -numValue : numValue;
          });
          
          if (col === 4) { // DISCREPANCY column - show sign and format
            const sign = total >= 0 ? '+' : '-';
            totalsRow[col] = `${sign}$${Math.abs(total).toFixed(2)}`;
          } else {
            totalsRow[col] = `$${total.toFixed(2)}`;
          }
        }
        
        // Add totals row to table data
        const tableDataWithTotals = [...dailyTableData, totalsRow];
        
        doc.autoTable({
          startY: currentY,
          head: [['DATE', 'NIGHT COUNTER', 'TOAST SALES', 'ACTUAL CASH IN', 'DISCREPANCY', 'EXCESS']],
          body: tableDataWithTotals,
          margin: { left: margin, right: margin },
          theme: 'grid',
          headStyles: { 
            font: 'helvetica', 
            fontStyle: 'bold', 
            textColor: [0, 0, 0], 
            fillColor: [245, 245, 245],
            fontSize: 7,        // Smaller font for daily table
            cellPadding: 2      // Smaller padding for daily table
          },
          bodyStyles: { 
            font: 'helvetica', 
            textColor: [0, 0, 0], 
            fillColor: null,
            fontSize: 7,        // Smaller font for daily table
            cellPadding: 2      // Smaller padding for daily table
          },
          didParseCell: function(data) {
            // Apply bold italic styling to totals row
            if (data.row.index === tableDataWithTotals.length - 1) {
              data.cell.styles.fontStyle = 'bolditalic';
              data.cell.styles.fillColor = [240, 240, 240]; // Light gray background for totals
            }
            
            // Color formatting for DISCREPANCY column (column index 4)
            if (data.column.index === 4 && data.row.index < tableDataWithTotals.length - 1) {
              const cellValue = data.cell.text[0];
              if (cellValue && cellValue.includes('-')) {
                // Negative discrepancy - dark red and italic
                data.cell.styles.textColor = [139, 69, 19]; // Dark red
                data.cell.styles.fontStyle = 'italic';
              } else if (cellValue && cellValue.includes('+')) {
                // Positive discrepancy - dark green
                data.cell.styles.textColor = [34, 139, 34]; // Dark green
              }
            }
          },
          tableWidth: 'auto'
        });
      }
      
      // Add explanatory notes footer
      currentY = doc.autoTable.previous.finalY + 25;
      
      // Check if we have enough space for notes, if not skip to keep single page
      if (currentY < pageHeight - 100) {
        // Section title
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(8);
        doc.setTextColor(80, 80, 80); // Medium gray
        doc.text('EXCESS COLUMN EXPLANATION', margin, currentY);
        
        currentY += 12;
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(7);
        doc.setTextColor(100, 100, 100); // Light gray
        
        // Excess column explanation
        const explanation = [
          'EXCESS: Cash taken from reported tips to balance daily operations and account for staff-caused discrepancies.',
          'Night deposits round envelope amounts to whole dollars. Excess coins return to cashbox for next day operations.',
          '',
          'COMING SOON: Weekly Cashbox Reconciliation - Starting + Excess - Discrepancies = Expected'
        ];
        
        explanation.forEach((text, index) => {
          if (text === '') {
            return;
          }
          if (text.startsWith('COMING SOON:')) {
            doc.setFont('helvetica', 'bold');
            doc.text(text, margin, currentY + (index * 8));
            doc.setFont('helvetica', 'normal');
          } else {
            doc.text(text, margin, currentY + (index * 8));
          }
        });
        
        // Add developer credit - centered, bold, black
        currentY += 50;
        if (currentY < pageHeight - 30) {
          doc.setFont('helvetica', 'bold');
          doc.setFontSize(8);
          doc.setTextColor(0, 0, 0); // Black
          const creditText = 'Report Generation App designed and coded by Demetri Gregorakis';
          const emailText = 'demetri_gregorakis@icloud.com for troubleshooting';
          
          const creditWidth = doc.getTextWidth(creditText);
          const emailWidth = doc.getTextWidth(emailText);
          const centerXCredit = (pageWidth - creditWidth) / 2;
          const centerXEmail = (pageWidth - emailWidth) / 2;
          
          doc.text(creditText, centerXCredit, currentY);
          doc.setFont('helvetica', 'normal');
          doc.setFontSize(7);
          doc.text(emailText, centerXEmail, currentY + 12);
        }
      }
      
      // Add payday sign off sheet as page 2
      generatePaydaySignOffPage(doc, startDate, endDate);
      
      // Return PDF data for potential merging, or save directly if no attachments
      const dateStr = tipPoolSummary.dateRange || `${startDate}_to_${endDate}`.replace(/-/g, '_');
      const filename = `Combined_Weekly_Report_${dateStr}.pdf`;
      
      return {
        doc: doc,
        filename: filename,
        pdfBytes: doc.output('arraybuffer')
      };
      
    } catch (error) {
      console.error('Combined PDF generation error:', error);
      throw error;
    }
  }

  // Save ALL Weekly Combined Report Data to Database
  async function saveWeeklyCombinedReportData(startDate, endDate, cashData, realEnvelopeAmount, cashboxTotal, cashReportHtml = null, tipPoolHtml = null) {
    try {
      if (!supabase) {
        console.log('Supabase not available - skipping data save');
        return;
      }

      // Prepare comprehensive report data
      const reportData = {
        // Report metadata
        week_start_date: startDate,
        week_end_date: endDate,
        generated_by: tipPoolSummary.calculatedByName || 'Unknown',
        generated_at: new Date().toISOString(),
        real_envelope_amount: realEnvelopeAmount,
        cashbox_total: cashboxTotal,
        
        // Tip Pool Summary Data
        total_toast_sales: tipPoolSummary.toastSalesReported || 0,
        actual_cash_in: tipPoolSummary.actualCashIn || 0,
        total_discrepancy: tipPoolSummary.totalDiscrepancy || 0,
        envelope_deposits: tipPoolSummary.envelopeDeposits || 0,
        credit_tips: tipPoolSummary.creditTips || 0,
        cash_tips: tipPoolSummary.cashTips || 0,
        ezcater_tips: tipPoolSummary.ezcaterTips || 0,
        total_tips: tipPoolSummary.totalTips || 0,
        tds_driver_tips: tipPoolSummary.tdsDriverTips || 0,
        tip_pool_total: tipPoolSummary.tipPoolTotal || 0,
        hourly_rate: tipPoolSummary.hourlyRate || 0,
        cash_needed: tipPoolSummary.cashNeeded || 0,
        
        // Additional tip pool fields
        calculated_cash_tips: tipPoolSummary.calculatedCashTips || 0,
        total_weighted_hours: tipPoolSummary.totalWeightedHours || 0,
        total_hours_worked: tipPoolSummary.totalHoursWorked || 0,
        
        // Employee data as JSON
        employee_tip_data: JSON.stringify(tipPoolRecords || []),
        
        // Daily cash breakdown as JSON
        daily_cash_breakdown: JSON.stringify(cashData || []),
        
        // System metadata
        report_version: '3.0',
        has_attachments: false, // Will be updated if attachments exist
        
        // Store the generated HTML content for easy retrieval
        generated_cash_report_html: cashReportHtml,
        generated_tip_pool_html: tipPoolHtml
      };

      // Save main report data
      const { data: savedReport, error: reportError } = await supabase
        .from('weekly_combined_reports')
        .insert([reportData])
        .select()
        .single();

      if (reportError) {
        console.error('Error saving weekly report:', reportError);
        throw reportError;
      }

      console.log('Weekly combined report data saved successfully:', savedReport.id);
      
      // Save individual employee records for easier querying
      if (tipPoolRecords && tipPoolRecords.length > 0) {
        const employeeRecords = tipPoolRecords.map(employee => ({
          weekly_report_id: savedReport.id,
          week_start_date: startDate,
          week_end_date: endDate,
          employee_first_name: employee.first,
          employee_last_name: employee.last,
          hours_worked: employee.hours,
          equity_percentage: employee.equity,
          weighted_hours: employee.weighted,
          tips_due: employee.due,
          created_at: new Date().toISOString()
        }));

        const { error: employeeError } = await supabase
          .from('weekly_employee_tips')
          .insert(employeeRecords);

        if (employeeError) {
          console.error('Error saving employee tip records:', employeeError);
          // Don't throw here - main report is saved
        } else {
          console.log(`Saved ${employeeRecords.length} employee tip records`);
        }
      }

      // Save daily cash breakdown records
      if (cashData && cashData.length > 0) {
        console.log('Preparing daily breakdown records from cashData:', cashData);
        
        // Filter to only include days with meaningful PM data
        const validDays = cashData.filter(day => 
          day.pm_total && day.pm_total > 0 && 
          day.pm_toast_sales && day.pm_toast_sales > 0
        );
        
        console.log(`Filtered to ${validDays.length} days with valid PM data out of ${cashData.length} total days`);
        
        const dailyRecords = validDays.map(day => {
          console.log('Processing day:', day);
          return {
            weekly_report_id: savedReport.id,
            date: day.date,
            night_counter: day.pm_counter || day.night_counter_name || 'Unknown',
            toast_sales: parseFloat(day.pm_toast_sales) || 0,
            actual_cash_in: parseFloat(day.pm_total) || 0,
            discrepancy: parseFloat(day.pm_discrepancy) || 0,
            excess: parseFloat(day.pm_drawer_over_amount) || 0,
            created_at: new Date().toISOString()
          };
        });
        
        console.log('Final daily records to insert:', dailyRecords);

        const { error: dailyError } = await supabase
          .from('weekly_daily_breakdown')
          .insert(dailyRecords);

        if (dailyError) {
          console.error('Error saving daily breakdown records:', dailyError);
          // Don't throw here - main report is saved
        } else {
          console.log(`Saved ${dailyRecords.length} daily breakdown records`);
        }
      }

      return savedReport.id;

    } catch (error) {
      console.error('Error saving weekly combined report data:', error);
      throw error;
    }
  }

  // Generate Payday Sign Off Sheet as PDF page
  function generatePaydaySignOffPage(doc, startDate, endDate) {
    try {
      // Add new page for payday sign off
      doc.addPage();
      
      const pageWidth = doc.internal.pageSize.getWidth();
      const margin = 40;
      let currentY = margin;
      
      // Header
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(18);
      doc.setTextColor(0, 0, 0);
      doc.text('JAYNA GYRO EMPLOYEE TIP OUT ACKNOWLEDGEMENT', margin, currentY + 15);
      
      // Week of section
      currentY += 35;
      doc.setFontSize(13);
      doc.text('WEEK OF', margin, currentY);
      doc.setFont('helvetica', 'normal');
      const weekRange = `${startDate.toUpperCase()} - ${endDate.toUpperCase()}`;
      doc.text(weekRange, margin + 80, currentY);
      
      // Disclaimer text
      currentY += 25;
      doc.setFontSize(8);
      doc.setFont('helvetica', 'normal');
      const disclaimerLines = [
        'As an employee, it is important to ensure accuracy and transparency in matters relating to your working hours, compensation, and breaks.',
        'Please carefully review the following statements:',
        '',
        'I have had the opportunity to review my hours worked each day and have been provided with a copy of this information if requested.',
        'The tip amount in cash I was given is accurate and complete.',
        '',
        'All details entered into the timekeeping system and reflected on my paycheck, including tip amounts and entries for breaks,',
        'meal periods, and overtime, are accurate and correct to the best of my knowledge.',
        '',
        'In the event that any information is found to be incorrect or if I have not been provided the opportunity to take a meal or',
        'rest break, I will document such discrepancies in the "Corrections" column below.',
        '',
        'I understand that it is not mandatory to note missed meal breaks if I worked less than six hours OR over six hours',
        'and have voluntarily signed a meal break waiver.',
        '',
        'I am aware that I am not required to document missed breaks if they were made available to me but I chose not to take them.'
      ];
      
      disclaimerLines.forEach((line, index) => {
        if (line !== '') {
          doc.text(line, margin, currentY + (index * 10));
        }
      });
      
      // Employee signature table
      currentY += disclaimerLines.length * 10 + 20;
      
      // Table headers
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(12);
      doc.text('EMPLOYEE NAME', margin, currentY);
      doc.text('EMPLOYEE SIGNATURE', margin + 250, currentY);
      
      // Line under headers
      currentY += 5;
      doc.line(margin, currentY, pageWidth - margin, currentY);
      
      // Employee rows - get from tip pool records
      currentY += 15;
      doc.setFont('helvetica', 'normal');
      doc.setFontSize(10);
      
      // Create employee list from tip pool records
      const employees = tipPoolRecords.map(record => ({
        first: record.first,
        last: record.last
      }));
      
      // Sort alphabetically by first name
      employees.sort((a, b) => a.first.localeCompare(b.first));
      
      employees.forEach((employee, index) => {
        const rowHeight = 25;
        const yPos = currentY + (index * rowHeight);
        
        // Check if we're getting too close to bottom of page
        if (yPos > 700) {
          return; // Skip if too close to bottom to maintain single page
        }
        
        // Alternating row background - properly aligned with text
        if (index % 2 === 1) {
          doc.setFillColor(232, 240, 254); // Light blue background
          doc.rect(margin - 5, yPos - 12, pageWidth - 2 * margin + 10, rowHeight, 'F');
        }
        
        // Employee name
        doc.setTextColor(0, 0, 0);
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(10);
        doc.text(`${employee.first} ${employee.last}`, margin, yPos);
        
        // Signature line - positioned at same baseline as employee name
        doc.setDrawColor(0, 0, 0);
        doc.line(margin + 250, yPos + 3, pageWidth - margin - 10, yPos + 3);
      });
      
      return doc;
      
    } catch (error) {
      console.error('Error generating payday sign off sheet:', error);
      throw error;
    }
  }

  // PDF Merging Function
  async function mergePDFsWithAttachments(mainPdfData, voidsFile = null, extrasFile = null) {
    try {
      const { PDFDocument } = PDFLib;
      
      // Create new PDF document
      const mergedPdf = await PDFDocument.create();
      
      // Add main report pages
      const mainPdf = await PDFDocument.load(mainPdfData.pdfBytes);
      const mainPages = await mergedPdf.copyPages(mainPdf, mainPdf.getPageIndices());
      mainPages.forEach((page) => mergedPdf.addPage(page));
      
      // Add Voids Log if uploaded
      if (voidsFile) {
        const voidsArrayBuffer = await voidsFile.arrayBuffer();
        const voidsPdf = await PDFDocument.load(voidsArrayBuffer);
        const voidsPages = await mergedPdf.copyPages(voidsPdf, voidsPdf.getPageIndices());
        voidsPages.forEach((page) => mergedPdf.addPage(page));
      }
      
      // Add Extras if uploaded
      if (extrasFile) {
        const extrasArrayBuffer = await extrasFile.arrayBuffer();
        const extrasPdf = await PDFDocument.load(extrasArrayBuffer);
        const extrasPages = await mergedPdf.copyPages(extrasPdf, extrasPdf.getPageIndices());
        extrasPages.forEach((page) => mergedPdf.addPage(page));
      }
      
      // Save merged PDF
      const mergedPdfBytes = await mergedPdf.save();
      const blob = new Blob([mergedPdfBytes], { type: 'application/pdf' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = mainPdfData.filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      return true;
    } catch (error) {
      console.error('PDF merging error:', error);
      throw new Error(`Failed to merge PDFs: ${error.message}`);
    }
  }

  function generateTipPoolReportHtml() {
    const { cashNeeded } = tipPoolSummary;
    
    // COPY EXACT LOGIC FROM ORIGINAL TIP POOL CALCULATOR LINE 565 (CORRECT LOGIC)
    let cashStatusText = '';
    let cashStatusClass = '';
    if (cashNeeded > 0) {
      // Need additional cash - show positive amount in red
      cashStatusText = 'NEEDED';
      cashStatusClass = 'color: #dc3545';
    } else {
      // Have surplus - show positive amount in green
      cashStatusText = 'SURPLUS';
      cashStatusClass = 'color: #28a745';
    }
    
    return `
      <div style="font-family: Arial, sans-serif; padding: 20px; background: white;">
        <div style="text-align: center; margin-bottom: 30px; border-bottom: 3px solid #1e3c72; padding-bottom: 20px;">
          <h1 style="margin: 0; color: #1e3c72; font-size: 24px;">JAYNA GYRO TIP POOL DISTRIBUTION</h1>
          <h2 style="margin: 10px 0 0 0; color: #666; font-size: 14px; font-weight: normal;">
            Period: ${tipPoolSummary.dateRange || 'Not specified'}
          </h2>
        </div>
        
        <!-- Summary Section -->
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 30px;">
          <div style="background: #f8f9fa; padding: 15px; border: 2px solid #007bff; border-radius: 8px; text-align: center;">
            <h4 style="margin: 0 0 8px 0; color: #007bff; font-size: 12px;">CREDIT TIPS</h4>
            <p style="font-size: 18px; font-weight: bold; margin: 0; color: #007bff;">$${tipPoolSummary.creditTips.toFixed(2)}</p>
          </div>
          
          <div style="background: #f8f9fa; padding: 15px; border: 2px solid #28a745; border-radius: 8px; text-align: center;">
            <h4 style="margin: 0 0 8px 0; color: #28a745; font-size: 12px;">CASH TIPS</h4>
            <p style="font-size: 18px; font-weight: bold; margin: 0; color: #28a745;">$${tipPoolSummary.cashTips.toFixed(2)}</p>
          </div>
          
          <div style="background: #f8f9fa; padding: 15px; border: 2px solid #f57c00; border-radius: 8px; text-align: center;">
            <h4 style="margin: 0 0 8px 0; color: #f57c00; font-size: 12px;">EZCATER TIPS</h4>
            <p style="font-size: 18px; font-weight: bold; margin: 0; color: #f57c00;">$${tipPoolSummary.ezcaterTips.toFixed(2)}</p>
          </div>
        </div>
        
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 30px;">
          <div style="background: #f8f9fa; padding: 15px; border: 2px solid #1e3c72; border-radius: 8px; text-align: center;">
            <h4 style="margin: 0 0 8px 0; color: #1e3c72; font-size: 12px;">TOTAL POOL</h4>
            <p style="font-size: 20px; font-weight: bold; margin: 0; color: #1e3c72;">$${tipPoolSummary.pool.toFixed(2)}</p>
          </div>
          
          <div style="background: #f8f9fa; padding: 15px; border: 2px solid #6c757d; border-radius: 8px; text-align: center;">
            <h4 style="margin: 0 0 8px 0; color: #6c757d; font-size: 12px;">HOURLY RATE</h4>
            <p style="font-size: 18px; font-weight: bold; margin: 0; color: #6c757d;">$${tipPoolSummary.hourlyRate.toFixed(2)}</p>
          </div>
          
          <div style="background: #f8f9fa; padding: 15px; border: 2px solid ${cashNeeded > 0 ? '#dc3545' : '#28a745'}; border-radius: 8px; text-align: center;">
            <h4 style="margin: 0 0 8px 0; ${cashStatusClass}; font-size: 12px;">CASH ${cashStatusText}</h4>
            <p style="font-size: 18px; font-weight: bold; margin: 0; ${cashStatusClass};">$${Math.abs(cashNeeded).toFixed(2)}</p>
          </div>
        </div>
        
        <!-- Employee Distribution Table -->
        <div style="margin-bottom: 30px;">
          <h3 style="color: #1e3c72; margin-bottom: 15px; border-bottom: 2px solid #1e3c72; padding-bottom: 5px;">
            EMPLOYEE TIP DISTRIBUTION
          </h3>
          
          <table style="width: 100%; border-collapse: collapse; border: 2px solid #000;">
            <thead>
              <tr style="background: #1e3c72; color: white;">
                <th style="padding: 12px; text-align: left; border: 1px solid #000; font-size: 12px;">EMPLOYEE</th>
                <th style="padding: 12px; text-align: center; border: 1px solid #000; font-size: 12px;">HOURS</th>
                <th style="padding: 12px; text-align: center; border: 1px solid #000; font-size: 12px;">EQUITY</th>
                <th style="padding: 12px; text-align: center; border: 1px solid #000; font-size: 12px;">WEIGHTED HOURS</th>
                <th style="padding: 12px; text-align: center; border: 1px solid #000; font-size: 12px;">TIPS DUE</th>
              </tr>
            </thead>
            <tbody>
    `;
    
    tipPoolRecords.forEach((record, index) => {
      const rowBg = index % 2 === 0 ? '#f8f9fa' : 'white';
      return `
        <tr style="background: ${rowBg};">
          <td style="padding: 10px; border: 1px solid #000; font-weight: bold;">${record.first} ${record.last}</td>
          <td style="padding: 10px; text-align: center; border: 1px solid #000;">${record.hours.toFixed(1)}</td>
          <td style="padding: 10px; text-align: center; border: 1px solid #000;">${record.equity.toFixed(2)}</td>
          <td style="padding: 10px; text-align: center; border: 1px solid #000;">${record.weighted.toFixed(1)}</td>
          <td style="padding: 10px; text-align: center; border: 1px solid #000; font-weight: bold; color: #28a745; font-size: 16px;">$${record.due.toFixed(2)}</td>
        </tr>
      `;
    }).join('') + `
            </tbody>
          </table>
        </div>
        
        <!-- Footer -->
        <div style="text-align: center; margin-top: 30px; padding-top: 20px; border-top: 2px solid #ddd; color: #666; font-size: 12px;">
          <p style="margin: 0;">Tips calculated by: <strong>${tipPoolSummary.calculatedByName}</strong></p>
          <p style="margin: 5px 0 0 0;">Generated: ${tipPoolSummary.generatedAt}</p>
          <p style="margin: 5px 0 0 0;">Jayna Gyro Cash Counter & Tip Pool System v2.86</p>
        </div>
      </div>
    `;
  }

  async function generateCombinedReport() {
    const startDate = document.getElementById('combinedStartDate').value;
    const endDate = document.getElementById('combinedEndDate').value;
    const realEnvelopeAmount = parseFloat(document.getElementById('combinedRealEnvelope').value) || null;

    console.log('generateCombinedReport called with auto-populated data:', { startDate, endDate, realEnvelopeAmount });

    if (!startDate || !endDate) {
      showErrorMessage('Please select both start and end dates for the cash report period.');
      return;
    }

    if (!tipPoolRecords || tipPoolRecords.length === 0) {
      showErrorMessage('Please calculate tip pool first before generating combined report.');
      return;
    }

    // Prompt for current cashbox count (only if user wants to use this feature)
    const shouldPromptCashbox = confirm(
      'üí∞ NEW FEATURE: Weekly Cashbox Reconciliation\\n\\n' +
      'Would you like to enter your current cashbox total for weekly tracking?\\n\\n' +
      '‚Ä¢ This feature tracks total cash on hand (not just registers)\\n' +
      '‚Ä¢ Helps reconcile weekly cashbox changes vs daily discrepancies\\n' +
      '‚Ä¢ Optional - you can skip for now and start using it later\\n\\n' +
      'Click OK to enter cashbox amount, or Cancel to skip.'
    );
    
    let cashboxTotal = null;
    if (shouldPromptCashbox) {
      const cashboxAmount = prompt(
        'üí∞ Enter current total cashbox amount:\\n\\n' +
        'Count all cash and coins in the cashbox and enter the total amount.\\n' +
        'This will be used to track weekly cashbox changes.\\n\\n' +
        'Amount (e.g., 1234.56):',
        ''
      );
      
      if (cashboxAmount === null) {
        return; // User cancelled
      }
      
      cashboxTotal = parseFloat(cashboxAmount);
      if (isNaN(cashboxTotal) || cashboxTotal < 0) {
        showErrorMessage('Please enter a valid cashbox amount (numbers only, no $ sign).');
        return;
      }
    }

    try {
      showLoading('Generating Combined Report', 'Fetching cash count data and combining with tip pool...');

      // Save cashbox count to database if provided
      if (cashboxTotal !== null) {
        await saveCashboxCountFromReport(cashboxTotal);
      }

      // Fetch cash count data for the date range (reusing existing logic)
      const start = new Date(startDate + 'T12:00:00');
      const end = new Date(endDate + 'T12:00:00');

      if (start > end) {
        throw new Error('Start date must be before end date');
      }

      const diffTime = Math.abs(end - start);
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      
      if (diffDays > 7) {
        throw new Error('Date range cannot exceed 7 days');
      }

      // Copy exact working query from generateDateRangePDF
      const { data: rangeData } = await supabase
        .from('cash_counts')
        .select('*')
        .gte('date', startDate)
        .lte('date', endDate)
        .not('pm_total', 'is', null)
        .order('date', { ascending: true });

      if (!rangeData || rangeData.length === 0) {
        throw new Error('No cash count data found for this date range');
      }

      // Store cash data for potential re-generation
      window.lastCombinedCashData = rangeData;
      
      // Save combined report data for persistence
      saveCombinedReportData();

      // Generate the HTML content first
      const cashReportHtml = generateDateRangeReportHtml(startDate, endDate, rangeData, realEnvelopeAmount);
      const tipPoolHtml = document.getElementById('tipPoolResults').innerHTML;
      
      // SAVE ALL DATA TO DATABASE BEFORE PDF GENERATION
      console.log('Saving comprehensive weekly report data to database...');
      try {
        const savedReportId = await saveWeeklyCombinedReportData(startDate, endDate, rangeData, realEnvelopeAmount, cashboxTotal, cashReportHtml, tipPoolHtml);
        console.log(`Weekly report data saved successfully with ID: ${savedReportId}`);
      } catch (saveError) {
        console.error('Warning: Failed to save report data to database:', saveError);
        // Don't stop PDF generation if database save fails
      }

      // Check for uploaded PDF attachments
      const voidsLogFile = document.getElementById('voidsLogUpload').files[0];
      const extrasFile = document.getElementById('extrasUpload').files[0];
      
      // Generate main PDF report
      const mainPdfData = await generateCombinedReportPDF(startDate, endDate, rangeData, realEnvelopeAmount, cashboxTotal);
      
      // If attachments exist, merge them; otherwise save main PDF directly
      if (voidsLogFile || extrasFile) {
        await mergePDFsWithAttachments(mainPdfData, voidsLogFile, extrasFile);
        
        let attachmentInfo = '';
        if (voidsLogFile && extrasFile) {
          attachmentInfo = ' (with Voids Log and Extras attached)';
        } else if (voidsLogFile) {
          attachmentInfo = ' (with Voids Log attached)';
        } else if (extrasFile) {
          attachmentInfo = ' (with Extras attached)';
        }
        
        showSuccessMessage(`Combined weekly report generated successfully${attachmentInfo}! You can modify data and generate again.`);
      } else {
        // No attachments, save main PDF directly
        mainPdfData.doc.save(mainPdfData.filename);
        showSuccessMessage('Combined weekly report generated successfully! You can modify data and generate again.');
      }
      
      hideLoading();
      
      // Return to tip pool section for easy re-editing
      showTipPool();
      
      // Return to tip pool section for easy re-editing
      showTipPool();
      
    } catch (error) {
      hideLoading();
      showErrorMessage('Error generating combined report: ' + error.message);
      console.error('Combined report generation error:', error);
    }
  }

  function generateCombinedReportHtml(startDate, endDate, cashData, realEnvelopeAmount = null) {
    // Calculate cash report totals using EXACT same logic as generateDateRangePDF
    let totalToastSalesReported = 0;
    let totalActualCashIn = 0;
    let totalDiscrepancy = 0;
    let totalEnvelopeDeposits = 0;
    let totalBackToCashbox = 0;

    cashData.forEach(day => {
      totalToastSalesReported += day.pm_toast_sales || 0;
      totalActualCashIn += (day.pm_total - day.am_total) || 0;  // Fixed: PM minus AM, not PM + AM
      totalDiscrepancy += day.pm_discrepancy || 0;              // Fixed: Use stored discrepancy
      totalEnvelopeDeposits += day.pm_deposit_amount || 0;      // Fixed: Use correct column name
      totalBackToCashbox += (day.pm_amount_to_keep - day.am_total) || 0;
    });

    const { cashNeeded } = tipPoolSummary;
    
    // COPY EXACT LOGIC FROM ORIGINAL TIP POOL CALCULATOR LINE 565 (CORRECT LOGIC)
    let cashStatusText = '';
    let cashStatusClass = '';
    if (cashNeeded > 0) {
      // Need additional cash - show positive amount in red
      cashStatusText = 'NEEDED';
      cashStatusClass = 'color: #dc3545';
    } else {
      // Have surplus - show positive amount in green
      cashStatusText = 'SURPLUS';
      cashStatusClass = 'color: #28a745';
    }

    return `
      <div style="font-family: Arial, sans-serif; padding: 20px; background: white;">
        <!-- Header matching tip pool calculator style -->
        <div style="text-align: center; margin-bottom: 30px; border-bottom: 3px solid #1e3c72; padding-bottom: 20px;">
          <h1 style="margin: 0; color: #1e3c72; font-size: 24px;">JAYNA GYRO COMBINED WEEKLY REPORT</h1>
          <h2 style="margin: 10px 0 0 0; color: #666; font-size: 16px; font-weight: normal;">CASH COUNT & TIP POOL DISTRIBUTION</h2>
          <h3 style="margin: 10px 0 0 0; color: #666; font-size: 14px; font-weight: normal;">PERIOD: ${startDate.toUpperCase()} TO ${endDate.toUpperCase()} | GENERATED: ${new Date().toLocaleString().toUpperCase()}</h3>
        </div>

        <!-- Cash Count Summary Section -->
        <div style="margin-bottom: 30px;">
          <h3 style="color: #1e3c72; margin-bottom: 15px; border-bottom: 2px solid #1e3c72; padding-bottom: 5px;">
            üí∞ CASH COUNT SUMMARY
          </h3>
          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px;">
            <div style="background: #f8f9fa; padding: 15px; border: 2px solid #007bff; border-radius: 8px; text-align: center;">
              <h4 style="margin: 0 0 8px 0; color: #007bff; font-size: 12px;">TOTAL TOAST SALES</h4>
              <p style="font-size: 18px; font-weight: bold; margin: 0; color: #007bff;">$${totalToastSalesReported.toFixed(2)}</p>
            </div>
            <div style="background: #f8f9fa; padding: 15px; border: 2px solid #28a745; border-radius: 8px; text-align: center;">
              <h4 style="margin: 0 0 8px 0; color: #28a745; font-size: 12px;">ACTUAL CASH IN</h4>
              <p style="font-size: 18px; font-weight: bold; margin: 0; color: #28a745;">$${totalActualCashIn.toFixed(2)}</p>
            </div>
            <div style="background: #f8f9fa; padding: 15px; border: 2px solid #dc3545; border-radius: 8px; text-align: center;">
              <h4 style="margin: 0 0 8px 0; color: #dc3545; font-size: 12px;">TOTAL DISCREPANCY</h4>
              <p style="font-size: 18px; font-weight: bold; margin: 0; color: #dc3545;">$${totalDiscrepancy.toFixed(2)}</p>
            </div>
          </div>
          <div style="display: grid; grid-template-columns: repeat(${realEnvelopeAmount !== null ? '3' : '2'}, 1fr); gap: 15px;">
            <div style="background: #f8f9fa; padding: 15px; border: 2px solid #6c757d; border-radius: 8px; text-align: center;">
              <h4 style="margin: 0 0 8px 0; color: #6c757d; font-size: 12px;">ENVELOPE DEPOSITS</h4>
              <p style="font-size: 18px; font-weight: bold; margin: 0; color: #6c757d;">$${totalEnvelopeDeposits.toFixed(2)}</p>
            </div>
            <div style="background: #f8f9fa; padding: 15px; border: 2px solid #f57c00; border-radius: 8px; text-align: center;">
              <h4 style="margin: 0 0 8px 0; color: #f57c00; font-size: 12px;">EXCESS BACK TO CASH BOX</h4>
              <p style="font-size: 18px; font-weight: bold; margin: 0; color: #f57c00;">$${totalBackToCashbox.toFixed(2)}</p>
            </div>
            ${realEnvelopeAmount !== null ? `
            <div style="background: #f8f9fa; padding: 15px; border: 2px solid #9c27b0; border-radius: 8px; text-align: center;">
              <h4 style="margin: 0 0 8px 0; color: #9c27b0; font-size: 12px;">REAL ENVELOPE AMOUNT</h4>
              <p style="font-size: 18px; font-weight: bold; margin: 0; color: #9c27b0;">$${realEnvelopeAmount.toFixed(2)}</p>
            </div>
            ` : ''}
          </div>
        </div>

        <!-- Tip Pool Summary Section -->
        <div style="margin-bottom: 30px;">
          <h3 style="color: #1e3c72; margin-bottom: 15px; border-bottom: 2px solid #1e3c72; padding-bottom: 5px;">
            üéØ TIP POOL SUMMARY
          </h3>
          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px;">
            <div style="background: #f8f9fa; padding: 15px; border: 2px solid #007bff; border-radius: 8px; text-align: center;">
              <h4 style="margin: 0 0 8px 0; color: #007bff; font-size: 12px;">CREDIT TIPS</h4>
              <p style="font-size: 18px; font-weight: bold; margin: 0; color: #007bff;">$${tipPoolSummary.creditTips.toFixed(2)}</p>
            </div>
            <div style="background: #f8f9fa; padding: 15px; border: 2px solid #28a745; border-radius: 8px; text-align: center;">
              <h4 style="margin: 0 0 8px 0; color: #28a745; font-size: 12px;">CASH TIPS</h4>
              <p style="font-size: 18px; font-weight: bold; margin: 0; color: #28a745;">$${tipPoolSummary.cashTips.toFixed(2)}</p>
            </div>
            <div style="background: #f8f9fa; padding: 15px; border: 2px solid #f57c00; border-radius: 8px; text-align: center;">
              <h4 style="margin: 0 0 8px 0; color: #f57c00; font-size: 12px;">EZCATER TIPS</h4>
              <p style="font-size: 18px; font-weight: bold; margin: 0; color: #f57c00;">$${tipPoolSummary.ezcaterTips.toFixed(2)}</p>
            </div>
          </div>
          <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px;">
            <div style="background: #f8f9fa; padding: 15px; border: 2px solid #e91e63; border-radius: 8px; text-align: center;">
              <h4 style="margin: 0 0 8px 0; color: #e91e63; font-size: 12px;">TDS DRIVER</h4>
              <p style="font-size: 18px; font-weight: bold; margin: 0; color: #e91e63;">$${tipPoolSummary.tdsDriverTips.toFixed(2)}</p>
            </div>
            <div style="background: #f8f9fa; padding: 15px; border: 2px solid #17a2b8; border-radius: 8px; text-align: center;">
              <h4 style="margin: 0 0 8px 0; color: #17a2b8; font-size: 12px;">CASH SALES</h4>
              <p style="font-size: 18px; font-weight: bold; margin: 0; color: #17a2b8;">$${tipPoolSummary.toastCashSales.toFixed(2)}</p>
            </div>
            <div style="background: #f8f9fa; padding: 15px; border: 2px solid #1e3c72; border-radius: 8px; text-align: center;">
              <h4 style="margin: 0 0 8px 0; color: #1e3c72; font-size: 12px;">TOTAL POOL</h4>
              <p style="font-size: 20px; font-weight: bold; margin: 0; color: #1e3c72;">$${tipPoolSummary.pool.toFixed(2)}</p>
            </div>
            <div style="background: #f8f9fa; padding: 15px; border: 2px solid #6c757d; border-radius: 8px; text-align: center;">
              <h4 style="margin: 0 0 8px 0; color: #6c757d; font-size: 12px;">HOURLY RATE</h4>
              <p style="font-size: 18px; font-weight: bold; margin: 0; color: #6c757d;">$${tipPoolSummary.hourlyRate.toFixed(2)}</p>
            </div>
          </div>
        </div>

        <!-- Cash Status Line (prominent display matching tip pool calculator) -->
        <div style="text-align: center; margin-bottom: 30px; background: #f8f9fa; padding: 15px; border: 2px solid ${cashNeeded > 0 ? '#dc3545' : '#28a745'}; border-radius: 8px;">
          <h4 style="margin: 0 0 8px 0; ${cashStatusClass}; font-size: 14px; font-weight: bold;">
            ${cashNeeded > 0 ? 'CASH NEEDED TO PAY OUT TIPS' : 'ZERO CASH NEEDED TO PAY OUT TIPS THIS WEEK. EXCESS CASH ON HAND'}
          </h4>
          <p style="font-size: 24px; font-weight: bold; margin: 0; ${cashStatusClass};">$${Math.abs(cashNeeded).toFixed(2)}</p>
        </div>

        <!-- Employee Distribution Table -->
        <div style="margin-bottom: 30px;">
          <h3 style="color: #1e3c72; margin-bottom: 15px; border-bottom: 2px solid #1e3c72; padding-bottom: 5px;">
            üë• EMPLOYEE TIP DISTRIBUTION
          </h3>
          <table style="width: 100%; border-collapse: collapse; border: 2px solid #000;">
            <thead>
              <tr style="background: #1e3c72; color: white;">
                <th style="padding: 12px; text-align: left; border: 1px solid #000; font-size: 12px;">EMPLOYEE</th>
                <th style="padding: 12px; text-align: center; border: 1px solid #000; font-size: 12px;">HOURS</th>
                <th style="padding: 12px; text-align: center; border: 1px solid #000; font-size: 12px;">EQUITY (%)</th>
                <th style="padding: 12px; text-align: center; border: 1px solid #000; font-size: 12px;">WEIGHTED</th>
                <th style="padding: 12px; text-align: center; border: 1px solid #000; font-size: 12px;">DUE</th>
              </tr>
            </thead>
            <tbody>
              ${tipPoolRecords.map((record, index) => {
                const rowBg = index % 2 === 0 ? '#f8f9fa' : 'white';
                return `
                  <tr style="background: ${rowBg};">
                    <td style="padding: 10px; border: 1px solid #000; font-weight: bold; font-size: 11px;">${record.first.toUpperCase()} ${record.last.toUpperCase()}</td>
                    <td style="padding: 10px; text-align: center; border: 1px solid #000; font-size: 11px;">${record.hours.toFixed(1)}</td>
                    <td style="padding: 10px; text-align: center; border: 1px solid #000; font-size: 11px;">${(record.equity * 100).toFixed(0)}</td>
                    <td style="padding: 10px; text-align: center; border: 1px solid #000; font-size: 11px;">${record.weighted.toFixed(1)}</td>
                    <td style="padding: 10px; text-align: center; border: 1px solid #000; font-weight: bold; font-size: 14px; color: #28a745;">$${record.due.toFixed(2)}</td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        </div>

        <!-- Daily Cash Breakdown -->
        <div style="border: 2px solid #000; margin: 30px 0; border-radius: 8px; overflow: hidden;">
          <div style="background: #f0f0f0; padding: 10px; border-bottom: 2px solid #000;">
            <h4 style="margin: 0; text-align: center; font-size: 14px; color: #1e3c72;">üìÖ DAILY CASH BREAKDOWN</h4>
          </div>
          
          <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
              <thead>
                <tr style="background: #f8f9fa;">
                  <th style="border: 1px solid #000; padding: 8px; text-align: left; font-weight: bold;">Date</th>
                  <th style="border: 1px solid #000; padding: 8px; text-align: center; font-weight: bold;">Counter</th>
                  <th style="border: 1px solid #000; padding: 8px; text-align: right; font-weight: bold;">Toast Sales</th>
                  <th style="border: 1px solid #000; padding: 8px; text-align: right; font-weight: bold;">Actual Cash In</th>
                  <th style="border: 1px solid #000; padding: 8px; text-align: right; font-weight: bold;">Discrepancy</th>
                  <th style="border: 1px solid #000; padding: 8px; text-align: right; font-weight: bold;">Envelope</th>
                  <th style="border: 1px solid #000; padding: 8px; text-align: right; font-weight: bold;">Cashbox</th>
                </tr>
              </thead>
              <tbody>
                ${cashData.map(day => {
                  const actualCashIn = day.pm_total - day.am_total;
                  const discrepancySign = day.pm_discrepancy >= 0 ? '+' : '';
                  return `
                    <tr>
                      <td style="border: 1px solid #000; padding: 6px; font-weight: bold;">
                        ${new Date(day.date + 'T12:00:00').toLocaleDateString()}
                      </td>
                      <td style="border: 1px solid #000; padding: 6px; text-align: center;">
                        ${day.pm_counter || 'N/A'}
                      </td>
                      <td style="border: 1px solid #000; padding: 6px; text-align: right;">
                        $${(day.pm_toast_sales || 0).toFixed(2)}
                      </td>
                      <td style="border: 1px solid #000; padding: 6px; text-align: right;">
                        $${actualCashIn.toFixed(2)}
                      </td>
                      <td style="border: 1px solid #000; padding: 6px; text-align: right; color: ${day.pm_discrepancy >= 0 ? '#28a745' : '#dc3545'};">
                        ${discrepancySign}$${Math.abs(day.pm_discrepancy || 0).toFixed(2)}
                      </td>
                      <td style="border: 1px solid #000; padding: 6px; text-align: right;">
                        $${day.pm_deposit_amount || 0}
                      </td>
                      <td style="border: 1px solid #000; padding: 6px; text-align: right;">
                        $${(day.pm_amount_to_keep || 0).toFixed(2)}
                      </td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          </div>
        </div>

        <!-- Footer -->
        <div style="text-align: center; margin-top: 30px; padding: 15px; border-top: 2px solid #1e3c72; font-size: 10px; background: #f8f9fa;">
          <div style="margin-bottom: 5px; font-weight: bold; color: #1e3c72;">Cash counts verified and tips calculated by: ${tipPoolSummary.ranBy || 'SYSTEM'}</div>
          <div style="margin-bottom: 5px; color: #666;">Generated: ${new Date().toLocaleString()}</div>
          <div style="color: #1e3c72; font-weight: bold;">Jayna Gyro Combined Weekly Report System v2.86</div>
        </div>
      </div>
    `;
  }
</script>
</body>
</html>