<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AMEX Receipts - Jayna Gyro Manager Portal</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    :root {
      --white: #ffffff;
      --gray-900: #1a1a1a;
      --gray-700: #4a4a4a;
      --gray-600: #6b6b6b;
      --gray-500: #9ca3af;
      --gray-400: #d1d5db;
      --gray-300: #e5e7eb;
      --gray-200: #f3f4f6;
      --gray-100: #f9fafb;

      --jayna-blue: #3b82f6;
      --jayna-blue-pale: #eff6ff;
      --jayna-blue-light: #dbeafe;

      --success-bg: #d1fae5;
      --success-text: #065f46;
      --success-border: #059669;

      --error-bg: #fee2e2;
      --error-text: #991b1b;
      --error-border: #dc2626;

      --warning-bg: #fef3c7;
      --warning-text: #92400e;
      --warning-border: #f59e0b;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--gray-100);
      color: var(--gray-700);
      line-height: 1.6;
      padding: 0;
      margin: 0;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
      padding: 20px;
    }

    h1, h2, h3 {
      color: var(--gray-900);
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    h1 {
      font-size: 20px;
      margin-bottom: 20px;
    }

    h2 {
      font-size: 18px;
      margin-bottom: 16px;
    }

    h3 {
      font-size: 16px;
      margin-bottom: 12px;
    }

    /* Tab System */
    .tab-container {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
      border-bottom: 2px solid var(--gray-300);
    }

    .tab-btn {
      padding: 12px 20px;
      background: var(--gray-100);
      color: var(--gray-700);
      border: none;
      border-bottom: 3px solid transparent;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .tab-btn.active {
      background: var(--gray-700);
      color: white;
      border-bottom-color: var(--gray-700);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* Form Styles */
    .form-section {
      background: white;
      padding: 0;
      margin-bottom: 20px;
    }

    .add-receipt-toggle {
      background: var(--gray-200);
      border: none;
      padding: 12px 20px;
      font-size: 11px;
      font-weight: 700;
      color: var(--gray-700);
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      transition: all 0.15s ease;
      float: right;
      margin-bottom: 20px;
    }

    .add-receipt-toggle:hover {
      background: var(--gray-300);
    }

    .add-receipt-form {
      display: none;
      background: white;
      padding: 20px;
      margin-bottom: 20px;
      clear: both;
    }

    .add-receipt-form.open {
      display: block;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-size: 11px;
      font-weight: 700;
      color: var(--gray-700);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    input[type="text"],
    input[type="number"],
    input[type="date"],
    select,
    textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid var(--gray-300);
      border-radius: 0;
      font-size: 14px;
      font-weight: 400;
      background: white;
      box-sizing: border-box;
    }

    input:focus,
    select:focus,
    textarea:focus {
      border-color: var(--gray-700);
      outline: none;
    }

    textarea {
      min-height: 80px;
      resize: vertical;
      font-family: inherit;
    }

    /* Button Styles */
    .btn {
      padding: 12px 24px;
      border: 2px solid var(--gray-900);
      font-size: 13px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      cursor: pointer;
      border-radius: 0;
      transition: all 0.15s ease;
    }

    .btn-primary {
      background: var(--gray-900);
      color: white;
    }

    .btn-primary:hover {
      background: var(--gray-700);
      border-color: var(--gray-700);
    }

    .btn-secondary {
      background: var(--gray-100);
      color: var(--gray-900);
      border-color: var(--gray-300);
    }

    .btn-danger {
      background: #dc2626;
      color: white;
      border-color: #dc2626;
    }

    .btn-success {
      background: #059669;
      color: white;
      border-color: #059669;
    }

    /* File Upload Area */
    .file-upload-area {
      border: 3px dashed var(--gray-300);
      padding: 40px;
      text-align: center;
      background: var(--gray-100);
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .file-upload-area:hover {
      border-color: var(--gray-700);
      background: white;
    }

    .file-upload-area.dragover {
      border-color: var(--gray-700);
      background: var(--success-bg);
    }

    .file-preview-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 12px;
      margin-top: 20px;
    }

    .file-preview {
      position: relative;
      border: 2px solid var(--gray-300);
      padding: 8px;
      background: white;
    }

    .file-preview img {
      width: 100%;
      height: 100px;
      object-fit: cover;
    }

    .file-preview-name {
      font-size: 10px;
      color: var(--gray-600);
      margin-top: 4px;
      word-break: break-all;
    }

    .file-remove-btn {
      position: absolute;
      top: 4px;
      right: 4px;
      background: #dc2626;
      color: white;
      border: none;
      width: 24px;
      height: 24px;
      font-size: 14px;
      cursor: pointer;
      font-weight: 700;
    }

    /* List View */
    .list-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      flex-wrap: wrap;
      gap: 12px;
    }

    .pagination-controls {
      display: flex;
      gap: 8px;
      align-items: center;
      font-size: 12px;
    }

    .list-container {
      background: white;
    }

    .list-item {
      display: grid;
      grid-template-columns: 40px 150px 100px 100px 120px 1fr;
      gap: 12px;
      padding: 16px 12px;
      align-items: center;
      cursor: pointer;
      transition: background 0.15s ease;
    }

    .list-item:nth-child(even) {
      background: var(--jayna-blue-pale);
    }

    .list-item:hover {
      background: var(--jayna-blue-light);
    }

    .list-item input[type="checkbox"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
    }

    .list-header {
      display: grid;
      grid-template-columns: 40px 150px 100px 100px 120px 1fr;
      gap: 12px;
      padding: 16px 12px;
      background: var(--gray-900);
      color: white;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.8px;
    }

    .category-badge {
      display: inline-block;
      padding: 4px 10px;
      background: var(--gray-200);
      color: var(--gray-700);
      font-weight: 600;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      max-width: 100%;
      word-wrap: break-word;
      white-space: normal;
      line-height: 1.3;
    }

    /* Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 10000;
      overflow-y: auto;
      padding: 20px;
      align-items: center;
      justify-content: center;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal-content {
      background: white;
      padding: 24px;
      max-width: 800px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      border: 3px solid var(--gray-700);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 2px solid var(--gray-300);
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      color: var(--gray-600);
      cursor: pointer;
      padding: 0;
      width: 30px;
      height: 30px;
      line-height: 1;
    }

    .modal-edit-icon {
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s ease;
    }

    .modal-edit-icon:hover {
      background: var(--gray-200);
    }

    .modal-edit-icon svg {
      width: 18px;
      height: 18px;
      fill: var(--gray-700);
    }

    .modal-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      margin-top: 20px;
      padding-top: 20px;
      border-top: 2px solid var(--gray-300);
    }

    /* Status Messages */
    .status-message {
      padding: 12px 16px;
      margin-bottom: 16px;
      border: 2px solid;
      font-size: 13px;
      font-weight: 600;
    }

    .status-message.success {
      background: var(--success-bg);
      color: var(--success-text);
      border-color: var(--success-border);
    }

    .status-message.error {
      background: var(--error-bg);
      color: var(--error-text);
      border-color: var(--error-border);
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: var(--gray-500);
      font-size: 13px;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--gray-500);
      font-size: 14px;
    }

    /* Archive List */
    .archive-item {
      padding: 16px 12px;
      display: grid;
      grid-template-columns: 120px 100px 120px 1fr 100px;
      gap: 16px;
      align-items: center;
    }

    .archive-item:nth-child(even) {
      background: var(--jayna-blue-pale);
    }

    .archive-item:hover {
      background: var(--jayna-blue-light);
    }

    /* Responsive */
    @media (max-width: 768px) {
      .container {
        padding: 12px;
      }

      .add-receipt-toggle {
        width: 100%;
        float: none;
        margin-bottom: 12px;
      }

      .add-receipt-form {
        padding: 16px;
      }

      .list-header,
      .list-item {
        grid-template-columns: 40px 1fr;
        gap: 8px;
        padding: 12px 8px;
      }

      .list-header span:not(:first-child):not(:last-child),
      .list-item > *:not(:first-child):not(:last-child) {
        display: none;
      }

      .archive-item {
        grid-template-columns: 1fr;
        gap: 8px;
        padding: 12px 8px;
      }

      .btn {
        padding: 10px 16px;
        font-size: 11px;
      }

      .form-group {
        margin-bottom: 16px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Shared Header -->
    <div id="appHeader"></div>
    <script src="./app-header.js"></script>
    <div style="text-align: center; margin-bottom: 20px;">
      <h1 style="margin-bottom: 8px; color: var(--gray-900);">AMEX RECEIPTS</h1>
      <p style="font-size: 13px; color: var(--gray-600); font-weight: 600; margin-bottom: 4px;">CARD ENDING 1100</p>
      <p style="font-size: 12px; color: var(--gray-500);">DEMETRI GREGORAKIS | JAYNA ONE INC</p>
    </div>

    <!-- Tab Navigation -->
    <div class="tab-container">
      <button class="tab-btn active" onclick="switchTab('receipts')">RECEIPTS</button>
      <button class="tab-btn" onclick="switchTab('archive')">ARCHIVE</button>
    </div>

    <!-- RECEIPTS TAB -->
    <div id="receiptsTab" class="tab-content active">
      <!-- Add Receipt Button -->
      <button class="add-receipt-toggle" onclick="toggleAddReceiptForm()">ADD RECEIPT</button>

      <!-- Upload Form (Collapsible) -->
      <div class="add-receipt-form" id="addReceiptForm">
        <div class="form-group">
          <label for="vendor">VENDOR / STORE NAME</label>
          <input type="text" id="vendor" list="vendorList" placeholder="Start typing... (e.g., Office Depot, Amazon, US Foods)" autocomplete="off">
          <datalist id="vendorList"></datalist>
        </div>

        <div class="form-group">
          <label for="purchaseDate">PURCHASE DATE</label>
          <input type="date" id="purchaseDate">
        </div>

        <div class="form-group">
          <label for="amount">AMOUNT ($)</label>
          <input type="number" id="amount" step="0.01" placeholder="0.00">
        </div>

        <div class="form-group">
          <label for="category">CATEGORY</label>
          <select id="category">
            <option value="">SELECT CATEGORY</option>
          </select>
          <div id="newCategoryContainer" style="margin-top: 12px; display: none;">
            <input type="text" id="newCategory" placeholder="Enter new category" style="margin-bottom: 8px; text-transform: uppercase;">
            <button class="btn btn-secondary" onclick="addNewCategory()" style="width: 100%;">ADD CATEGORY</button>
          </div>
        </div>

        <div class="form-group">
          <label for="details">DETAILS</label>
          <textarea id="details" placeholder="Enter purchase details..."></textarea>
        </div>

        <div class="form-group">
          <label>RECEIPT FILES (IMAGES, PDF, WORD, EXCEL)</label>
          <div class="file-upload-area" id="fileUploadArea">
            <p style="font-size: 14px; font-weight: 600; margin-bottom: 8px;">CLICK OR DRAG FILES HERE</p>
            <p style="font-size: 12px; color: var(--gray-500);">Images will be compressed. Documents saved as-is.</p>
          </div>
          <input type="file" id="fileInput" multiple accept="image/*,.pdf,.doc,.docx,.xls,.xlsx" style="display: none;">
          <div id="filePreviewContainer" class="file-preview-container"></div>
        </div>

        <button class="btn btn-primary" onclick="saveReceipt()" style="width: 100%;">SAVE RECEIPT</button>
      </div>

      <!-- List View -->
      <div class="form-section">
        <div class="list-controls">
          <h2 style="margin: 0;">RECEIPT LIST</h2>
          <div class="pagination-controls">
            <label style="margin: 0;">SHOW:</label>
            <select id="pageSize" onchange="changePageSize()" style="width: auto; padding: 8px;">
              <option value="10">10</option>
              <option value="25">25</option>
              <option value="50">50</option>
              <option value="100">100</option>
            </select>
          </div>
        </div>

        <div style="display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap;">
          <button class="btn btn-success" id="acceptClearBtn" onclick="acceptAndClear()" disabled style="opacity: 0.5; cursor: not-allowed;">ACCEPT AND CLEAR</button>
          <button class="btn btn-secondary" id="downloadBtn" onclick="downloadSelectedPDF()" disabled style="opacity: 0.5; cursor: not-allowed;">DOWNLOAD</button>
          <button class="btn btn-danger" id="deleteSelectedBtn" onclick="deleteSelected()" style="display: none;">DELETE SELECTED</button>
        </div>

        <div id="receiptListContainer"></div>

        <div id="paginationControls" style="display: flex; justify-content: center; gap: 8px; margin-top: 16px; flex-wrap: wrap;"></div>
      </div>
    </div>

    <!-- ARCHIVE TAB -->
    <div id="archiveTab" class="tab-content">
      <div class="form-section">
        <h2>ARCHIVED RECEIPTS</h2>
        <div id="archiveListContainer"></div>
      </div>
    </div>
  </div>

  <!-- Detail Modal -->
  <div id="detailModal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h2 style="margin: 0;">RECEIPT DETAILS</h2>
        <div style="display: flex; gap: 8px; align-items: center;">
          <button class="modal-edit-icon" id="modalEditBtn" onclick="enableEditing()" title="Edit Receipt">
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
            </svg>
          </button>
          <button class="modal-close" onclick="closeDetailModal()">&times;</button>
        </div>
      </div>

      <div id="detailContent"></div>

      <div class="modal-actions" id="detailModalActions">
        <button class="btn btn-secondary" onclick="closeDetailModal()">CLOSE</button>
      </div>
    </div>
  </div>

  <!-- Password Modal -->
  <div id="passwordModal" class="modal-overlay">
    <div class="modal-content" style="max-width: 400px;">
      <div class="modal-header">
        <h2 style="margin: 0;">ENTER PASSWORD</h2>
        <button class="modal-close" onclick="closePasswordModal()">&times;</button>
      </div>

      <div style="padding: 20px 0;">
        <input type="password" id="passwordInput" placeholder="Admin password" style="width: 100%; padding: 12px; border: 2px solid var(--gray-300); font-size: 14px;">
        <p id="passwordError" style="color: var(--error-text); font-size: 12px; margin-top: 8px; display: none;">Incorrect password</p>
      </div>

      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closePasswordModal()">CANCEL</button>
        <button class="btn btn-primary" onclick="checkPassword()">SUBMIT</button>
      </div>
    </div>
  </div>

  <!-- Confirm Modal -->
  <div id="confirmModal" class="modal-overlay">
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h2 style="margin: 0;">CONFIRM ACTION</h2>
        <button class="modal-close" onclick="closeConfirmModal()">&times;</button>
      </div>

      <div style="padding: 20px 0;">
        <p id="confirmMessage" style="font-size: 14px; color: var(--gray-700);"></p>
      </div>

      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeConfirmModal()">CANCEL</button>
        <button class="btn btn-success" id="confirmButton" onclick="confirmAction()">CONFIRM</button>
      </div>
    </div>
  </div>

  <!-- Accept and Clear Confirmation Modal -->
  <div id="acceptClearModal" class="modal-overlay">
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h2 style="margin: 0;">CONFIRM ARCHIVE</h2>
        <button class="modal-close" onclick="closeAcceptClearModal()">&times;</button>
      </div>

      <div style="padding: 20px 0;">
        <div style="background: var(--warning-bg); padding: 16px; margin-bottom: 20px; border-left: 4px solid var(--warning-border);">
          <p style="font-size: 14px; color: var(--warning-text); font-weight: 600; margin-bottom: 8px;">YOU ARE ABOUT TO:</p>
          <ul style="margin-left: 20px; color: var(--warning-text); font-size: 13px; line-height: 1.8;">
            <li>Archive <strong id="acceptClearCount">0</strong> selected receipt(s)</li>
            <li>Generate a PDF summary (saved to database)</li>
            <li>Email PDF to Epson printer</li>
            <li>Permanently delete these entries from active receipts</li>
          </ul>
          <p style="font-size: 12px; color: var(--warning-text); margin-top: 12px; font-style: italic;">This action cannot be undone. Receipts will be archived and no longer editable.</p>
        </div>

        <div style="margin-bottom: 20px;">
          <label style="display: flex; align-items: center; cursor: pointer; font-size: 13px; color: var(--gray-700);">
            <input type="checkbox" id="acceptClearCheckbox" style="width: 18px; height: 18px; margin-right: 10px; cursor: pointer;">
            I understand this action is permanent
          </label>
        </div>

        <div style="margin-bottom: 20px;">
          <label style="font-size: 11px; font-weight: 700; color: var(--gray-700); text-transform: uppercase; letter-spacing: 0.5px; display: block; margin-bottom: 8px;">YOUR INITIALS</label>
          <input type="text" id="acceptClearInitials" placeholder="Enter your initials" maxlength="4" style="width: 100%; padding: 12px; border: 2px solid var(--gray-300); font-size: 14px; text-transform: uppercase;">
        </div>

        <div style="font-size: 11px; color: var(--gray-500); margin-top: 12px;">
          <p>Timestamp: <span id="acceptClearTimestamp"></span></p>
        </div>
      </div>

      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeAcceptClearModal()">CANCEL</button>
        <button class="btn btn-success" id="acceptClearConfirmBtn" onclick="confirmAcceptClear()" disabled style="opacity: 0.5; cursor: not-allowed;">CONFIRM</button>
      </div>
    </div>
  </div>

  <script>
    // Universal Modal Helper Functions (replaces alert/confirm/prompt)
    function showMessage(message, type = 'info') {
      const existing = document.getElementById('inlineMessageOverlay');
      if (existing) existing.remove();

      const overlay = document.createElement('div');
      overlay.id = 'inlineMessageOverlay';
      overlay.style.cssText = `position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 100000; padding: 20px;`;

      const box = document.createElement('div');
      const colors = {
        success: { bg: 'var(--success-bg)', text: 'var(--success-text)', border: 'var(--success-border)' },
        error: { bg: 'var(--error-bg)', text: 'var(--error-text)', border: 'var(--error-border)' },
        warning: { bg: 'var(--warning-bg)', text: 'var(--warning-text)', border: 'var(--warning-border)' },
        info: { bg: 'var(--blue-bg)', text: 'var(--blue-text)', border: 'var(--blue-text)' }
      };
      const color = colors[type] || colors.info;
      box.style.cssText = `background: white; padding: 24px; max-width: 500px; width: 100%; border: 3px solid ${color.border}; box-shadow: 0 4px 20px rgba(0,0,0,0.3);`;

      const messageEl = document.createElement('div');
      messageEl.textContent = message;
      messageEl.style.cssText = `font-size: 14px; line-height: 1.6; color: ${color.text}; margin-bottom: 20px; white-space: pre-line;`;

      const closeBtn = document.createElement('button');
      closeBtn.textContent = 'OK';
      closeBtn.style.cssText = `width: 100%; padding: 12px 24px; background: var(--gray-900); color: white; border: 2px solid var(--gray-900); font-size: 13px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; cursor: pointer;`;
      closeBtn.onclick = () => overlay.remove();

      box.appendChild(messageEl);
      box.appendChild(closeBtn);
      overlay.appendChild(box);
      document.body.appendChild(overlay);
      overlay.addEventListener('click', (e) => { if (e.target === overlay) overlay.remove(); });
    }

    function showConfirm(message, onConfirm, onCancel = null) {
      const existing = document.getElementById('inlineConfirmOverlay');
      if (existing) existing.remove();

      const overlay = document.createElement('div');
      overlay.id = 'inlineConfirmOverlay';
      overlay.style.cssText = `position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 100000; padding: 20px;`;

      const box = document.createElement('div');
      box.style.cssText = `background: white; padding: 24px; max-width: 500px; width: 100%; border: 3px solid var(--warning-border); box-shadow: 0 4px 20px rgba(0,0,0,0.3);`;

      const messageEl = document.createElement('div');
      messageEl.textContent = message;
      messageEl.style.cssText = `font-size: 14px; line-height: 1.6; color: var(--gray-900); margin-bottom: 20px; white-space: pre-line;`;

      const buttonContainer = document.createElement('div');
      buttonContainer.style.cssText = `display: flex; gap: 12px; justify-content: flex-end;`;

      const cancelBtn = document.createElement('button');
      cancelBtn.textContent = 'CANCEL';
      cancelBtn.style.cssText = `padding: 12px 24px; background: var(--gray-100); color: var(--gray-900); border: 2px solid var(--gray-300); font-size: 13px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; cursor: pointer;`;
      cancelBtn.onclick = () => { overlay.remove(); if (onCancel) onCancel(); };

      const confirmBtn = document.createElement('button');
      confirmBtn.textContent = 'CONFIRM';
      confirmBtn.style.cssText = `padding: 12px 24px; background: #dc2626; color: white; border: 2px solid #dc2626; font-size: 13px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; cursor: pointer;`;
      confirmBtn.onclick = () => { overlay.remove(); if (onConfirm) onConfirm(); };

      buttonContainer.appendChild(cancelBtn);
      buttonContainer.appendChild(confirmBtn);
      box.appendChild(messageEl);
      box.appendChild(buttonContainer);
      overlay.appendChild(box);
      document.body.appendChild(overlay);
      overlay.addEventListener('click', (e) => { if (e.target === overlay) { overlay.remove(); if (onCancel) onCancel(); } });
    }

    function showPrompt(message, defaultValue = '', onSubmit, onCancel = null) {
      const existing = document.getElementById('inlinePromptOverlay');
      if (existing) existing.remove();

      const overlay = document.createElement('div');
      overlay.id = 'inlinePromptOverlay';
      overlay.style.cssText = `position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 100000; padding: 20px;`;

      const box = document.createElement('div');
      box.style.cssText = `background: white; padding: 24px; max-width: 500px; width: 100%; border: 3px solid var(--gray-700); box-shadow: 0 4px 20px rgba(0,0,0,0.3);`;

      const messageEl = document.createElement('div');
      messageEl.textContent = message;
      messageEl.style.cssText = `font-size: 14px; line-height: 1.6; color: var(--gray-900); margin-bottom: 12px; font-weight: 600;`;

      const input = document.createElement('input');
      input.type = 'text';
      input.value = defaultValue;
      input.style.cssText = `width: 100%; padding: 12px; border: 2px solid var(--gray-300); font-size: 14px; margin-bottom: 20px; box-sizing: border-box;`;

      const buttonContainer = document.createElement('div');
      buttonContainer.style.cssText = `display: flex; gap: 12px; justify-content: flex-end;`;

      const cancelBtn = document.createElement('button');
      cancelBtn.textContent = 'CANCEL';
      cancelBtn.style.cssText = `padding: 12px 24px; background: var(--gray-100); color: var(--gray-900); border: 2px solid var(--gray-300); font-size: 13px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; cursor: pointer;`;
      cancelBtn.onclick = () => { overlay.remove(); if (onCancel) onCancel(); };

      const submitBtn = document.createElement('button');
      submitBtn.textContent = 'OK';
      submitBtn.style.cssText = `padding: 12px 24px; background: var(--gray-900); color: white; border: 2px solid var(--gray-900); font-size: 13px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; cursor: pointer;`;
      submitBtn.onclick = () => { const value = input.value.trim(); overlay.remove(); if (onSubmit) onSubmit(value); };

      input.addEventListener('keypress', (e) => { if (e.key === 'Enter') submitBtn.click(); });

      buttonContainer.appendChild(cancelBtn);
      buttonContainer.appendChild(submitBtn);
      box.appendChild(messageEl);
      box.appendChild(input);
      box.appendChild(buttonContainer);
      overlay.appendChild(box);
      document.body.appendChild(overlay);
      setTimeout(() => input.focus(), 100);
    }

    // Create single Supabase client for this page
    const supabase = (() => {
      if (window._amexSupabaseClient) {
        return window._amexSupabaseClient;
      }
      window._amexSupabaseClient = window.supabase.createClient(
        'https://gaawtbqpnnbbnsyswqwv.supabase.co',
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdhYXd0YnFwbm5iYm5zeXN3cXd2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1MDE1NTAsImV4cCI6MjA3MjA3NzU1MH0.F-y7AIQTWaUe7DRT4OnIZVn94mhXxfhpBbng2aJ8nXg',
        { db: { schema: 'public' }, auth: { persistSession: false } }
      );
      return window._amexSupabaseClient;
    })();

    const ADMIN_PASSWORD = 'JaynaGyro2025!';

    // State
    let uploadedFiles = [];
    let currentReceipt = null;
    let currentPage = 1;
    let pageSize = 10;
    let allReceipts = [];

    // Toggle Add Receipt Form (MUST be global for onclick)
    function toggleAddReceiptForm() {
      const form = document.getElementById('addReceiptForm');
      form.classList.toggle('open');
    }

    function setTodayDate() {
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('purchaseDate').value = today;
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      initializeFileUpload();
      loadCategories();
      loadVendors();
      loadReceipts();
      setTodayDate();
      setupCategoryDropdown();
    });

    // Load existing vendors for autocomplete
    async function loadVendors() {
      const { data, error } = await supabase
        .from('amex_receipts')
        .select('vendor')
        .not('vendor', 'is', null)
        .order('vendor');

      if (error) {
        console.error('Error loading vendors:', error);
        return;
      }

      // Get unique vendors
      const uniqueVendors = [...new Set(data.map(r => r.vendor))].filter(v => v && v.trim());

      // Populate datalist
      const datalist = document.getElementById('vendorList');
      datalist.innerHTML = '';
      uniqueVendors.forEach(vendor => {
        const option = document.createElement('option');
        option.value = vendor;
        datalist.appendChild(option);
      });

      console.log(`Loaded ${uniqueVendors.length} existing vendors for autocomplete`);
    }

    // Tab Switching
    function switchTab(tab) {
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

      if (tab === 'receipts') {
        document.querySelector('.tab-btn:nth-child(1)').classList.add('active');
        document.getElementById('receiptsTab').classList.add('active');
        loadReceipts();
      } else if (tab === 'archive') {
        document.querySelector('.tab-btn:nth-child(2)').classList.add('active');
        document.getElementById('archiveTab').classList.add('active');
        loadArchive();
      }
    }

    // File Upload
    function initializeFileUpload() {
      const uploadArea = document.getElementById('fileUploadArea');
      const fileInput = document.getElementById('fileInput');

      uploadArea.addEventListener('click', () => fileInput.click());

      uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
      });

      uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
      });

      uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        handleFiles(e.dataTransfer.files);
      });

      fileInput.addEventListener('change', (e) => {
        handleFiles(e.target.files);
      });
    }

    function handleFiles(files) {
      Array.from(files).forEach(file => {
        uploadedFiles.push(file);
        displayFilePreview(file);
      });
    }

    function displayFilePreview(file) {
      const container = document.getElementById('filePreviewContainer');
      const preview = document.createElement('div');
      preview.className = 'file-preview';

      if (file.type.startsWith('image/')) {
        const img = document.createElement('img');
        img.src = URL.createObjectURL(file);
        preview.appendChild(img);
      } else {
        const icon = document.createElement('div');
        icon.style.cssText = 'width: 100%; height: 100px; display: flex; align-items: center; justify-content: center; background: var(--gray-100); font-size: 12px; color: var(--gray-500); font-weight: 600;';
        icon.textContent = file.name.split('.').pop().toUpperCase();
        preview.appendChild(icon);
      }

      const name = document.createElement('div');
      name.className = 'file-preview-name';
      name.textContent = file.name;
      preview.appendChild(name);

      const removeBtn = document.createElement('button');
      removeBtn.className = 'file-remove-btn';
      removeBtn.textContent = 'Ã—';
      removeBtn.onclick = () => {
        uploadedFiles = uploadedFiles.filter(f => f !== file);
        preview.remove();
      };
      preview.appendChild(removeBtn);

      container.appendChild(preview);
    }

    // Category Dropdown Setup
    function setupCategoryDropdown() {
      const categorySelect = document.getElementById('category');
      const newCategoryContainer = document.getElementById('newCategoryContainer');
      const newCategoryInput = document.getElementById('newCategory');

      categorySelect.addEventListener('change', () => {
        if (categorySelect.value === 'ADD_NEW') {
          newCategoryContainer.style.display = 'block';
          newCategoryInput.focus();
        } else {
          newCategoryContainer.style.display = 'none';
          newCategoryInput.value = '';
        }
      });

      // Auto-uppercase input
      newCategoryInput.addEventListener('input', (e) => {
        e.target.value = e.target.value.toUpperCase();
      });
    }

    // Categories
    async function loadCategories() {
      const { data, error } = await supabase
        .from('amex_categories')
        .select('*')
        .order('name');

      if (error) {
        console.error('Error loading categories:', error);
        return;
      }

      const select = document.getElementById('category');
      select.innerHTML = '<option value="">SELECT CATEGORY</option>';
      data.forEach(cat => {
        const option = document.createElement('option');
        option.value = cat.name;
        option.textContent = cat.name;
        select.appendChild(option);
      });

      // Add "ADD NEW" option at the end
      const addNewOption = document.createElement('option');
      addNewOption.value = 'ADD_NEW';
      addNewOption.textContent = '+ ADD NEW CATEGORY';
      select.appendChild(addNewOption);
    }

    async function addNewCategory() {
      const input = document.getElementById('newCategory');
      const name = input.value.trim().toUpperCase();

      if (!name) {
        showMessage('Please enter a category name', 'error');
        return;
      }

      const { data, error } = await supabase
        .from('amex_categories')
        .insert({ name })
        .select();

      if (error) {
        showMessage('Error adding category: ' + error.message, 'error');
        return;
      }

      input.value = '';
      document.getElementById('newCategoryContainer').style.display = 'none';
      await loadCategories();
      document.getElementById('category').value = name;
      showStatus('Category added successfully', 'success');
    }

    // Save Receipt
    async function saveReceipt() {
      const vendor = document.getElementById('vendor').value.trim();
      const date = document.getElementById('purchaseDate').value;
      const amount = parseFloat(document.getElementById('amount').value);
      let category = document.getElementById('category').value;
      const details = document.getElementById('details').value.trim();

      // CRITICAL FIX: If user selected ADD_NEW but typed a category name without clicking "ADD CATEGORY"
      // Automatically create the category first before saving receipt
      if (category === 'ADD_NEW') {
        const newCategoryInput = document.getElementById('newCategory');
        const newCategoryName = newCategoryInput.value.trim().toUpperCase();

        if (!newCategoryName) {
          showMessage('Please enter a category name or select an existing category', 'error');
          newCategoryInput.focus();
          return;
        }

        // Create the new category automatically
        const { data: categoryData, error: categoryError } = await supabase
          .from('amex_categories')
          .insert({ name: newCategoryName })
          .select();

        if (categoryError && !categoryError.message.includes('duplicate')) {
          showMessage('Error creating category: ' + categoryError.message, 'error');
          return;
        }

        // Update category variable to the new category name
        category = newCategoryName;

        // Reload categories and select the new one
        await loadCategories();
        document.getElementById('category').value = newCategoryName;

        console.log(`Auto-created category: ${newCategoryName}`);
      }

      if (!vendor || !date || !amount || !category) {
        showStatus('Please fill in all required fields', 'error');
        return;
      }

      showStatus('Uploading files...', 'success');

      // Upload files
      const imageUrls = [];
      for (const file of uploadedFiles) {
        try {
          const fileUrl = await uploadFile(file);
          imageUrls.push(fileUrl);
        } catch (error) {
          showStatus('Error uploading file: ' + error.message, 'error');
          return;
        }
      }

      // Save to database
      const { data, error } = await supabase
        .from('amex_receipts')
        .insert({
          vendor: vendor,
          purchase_date: date,
          amount: amount,
          category: category,
          details: details,
          image_urls: imageUrls
        })
        .select();

      if (error) {
        showStatus('Error saving receipt: ' + error.message, 'error');
        return;
      }

      showStatus('Receipt saved successfully', 'success');
      clearForm();
      loadReceipts();
    }

    async function uploadFile(file) {
      // Convert file to base64
      const reader = new FileReader();
      const base64 = await new Promise((resolve, reject) => {
        reader.onload = () => resolve(reader.result.split(',')[1]);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });

      // Send to API
      const response = await fetch('/api/process-amex-receipt-image', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          file: base64,
          fileType: file.type,
          fileName: file.name
        })
      });

      if (!response.ok) {
        throw new Error('File upload failed');
      }

      const result = await response.json();
      return result.fileUrl;
    }

    function clearForm() {
      document.getElementById('vendor').value = '';
      setTodayDate();
      document.getElementById('amount').value = '';
      document.getElementById('category').value = '';
      document.getElementById('details').value = '';
      document.getElementById('filePreviewContainer').innerHTML = '';
      uploadedFiles = [];
      // Close the form
      document.getElementById('addReceiptForm').classList.remove('open');
    }

    // Load Receipts
    async function loadReceipts() {
      const container = document.getElementById('receiptListContainer');
      container.innerHTML = '<div class="loading">Loading receipts...</div>';

      const { data, error } = await supabase
        .from('amex_receipts')
        .select('*')
        .order('purchase_date', { ascending: false });

      if (error) {
        container.innerHTML = '<div class="empty-state">Error loading receipts</div>';
        return;
      }

      allReceipts = data;
      renderReceiptList();
    }

    function renderReceiptList() {
      const container = document.getElementById('receiptListContainer');

      if (allReceipts.length === 0) {
        container.innerHTML = '<div class="empty-state">No receipts yet. Add your first receipt above.</div>';
        return;
      }

      const start = (currentPage - 1) * pageSize;
      const end = start + pageSize;
      const pageReceipts = allReceipts.slice(start, end);

      let html = '<div class="list-container">';
      html += `
        <div class="list-header">
          <span><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"></span>
          <span>VENDOR</span>
          <span>DATE</span>
          <span>AMOUNT</span>
          <span>CATEGORY</span>
          <span>DETAILS</span>
        </div>
      `;

      pageReceipts.forEach(receipt => {
        html += `
          <div class="list-item" onclick="viewReceipt(${receipt.id}, event)">
            <input type="checkbox" class="receipt-checkbox" data-id="${receipt.id}" onclick="event.stopPropagation(); updateButtonStates();">
            <span style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: 600;">${receipt.vendor || 'N/A'}</span>
            <span>${receipt.purchase_date}</span>
            <span>$${parseFloat(receipt.amount).toFixed(2)}</span>
            <span><span class="category-badge">${receipt.category}</span></span>
            <span style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${receipt.details || 'N/A'}</span>
          </div>
        `;
      });

      html += '</div>';
      container.innerHTML = html;

      renderPagination();
    }

    function renderPagination() {
      const container = document.getElementById('paginationControls');
      const totalPages = Math.ceil(allReceipts.length / pageSize);

      if (totalPages <= 1) {
        container.innerHTML = '';
        return;
      }

      let html = '';

      if (currentPage > 1) {
        html += '<button class="btn btn-secondary" onclick="changePage(' + (currentPage - 1) + ')">PREV</button>';
      }

      for (let i = 1; i <= totalPages; i++) {
        if (i === currentPage) {
          html += '<button class="btn btn-primary">' + i + '</button>';
        } else {
          html += '<button class="btn btn-secondary" onclick="changePage(' + i + ')">' + i + '</button>';
        }
      }

      if (currentPage < totalPages) {
        html += '<button class="btn btn-secondary" onclick="changePage(' + (currentPage + 1) + ')">NEXT</button>';
      }

      container.innerHTML = html;
    }

    function changePage(page) {
      currentPage = page;
      renderReceiptList();
    }

    function changePageSize() {
      pageSize = parseInt(document.getElementById('pageSize').value);
      currentPage = 1;
      renderReceiptList();
    }

    function toggleSelectAll() {
      const checked = document.getElementById('selectAll').checked;
      document.querySelectorAll('.receipt-checkbox').forEach(cb => cb.checked = checked);
      updateButtonStates();
    }

    // Update button states based on selection
    function updateButtonStates() {
      const selectedCount = document.querySelectorAll('.receipt-checkbox:checked').length;
      const acceptClearBtn = document.getElementById('acceptClearBtn');
      const downloadBtn = document.getElementById('downloadBtn');
      const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');

      if (selectedCount > 0) {
        // Enable buttons
        acceptClearBtn.disabled = false;
        acceptClearBtn.style.opacity = '1';
        acceptClearBtn.style.cursor = 'pointer';

        downloadBtn.disabled = false;
        downloadBtn.style.opacity = '1';
        downloadBtn.style.cursor = 'pointer';

        // Show red delete button
        deleteSelectedBtn.style.display = 'inline-block';
      } else {
        // Disable buttons
        acceptClearBtn.disabled = true;
        acceptClearBtn.style.opacity = '0.5';
        acceptClearBtn.style.cursor = 'not-allowed';

        downloadBtn.disabled = true;
        downloadBtn.style.opacity = '0.5';
        downloadBtn.style.cursor = 'not-allowed';

        // Hide red delete button
        deleteSelectedBtn.style.display = 'none';
      }
    }

    // View Receipt
    async function viewReceipt(id, event) {
      if (event.target.type === 'checkbox') return;

      const { data, error } = await supabase
        .from('amex_receipts')
        .select('*')
        .eq('id', id)
        .single();

      if (error) {
        showStatus('Error loading receipt', 'error');
        return;
      }

      currentReceipt = data;
      displayReceiptDetails(data, false);
      document.getElementById('detailModal').classList.add('active');
    }

    function displayReceiptDetails(receipt, editable) {
      const content = document.getElementById('detailContent');

      let html = '';

      if (editable) {
        html += `
          <div class="form-group">
            <label>VENDOR / STORE NAME</label>
            <input type="text" id="editVendor" list="vendorList" value="${receipt.vendor || ''}" placeholder="Start typing... (e.g., Office Depot, Amazon, US Foods)" autocomplete="off">
          </div>
          <div class="form-group">
            <label>PURCHASE DATE</label>
            <input type="date" id="editDate" value="${receipt.purchase_date}">
          </div>
          <div class="form-group">
            <label>AMOUNT ($)</label>
            <input type="number" id="editAmount" value="${receipt.amount}" step="0.01">
          </div>
          <div class="form-group">
            <label>CATEGORY</label>
            <select id="editCategory">
              ${Array.from(document.getElementById('category').options).map(opt =>
                `<option value="${opt.value}" ${opt.value === receipt.category ? 'selected' : ''}>${opt.textContent}</option>`
              ).join('')}
            </select>
            <div id="editNewCategoryContainer" style="margin-top: 12px; display: none;">
              <input type="text" id="editNewCategory" placeholder="Enter new category" style="margin-bottom: 8px; text-transform: uppercase; width: 100%; padding: 12px; border: 2px solid var(--gray-300); font-size: 14px;">
              <button class="btn btn-secondary" onclick="addNewCategoryFromEdit()" style="width: 100%;">ADD CATEGORY</button>
            </div>
          </div>
          <div class="form-group">
            <label>DETAILS</label>
            <textarea id="editDetails">${receipt.details || ''}</textarea>
          </div>
        `;
      } else {
        html += `
          <div style="margin-bottom: 16px;">
            <label>VENDOR / STORE NAME</label>
            <p style="font-size: 14px; margin-top: 4px; font-weight: 600;">${receipt.vendor || 'N/A'}</p>
          </div>
          <div style="margin-bottom: 16px;">
            <label>PURCHASE DATE</label>
            <p style="font-size: 14px; margin-top: 4px;">${receipt.purchase_date}</p>
          </div>
          <div style="margin-bottom: 16px;">
            <label>AMOUNT</label>
            <p style="font-size: 14px; margin-top: 4px;">$${parseFloat(receipt.amount).toFixed(2)}</p>
          </div>
          <div style="margin-bottom: 16px;">
            <label>CATEGORY</label>
            <p style="font-size: 14px; margin-top: 4px;"><span class="category-badge">${receipt.category}</span></p>
          </div>
          <div style="margin-bottom: 16px;">
            <label>DETAILS</label>
            <p style="font-size: 14px; margin-top: 4px;">${receipt.details || 'N/A'}</p>
          </div>
          <div style="margin-bottom: 16px;">
            <label>DATE ADDED</label>
            <p style="font-size: 11px; margin-top: 4px; color: var(--gray-500);">${new Date(receipt.date_added).toLocaleString()}</p>
          </div>
        `;
      }

      // Show images
      if (receipt.image_urls && receipt.image_urls.length > 0) {
        html += '<div style="margin-top: 20px;"><label>ATTACHED FILES</label>';
        html += '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 12px; margin-top: 12px;">';
        receipt.image_urls.forEach(url => {
          if (url.includes('.jpg') || url.includes('.jpeg') || url.includes('.png')) {
            html += `<a href="${url}" target="_blank"><img src="${url}" style="width: 100%;"></a>`;
          } else {
            const ext = url.split('.').pop().toUpperCase();
            html += `<a href="${url}" target="_blank" style="padding: 20px; background: var(--gray-100); text-align: center; display: block; text-decoration: none; color: var(--gray-700); font-weight: 600; font-size: 12px;">VIEW ${ext}</a>`;
          }
        });
        html += '</div></div>';
      }

      content.innerHTML = html;

      // If editable, setup category dropdown handler
      if (editable) {
        const editCategorySelect = document.getElementById('editCategory');
        const editNewCategoryContainer = document.getElementById('editNewCategoryContainer');
        const editNewCategoryInput = document.getElementById('editNewCategory');

        editCategorySelect.addEventListener('change', async () => {
          if (editCategorySelect.value === 'ADD_NEW') {
            editNewCategoryContainer.style.display = 'block';
            editNewCategoryInput.focus();
          } else {
            editNewCategoryContainer.style.display = 'none';
            editNewCategoryInput.value = '';

            // AUTO-SAVE: Save category immediately when changed
            await autoSaveCategory(editCategorySelect.value);
          }
        });

        // Auto-uppercase input
        editNewCategoryInput.addEventListener('input', (e) => {
          e.target.value = e.target.value.toUpperCase();
        });
      }

      // Show/hide edit icon button based on mode
      const editIconBtn = document.getElementById('modalEditBtn');
      if (editIconBtn) {
        editIconBtn.style.display = editable ? 'none' : 'flex';
      }

      // Update actions
      const actions = document.getElementById('detailModalActions');
      if (editable) {
        actions.innerHTML = `
          <button class="btn btn-danger" onclick="deleteReceipt()">DELETE</button>
          <button class="btn btn-secondary" onclick="closeDetailModal()">CANCEL</button>
          <button class="btn btn-primary" onclick="saveEdit()">SAVE</button>
        `;
      } else {
        actions.innerHTML = `
          <button class="btn btn-secondary" onclick="closeDetailModal()">CLOSE</button>
        `;
      }
    }

    // Auto-save category with green glow visual feedback
    async function autoSaveCategory(newCategory) {
      if (!currentReceipt) return;

      const editCategorySelect = document.getElementById('editCategory');
      const originalBorder = editCategorySelect.style.borderColor;
      const originalBg = editCategorySelect.style.background;

      try {
        // Save to database
        const { error } = await supabase
          .from('amex_receipts')
          .update({ category: newCategory })
          .eq('id', currentReceipt.id);

        if (error) throw error;

        // Update current receipt object
        currentReceipt.category = newCategory;

        // GREEN GLOW SUCCESS FEEDBACK
        editCategorySelect.style.borderColor = '#059669';
        editCategorySelect.style.background = '#d1fae5';
        editCategorySelect.style.transition = 'all 0.3s ease';

        console.log(`âœ… Auto-saved category: ${newCategory}`);

        // Fade back to normal after 2 seconds
        setTimeout(() => {
          editCategorySelect.style.borderColor = originalBorder || '';
          editCategorySelect.style.background = originalBg || '';
        }, 2000);

        // Reload receipt list in background to show updated category
        loadReceipts();

      } catch (error) {
        console.error('Auto-save category error:', error);
        // Red flash on error
        editCategorySelect.style.borderColor = '#dc2626';
        editCategorySelect.style.background = '#fee2e2';
        setTimeout(() => {
          editCategorySelect.style.borderColor = originalBorder || '';
          editCategorySelect.style.background = originalBg || '';
        }, 2000);
      }
    }

    function enableEditing() {
      // Show password modal instead of prompt (Google Sites sandbox)
      document.getElementById('passwordModal').classList.add('active');
      document.getElementById('passwordInput').value = '';
      document.getElementById('passwordError').style.display = 'none';
      setTimeout(() => {
        const input = document.getElementById('passwordInput');
        input.focus();
        // Allow Enter key to submit
        input.onkeypress = (e) => {
          if (e.key === 'Enter') checkPassword();
        };
      }, 100);
    }

    function closePasswordModal() {
      document.getElementById('passwordModal').classList.remove('active');
      document.getElementById('passwordInput').value = '';
      document.getElementById('passwordError').style.display = 'none';
    }

    function checkPassword() {
      const password = document.getElementById('passwordInput').value;
      if (password !== ADMIN_PASSWORD) {
        document.getElementById('passwordError').style.display = 'block';
        document.getElementById('passwordInput').select();
        return;
      }
      closePasswordModal();
      displayReceiptDetails(currentReceipt, true);
    }

    // Add new category from edit modal
    async function addNewCategoryFromEdit() {
      const input = document.getElementById('editNewCategory');
      const name = input.value.trim().toUpperCase();

      if (!name) {
        showMessage('Please enter a category name', 'error');
        return;
      }

      const { data, error } = await supabase
        .from('amex_categories')
        .insert({ name })
        .select();

      if (error && !error.message.includes('duplicate')) {
        showMessage('Error adding category: ' + error.message, 'error');
        return;
      }

      input.value = '';
      document.getElementById('editNewCategoryContainer').style.display = 'none';
      await loadCategories();
      document.getElementById('editCategory').value = name;
      console.log(`Added category from edit: ${name}`);
    }

    async function saveEdit() {
      const vendor = document.getElementById('editVendor').value.trim();
      const date = document.getElementById('editDate').value;
      const amount = parseFloat(document.getElementById('editAmount').value);
      let category = document.getElementById('editCategory').value;
      const details = document.getElementById('editDetails').value.trim();

      // CRITICAL FIX: Same as saveReceipt - handle ADD_NEW category
      if (category === 'ADD_NEW') {
        const editNewCategoryInput = document.getElementById('editNewCategory');
        const newCategoryName = editNewCategoryInput.value.trim().toUpperCase();

        if (!newCategoryName) {
          showMessage('Please enter a category name or select an existing category', 'error');
          editNewCategoryInput.focus();
          return;
        }

        // Create the new category automatically
        const { data: categoryData, error: categoryError } = await supabase
          .from('amex_categories')
          .insert({ name: newCategoryName })
          .select();

        if (categoryError && !categoryError.message.includes('duplicate')) {
          showMessage('Error creating category: ' + categoryError.message, 'error');
          return;
        }

        // Update category variable to the new category name
        category = newCategoryName;

        // Reload categories
        await loadCategories();

        console.log(`Auto-created category from edit: ${newCategoryName}`);
      }

      const { error } = await supabase
        .from('amex_receipts')
        .update({
          vendor: vendor,
          purchase_date: date,
          amount: amount,
          category: category,
          details: details
        })
        .eq('id', currentReceipt.id);

      if (error) {
        showStatus('Error updating receipt: ' + error.message, 'error');
        return;
      }

      showStatus('Receipt updated successfully', 'success');
      closeDetailModal();
      loadReceipts();
    }

    // Delete individual receipt
    async function deleteReceipt() {
      if (!currentReceipt) return;

      showConfirmModal(
        `Delete this receipt ($${parseFloat(currentReceipt.amount).toFixed(2)} - ${currentReceipt.category})? This action cannot be undone.`,
        async () => {
          const { error } = await supabase
            .from('amex_receipts')
            .delete()
            .eq('id', currentReceipt.id);

          if (error) {
            showStatus('Error deleting receipt: ' + error.message, 'error');
            return;
          }

          // Show success popup for 2 seconds
          showStatus('Receipt deleted successfully', 'success');
          closeDetailModal();

          // Reload list after brief delay
          setTimeout(() => {
            loadReceipts();
          }, 500);
        }
      );
    }

    function closeDetailModal() {
      document.getElementById('detailModal').classList.remove('active');
      currentReceipt = null;
    }

    // Confirm Modal Handlers
    let confirmCallback = null;

    function showConfirmModal(message, callback) {
      document.getElementById('confirmMessage').textContent = message;
      document.getElementById('confirmModal').classList.add('active');
      confirmCallback = callback;
    }

    function closeConfirmModal() {
      document.getElementById('confirmModal').classList.remove('active');
      confirmCallback = null;
    }

    function confirmAction() {
      if (confirmCallback) {
        confirmCallback();
        confirmCallback = null;
      }
      closeConfirmModal();
    }

    // Accept and Clear Modal
    function acceptAndClear() {
      const selectedIds = getSelectedReceiptIds();

      if (selectedIds.length === 0) {
        showStatus('Please select receipts to archive', 'error');
        return;
      }

      // Show enhanced confirmation modal
      const modal = document.getElementById('acceptClearModal');
      const count = document.getElementById('acceptClearCount');
      const checkbox = document.getElementById('acceptClearCheckbox');
      const initialsInput = document.getElementById('acceptClearInitials');
      const confirmBtn = document.getElementById('acceptClearConfirmBtn');
      const timestamp = document.getElementById('acceptClearTimestamp');

      count.textContent = selectedIds.length;
      checkbox.checked = false;
      initialsInput.value = '';
      confirmBtn.disabled = true;
      confirmBtn.style.opacity = '0.5';
      confirmBtn.style.cursor = 'not-allowed';

      // Set timestamp
      const now = new Date().toLocaleString('en-US', {
        timeZone: 'America/Los_Angeles',
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });
      timestamp.textContent = now;

      // Watch checkbox and initials for enabling confirm button
      const updateConfirmBtn = () => {
        if (checkbox.checked && initialsInput.value.trim().length > 0) {
          confirmBtn.disabled = false;
          confirmBtn.style.opacity = '1';
          confirmBtn.style.cursor = 'pointer';
        } else {
          confirmBtn.disabled = true;
          confirmBtn.style.opacity = '0.5';
          confirmBtn.style.cursor = 'not-allowed';
        }
      };

      checkbox.onchange = updateConfirmBtn;
      initialsInput.oninput = updateConfirmBtn;

      modal.classList.add('active');
    }

    function closeAcceptClearModal() {
      document.getElementById('acceptClearModal').classList.remove('active');
    }

    async function confirmAcceptClear() {
      const selectedIds = getSelectedReceiptIds();
      const initials = document.getElementById('acceptClearInitials').value.trim().toUpperCase();
      const timestamp = document.getElementById('acceptClearTimestamp').textContent;

      closeAcceptClearModal();
      showStatus('Generating PDF and emailing...', 'success');

      try {
        const response = await fetch('/api/archive-amex-receipts', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            receiptIds: selectedIds,
            emailToPrinter: true,
            approvedBy: initials,
            timestamp: timestamp
          })
        });

        if (!response.ok) {
          throw new Error('Archive failed');
        }

        const result = await response.json();
        showStatus(`Archived ${result.entryCount} receipts. PDF emailed to printer.`, 'success');
        loadReceipts();
      } catch (error) {
        showStatus('Error archiving receipts: ' + error.message, 'error');
      }
    }

    async function downloadSelectedPDF() {
      const selectedIds = getSelectedReceiptIds();

      if (selectedIds.length === 0) {
        return; // Button is disabled if nothing selected, so this shouldn't happen
      }

      const btn = document.getElementById('downloadBtn');
      const originalText = btn.textContent;
      btn.textContent = 'GENERATING...';
      btn.disabled = true;
      btn.style.opacity = '0.7';

      try {
        const response = await fetch('/api/archive-amex-receipts', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            receiptIds: selectedIds,
            emailToPrinter: false,
            approvedBy: 'Demetri Gregorakis',
            previewOnly: true
          })
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.details || 'PDF generation failed');
        }

        const result = await response.json();

        // Fetch PDF as blob to avoid cross-origin download issues
        const pdfResponse = await fetch(result.pdfUrl);
        const pdfBlob = await pdfResponse.blob();
        const blobUrl = URL.createObjectURL(pdfBlob);

        // Download PDF using blob URL
        const link = document.createElement('a');
        link.href = blobUrl;
        link.download = `amex_receipts_${new Date().toISOString().split('T')[0]}.pdf`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        // Clean up blob URL
        setTimeout(() => URL.revokeObjectURL(blobUrl), 100);

        // Show success on button
        showButtonSuccess('downloadBtn', 'SUCCESS!');

        // Re-enable button after feedback
        setTimeout(() => {
          btn.disabled = false;
          btn.style.opacity = '1';
        }, 2000);

      } catch (error) {
        console.error('Download error:', error);
        showButtonError('downloadBtn', 'ERROR');

        // Re-enable button after feedback
        setTimeout(() => {
          btn.textContent = originalText;
          btn.disabled = false;
          btn.style.opacity = '1';
        }, 2000);
      }
    }

    function getSelectedReceiptIds() {
      const checkboxes = document.querySelectorAll('.receipt-checkbox:checked');
      return Array.from(checkboxes).map(cb => parseInt(cb.dataset.id));
    }

    // Delete selected with password protection
    function deleteSelected() {
      const selectedIds = getSelectedReceiptIds();

      if (selectedIds.length === 0) {
        showStatus('Please select receipts to delete', 'error');
        return;
      }

      // Show password modal first
      document.getElementById('passwordModal').classList.add('active');
      document.getElementById('passwordInput').value = '';
      document.getElementById('passwordError').style.display = 'none';

      // Override checkPassword for delete action
      const originalCheckPassword = window.checkPassword;
      window.checkPassword = async function() {
        const password = document.getElementById('passwordInput').value;
        if (password !== ADMIN_PASSWORD) {
          document.getElementById('passwordError').style.display = 'block';
          document.getElementById('passwordInput').select();
          return;
        }

        closePasswordModal();

        // Now show confirm modal
        showConfirmModal(
          `Delete ${selectedIds.length} selected receipt(s)? This action cannot be undone.`,
          async () => {
            console.log('Deleting receipts:', selectedIds);

            try {
              const { error } = await supabase
                .from('amex_receipts')
                .delete()
                .in('id', selectedIds);

              if (error) {
                console.error('Error deleting receipts:', error);
                showMessage(`Error deleting receipts: ${error.message}`, 'error');
                return;
              }

              console.log(`Deleted ${selectedIds.length} receipt(s) successfully`);

              // Reload list immediately
              loadReceipts();
            } catch (error) {
              console.error('Delete error:', error);
              showMessage(`Error: ${error.message}`, 'error');
            }
          }
        );

        // Restore original checkPassword
        window.checkPassword = originalCheckPassword;
      };

      setTimeout(() => document.getElementById('passwordInput').focus(), 100);
    }

    // Archive
    async function loadArchive() {
      const container = document.getElementById('archiveListContainer');
      container.innerHTML = '<div class="loading">Loading archive...</div>';

      const { data, error } = await supabase
        .from('amex_archived_pdfs')
        .select('*')
        .order('archive_date', { ascending: false });

      if (error) {
        container.innerHTML = '<div class="empty-state">Error loading archive</div>';
        return;
      }

      if (data.length === 0) {
        container.innerHTML = '<div class="empty-state">No archived receipts yet</div>';
        return;
      }

      let html = '<div class="list-container">';
      data.forEach(archive => {
        html += `
          <div class="archive-item">
            <span><strong>${archive.archive_date}</strong></span>
            <span>${archive.entry_count} entries</span>
            <span><strong>$${parseFloat(archive.total_amount).toFixed(2)}</strong></span>
            <span style="font-size: 11px; color: var(--gray-500);">
              ${archive.date_range_start} to ${archive.date_range_end}<br>
              Approved by: ${archive.approved_by}
            </span>
            <a href="${archive.pdf_url}" target="_blank" class="btn btn-primary" style="text-decoration: none; padding: 8px 16px;">VIEW PDF</a>
          </div>
        `;
      });
      html += '</div>';

      container.innerHTML = html;
    }

    // Simple status logging (no visual feedback for internal operations)
    function showStatus(message, type) {
      console.log(`[${type.toUpperCase()}] ${message}`);
      // Just log to console - visual feedback is handled by buttons
    }

    // Button-level feedback (no status box at top)
    function showButtonSuccess(buttonId, successText = 'SUCCESS!') {
      const btn = document.getElementById(buttonId);
      if (!btn) return;

      const originalText = btn.textContent;
      const originalBg = btn.style.background;
      const originalColor = btn.style.color;

      // Show success
      btn.textContent = successText;
      btn.style.background = '#059669';
      btn.style.color = 'white';
      btn.style.borderColor = '#059669';

      // Fade back after 2 seconds
      setTimeout(() => {
        btn.textContent = originalText;
        btn.style.background = originalBg;
        btn.style.color = originalColor;
        btn.style.borderColor = '';
      }, 2000);
    }

    function showButtonError(buttonId, errorText = 'ERROR') {
      const btn = document.getElementById(buttonId);
      if (!btn) return;

      const originalText = btn.textContent;
      const originalBg = btn.style.background;
      const originalColor = btn.style.color;

      // Show error
      btn.textContent = errorText;
      btn.style.background = '#dc2626';
      btn.style.color = 'white';
      btn.style.borderColor = '#dc2626';

      // Fade back after 2 seconds
      setTimeout(() => {
        btn.textContent = originalText;
        btn.style.background = originalBg;
        btn.style.color = originalColor;
        btn.style.borderColor = '';
      }, 2000);
    }
  </script>
</body>
</html>
