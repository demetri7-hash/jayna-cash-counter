<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, viewport-fit=cover">
  <title>Inventory Count - Jayna Gyro</title>

  <link rel="apple-touch-icon" href="https://static.spotapps.co/website_images/ab_websites/229800_website_v1/logo.png">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#00A8E1">

  <style>
    /* Jayna Brand Design - Sky Blue & Grayscale */
    :root {
      --primary-blue: #00A8E1;
      --secondary-blue: #0094D6;
      --light-blue: #E3F4FC;
      --accent-blue: #0081C6;
      --gray-900: #212121;
      --gray-700: #424242;
      --gray-600: #616161;
      --gray-500: #757575;
      --gray-400: #BDBDBD;
      --gray-300: #E0E0E0;
      --gray-100: #F5F5F5;
      --success: #00C853;
      --warning: #FFB300;
      --error: #D32F2F;
      --white: #FFFFFF;
      --blue-bg: #dbeafe;
      --blue-text: #1e40af;
      --success-bg: #d1fae5;
      --success-text: #065f46;
      --success-border: #059669;
      --warning-bg: #fef3c7;
      --warning-text: #92400e;
      --warning-border: #f59e0b;
      --error-bg: #fee2e2;
      --error-text: #991b1b;
      --error-border: #dc2626;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    html, body {
      font-family: 'Aptos', 'Segoe UI Variable', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      background: var(--white);
      min-height: 100vh;
      padding: 0;
      overflow-x: hidden;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
      background: var(--white);
      border-radius: 0;
      overflow: visible;
      box-shadow: none;
      min-height: auto;
      max-height: none;
    }

    .header {
      background: var(--white);
      color: var(--gray-900);
      text-align: center;
      padding: 12px;
      border-radius: 0;
      border-bottom: 1px solid var(--gray-300);
    }

    .header h1 {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 2px;
      letter-spacing: 1.5px;
      text-transform: uppercase;
    }

    .header p {
      opacity: 0.7;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .content {
      padding: 12px;
      max-height: none;
      overflow: visible;
    }

    /* Counter Name Display */
    .counter-section {
      background: var(--gray-100);
      padding: 16px;
      margin-bottom: 20px;
      border: 2px solid var(--gray-300);
      text-align: center;
    }

    .counter-label {
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--gray-600);
      margin-bottom: 8px;
    }

    .counter-name-display {
      background: var(--success);
      color: white;
      padding: 16px 24px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
      user-select: none;
      border: 3px solid var(--success-border);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .counter-name-display:hover {
      background: var(--success-border);
    }

    .counter-hint {
      font-size: 11px;
      color: var(--gray-500);
      margin-top: 8px;
      font-style: italic;
    }

    /* Controls */
    .controls {
      background: var(--gray-100);
      padding: 16px;
      margin-bottom: 20px;
      border: 2px solid var(--gray-300);
    }

    .control-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 16px;
    }

    .control-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .control-label {
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--gray-700);
    }

    .control-select {
      padding: 14px;
      border: 2px solid var(--gray-300);
      border-radius: 0;
      font-size: 14px;
      font-weight: 600;
      background: white;
      color: var(--gray-900);
      min-height: 48px;
    }

    .btn-group {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .btn {
      padding: 12px 16px;
      border: 2px solid var(--gray-700);
      background: var(--gray-700);
      color: white;
      font-size: 13px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      cursor: pointer;
      transition: all 0.2s;
      flex: 1;
      min-width: 100px;
      min-height: 48px;
    }

    .btn:hover {
      background: var(--gray-600);
      border-color: var(--gray-600);
    }

    .btn.primary {
      background: var(--success);
      border-color: var(--success);
    }

    .btn.primary:hover {
      background: var(--success-border);
      border-color: var(--success-border);
    }

    /* Stats */
    .stats-bar {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: white;
      border: 2px solid var(--gray-300);
      padding: 16px;
      text-align: center;
    }

    .stat-value {
      font-size: 28px;
      font-weight: 700;
      color: var(--gray-900);
      line-height: 1;
    }

    .stat-label {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--gray-600);
      margin-top: 8px;
      font-weight: 600;
    }

    /* Item Cards */
    .group-section {
      background: white;
      border: 2px solid var(--gray-300);
      margin-bottom: 20px;
    }

    .group-header {
      background: var(--gray-900);
      color: white;
      padding: 14px 16px;
      font-size: 13px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .group-count {
      background: var(--gray-700);
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
    }

    .item-card {
      border-bottom: 1px solid var(--gray-200);
      padding: 16px;
    }

    .item-card:last-child {
      border-bottom: none;
    }

    .item-card.counted {
      background: var(--success-bg);
    }

    .item-name {
      font-size: 15px;
      font-weight: 700;
      color: var(--gray-900);
      margin-bottom: 12px;
    }

    .item-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 12px;
    }

    .meta-badge {
      background: var(--gray-100);
      border: 1px solid var(--gray-300);
      padding: 4px 8px;
      font-size: 11px;
      font-weight: 600;
      color: var(--gray-700);
      text-transform: uppercase;
    }

    .meta-badge.vendor {
      background: var(--blue-bg);
      border-color: #3b82f6;
      color: var(--blue-text);
    }

    .meta-badge.location {
      background: var(--warning-bg);
      border-color: var(--warning);
      color: var(--warning-text);
    }

    .item-inputs {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .input-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .input-label {
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--gray-700);
    }

    .count-input, .location-select {
      padding: 14px;
      border: 3px solid var(--gray-300);
      font-size: 16px;
      font-weight: 700;
      border-radius: 0;
      background: white;
      min-height: 56px;
      text-align: center;
    }

    .count-input:focus, .location-select:focus {
      outline: none;
      border-color: var(--primary-blue);
    }

    .count-input.saved {
      border-color: var(--success);
      background: var(--success-bg);
    }

    .counted-info {
      margin-top: 12px;
      padding: 8px 12px;
      background: var(--gray-100);
      border-left: 3px solid var(--success);
      font-size: 12px;
      color: var(--gray-700);
    }

    .counted-info strong {
      color: var(--success-border);
    }

    /* Loading */
    .loading {
      text-align: center;
      padding: 60px 20px;
      color: var(--gray-500);
    }

    .spinner {
      border: 4px solid var(--gray-200);
      border-top-color: var(--primary-blue);
      border-radius: 50%;
      width: 48px;
      height: 48px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Print */
    @media print {
      .header img, .controls, .btn-group, .counter-section { display: none !important; }
      body { background: white; }
    }

    @media (max-width: 600px) {
      .control-row {
        grid-template-columns: 1fr;
      }
      .item-inputs {
        grid-template-columns: 1fr;
      }
      .stats-bar {
        grid-template-columns: repeat(2, 1fr);
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- HARDCODED HEADER (from app-header.js) -->
    <div class="header" style="padding-top: 20px;">
      <img src="jayna-logo-new.png" alt="Jayna Gyro Logo" class="logo" style="max-width: 576px; width: 100%; height: auto; display: block; margin: 0 auto;">
      <h1>INVENTORY COUNT</h1>
      <p style="opacity: 0.7;">FOR AUTHORIZED USE ONLY</p>

      <!-- MAIN MENU NAVIGATION (CENTERED COLUMN) -->
      <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-top: 20px; margin-bottom: 20px;">
        <a href="index.html" class="menu-btn primary" style="text-decoration: none; display: block; padding: 14px; background: var(--gray-900); color: white; border: 2px solid var(--gray-900); text-align: center; font-size: 13px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; cursor: pointer; transition: all 0.15s ease;">CASH</a>
        <a href="orders-prep.html" class="menu-btn" style="text-decoration: none; display: block; padding: 14px; background: var(--gray-700); color: white; border: 2px solid var(--gray-700); text-align: center; font-size: 13px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; cursor: pointer; transition: all 0.15s ease;">ORDERS & PREP</a>
        <a href="dry-goods.html" class="menu-btn primary" style="text-decoration: none; display: block; padding: 14px; background: var(--gray-900); color: white; border: 2px solid var(--gray-900); text-align: center; font-size: 13px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; cursor: pointer; transition: all 0.15s ease;">DRY GOODS</a>
        <a href="foh-checklists.html" class="menu-btn" style="text-decoration: none; display: block; padding: 14px; background: var(--gray-700); color: white; border: 2px solid var(--gray-700); text-align: center; font-size: 13px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; cursor: pointer; transition: all 0.15s ease;">FOH</a>
        <a href="boh.html" class="menu-btn primary" style="text-decoration: none; display: block; padding: 14px; background: var(--gray-900); color: white; border: 2px solid var(--gray-900); text-align: center; font-size: 13px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; cursor: pointer; transition: all 0.15s ease;">BOH</a>
        <a href="catering.html" class="menu-btn" style="text-decoration: none; display: block; padding: 14px; background: var(--gray-700); color: white; border: 2px solid var(--gray-700); text-align: center; font-size: 13px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; cursor: pointer; transition: all 0.15s ease;">CATERING</a>
        <a href="drivers.html" class="menu-btn primary" style="text-decoration: none; display: block; padding: 14px; background: var(--gray-900); color: white; border: 2px solid var(--gray-900); text-align: center; font-size: 13px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; cursor: pointer; transition: all 0.15s ease;">DRIVERS</a>
        <a href="teamupdates.html" class="menu-btn" style="text-decoration: none; display: block; padding: 14px; background: var(--gray-700); color: white; border: 2px solid var(--gray-700); text-align: center; font-size: 13px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; cursor: pointer; transition: all 0.15s ease;">TEAM UPDATES</a>
      </div>

      <p style="opacity: 0.7; margin-top: 12px;">APP CREATED BY DEMETRI GREGORAKIS</p>
    </div>

    <div class="content">
      <!-- Counter Name Section (like orders-prep.html) -->
      <div class="counter-section">
        <div class="counter-label">COUNTED BY:</div>
        <div class="counter-name-display" id="counterNameDisplay" onclick="cycleCounterName()">
          Loading...
        </div>
        <div class="counter-hint">Tap name to change ‚Ä¢ Persists 30 minutes</div>
      </div>

      <!-- Controls -->
      <div class="controls">
        <div class="control-row">
          <div class="control-group">
            <label class="control-label">Group By</label>
            <select class="control-select" id="groupBySelect" onchange="renderInventory()">
              <option value="vendor">Vendor</option>
              <option value="location">Physical Location</option>
              <option value="category">Category</option>
            </select>
          </div>
          <div class="control-group">
            <label class="control-label">Sort By</label>
            <select class="control-select" id="sortBySelect" onchange="renderInventory()">
              <option value="name">Item Name (A-Z)</option>
              <option value="name-desc">Item Name (Z-A)</option>
              <option value="count-asc">Count (Low to High)</option>
              <option value="count-desc">Count (High to Low)</option>
            </select>
          </div>
        </div>
        <div class="btn-group">
          <button class="btn primary" onclick="generateReport()">üìä Report</button>
          <button class="btn" onclick="exportCSV()">üì• CSV</button>
          <button class="btn" onclick="window.print()">üñ®Ô∏è Print</button>
        </div>
      </div>

      <!-- Stats -->
      <div class="stats-bar">
        <div class="stat-card">
          <div class="stat-value" id="totalItems">0</div>
          <div class="stat-label">Total Items</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="countedItems">0</div>
          <div class="stat-label">Counted</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="percentComplete">0%</div>
          <div class="stat-label">Complete</div>
        </div>
      </div>

      <!-- Inventory List -->
      <div id="inventoryContainer">
        <div class="loading">
          <div class="spinner"></div>
          <p>Loading inventory...</p>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script type="module">
    // Supabase
    const { createClient } = supabase;
    const db = createClient(
      'https://gaawtbqpnnbbnsyswqwv.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdhYXd0YnFwbm5iYm5zeXN3cXd2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1MDE1NTAsImV4cCI6MjA3MjA3NzU1MH0.F-y7AIQTWaUe7DRT4OnIZVn94mhXxfhpBbng2aJ8nXg'
    );

    // STAFF TRACKING STATE (EXACT PATTERN FROM ORDERS-PREP.HTML)
    const inventoryCountState = {
      clockedInEmployees: [],
      teamNames: [], // Array of {name: string, color: string}
      activeUserIndex: 0,
      activeUserTimeout: null,
      lastFetched: null
    };

    const USER_COLORS = [
      '#0094D6', '#00C853', '#FFB300', '#9C27B0',
      '#F44336', '#00BCD4', '#FF9800', '#4CAF50'
    ];

    const LOCATIONS = [
      'Not Assigned', 'Walk-in Cooler', 'Freezer', 'Dry Storage',
      'Bar', 'Line Station', 'Prep Area', 'Back Office',
      'Reach-in Cooler', 'Shelf - Top', 'Shelf - Middle', 'Shelf - Bottom'
    ];

    let inventoryItems = [];

    function getUserColor(index) {
      return USER_COLORS[index % USER_COLORS.length];
    }

    function setActiveInventoryCounter(index) {
      inventoryCountState.activeUserIndex = index;
      if (inventoryCountState.activeUserTimeout) {
        clearTimeout(inventoryCountState.activeUserTimeout);
      }
      inventoryCountState.activeUserTimeout = setTimeout(() => {
        inventoryCountState.activeUserIndex = 0;
        console.log('‚è∞ Counter timeout - reset to default');
      }, 1800000); // 30 minutes
    }

    function getActiveCounterName() {
      if (inventoryCountState.teamNames.length === 0) return 'Demetri Gregorakis';
      return inventoryCountState.teamNames[inventoryCountState.activeUserIndex]?.name || 'Demetri Gregorakis';
    }

    function updateCounterDisplay() {
      const nameEl = document.getElementById('counterNameDisplay');
      if (nameEl) {
        nameEl.textContent = getActiveCounterName();
      }
    }

    window.cycleCounterName = function() {
      if (inventoryCountState.teamNames.length === 0) return;
      const nextIndex = (inventoryCountState.activeUserIndex + 1) % inventoryCountState.teamNames.length;
      setActiveInventoryCounter(nextIndex);
      updateCounterDisplay();
      console.log(`üë§ Switched to: ${getActiveCounterName()}`);
    };

    async function fetchClockedInStaff() {
      try {
        const todayPacific = new Date().toLocaleString('en-US', {
          timeZone: 'America/Los_Angeles',
          year: 'numeric',
          month: '2-digit',
          day: '2-digit'
        });
        const [month, day, year] = todayPacific.split(', ')[0].split('/');
        const today = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;

        const authResponse = await fetch('/api/toast-auth', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        if (!authResponse.ok) {
          console.error('Toast auth failed');
          inventoryCountState.clockedInEmployees = [];
          inventoryCountState.teamNames = [{ name: 'Demetri Gregorakis', color: getUserColor(0) }];
          updateCounterDisplay();
          return;
        }

        const authData = await authResponse.json();
        if (!authData.success || !authData.data?.accessToken) {
          console.error('No Toast token');
          inventoryCountState.clockedInEmployees = [];
          inventoryCountState.teamNames = [{ name: 'Demetri Gregorakis', color: getUserColor(0) }];
          updateCounterDisplay();
          return;
        }

        const token = authData.data.accessToken;
        const clockedInUrl = `/api/toast-clocked-in?date=${today}&token=${encodeURIComponent(token)}`;
        const response = await fetch(clockedInUrl);

        if (!response.ok) {
          inventoryCountState.clockedInEmployees = [];
          inventoryCountState.teamNames = [{ name: 'Demetri Gregorakis', color: getUserColor(0) }];
          updateCounterDisplay();
          return;
        }

        const result = await response.json();
        if (!result.success) {
          inventoryCountState.clockedInEmployees = [];
          inventoryCountState.teamNames = [{ name: 'Demetri Gregorakis', color: getUserColor(0) }];
          updateCounterDisplay();
          return;
        }

        const names = result.clockedIn
          .map(emp => {
            const fullName = emp.fullName || emp.name || '';
            return fullName.split(' ')[0];
          })
          .filter(name => name)
          .sort();

        // ALWAYS INCLUDE DEMETRI FIRST
        inventoryCountState.clockedInEmployees = ['Demetri Gregorakis', ...names.filter(n => n !== 'Demetri')];
        inventoryCountState.teamNames = inventoryCountState.clockedInEmployees.map((name, index) => ({
          name: name,
          color: getUserColor(index)
        }));

        console.log('‚úÖ Clocked-in staff loaded:', inventoryCountState.clockedInEmployees);
        updateCounterDisplay();

      } catch (error) {
        console.error('Error fetching clocked-in staff:', error);
        inventoryCountState.clockedInEmployees = [];
        inventoryCountState.teamNames = [{ name: 'Demetri Gregorakis', color: getUserColor(0) }];
        updateCounterDisplay();
      }
    }

    async function loadInventoryData() {
      try {
        const { data, error } = await db
          .from('inventory_items')
          .select('*')
          .order('item_name', { ascending: true });

        if (error) throw error;

        // Map to match orders-prep.html structure (use vendor, not vendor_name!)
        inventoryItems = (data || []).map(item => ({
          id: item.id,
          itemName: item.item_name,
          vendor: item.vendor, // CRITICAL: Use 'vendor', NOT 'vendor_name'
          category: item.category,
          unit: item.unit,
          parLevel: item.par_level || 0,
          currentOnHand: item.current_on_hand,
          physicalLocation: item.physical_location,
          countedBy: item.counted_by,
          lastCounted: item.last_counted,
          currentCost: item.current_cost
        }));

        console.log(`‚úÖ Loaded ${inventoryItems.length} inventory items`);

      } catch (error) {
        console.error('Error loading inventory:', error);
        document.getElementById('inventoryContainer').innerHTML = `
          <div class="loading">
            <p style="color: var(--error);">Failed to load inventory: ${error.message}</p>
          </div>
        `;
      }
    }

    window.renderInventory = function() {
      const groupBy = document.getElementById('groupBySelect').value;
      const sortBy = document.getElementById('sortBySelect').value;
      const container = document.getElementById('inventoryContainer');

      if (inventoryItems.length === 0) {
        container.innerHTML = '<div class="loading"><p>No inventory items found</p></div>';
        return;
      }

      // Group items
      const groups = {};
      inventoryItems.forEach(item => {
        let groupKey;
        if (groupBy === 'vendor') {
          groupKey = item.vendor || 'Unknown Vendor';
        } else if (groupBy === 'location') {
          groupKey = item.physicalLocation || 'Not Assigned';
        } else if (groupBy === 'category') {
          groupKey = item.category || 'Uncategorized';
        }

        if (!groups[groupKey]) groups[groupKey] = [];
        groups[groupKey].push(item);
      });

      // Sort items within groups
      Object.keys(groups).forEach(key => {
        groups[key].sort((a, b) => {
          if (sortBy === 'name') return a.itemName.localeCompare(b.itemName);
          if (sortBy === 'name-desc') return b.itemName.localeCompare(a.itemName);
          if (sortBy === 'count-asc') return (a.currentOnHand || 0) - (b.currentOnHand || 0);
          if (sortBy === 'count-desc') return (b.currentOnHand || 0) - (a.currentOnHand || 0);
          return 0;
        });
      });

      // Render
      let html = '';
      Object.keys(groups).sort().forEach(groupKey => {
        const items = groups[groupKey];
        html += `
          <div class="group-section">
            <div class="group-header">
              <span>${groupKey}</span>
              <span class="group-count">${items.length}</span>
            </div>
        `;

        items.forEach(item => {
          const isCounted = item.lastCounted && item.currentOnHand !== null;
          const countedClass = isCounted ? 'counted' : '';

          html += `
            <div class="item-card ${countedClass}">
              <div class="item-name">${item.itemName}</div>
              <div class="item-meta">
                ${item.vendor ? `<span class="meta-badge vendor">${item.vendor}</span>` : ''}
                ${item.category ? `<span class="meta-badge">${item.category}</span>` : ''}
                ${item.physicalLocation ? `<span class="meta-badge location">üìç ${item.physicalLocation}</span>` : ''}
                ${item.unit ? `<span class="meta-badge">${item.unit}</span>` : ''}
              </div>
              <div class="item-inputs">
                <div class="input-group">
                  <label class="input-label">Count</label>
                  <input
                    type="number"
                    class="count-input"
                    id="count-${item.id}"
                    value="${item.currentOnHand !== null ? item.currentOnHand : ''}"
                    placeholder="0"
                    inputmode="decimal"
                    step="0.1"
                    onblur="saveCount(${item.id}, this.value)"
                  />
                </div>
                <div class="input-group">
                  <label class="input-label">Location</label>
                  <select
                    class="location-select"
                    id="location-${item.id}"
                    onchange="saveLocation(${item.id}, this.value)"
                  >
                    ${LOCATIONS.map(loc =>
                      `<option value="${loc}" ${item.physicalLocation === loc ? 'selected' : ''}>${loc}</option>`
                    ).join('')}
                  </select>
                </div>
              </div>
              ${item.countedBy && item.lastCounted ? `
                <div class="counted-info">
                  ‚úì Counted by <strong>${item.countedBy}</strong> on ${formatDateTime(item.lastCounted)}
                </div>
              ` : ''}
            </div>
          `;
        });

        html += '</div>';
      });

      container.innerHTML = html;
      updateStats();
    };

    function formatDateTime(isoString) {
      const date = new Date(isoString);
      const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      const timeStr = date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
      return `${dateStr} at ${timeStr}`;
    }

    window.saveCount = async function(itemId, value) {
      const inputEl = document.getElementById(`count-${itemId}`);
      const countValue = value === '' ? null : parseFloat(value);

      try {
        const timestamp = new Date().toISOString();
        const counterName = getActiveCounterName();

        // Update database
        const { error } = await db
          .from('inventory_items')
          .update({
            current_on_hand: countValue,
            last_counted: timestamp,
            counted_by: counterName
          })
          .eq('id', itemId);

        if (error) throw error;

        // Update local state
        const item = inventoryItems.find(i => i.id === itemId);
        if (item) {
          item.currentOnHand = countValue;
          item.lastCounted = timestamp;
          item.countedBy = counterName;
        }

        // Visual feedback
        inputEl.classList.add('saved');
        setTimeout(() => {
          inputEl.classList.remove('saved');
          renderInventory(); // Re-render to show counted info
        }, 800);

        console.log(`‚úÖ Saved count: ${item.itemName} = ${countValue} by ${counterName}`);

      } catch (error) {
        console.error('Error saving count:', error);
        inputEl.style.borderColor = 'var(--error)';
        setTimeout(() => {
          inputEl.style.borderColor = '';
        }, 2000);
      }
    };

    window.saveLocation = async function(itemId, location) {
      try {
        const { error } = await db
          .from('inventory_items')
          .update({ physical_location: location })
          .eq('id', itemId);

        if (error) throw error;

        const item = inventoryItems.find(i => i.id === itemId);
        if (item) {
          item.physicalLocation = location;
        }

        console.log(`‚úÖ Saved location: ${location}`);

      } catch (error) {
        console.error('Error saving location:', error);
      }
    };

    function updateStats() {
      const total = inventoryItems.length;
      const counted = inventoryItems.filter(i => i.lastCounted && i.currentOnHand !== null).length;
      const percent = total > 0 ? Math.round((counted / total) * 100) : 0;

      document.getElementById('totalItems').textContent = total;
      document.getElementById('countedItems').textContent = counted;
      document.getElementById('percentComplete').textContent = percent + '%';
    }

    window.generateReport = function() {
      const reportWin = window.open('', '_blank');
      reportWin.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <title>Inventory Count Report</title>
          <style>
            body { font-family: Arial, sans-serif; padding: 40px; }
            h1 { font-size: 24px; margin-bottom: 20px; }
            table { width: 100%; border-collapse: collapse; margin-top: 20px; }
            th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
            th { background: #212121; color: white; font-weight: 700; text-transform: uppercase; font-size: 11px; }
            tr:nth-child(even) { background: #f9f9f9; }
          </style>
        </head>
        <body>
          <h1>üì¶ Inventory Count Report</h1>
          <p><strong>Date:</strong> ${new Date().toLocaleString()}</p>
          <p><strong>Counted By:</strong> ${getActiveCounterName()}</p>
          <p><strong>Total Items:</strong> ${inventoryItems.length}</p>
          <p><strong>Items Counted:</strong> ${inventoryItems.filter(i => i.lastCounted).length}</p>

          <table>
            <thead>
              <tr>
                <th>Item Name</th>
                <th>Vendor</th>
                <th>Location</th>
                <th>Count</th>
                <th>Unit</th>
                <th>Counted By</th>
                <th>Timestamp</th>
              </tr>
            </thead>
            <tbody>
              ${inventoryItems.map(item => `
                <tr>
                  <td>${item.itemName}</td>
                  <td>${item.vendor || '-'}</td>
                  <td>${item.physicalLocation || '-'}</td>
                  <td><strong>${item.currentOnHand !== null ? item.currentOnHand : '-'}</strong></td>
                  <td>${item.unit || '-'}</td>
                  <td>${item.countedBy || '-'}</td>
                  <td>${item.lastCounted ? new Date(item.lastCounted).toLocaleString() : '-'}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>

          <div style="margin-top: 40px; font-size: 12px; color: #666;">
            Generated by Jayna Gyro Inventory System ‚Ä¢ ${new Date().toLocaleString()}
          </div>
        </body>
        </html>
      `);
      reportWin.document.close();
    };

    window.exportCSV = function() {
      const headers = ['Item Name', 'Vendor', 'Physical Location', 'Category', 'Count', 'Unit', 'Counted By', 'Timestamp'];
      const rows = inventoryItems.map(item => [
        item.itemName,
        item.vendor || '',
        item.physicalLocation || '',
        item.category || '',
        item.currentOnHand !== null ? item.currentOnHand : '',
        item.unit || '',
        item.countedBy || '',
        item.lastCounted || ''
      ]);

      let csv = headers.join(',') + '\n';
      rows.forEach(row => {
        csv += row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',') + '\n';
      });

      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `inventory-count-${new Date().toISOString().split('T')[0]}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    };

    // Initialize
    async function init() {
      await fetchClockedInStaff();
      await loadInventoryData();
      renderInventory();
      updateStats();
    }

    init();
  </script>
</body>
</html>
