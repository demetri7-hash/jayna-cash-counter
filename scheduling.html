<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, viewport-fit=cover">
  <title>Employee Scheduling - Jayna Gyro</title>

  <link rel="apple-touch-icon" href="https://static.spotapps.co/website_images/ab_websites/229800_website_v1/logo.png">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#00A8E1">

  <style>
    /* Jayna Brand Design - Sky Blue & Grayscale */
    :root {
      --primary-blue: #00A8E1;
      --secondary-blue: #0094D6;
      --light-blue: #E3F4FC;
      --accent-blue: #0081C6;
      --gray-900: #212121;
      --gray-700: #424242;
      --gray-600: #616161;
      --gray-500: #757575;
      --gray-400: #BDBDBD;
      --gray-300: #E0E0E0;
      --gray-200: #F3F4F6;
      --gray-100: #F5F5F5;
      --success: #00C853;
      --warning: #FFB300;
      --error: #D32F2F;
      --white: #FFFFFF;
      --blue-bg: #dbeafe;
      --blue-text: #1e40af;
      --success-bg: #d1fae5;
      --success-text: #065f46;
      --success-border: #059669;
      --warning-bg: #fef3c7;
      --warning-text: #92400e;
      --warning-border: #f59e0b;
      --error-bg: #fee2e2;
      --error-text: #991b1b;
      --error-border: #dc2626;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    html, body {
      font-family: 'Aptos', 'Segoe UI Variable', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      background: var(--white);
      min-height: 100vh;
      padding: 0;
      overflow-x: hidden;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: var(--white);
      padding: 0;
    }

    .header {
      background: var(--white);
      color: var(--gray-900);
      text-align: center;
      padding: 16px;
      border-bottom: 2px solid var(--gray-300);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header h1 {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 4px;
      letter-spacing: 1.5px;
      text-transform: uppercase;
    }

    .header p {
      opacity: 0.7;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    /* Tab Navigation */
    .tab-nav {
      display: flex;
      gap: 0;
      border-bottom: 2px solid var(--gray-300);
      background: var(--gray-100);
      position: sticky;
      top: 80px;
      z-index: 99;
    }

    .tab-btn {
      flex: 1;
      padding: 14px 12px;
      background: var(--gray-100);
      color: var(--gray-700);
      border: none;
      border-right: 1px solid var(--gray-300);
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .tab-btn:last-child {
      border-right: none;
    }

    .tab-btn:hover {
      background: var(--gray-200);
    }

    .tab-btn.active {
      background: var(--gray-700);
      color: var(--white);
    }

    /* Tab Content */
    .tab-content {
      display: none;
      padding: 20px;
    }

    .tab-content.active {
      display: block;
    }

    /* Buttons */
    .btn {
      padding: 12px 24px;
      background: var(--gray-900);
      color: white;
      border: 2px solid var(--gray-900);
      font-size: 13px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      cursor: pointer;
      border-radius: 0;
      transition: all 0.15s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn:hover {
      background: var(--gray-700);
      border-color: var(--gray-700);
      transform: translateY(-1px);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.12);
    }

    .btn-secondary {
      background: var(--gray-100);
      color: var(--gray-900);
      border-color: var(--gray-300);
    }

    .btn-secondary:hover {
      background: var(--gray-200);
      border-color: var(--gray-400);
    }

    .btn-success {
      background: #059669;
      border-color: #059669;
    }

    .btn-danger {
      background: #dc2626;
      border-color: #dc2626;
    }

    /* Employee List */
    .employee-list-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 12px;
    }

    .employee-table {
      width: 100%;
      border-collapse: collapse;
      border: 2px solid var(--gray-300);
      background: white;
    }

    .employee-table thead {
      background: var(--gray-100);
      border-bottom: 2px solid var(--gray-300);
    }

    .employee-table th {
      padding: 12px;
      text-align: left;
      font-size: 11px;
      font-weight: 700;
      color: var(--gray-700);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .employee-table td {
      padding: 12px;
      font-size: 13px;
      color: var(--gray-700);
      border-bottom: 1px solid var(--gray-200);
    }

    .employee-table tr:hover {
      background: var(--gray-50);
    }

    .status-badge {
      display: inline-block;
      padding: 4px 10px;
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-radius: 0;
    }

    .status-active {
      background: var(--success-bg);
      color: var(--success-text);
    }

    .status-inactive {
      background: var(--error-bg);
      color: var(--error-text);
    }

    /* Schedule View */
    .schedule-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 12px;
    }

    .week-nav {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .week-nav button {
      padding: 8px 16px;
      background: var(--gray-100);
      border: 2px solid var(--gray-300);
      font-size: 12px;
      font-weight: 700;
      cursor: pointer;
      border-radius: 0;
    }

    .week-nav button:hover {
      background: var(--gray-200);
    }

    .week-display {
      font-size: 14px;
      font-weight: 700;
      color: var(--gray-900);
      padding: 8px 16px;
    }

    /* Calendar Grid */
    .calendar-grid {
      overflow-x: auto;
      border: 2px solid var(--gray-300);
      background: white;
    }

    .calendar-table {
      width: 100%;
      min-width: 900px;
      border-collapse: collapse;
    }

    .calendar-table thead {
      background: var(--gray-100);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .calendar-table th {
      padding: 12px 8px;
      text-align: center;
      font-size: 11px;
      font-weight: 700;
      color: var(--gray-700);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border: 1px solid var(--gray-300);
      min-width: 120px;
    }

    .calendar-table th.time-col {
      width: 80px;
      min-width: 80px;
    }

    .calendar-table td {
      padding: 8px;
      text-align: center;
      font-size: 12px;
      border: 1px solid var(--gray-200);
      height: 60px;
      vertical-align: top;
      position: relative;
    }

    .calendar-table td.time-cell {
      background: var(--gray-50);
      font-weight: 600;
      color: var(--gray-600);
      font-size: 11px;
    }

    .day-header {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .day-name {
      font-size: 12px;
      font-weight: 700;
      color: var(--gray-900);
    }

    .day-date {
      font-size: 10px;
      color: var(--gray-600);
      margin-top: 2px;
    }

    /* Shift Blocks */
    .shift-block {
      background: var(--primary-blue);
      color: white;
      padding: 8px;
      margin: 2px;
      border-radius: 0;
      font-size: 11px;
      font-weight: 600;
      cursor: move;
      user-select: none;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      transition: all 0.15s ease;
      position: relative;
    }

    .shift-block:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .shift-block.dragging {
      opacity: 0.5;
      cursor: grabbing;
    }

    .shift-block.position-foh {
      background: var(--primary-blue);
    }

    .shift-block.position-boh {
      background: var(--warning);
      color: var(--gray-900);
    }

    .shift-block.position-manager {
      background: var(--gray-900);
    }

    .shift-employee-name {
      font-size: 12px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .shift-time {
      font-size: 10px;
      opacity: 0.9;
    }

    /* Drop Zone */
    .drop-zone {
      min-height: 60px;
    }

    .drop-zone.drag-over {
      background: var(--success-bg) !important;
      border: 2px dashed var(--success-border) !important;
    }

    /* Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 10000;
      align-items: center;
      justify-content: center;
      padding: 20px;
      overflow-y: auto;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal-content {
      background: white;
      padding: 24px;
      max-width: 600px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      border: 3px solid var(--gray-700);
      border-radius: 0;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-title {
      font-size: 18px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--gray-700);
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-close:hover {
      color: var(--gray-900);
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      margin-bottom: 8px;
      font-size: 11px;
      font-weight: 700;
      color: var(--gray-700);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .form-input,
    .form-select {
      width: 100%;
      padding: 12px;
      border: 2px solid var(--gray-300);
      border-radius: 0;
      font-size: 14px;
      font-family: inherit;
      background: white;
      box-sizing: border-box;
    }

    .form-input:focus,
    .form-select:focus {
      border-color: var(--gray-700);
      outline: none;
    }

    .form-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      margin-top: 24px;
    }

    /* Loading Overlay */
    .loading-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(33, 33, 33, 0.85);
      z-index: 9999;
      align-items: center;
      justify-content: center;
    }

    .loading-overlay.active {
      display: flex;
    }

    .loading-content {
      text-align: center;
      background: white;
      padding: 40px 50px;
      border: 3px solid var(--gray-700);
      border-radius: 0;
    }

    .spinner {
      border: 4px solid var(--gray-300);
      border-top: 4px solid var(--gray-900);
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 24px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loading-title {
      font-size: 14px;
      font-weight: 700;
      color: var(--gray-900);
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .loading-message {
      font-size: 13px;
      color: var(--gray-700);
    }

    /* Success/Error Overlays */
    .message-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 10000;
      align-items: center;
      justify-content: center;
    }

    .message-overlay.active {
      display: flex;
    }

    .message-content {
      text-align: center;
      background: white;
      padding: 40px 50px;
      border-radius: 0;
      min-width: 300px;
    }

    .message-content.success {
      border: 3px solid #059669;
    }

    .message-content.error {
      border: 3px solid #dc2626;
    }

    .message-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }

    .message-text {
      font-size: 16px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .message-content.success .message-text {
      color: #065f46;
    }

    .message-content.error .message-text {
      color: #991b1b;
    }

    /* Labor Cost Summary */
    .labor-summary {
      background: var(--gray-100);
      border: 2px solid var(--gray-300);
      padding: 16px;
      margin-bottom: 20px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
    }

    .labor-stat {
      text-align: center;
    }

    .labor-stat-label {
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--gray-600);
      margin-bottom: 4px;
    }

    .labor-stat-value {
      font-size: 24px;
      font-weight: 700;
      color: var(--gray-900);
    }

    /* Responsive */
    @media (max-width: 768px) {
      .tab-btn {
        font-size: 10px;
        padding: 12px 8px;
      }

      .calendar-table {
        min-width: 100%;
      }

      .calendar-table th,
      .calendar-table td {
        min-width: 100px;
      }
    }
  </style>

  <!-- Supabase JS Client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

<div class="container">
  <!-- Header -->
  <div class="header">
    <img src="jayna-logo-new.png" alt="Jayna Gyro Logo" style="width: 300px; height: 155px; margin-bottom: 4px;">
    <h1 style="margin-bottom: 8px;">JAYNA GYRO</h1>
    <p style="margin-bottom: 8px;">FOR AUTHORIZED USE ONLY</p>

    <!-- TIPS PER HOUR -->
    <div style="margin-top: 8px; font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: #666;">
      CURRENT TIPS PER HOUR
    </div>
    <div id="tipsPerHourText" style="margin-top: 4px; font-size: 9px; line-height: 1.3;">
      </div>
      <div id="tipsLastUpdated" style="margin-top: 4px; font-size: 8px; color: #999; font-weight: 500;">
        <!-- Last updated timestamp -->
      </div>
      <div id="tipsLastUpdated" style="margin-top: 4px; font-size: 8px; color: #999; font-weight: 500;">
    </div>

    <!-- TOP LEADER DISPLAY -->
    <div id="topLeaderDisplay" onclick="window.location.href='teamupdates.html'" style="margin-top: 12px; padding: 8px 12px; background: linear-gradient(135deg, #FFD700 0%, #FFF9E6 100%); border: 2px solid #FFD700; border-radius: 0; cursor: pointer; transition: all 0.15s ease;">
      <div style="font-size: 9px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: #666; margin-bottom: 2px;">üèÜ TODAY'S LEADER</div>
      <div id="topLeaderText" style="font-size: 13px; font-weight: 700; color: #212121;">
        Loading...
      </div>
    </div>

  </div>

  <!-- Navigation -->
  <div style="padding: 12px;">
    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-bottom: 12px;">
      <a href="index.html" class="menu-btn primary" style="text-decoration: none; padding: 16px 12px; border: 2px solid var(--gray-300); background: var(--gray-100); font-size: 11px; font-weight: 700; color: var(--gray-900); text-align: center; min-height: 50px; display: flex; align-items: center; justify-content: center; text-transform: uppercase; letter-spacing: 1.2px;">Cash</a>
      <a href="index.html" class="menu-btn" style="text-decoration: none; padding: 16px 12px; border: 2px solid var(--gray-700); background: var(--gray-700); font-size: 11px; font-weight: 700; color: white; text-align: center; min-height: 50px; display: flex; align-items: center; justify-content: center; text-transform: uppercase; letter-spacing: 1.2px;">Orders & Prep</a>
      <a href="foh-checklists.html" class="menu-btn primary" style="text-decoration: none; padding: 16px 12px; border: 2px solid var(--gray-300); background: var(--gray-100); font-size: 11px; font-weight: 700; color: var(--gray-900); text-align: center; min-height: 50px; display: flex; align-items: center; justify-content: center; text-transform: uppercase; letter-spacing: 1.2px;">FOH</a>
      <a href="boh.html" class="menu-btn" style="text-decoration: none; padding: 16px 12px; border: 2px solid var(--gray-700); background: var(--gray-700); font-size: 11px; font-weight: 700; color: white; text-align: center; min-height: 50px; display: flex; align-items: center; justify-content: center; text-transform: uppercase; letter-spacing: 1.2px;">BOH</a>
      <a href="catering.html" class="menu-btn primary" style="text-decoration: none; padding: 16px 12px; border: 2px solid var(--gray-300); background: var(--gray-100); font-size: 11px; font-weight: 700; color: var(--gray-900); text-align: center; min-height: 50px; display: flex; align-items: center; justify-content: center; text-transform: uppercase; letter-spacing: 1.2px;">Catering</a>
      <a href="drivers.html" class="menu-btn" style="text-decoration: none; padding: 16px 12px; border: 2px solid var(--gray-700); background: var(--gray-700); font-size: 11px; font-weight: 700; color: white; text-align: center; min-height: 50px; display: flex; align-items: center; justify-content: center; text-transform: uppercase; letter-spacing: 1.2px;">Drivers</a>
      <button class="menu-btn primary" style="cursor: default; background: var(--gray-300) !important; border-color: var(--gray-400) !important; padding: 16px 12px; font-size: 11px; font-weight: 700; text-align: center; min-height: 50px; display: flex; align-items: center; justify-content: center; text-transform: uppercase; letter-spacing: 1.2px; border: 2px solid;">Scheduling</button>
      <a href="manager.html" class="menu-btn" style="text-decoration: none; padding: 16px 12px; border: 2px solid var(--gray-700); background: var(--gray-700); font-size: 11px; font-weight: 700; color: white; text-align: center; min-height: 50px; display: flex; align-items: center; justify-content: center; text-transform: uppercase; letter-spacing: 1.2px;">Manager</a>
        <a href="teamupdates.html" class="menu-btn primary">Team Updates</a>
    </div>
  </div>

  <!-- Tab Navigation -->
  <div class="tab-nav">
    <button class="tab-btn active" onclick="switchTab('staff')">STAFF</button>
    <button class="tab-btn" onclick="switchTab('schedule')">SCHEDULE</button>
  </div>

  <!-- STAFF TAB -->
  <div id="staffTab" class="tab-content active">
    <div class="employee-list-header">
      <h2 style="font-size: 16px; font-weight: 700; text-transform: uppercase;">Employee List</h2>
      <div style="display: flex; gap: 12px; align-items: center;">
        <label style="display: flex; align-items: center; gap: 8px; font-size: 12px; font-weight: 600; color: var(--gray-700);">
          <input type="checkbox" id="showInactiveToggle" onchange="renderEmployeeTable()" style="width: 18px; height: 18px; cursor: pointer;">
          Show Inactive
        </label>
        <button class="btn" onclick="syncEmployeesFromToast()">
          <span>üîÑ</span> SYNC FROM TOAST
        </button>
      </div>
    </div>

    <div id="lastSyncInfo" style="margin-bottom: 16px; font-size: 12px; color: var(--gray-600);"></div>

    <div id="employeeTableContainer">
      <table class="employee-table">
        <thead>
          <tr>
            <th>Name</th>
            <th>Job Title</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="employeeTableBody">
          <tr>
            <td colspan="4" style="text-align: center; padding: 40px; color: var(--gray-500);">
              Click "SYNC FROM TOAST" to load employees
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- SCHEDULE TAB -->
  <div id="scheduleTab" class="tab-content">
    <!-- Schedule Header -->
    <div class="schedule-header">
      <div class="week-nav">
        <button onclick="previousWeek()">‚óÄ PREV</button>
        <div class="week-display" id="weekDisplay">Loading...</div>
        <button onclick="nextWeek()">NEXT ‚ñ∂</button>
        <button onclick="goToToday()">TODAY</button>
      </div>
      <button class="btn btn-success" onclick="openAddShiftModal()">
        <span>+</span> ADD SHIFT
      </button>
    </div>

    <!-- Labor Cost Summary -->
    <div class="labor-summary">
      <div class="labor-stat">
        <div class="labor-stat-label">Total Hours</div>
        <div class="labor-stat-value" id="totalHours">0.0</div>
      </div>
      <div class="labor-stat">
        <div class="labor-stat-label">Labor Cost</div>
        <div class="labor-stat-value" id="totalLaborCost">$0.00</div>
      </div>
      <div class="labor-stat">
        <div class="labor-stat-label">Shifts</div>
        <div class="labor-stat-value" id="totalShifts">0</div>
      </div>
    </div>

    <!-- Calendar Grid -->
    <div class="calendar-grid">
      <table class="calendar-table">
        <thead>
          <tr>
            <th class="time-col">TIME</th>
            <th id="daySun"><div class="day-header"><span class="day-name">SUNDAY</span><span class="day-date"></span></div></th>
            <th id="dayMon"><div class="day-header"><span class="day-name">MONDAY</span><span class="day-date"></span></div></th>
            <th id="dayTue"><div class="day-header"><span class="day-name">TUESDAY</span><span class="day-date"></span></div></th>
            <th id="dayWed"><div class="day-header"><span class="day-name">WEDNESDAY</span><span class="day-date"></span></div></th>
            <th id="dayThu"><div class="day-header"><span class="day-name">THURSDAY</span><span class="day-date"></span></div></th>
            <th id="dayFri"><div class="day-header"><span class="day-name">FRIDAY</span><span class="day-date"></span></div></th>
            <th id="daySat"><div class="day-header"><span class="day-name">SATURDAY</span><span class="day-date"></span></div></th>
          </tr>
        </thead>
        <tbody id="calendarBody">
          <!-- Generated dynamically -->
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Add/Edit Shift Modal -->
<div id="shiftModal" class="modal-overlay">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title" id="shiftModalTitle">ADD SHIFT</h2>
      <button class="modal-close" onclick="closeShiftModal()">‚úï</button>
    </div>

    <form id="shiftForm" onsubmit="saveShift(event)">
      <input type="hidden" id="shiftId">

      <div class="form-group">
        <label class="form-label" for="shiftEmployee">Employee</label>
        <select class="form-select" id="shiftEmployee" required>
          <option value="">Select Employee...</option>
        </select>
      </div>

      <div class="form-group">
        <label class="form-label" for="shiftDate">Date</label>
        <input type="date" class="form-input" id="shiftDate" required>
      </div>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
        <div class="form-group">
          <label class="form-label" for="shiftStartTime">Start Time</label>
          <input type="time" class="form-input" id="shiftStartTime" required>
        </div>

        <div class="form-group">
          <label class="form-label" for="shiftEndTime">End Time</label>
          <input type="time" class="form-input" id="shiftEndTime" required>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label" for="shiftPosition">Position</label>
        <select class="form-select" id="shiftPosition" required>
          <option value="">Select Position...</option>
          <option value="Server">Server</option>
          <option value="Host">Host</option>
          <option value="Cook">Cook</option>
          <option value="Prep">Prep Cook</option>
          <option value="Dishwasher">Dishwasher</option>
          <option value="Manager">Manager</option>
          <option value="Other">Other</option>
        </select>
      </div>

      <div class="form-group">
        <label class="form-label" for="shiftBreakMinutes">Break Time (minutes)</label>
        <input type="number" class="form-input" id="shiftBreakMinutes" value="0" min="0" max="120">
      </div>

      <div class="form-group">
        <label class="form-label" for="shiftNotes">Notes (optional)</label>
        <input type="text" class="form-input" id="shiftNotes" placeholder="Any special notes...">
      </div>

      <div id="shiftCostPreview" style="padding: 12px; background: var(--gray-100); border: 2px solid var(--gray-300); margin-bottom: 20px; display: none;">
        <div style="font-size: 11px; font-weight: 700; text-transform: uppercase; color: var(--gray-600); margin-bottom: 4px;">Estimated Cost</div>
        <div style="font-size: 18px; font-weight: 700; color: var(--gray-900);" id="shiftCostAmount">$0.00</div>
        <div style="font-size: 11px; color: var(--gray-600); margin-top: 4px;" id="shiftCostDetails"></div>
      </div>

      <div class="form-actions">
        <button type="button" class="btn btn-secondary" onclick="closeShiftModal()">CANCEL</button>
        <button type="submit" class="btn btn-success">SAVE SHIFT</button>
      </div>
    </form>
  </div>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="loading-overlay">
  <div class="loading-content">
    <div class="spinner"></div>
    <div class="loading-title" id="loadingTitle">LOADING</div>
    <div class="loading-message" id="loadingMessage">Please wait...</div>
  </div>
</div>

<!-- Success Message Overlay -->
<div id="successOverlay" class="message-overlay">
  <div class="message-content success">
    <div class="message-icon">‚úÖ</div>
    <div class="message-text" id="successMessage"></div>
  </div>
</div>

<!-- Error Message Overlay -->
<div id="errorOverlay" class="message-overlay">
  <div class="message-content error">
    <div class="message-icon">‚ùå</div>
    <div class="message-text" id="errorMessage"></div>
    <button class="btn btn-secondary" onclick="hideError()" style="margin-top: 20px;">OK</button>
  </div>
</div>

<!-- Employee Details Modal (Password Protected) -->
<div id="employeeDetailsModal" class="modal-overlay">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title">EMPLOYEE DETAILS</h2>
      <button class="modal-close" onclick="closeEmployeeDetailsModal()">‚úï</button>
    </div>

    <!-- Password Gate -->
    <div id="employeePasswordGate" style="text-align: center; padding: 20px;">
      <p style="font-size: 13px; color: var(--gray-700); margin-bottom: 16px;">Manager password required to view sensitive information</p>
      <input type="password" id="employeeDetailsPassword" placeholder="Enter manager password" class="form-input" style="max-width: 300px; margin: 0 auto 16px;">
      <button onclick="unlockEmployeeDetails()" class="btn">UNLOCK</button>
    </div>

    <!-- Employee Details Content (hidden until unlocked) -->
    <div id="employeeDetailsContent" style="display: none;">
      <div style="background: var(--gray-100); padding: 16px; border: 2px solid var(--gray-300); margin-bottom: 20px;">
        <div style="font-size: 11px; font-weight: 700; text-transform: uppercase; color: var(--gray-600); margin-bottom: 8px;">Employee Name</div>
        <div style="font-size: 18px; font-weight: 700; color: var(--gray-900);" id="detailsEmployeeName"></div>
      </div>

      <div class="form-group">
        <label class="form-label">JOB TITLE</label>
        <div style="font-size: 14px; color: var(--gray-700); padding: 12px; background: white; border: 2px solid var(--gray-300);" id="detailsJobTitle"></div>
      </div>

      <div class="form-group">
        <label class="form-label">HOURLY WAGE</label>
        <div style="font-size: 20px; font-weight: 700; color: var(--success-text); padding: 12px; background: var(--success-bg); border: 2px solid var(--success-border);" id="detailsHourlyWage"></div>
      </div>

      <div class="form-group">
        <label class="form-label">EMAIL</label>
        <div style="font-size: 14px; color: var(--gray-700); padding: 12px; background: white; border: 2px solid var(--gray-300);" id="detailsEmail"></div>
      </div>

      <div class="form-group">
        <label class="form-label">PHONE</label>
        <div style="font-size: 14px; color: var(--gray-700); padding: 12px; background: white; border: 2px solid var(--gray-300);" id="detailsPhone"></div>
      </div>

      <div class="form-group">
        <label class="form-label">STATUS</label>
        <div id="detailsStatus"></div>
      </div>

      <div class="form-group">
        <label class="form-label">LAST SYNCED FROM TOAST</label>
        <div style="font-size: 12px; color: var(--gray-600); padding: 12px; background: white; border: 2px solid var(--gray-300);" id="detailsLastSynced"></div>
      </div>

      <div style="text-align: center; margin-top: 24px;">
        <button class="btn btn-secondary" onclick="closeEmployeeDetailsModal()">CLOSE</button>
      </div>
    </div>
  </div>
</div>

<script>
// ============================================
// GLOBAL STATE
// ============================================

let supabase;
let employees = [];
let currentWeekStart = null;
let shifts = [];

// ============================================
// INITIALIZATION
// ============================================

async function init() {
  // Initialize Supabase
  const supabaseUrl = 'https://gaawtbqpnnbbnsyswqwv.supabase.co';
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdhYXd0YnFwbm5iYm5zeXN3cXd2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1MDE1NTAsImV4cCI6MjA3MjA3NzU1MH0.F-y7AIQTWaUe7DRT4OnIZVn94mhXxfhpBbng2aJ8nXg';

  supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

  console.log('‚úÖ Supabase initialized');

  // Load initial data
  await loadEmployees();

  // Set current week to today
  goToToday();

  // Load tips per hour
  fetchTipsPerHour();
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', init);

// ============================================
// TAB NAVIGATION
// ============================================

function switchTab(tabName) {
  // Update tab buttons
  const tabButtons = document.querySelectorAll('.tab-btn');
  tabButtons.forEach(btn => btn.classList.remove('active'));
  event.target.classList.add('active');

  // Update tab content
  const tabContents = document.querySelectorAll('.tab-content');
  tabContents.forEach(content => content.classList.remove('active'));

  if (tabName === 'staff') {
    document.getElementById('staffTab').classList.add('active');
  } else if (tabName === 'schedule') {
    document.getElementById('scheduleTab').classList.add('active');
    // Load schedule when switching to this tab
    loadWeekSchedule();
  }
}

// ============================================
// EMPLOYEE MANAGEMENT
// ============================================

async function syncEmployeesFromToast() {
  try {
    showLoading('SYNCING EMPLOYEES', 'Fetching employee data from Toast POS...');

    const response = await fetch('/api/toast-employees-sync', {
      method: 'POST'
    });

    const result = await response.json();
    hideLoading();

    if (!result.success) {
      showError(`Sync failed: ${result.error || 'Unknown error'}`);
      return;
    }

    showSuccess(`‚úÖ Synced ${result.synced} employees successfully!`);

    // Reload employees
    await loadEmployees();

  } catch (error) {
    hideLoading();
    console.error('Error syncing employees:', error);
    showError(`Sync failed: ${error.message}`);
  }
}

async function loadEmployees() {
  try {
    const { data, error } = await supabase
      .from('employees')
      .select('*')
      .order('last_name', { ascending: true });

    if (error) throw error;

    employees = data || [];
    console.log(`‚úÖ Loaded ${employees.length} employees`);

    renderEmployeeTable();
    populateEmployeeDropdown();

  } catch (error) {
    console.error('Error loading employees:', error);
  }
}

function renderEmployeeTable() {
  const tbody = document.getElementById('employeeTableBody');
  const showInactive = document.getElementById('showInactiveToggle')?.checked || false;

  if (employees.length === 0) {
    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 40px; color: var(--gray-500);">No employees found. Click "SYNC FROM TOAST" to load employees.</td></tr>';
    document.getElementById('lastSyncInfo').textContent = '';
    return;
  }

  // Filter employees by active status
  const filteredEmployees = showInactive ? employees : employees.filter(emp => emp.is_active);

  // Show last sync time and count (Pacific Time)
  const lastSync = employees[0]?.last_synced_from_toast;
  if (lastSync) {
    const syncDate = new Date(lastSync);
    const activeCount = employees.filter(emp => emp.is_active).length;
    const inactiveCount = employees.length - activeCount;
    document.getElementById('lastSyncInfo').textContent =
      `Last synced: ${syncDate.toLocaleString('en-US', { timeZone: 'America/Los_Angeles' })} PT | Active: ${activeCount} | Inactive: ${inactiveCount} | Total: ${employees.length}`;
  }

  tbody.innerHTML = '';

  if (filteredEmployees.length === 0) {
    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 40px; color: var(--gray-500);">No active employees found.</td></tr>';
    return;
  }

  filteredEmployees.forEach(emp => {
    const row = document.createElement('tr');

    const nameCell = document.createElement('td');
    nameCell.textContent = `${emp.first_name} ${emp.last_name}`.trim();
    nameCell.style.fontWeight = '600';
    row.appendChild(nameCell);

    const jobCell = document.createElement('td');
    jobCell.textContent = emp.job_title || 'Staff';
    row.appendChild(jobCell);

    const statusCell = document.createElement('td');
    const statusBadge = document.createElement('span');
    statusBadge.className = `status-badge ${emp.is_active ? 'status-active' : 'status-inactive'}`;
    statusBadge.textContent = emp.is_active ? 'ACTIVE' : 'INACTIVE';
    statusCell.appendChild(statusBadge);
    row.appendChild(statusCell);

    const actionsCell = document.createElement('td');
    const viewBtn = document.createElement('button');
    viewBtn.textContent = 'View Details';
    viewBtn.className = 'btn btn-secondary';
    viewBtn.style.padding = '6px 12px';
    viewBtn.style.fontSize = '11px';
    viewBtn.onclick = () => openEmployeeDetailsModal(emp);
    actionsCell.appendChild(viewBtn);
    row.appendChild(actionsCell);

    tbody.appendChild(row);
  });
}

function populateEmployeeDropdown() {
  const select = document.getElementById('shiftEmployee');

  // Clear existing options (except first)
  while (select.options.length > 1) {
    select.remove(1);
  }

  // Add active employees only
  employees.filter(emp => emp.is_active).forEach(emp => {
    const option = document.createElement('option');
    option.value = emp.id;
    option.textContent = `${emp.first_name} ${emp.last_name} - ${emp.job_title || 'Staff'}`;
    option.dataset.wage = emp.hourly_wage || 0;
    select.appendChild(option);
  });
}

// ============================================
// EMPLOYEE DETAILS MODAL (Password Protected)
// ============================================

let selectedEmployee = null;

function openEmployeeDetailsModal(emp) {
  selectedEmployee = emp;
  document.getElementById('employeeDetailsModal').classList.add('active');
  document.getElementById('employeePasswordGate').style.display = 'block';
  document.getElementById('employeeDetailsContent').style.display = 'none';
  document.getElementById('employeeDetailsPassword').value = '';
}

function unlockEmployeeDetails() {
  const password = document.getElementById('employeeDetailsPassword').value;
  const MANAGER_PASSWORD = 'JaynaGyro2025!'; // Existing manager password

  if (password !== MANAGER_PASSWORD) {
    showError('Incorrect password');
    return;
  }

  // Populate modal with employee data
  document.getElementById('detailsEmployeeName').textContent =
    `${selectedEmployee.first_name} ${selectedEmployee.last_name}`.trim();
  document.getElementById('detailsJobTitle').textContent =
    selectedEmployee.job_title || 'Staff';
  document.getElementById('detailsHourlyWage').textContent =
    selectedEmployee.hourly_wage ? `$${selectedEmployee.hourly_wage.toFixed(2)}/hr` : 'Not Available';
  document.getElementById('detailsEmail').textContent =
    selectedEmployee.email || 'Not Provided';
  document.getElementById('detailsPhone').textContent =
    selectedEmployee.phone || 'Not Provided';

  const statusBadge = document.createElement('span');
  statusBadge.className = `status-badge ${selectedEmployee.is_active ? 'status-active' : 'status-inactive'}`;
  statusBadge.textContent = selectedEmployee.is_active ? 'ACTIVE' : 'INACTIVE';
  document.getElementById('detailsStatus').innerHTML = '';
  document.getElementById('detailsStatus').appendChild(statusBadge);

  document.getElementById('detailsLastSynced').textContent =
    selectedEmployee.last_synced_from_toast ?
    new Date(selectedEmployee.last_synced_from_toast).toLocaleString('en-US', { timeZone: 'America/Los_Angeles' }) + ' PT' : 'Never';

  // Hide password gate, show details
  document.getElementById('employeePasswordGate').style.display = 'none';
  document.getElementById('employeeDetailsContent').style.display = 'block';
}

function closeEmployeeDetailsModal() {
  document.getElementById('employeeDetailsModal').classList.remove('active');
  selectedEmployee = null;
}

// ============================================
// SCHEDULE MANAGEMENT
// ============================================

function goToToday() {
  const today = new Date();
  // Get Sunday of current week
  const dayOfWeek = today.getDay();
  const sundayDate = new Date(today);
  sundayDate.setDate(today.getDate() - dayOfWeek);

  currentWeekStart = sundayDate;
  updateWeekDisplay();
  loadWeekSchedule();
}

function previousWeek() {
  currentWeekStart.setDate(currentWeekStart.getDate() - 7);
  updateWeekDisplay();
  loadWeekSchedule();
}

function nextWeek() {
  currentWeekStart.setDate(currentWeekStart.getDate() + 7);
  updateWeekDisplay();
  loadWeekSchedule();
}

function updateWeekDisplay() {
  const weekEnd = new Date(currentWeekStart);
  weekEnd.setDate(currentWeekStart.getDate() + 6);

  const formatDate = (date) => {
    const month = date.toLocaleString('en-US', { month: 'short' });
    const day = date.getDate();
    return `${month} ${day}`;
  };

  document.getElementById('weekDisplay').textContent =
    `${formatDate(currentWeekStart)} - ${formatDate(weekEnd)}, ${currentWeekStart.getFullYear()}`;

  // Update day headers with dates
  for (let i = 0; i < 7; i++) {
    const date = new Date(currentWeekStart);
    date.setDate(currentWeekStart.getDate() + i);

    const dayNames = ['daySun', 'dayMon', 'dayTue', 'dayWed', 'dayThu', 'dayFri', 'daySat'];
    const dayHeader = document.getElementById(dayNames[i]);
    const dateSpan = dayHeader.querySelector('.day-date');
    dateSpan.textContent = `${date.getMonth() + 1}/${date.getDate()}`;
  }

  generateCalendarGrid();
}

function generateCalendarGrid() {
  const tbody = document.getElementById('calendarBody');
  tbody.innerHTML = '';

  // Generate hourly rows from 6 AM to 11 PM
  for (let hour = 6; hour <= 23; hour++) {
    const row = document.createElement('tr');

    // Time cell
    const timeCell = document.createElement('td');
    timeCell.className = 'time-cell';
    const displayHour = hour > 12 ? hour - 12 : (hour === 0 ? 12 : hour);
    const period = hour >= 12 ? 'PM' : 'AM';
    timeCell.textContent = `${displayHour}:00 ${period}`;
    row.appendChild(timeCell);

    // Day cells (7 days)
    for (let day = 0; day < 7; day++) {
      const cell = document.createElement('td');
      cell.className = 'drop-zone';

      const date = new Date(currentWeekStart);
      date.setDate(currentWeekStart.getDate() + day);
      const dateStr = date.toISOString().split('T')[0];

      cell.dataset.date = dateStr;
      cell.dataset.hour = hour;

      // Add drop event listeners
      cell.addEventListener('dragover', handleDragOver);
      cell.addEventListener('drop', handleDrop);
      cell.addEventListener('dragleave', handleDragLeave);

      row.appendChild(cell);
    }

    tbody.appendChild(row);
  }
}

async function loadWeekSchedule() {
  try {
    showLoading('LOADING SCHEDULE', 'Fetching shifts for this week...');

    const weekEnd = new Date(currentWeekStart);
    weekEnd.setDate(currentWeekStart.getDate() + 6);

    const { data, error } = await supabase
      .from('shifts')
      .select('*, employee:employees(*)')
      .gte('shift_date', currentWeekStart.toISOString().split('T')[0])
      .lte('shift_date', weekEnd.toISOString().split('T')[0]);

    hideLoading();

    if (error) throw error;

    shifts = data || [];
    console.log(`‚úÖ Loaded ${shifts.length} shifts for week`);

    renderShifts();
    updateLaborSummary();

  } catch (error) {
    hideLoading();
    console.error('Error loading schedule:', error);
    showError(`Failed to load schedule: ${error.message}`);
  }
}

function renderShifts() {
  // Clear existing shift blocks
  document.querySelectorAll('.shift-block').forEach(block => block.remove());

  shifts.forEach(shift => {
    const shiftBlock = createShiftBlock(shift);

    // Find the cell to place it in
    const date = shift.shift_date;
    const startHour = parseInt(shift.start_time.split(':')[0]);

    const cell = document.querySelector(`td[data-date="${date}"][data-hour="${startHour}"]`);
    if (cell) {
      cell.appendChild(shiftBlock);
    }
  });
}

function createShiftBlock(shift) {
  const block = document.createElement('div');
  block.className = 'shift-block';
  block.draggable = true;
  block.dataset.shiftId = shift.id;

  // Position-based color
  const position = shift.position?.toLowerCase() || '';
  if (position.includes('server') || position.includes('host')) {
    block.classList.add('position-foh');
  } else if (position.includes('cook') || position.includes('prep') || position.includes('dish')) {
    block.classList.add('position-boh');
  } else if (position.includes('manager')) {
    block.classList.add('position-manager');
  }

  const employeeName = document.createElement('div');
  employeeName.className = 'shift-employee-name';
  employeeName.textContent = shift.employee ? `${shift.employee.first_name} ${shift.employee.last_name}` : 'Open Shift';
  block.appendChild(employeeName);

  const timeInfo = document.createElement('div');
  timeInfo.className = 'shift-time';
  timeInfo.textContent = `${formatTime(shift.start_time)} - ${formatTime(shift.end_time)}`;
  block.appendChild(timeInfo);

  // Drag events
  block.addEventListener('dragstart', handleDragStart);
  block.addEventListener('dragend', handleDragEnd);

  // Click to edit
  block.addEventListener('click', (e) => {
    if (!e.target.closest('.delete-btn')) {
      editShift(shift);
    }
  });

  return block;
}

function formatTime(timeStr) {
  const [hours, minutes] = timeStr.split(':');
  const hour = parseInt(hours);
  const displayHour = hour > 12 ? hour - 12 : (hour === 0 ? 12 : hour);
  const period = hour >= 12 ? 'PM' : 'AM';
  return `${displayHour}:${minutes} ${period}`;
}

function updateLaborSummary() {
  const totalHours = shifts.reduce((sum, shift) => sum + (shift.total_hours || 0), 0);
  const totalCost = shifts.reduce((sum, shift) => sum + (shift.shift_cost || 0), 0);
  const totalShiftCount = shifts.length;

  document.getElementById('totalHours').textContent = totalHours.toFixed(1);
  document.getElementById('totalLaborCost').textContent = `$${totalCost.toFixed(2)}`;
  document.getElementById('totalShifts').textContent = totalShiftCount;
}

// ============================================
// DRAG AND DROP
// ============================================

let draggedShiftId = null;

function handleDragStart(e) {
  draggedShiftId = e.target.dataset.shiftId;
  e.target.classList.add('dragging');
  e.dataTransfer.effectAllowed = 'move';
}

function handleDragEnd(e) {
  e.target.classList.remove('dragging');
  draggedShiftId = null;
}

function handleDragOver(e) {
  e.preventDefault();
  e.dataTransfer.dropEffect = 'move';
  e.currentTarget.classList.add('drag-over');
}

function handleDragLeave(e) {
  e.currentTarget.classList.remove('drag-over');
}

async function handleDrop(e) {
  e.preventDefault();
  e.currentTarget.classList.remove('drag-over');

  if (!draggedShiftId) return;

  const targetCell = e.currentTarget;
  const newDate = targetCell.dataset.date;
  const newHour = parseInt(targetCell.dataset.hour);

  // Find the shift
  const shift = shifts.find(s => s.id === draggedShiftId);
  if (!shift) return;

  // Calculate new times (keep duration same)
  const [oldStartHour, oldStartMinute] = shift.start_time.split(':').map(Number);
  const [oldEndHour, oldEndMinute] = shift.end_time.split(':').map(Number);
  const duration = (oldEndHour * 60 + oldEndMinute) - (oldStartHour * 60 + oldStartMinute);

  const newStartTime = `${String(newHour).padStart(2, '0')}:${String(oldStartMinute).padStart(2, '0')}:00`;
  const newEndHour = Math.floor((newHour * 60 + oldStartMinute + duration) / 60);
  const newEndMinute = (newHour * 60 + oldStartMinute + duration) % 60;
  const newEndTime = `${String(newEndHour).padStart(2, '0')}:${String(newEndMinute).padStart(2, '0')}:00`;

  try {
    showLoading('MOVING SHIFT', 'Updating schedule...');

    const { error } = await supabase
      .from('shifts')
      .update({
        shift_date: newDate,
        start_time: newStartTime,
        end_time: newEndTime,
        updated_at: new Date().toISOString()
      })
      .eq('id', draggedShiftId);

    hideLoading();

    if (error) throw error;

    // Reload schedule
    await loadWeekSchedule();

  } catch (error) {
    hideLoading();
    console.error('Error moving shift:', error);
    showError(`Failed to move shift: ${error.message}`);
  }
}

// ============================================
// SHIFT MODAL
// ============================================

function openAddShiftModal() {
  document.getElementById('shiftModalTitle').textContent = 'ADD SHIFT';
  document.getElementById('shiftForm').reset();
  document.getElementById('shiftId').value = '';
  document.getElementById('shiftCostPreview').style.display = 'none';

  // Set default date to Monday of current week
  const monday = new Date(currentWeekStart);
  monday.setDate(currentWeekStart.getDate() + 1);
  document.getElementById('shiftDate').value = monday.toISOString().split('T')[0];

  document.getElementById('shiftModal').classList.add('active');
}

function editShift(shift) {
  document.getElementById('shiftModalTitle').textContent = 'EDIT SHIFT';
  document.getElementById('shiftId').value = shift.id;
  document.getElementById('shiftEmployee').value = shift.employee_id;
  document.getElementById('shiftDate').value = shift.shift_date;
  document.getElementById('shiftStartTime').value = shift.start_time.substring(0, 5);
  document.getElementById('shiftEndTime').value = shift.end_time.substring(0, 5);
  document.getElementById('shiftPosition').value = shift.position;
  document.getElementById('shiftBreakMinutes').value = shift.break_minutes || 0;
  document.getElementById('shiftNotes').value = shift.notes || '';

  updateShiftCostPreview();

  document.getElementById('shiftModal').classList.add('active');
}

function closeShiftModal() {
  document.getElementById('shiftModal').classList.remove('active');
}

// Update cost preview when employee or times change
document.getElementById('shiftEmployee')?.addEventListener('change', updateShiftCostPreview);
document.getElementById('shiftStartTime')?.addEventListener('change', updateShiftCostPreview);
document.getElementById('shiftEndTime')?.addEventListener('change', updateShiftCostPreview);
document.getElementById('shiftBreakMinutes')?.addEventListener('change', updateShiftCostPreview);

function updateShiftCostPreview() {
  const employeeSelect = document.getElementById('shiftEmployee');
  const startTime = document.getElementById('shiftStartTime').value;
  const endTime = document.getElementById('shiftEndTime').value;
  const breakMinutes = parseInt(document.getElementById('shiftBreakMinutes').value) || 0;

  if (!employeeSelect.value || !startTime || !endTime) {
    document.getElementById('shiftCostPreview').style.display = 'none';
    return;
  }

  const selectedOption = employeeSelect.options[employeeSelect.selectedIndex];
  const hourlyWage = parseFloat(selectedOption.dataset.wage) || 0;

  // Calculate hours
  const start = new Date(`2000-01-01T${startTime}`);
  const end = new Date(`2000-01-01T${endTime}`);
  let diffMinutes = (end - start) / (1000 * 60);
  if (diffMinutes < 0) diffMinutes += 24 * 60; // Handle overnight shifts

  const totalHours = (diffMinutes - breakMinutes) / 60;
  const cost = totalHours * hourlyWage;

  document.getElementById('shiftCostAmount').textContent = `$${cost.toFixed(2)}`;
  document.getElementById('shiftCostDetails').textContent = `${totalHours.toFixed(2)} hours √ó $${hourlyWage.toFixed(2)}/hr`;
  document.getElementById('shiftCostPreview').style.display = 'block';
}

async function saveShift(e) {
  e.preventDefault();

  try {
    showLoading('SAVING SHIFT', 'Updating schedule...');

    const shiftId = document.getElementById('shiftId').value;
    const employeeId = document.getElementById('shiftEmployee').value;
    const shiftDate = document.getElementById('shiftDate').value;
    const startTime = document.getElementById('shiftStartTime').value + ':00';
    const endTime = document.getElementById('shiftEndTime').value + ':00';
    const position = document.getElementById('shiftPosition').value;
    const breakMinutes = parseInt(document.getElementById('shiftBreakMinutes').value) || 0;
    const notes = document.getElementById('shiftNotes').value;

    // Get employee wage
    const employee = employees.find(emp => emp.id === employeeId);
    const hourlyWage = employee?.hourly_wage || null;

    const shiftData = {
      employee_id: employeeId,
      shift_date: shiftDate,
      start_time: startTime,
      end_time: endTime,
      position: position,
      break_minutes: breakMinutes,
      hourly_wage: hourlyWage,
      notes: notes,
      updated_at: new Date().toISOString()
    };

    if (shiftId) {
      // Update existing shift
      const { error } = await supabase
        .from('shifts')
        .update(shiftData)
        .eq('id', shiftId);

      if (error) throw error;
    } else {
      // Create new shift
      const { error } = await supabase
        .from('shifts')
        .insert(shiftData);

      if (error) throw error;
    }

    hideLoading();
    closeShiftModal();
    showSuccess(shiftId ? 'Shift updated successfully!' : 'Shift created successfully!');

    // Reload schedule
    await loadWeekSchedule();

  } catch (error) {
    hideLoading();
    console.error('Error saving shift:', error);
    showError(`Failed to save shift: ${error.message}`);
  }
}

// ============================================
// UI HELPERS
// ============================================

function showLoading(title, message) {
  document.getElementById('loadingTitle').textContent = title;
  document.getElementById('loadingMessage').textContent = message;
  document.getElementById('loadingOverlay').classList.add('active');
}

function hideLoading() {
  document.getElementById('loadingOverlay').classList.remove('active');
}

function showSuccess(message) {
  document.getElementById('successMessage').textContent = message;
  document.getElementById('successOverlay').classList.add('active');
  setTimeout(() => {
    document.getElementById('successOverlay').classList.remove('active');
  }, 1500);
}

function showError(message) {
  document.getElementById('errorMessage').textContent = message;
  document.getElementById('errorOverlay').classList.add('active');
}

function hideError() {
  document.getElementById('errorOverlay').classList.remove('active');
}

// ==================== TIPS PER HOUR DISPLAY ====================

    let lastTipsUpdate = null;


async function fetchTipsPerHour() {
  try {
    const response = await fetch('/api/toast-tips-per-hour-today', {
      method: 'POST'
    });

    if (!response.ok) {
      updateTipsPerHourDisplay(null);
      return;
    }

    const result = await response.json();

    if (result.success && result.data) {
          lastTipsUpdate = new Date();

      updateTipsPerHourDisplay(result.data);
          updateLastUpdatedTime();

    } else {
      updateTipsPerHourDisplay(null);
    }
  } catch (error) {
    console.error('Error fetching tips per hour:', error);
    updateTipsPerHourDisplay(null);
  }
}

function updateTipsPerHourDisplay(data) {
  const displayDiv = document.getElementById('tipsPerHourText');
  if (!displayDiv) return;

  if (!data) {
    displayDiv.innerHTML = '';
    return;
  }

  let html = '';

  // Main tips/hr with color and hour-over-hour percentage
  const mainColor = data.trendingUp ? '#059669' : '#dc2626';
  const arrow = data.trendingUp ? '‚Üë' : '‚Üì';

  html += `<div style="color: ${mainColor}; font-weight: 600; margin-bottom: 2px;">`;
  html += `${arrow} $${data.tipsPerHour.toFixed(2)}/hr`;

  // Add hour-over-hour percentage if available
  if (data.percentChangeFromLastHour !== null && data.percentChangeFromLastHour !== undefined) {
    html += ` ${data.percentChangeFromLastHour > 0 ? '+' : ''}${data.percentChangeFromLastHour}% vs. last hour`;
  }

  html += `</div>`;

  // Yesterday comparison (check actual sign of percentChangeFromYesterday)
  if (data.percentChangeFromYesterday !== null) {
    const color = data.percentChangeFromYesterday >= 0 ? '#059669' : '#dc2626';
    const arrow = data.percentChangeFromYesterday >= 0 ? '‚Üë' : '‚Üì';
    html += `<div style="color: ${color}; margin-bottom: 2px;">`;
    html += `${arrow} ${data.percentChangeFromYesterday > 0 ? '+' : ''}${data.percentChangeFromYesterday.toFixed(1)}% vs yesterday`;
    html += `</div>`;
  }

  // Week comparison (check actual sign of percentChangeFromLastWeek)
  if (data.percentChangeFromLastWeek !== null) {
    const color = data.percentChangeFromLastWeek >= 0 ? '#059669' : '#dc2626';
    const arrow = data.percentChangeFromLastWeek >= 0 ? '‚Üë' : '‚Üì';
    html += `<div style="color: ${color}; margin-bottom: 2px;">`;
    html += `${arrow} ${data.percentChangeFromLastWeek > 0 ? '+' : ''}${data.percentChangeFromLastWeek.toFixed(1)}% vs last week`;
    html += `</div>`;
  }

  // Month comparison (check actual sign of percentChangeFromLastMonth)
  if (data.percentChangeFromLastMonth !== null) {
    const color = data.percentChangeFromLastMonth >= 0 ? '#059669' : '#dc2626';
    const arrow = data.percentChangeFromLastMonth >= 0 ? '‚Üë' : '‚Üì';
    html += `<div style="color: ${color};">`;
    html += `${arrow} ${data.percentChangeFromLastMonth > 0 ? '+' : ''}${data.percentChangeFromLastMonth.toFixed(1)}% vs last month`;
    html += `</div>`;
  }

  displayDiv.innerHTML = html;
}

// Auto-refresh tips/hr every 5 minutes
setInterval(fetchTipsPerHour, 5 * 60 * 1000);


    function updateLastUpdatedTime() {
      const lastUpdatedDiv = document.getElementById('tipsLastUpdated');
      if (!lastUpdatedDiv || !lastTipsUpdate) return;

      const now = new Date();
      const diffMs = now - lastTipsUpdate;
      const diffSec = Math.floor(diffMs / 1000);
      const diffMin = Math.floor(diffSec / 60);

      let timeAgo = '';
      if (diffMin < 1) {
        timeAgo = 'Just now';
      } else if (diffMin === 1) {
        timeAgo = '1 minute ago';
      } else if (diffMin < 60) {
        timeAgo = `${diffMin} minutes ago`;
      } else {
        const diffHour = Math.floor(diffMin / 60);
        timeAgo = diffHour === 1 ? '1 hour ago' : `${diffHour} hours ago`;
      }

      lastUpdatedDiv.textContent = `LAST UPDATED: ${timeAgo}`;
    }

    // Update "time ago" display every 30 seconds
    setInterval(updateLastUpdatedTime, 30 * 1000);


// ==================== TOP LEADER DISPLAY ====================

async function fetchTopLeader() {
  try {
    const todayPacific = new Date().toLocaleString('en-US', {
      timeZone: 'America/Los_Angeles',
      year: 'numeric',
      month: '2-digit',
      day: '2-digit'
    });

    const [month, day, year] = todayPacific.split(', ')[0].split('/');
    const today = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;

    // Fetch FOH tasks
    const { data: tasks, error: tasksError } = await supabase
      .from('foh_checklist_tasks')
      .select('completed_by, completed_at, is_completed')
      .eq('is_completed', true)
      .gte('completed_at', `${today}T00:00:00`)
      .lt('completed_at', `${today}T23:59:59`);

    // Fetch prep counts
    const { data: prepCounts, error: prepError } = await supabase
      .from('inventory_items')
      .select('counted_by, counted_at')
      .not('counted_by', 'is', null)
      .not('counted_at', 'is', null)
      .gte('counted_at', `${today}T00:00:00`)
      .lt('counted_at', `${today}T23:59:59`);

    if ((!tasks || tasks.length === 0) && (!prepCounts || prepCounts.length === 0)) {
      updateTopLeaderDisplay(null);
      return;
    }

    const leaderboard = {};

    // Count FOH tasks
    if (tasks && tasks.length > 0) {
      tasks.forEach(task => {
        const name = task.completed_by || 'Unknown';
        if (!leaderboard[name]) {
          leaderboard[name] = { name, count: 0, lastCompleted: null };
        }
        leaderboard[name].count++;
        const completedAt = new Date(task.completed_at);
        if (!leaderboard[name].lastCompleted || completedAt > leaderboard[name].lastCompleted) {
          leaderboard[name].lastCompleted = completedAt;
        }
      });
    }

    // Count prep items
    if (prepCounts && prepCounts.length > 0) {
      prepCounts.forEach(prep => {
        const name = prep.counted_by || 'Unknown';
        if (!leaderboard[name]) {
          leaderboard[name] = { name, count: 0, lastCompleted: null };
        }
        leaderboard[name].count++;
        const countedAt = new Date(prep.counted_at);
        if (!leaderboard[name].lastCompleted || countedAt > leaderboard[name].lastCompleted) {
          leaderboard[name].lastCompleted = countedAt;
        }
      });
    }

    const sortedLeaderboard = Object.values(leaderboard)
      .sort((a, b) => {
        if (b.count !== a.count) return b.count - a.count;
        return b.lastCompleted - a.lastCompleted;
      });

    updateTopLeaderDisplay(sortedLeaderboard[0]);

  } catch (error) {
    console.error('Error fetching top leader:', error);
    updateTopLeaderDisplay(null);
  }
}

function updateTopLeaderDisplay(leader) {
  const displayDiv = document.getElementById('topLeaderText');
  if (!displayDiv) return;

  if (!leader) {
    displayDiv.textContent = 'No tasks completed yet today! üéØ';
    return;
  }

  displayDiv.textContent = `${leader.name} is crushing it with ${leader.count} task${leader.count !== 1 ? 's' : ''}! üî•`;
}

// Fetch on page load and refresh every 2 minutes
fetchTopLeader();
setInterval(fetchTopLeader, 2 * 60 * 1000);

// ==================== END TOP LEADER DISPLAY ====================

// ==================== END TIPS PER HOUR DISPLAY ====================
</script>

</body>
</html>
