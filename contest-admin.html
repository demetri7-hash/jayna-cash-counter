<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contest Admin - Jayna Gyro Teacher's Feast</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #46B0E4 0%, #176F9A 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            text-align: center;
        }

        h1 {
            font-size: 28px;
            color: #176F9A;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-bottom: 10px;
        }

        .quick-links {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }

        .quick-link {
            background: #46B0E4;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .quick-link:hover {
            background: #176F9A;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
        }

        .stat-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .stat-value {
            font-size: 48px;
            font-weight: 700;
            color: #176F9A;
            margin-bottom: 10px;
        }

        .stat-label {
            font-size: 14px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
        }

        .section h2 {
            color: #176F9A;
            font-size: 24px;
            margin-bottom: 20px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .vote-breakdown {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .breakdown-card {
            background: #f0f9ff;
            border: 2px solid #46B0E4;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
        }

        .breakdown-value {
            font-size: 36px;
            font-weight: 700;
            color: #176F9A;
            margin-bottom: 5px;
        }

        .breakdown-label {
            font-size: 14px;
            color: #666;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e0f2fe;
        }

        th {
            background: #f0f9ff;
            color: #176F9A;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 12px;
        }

        tr:hover {
            background: #f9fafb;
        }

        .refresh-btn {
            background: linear-gradient(135deg, #46B0E4 0%, #176F9A 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 14px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }

        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(70, 176, 228, 0.4);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #46B0E4;
        }

        .spinner {
            border: 4px solid #e0f2fe;
            border-top: 4px solid #46B0E4;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-instagram {
            background: #e1bee7;
            color: #6a1b9a;
        }

        .badge-form {
            background: #c5e1a5;
            color: #33691e;
        }

        .btn {
            background: linear-gradient(135deg, #46B0E4 0%, #176F9A 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 14px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(70, 176, 228, 0.4);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: white;
            color: #176F9A;
            border: 2px solid #46B0E4;
        }

        .file-input-wrapper {
            display: inline-block;
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }

        .preview-box {
            background: #f9fafb;
            border: 2px solid #ddd;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
        }

        .preview-item {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 8px;
            font-size: 13px;
        }

        .preview-item.valid {
            border-color: #059669;
            background: #f0fdf4;
        }

        .preview-item.invalid {
            border-color: #dc2626;
            background: #fef2f2;
        }

        .preview-item.duplicate {
            border-color: #f59e0b;
            background: #fffbeb;
        }

        .import-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }

        .import-stat {
            background: #f0f9ff;
            border: 2px solid #46B0E4;
            border-radius: 5px;
            padding: 15px;
            text-align: center;
        }

        .import-stat-value {
            font-size: 28px;
            font-weight: 700;
            color: #176F9A;
        }

        .import-stat-label {
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
        }

        .success-message, .error-message {
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            display: none;
        }

        .success-message {
            background: #d1fae5;
            border: 2px solid #059669;
            color: #065f46;
        }

        .error-message {
            background: #fee2e2;
            border: 2px solid #dc2626;
            color: #991b1b;
        }

        /* Bulk Actions Bar */
        .bulk-actions {
            position: fixed;
            bottom: -100px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            color: white;
            padding: 20px 30px;
            border-radius: 15px 15px 0 0;
            box-shadow: 0 -5px 30px rgba(0,0,0,0.3);
            transition: bottom 0.3s ease;
            z-index: 1000;
            min-width: 800px;
            max-width: 90%;
        }

        .bulk-actions.active {
            bottom: 0;
        }

        .bulk-actions-header {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 15px;
            text-align: center;
        }

        .bulk-actions-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .bulk-actions-buttons .btn {
            margin: 0;
            padding: 10px 20px;
            font-size: 13px;
        }

        .btn-warning {
            background: #f59e0b;
        }

        .btn-warning:hover {
            background: #d97706;
        }

        .btn-success {
            background: #059669;
        }

        .btn-success:hover {
            background: #047857;
        }

        .btn-delete {
            background: #dc2626;
        }

        .btn-delete:hover {
            background: #b91c1c;
        }

        .school-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-content h3 {
            color: #176F9A;
            margin-bottom: 20px;
            font-size: 22px;
        }

        .modal-content input,
        .modal-content select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 15px;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üèÜ Contest Admin Dashboard</h1>
            <p style="color: #666; margin-top: 10px;">Jayna Gyro's Great Teacher's Feast</p>
            <div class="quick-links">
                <a href="/teachers-feast-contest.html" class="quick-link" target="_blank">üìä Public Leaderboard</a>
                <a href="/contest-submissions.html" class="quick-link">üìã View Submissions</a>
                <a href="/contest-scraper-config.html" class="quick-link">‚öôÔ∏è Scraper Config</a>
                <a href="/contest-instagram-handles.html" class="quick-link">üì∏ Instagram Handles</a>
                <a href="/contest-import.html" class="quick-link">üìÅ Import CSV</a>
            </div>
        </div>

        <button class="refresh-btn" onclick="loadData()">üîÑ Refresh Data</button>

        <!-- CSV Import Section -->
        <div class="section">
            <h2>üìÅ Import Instagram Comments (CSV)</h2>
            <p style="margin-bottom: 20px; color: #666;">
                Upload CSV exported from Instagram comments (Chrome extension). Smart duplicate detection using exact timestamps.
            </p>

            <div class="success-message" id="successMessage"></div>
            <div class="error-message" id="errorMessage"></div>

            <div class="file-input-wrapper">
                <button class="btn" onclick="document.getElementById('csvFileInput').click()">üì§ Select CSV File</button>
                <input type="file" id="csvFileInput" accept=".csv" onchange="handleFileSelect(event)">
            </div>
            <span id="fileName" style="margin-left: 15px; color: #666;"></span>

            <div id="previewSection" style="display: none;">
                <div class="import-stats">
                    <div class="import-stat">
                        <div class="import-stat-value" id="statTotal">0</div>
                        <div class="import-stat-label">Total</div>
                    </div>
                    <div class="import-stat">
                        <div class="import-stat-value" id="statValid">0</div>
                        <div class="import-stat-label">Valid</div>
                    </div>
                    <div class="import-stat">
                        <div class="import-stat-value" id="statDuplicates">0</div>
                        <div class="import-stat-label">Duplicates</div>
                    </div>
                    <div class="import-stat">
                        <div class="import-stat-value" id="statInvalid">0</div>
                        <div class="import-stat-label">Invalid</div>
                    </div>
                    <div class="import-stat">
                        <div class="import-stat-value" id="statPoints">0</div>
                        <div class="import-stat-label">Points</div>
                    </div>
                </div>

                <div class="preview-box" id="previewBox"></div>

                <div style="margin-top: 15px;">
                    <button class="btn" onclick="saveVotes()" id="saveBtn">üíæ Save All Votes</button>
                    <button class="btn btn-secondary" onclick="cancelImport()">‚ùå Cancel</button>
                </div>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">üìö</div>
                <div class="stat-value" id="totalSchools">--</div>
                <div class="stat-label">Total Schools</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üó≥Ô∏è</div>
                <div class="stat-value" id="totalVotes">--</div>
                <div class="stat-label">Total Votes</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üì∏</div>
                <div class="stat-value" id="instagramVotes">--</div>
                <div class="stat-label">Instagram Votes</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üìù</div>
                <div class="stat-value" id="formVotes">--</div>
                <div class="stat-label">Form Votes</div>
            </div>
        </div>

        <div class="section">
            <h2>üìä Top 10 Schools</h2>
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Loading data...</p>
            </div>
            <div id="leaderboard" style="display: none;">
                <table>
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>School Name</th>
                            <th>Total Votes</th>
                            <th>Instagram</th>
                            <th>Form</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboardBody"></tbody>
                </table>
            </div>
        </div>

        <div class="section">
            <h2>üìã Recent Votes (Last 20)</h2>
            <div id="recentVotes">
                <table>
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>School</th>
                            <th>Type</th>
                            <th>Points</th>
                            <th>Username/Name</th>
                        </tr>
                    </thead>
                    <tbody id="recentVotesBody"></tbody>
                </table>
            </div>
        </div>

        <!-- Manage Schools Section -->
        <div class="section">
            <h2>üè´ Manage Schools</h2>
            <div style="margin-bottom: 20px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                <label for="sortSelect" style="font-weight: 600; color: #176F9A;">Sort by:</label>
                <select id="sortSelect" onchange="sortSchools(this.value)" style="padding: 8px 12px; border: 2px solid #46B0E4; border-radius: 5px; font-size: 14px;">
                    <option value="votes-desc">Most Votes</option>
                    <option value="votes-asc">Least Votes</option>
                    <option value="name-asc">Alphabetical (A-Z)</option>
                    <option value="name-desc">Alphabetical (Z-A)</option>
                    <option value="date-desc">Date Added (Newest)</option>
                    <option value="date-asc">Date Added (Oldest)</option>
                    <option value="latest-vote">Latest Vote</option>
                </select>
                <span id="schoolCount" style="margin-left: auto; color: #666; font-size: 14px;"></span>
            </div>
            <div id="manageSchools">
                <table>
                    <thead>
                        <tr>
                            <th style="width: 40px;">
                                <input type="checkbox" id="selectAllSchools" class="school-checkbox" onchange="toggleSelectAllSchools()">
                            </th>
                            <th>School Name</th>
                            <th>Total Votes</th>
                            <th>Instagram</th>
                            <th>Form</th>
                            <th>Date Added</th>
                            <th>Latest Vote</th>
                            <th style="width: 150px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="manageSchoolsBody"></tbody>
                </table>
            </div>
        </div>

        <!-- Bulk Actions Bar -->
        <div class="bulk-actions" id="bulkSchoolActions">
            <div class="bulk-actions-header">
                <span id="selectedSchoolCount">0</span> school(s) selected
            </div>
            <div class="bulk-actions-buttons">
                <button class="btn btn-warning" onclick="bulkMergeSchools()">üîÄ Merge Schools</button>
                <button class="btn btn-success" onclick="bulkAddVotes()">‚ûï Add Votes</button>
                <button class="btn btn-warning" onclick="bulkReduceVotes()">‚ûñ Reduce Votes</button>
                <button class="btn btn-warning" onclick="bulkTransferVotes()">‚ÜóÔ∏è Transfer Votes</button>
                <button class="btn btn-delete" onclick="bulkDeleteSchools()">üóëÔ∏è Delete Schools</button>
                <button class="btn btn-secondary" onclick="clearSchoolSelection()">‚úï Clear</button>
            </div>
        </div>

        <!-- Modal Container -->
        <div class="modal" id="schoolModal"></div>
    </div>

    <script>
        let allSchools = []; // Store all schools for sorting
        let selectedSchools = new Set(); // Track selected schools

        async function loadData() {
            try {
                document.getElementById('loading').style.display = 'block';
                document.getElementById('leaderboard').style.display = 'none';

                // Load stats
                const statsResponse = await fetch('/api/teacher-feast-leaderboard');
                const statsData = await statsResponse.json();

                if (statsData.success) {
                    displayLeaderboard(statsData.schools);
                }

                // Load totals (aggregate from database)
                await loadTotalStats();
                await loadRecentVotes();
                await loadAllSchools(); // Load all schools for manage section

                document.getElementById('loading').style.display = 'none';
                document.getElementById('leaderboard').style.display = 'block';

            } catch (error) {
                console.error('Error loading data:', error);
                alert('Error loading data. Please check console.');
            }
        }

        async function loadTotalStats() {
            // For now, calculate from leaderboard data
            // In production, you'd create a dedicated stats API endpoint
            const response = await fetch('/api/teacher-feast-leaderboard');
            const data = await response.json();

            if (data.success) {
                const schools = data.schools;
                const totalVotes = schools.reduce((sum, s) => sum + (s.total_votes || 0), 0);
                const instagramVotes = schools.reduce((sum, s) => sum + (s.instagram_votes || 0), 0);
                const formVotes = schools.reduce((sum, s) => sum + (s.form_votes || 0), 0);

                document.getElementById('totalSchools').textContent = schools.length;
                document.getElementById('totalVotes').textContent = totalVotes;
                document.getElementById('instagramVotes').textContent = instagramVotes;
                document.getElementById('formVotes').textContent = formVotes;
            }
        }

        async function loadRecentVotes() {
            // This would require a new API endpoint in production
            // For now, show placeholder
            const tbody = document.getElementById('recentVotesBody');
            tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #666;">Recent votes tracking coming soon</td></tr>';
        }

        function displayLeaderboard(schools) {
            const tbody = document.getElementById('leaderboardBody');
            tbody.innerHTML = '';

            schools.forEach((school, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>#${index + 1}</strong></td>
                    <td>${school.school_name}</td>
                    <td><strong>${school.total_votes || 0}</strong></td>
                    <td>${school.instagram_votes || 0}</td>
                    <td>${school.form_votes || 0}</td>
                `;
                tbody.appendChild(row);
            });
        }

        async function loadAllSchools() {
            try {
                const response = await fetch('/api/teacher-feast-schools');
                const data = await response.json();

                if (data.success) {
                    allSchools = data.schools;

                    // Default sort: most votes
                    sortSchools('votes-desc');
                }
            } catch (error) {
                console.error('Error loading all schools:', error);
            }
        }

        function sortSchools(sortBy) {
            if (!allSchools || allSchools.length === 0) return;

            let sorted = [...allSchools];

            switch(sortBy) {
                case 'votes-desc':
                    sorted.sort((a, b) => (b.total_votes || 0) - (a.total_votes || 0));
                    break;
                case 'votes-asc':
                    sorted.sort((a, b) => (a.total_votes || 0) - (b.total_votes || 0));
                    break;
                case 'name-asc':
                    sorted.sort((a, b) => a.school_name.localeCompare(b.school_name));
                    break;
                case 'name-desc':
                    sorted.sort((a, b) => b.school_name.localeCompare(a.school_name));
                    break;
                case 'date-desc':
                    sorted.sort((a, b) => {
                        if (!a.created_at) return 1;
                        if (!b.created_at) return -1;
                        return new Date(b.created_at) - new Date(a.created_at);
                    });
                    break;
                case 'date-asc':
                    sorted.sort((a, b) => {
                        if (!a.created_at) return 1;
                        if (!b.created_at) return -1;
                        return new Date(a.created_at) - new Date(b.created_at);
                    });
                    break;
                case 'latest-vote':
                    sorted.sort((a, b) => {
                        if (!a.latest_vote) return 1;
                        if (!b.latest_vote) return -1;
                        return new Date(b.latest_vote) - new Date(a.latest_vote);
                    });
                    break;
            }

            displayManageSchools(sorted);
        }

        function displayManageSchools(schools) {
            const tbody = document.getElementById('manageSchoolsBody');
            tbody.innerHTML = '';

            document.getElementById('schoolCount').textContent = `${schools.length} school${schools.length !== 1 ? 's' : ''}`;

            schools.forEach((school) => {
                const row = document.createElement('tr');

                // Format dates
                const dateAdded = school.created_at
                    ? new Date(school.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })
                    : 'Unknown';

                const latestVote = school.latest_vote
                    ? new Date(school.latest_vote).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric', hour: 'numeric', minute: '2-digit' })
                    : 'No votes yet';

                // Checkbox cell
                const checkboxCell = document.createElement('td');
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'school-checkbox';
                checkbox.checked = selectedSchools.has(school.school_name);
                checkbox.onchange = () => toggleSchoolSelection(school.school_name);
                checkboxCell.appendChild(checkbox);
                row.appendChild(checkboxCell);

                // School name
                const nameCell = document.createElement('td');
                nameCell.innerHTML = `<strong>${school.school_name}</strong>`;
                row.appendChild(nameCell);

                // Total votes
                const votesCell = document.createElement('td');
                votesCell.innerHTML = `<strong>${school.total_votes || 0}</strong>`;
                row.appendChild(votesCell);

                // Instagram votes
                const igCell = document.createElement('td');
                igCell.textContent = school.instagram_votes || 0;
                row.appendChild(igCell);

                // Form votes
                const formCell = document.createElement('td');
                formCell.textContent = school.form_votes || 0;
                row.appendChild(formCell);

                // Date added
                const dateCell = document.createElement('td');
                dateCell.style.cssText = 'font-size: 12px; color: #666;';
                dateCell.textContent = dateAdded;
                row.appendChild(dateCell);

                // Latest vote
                const latestCell = document.createElement('td');
                latestCell.style.cssText = 'font-size: 12px; color: #666;';
                latestCell.textContent = latestVote;
                row.appendChild(latestCell);

                // Actions cell
                const actionsCell = document.createElement('td');
                actionsCell.style.cssText = 'display: flex; gap: 5px; align-items: center;';

                // Edit button
                const editBtn = document.createElement('button');
                editBtn.className = 'btn btn-warning';
                editBtn.style.cssText = 'padding: 6px 12px; font-size: 11px;';
                editBtn.textContent = '‚úèÔ∏è';
                editBtn.title = 'Edit School';
                editBtn.onclick = () => editSchool(school);
                actionsCell.appendChild(editBtn);

                // Delete button
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn btn-delete';
                deleteBtn.style.cssText = 'padding: 6px 12px; font-size: 11px;';
                deleteBtn.textContent = 'üóëÔ∏è';
                deleteBtn.title = 'Delete School';
                deleteBtn.onclick = () => deleteSchool(school);
                actionsCell.appendChild(deleteBtn);

                row.appendChild(actionsCell);
                tbody.appendChild(row);
            });
        }

        // Selection Management
        window.toggleSchoolSelection = function(schoolName) {
            if (selectedSchools.has(schoolName)) {
                selectedSchools.delete(schoolName);
            } else {
                selectedSchools.add(schoolName);
            }
            updateBulkActionsBar();
            displayManageSchools(allSchools); // Refresh to update checkboxes
        };

        window.toggleSelectAllSchools = function() {
            const selectAllCheckbox = document.getElementById('selectAllSchools');
            if (selectAllCheckbox.checked) {
                allSchools.forEach(school => selectedSchools.add(school.school_name));
            } else {
                selectedSchools.clear();
            }
            updateBulkActionsBar();
            displayManageSchools(allSchools);
        };

        window.clearSchoolSelection = function() {
            selectedSchools.clear();
            document.getElementById('selectAllSchools').checked = false;
            updateBulkActionsBar();
            displayManageSchools(allSchools);
        };

        function updateBulkActionsBar() {
            const bulkActions = document.getElementById('bulkSchoolActions');
            const selectedCount = document.getElementById('selectedSchoolCount');

            selectedCount.textContent = selectedSchools.size;

            if (selectedSchools.size > 0) {
                bulkActions.classList.add('active');
            } else {
                bulkActions.classList.remove('active');
            }
        }

        // Bulk Operations
        window.bulkMergeSchools = async function() {
            if (selectedSchools.size < 2) {
                alert('Please select at least 2 schools to merge');
                return;
            }

            const selectedList = allSchools.filter(s => selectedSchools.has(s.school_name));

            // Show merge modal
            showModal(`
                <h3>üîÄ Merge ${selectedSchools.size} Schools</h3>
                <p style="margin-bottom: 15px; color: #666;">Select which school to keep (all others will be merged into it):</p>
                ${selectedList.map(school => `
                    <div style="margin-bottom: 10px;">
                        <label style="display: flex; align-items: center; gap: 10px; padding: 10px; border: 2px solid #ddd; border-radius: 8px; cursor: pointer;">
                            <input type="radio" name="targetSchool" value="${school.school_name}">
                            <div>
                                <strong>${school.school_name}</strong><br>
                                <span style="font-size: 12px; color: #666;">${school.total_votes || 0} votes (${school.instagram_votes || 0} IG + ${school.form_votes || 0} Form)</span>
                            </div>
                        </label>
                    </div>
                `).join('')}
                <div class="modal-buttons">
                    <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button class="btn btn-warning" onclick="confirmMerge()">Merge Schools</button>
                </div>
            `);
        };

        window.confirmMerge = async function() {
            const targetRadio = document.querySelector('input[name="targetSchool"]:checked');
            if (!targetRadio) {
                alert('Please select which school to keep');
                return;
            }

            const targetSchool = targetRadio.value;
            const schoolsToMerge = Array.from(selectedSchools).filter(s => s !== targetSchool);

            if (!confirm(`FINAL CONFIRMATION:\n\nMerge ${schoolsToMerge.length} school(s) into "${targetSchool}"?\n\nSchools to be deleted:\n${schoolsToMerge.map(s => '‚Ä¢ ' + s).join('\n')}\n\nThis CANNOT be undone.`)) {
                return;
            }

            closeModal();

            // Merge logic (implement with Supabase)
            alert('Merge functionality will be implemented with Supabase integration');
            // TODO: Transfer all votes, update vote counts, delete merged schools
        };

        window.bulkAddVotes = function() {
            if (selectedSchools.size === 0) {
                alert('Please select at least one school');
                return;
            }

            showModal(`
                <h3>‚ûï Add Manual Votes</h3>
                <p style="margin-bottom: 15px; color: #666;">Adding votes to ${selectedSchools.size} school(s)</p>
                <label style="display: block; margin-bottom: 8px; font-weight: 700;">Number of votes to add:</label>
                <input type="number" id="voteCount" min="1" value="1" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px;">
                <label style="display: block; margin-top: 15px; margin-bottom: 8px; font-weight: 700;">Vote type:</label>
                <select id="voteType" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px;">
                    <option value="instagram">Instagram (1 point each)</option>
                    <option value="form">Form (2 points each)</option>
                </select>
                <div class="modal-buttons">
                    <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button class="btn btn-success" onclick="confirmAddVotes()">Add Votes</button>
                </div>
            `);
        };

        window.confirmAddVotes = function() {
            const count = parseInt(document.getElementById('voteCount').value);
            const type = document.getElementById('voteType').value;

            if (!count || count < 1) {
                alert('Please enter a valid number');
                return;
            }

            closeModal();
            alert(`Will add ${count} ${type} vote(s) to ${selectedSchools.size} school(s)`);
            // TODO: Implement with Supabase
        };

        window.bulkReduceVotes = function() {
            if (selectedSchools.size === 0) {
                alert('Please select at least one school');
                return;
            }

            showModal(`
                <h3>‚ûñ Reduce Votes</h3>
                <p style="margin-bottom: 15px; color: #666;">Reducing votes from ${selectedSchools.size} school(s)</p>
                <label style="display: block; margin-bottom: 8px; font-weight: 700;">Number of votes to reduce:</label>
                <input type="number" id="reduceCount" min="1" value="1">
                <div class="modal-buttons">
                    <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button class="btn btn-warning" onclick="confirmReduceVotes()">Reduce Votes</button>
                </div>
            `);
        };

        window.confirmReduceVotes = function() {
            const count = parseInt(document.getElementById('reduceCount').value);
            if (!count || count < 1) {
                alert('Please enter a valid number');
                return;
            }

            closeModal();
            alert(`Will reduce ${count} vote(s) from ${selectedSchools.size} school(s)`);
            // TODO: Implement with Supabase
        };

        window.bulkTransferVotes = function() {
            if (selectedSchools.size === 0) {
                alert('Please select at least one school to transfer votes FROM');
                return;
            }

            // Get schools not selected
            const availableSchools = allSchools.filter(s => !selectedSchools.has(s.school_name));

            showModal(`
                <h3>‚ÜóÔ∏è Transfer Votes</h3>
                <p style="margin-bottom: 15px; color: #666;">Transfer ALL votes from ${selectedSchools.size} school(s) to another school</p>
                <label style="display: block; margin-bottom: 8px; font-weight: 700;">Transfer TO:</label>
                <select id="targetSchool" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px;">
                    <option value="">-- Select School --</option>
                    ${availableSchools.map(s => `<option value="${s.school_name}">${s.school_name} (${s.total_votes || 0} votes)</option>`).join('')}
                </select>
                <div class="modal-buttons">
                    <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button class="btn btn-warning" onclick="confirmTransferVotes()">Transfer</button>
                </div>
            `);
        };

        window.confirmTransferVotes = function() {
            const target = document.getElementById('targetSchool').value;
            if (!target) {
                alert('Please select a target school');
                return;
            }

            closeModal();
            alert(`Will transfer all votes to: ${target}`);
            // TODO: Implement with Supabase
        };

        window.bulkDeleteSchools = function() {
            if (selectedSchools.size === 0) {
                alert('Please select at least one school');
                return;
            }

            if (!confirm(`‚ö†Ô∏è WARNING:\n\nDelete ${selectedSchools.size} school(s) and ALL their votes?\n\nThis CANNOT be undone.`)) {
                return;
            }

            alert(`Will delete ${selectedSchools.size} school(s)`);
            // TODO: Implement with Supabase
        };

        // Individual Actions
        window.editSchool = function(school) {
            showModal(`
                <h3>‚úèÔ∏è Edit School: ${school.school_name}</h3>
                <label style="display: block; margin-bottom: 8px; font-weight: 700;">School Name:</label>
                <input type="text" id="editSchoolName" value="${school.school_name}">
                <label style="display: block; margin-top: 15px; margin-bottom: 8px; font-weight: 700;">Instagram Handles (comma-separated):</label>
                <input type="text" id="editHandles" value="${(school.instagram_handles || []).join(', ')}">
                <div class="modal-buttons">
                    <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button class="btn btn-success" onclick="confirmEditSchool('${school.school_name}')">Save Changes</button>
                </div>
            `);
        };

        window.confirmEditSchool = function(originalName) {
            const newName = document.getElementById('editSchoolName').value.trim();
            const handles = document.getElementById('editHandles').value.trim();

            if (!newName) {
                alert('School name cannot be empty');
                return;
            }

            closeModal();
            alert(`Will update: ${originalName} ‚Üí ${newName}`);
            // TODO: Implement with Supabase
        };

        window.deleteSchool = function(school) {
            if (!confirm(`‚ö†Ô∏è Delete "${school.school_name}" and all its ${school.total_votes || 0} votes?\n\nThis CANNOT be undone.`)) {
                return;
            }

            alert(`Will delete: ${school.school_name}`);
            // TODO: Implement with Supabase
        };

        // Modal Helpers
        function showModal(html) {
            const modal = document.getElementById('schoolModal');
            modal.innerHTML = `<div class="modal-content">${html}</div>`;
            modal.classList.add('active');
        }

        function closeModal() {
            const modal = document.getElementById('schoolModal');
            modal.classList.remove('active');
            modal.innerHTML = '';
        }

        window.closeModal = closeModal;

        // Load data on page load
        loadData();

        // Auto-refresh every 60 seconds
        setInterval(loadData, 60000);
    </script>

    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

        const supabase = createClient(
            'https://gaawtbqpnnbbnsyswqwv.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdhYXd0YnFwbm5iYm5zeXN3cXd2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1MDE1NTAsImV4cCI6MjA3MjA3NzU1MH0.F-y7AIQTWaUe7DRT4OnIZVn94mhXxfhpBbng2aJ8nXg'
        );

        let validSchools = [];
        let existingVotes = [];
        let parsedVotes = [];

        // Load schools and existing votes
        async function loadSchoolsAndVotes() {
            try {
                // Load valid schools
                const { data: schools, error: schoolsError } = await supabase
                    .from('teacher_feast_schools')
                    .select('school_name, instagram_handles');

                if (schoolsError) throw schoolsError;
                validSchools = schools;

                // Load existing votes for duplicate detection
                const { data: votes, error: votesError } = await supabase
                    .from('teacher_feast_votes')
                    .select('instagram_comment_id, school_name, instagram_username, vote_type, voted_at');

                if (votesError) throw votesError;
                existingVotes = votes;

                console.log(`‚úÖ Loaded ${validSchools.length} schools and ${existingVotes.length} existing votes`);

            } catch (error) {
                console.error('Error loading data:', error);
                showError('Failed to load school data: ' + error.message);
            }
        }

        window.handleFileSelect = async function(event) {
            const file = event.target.files[0];
            if (!file) return;

            document.getElementById('fileName').textContent = file.name;

            // Load schools and votes if not already loaded
            if (validSchools.length === 0) {
                await loadSchoolsAndVotes();
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const csv = e.target.result;
                parseCSV(csv);
            };
            reader.readAsText(file);
        };

        function parseCSV(csv) {
            const lines = csv.split('\n');
            const headers = lines[0].split(',');

            parsedVotes = [];

            // CSV format: User Name,UID,Profile URL,Content,Published,URL
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;

                const values = parseCSVLine(line);
                if (values.length < 6) continue;

                const username = values[0];
                const content = values[3];
                const published = values[4]; // Format: 2025/11/24 09:14:38

                if (!content) continue;

                // Extract school tags
                const tags = extractSchoolTags(content);

                for (const tag of tags) {
                    const matchedSchool = matchSchoolName(tag);

                    if (matchedSchool) {
                        const vote = {
                            username: username,
                            content: content,
                            tag: tag,
                            matched_school: matchedSchool,
                            published: parsePublishedDate(published),
                            points: 1,
                            vote_type: 'instagram',
                            is_duplicate: false,
                            is_valid: true
                        };

                        // Check for duplicates using 12-hour tolerance
                        if (isDuplicate(content, matchedSchool, vote.published, username)) {
                            vote.is_duplicate = true;
                            vote.is_valid = false;
                        }

                        parsedVotes.push(vote);
                    } else {
                        // Invalid tag
                        parsedVotes.push({
                            username: username,
                            content: content,
                            tag: tag,
                            matched_school: null,
                            published: parsePublishedDate(published),
                            points: 0,
                            vote_type: 'instagram',
                            is_duplicate: false,
                            is_valid: false
                        });
                    }
                }
            }

            displayPreview();
        }

        function parseCSVLine(line) {
            const values = [];
            let current = '';
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];

                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    values.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }

            values.push(current.trim());
            return values;
        }

        function parsePublishedDate(dateString) {
            // Format: 2025/11/24 09:14:38
            // Convert to ISO: 2025-11-24T09:14:38
            const cleaned = dateString.replace(/\//g, '-').replace(' ', 'T');
            return new Date(cleaned).toISOString();
        }

        function extractSchoolTags(text) {
            const tags = [];

            // Remove URLs and emojis
            const cleanText = text
                .replace(/https?:\/\/[^\s]+/g, '')
                .replace(/[\u{1F600}-\u{1F64F}]/gu, '');

            // Extract @handles and #hashtags
            const tagPattern = /[@#]([a-zA-Z0-9_]+)/g;
            let match;

            while ((match = tagPattern.exec(cleanText)) !== null) {
                const tag = match[1].trim();
                if (tag.length > 2) {
                    tags.push(tag.toLowerCase());
                }
            }

            // Also check for plain school names
            const lowerText = cleanText.toLowerCase();
            for (const school of validSchools) {
                const schoolLower = school.school_name.toLowerCase();
                if (lowerText.includes(schoolLower)) {
                    tags.push(schoolLower);
                }
            }

            return [...new Set(tags)];
        }

        function matchSchoolName(tag) {
            const tagLower = tag.toLowerCase().replace(/[^a-z0-9]/g, '');

            // Priority 1: Instagram handle exact match
            for (const school of validSchools) {
                if (school.instagram_handles && Array.isArray(school.instagram_handles)) {
                    for (const handle of school.instagram_handles) {
                        const cleanHandle = handle.replace('@', '').toLowerCase().replace(/[^a-z0-9]/g, '');
                        if (cleanHandle === tagLower) {
                            return school.school_name;
                        }
                    }
                }
            }

            // Priority 2: Exact school name match
            for (const school of validSchools) {
                const schoolClean = school.school_name.toLowerCase().replace(/[^a-z0-9]/g, '');
                if (schoolClean === tagLower) {
                    return school.school_name;
                }
            }

            // Priority 3: Fuzzy match
            for (const school of validSchools) {
                const schoolClean = school.school_name.toLowerCase().replace(/[^a-z0-9]/g, '');
                const tagCleaned = tagLower.replace(/high|middle|elementary|school/g, '');
                const schoolCleaned = schoolClean.replace(/high|middle|elementary|school/g, '');

                if (tagCleaned.length > 3 && schoolCleaned.length > 3) {
                    if (tagCleaned.includes(schoolCleaned) || schoolCleaned.includes(tagCleaned)) {
                        return school.school_name;
                    }
                }
            }

            return null;
        }

        function isDuplicate(commentText, schoolName, timestamp, username) {
            // 12-hour tolerance window for duplicate detection
            // Uses username + school + timestamp (since comment_text not stored in DB)
            const commentTime = new Date(timestamp);
            const TOLERANCE_MS = 12 * 60 * 60 * 1000; // 12 hours

            return existingVotes.some(vote => {
                // Must match: same username + same school
                if (vote.instagram_username !== username || vote.school_name !== schoolName) {
                    return false;
                }

                // Check timestamp tolerance
                if (vote.voted_at) {
                    const existingTime = new Date(vote.voted_at);
                    const timeDiff = Math.abs(commentTime - existingTime);

                    // If same user voted for same school within 12 hours, it's a duplicate
                    if (timeDiff <= TOLERANCE_MS) {
                        return true;
                    }
                }

                return false;
            });
        }

        function displayPreview() {
            const validVotes = parsedVotes.filter(v => v.is_valid && !v.is_duplicate);
            const duplicateVotes = parsedVotes.filter(v => v.is_duplicate);
            const invalidVotes = parsedVotes.filter(v => !v.is_valid && !v.is_duplicate);

            const totalPoints = validVotes.reduce((sum, v) => sum + v.points, 0);

            // Update stats
            document.getElementById('statTotal').textContent = parsedVotes.length;
            document.getElementById('statValid').textContent = validVotes.length;
            document.getElementById('statDuplicates').textContent = duplicateVotes.length;
            document.getElementById('statInvalid').textContent = invalidVotes.length;
            document.getElementById('statPoints').textContent = totalPoints;

            // Display preview items
            const previewBox = document.getElementById('previewBox');
            previewBox.innerHTML = '';

            // Show valid votes
            for (const vote of validVotes.slice(0, 20)) {
                previewBox.appendChild(createPreviewItem(vote, 'valid', '‚úÖ'));
            }

            // Show duplicates
            for (const vote of duplicateVotes.slice(0, 10)) {
                previewBox.appendChild(createPreviewItem(vote, 'duplicate', '‚ö†Ô∏è'));
            }

            // Show invalid
            for (const vote of invalidVotes.slice(0, 10)) {
                previewBox.appendChild(createPreviewItem(vote, 'invalid', '‚ùå'));
            }

            if (parsedVotes.length > 40) {
                const moreDiv = document.createElement('div');
                moreDiv.style.cssText = 'text-align: center; padding: 10px; color: #666;';
                moreDiv.textContent = `... and ${parsedVotes.length - 40} more items`;
                previewBox.appendChild(moreDiv);
            }

            document.getElementById('previewSection').style.display = 'block';
        }

        function createPreviewItem(vote, cssClass, icon) {
            const item = document.createElement('div');
            item.className = `preview-item ${cssClass}`;

            let html = `<strong>${icon} ${vote.username}:</strong> ${vote.content.substring(0, 60)}...<br>`;
            html += `<span style="color: #666;">Tag: ${vote.tag} ‚Üí </span>`;

            if (vote.is_duplicate) {
                html += `<span style="color: #f59e0b; font-weight: 600;">DUPLICATE (${vote.matched_school})</span>`;
            } else if (vote.matched_school) {
                html += `<span style="color: #059669; font-weight: 600;">${vote.matched_school} (+1 pt)</span>`;
            } else {
                html += `<span style="color: #dc2626; font-weight: 600;">No match</span>`;
            }

            item.innerHTML = html;
            return item;
        }

        window.saveVotes = async function() {
            // Include ALL votes (both valid and invalid - we'll auto-create schools)
            const votesToSave = parsedVotes.filter(v => !v.is_duplicate);

            if (votesToSave.length === 0) {
                showError('No votes to save! All are duplicates.');
                return;
            }

            document.getElementById('saveBtn').disabled = true;
            document.getElementById('saveBtn').textContent = 'Saving...';

            try {
                let successCount = 0;
                let errorCount = 0;
                let newSchoolsCreated = 0;

                for (const vote of votesToSave) {
                    // If no matched school, auto-create it from the tag
                    let schoolName = vote.matched_school;

                    if (!schoolName) {
                        // Extract school name from tag
                        schoolName = extractSchoolNameFromTag(vote.tag);

                        // Create new school in database
                        console.log(`üÜï Creating new school: ${schoolName} (from tag: ${vote.tag})`);

                        const { error: schoolError } = await supabase
                            .from('teacher_feast_schools')
                            .insert([{
                                school_name: schoolName,
                                instagram_handles: [`@${vote.tag.toLowerCase()}`],
                                total_votes: 0,
                                instagram_votes: 0,
                                form_votes: 0
                            }]);

                        if (schoolError) {
                            // School might already exist, that's okay
                            console.log(`School already exists or error: ${schoolError.message}`);
                        } else {
                            newSchoolsCreated++;
                        }
                    }

                    // Insert vote with actual published timestamp
                    const { error: voteError } = await supabase
                        .from('teacher_feast_votes')
                        .insert([{
                            school_name: schoolName,
                            vote_type: vote.vote_type,
                            points: vote.points,
                            instagram_username: vote.username,
                            voted_at: vote.published
                        }]);

                    if (voteError) {
                        console.error('Vote insert error:', voteError);
                        errorCount++;
                        continue;
                    }

                    // Increment school votes
                    await supabase.rpc('increment_school_votes', {
                        school_name_param: schoolName,
                        points_param: vote.points
                    });

                    successCount++;
                }

                let successMsg = `‚úÖ Successfully saved ${successCount} votes!`;
                if (newSchoolsCreated > 0) {
                    successMsg += ` (${newSchoolsCreated} new schools created)`;
                }
                if (errorCount > 0) {
                    successMsg += ` (${errorCount} errors)`;
                }

                showSuccess(successMsg);

                // Clear form and refresh
                document.getElementById('csvFileInput').value = '';
                document.getElementById('fileName').textContent = '';
                parsedVotes = [];
                document.getElementById('previewSection').style.display = 'none';

                // Reload votes for next import
                await loadSchoolsAndVotes();

                // Refresh dashboard stats
                loadData();

            } catch (error) {
                console.error('Save error:', error);
                showError('Failed to save votes: ' + error.message);
            } finally {
                document.getElementById('saveBtn').disabled = false;
                document.getElementById('saveBtn').textContent = 'üíæ Save All Votes';
            }
        };

        // Helper function to extract school name from Instagram tag
        function extractSchoolNameFromTag(tag) {
            // Remove special characters and convert to Title Case
            let schoolName = tag
                .replace(/[@#]/g, '')
                .replace(/elementary|middle|high|school|charter/gi, '')
                .trim();

            // Convert camelCase or underscores to spaces
            schoolName = schoolName
                .replace(/([a-z])([A-Z])/g, '$1 $2') // camelCase
                .replace(/_/g, ' '); // underscores

            // Title case each word
            schoolName = schoolName
                .split(' ')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
                .join(' ');

            // Add "Elementary School" suffix if appropriate
            const lowerTag = tag.toLowerCase();
            if (lowerTag.includes('elementary')) {
                schoolName += ' Elementary School';
            } else if (lowerTag.includes('middle')) {
                schoolName += ' Middle School';
            } else if (lowerTag.includes('high')) {
                schoolName += ' High School';
            } else if (lowerTag.includes('charter')) {
                schoolName += ' Charter School';
            } else {
                // Default to Elementary School
                schoolName += ' Elementary School';
            }

            return schoolName;
        }

        window.cancelImport = function() {
            document.getElementById('csvFileInput').value = '';
            document.getElementById('fileName').textContent = '';
            parsedVotes = [];
            document.getElementById('previewSection').style.display = 'none';
        };

        function showSuccess(message) {
            const el = document.getElementById('successMessage');
            el.textContent = message;
            el.style.display = 'block';
            setTimeout(() => { el.style.display = 'none'; }, 5000);
        }

        function showError(message) {
            const el = document.getElementById('errorMessage');
            el.textContent = message;
            el.style.display = 'block';
            setTimeout(() => { el.style.display = 'none'; }, 5000);
        }

        // Load schools and votes on page load
        loadSchoolsAndVotes();
    </script>
</body>
</html>
