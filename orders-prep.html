<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, viewport-fit=cover">
  <title>Jayna Gyro Cash Counter</title>
  
  <link rel="apple-touch-icon" href="https://static.spotapps.co/website_images/ab_websites/229800_website_v1/logo.png">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#00A8E1">
  
  <style>
    /* Jayna Brand Design - Sky Blue & Grayscale */
    :root {
      --primary-blue: #00A8E1;
      --secondary-blue: #0094D6;
      --light-blue: #E3F4FC;
      --accent-blue: #0081C6;
      --gray-900: #212121;
      --gray-700: #424242;
      --gray-600: #616161;
      --gray-500: #757575;
      --gray-400: #BDBDBD;
      --gray-300: #E0E0E0;
      --gray-100: #F5F5F5;
      --success: #00C853;
      --warning: #FFB300;
      --error: #D32F2F;
      --white: #FFFFFF;
      --blue-bg: #dbeafe;
      --blue-text: #1e40af;
      --success-bg: #d1fae5;
      --success-text: #065f46;
      --success-border: #059669;
      --warning-bg: #fef3c7;
      --warning-text: #92400e;
      --warning-border: #f59e0b;
      --error-bg: #fee2e2;
      --error-text: #991b1b;
      --error-border: #dc2626;
    }

    /* Pen Icon Edit Button */
    .modal-edit-icon {
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s ease;
    }
    .modal-edit-icon:hover {
      background: var(--gray-200);
    }
    .modal-edit-icon svg {
      width: 18px;
      height: 18px;
      fill: var(--gray-700);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body {
      font-family: 'Aptos', 'Segoe UI Variable', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      background: var(--white); /* White background to blend with Google Sites header */
      min-height: 100vh;
      padding: 0;
      overflow-x: hidden;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
      background: var(--white);
      border-radius: 0;
      overflow: visible;
      box-shadow: none; /* Remove shadow for seamless Google Sites embed */
      min-height: auto;
      max-height: none;
    }
    .header {
      background: var(--white);
      color: var(--gray-900);
      text-align: center;
      padding: 12px;
      border-radius: 0;
      border-bottom: 1px solid var(--gray-300);
    }
    .header h1 { font-size: 18px; font-weight: 700; margin-bottom: 2px; letter-spacing: 1.5px; text-transform: uppercase; }
    .header p { opacity: 0.7; font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }
    /* Mobile-First Responsive Design */
    .content {
      padding: 12px;
      /* Google Sites full page embed optimization */
      max-height: none;
      overflow: visible;
    }
    .main-menu { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-bottom: 12px; }
    .secondary-links { display: flex; flex-wrap: wrap; gap: 12px; justify-content: center; margin-bottom: 20px; font-size: 11px; }
    .secondary-links a { color: var(--gray-700); text-decoration: underline; cursor: pointer; transition: color 0.15s ease; }
    .secondary-links a:hover { color: var(--gray-900); }
    .menu-btn {
      padding: 16px 12px !important;
      border: 2px solid var(--gray-700) !important;
      border-radius: 0 !important;
      background: var(--gray-700) !important;
      font-size: 11px !important;
      font-weight: 700 !important;
      color: white !important;
      cursor: pointer !important;
      transition: all 0.15s ease !important;
      text-align: center !important;
      min-height: 50px !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      text-transform: uppercase !important;
      letter-spacing: 1.2px !important;
      text-decoration: none !important;
    }
    .menu-btn:hover {
      background: var(--gray-600) !important;
      border-color: var(--gray-600) !important;
      transform: translateY(-1px);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
    }
    .menu-btn.active {
      border-color: var(--gray-600) !important;
      background: var(--gray-600) !important;
      transform: translateY(-1px);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
    }
    .menu-btn.primary {
      background: var(--gray-100) !important;
      color: var(--gray-900) !important;
      border: 2px solid var(--gray-300) !important;
    }
    .menu-btn.primary:hover {
      background: var(--gray-200) !important;
      border-color: var(--gray-400) !important;
    }
    .form-section { 
      display: none; 
      /* Ensure sections don't get cut off */
      min-height: auto;
      overflow: visible;
    }
    .form-section.active {
      display: block;
      /* Force visibility in Google Sites */
      position: relative;
      z-index: 1;
    }
    .form-group { margin-bottom: 12px; }
    .form-group label {
      display: block;
      margin-bottom: 4px;
      font-weight: 700;
      font-size: 10px;
      color: var(--gray-700);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    /* Enhanced Mobile-Friendly Inputs */
    .form-input, .form-select {
      width: 100%;
      padding: 12px 14px;
      border: 1px solid var(--gray-300);
      border-radius: 0;
      font-size: 14px;
      min-height: 44px;
      box-sizing: border-box;
      -webkit-appearance: none;
      appearance: none;
      transition: all 0.15s ease;
      background: var(--white);
      color: var(--gray-900);
    }
    .form-input:focus, .form-select:focus {
      outline: none;
      border-color: var(--primary-blue);
      box-shadow: 0 0 0 2px rgba(0, 217, 217, 0.15);
      background: var(--white);
    }
    
    /* Number inputs with mobile optimization */
    input[type="number"] {
      -webkit-appearance: none;
      -moz-appearance: textfield;
      appearance: none;
      /* Remove number input arrows */
    }
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    input, select, textarea, button {
      font-size: 16px !important;
    }

    .drawer-section {
      margin: 20px 0;
      border: 2px solid var(--gray-300);
      border-radius: 0;
      overflow: hidden;
    }
    .drawer-header {
      background: var(--light-blue);
      padding: 15px 20px;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 15px;
      color: var(--primary-blue);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .skip-toggle {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 16px;
      color: var(--gray-500);
    }
    .skip-toggle input[type="checkbox"] { width: 20px; height: 20px; }
    .drawer-content { padding: 20px; }
    .denom-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 0;
      border-bottom: 1px solid var(--gray-300);
    }
    .denom-row:last-child { border-bottom: none; }
    .denom-label { font-weight: 500; font-size: 18px; color: var(--gray-700); }
    .denom-value { font-size: 16px; color: var(--gray-500); margin-top: 4px; }

    /* Mobile-Optimized Quantity Inputs */
    .qty-input {
      width: 100px;
      height: 56px;
      text-align: center;
      border: 2px solid var(--gray-300);
      border-radius: 0;
      font-size: 20px;
      font-weight: 500;
      color: var(--gray-700);
      -webkit-appearance: none;
      -moz-appearance: textfield;
      appearance: none;
      transition: all 0.2s ease;
      background: var(--white);
    }
    .qty-input:focus {
      outline: none;
      border-color: var(--primary-blue);
      box-shadow: 0 0 0 3px rgba(44, 95, 141, 0.1);
    }
    /* Remove number arrows */
    .qty-input::-webkit-outer-spin-button,
    .qty-input::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    
    /* Disabled denomination inputs */
    .qty-input:disabled {
      background-color: var(--gray-300);
      color: var(--gray-500);
      border-color: var(--gray-300);
      cursor: not-allowed;
    }

    .denom-row.disabled {
      opacity: 0.5;
    }

    .drawer-total {
      margin-top: 15px;
      padding: 15px;
      background: var(--light-blue);
      border-radius: 0;
      text-align: center;
      font-size: 18px;
      font-weight: 600;
      color: var(--primary-blue);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .grand-total {
      background: linear-gradient(135deg, var(--primary-blue) 0%, var(--secondary-blue) 100%);
      color: var(--white);
      padding: 20px;
      border-radius: 0;
      text-align: center;
      margin: 20px 0;
      box-shadow: 0 4px 12px rgba(44, 95, 141, 0.2);
    }
    .grand-total h3 { font-size: 18px; margin-bottom: 8px; font-weight: 600; opacity: 0.9; text-transform: uppercase; letter-spacing: 0.5px; }
    .grand-total .amount { font-size: 36px; font-weight: 600; }
    .notes-area {
      width: 100%;
      min-height: 100px;
      padding: 18px;
      border: 2px solid var(--gray-300);
      border-radius: 0;
      font-size: 16px;
      resize: vertical;
      box-sizing: border-box;
      transition: all 0.2s ease;
    }
    .notes-area:focus {
      outline: none;
      border-color: var(--primary-blue);
      box-shadow: 0 0 0 3px rgba(44, 95, 141, 0.1);
    }
    .submit-btn {
      padding: 14px 20px;
      background: var(--gray-100);
      color: var(--gray-900);
      border: none;
      border-radius: 0;
      font-size: 12px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.15s ease;
      min-height: 48px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
      text-transform: uppercase;
      letter-spacing: 1.2px;
      border: 2px solid var(--gray-300);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      white-space: nowrap;
    }
    .submit-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.12);
      background: var(--gray-300);
    }
    .submit-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
      background: var(--gray-300);
      color: var(--gray-500);
    }
    .am-total-display {
      background: var(--light-blue);
      padding: 20px;
      border-radius: 0;
      margin: 20px 0;
      border: 2px solid rgba(44, 95, 141, 0.1);
    }
    .am-total-display h4 { margin-bottom: 8px; color: var(--primary-blue); font-size: 16px; font-weight: 500; }
    .am-total-display .amount { font-size: 28px; font-weight: 600; color: var(--primary-blue); }

    /* Enhanced Currency Inputs */
    .currency-input {
      width: 100%;
      padding: 20px;
      border: 2px solid var(--gray-300);
      border-radius: 0;
      font-size: 22px;
      text-align: center;
      min-height: 60px;
      box-sizing: border-box;
      -webkit-appearance: none;
      -moz-appearance: textfield;
      appearance: none;
      transition: all 0.2s ease;
      background: var(--white);
      color: var(--gray-700);
    }
    .currency-input:focus {
      outline: none;
      border-color: var(--primary-blue);
      box-shadow: 0 0 0 3px rgba(44, 95, 141, 0.1);
    }
    .currency-input::-webkit-outer-spin-button,
    .currency-input::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    .confirmation-screen { text-align: center; padding: 40px 20px; }
    .confirmation-screen h2 { color: var(--success); margin-bottom: 30px; font-size: 32px; font-weight: 600; }
    .deposit-instruction {
      background: linear-gradient(135deg, var(--success) 0%, #4A8C63 100%);
      color: var(--white);
      padding: 30px;
      border-radius: 0;
      margin: 25px 0;
      font-size: 24px;
      font-weight: 500;
      box-shadow: 0 4px 12px rgba(95, 167, 119, 0.2);
    }
    .return-instruction {
      background: linear-gradient(135deg, var(--warning) 0%, #C69563 100%);
      color: var(--white);
      padding: 30px;
      border-radius: 0;
      margin: 25px 0;
      font-size: 24px;
      font-weight: 500;
      box-shadow: 0 4px 12px rgba(212, 165, 116, 0.2);
    }
    .thank-you { font-size: 22px; color: var(--success); margin: 30px 0; font-weight: 500; }
    .confirm-btn {
      background: linear-gradient(135deg, var(--success) 0%, #4A8C63 100%);
      margin-top: 30px;
    }
    .loading { text-align: center; padding: 40px; }
    .loading-spinner {
      width: 60px;
      height: 60px;
      border: 6px solid var(--gray-300);
      border-top: 6px solid var(--primary-blue);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .message {
      padding: 18px;
      border-radius: 0;
      margin: 20px 0;
      text-align: center;
      font-size: 15px;
      font-weight: 500;
      letter-spacing: 0.3px;
    }
    .message.success {
      background: #E8F5EC;
      color: #2D5F3F;
      border: 2px solid var(--success);
    }
    .message.error {
      background: #F8E6E7;
      color: #6B3638;
      border: 2px solid var(--error);
    }
    .message.info {
      background: var(--light-blue);
      color: var(--primary-blue);
      border: 2px solid var(--secondary-blue);
    }

    /* Typography - Headers */
    h2, h3, h4, h5, h6 {
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 600;
    }
    h2 { font-size: 22px; }
    h3 { font-size: 19px; }
    h4 { font-size: 16px; }
    h5 { font-size: 14px; }
    h6 { font-size: 12px; }

    /* Tip Pool Calculator Styles */
    .cash-needed { color: var(--error); font-weight: 600; }
    .cash-surplus { color: var(--success); font-weight: 600; }
    .hidden { display: none; }
    .skip-content { padding: 25px; }
    .skip-reason {
      width: 100%;
      padding: 18px;
      border: 2px solid var(--gray-300);
      border-radius: 0;
      font-size: 16px;
      min-height: 56px;
      box-sizing: border-box;
      transition: all 0.2s ease;
    }
    .skip-reason:focus {
      outline: none;
      border-color: var(--primary-blue);
      box-shadow: 0 0 0 3px rgba(44, 95, 141, 0.1);
    }
    
    /* Mobile responsive adjustments */
    @media (max-width: 768px) {
      .container { margin: 0; border-radius: 0; }
      .header { padding: 20px; }
      .header h1 { font-size: 24px; }
      .content { padding: 15px; }
      .main-menu { gap: 12px; }
      .menu-btn { padding: 25px 15px; font-size: 16px; min-height: 70px; }
      .denom-row { flex-direction: column; align-items: flex-start; gap: 12px; padding: 20px 0; }
      .qty-input { width: 120px; margin-top: 8px; }
      .grand-total .amount { font-size: 32px; }
      .confirmation-screen h2 { font-size: 28px; }
      .deposit-instruction, .return-instruction { font-size: 20px; padding: 25px; }
    }
    
    @media (max-width: 768px) {
      .main-menu { grid-template-columns: 1fr 1fr; gap: 12px; }
    }

    @media (max-width: 480px) {
      .header h1 { font-size: 20px; }
      .main-menu { grid-template-columns: 1fr; gap: 10px; }
      .main-menu.show-report { grid-template-columns: 1fr; }
      .menu-btn { padding: 20px 15px; min-height: 60px; }
      .secondary-links { font-size: 10px; gap: 10px; }
      .denom-label { font-size: 16px; }
      .qty-input { width: 100px; height: 50px; font-size: 18px; }
      .grand-total .amount { font-size: 28px; }
      .deposit-instruction, .return-instruction { font-size: 18px; padding: 20px; }
    }
    
    /* Google Sites Full Page Embed Optimizations */
    @media screen {
      html {
        /* Force proper viewport handling in Google Sites */
        height: auto !important;
        min-height: 100% !important;
        overflow-y: auto !important;
      }
      
      body {
        /* Ensure body can scroll properly in Google Sites iframe */
        height: auto !important;
        min-height: 100% !important;
        position: relative !important;
        overflow-y: auto !important;
        padding-top: 10px !important; /* Space for Google Sites white bar */
        padding-bottom: 50px !important; /* Extra space at bottom */
      }
      
      .container {
        /* Ensure container doesn't get viewport-locked */
        position: relative !important;
        height: auto !important;
        min-height: auto !important;
        max-height: none !important;
        overflow: visible !important;
        margin-bottom: 50px !important; /* Extra bottom margin */
      }
      
      .submit-btn {
        /* Ensure submit buttons are always accessible */
        position: relative !important;
        z-index: 10 !important;
        margin-bottom: 30px !important;
      }
      
      /* Force visibility of bottom elements in Google Sites */
      .form-section:last-child,
      .form-section .submit-btn:last-child {
        margin-bottom: 100px !important;
      }
    }
    
    /* Elegant Loading Overlay */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      z-index: 9999;
      display: flex;
      justify-content: center;
      align-items: center;
      transition: opacity 0.3s ease;
    }
    .loading-overlay.hidden {
      display: none;
    }
    .loading-content {
      text-align: center;
      padding: 40px;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 0;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    .loading-spinner-elegant {
      width: 60px;
      height: 60px;
      border: 4px solid rgba(102, 126, 234, 0.1);
      border-top: 4px solid #667eea;
      border-radius: 50%;
      animation: spin-elegant 1.2s linear infinite;
      margin: 0 auto 20px;
    }
    @keyframes spin-elegant {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .loading-content h3 {
      margin: 0 0 10px 0;
      font-size: 24px;
      color: #333;
      font-weight: 600;
    }
    .loading-content p {
      margin: 0;
      font-size: 16px;
      color: #666;
      opacity: 0.8;
    }
    
    /* Success Screens */
    .success-screen {
      text-align: center;
      padding: 40px 20px;
      max-width: 600px;
      margin: 0 auto;
    }
    .success-icon {
      font-size: 80px;
      margin-bottom: 20px;
      animation: success-bounce 0.6s ease;
    }
    @keyframes success-bounce {
      0% { transform: scale(0.3); opacity: 0; }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); opacity: 1; }
    }
    .success-screen h2 {
      color: #28a745;
      margin-bottom: 15px;
      font-size: 32px;
      font-weight: 700;
    }
    .success-message {
      font-size: 18px;
      color: #666;
      margin-bottom: 30px;
      line-height: 1.5;
    }
    .success-details {
      background: #f8f9fa;
      border-radius: 0;
      padding: 25px;
      margin: 25px 0;
      border-left: 4px solid #28a745;
    }
    .detail-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      font-size: 16px;
    }
    .detail-row:not(:last-child) {
      border-bottom: 1px solid #e9ecef;
    }
    .detail-row span:first-child {
      color: #666;
      font-weight: 500;
    }
    .detail-row span:last-child {
      color: #333;
      font-weight: 600;
    }
    .success-btn {
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
      margin-top: 30px;
      font-size: 18px;
      padding: 20px 40px;
      border-radius: 0;
      transition: all 0.3s ease;
    }
    .success-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(40, 167, 69, 0.3);
    }
  </style>
  
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
  <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
  <!-- Tip Pool Calculator Dependencies -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

  <!-- OCR Dependencies -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>
    // Configure PDF.js worker
    if (typeof pdfjsLib !== 'undefined') {
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    }
  </script>

  <style>
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- App Header (Injected by app-header.js) -->
    <div id="appHeader"></div>

    <div class="content">
    <div id="messageArea"></div>
    
      <div id="orderingSystemForm" class="form-section">
        <h2 style="margin-bottom: 20px; color: var(--gray-900);">Orders & Prep System</h2>

        <!-- Ordering Guide Print -->
        <div style="margin-bottom: 16px; padding: 12px; background: var(--gray-100); border-left: 3px solid var(--gray-700); border-radius: 0;">
          <span style="font-size: 12px; font-weight: 700; color: var(--gray-700); text-transform: uppercase; letter-spacing: 0.5px; margin-right: 12px;">Print Ordering Guides:</span>
          <a href="#" onclick="downloadOrderingGuide('greenleaf'); return false;" style="font-size: 12px; color: #059669; text-decoration: underline; margin-right: 16px; cursor: pointer;">üñ®Ô∏è Greenleaf</a>
          <a href="#" onclick="downloadOrderingGuide('performance'); return false;" style="font-size: 12px; color: #059669; text-decoration: underline; margin-right: 16px; cursor: pointer;">üñ®Ô∏è Performance</a>
          <a href="#" onclick="downloadOrderingGuide('mani'); return false;" style="font-size: 12px; color: #059669; text-decoration: underline; cursor: pointer;">üñ®Ô∏è Mani</a>
        </div>

        <!-- Tab Navigation -->
        <div style="position: sticky; top: 0; z-index: 100; background: var(--white); margin-bottom: 20px; padding-bottom: 10px;">
          <div class="tabs" style="display: flex; border-bottom: 2px solid var(--gray-300); overflow-x: auto; overflow-y: hidden; -webkit-overflow-scrolling: touch; gap: 4px;">
            <button class="tab-link active" onclick="openOrderTab(event, 'prepSheet')" style="
            flex: 0 0 auto;
            padding: 12px 10px;
            min-width: 80px;
            background: var(--gray-700);
            color: var(--white);
            border: none;
            cursor: pointer;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            transition: all 0.15s ease;
          ">PREP</button>
          <button class="tab-link" onclick="openOrderTab(event, 'checkInInvoice')" style="
            flex: 0 0 auto;
            padding: 12px 10px;
            min-width: 80px;
            background: var(--gray-100);
            color: var(--gray-700);
            border: none;
            cursor: pointer;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            transition: all 0.15s ease;
          ">RECEIVE</button>
          <button class="tab-link" onclick="openOrderTab(event, 'upcomingOrders')" style="
            flex: 0 0 auto;
            padding: 12px 10px;
            min-width: 80px;
            background: var(--gray-100);
            color: var(--gray-700);
            border: none;
            cursor: pointer;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            transition: all 0.15s ease;
          ">ORDERING</button>
          <button class="tab-link" onclick="openOrderTab(event, 'updateCounts')" style="
            flex: 0 0 auto;
            padding: 12px 10px;
            min-width: 80px;
            background: var(--gray-100);
            color: var(--gray-700);
            border: none;
            cursor: pointer;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            transition: all 0.15s ease;
          ">COUNT</button>
          <button class="tab-link" onclick="openOrderTab(event, 'manageInventory')" style="
            flex: 0 0 auto;
            padding: 12px 10px;
            min-width: 80px;
            background: var(--gray-100);
            color: var(--gray-700);
            border: none;
            cursor: pointer;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
          ">
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" style="width: 14px; height: 14px; fill: currentColor;">
              <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
            </svg>
            EDIT
          </button>
          <button class="tab-link" onclick="openManageOrdersTab(event)" style="
            flex: 0 0 auto;
            padding: 12px 10px;
            min-width: 80px;
            background: var(--gray-100);
            color: var(--gray-700);
            border: none;
            cursor: pointer;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            transition: all 0.15s ease;
          ">MANAGE</button>
          <button class="tab-link" onclick="openOrderTab(event, 'priceHistory')" style="
            flex: 0 0 auto;
            padding: 12px 10px;
            min-width: 80px;
            background: var(--gray-100);
            color: var(--gray-700);
            border: none;
            cursor: pointer;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            transition: all 0.15s ease;
          ">PRICES</button>
          </div>
        </div>

        <!-- Tab Content: Upcoming Orders -->
        <div id="upcomingOrders" class="tab-content" style="display: none;">
          <div style="text-align: center; padding: 20px;">
            <p>Loading orders...</p>
          </div>
        </div>

        <!-- Tab Content: Manage Inventory -->
        <div id="manageInventory" class="tab-content" style="display: none;">
          <!-- Add Item Button -->
          <div style="margin-bottom: 20px;">
            <button onclick="showAddInventoryModal()" style="
              background: var(--gray-700);
              color: white;
              border: none;
              padding: 10px 20px;
              border-radius: 0;
              cursor: pointer;
              font-size: 12px;
              font-weight: 700;
              text-transform: uppercase;
              letter-spacing: 0.8px;
            ">+ Add Inventory Item</button>
          </div>

          <!-- Inventory List -->
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3 style="margin: 0; color: var(--gray-900);">Inventory Items</h3>
            <button onclick="showVendorManagement()" style="
              background: var(--gray-600);
              color: white;
              border: none;
              padding: 8px 16px;
              border-radius: 0;
              cursor: pointer;
              font-size: 13px;
              font-weight: 600;
            ">Manage Vendors</button>
          </div>

          <!-- Search and Filter Controls -->
          <div style="display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap;">
            <input
              type="text"
              id="inventorySearchInput"
              placeholder="Search items..."
              oninput="filterInventoryList()"
              style="
                flex: 1;
                min-width: 200px;
                padding: 10px 14px;
                border: 2px solid #e0e0e0;
                border-radius: 6px;
                font-size: 14px;
                transition: border-color 0.2s;
              "
              onfocus="this.style.borderColor='var(--gray-700)'"
              onblur="this.style.borderColor='#e0e0e0'"
            />
            <select
              id="inventoryVendorFilter"
              onchange="filterInventoryList()"
              style="
                padding: 10px 14px;
                border: 2px solid #e0e0e0;
                border-radius: 6px;
                font-size: 14px;
                background: white;
                cursor: pointer;
              "
            >
              <option value="">All Vendors</option>
              <option value="PREP">PREP</option>
              <option value="Greenleaf">Greenleaf</option>
              <option value="Performance">Performance</option>
              <option value="Mani Imports">Mani Imports</option>
              <option value="Eatopia">Eatopia</option>
              <option value="Restaurant Depot">Restaurant Depot</option>
              <option value="Alsco">Alsco</option>
              <option value="SRC Pumping">SRC Pumping</option>
              <option value="Southern Glazer's">Southern Glazer's</option>
              <option value="Breakthru Beverage">Breakthru Beverage</option>
            </select>
          </div>

          <div id="inventoryList" style="width: 100%;">
            <p style="text-align: center; padding: 20px;">Loading inventory...</p>
          </div>
        </div>

        <!-- Tab Content: Price History -->
        <div id="priceHistory" class="tab-content" style="display: none;">
          <div style="border: 2px solid var(--gray-300); padding: 18px; margin-bottom: 18px; background: var(--gray-100);">
            <h3 style="margin: 0 0 16px 0; color: var(--gray-900); font-size: 15px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.6px;">Price History Explorer</h3>

            <div style="display: flex; flex-wrap: wrap; gap: 16px; margin-bottom: 16px;">
              <div style="flex: 1 1 200px;">
                <label for="priceHistoryStartDate" style="display: block; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: var(--gray-700); margin-bottom: 4px;">Start Date</label>
                <input type="date" id="priceHistoryStartDate" style="width: 100%; padding: 10px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 13px;" />
              </div>
              <div style="flex: 1 1 200px;">
                <label for="priceHistoryEndDate" style="display: block; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: var(--gray-700); margin-bottom: 4px;">End Date</label>
                <input type="date" id="priceHistoryEndDate" style="width: 100%; padding: 10px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 13px;" />
              </div>
              <div style="flex: 1 1 220px;">
                <label for="priceHistoryVendor" style="display: block; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: var(--gray-700); margin-bottom: 4px;">Vendor Filter</label>
                <select id="priceHistoryVendor" onchange="handlePriceHistoryVendorChange()" style="width: 100%; padding: 10px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 13px; background: white;">
                  <option value="ALL">All Vendors</option>
                </select>
              </div>
            </div>

            <div style="border: 2px solid var(--gray-300); background: white; padding: 16px;">
              <div style="display: flex; flex-wrap: wrap; gap: 12px; align-items: center; margin-bottom: 12px;">
                <div style="flex: 1 1 200px;">
                  <label for="priceHistoryItemSearch" style="display: block; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: var(--gray-700); margin-bottom: 4px;">Search Items</label>
                  <input type="text" id="priceHistoryItemSearch" placeholder="Search inventory items..." oninput="handlePriceHistorySearch(this.value)" style="width: 100%; padding: 8px 10px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 12px;" />
                </div>
                <div style="display: flex; gap: 10px;">
                  <button type="button" onclick="priceHistorySelectAll()" style="padding: 8px 12px; border: 2px solid var(--gray-400); background: var(--gray-100); color: var(--gray-800); font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; cursor: pointer;">Select All</button>
                  <button type="button" onclick="priceHistoryClearSelection()" style="padding: 8px 12px; border: 2px solid var(--gray-400); background: white; color: var(--gray-700); font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; cursor: pointer;">Clear</button>
                </div>
              </div>
              <div id="priceHistoryItemList" style="max-height: 220px; overflow-y: auto; border: 1px solid var(--gray-200); padding: 8px; background: #f8f9fa;"></div>
              <p style="margin-top: 8px; font-size: 11px; color: var(--gray-600);">Tip: leave vendor on "All" to compare cross-vendor items. Select at least one item or choose a vendor to analyze.</p>
            </div>

            <div style="margin-top: 16px; display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
              <button type="button" onclick="loadPriceHistory()" style="padding: 12px 20px; background: var(--gray-900); color: white; border: 2px solid var(--gray-900); font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.8px; cursor: pointer;">Load Price History</button>
              <span id="priceHistoryStatus" style="font-size: 12px; color: var(--gray-600);"></span>
            </div>
          </div>

          <div id="priceHistoryResults" style="border: 2px solid var(--gray-300); padding: 18px; background: white; min-height: 120px;">
            <p style="margin: 0; font-size: 13px; color: var(--gray-600);">Select a date range and items to view pricing trends.</p>
          </div>
        </div>

        <!-- Tab Content: Update Counts -->
        <div id="updateCounts" class="tab-content" style="display: none;">
          <!-- Search and Filter Controls -->
          <div style="display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap;">
            <input
              type="text"
              id="stockCountSearchInput"
              placeholder="Search items..."
              oninput="filterStockCountList()"
              style="
                flex: 1;
                min-width: 200px;
                padding: 10px 14px;
                border: 2px solid #e0e0e0;
                border-radius: 6px;
                font-size: 14px;
                transition: border-color 0.2s;
              "
              onfocus="this.style.borderColor='var(--gray-700)'"
              onblur="this.style.borderColor='#e0e0e0'"
            />
            <select
              id="stockCountVendorFilter"
              onchange="filterStockCountList()"
              style="
                padding: 10px 14px;
                border: 2px solid #e0e0e0;
                border-radius: 6px;
                font-size: 14px;
                background: white;
                cursor: pointer;
              "
            >
              <option value="">All Vendors</option>
              <option value="Greenleaf">Greenleaf</option>
              <option value="Performance">Performance</option>
              <option value="Mani Imports">Mani Imports</option>
              <option value="Eatopia">Eatopia</option>
              <option value="Restaurant Depot">Restaurant Depot</option>
              <option value="Alsco">Alsco</option>
              <option value="SRC Pumping">SRC Pumping</option>
              <option value="Southern Glazer's">Southern Glazer's</option>
              <option value="Breakthru Beverage">Breakthru Beverage</option>
            </select>
          </div>

          <div id="stockCountList" style="width: 100%;">
            <p style="text-align: center; padding: 20px;">Loading items...</p>
          </div>
        </div>

        <!-- Tab Content: Prep Sheet -->
        <div id="prepSheet" class="tab-content" style="display: block;">
          <!-- Add Prep Item Button -->
          <div style="margin-bottom: 20px;">
            <button onclick="showAddPrepModal()" style="
              background: var(--gray-700);
              color: white;
              border: none;
              padding: 10px 20px;
              border-radius: 0;
              cursor: pointer;
              font-size: 12px;
              font-weight: 700;
              text-transform: uppercase;
              letter-spacing: 0.8px;
            ">+ Add Prep Item</button>
          </div>

          <!-- Count Session Info (Auto-detected) -->
          <div id="countSessionInfo" style="margin-bottom: 20px; padding: 16px; background: var(--gray-100); border-radius: 0; border: 2px solid var(--gray-300);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
              <div style="font-weight: 700; color: var(--gray-900); font-size: 14px; text-transform: uppercase; letter-spacing: 1px;">
                <span id="currentSessionIcon"></span>
                <span id="currentSessionName"></span>
              </div>
              <div style="font-size: 11px; color: var(--gray-500); font-weight: 600;">
                <span id="currentSessionTime"></span>
              </div>
            </div>
            <div id="sessionCompletionStats" style="font-size: 12px; color: var(--gray-700); line-height: 1.6;">
              <!-- Populated by JavaScript -->
            </div>
          </div>

          <!-- Bottle Count Section -->
          <div id="bottleCountSection" style="
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 0;
            padding: 20px;
            margin-bottom: 20px;
            border: 3px solid #5a67d8;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
          ">
            <h3 style="margin: 0 0 16px 0; color: white; font-size: 14px; font-weight: 700; text-transform: uppercase; letter-spacing: 1.5px;">
              üçæ BOTTLE COUNT
            </h3>

            <div id="bottleCountGrid" style="
              display: grid;
              grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
              gap: 12px;
            ">
              <!-- Will be populated by JavaScript -->
              <div style="text-align: center; color: white; font-size: 12px; padding: 20px; grid-column: 1 / -1;">
                Loading bottle counts...
              </div>
            </div>
          </div>

          <!-- Action Buttons (Redesigned - Small Jayna Blue) -->
          <div style="display: flex; gap: 12px; margin-bottom: 20px; justify-content: flex-start; flex-wrap: wrap;">
            <button onclick="generatePrepSheetPDF()" style="
              background: #2196f3 !important;
              color: white !important;
              border: 2px solid #2196f3 !important;
              padding: 12px 24px !important;
              font-size: 13px !important;
              font-weight: 700 !important;
              text-transform: uppercase !important;
              letter-spacing: 0.5px !important;
              cursor: pointer !important;
              border-radius: 0 !important;
              transition: all 0.2s !important;
              box-sizing: border-box !important;
              min-height: 44px !important;
              display: inline-flex !important;
              align-items: center !important;
              justify-content: center !important;
            " onmouseover="this.style.background='#1976d2'" onmouseout="this.style.background='#2196f3'">
              DOWNLOAD PREP LIST
            </button>
            <button id="emailPrepButton" onclick="emailPrepSheetToPrinter()" style="
              background: #2196f3 !important;
              color: white !important;
              border: 2px solid #2196f3 !important;
              padding: 12px 24px !important;
              font-size: 13px !important;
              font-weight: 700 !important;
              text-transform: uppercase !important;
              letter-spacing: 0.5px !important;
              cursor: pointer !important;
              border-radius: 0 !important;
              transition: all 0.2s !important;
              box-sizing: border-box !important;
              min-height: 44px !important;
              display: inline-flex !important;
              align-items: center !important;
              justify-content: center !important;
            " onmouseover="this.style.background='#1976d2'" onmouseout="this.style.background='#2196f3'">
              PRINT PREP LIST
            </button>
            <button id="printItemListButton" onclick="printAllPrepItems()" style="
              background: var(--gray-700) !important;
              color: white !important;
              border: 2px solid var(--gray-700) !important;
              padding: 12px 24px !important;
              font-size: 13px !important;
              font-weight: 700 !important;
              text-transform: uppercase !important;
              letter-spacing: 0.5px !important;
              cursor: pointer !important;
              border-radius: 0 !important;
              transition: all 0.2s !important;
              box-sizing: border-box !important;
              min-height: 44px !important;
              display: inline-flex !important;
              align-items: center !important;
              justify-content: center !important;
            " onmouseover="this.style.background='var(--gray-900)'" onmouseout="this.style.background='var(--gray-700)'">
              PRINT ITEM LIST
            </button>
          </div>

          <!-- PREP Item Counting Section -->
          <div style="margin-bottom: 30px;">
            <h3 style="margin-bottom: 16px; color: var(--gray-900); font-size: 14px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;">Update Prep Stock Counts</h3>

            <!-- Active Prep Counter Display -->
            <div onclick="cycleToNextPrepCounter()" style="
              background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
              border: 3px solid #1565c0;
              padding: 16px 20px;
              margin-bottom: 20px;
              cursor: pointer;
              transition: all 0.2s ease;
              box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.3)'" onmouseout="this.style.transform=''; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.2)'">
              <div style="display: flex; align-items: center; gap: 12px;">
                <!-- Color Dot -->
                <div id="prepCounterColorDot" style="
                  width: 24px;
                  height: 24px;
                  border-radius: 50%;
                  background: #fff;
                  border: 2px solid rgba(255,255,255,0.5);
                  flex-shrink: 0;
                "></div>

                <div style="flex: 1;">
                  <div style="font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.8px; color: rgba(255,255,255,0.85); margin-bottom: 4px;">
                    COUNTING AS:
                  </div>
                  <div id="prepCounterName" style="
                    font-size: 20px;
                    font-weight: 700;
                    color: white;
                    text-transform: uppercase;
                    letter-spacing: 1px;
                  ">
                    Loading...
                  </div>
                </div>

                <!-- Cycle Instruction -->
                <div style="
                  font-size: 10px;
                  color: rgba(255,255,255,0.85);
                  text-align: right;
                  font-weight: 600;
                  text-transform: uppercase;
                  letter-spacing: 0.5px;
                  line-height: 1.4;
                ">
                  CLICK TO<br>CHANGE
                </div>
              </div>
            </div>

            <!-- FEATURE 5: Voice Input Mode & FEATURE 7: Copy Yesterday's Counts & FEATURE 8: Bulk Actions -->
            <div style="display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap;">
              <button
                id="voiceModeButton"
                onclick="toggleVoiceMode()"
                style="
                  flex: 1;
                  min-width: 140px;
                  padding: 12px 16px;
                  font-size: 12px;
                  font-weight: 700;
                  background: #9c27b0;
                  border: 2px solid #9c27b0;
                  border-radius: 0;
                  color: white;
                  cursor: pointer;
                  transition: all 0.2s;
                  text-transform: uppercase;
                  letter-spacing: 0.5px;
                  min-height: 48px;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  gap: 8px;
                "
                onmouseover="this.style.background='#7b1fa2'"
                onmouseout="if(!window.voiceModeActive) this.style.background='#9c27b0'"
              >
                <span id="voiceModeIcon">üéôÔ∏è</span>
                <span id="voiceModeText">VOICE MODE</span>
              </button>
              <button
                onclick="copyYesterdayCounts()"
                style="
                  flex: 1;
                  min-width: 140px;
                  padding: 12px 16px;
                  font-size: 12px;
                  font-weight: 700;
                  background: #00acc1;
                  border: 2px solid #00acc1;
                  border-radius: 0;
                  color: white;
                  cursor: pointer;
                  transition: all 0.2s;
                  text-transform: uppercase;
                  letter-spacing: 0.5px;
                  min-height: 48px;
                "
                onmouseover="this.style.background='#00838f'"
                onmouseout="this.style.background='#00acc1'"
              >
                üìã COPY YESTERDAY
              </button>
            </div>

            <!-- FEATURE 8: Bulk Actions Bar (Hidden by default) -->
            <div id="bulkActionsBar" style="display: none; background: var(--gray-100); border: 2px solid var(--gray-300); padding: 16px; margin-bottom: 20px;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <div style="font-size: 13px; font-weight: 700; color: var(--gray-900);">
                  <span id="bulkSelectedCount">0</span> items selected
                </div>
                <button onclick="clearBulkSelection()" style="font-size: 11px; padding: 6px 12px; background: var(--gray-300); border: 2px solid var(--gray-400); color: var(--gray-700); cursor: pointer; font-weight: 600; min-height: 36px;">
                  CLEAR SELECTION
                </button>
              </div>
              <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                <button onclick="bulkMarkAs('full')" style="
                  flex: 1;
                  min-width: 120px;
                  padding: 10px 14px;
                  font-size: 11px;
                  font-weight: 700;
                  background: #4caf50;
                  border: 2px solid #4caf50;
                  border-radius: 0;
                  color: white;
                  cursor: pointer;
                  text-transform: uppercase;
                  letter-spacing: 0.5px;
                  min-height: 44px;
                " onmouseover="this.style.background='#45a049'" onmouseout="this.style.background='#4caf50'">
                  MARK ALL AS FULL
                </button>
                <button onclick="bulkMarkAs('empty')" style="
                  flex: 1;
                  min-width: 120px;
                  padding: 10px 14px;
                  font-size: 11px;
                  font-weight: 700;
                  background: #f44336;
                  border: 2px solid #f44336;
                  border-radius: 0;
                  color: white;
                  cursor: pointer;
                  text-transform: uppercase;
                  letter-spacing: 0.5px;
                  min-height: 44px;
                " onmouseover="this.style.background='#e53935'" onmouseout="this.style.background='#f44336'">
                  MARK ALL AS EMPTY
                </button>
                <button onclick="bulkCopyYesterday()" style="
                  flex: 1;
                  min-width: 120px;
                  padding: 10px 14px;
                  font-size: 11px;
                  font-weight: 700;
                  background: #00acc1;
                  border: 2px solid #00acc1;
                  border-radius: 0;
                  color: white;
                  cursor: pointer;
                  text-transform: uppercase;
                  letter-spacing: 0.5px;
                  min-height: 44px;
                " onmouseover="this.style.background='#00838f'" onmouseout="this.style.background='#00acc1'">
                  COPY FROM YESTERDAY
                </button>
              </div>
            </div>

            <!-- FEATURE 1: Progress Bar -->
            <div id="prepCountProgressBar" style="
              position: sticky;
              top: 0;
              z-index: 100;
              background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
              border: 3px solid #1565c0;
              padding: 16px 20px;
              margin-bottom: 20px;
              box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            ">
              <div style="margin-bottom: 8px;">
                <div style="font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.8px; color: rgba(255,255,255,0.85); margin-bottom: 6px;">
                  COUNTING PROGRESS
                </div>
                <div id="prepProgressText" style="font-size: 18px; font-weight: 700; color: white; margin-bottom: 10px;">
                  0 / 0 items counted (0%)
                </div>
                <div style="width: 100%; height: 12px; background: rgba(255,255,255,0.3); border-radius: 6px; overflow: hidden;">
                  <div id="prepProgressBar" style="height: 100%; background: #4caf50; width: 0%; transition: width 0.3s ease;"></div>
                </div>
              </div>
              <div id="prepProgressStats" style="display: flex; gap: 20px; flex-wrap: wrap; font-size: 12px; color: white; margin-top: 12px;">
                <div><span style="opacity: 0.85;">‚úì Counted:</span> <strong id="prepCountedCount">0</strong></div>
                <div><span style="opacity: 0.85;">‚è≥ Remaining:</span> <strong id="prepRemainingCount">0</strong></div>
                <div><span style="opacity: 0.85;">‚ö†Ô∏è Low Stock:</span> <strong id="prepLowStockCount">0</strong></div>
              </div>
            </div>

            <!-- FEATURE 2: Show Only Uncounted Toggle -->
            <div style="background: var(--gray-100); border: 2px solid var(--gray-300); padding: 12px 16px; margin-bottom: 20px; display: flex; align-items: center; gap: 12px;">
              <input
                type="checkbox"
                id="hideCountedItemsToggle"
                style="width: 20px; height: 20px; cursor: pointer;"
                onchange="toggleHideCountedItems()"
              />
              <label for="hideCountedItemsToggle" style="font-size: 13px; font-weight: 600; color: var(--gray-900); cursor: pointer; user-select: none;">
                ‚òë Hide Counted Items
              </label>
            </div>

            <div id="prepCountList" style="width: 100%;">
              <p style="text-align: center; padding: 20px; color: var(--gray-500);">Loading prep items...</p>
            </div>
          </div>

          <!-- Custom Notes Section -->
          <div style="margin-bottom: 20px;">
            <label for="prepSheetNotes" style="display: block; font-size: 12px; font-weight: 700; color: var(--gray-700); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">
              Custom Notes (optional - will appear on PDF):
            </label>
            <textarea
              id="prepSheetNotes"
              placeholder="Add any special instructions or notes for the prep team..."
              style="width: 100%; padding: 12px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 13px; min-height: 80px; font-family: inherit; resize: vertical;"
            ></textarea>
          </div>

          <!-- Action Buttons (Bottom - Duplicate) -->
          <div style="display: flex; gap: 12px; margin-bottom: 20px; justify-content: flex-start; flex-wrap: wrap;">
            <button onclick="generatePrepSheetPDF()" style="
              background: #2196f3 !important;
              color: white !important;
              border: 2px solid #2196f3 !important;
              padding: 12px 24px !important;
              font-size: 13px !important;
              font-weight: 700 !important;
              text-transform: uppercase !important;
              letter-spacing: 0.5px !important;
              cursor: pointer !important;
              border-radius: 0 !important;
              transition: all 0.2s !important;
              box-sizing: border-box !important;
              min-height: 44px !important;
              display: inline-flex !important;
              align-items: center !important;
              justify-content: center !important;
            " onmouseover="this.style.background='#1976d2'" onmouseout="this.style.background='#2196f3'">
              DOWNLOAD PREP LIST
            </button>
            <button id="emailPrepButtonBottom" onclick="emailPrepSheetToPrinter()" style="
              background: #2196f3 !important;
              color: white !important;
              border: 2px solid #2196f3 !important;
              padding: 12px 24px !important;
              font-size: 13px !important;
              font-weight: 700 !important;
              text-transform: uppercase !important;
              letter-spacing: 0.5px !important;
              cursor: pointer !important;
              border-radius: 0 !important;
              transition: all 0.2s !important;
              box-sizing: border-box !important;
              min-height: 44px !important;
              display: inline-flex !important;
              align-items: center !important;
              justify-content: center !important;
            " onmouseover="this.style.background='#1976d2'" onmouseout="this.style.background='#2196f3'">
              PRINT PREP LIST
            </button>
            <button id="printItemListButton" onclick="printAllPrepItems()" style="
              background: var(--gray-700) !important;
              color: white !important;
              border: 2px solid var(--gray-700) !important;
              padding: 12px 24px !important;
              font-size: 13px !important;
              font-weight: 700 !important;
              text-transform: uppercase !important;
              letter-spacing: 0.5px !important;
              cursor: pointer !important;
              border-radius: 0 !important;
              transition: all 0.2s !important;
              box-sizing: border-box !important;
              min-height: 44px !important;
              display: inline-flex !important;
              align-items: center !important;
              justify-content: center !important;
            " onmouseover="this.style.background='var(--gray-900)'" onmouseout="this.style.background='var(--gray-700)'">
              PRINT ITEM LIST
            </button>
          </div>

          <!-- Auto-Print Status Disclaimer -->
          <div id="autoPrintStatus" style="margin-bottom: 20px;">
            <p style="text-align: center; padding: 12px; color: var(--gray-500); font-size: 12px;">
              Checking auto-print status...
            </p>
          </div>
        </div>

        <!-- Tab Content: Check-In Invoice -->
        <div id="checkInInvoice" class="tab-content" style="display: none;">
          <div style="margin-bottom: 20px;">
            <h3 style="color: var(--gray-900); margin-bottom: 10px; font-size: 16px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;">Invoice Check-In</h3>
            <p style="color: var(--gray-500); font-size: 13px; margin-bottom: 20px;">
              Upload an invoice photo to scan and reconcile items with inventory.
            </p>

            <!-- Type Selector - REQUIRED DROPDOWN -->
            <div style="background: white; border: 2px solid var(--gray-300); padding: 16px; margin-bottom: 20px;">
              <label for="documentTypeSelect" style="display: block; color: var(--gray-700); font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px;">
                DOCUMENT TYPE: <span style="color: #dc2626;">* REQUIRED</span>
              </label>
              <select
                id="documentTypeSelect"
                onchange="selectInvoiceType(this.value)"
                style="width: 100%; padding: 12px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 13px; background: white; font-weight: 600; cursor: pointer;"
              >
                <option value="">-- SELECT TYPE --</option>
                <option value="invoice">INVOICE FROM DELIVERY (Updates Inventory)</option>
                <option value="order">PENDING ORDER (For Future Delivery)</option>
              </select>
              <p id="invoiceTypeDescription" style="margin-top: 10px; font-size: 11px; color: var(--gray-500); line-height: 1.5;">
                Select whether this is an invoice from a delivery you're receiving now, or a pending order for a future date.
              </p>
            </div>
          </div>

          <!-- Orders Due Today Alert (dynamically populated) -->
          <div id="ordersDueTodayAlert"></div>

          <!-- Pending Order Check-In View (dynamically populated) -->
          <div id="pendingOrderCheckInView" style="display: none;"></div>

          <!-- Pending Order Metadata (shown BEFORE upload if type is 'order') -->
          <div id="pendingOrderMetadata" style="display: none; background: white; border: 2px solid var(--gray-300); padding: 20px; margin-bottom: 20px;">
            <h4 style="margin: 0 0 16px 0; color: var(--gray-900); font-size: 14px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;">Order Details</h4>

            <label style="display: block; color: var(--gray-700); font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">
              YOUR NAME: <span style="color: #dc2626;">*</span>
            </label>
            <input
              type="text"
              id="pendingOrderName"
              placeholder="Enter your name"
              style="width: 100%; padding: 12px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 13px; margin-bottom: 16px; box-sizing: border-box;"
            />

            <label style="display: block; color: var(--gray-700); font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">
              EXPECTED DELIVERY DATE: <span style="color: #dc2626;">*</span>
            </label>
            <input
              type="date"
              id="pendingOrderDate"
              style="width: 100%; padding: 12px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 13px; margin-bottom: 16px; box-sizing: border-box;"
            />

            <label style="display: block; color: var(--gray-700); font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">
              NOTES (OPTIONAL):
            </label>
            <textarea
              id="pendingOrderNotes"
              placeholder="Add any special instructions or notes..."
              style="width: 100%; min-height: 80px; padding: 12px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 13px; resize: vertical; font-family: inherit; box-sizing: border-box;"
            ></textarea>
          </div>

          <!-- Upload Section -->
          <div id="uploadSection" style="background: var(--gray-100); padding: 24px; border-radius: 0; margin-bottom: 24px; border: 2px solid var(--gray-300); opacity: 0.5; pointer-events: none;">
            <div style="text-align: center;">
              <h4 style="margin: 0 0 12px 0; color: var(--gray-900); font-size: 14px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;">Upload Invoice/Order</h4>
              <p style="color: var(--gray-500); font-size: 12px; margin-bottom: 16px;">Select document type above first</p>

              <!-- File Input for Camera (Hidden) -->
              <input
                type="file"
                id="invoiceCameraInput"
                accept="image/*,application/pdf,.csv,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
                capture="environment"
                style="display: none;"
                onchange="handleInvoiceUpload(event)"
              />

              <!-- File Input for Upload (Hidden) -->
              <input
                type="file"
                id="invoiceFileInput"
                accept="image/*,application/pdf,.csv,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
                style="display: none;"
                onchange="handleInvoiceUpload(event)"
              />

              <!-- Upload Buttons (Side by Side) -->
              <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                <button
                  class="submit-btn"
                  onclick="document.getElementById('invoiceCameraInput').click()"
                  style="background: var(--gray-100); color: var(--gray-900); border: 2px solid var(--gray-300); flex: 1; max-width: 200px; padding: 14px;"
                >
                  TAKE PHOTO
                </button>
                <button
                  class="submit-btn"
                  onclick="document.getElementById('invoiceFileInput').click()"
                  style="background: var(--gray-100); color: var(--gray-900); border: 2px solid var(--gray-300); flex: 1; max-width: 200px; padding: 14px;"
                >
                  UPLOAD
                </button>
              </div>
            </div>
          </div>

          <!-- Preview Section (Hidden until image uploaded) -->
          <div id="invoicePreviewSection" style="display: none; margin-bottom: 24px;">
            <h4 style="color: var(--gray-900); margin-bottom: 12px; font-size: 14px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;">Uploaded Image</h4>
            <div style="background: var(--white); padding: 16px; border-radius: 0; border: 1px solid var(--gray-300); position: relative;">
              <img
                id="invoicePreviewImage"
                style="max-width: 100%; height: auto; border-radius: 0; display: block; margin: 0 auto;"
              />

              <!-- Vendor Format Selector -->
              <div style="margin-top: 16px; padding: 12px; background: var(--gray-100); border: 2px solid var(--gray-300);">
                <label style="display: block; margin-bottom: 8px; color: var(--gray-700); font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;">
                  VENDOR FORMAT (helps OCR accuracy)
                </label>
                <select
                  id="ocrVendorFormat"
                  style="width: 100%; padding: 10px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 13px; background: white; font-weight: 600;"
                  onchange="handleVendorFormatChange(this.value)"
                >
                  <option value="auto">Auto-Detect Format</option>
                  <option value="performance-order">Performance - Order Email</option>
                  <option value="performance-invoice">Performance - Invoice</option>
                  <option value="greenleaf-invoice">Greenleaf - Invoice</option>
                  <option value="mani-invoice">Mani Imports - Invoice</option>
                  <option value="generic">Generic Format</option>
                  <option value="__ADD_NEW__" style="border-top: 2px solid #ccc; margin-top: 4px; font-weight: 700;">‚ûï CREATE NEW FORMAT...</option>
                </select>
                <p style="margin-top: 6px; font-size: 10px; color: var(--gray-600);">
                  System learns and improves with each check-in!
                </p>
              </div>

              <div style="margin-top: 16px; display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                <button
                  class="submit-btn"
                  onclick="processInvoiceOCR()"
                  id="processOCRButton"
                  style="background: var(--gray-700); color: white; border: 2px solid var(--gray-700); flex: 1; max-width: 200px; padding: 14px; font-weight: 700;"
                >
                  SCAN & EXTRACT
                </button>
                <button
                  class="submit-btn"
                  onclick="clearInvoiceUpload()"
                  style="background: var(--gray-100); color: var(--gray-900); border: 2px solid var(--gray-300); flex: 1; max-width: 200px; padding: 14px;"
                >
                  CLEAR
                </button>
              </div>
            </div>
          </div>

          <!-- OCR Processing Status -->
          <div id="ocrProcessingStatus" style="display: none; margin-bottom: 24px;">
            <div style="background: var(--gray-100); padding: 16px; border-radius: 0; border: 2px solid var(--gray-300);">
              <div style="display: flex; align-items: center; gap: 12px;">
                <div class="spinner" style="
                  border: 3px solid var(--gray-300);
                  border-top: 3px solid var(--gray-500);
                  border-radius: 50%;
                  width: 24px;
                  height: 24px;
                  animation: spin 1s linear infinite;
                "></div>
                <div>
                  <strong style="color: var(--gray-900); font-size: 13px; text-transform: uppercase; letter-spacing: 1px;">Processing Invoice...</strong>
                  <p id="ocrProgressText" style="margin: 4px 0 0 0; color: var(--gray-500); font-size: 12px;">
                    Extracting text from image...
                  </p>
                </div>
              </div>
            </div>
          </div>

          <!-- Extracted Items Section (Hidden until OCR complete) -->
          <div id="extractedItemsSection" style="display: none;">
            <h4 style="color: var(--gray-900); margin-bottom: 16px; font-size: 14px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;">Extracted Items</h4>
            <div id="extractedItemsList" style="width: 100%;">
              <!-- Will be populated by JavaScript including check-in button -->
            </div>
          </div>
        </div>

        <!-- Tab Content: Manage Pending Orders (Password Protected) -->
        <div id="manageOrders" class="tab-content" style="display: none;">
          <!-- Page Header -->
          <div style="background: var(--gray-100); border: 2px solid var(--gray-300); padding: 20px; margin-bottom: 20px;">
            <h3 style="color: var(--gray-900); margin: 0 0 12px 0; font-size: 18px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;">Manage Pending Orders</h3>
            <p style="color: var(--gray-600); font-size: 13px; margin: 0; line-height: 1.5;">View, edit, and delete all pending orders. Change delivery dates to control when orders appear in the Check-In flow. <strong>Red dates</strong> are overdue, <strong style="color: #f59e0b;">orange</strong> are today, <strong style="color: #059669;">green</strong> are future.</p>
          </div>

          <!-- Orders List Container -->
          <div id="managePendingOrdersList" style="width: 100%;"></div>
        </div>

        <button class="submit-btn" onclick="goHome()" style="margin-top: 20px;">Back to Menu</button>
      </div>
    </div>
  </div>

<script>
  // ====================================
  // CONFIGURATION & INITIALIZATION
  // ====================================

  const SUPABASE_URL = 'https://gaawtbqpnnbbnsyswqwv.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdhYXd0YnFwbm5iYm5zeXN3cXd2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1MDE1NTAsImV4cCI6MjA3MjA3NzU1MH0.F-y7AIQTWaUe7DRT4OnIZVn94mhXxfhpBbng2aJ8nXg';
  const PACIFIC_TIMEZONE = 'America/Los_Angeles';
  const BOTTLED_SAUCE_ITEMS = [
    { label: 'Spicy Aioli Bottled', aliases: ['spicy aioli bottled', 'spicy aioli - bottled'] },
    { label: 'Tzatziki Bottled', aliases: ['tzatziki bottled', 'tzatziki - bottled'] },
    { label: 'Lemon Vinaigrette Bottled', aliases: ['lemon vinaigrette bottled', 'lemon vinaigrette - bottled'] }
  ];
  let supabase;

  function initializeSupabase() {
    if (SUPABASE_URL === 'YOUR_SUPABASE_URL_HERE' || SUPABASE_ANON_KEY === 'YOUR_SUPABASE_ANON_KEY_HERE') {
      showMessage('Please configure Supabase credentials', 'error');
      return;
    }
    try {
      supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      console.log('‚úÖ Supabase initialized for orders-prep.html');
    } catch (error) {
      console.error('Supabase init failed:', error);
      showMessage('Database connection failed', 'error');
    }
  }

  // ====================================
  // PACIFIC TIME HELPER FUNCTIONS
  // ====================================

  /**
   * Determine the offset (in minutes) for Pacific time at a specific moment.
   */
  function getPacificOffsetMinutes(date) {
    const parts = new Intl.DateTimeFormat('en-US', {
      timeZone: PACIFIC_TIMEZONE,
      timeZoneName: 'short'
    }).formatToParts(date);

    const tzName = parts.find(part => part.type === 'timeZoneName')?.value || 'PST';

    if (tzName.includes('PDT')) return 420; // UTC-7
    if (tzName.includes('PST')) return 480; // UTC-8

    const gmtMatch = tzName.match(/GMT([+-]\d{2})(\d{2})?/i);
    if (gmtMatch) {
      const hours = parseInt(gmtMatch[1], 10);
      const minutes = gmtMatch[2] ? parseInt(gmtMatch[2], 10) : 0;
      return Math.abs(hours) * 60 + minutes;
    }

    return 480; // Default to PST
  }

  /**
   * Create a Date that represents a Pacific-local wall clock time.
   */
  function createPacificDate(year, month, day, hour = 12, minute = 0, second = 0) {
    const utcMillis = Date.UTC(year, month - 1, day, hour, minute, second);
    const tempUtcDate = new Date(utcMillis);
    const offsetMinutes = getPacificOffsetMinutes(tempUtcDate);
    return new Date(utcMillis + offsetMinutes * 60000);
  }

  /**
   * Convert any JS Date into a Pacific-local date (defaulting to midday).
   */
  function getPacificMidday(date = new Date()) {
    const parts = new Intl.DateTimeFormat('en-US', {
      timeZone: PACIFIC_TIMEZONE,
      year: 'numeric',
      month: '2-digit',
      day: '2-digit'
    }).formatToParts(date);

    const year = Number(parts.find(part => part.type === 'year')?.value);
    const month = Number(parts.find(part => part.type === 'month')?.value);
    const day = Number(parts.find(part => part.type === 'day')?.value);

    return createPacificDate(year, month, day, 12, 0, 0);
  }

  /**
   * Parse a YYYY-MM-DD string into a Pacific-local Date (midday).
   */
  function parsePacificDate(dateString) {
    if (!dateString) return null;
    const [year, month, day] = dateString.split('-').map(Number);
    if (!year || !month || !day) return null;
    return createPacificDate(year, month, day, 12, 0, 0);
  }

  /**
   * Format a Date as YYYY-MM-DD in Pacific time.
   */
  function formatPacificDate(date) {
    if (!date) return '';
    const parts = new Intl.DateTimeFormat('en-US', {
      timeZone: PACIFIC_TIMEZONE,
      year: 'numeric',
      month: '2-digit',
      day: '2-digit'
    }).formatToParts(date);

    const year = parts.find(part => part.type === 'year')?.value;
    const month = parts.find(part => part.type === 'month')?.value;
    const day = parts.find(part => part.type === 'day')?.value;

    return `${year}-${month}-${day}`;
  }

  /**
   * Format helper for display strings while forcing Pacific timezone.
   */
  function formatPacificDateDisplay(date, options = {}) {
    if (!date) return '';
    return new Intl.DateTimeFormat('en-US', {
      timeZone: PACIFIC_TIMEZONE,
      ...options
    }).format(date);
  }

  function formatPacificWeekday(date) {
    return formatPacificDateDisplay(date, { weekday: 'long' });
  }

  function getPacificHour(date) {
    if (!date) return null;
    const hourString = new Intl.DateTimeFormat('en-US', {
      timeZone: PACIFIC_TIMEZONE,
      hour: '2-digit',
      hour12: false
    }).format(date);
    return Number(hourString);
  }

  /**
   * Add days to a Pacific Date and return the normalized Pacific midday Date.
   */
  function addPacificDays(date, days) {
    if (!date) return null;
    const pacificMidday = getPacificMidday(date);
    const nextUtc = new Date(pacificMidday.getTime() + days * 86400000);
    return getPacificMidday(nextUtc);
  }

  /**
   * Return the current Pacific date as YYYY-MM-DD.
   */
  function getPacificDate(date = new Date()) {
    return formatPacificDate(date);
  }

  // ====================================
  // ORDERING SYSTEM HELPER FUNCTIONS
  // ====================================

  /**
   * Check if an item should be in bottled/to-go section
   */
  function isBottledOrToGoItem(itemName) {
    const name = (itemName || '').trim().toLowerCase();
    // Check if it's in the bottled sauce list
    const isBottled = BOTTLED_SAUCE_ITEMS.some(config =>
      config.aliases.some(alias => name.includes(alias))
    );
    // Check if it has "to go" or "to-go" in the name
    const isToGo = name.includes('to go') || name.includes('to-go');
    return isBottled || isToGo;
  }

  /**
   * Format relative time (e.g., "15 mins ago", "2 hours ago")
   */
  function formatRelativeTime(dateStr) {
    if (!dateStr) return 'Never';

    const date = parsePacificDate(dateStr) || new Date(dateStr);
    const now = new Date();

    const diffMs = now - date;
    const diffMinutes = Math.floor(diffMs / (1000 * 60));
    const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

    if (diffMinutes < 60) {
      const minutes = Math.max(diffMinutes, 0);
      return `${minutes} min${minutes === 1 ? '' : 's'} ago`;
    }

    if (diffHours < 24) {
      const hours = diffHours;
      const minutes = diffMinutes % 60;
      if (minutes > 0) {
        return `${hours} hour${hours === 1 ? '' : 's'} and ${minutes} min${minutes === 1 ? '' : 's'} ago`;
      } else {
        return `${hours} hour${hours === 1 ? '' : 's'} ago`;
      }
    }

    // More than 24 hours: show days
    const hours = diffHours % 24;
    if (hours > 0) {
      return `${diffDays} day${diffDays === 1 ? '' : 's'} and ${hours} hour${hours === 1 ? '' : 's'} ago`;
    } else {
      return `${diffDays} day${diffDays === 1 ? '' : 's'} ago`;
    }
  }

  /**
   * Format last count for prep sheet PDF
   * Returns: "Last Counted 1 day, 3 hours, 14 minutes ago on 1/7/26 at 10:45pm"
   */
  function formatLastCountForPrepSheet(dateStr, countedBy) {
    if (!dateStr) return 'Never counted';

    const date = parsePacificDate(dateStr) || new Date(dateStr);
    const now = new Date();

    const diffMs = now - date;
    const diffMinutes = Math.floor(diffMs / (1000 * 60));
    const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

    // Calculate remaining hours and minutes
    const remainingHours = diffHours % 24;
    const remainingMinutes = diffMinutes % 60;

    // Build time elapsed string with all components
    let timeElapsed = 'Last Counted ';
    const parts = [];

    if (diffDays > 0) {
      parts.push(`${diffDays} day${diffDays === 1 ? '' : 's'}`);
    }
    if (remainingHours > 0 || diffDays > 0) { // Include hours if we have days
      parts.push(`${remainingHours} hour${remainingHours === 1 ? '' : 's'}`);
    }
    parts.push(`${remainingMinutes} minute${remainingMinutes === 1 ? '' : 's'}`);

    timeElapsed += parts.join(', ') + ' ago';

    // Format the date and time
    const formattedDate = date.toLocaleDateString('en-US', {
      month: 'numeric',
      day: 'numeric',
      year: '2-digit'
    });

    const formattedTime = date.toLocaleTimeString('en-US', {
      hour: 'numeric',
      minute: '2-digit',
      hour12: true
    }).toLowerCase();

    // Build final string
    if (countedBy) {
      return `${timeElapsed} by ${countedBy} on ${formattedDate} at ${formattedTime}`;
    } else {
      return `${timeElapsed} on ${formattedDate} at ${formattedTime}`;
    }
  }

  /**
   * Format price with date (e.g., "$12.50 (11/3/25)")
   */
  function formatPriceWithDate(price, dateStr) {
    if (!price) return '';

    const formattedPrice = '$' + parseFloat(price).toFixed(2);

    if (!dateStr) return formattedPrice;

    const pacificDate = parsePacificDate(dateStr) || new Date(dateStr);
    const formattedDate = pacificDate
      ? formatPacificDateDisplay(pacificDate, { month: 'numeric', day: 'numeric', year: '2-digit' })
      : '';

    return `${formattedPrice} (${formattedDate})`;
  }

  // ====================================
  // HELPER FUNCTIONS
  // ====================================

  function showLoading(title, message) {
    const existingOverlay = document.getElementById('loadingOverlay');
    if (existingOverlay) {
      existingOverlay.style.display = 'flex';
      return;
    }

    const overlayHTML = `
      <div id="loadingOverlay" style="
        display: flex;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        z-index: 9999;
        justify-content: center;
        align-items: center;
      ">
        <div style="text-align: center;">
          <!-- Logo Container with Pulse + Glow Effect -->
          <div style="position: relative; width: 150px; height: 150px; margin: 0 auto;">
            <!-- Animated glowing rings -->
            <div style="
              position: absolute;
              top: 50%;
              left: 50%;
              transform: translate(-50%, -50%);
              width: 150px;
              height: 150px;
              border-radius: 50%;
              border: 3px solid rgba(0, 123, 255, 0.6);
              animation: pulseRing 2s ease-out infinite;
            "></div>

            <div style="
              position: absolute;
              top: 50%;
              left: 50%;
              transform: translate(-50%, -50%);
              width: 150px;
              height: 150px;
              border-radius: 50%;
              border: 3px solid rgba(0, 123, 255, 0.4);
              animation: pulseRing 2s ease-out infinite 0.5s;
            "></div>

            <!-- Main logo with pulse + rotation -->
            <img src="jayna-logo-loading.png" alt="Jayna Logo" style="
              width: 120px;
              height: 120px;
              position: absolute;
              top: 50%;
              left: 50%;
              transform: translate(-50%, -50%);
              animation: logoFloat 3s ease-in-out infinite, logoGlow 2s ease-in-out infinite;
              filter: drop-shadow(0 0 20px rgba(0, 123, 255, 0.8));
              border-radius: 50%;
            ">
          </div>
        </div>
      </div>

      <style>
        @keyframes pulseRing {
          0% {
            transform: translate(-50%, -50%) scale(0.8);
            opacity: 1;
          }
          100% {
            transform: translate(-50%, -50%) scale(1.4);
            opacity: 0;
          }
        }

        @keyframes logoFloat {
          0%, 100% {
            transform: translate(-50%, -50%) scale(1) rotate(0deg);
          }
          50% {
            transform: translate(-50%, -50%) scale(1.1) rotate(5deg);
          }
        }

        @keyframes logoGlow {
          0%, 100% {
            filter: drop-shadow(0 0 20px rgba(0, 123, 255, 0.8)) brightness(1);
          }
          50% {
            filter: drop-shadow(0 0 40px rgba(0, 200, 255, 1)) brightness(1.2);
          }
        }
      </style>
    `;
    document.body.insertAdjacentHTML('beforeend', overlayHTML);
  }

  function hideLoading() {
    const overlay = document.getElementById('loadingOverlay');
    if (overlay) {
      overlay.style.display = 'none';
    }
  }

  // ====================================
  // UNIVERSAL MODAL HELPER FUNCTIONS
  // ====================================

  function showMessage(message, type = 'info') {
    // Remove existing message if any
    const existing = document.getElementById('inlineMessageOverlay');
    if (existing) existing.remove();

    // Create overlay
    const overlay = document.createElement('div');
    overlay.id = 'inlineMessageOverlay';
    overlay.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100000;
      padding: 20px;
    `;

    // Create message box
    const box = document.createElement('div');
    const colors = {
      success: { bg: 'var(--success-bg)', text: 'var(--success-text)', border: 'var(--success-border)' },
      error: { bg: 'var(--error-bg)', text: 'var(--error-text)', border: 'var(--error-border)' },
      warning: { bg: 'var(--warning-bg)', text: 'var(--warning-text)', border: 'var(--warning-border)' },
      info: { bg: 'var(--blue-bg)', text: 'var(--blue-text)', border: 'var(--blue-text)' }
    };
    const color = colors[type] || colors.info;

    box.style.cssText = `
      background: white;
      padding: 24px;
      max-width: 500px;
      width: 100%;
      border: 3px solid ${color.border};
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    `;

    const messageEl = document.createElement('div');
    messageEl.textContent = message;
    messageEl.style.cssText = `
      font-size: 14px;
      line-height: 1.6;
      color: ${color.text};
      margin-bottom: 20px;
      white-space: pre-line;
    `;

    const okBtn = document.createElement('button');
    okBtn.textContent = 'OK';
    okBtn.style.cssText = `
      width: 100%;
      padding: 12px 24px;
      background: var(--gray-900);
      color: white;
      border: 2px solid var(--gray-900);
      font-size: 13px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      cursor: pointer;
    `;
    okBtn.onclick = () => overlay.remove();

    box.appendChild(messageEl);
    box.appendChild(okBtn);
    overlay.appendChild(box);
    document.body.appendChild(overlay);

    // Close on overlay click
    overlay.addEventListener('click', (e) => {
      if (e.target === overlay) overlay.remove();
    });
  }

  function showConfirm(message, onConfirm, onCancel = null) {
    // Remove existing confirm if any
    const existing = document.getElementById('inlineConfirmOverlay');
    if (existing) existing.remove();

    // Create overlay
    const overlay = document.createElement('div');
    overlay.id = 'inlineConfirmOverlay';
    overlay.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100000;
      padding: 20px;
    `;

    // Create message box
    const box = document.createElement('div');
    box.style.cssText = `
      background: white;
      padding: 24px;
      max-width: 500px;
      width: 100%;
      border: 3px solid var(--warning-border);
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    `;

    const messageEl = document.createElement('div');
    messageEl.textContent = message;
    messageEl.style.cssText = `
      font-size: 14px;
      line-height: 1.6;
      color: var(--gray-900);
      margin-bottom: 20px;
      white-space: pre-line;
    `;

    const buttonContainer = document.createElement('div');
    buttonContainer.style.cssText = `
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    `;

    const cancelBtn = document.createElement('button');
    cancelBtn.textContent = 'CANCEL';
    cancelBtn.style.cssText = `
      padding: 12px 24px;
      background: var(--gray-100);
      color: var(--gray-900);
      border: 2px solid var(--gray-300);
      font-size: 13px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      cursor: pointer;
    `;
    cancelBtn.onclick = () => {
      overlay.remove();
      if (onCancel) onCancel();
    };

    const confirmBtn = document.createElement('button');
    confirmBtn.textContent = 'OK';
    confirmBtn.style.cssText = `
      padding: 12px 24px;
      background: #dc2626;
      color: white;
      border: 2px solid #dc2626;
      font-size: 13px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      cursor: pointer;
    `;
    confirmBtn.onclick = () => {
      overlay.remove();
      if (onConfirm) onConfirm();
    };

    buttonContainer.appendChild(cancelBtn);
    buttonContainer.appendChild(confirmBtn);
    box.appendChild(messageEl);
    box.appendChild(buttonContainer);
    overlay.appendChild(box);
    document.body.appendChild(overlay);

    // Close on overlay click = cancel
    overlay.addEventListener('click', (e) => {
      if (e.target === overlay) {
        overlay.remove();
        if (onCancel) onCancel();
      }
    });
  }

  function showPrompt(message, defaultValue = '', onSubmit, onCancel = null) {
    // Remove existing prompt if any
    const existing = document.getElementById('inlinePromptOverlay');
    if (existing) existing.remove();

    // Create overlay
    const overlay = document.createElement('div');
    overlay.id = 'inlinePromptOverlay';
    overlay.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100000;
      padding: 20px;
    `;

    // Create message box
    const box = document.createElement('div');
    box.style.cssText = `
      background: white;
      padding: 24px;
      max-width: 500px;
      width: 100%;
      border: 3px solid var(--gray-700);
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    `;

    const messageEl = document.createElement('div');
    messageEl.textContent = message;
    messageEl.style.cssText = `
      font-size: 14px;
      line-height: 1.6;
      color: var(--gray-900);
      margin-bottom: 12px;
      font-weight: 600;
    `;

    const input = document.createElement('input');
    input.type = 'text';
    input.value = defaultValue;
    input.style.cssText = `
      width: 100%;
      padding: 12px;
      border: 2px solid var(--gray-300);
      font-size: 14px;
      margin-bottom: 20px;
      box-sizing: border-box;
    `;

    const buttonContainer = document.createElement('div');
    buttonContainer.style.cssText = `
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    `;

    const cancelBtn = document.createElement('button');
    cancelBtn.textContent = 'CANCEL';
    cancelBtn.style.cssText = `
      padding: 12px 24px;
      background: var(--gray-100);
      color: var(--gray-900);
      border: 2px solid var(--gray-300);
      font-size: 13px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      cursor: pointer;
    `;
    cancelBtn.onclick = () => {
      overlay.remove();
      if (onCancel) onCancel();
    };

    const submitBtn = document.createElement('button');
    submitBtn.textContent = 'OK';
    submitBtn.style.cssText = `
      padding: 12px 24px;
      background: var(--gray-900);
      color: white;
      border: 2px solid var(--gray-900);
      font-size: 13px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      cursor: pointer;
    `;
    submitBtn.onclick = () => {
      const value = input.value.trim();
      overlay.remove();
      if (onSubmit) onSubmit(value);
    };

    // Allow Enter key to submit
    input.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        submitBtn.click();
      }
    });

    buttonContainer.appendChild(cancelBtn);
    buttonContainer.appendChild(submitBtn);
    box.appendChild(messageEl);
    box.appendChild(input);
    box.appendChild(buttonContainer);
    overlay.appendChild(box);
    document.body.appendChild(overlay);

    // Focus input
    setTimeout(() => input.focus(), 100);

    // Close on overlay click = cancel
    overlay.addEventListener('click', (e) => {
      if (e.target === overlay) {
        overlay.remove();
        if (onCancel) onCancel();
      }
    });
  }

  function hideAllSections() {
    // For orders-prep.html, we only have one section, so this is a no-op
    // But we need it defined because ordering system code calls it
  }

  function goHome() {
    // Reload current page to refresh data
    window.location.href = 'orders-prep.html';
  }

  // ====================================
  // ORDERING SYSTEM - START
  // ====================================

  /**
   * @typedef {Object} InventoryItem
   * @property {number} id - Database ID
   * @property {string} itemName - Full name with packaging
   * @property {string} vendor - Vendor name
   * @property {number} parLevel - Target stock level
   * @property {number} currentStock - Current on-hand quantity
   * @property {string} unit - Unit of measurement (CS, EA, LB, etc.)
   * @property {string} [lastCountedDate] - Last stock count date
   */

  /**
   * @typedef {Object} CalculatedOrder
   * @property {string} vendor - Vendor name
   * @property {Date} orderDate - When to place order
   * @property {string} cutoffTime - Order deadline
   * @property {Date} deliveryDate - Expected delivery
   * @property {OrderItem[]} items - Items to order
   * @property {string} [notes] - Special instructions
   */

  /**
   * @typedef {Object} OrderItem
   * @property {string} itemName - Item name
   * @property {number} quantity - Quantity to order
   * @property {string} unit - Unit of measurement
   * @property {number} parLevel - Par level for reference
   * @property {number} currentStock - Current stock for reference
   */

  /**
   * Global state for ordering system
   */
  const orderingSystemState = {
    items: [],
    calculatedOrders: [],
    currentTab: 'upcomingOrders',
    lastUpdated: null,
    pendingStockUpdates: new Map(), // Track unsaved stock updates
    currentCountSession: 'morning_prep', // Track current prep count session
    previousCounts: new Map(), // Track previous counts for consumption calculation (itemId -> {count, session})
    prepRecommendations: [], // Store current prep recommendations for print/PDF
    // Invoice system state
    currentInvoiceImage: null,
    extractedInvoiceItems: [],
    invoiceType: 'invoice', // 'invoice' or 'order'
    selectedPendingOrderId: null, // For reconciliation against pending order
    // Price history drill-down state
    priceHistory: {
      selectedItemIds: new Set(),
      results: [],
      lastFetchParams: null,
      cache: new Map(),
      initialized: false
    }
  };

  /**
   * PREP COUNTING STAFF TRACKING SYSTEM
   * Similar to FOH checklists - track who counts prep items with timestamp
   */
  const prepCountingState = {
    clockedInEmployees: [],
    teamNames: [], // Array of {name: string, color: string}
    activeUserIndex: 0, // Index of currently active user
    activeUserTimeout: null, // Timeout to reset to default user after 30 minutes
    lastFetched: null // Last time clocked-in employees were fetched
  };

  // User color palette (same as FOH checklists)
  const USER_COLORS = [
    '#0094D6', // Blue
    '#00C853', // Green
    '#FFB300', // Orange
    '#9C27B0', // Purple
    '#F44336', // Red
    '#00BCD4', // Cyan
    '#FF9800', // Deep Orange
    '#4CAF50'  // Lime Green
  ];

  /**
   * Get color for user by index
   */
  function getUserColor(index) {
    return USER_COLORS[index % USER_COLORS.length];
  }

  /**
   * Set active user with 30-minute timeout
   */
  function setActivePrepCounter(index) {
    prepCountingState.activeUserIndex = index;

    // Clear existing timeout
    if (prepCountingState.activeUserTimeout) {
      clearTimeout(prepCountingState.activeUserTimeout);
    }

    // Set new timeout to reset to first user after 30 minutes
    prepCountingState.activeUserTimeout = setTimeout(() => {
      prepCountingState.activeUserIndex = 0;
      console.log('‚è∞ Prep counter timeout - reset to default user');
    }, 1800000); // 30 minutes (30 * 60 * 1000 ms)
  }

  /**
   * Cycle to next prep counter
   */
  function cycleToNextPrepCounter() {
    if (prepCountingState.teamNames.length === 0) return;
    const nextIndex = (prepCountingState.activeUserIndex + 1) % prepCountingState.teamNames.length;
    setActivePrepCounter(nextIndex);
    console.log(`üë§ Switched to prep counter: ${getActivePrepCounterName()}`);
    // Update the display to show new counter name
    updatePrepCounterDisplay();
  }

  /**
   * Update the prep counter display UI with current active user
   */
  function updatePrepCounterDisplay() {
    const nameElement = document.getElementById('prepCounterName');
    const dotElement = document.getElementById('prepCounterColorDot');

    if (nameElement) {
      const activeName = getActivePrepCounterName();
      nameElement.textContent = activeName;
      console.log(`üìù Updated prep counter display: ${activeName}`);
    }

    if (dotElement) {
      const activeColor = getActivePrepCounterColor();
      dotElement.style.background = activeColor;
    }
  }

  /**
   * Get active prep counter name
   */
  function getActivePrepCounterName() {
    if (prepCountingState.teamNames.length === 0) return 'Unknown';
    return prepCountingState.teamNames[prepCountingState.activeUserIndex]?.name || 'Unknown';
  }

  /**
   * Get active prep counter color
   */
  function getActivePrepCounterColor() {
    if (prepCountingState.teamNames.length === 0) return getUserColor(0);
    return prepCountingState.teamNames[prepCountingState.activeUserIndex]?.color || getUserColor(0);
  }

  /**
   * Change Prep Item User - Cycle through team members for a counted item
   * (Same pattern as FOH checklists' changeTaskUser)
   */
  async function changePrepItemUser(itemId) {
    const item = orderingSystemState.items.find(i => i.id === itemId);
    if (!item || !item.countedBy) return;

    // Ensure teamNames includes all clocked-in employees
    if (prepCountingState.clockedInEmployees.length > 0) {
      if (prepCountingState.teamNames.length < prepCountingState.clockedInEmployees.length) {
        prepCountingState.teamNames = prepCountingState.clockedInEmployees.map((name, index) => ({
          name: name,
          color: getUserColor(index)
        }));
      }
    }

    if (prepCountingState.teamNames.length === 0) {
      showMessage('No team members available to cycle through', 'error');
      return;
    }

    // Find current user index
    const currentUserIndex = prepCountingState.teamNames.findIndex(u => u.name === item.countedBy);

    // Cycle to next user
    const nextUserIndex = (currentUserIndex + 1) % prepCountingState.teamNames.length;
    const nextUser = prepCountingState.teamNames[nextUserIndex];

    try {
      const newTimestamp = new Date().toISOString();

      // Update item in database
      const { error } = await supabase
        .from('inventory_items')
        .update({
          counted_by: nextUser.name,
          counted_at: newTimestamp
        })
        .eq('id', itemId);

      if (error) throw error;

      // CRITICAL: Also update the prep_count_log to give credit to the correct person
      // Find the most recent log entry for this item and update it
      const { data: logEntries, error: logFetchError } = await supabase
        .from('prep_count_log')
        .select('id')
        .eq('item_id', itemId)
        .order('counted_at', { ascending: false })
        .limit(1);

      if (!logFetchError && logEntries && logEntries.length > 0) {
        const logId = logEntries[0].id;
        await supabase
          .from('prep_count_log')
          .update({
            counted_by: nextUser.name,
            counted_at: newTimestamp
          })
          .eq('id', logId);
        console.log(`‚úÖ Updated prep_count_log for leaderboard: ${nextUser.name}`);
      }

      // Update local state
      item.countedBy = nextUser.name;
      item.countedAt = newTimestamp;

      // Set this as active user
      setActivePrepCounter(nextUserIndex);

      // Re-render prep count list to show new user
      renderPrepCountList();

      console.log(`‚úèÔ∏è Changed prep item user to: ${nextUser.name}`);

    } catch (error) {
      console.error('Error changing prep item user:', error);
      showMessage('Failed to change user', 'error');
    }
  }

  /**
   * Fetch Currently Clocked-In Employees from Toast API for prep counting
   */
  async function fetchClockedInEmployeesForPrep() {
    try {
      // Get TODAY in YYYY-MM-DD format (Pacific time)
      const todayPacific = new Date().toLocaleString('en-US', {
        timeZone: 'America/Los_Angeles',
        year: 'numeric',
        month: '2-digit',
        day: '2-digit'
      });

      const [month, day, year] = todayPacific.split(', ')[0].split('/');
      const today = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;

      console.log('üë• Fetching clocked-in employees from Toast for prep counting:', today);

      // STEP 1: Authenticate with Toast API
      const authResponse = await fetch('/api/toast-auth', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      });

      if (!authResponse.ok) {
        console.error('‚ùå Failed to authenticate with Toast API');
        prepCountingState.clockedInEmployees = [];
        return;
      }

      const authData = await authResponse.json();
      if (!authData.success || !authData.data?.accessToken) {
        console.error('‚ùå Toast authentication failed');
        prepCountingState.clockedInEmployees = [];
        return;
      }

      const token = authData.data.accessToken;

      // STEP 2: Fetch clocked-in employees via serverless function (same as FOH checklists)
      const clockedInUrl = `/api/toast-clocked-in?date=${today}&token=${encodeURIComponent(token)}`;

      console.log('üîç Fetching clocked-in employees from serverless function');

      const response = await fetch(clockedInUrl);

      if (!response.ok) {
        console.error('‚ùå Failed to fetch clocked-in employees:', response.status);
        prepCountingState.clockedInEmployees = [];
        return;
      }

      const result = await response.json();

      if (!result.success) {
        console.error('‚ùå Clocked-in API error:', result.error);
        prepCountingState.clockedInEmployees = [];
        return;
      }

      console.log(`üìä Total time entries today: ${result.totalTimeEntries}`);
      console.log(`üü¢ Currently clocked in: ${result.count} employees`);

      if (result.clockedIn.length > 0) {
        console.log('‚úÖ Clocked in employees:', result.clockedIn);
      }

      // Extract first names only (same pattern as FOH checklists)
      const clockedInList = result.clockedIn
        .map(emp => {
          const fullName = emp.fullName || emp.name || 'Unknown';
          const firstName = fullName.split(' ')[0]; // Get first name only
          return firstName;
        })
        .filter(name => name) // Remove any nulls/undefined
        .sort();

      prepCountingState.clockedInEmployees = clockedInList;

      // Update teamNames array
      if (clockedInList.length > 0) {
        prepCountingState.teamNames = clockedInList.map((name, index) => ({
          name: name,
          color: getUserColor(index)
        }));
        // Keep current active index if valid, otherwise reset to 0
        if (prepCountingState.activeUserIndex >= prepCountingState.teamNames.length) {
          prepCountingState.activeUserIndex = 0;
        }
      } else {
        // No clocked-in employees - set default user
        prepCountingState.teamNames = [{ name: 'Unknown', color: getUserColor(0) }];
        prepCountingState.activeUserIndex = 0;
      }

      prepCountingState.lastFetched = new Date();
      console.log(`‚úÖ Found ${clockedInList.length} clocked-in employees for prep counting:`, clockedInList);

      // Update the UI display
      updatePrepCounterDisplay();

    } catch (error) {
      console.error('‚ùå Error fetching clocked-in employees for prep:', error);
      prepCountingState.clockedInEmployees = [];
      // Set default user on error
      prepCountingState.teamNames = [{ name: 'Unknown', color: getUserColor(0) }];
      prepCountingState.activeUserIndex = 0;

      // Update the UI display even on error
      updatePrepCounterDisplay();
    }
  }

  /**
   * Print Ordering Guide PDF for vendors (sends to printer via email)
   */
  async function downloadOrderingGuide(vendor) {
    try {
      // Ensure inventory data is loaded
      if (!orderingSystemState.items || orderingSystemState.items.length === 0) {
        showMessage('Loading inventory data...', 'info');
        await loadInventoryData();
      }

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'letter' });

      const vendorNames = {
        'greenleaf': 'Greenleaf',
        'performance': 'Performance',
        'mani': 'Mani'
      };

      const vendorName = vendorNames[vendor] || vendor;
      const today = new Date().toLocaleDateString('en-US', {
        month: 'long',
        day: 'numeric',
        year: 'numeric'
      });

      // Header
      doc.setFontSize(14);
      doc.setFont('helvetica', 'bold');
      doc.text(`${vendorName} - Complete Inventory Reference`, 40, 40);

      doc.setFontSize(8);
      doc.setFont('helvetica', 'normal');
      doc.text('Quick reference list of all items in inventory', 40, 55);

      // Filter inventory items by vendor
      const vendorItems = orderingSystemState.items.filter(item => {
        const itemVendor = (item.vendor || '').toLowerCase();
        const targetVendor = vendor.toLowerCase();
        return itemVendor === targetVendor || itemVendor.includes(targetVendor);
      });

      // Sort by item name
      vendorItems.sort((a, b) => (a.itemName || '').localeCompare(b.itemName || ''));

      // Prepare table data with very compact info
      const inventoryTableData = vendorItems.map(item => {
        const lastCounted = item.lastCountedDate
          ? new Date(item.lastCountedDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: '2-digit' })
          : 'Never';

        return [
          item.itemName || 'N/A',
          `${item.currentStock || 0} ${item.unit || ''}`,
          item.parLevel || 0,
          lastCounted
        ];
      });

      // If no items found, show message
      if (inventoryTableData.length === 0) {
        doc.setFontSize(10);
        doc.text(`No inventory items found for ${vendorName}`, 40, 80);
      } else {
        doc.autoTable({
          head: [['ITEM NAME', 'CURRENT STOCK', 'PAR', 'LAST COUNT']],
          body: inventoryTableData,
          startY: 70,
          theme: 'grid',
          styles: {
            fontSize: 7,
            cellPadding: 3,
            lineColor: [200, 200, 200],
            lineWidth: 0.3
          },
          headStyles: {
            fillColor: [100, 100, 100],
            textColor: 255,
            fontStyle: 'bold',
            fontSize: 7,
            halign: 'center'
          },
          columnStyles: {
            0: { cellWidth: 280 },                    // ITEM NAME
            1: { cellWidth: 90, halign: 'center' },   // CURRENT STOCK
            2: { cellWidth: 50, halign: 'center' },   // PAR
            3: { cellWidth: 80, halign: 'center' }    // LAST COUNT
          },
          margin: { left: 40, right: 40, bottom: 40 }
        });

        // Add item count at bottom
        const finalY = doc.lastAutoTable.finalY || 500;
        doc.setFontSize(8);
        doc.setFont('helvetica', 'italic');
        doc.text(
          `Total: ${inventoryTableData.length} items in inventory`,
          40,
          finalY + 15
        );
      }

      // Footer for all pages
      const pageCount = doc.internal.getNumberOfPages();
      for (let i = 1; i <= pageCount; i++) {
        doc.setPage(i);
        doc.setFontSize(8);
        doc.setFont('helvetica', 'normal');
        doc.text(
          `Page ${i} of ${pageCount}`,
          doc.internal.pageSize.width / 2,
          doc.internal.pageSize.height - 20,
          { align: 'center' }
        );
      }

      // Convert PDF to base64 for email attachment
      const pdfBase64 = doc.output('datauristring').split(',')[1];
      const filename = `${vendorName}_Ordering_Guide_${new Date().toISOString().split('T')[0]}.pdf`;

      // Show loading message
      showMessage('Sending to printer...', 'info');

      // Send to printer via backend API (nodemailer + Gmail)
      const response = await fetch('/api/send-ordering-guide-email', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          pdfBase64: pdfBase64,
          filename: filename
        })
      });

      const result = await response.json();

      if (!response.ok) {
        throw new Error(result.error || 'Failed to send to printer');
      }

      showMessage(`‚úÖ ${vendorName} ordering guide sent to printer!`, 'success');
      console.log(`‚úì Sent ${vendorName} ordering guide to printer`);

    } catch (error) {
      console.error('Error sending ordering guide to printer:', error);
      showMessage(`Error sending to printer: ${error.message}`, 'error');
    }
  }

  /**
   * Start the ordering system
   */
  async function startOrderingSystem() {
    // Keep main menu visible at top
    hideAllSections();
    document.getElementById('orderingSystemForm').classList.add('active');

    // Load data AFTER form is visible (same pattern as startPMCount)
    try {
      await loadInventoryData();
      await fetchClockedInEmployeesForPrep(); // Load clocked-in staff for prep counting
      calculateUpcomingOrders();
      await refreshUpcomingOrdersUI();
      await refreshUpcomingOrdersUI();
      renderInventoryList();
      renderStockCountList();
      renderPrepCountList(); // Render PREP items in PREP tab
      await updateCountSessionDisplay(); // Auto-detect and display current count session
    } catch (error) {
      console.error('Error loading ordering system data:', error);
      showMessage(`Error: ${error.message}`, 'error');
    }
  }

  /**
   * Switch between tabs
   */
  function openOrderTab(event, tabName) {
    console.log('openOrderTab:', tabName);

    // Hide all tab contents
    const tabContents = document.querySelectorAll('.tab-content');
    tabContents.forEach(content => content.style.display = 'none');

    // Remove active class from all tab links
    const tabLinks = document.querySelectorAll('.tab-link');
    tabLinks.forEach(link => {
      link.style.background = 'var(--gray-100)';
      link.style.color = 'var(--gray-700)';
    });

    // Show selected tab and mark button as active
    document.getElementById(tabName).style.display = 'block';
    if (event && event.target) {
      event.target.style.background = 'var(--gray-700)';
      event.target.style.color = 'white';
    }

    orderingSystemState.currentTab = tabName;

    // Auto-refresh prep sheet and count session when tab is opened
    if (tabName === 'prepSheet') {
      checkAutoPrintStatus(); // Check if prep list was auto-printed at 4am
      refreshPrepSheet();
      updateCountSessionDisplay(); // Update session info each time PREP tab is opened
      refreshBottleCount(); // Refresh bottle count display
      fetchClockedInEmployeesForPrep(); // Refresh clocked-in employees for prep counting
    }

    // Load both pending orders AND AI suggestions when ORDERS tab is opened
    if (tabName === 'upcomingOrders') {
      renderOrdersTab();
    }

    if (tabName === 'priceHistory') {
      if (!orderingSystemState.priceHistory.initialized) {
        initializePriceHistoryTab();
      } else {
        refreshPriceHistoryControls();
      }
    }

    // Load orders due today alert when CHECK-IN tab is opened
  if (tabName === 'checkInInvoice') {
    loadOrdersDueTodayAlert();
    renderReceivePendingOrders();
  }
  }

  /**
   * Render complete ORDERS tab (pending orders + AI suggestions)
   */
async function renderOrdersTab() {
  const container = document.getElementById('upcomingOrders');
  container.innerHTML = '<div style="text-align: center; padding: 40px;"><p style="color: var(--gray-500);">Loading...</p></div>';

    // Create wrapper for both sections
    const wrapper = document.createElement('div');

    // Section 1: Pending Orders
    const pendingSection = document.createElement('div');
    pendingSection.id = 'pendingOrdersSection';
    wrapper.appendChild(pendingSection);

    // Section 2: AI Suggestions
    const aiSection = document.createElement('div');
    aiSection.id = 'aiSuggestionsSection';
    aiSection.style.cssText = 'margin-top: 40px;';
    wrapper.appendChild(aiSection);

    // Replace container content
    container.innerHTML = '';
    container.appendChild(wrapper);

    // Load both sections
    await renderPendingOrders(pendingSection);
    calculateUpcomingOrders();
    await refreshUpcomingOrdersUI(aiSection); // Ensure price snapshots before rendering suggestions
  }

  /**
   * Render pending orders section
   */
  async function renderPendingOrders(targetContainer) {
    const container = targetContainer || document.getElementById('pendingOrdersSection');
    console.log('Rendering pending orders...');

    // Show loading state (only if no target container provided)
    container.innerHTML = '<div style="text-align: center; padding: 40px;"><p style="color: var(--gray-500);">Loading pending orders...</p></div>';

    try {
      // Fetch all pending orders
      const { data: orders, error } = await supabase
        .from('pending_orders')
        .select(`
          *,
          pending_order_items (
            id,
            inventory_item_id,
            quantity_ordered,
            unit,
            item_name,
            quantity_received,
            variance
          )
        `)
        .in('status', ['pending', 'partial'])
        .order('expected_delivery_date', { ascending: true });

      if (error) throw error;

      console.log('Loaded pending orders:', orders?.length || 0);

      const priceItemIds = [];
      (orders || []).forEach(order => {
        (order.pending_order_items || []).forEach(item => {
          if (item && item.inventory_item_id != null) {
            priceItemIds.push(item.inventory_item_id);
          }
        });
      });
      if (priceItemIds.length) {
        await ensurePriceSnapshotsForItems(priceItemIds);
      }

      // Clear container
      container.innerHTML = '';

      // Add section header
      const header = document.createElement('div');
      header.style.cssText = 'margin-bottom: 20px; padding-bottom: 12px; border-bottom: 3px solid var(--gray-300);';

      const title = document.createElement('h3');
      title.textContent = 'PENDING ORDERS';
      title.style.cssText = 'color: var(--gray-900); margin: 0; font-size: 18px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;';
      header.appendChild(title);

      const subtitle = document.createElement('p');
      subtitle.textContent = 'Orders you\'ve created that are awaiting delivery';
      subtitle.style.cssText = 'color: var(--gray-600); font-size: 12px; margin: 8px 0 0 0;';
      header.appendChild(subtitle);

      container.appendChild(header);

      // Add action buttons for PDF and Email
      const buttonsDiv = document.createElement('div');
      buttonsDiv.style.cssText = 'display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap;';

      // Create DOWNLOAD PDF button with direct onclick assignment
      const downloadPdfBtn = document.createElement('button');
      downloadPdfBtn.className = 'submit-btn';
      downloadPdfBtn.style.cssText = 'background: #808080; color: white; flex: 1; min-width: 150px; padding: 12px; font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; border: none; cursor: pointer;';
      downloadPdfBtn.textContent = 'DOWNLOAD PDF';
      downloadPdfBtn.onclick = () => generatePendingOrdersPDF();
      buttonsDiv.appendChild(downloadPdfBtn);

      // Create EMAIL TO PRINTER button with direct onclick assignment
      const emailPrinterBtn = document.createElement('button');
      emailPrinterBtn.className = 'submit-btn';
      emailPrinterBtn.style.cssText = 'background: #808080; color: white; flex: 1; min-width: 150px; padding: 12px; font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; border: none; cursor: pointer;';
      emailPrinterBtn.textContent = 'EMAIL TO PRINTER';
      emailPrinterBtn.onclick = () => emailPendingOrdersToPrinter();
      buttonsDiv.appendChild(emailPrinterBtn);

      container.appendChild(buttonsDiv);

      // Group orders by delivery status
      const today = getPacificDate(); // Pacific Time, not UTC
      const ordersToday = orders?.filter(o => o.expected_delivery_date === today) || [];
      const ordersUpcoming = orders?.filter(o => o.expected_delivery_date > today) || [];
      const ordersPast = orders?.filter(o => o.expected_delivery_date < today) || [];

      // Alert for orders due today
      if (ordersToday.length > 0) {
        const alert = document.createElement('div');
        alert.style.cssText = 'background: #fef3c7; border: 2px solid #f59e0b; padding: 16px; margin-bottom: 24px;';

        const alertTitle = document.createElement('h4');
        alertTitle.textContent = `‚ö†Ô∏è ${ordersToday.length} ORDER(S) DUE TODAY`;
        alertTitle.style.cssText = 'color: #92400e; margin: 0 0 8px 0; font-size: 14px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;';
        alert.appendChild(alertTitle);

        const alertText = document.createElement('p');
        alertText.textContent = 'Check in these orders in the CHECK-IN tab when they arrive.';
        alertText.style.cssText = 'color: #78350f; margin: 0; font-size: 12px;';
        alert.appendChild(alertText);

        container.appendChild(alert);
      }

      // Alert for overdue orders
      if (ordersPast.length > 0) {
        const alert = document.createElement('div');
        alert.style.cssText = 'background: #fee2e2; border: 2px solid #ef4444; padding: 16px; margin-bottom: 24px;';

        const alertTitle = document.createElement('h4');
        alertTitle.textContent = `üö® ${ordersPast.length} OVERDUE ORDER(S)`;
        alertTitle.style.cssText = 'color: #7f1d1d; margin: 0 0 8px 0; font-size: 14px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;';
        alert.appendChild(alertTitle);

        const alertText = document.createElement('p');
        alertText.textContent = 'These orders were expected but have not been checked in yet.';
        alertText.style.cssText = 'color: #991b1b; margin: 0; font-size: 12px;';
        alert.appendChild(alertText);

        container.appendChild(alert);
      }

      // Display all orders
      const allOrders = [...ordersPast, ...ordersToday, ...ordersUpcoming];

      if (allOrders.length === 0) {
        const emptyState = document.createElement('div');
        emptyState.style.cssText = 'text-align: center; padding: 60px 20px;';

        const emptyIcon = document.createElement('div');
        emptyIcon.textContent = 'üì¶';
        emptyIcon.style.cssText = 'font-size: 48px; margin-bottom: 16px;';
        emptyState.appendChild(emptyIcon);

        const emptyText = document.createElement('p');
        emptyText.textContent = 'No pending orders';
        emptyText.style.cssText = 'color: var(--gray-500); font-size: 14px; margin: 0;';
        emptyState.appendChild(emptyText);

        const emptyHint = document.createElement('p');
        emptyHint.textContent = 'Create an order in the CHECK-IN tab by selecting "ORDER" type';
        emptyHint.style.cssText = 'color: var(--gray-400); font-size: 12px; margin-top: 8px;';
        emptyState.appendChild(emptyHint);

        container.appendChild(emptyState);
        return;
      }

      // Render each order
      allOrders.forEach(order => {
        const card = document.createElement('div');
        card.style.cssText = 'background: white; border: 2px solid var(--gray-300); padding: 16px; margin-bottom: 16px;';

        // Header row
        const header = document.createElement('div');
        header.style.cssText = 'display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;';

        const leftSide = document.createElement('div');

        const vendor = document.createElement('h4');
        vendor.textContent = order.vendor;
        vendor.style.cssText = 'color: var(--gray-900); margin: 0 0 4px 0; font-size: 16px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;';
        leftSide.appendChild(vendor);

        const orderDateElement = document.createElement('div');
        const orderDatePacific = parsePacificDate(order.order_date);
        orderDateElement.textContent = `Ordered: ${
          orderDatePacific
            ? formatPacificDateDisplay(orderDatePacific, { month: 'short', day: 'numeric', year: 'numeric' })
            : 'Unknown'
        }`;
        orderDateElement.style.cssText = 'color: var(--gray-600); font-size: 11px;';
        leftSide.appendChild(orderDateElement);

        header.appendChild(leftSide);

        const rightSide = document.createElement('div');
        rightSide.style.textAlign = 'right';

        const deliveryDate = document.createElement('div');
        const expectedDatePacific = parsePacificDate(order.expected_delivery_date);
        const todayPacific = parsePacificDate(today);
        const dayDifference = (expectedDatePacific && todayPacific)
          ? Math.round((expectedDatePacific.getTime() - todayPacific.getTime()) / 86400000)
          : null;

        let dateText = 'Expected: ';
        dateText += expectedDatePacific
          ? formatPacificDateDisplay(expectedDatePacific, { month: 'short', day: 'numeric', year: 'numeric' })
          : 'Unknown';

        if (dayDifference === 0) dateText += ' (TODAY)';
        else if (dayDifference === 1) dateText += ' (Tomorrow)';
        else if (typeof dayDifference === 'number') {
          if (dayDifference < 0) {
            const overdueDays = Math.abs(dayDifference);
            dateText += ` (${overdueDays} day${overdueDays === 1 ? '' : 's'} overdue)`;
          } else if (dayDifference <= 7) {
            dateText += ` (in ${dayDifference} days)`;
          }
        }

        const deliveryStyle = dayDifference === 0
          ? 'color: #f59e0b; font-size: 11px; font-weight: 700;'
          : (typeof dayDifference === 'number' && dayDifference < 0
            ? 'color: #ef4444; font-size: 11px; font-weight: 700;'
            : 'color: var(--gray-600); font-size: 11px;');

        deliveryDate.textContent = dateText;
        deliveryDate.style.cssText = deliveryStyle;
        rightSide.appendChild(deliveryDate);

        const itemCount = document.createElement('div');
        itemCount.textContent = `${order.total_items} item(s)`;
        itemCount.style.cssText = 'color: var(--gray-500); font-size: 10px; margin-top: 4px;';
        rightSide.appendChild(itemCount);

        header.appendChild(rightSide);
        card.appendChild(header);

        // Items list (collapsible)
        if (order.pending_order_items && order.pending_order_items.length > 0) {
          const itemsList = document.createElement('div');
          itemsList.style.cssText = 'border-top: 1px solid var(--gray-200); padding-top: 12px; margin-top: 8px;';

          order.pending_order_items.forEach(item => {
            const itemRow = document.createElement('div');
            itemRow.style.cssText = 'padding: 6px 0; font-size: 12px; border-bottom: 1px dashed var(--gray-200);';

            const topRow = document.createElement('div');
            topRow.style.cssText = 'display: flex; justify-content: space-between; align-items: center; gap: 12px;';

            const itemName = document.createElement('span');
            itemName.textContent = item.item_name;
            itemName.style.cssText = 'color: var(--gray-700); font-weight: 600;';
            topRow.appendChild(itemName);

            const itemQty = document.createElement('span');
            itemQty.textContent = `${item.quantity_ordered} ${item.unit}`;
            itemQty.style.cssText = 'color: var(--gray-500); font-weight: 700; font-size: 12px;';
            topRow.appendChild(itemQty);

            itemRow.appendChild(topRow);

            if (item.inventory_item_id != null) {
              const localItem = orderingSystemState.items.find(i => i.id === item.inventory_item_id);
              const priceInfo = getPriceInfoForInventoryId(
                item.inventory_item_id,
                localItem?.currentUnitCost,
                localItem?.lastCostUpdate
              );

              const priceDiv = document.createElement('div');
              priceDiv.style.cssText = 'margin-top: 4px; font-size: 11px;';
              priceDiv.innerHTML = renderPriceTrendHtml(priceInfo);
              itemRow.appendChild(priceDiv);
            }

            itemsList.appendChild(itemRow);
          });

          card.appendChild(itemsList);
        }

        // Notes if any
        if (order.notes) {
          const notes = document.createElement('div');
          notes.textContent = `Notes: ${order.notes}`;
          notes.style.cssText = 'color: var(--gray-500); font-size: 11px; margin-top: 12px; font-style: italic;';
          card.appendChild(notes);
        }

        container.appendChild(card);
      });

    } catch (error) {
      console.error('Error loading pending orders:', error);
      container.innerHTML = `<div style="text-align: center; padding: 40px;"><p style="color: #ef4444;">Error loading orders: ${error.message}</p></div>`;
    }
  }

  /**
   * Load and display orders due today alert on CHECK-IN tab
   */
  async function loadOrdersDueTodayAlert() {
    const container = document.getElementById('ordersDueTodayAlert');
    if (!container) return;

    // Clear previous alert
    container.innerHTML = '';

    try {
      // Fetch orders due today
      const today = getPacificDate(); // Pacific Time, not UTC
      const { data: orders, error } = await supabase
        .from('pending_orders')
        .select(`
          *,
          pending_order_items (
            id,
            inventory_item_id,
            quantity_ordered,
            unit,
            item_name
          )
        `)
        .eq('expected_delivery_date', today)
        .eq('status', 'pending');

      if (error) throw error;

      if (!orders || orders.length === 0) {
        // No orders due today - don't show anything
        return;
      }

      console.log(`Found ${orders.length} order(s) due today`);

      // Create alert box
      const alert = document.createElement('div');
      alert.style.cssText = 'background: #fef3c7; border: 2px solid #f59e0b; padding: 16px; margin-bottom: 24px;';

      const header = document.createElement('div');
      header.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;';

      const title = document.createElement('h4');
      title.textContent = `‚ö†Ô∏è ${orders.length} ORDER(S) DUE TODAY`;
      title.style.cssText = 'color: #92400e; margin: 0; font-size: 14px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;';
      header.appendChild(title);

      alert.appendChild(header);

      const description = document.createElement('p');
      description.textContent = 'Select the order below when checking in delivery:';
      description.style.cssText = 'color: #78350f; margin: 0 0 12px 0; font-size: 12px;';
      alert.appendChild(description);

      // List each order
      orders.forEach(order => {
        const orderCard = document.createElement('div');
        orderCard.style.cssText = 'background: white; border: 2px solid #f59e0b; padding: 12px; margin-top: 8px; cursor: pointer; transition: background 0.2s;';
        orderCard.onmouseover = () => orderCard.style.background = '#fffbeb';
        orderCard.onmouseout = () => orderCard.style.background = 'white';

        const vendorName = document.createElement('div');
        vendorName.textContent = order.vendor;
        vendorName.style.cssText = 'color: #92400e; font-size: 14px; font-weight: 700; margin-bottom: 4px;';
        orderCard.appendChild(vendorName);

        const itemCount = document.createElement('div');
        itemCount.textContent = `${order.total_items} item(s) ordered`;
        itemCount.style.cssText = 'color: #78350f; font-size: 11px;';
        orderCard.appendChild(itemCount);

        // Store order ID and show check-in interface
        orderCard.onclick = () => {
          // Highlight selected
          document.querySelectorAll('#ordersDueTodayAlert > div > div').forEach(card => {
            card.style.borderColor = '#f59e0b';
            card.style.background = 'white';
          });
          orderCard.style.borderColor = '#92400e';
          orderCard.style.background = '#fffbeb';

          // Show check-in interface for this order
          showPendingOrderForCheckIn(order.id);
        };

        alert.appendChild(orderCard);
      });

      container.appendChild(alert);

    } catch (error) {
      console.error('Error loading orders due today:', error);
    }
  }

  /**
   * ============================================
   * MANAGE PENDING ORDERS (PASSWORD PROTECTED)
   * ============================================
   */

  /**
   * Open Manage Orders tab with password protection
   */
  function openManageOrdersTab(event) {
    requirePasswordFor('Manage Pending Orders', async () => {
      // Password correct - proceed to open tab
      openOrderTab(event, 'manageOrders');

      // Load all pending orders
      await loadAllPendingOrders();
    }, 'JaynaGyro2025!');
  }

  /**
   * Load ALL pending orders (not just today's)
   */
  async function loadAllPendingOrders() {
    console.log('üì• Loading all pending orders...');

    const container = document.getElementById('managePendingOrdersList');
    if (!container) return;

    showLoading('Loading Orders', 'Fetching all pending orders...');

    try {
      const { data: orders, error } = await supabase
        .from('pending_orders')
        .select(`
          id,
          vendor,
          order_date,
          expected_delivery_date,
          status,
          total_items,
          notes,
          created_at,
          pending_order_items (
            id,
            inventory_item_id,
            quantity_ordered,
            unit,
            item_name,
            vendor,
            quantity_received,
            variance,
            unit_price,
            receiving_notes
          )
        `)
        .in('status', ['pending', 'partial'])
        .order('expected_delivery_date', { ascending: true });

      if (error) throw error;

      hideLoading();

      if (!orders || orders.length === 0) {
        container.innerHTML = `
          <div style="background: var(--gray-100); padding: 40px; text-align: center; border-radius: 0; border: 2px solid var(--gray-300);">
            <p style="color: var(--gray-600); font-size: 14px; margin: 0;">No pending orders found</p>
          </div>
        `;
        return;
      }

      renderManagePendingOrdersList(orders);

    } catch (error) {
      hideLoading();
      console.error('Error loading pending orders:', error);
      showMessage('Failed to load pending orders: ' + error.message, 'error');
    }
  }

  /**
   * Render all pending orders in a table
   */
  function renderManagePendingOrdersList(orders) {
    console.log('üé® Rendering', orders.length, 'pending orders');

    const container = document.getElementById('managePendingOrdersList');
    if (!container) {
      console.error('‚ùå Container managePendingOrdersList not found!');
      return;
    }

    container.innerHTML = '';

    // Summary stats bar
    const summary = document.createElement('div');
    summary.style.cssText = 'background: white; border: 2px solid var(--gray-300); padding: 16px 20px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;';

    const totalOrders = orders.length;
    const todayPacific = getPacificMidday();
    const overdueCount = orders.filter(o => {
      const deliveryDatePacific = parsePacificDate(o.expected_delivery_date);
      return deliveryDatePacific && deliveryDatePacific < todayPacific;
    }).length;
    const todayCount = orders.filter(o => {
      const deliveryDatePacific = parsePacificDate(o.expected_delivery_date);
      return deliveryDatePacific && deliveryDatePacific.getTime() === todayPacific.getTime();
    }).length;

    summary.innerHTML = `
      <div style="display: flex; gap: 24px; align-items: center; flex-wrap: wrap;">
        <div>
          <div style="font-size: 24px; font-weight: 700; color: var(--gray-900); line-height: 1;">${totalOrders}</div>
          <div style="font-size: 11px; font-weight: 700; color: var(--gray-600); text-transform: uppercase; letter-spacing: 0.5px; margin-top: 4px;">Total Orders</div>
        </div>
        ${overdueCount > 0 ? `
        <div style="padding: 8px 12px; background: #fee2e2; border: 2px solid #dc2626;">
          <div style="font-size: 20px; font-weight: 700; color: #991b1b; line-height: 1;">${overdueCount}</div>
          <div style="font-size: 10px; font-weight: 700; color: #991b1b; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 4px;">Overdue</div>
        </div>
        ` : ''}
        ${todayCount > 0 ? `
        <div style="padding: 8px 12px; background: #fef3c7; border: 2px solid #f59e0b;">
          <div style="font-size: 20px; font-weight: 700; color: #92400e; line-height: 1;">${todayCount}</div>
          <div style="font-size: 10px; font-weight: 700; color: #92400e; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 4px;">Due Today</div>
        </div>
        ` : ''}
      </div>
    `;
    container.appendChild(summary);

    // Desktop Table (hidden on mobile)
    const tableContainer = document.createElement('div');
    tableContainer.style.cssText = 'display: block; overflow-x: auto; border: 2px solid #e5e7eb; background: white;';
    tableContainer.className = 'desktop-table';

    const tableHTML = `
      <table style="width: 100%; border-collapse: collapse; background: white;">
        <thead>
          <tr style="background: #1a1a1a; border-bottom: 2px solid #4a4a4a;">
            <th style="padding: 10px 12px; text-align: left; font-size: 11px; font-weight: 700; color: white; text-transform: uppercase; letter-spacing: 0.5px;">Vendor</th>
            <th style="padding: 10px 12px; text-align: left; font-size: 11px; font-weight: 700; color: white; text-transform: uppercase; letter-spacing: 0.5px;">Order Date</th>
            <th style="padding: 10px 12px; text-align: left; font-size: 11px; font-weight: 700; color: white; text-transform: uppercase; letter-spacing: 0.5px;">Delivery Date</th>
            <th style="padding: 10px 8px; text-align: center; font-size: 11px; font-weight: 700; color: white; text-transform: uppercase; letter-spacing: 0.5px; width: 60px;">Items</th>
            <th style="padding: 10px 8px; text-align: center; font-size: 11px; font-weight: 700; color: white; text-transform: uppercase; letter-spacing: 0.5px; width: 100px;">Actions</th>
          </tr>
        </thead>
        <tbody id="pendingOrdersTableBody">
        </tbody>
      </table>
    `;

    tableContainer.innerHTML = tableHTML;
    container.appendChild(tableContainer);

    const tbody = document.getElementById('pendingOrdersTableBody');

    console.log('üìä Creating table rows for orders...');

    orders.forEach((order, index) => {
      console.log(`Row ${index + 1}/${orders.length}: ${order.vendor} (ID: ${order.id})`);

      const row = document.createElement('tr');
      row.style.cssText = 'border-bottom: 1px solid #f3f4f6; transition: background 0.15s ease;';
      row.onmouseover = () => row.style.background = '#f9fafb';
      row.onmouseout = () => row.style.background = 'white';

      const orderDatePacific = parsePacificDate(order.order_date);
      const deliveryDatePacific = parsePacificDate(order.expected_delivery_date);
      const formattedOrderDate = orderDatePacific
        ? formatPacificDateDisplay(orderDatePacific, { month: 'short', day: 'numeric', year: 'numeric' })
        : 'Unknown';
      const formattedDeliveryDate = deliveryDatePacific
        ? formatPacificDateDisplay(deliveryDatePacific, { month: 'short', day: 'numeric', year: 'numeric' })
        : 'Unknown';

      // Determine if delivery date is in the past, today, or future (Pacific time)
      const todayPacific = getPacificMidday();

      let deliveryDateColor = 'var(--gray-900)';
      let deliveryDateBg = 'transparent';
      if (deliveryDatePacific && deliveryDatePacific < todayPacific) {
        deliveryDateColor = '#991b1b'; // Dark red text
        deliveryDateBg = '#fee2e2'; // Light red background
      } else if (deliveryDatePacific && deliveryDatePacific.getTime() === todayPacific.getTime()) {
        deliveryDateColor = '#92400e'; // Dark orange text
        deliveryDateBg = '#fef3c7'; // Light orange background
      } else if (deliveryDatePacific) {
        deliveryDateColor = '#065f46'; // Dark green text
        deliveryDateBg = '#d1fae5'; // Light green background
      }

      // Vendor
      const vendorCell = document.createElement('td');
      vendorCell.style.cssText = 'padding: 10px 12px; font-size: 13px; font-weight: 700; color: #1a1a1a;';
      vendorCell.textContent = order.vendor;
      row.appendChild(vendorCell);

      // Order Date
      const orderDateCell = document.createElement('td');
      orderDateCell.style.cssText = 'padding: 10px 12px; font-size: 12px; color: #6b6b6b;';
      orderDateCell.textContent = formattedOrderDate;
      row.appendChild(orderDateCell);

      // Delivery Date
      const deliveryCell = document.createElement('td');
      deliveryCell.style.cssText = 'padding: 10px 12px;';
      const deliveryBadge = document.createElement('div');
      deliveryBadge.style.cssText = `display: inline-block; padding: 4px 8px; background: ${deliveryDateBg}; border: 2px solid ${deliveryDateColor};`;
      const deliveryText = document.createElement('span');
      deliveryText.style.cssText = `font-size: 12px; font-weight: 700; color: ${deliveryDateColor};`;
      deliveryText.textContent = formattedDeliveryDate;
      deliveryBadge.appendChild(deliveryText);
      deliveryCell.appendChild(deliveryBadge);
      row.appendChild(deliveryCell);

      // Items
      const itemsCell = document.createElement('td');
      itemsCell.style.cssText = 'padding: 10px 8px; text-align: center; width: 60px;';
      const itemsBadge = document.createElement('span');
      itemsBadge.style.cssText = 'display: inline-block; padding: 4px 8px; background: #f9fafb; border: 2px solid #e5e7eb; font-size: 13px; font-weight: 700; color: #1a1a1a;';
      itemsBadge.textContent = order.total_items;
      itemsCell.appendChild(itemsBadge);
      row.appendChild(itemsCell);

      // Actions - EVENT DELEGATION PATTERN with data attributes
      const actionsCell = document.createElement('td');
      actionsCell.style.cssText = 'padding: 10px 8px; text-align: center; font-size: 13px; white-space: nowrap; width: 100px;';

      const editLink = document.createElement('a');
      editLink.href = '#';
      editLink.className = 'edit-order-btn';
      editLink.setAttribute('data-order-id', order.id);
      editLink.style.cssText = 'color: #4a4a4a; text-decoration: underline; cursor: pointer; font-weight: 600; font-size: 13px;';
      editLink.textContent = 'edit';

      const separator = document.createElement('span');
      separator.style.cssText = 'margin: 0 8px; color: #d1d5db; font-size: 13px;';
      separator.textContent = '|';

      const deleteLink = document.createElement('a');
      deleteLink.href = '#';
      deleteLink.className = 'delete-order-btn';
      deleteLink.setAttribute('data-order-id', order.id);
      deleteLink.setAttribute('data-vendor-name', order.vendor);
      deleteLink.style.cssText = 'color: #dc2626; text-decoration: underline; cursor: pointer; font-weight: 600; font-size: 13px;';
      deleteLink.textContent = 'delete';

      actionsCell.appendChild(editLink);
      actionsCell.appendChild(separator);
      actionsCell.appendChild(deleteLink);
      row.appendChild(actionsCell);

      tbody.appendChild(row);
      console.log(`‚úÖ Row ${index + 1} appended with EDIT and DELETE buttons`);
    });

    console.log('‚úÖ All rows rendered successfully!');

    // EVENT DELEGATION - Add click listener to container (not individual buttons)
    container.removeEventListener('click', handleOrderActions); // Remove old listener
    container.addEventListener('click', handleOrderActions); // Add new listener
  }

  /**
   * Handle all edit/delete button clicks via event delegation
   */
  function handleOrderActions(event) {
    const editLink = event.target.closest('.edit-order-btn');
    if (editLink) {
      event.preventDefault();
      const orderId = parseInt(editLink.getAttribute('data-order-id'));
      console.log('üñ±Ô∏è EDIT clicked for order ID:', orderId);
      try {
        editPendingOrder(orderId);
      } catch (err) {
        console.error('‚ùå Error calling editPendingOrder:', err);
      }
      return;
    }

    const deleteLink = event.target.closest('.delete-order-btn');
    if (deleteLink) {
      event.preventDefault();
      const orderId = parseInt(deleteLink.getAttribute('data-order-id'));
      const vendorName = deleteLink.getAttribute('data-vendor-name');
      console.log('üñ±Ô∏è DELETE clicked for order ID:', orderId, 'Vendor:', vendorName);
      console.log('üîß About to call deletePendingOrder...');
      try {
        deletePendingOrder(orderId, vendorName);
        console.log('‚úÖ deletePendingOrder called successfully');
      } catch (err) {
        console.error('‚ùå Error calling deletePendingOrder:', err);
      }
      return;
    }
  }

  /**
   * Edit pending order (delivery date, items, etc.)
   */
  async function editPendingOrder(orderId) {
    console.log('Editing order:', orderId);

    showLoading('Loading Order', 'Fetching order details...');

    try {
      const { data: order, error } = await supabase
        .from('pending_orders')
        .select(`
          *,
          pending_order_items (
            id,
            inventory_item_id,
            quantity_ordered,
            unit,
            item_name,
            vendor
          )
        `)
        .eq('id', orderId)
        .single();

      if (error) throw error;

      hideLoading();

      // Create modal
      const modal = document.createElement('div');
      modal.id = 'editOrderModal';
      modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10000; overflow-y: auto; padding: 20px;';

      const content = document.createElement('div');
      content.style.cssText = 'background: white; padding: 24px; max-width: 800px; width: 100%; max-height: 90vh; overflow-y: auto; border: 3px solid var(--gray-700);';

      // Header
      const header = document.createElement('h3');
      header.textContent = `EDIT ORDER: ${order.vendor}`;
      header.style.cssText = 'margin: 0 0 20px 0; font-size: 16px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: var(--gray-900);';
      content.appendChild(header);

      // Delivery Date Input
      const dateLabel = document.createElement('label');
      dateLabel.textContent = 'DELIVERY DATE';
      dateLabel.style.cssText = 'display: block; margin-bottom: 8px; font-size: 11px; font-weight: 700; color: var(--gray-700); text-transform: uppercase; letter-spacing: 0.5px;';
      content.appendChild(dateLabel);

      const dateInput = document.createElement('input');
      dateInput.type = 'date';
      dateInput.id = 'editDeliveryDate';
      dateInput.value = order.expected_delivery_date;
      dateInput.style.cssText = 'width: 100%; padding: 12px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 14px; margin-bottom: 20px; box-sizing: border-box;';
      content.appendChild(dateInput);

      // Items list
      const itemsLabel = document.createElement('h4');
      itemsLabel.textContent = 'ORDER ITEMS';
      itemsLabel.style.cssText = 'margin: 20px 0 12px 0; font-size: 13px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: var(--gray-900);';
      content.appendChild(itemsLabel);

      const itemsContainer = document.createElement('div');
      itemsContainer.id = 'editOrderItems';
      itemsContainer.style.cssText = 'max-height: 300px; overflow-y: auto; border: 2px solid var(--gray-300); padding: 12px; margin-bottom: 20px;';

      order.pending_order_items.forEach(item => {
        const itemDiv = document.createElement('div');
        itemDiv.style.cssText = 'display: grid; grid-template-columns: 3fr 1fr 1fr 40px; gap: 8px; margin-bottom: 12px; align-items: center; padding-bottom: 12px; border-bottom: 1px solid #e5e7eb;';

        const nameDiv = document.createElement('div');
        nameDiv.style.cssText = 'font-size: 13px; font-weight: 600; color: #1a1a1a;';
        nameDiv.textContent = item.item_name;

        const qtyInput = document.createElement('input');
        qtyInput.type = 'number';
        qtyInput.id = `editQty_${item.id}`;
        qtyInput.value = item.quantity_ordered;
        qtyInput.min = '0';
        qtyInput.step = '0.1';
        qtyInput.style.cssText = 'padding: 8px; border: 2px solid #d1d5db; border-radius: 0; font-size: 13px; text-align: center;';

        const unitDiv = document.createElement('div');
        unitDiv.style.cssText = 'font-size: 12px; color: #6b6b6b; text-align: center;';
        unitDiv.textContent = item.unit;

        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'delete-order-item-btn';
        deleteBtn.setAttribute('data-item-id', item.id);
        deleteBtn.setAttribute('data-order-id', orderId);
        deleteBtn.style.cssText = 'padding: 6px; background: #dc2626; color: white; border: none; cursor: pointer; font-size: 11px; font-weight: 700;';
        deleteBtn.textContent = '‚úï';

        itemDiv.appendChild(nameDiv);
        itemDiv.appendChild(qtyInput);
        itemDiv.appendChild(unitDiv);
        itemDiv.appendChild(deleteBtn);
        itemsContainer.appendChild(itemDiv);
      });

      // EVENT DELEGATION for delete buttons in modal
      itemsContainer.addEventListener('click', function(event) {
        if (event.target.classList.contains('delete-order-item-btn')) {
          const itemId = parseInt(event.target.getAttribute('data-item-id'));
          const orderId = parseInt(event.target.getAttribute('data-order-id'));
          console.log('üñ±Ô∏è DELETE ITEM clicked:', itemId, 'from order:', orderId);
          deleteOrderItem(itemId, orderId);
        }
      });

      content.appendChild(itemsContainer);

      // Buttons
      const buttonsDiv = document.createElement('div');
      buttonsDiv.style.cssText = 'display: flex; gap: 12px; justify-content: flex-end;';

      const cancelBtn = document.createElement('button');
      cancelBtn.textContent = 'CANCEL';
      cancelBtn.style.cssText = 'padding: 12px 24px; background: var(--gray-100); border: 2px solid var(--gray-300); color: var(--gray-900); font-size: 13px; font-weight: 700; cursor: pointer; text-transform: uppercase; letter-spacing: 0.5px;';
      cancelBtn.onclick = () => modal.remove();
      buttonsDiv.appendChild(cancelBtn);

      const saveBtn = document.createElement('button');
      saveBtn.textContent = 'SAVE CHANGES';
      saveBtn.style.cssText = 'padding: 12px 24px; background: var(--gray-900); border: 2px solid var(--gray-900); color: white; font-size: 13px; font-weight: 700; cursor: pointer; text-transform: uppercase; letter-spacing: 0.5px;';
      saveBtn.onclick = () => saveOrderEdits(orderId, order);
      buttonsDiv.appendChild(saveBtn);

      content.appendChild(buttonsDiv);

      modal.appendChild(content);
      document.body.appendChild(modal);

    } catch (error) {
      hideLoading();
      console.error('Error loading order for edit:', error);
      showMessage('Failed to load order: ' + error.message, 'error');
    }
  }

  /**
   * Save edits to pending order
   */
  async function saveOrderEdits(orderId, originalOrder) {
    const newDeliveryDate = document.getElementById('editDeliveryDate').value;

    showLoading('Saving Changes', 'Updating order...');

    try {
      // Update delivery date
      const { error: orderError } = await supabase
        .from('pending_orders')
        .update({
          expected_delivery_date: newDeliveryDate,
          updated_at: new Date().toISOString()
        })
        .eq('id', orderId);

      if (orderError) throw orderError;

      // Update item quantities
      for (const item of originalOrder.pending_order_items) {
        const qtyInput = document.getElementById(`editQty_${item.id}`);
        if (qtyInput) {
          const newQty = parseFloat(qtyInput.value) || 0;

          if (newQty !== item.quantity_ordered) {
            const { error: itemError } = await supabase
              .from('pending_order_items')
              .update({ quantity_ordered: newQty })
              .eq('id', item.id);

            if (itemError) throw itemError;
          }
        }
      }

      hideLoading();
      showMessage('‚úÖ Order updated successfully!', 'success');

      // Close modal
      const modal = document.getElementById('editOrderModal');
      if (modal) modal.remove();

      // Reload orders list
      await loadAllPendingOrders();

      // Reload orders due today alert
      await loadOrdersDueTodayAlert();

    } catch (error) {
      hideLoading();
      console.error('Error saving order edits:', error);
      showMessage('Failed to save changes: ' + error.message, 'error');
    }
  }

  window.editPendingOrder = editPendingOrder;

  /**
   * Delete an item from a pending order
   */
  async function deleteOrderItem(itemId, orderId) {
    showLoading('Deleting Item', 'Removing item from order...');

    try {
      const { error } = await supabase
        .from('pending_order_items')
        .delete()
        .eq('id', itemId);

      if (error) throw error;

      hideLoading();
      showMessage('‚úÖ Item deleted', 'success');

      // Re-open the edit modal
      const modal = document.getElementById('editOrderModal');
      if (modal) modal.remove();

      await editPendingOrder(orderId);

    } catch (error) {
      hideLoading();
      console.error('Error deleting item:', error);
      showMessage('Failed to delete item: ' + error.message, 'error');
    }
  }
  window.deleteOrderItem = deleteOrderItem;

  /**
   * Delete entire pending order - SIMPLIFIED VERSION
   */
  async function deletePendingOrder(orderId, vendorName) {
    if (!orderId) {
      showMessage('Order ID missing. Unable to delete.', 'error');
      return;
    }

    const overlay = document.createElement('div');
    overlay.id = 'deleteOrderModal';
    overlay.style.cssText = `
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.55);
      z-index: 11000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    `;

    const modal = document.createElement('div');
    modal.style.cssText = `
      background: white;
      border: 2px solid #b91c1c;
      max-width: 420px;
      width: 100%;
      padding: 24px 24px 20px 24px;
      box-shadow: 0 12px 24px rgba(0,0,0,0.18);
    `;

    modal.innerHTML = `
      <div style="color: #7f1d1d; font-weight: 700; text-transform: uppercase; letter-spacing: 0.6px; margin-bottom: 12px;">Confirm delete</div>
      <p style="margin: 0 0 18px 0; color: #4b5563; font-size: 13px; line-height: 1.5;">
        Permanently delete the pending order for <strong>${vendorName || 'this vendor'}</strong>?<br>
        This will remove all associated items and cannot be undone.
      </p>
      <div style="display: flex; gap: 12px;">
        <button type="button" id="cancelDeleteOrder" style="flex: 1; padding: 12px; background: white; border: 2px solid var(--gray-300); color: var(--gray-700); font-weight: 700; text-transform: uppercase; letter-spacing: 0.6px; cursor: pointer;">Cancel</button>
        <button type="button" id="confirmDeleteOrder" style="flex: 1; padding: 12px; background: #b91c1c; border: 2px solid #991b1b; color: white; font-weight: 700; text-transform: uppercase; letter-spacing: 0.6px; cursor: pointer;">Delete</button>
      </div>
    `;

    overlay.appendChild(modal);
    document.body.appendChild(overlay);

    const removeOverlay = () => {
      if (overlay && overlay.parentNode) {
        overlay.parentNode.removeChild(overlay);
      }
    };

    modal.querySelector('#cancelDeleteOrder').onclick = removeOverlay;
    overlay.onclick = (evt) => {
      if (evt.target === overlay) removeOverlay();
    };

    modal.querySelector('#confirmDeleteOrder').onclick = async () => {
      await performPendingOrderDeletion(orderId, vendorName, overlay);
    };
  }

  async function performPendingOrderDeletion(orderId, vendorName, overlay) {
    showLoading('Deleting Order', `Removing ${vendorName || 'order'}...`);

    try {
      const { data: orderItems, error: fetchItemsError } = await supabase
        .from('pending_order_items')
        .select('inventory_item_id')
        .eq('order_id', orderId);

      if (fetchItemsError) throw new Error(fetchItemsError.message);

      const itemIds = (orderItems || [])
        .map(row => row.inventory_item_id)
        .filter(id => id !== null && id !== undefined);

      const { error: itemsError } = await supabase
        .from('pending_order_items')
        .delete()
        .eq('order_id', orderId);

      if (itemsError) throw new Error(itemsError.message);

      const { error: orderError } = await supabase
        .from('pending_orders')
        .delete()
        .eq('id', orderId);

      if (orderError) throw new Error(orderError.message);

      const cache = getPriceCache();
      itemIds.forEach(id => cache.delete(id));
      if (itemIds.length) {
        await ensurePriceSnapshotsForItems(itemIds);
      }

      hideLoading();
      if (overlay) overlay.remove();

      await loadAllPendingOrders();
      await loadOrdersDueTodayAlert();
      calculateUpcomingOrders();
      await refreshUpcomingOrdersUI();

      showMessage(`‚úÖ Deleted pending order for ${vendorName || 'vendor'}`, 'success');
    } catch (error) {
      hideLoading();
      if (overlay) overlay.remove();
      console.error('Failed to delete order:', error);
      showMessage(`Failed to delete order: ${error.message}`, 'error');
    }
  }
  window.deletePendingOrder = deletePendingOrder;

  // Define loadPendingOrderForCheckIn as wrapper function
  async function loadPendingOrderForCheckIn(orderId) {
    return showPendingOrderForCheckIn(orderId);
  }
  window.loadPendingOrderForCheckIn = loadPendingOrderForCheckIn;

  /**
   * Display pending order items for manual check-in
   */
  async function showPendingOrderForCheckIn(orderId) {
    console.log('showPendingOrderForCheckIn called with order ID:', orderId);

    const container = document.getElementById('pendingOrderCheckInView');
    if (!container) return;

    showLoading('Loading Order', 'Fetching order details...');

    try {
      // Fetch pending order with all items
      const { data: orderData, error: orderError } = await supabase
        .from('pending_orders')
        .select(`
          *,
          pending_order_items (
            id,
            inventory_item_id,
            quantity_ordered,
            unit,
            item_name,
            vendor
          )
        `)
        .eq('id', orderId)
        .single();

      if (orderError) throw orderError;
      if (!orderData) throw new Error('Order not found');

      hideLoading();

      // Store order ID for later
      orderingSystemState.selectedPendingOrderId = orderId;
      orderingSystemState.currentCheckInOrder = orderData;

      // Clear and show container
      container.innerHTML = '';
      container.style.display = 'block';

      // Scroll to this section
      container.scrollIntoView({ behavior: 'smooth', block: 'start' });

      // Header
      const header = document.createElement('div');
      header.style.cssText = 'background: #fef3c7; border: 2px solid #f59e0b; padding: 16px; margin-bottom: 20px;';

      const title = document.createElement('h3');
      title.textContent = `CHECK IN: ${orderData.vendor}`;
      title.style.cssText = 'color: #92400e; margin: 0 0 8px 0; font-size: 16px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;';
      header.appendChild(title);

      const orderInfo = document.createElement('div');
      orderInfo.style.cssText = 'display: flex; gap: 20px; flex-wrap: wrap;';

      const date = document.createElement('div');
      const expectedDatePacific = parsePacificDate(orderData.expected_delivery_date);
      date.innerHTML = `<strong>Expected:</strong> ${
        expectedDatePacific
          ? formatPacificDateDisplay(expectedDatePacific, { month: 'short', day: 'numeric', year: 'numeric', weekday: 'long' })
          : 'Unknown'
      }`;
      date.style.cssText = 'font-size: 12px; color: #78350f;';
      orderInfo.appendChild(date);

      const itemCount = document.createElement('div');
      itemCount.innerHTML = `<strong>Total Items:</strong> ${orderData.total_items}`;
      itemCount.style.cssText = 'font-size: 12px; color: #78350f;';
      orderInfo.appendChild(itemCount);

      header.appendChild(orderInfo);
      container.appendChild(header);

      // Instructions
      const instructions = document.createElement('p');
      instructions.textContent = 'Update received quantities, enter prices (required), add notes, then click CONFIRM ORDER to finalize.';
      instructions.style.cssText = 'color: var(--gray-600); font-size: 13px; margin-bottom: 16px;';
      container.appendChild(instructions);

      // Items table
      const table = document.createElement('div');
      table.style.cssText = 'border: 2px solid var(--gray-300); margin-bottom: 20px;';

      // Table header
      const thead = document.createElement('div');
      thead.style.cssText = 'display: grid; grid-template-columns: 2fr 1fr 1fr 1fr 1fr 2fr 120px; gap: 8px; padding: 10px; background: var(--gray-900); color: white; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;';

      ['Item', 'Ordered', 'Received', 'Unit', 'Price', 'Notes', 'Action'].forEach(label => {
        const th = document.createElement('div');
        th.textContent = label;
        thead.appendChild(th);
      });

      table.appendChild(thead);

      // Items (stored for later updates)
      orderingSystemState.checkInItems = {};

      // Table body
      orderData.pending_order_items.forEach((item, index) => {
        // Initialize item state
        const inventoryItem = orderingSystemState.items?.find(i => i.id === item.inventory_item_id);
        const defaultPrice = item.unit_price != null
          ? parseFloat(item.unit_price)
          : inventoryItem?.currentUnitCost != null
            ? parseFloat(inventoryItem.currentUnitCost)
            : null;

        orderingSystemState.checkInItems[item.id] = {
          id: item.id,
          inventoryItemId: item.inventory_item_id,
          itemName: item.item_name,
          ordered: Number(item.quantity_ordered) || 0,
          received: item.quantity_received != null ? Number(item.quantity_received) : Number(item.quantity_ordered) || 0,
          unit: item.unit,
          price: defaultPrice,
          notes: item.receiving_notes || ''
        };

        const row = document.createElement('div');
        row.id = `checkInRow${item.id}`;
        row.style.cssText = 'display: grid; grid-template-columns: 2fr 1fr 1fr 1fr 1fr 2fr 120px; gap: 8px; padding: 12px; border-top: 1px solid var(--gray-300); background: white;';

        // Item name
        const nameCell = document.createElement('div');
        nameCell.textContent = item.item_name;
        nameCell.style.cssText = 'font-size: 12px; font-weight: 600; color: var(--gray-900);';
        row.appendChild(nameCell);

        // Ordered quantity (read-only)
        const orderedCell = document.createElement('div');
        orderedCell.textContent = item.quantity_ordered;
        orderedCell.style.cssText = 'font-size: 12px; font-weight: 700; color: var(--gray-700);';
        row.appendChild(orderedCell);

        // Received quantity (editable input)
        const receivedCell = document.createElement('div');
        const receivedInput = document.createElement('input');
        receivedInput.type = 'number';
        receivedInput.min = '0';
        receivedInput.step = '0.25';
        receivedInput.value = orderingSystemState.checkInItems[item.id].received;
        receivedInput.id = `receivedQty${item.id}`;
        receivedInput.style.cssText = 'width: 100%; padding: 6px; border: 2px solid var(--gray-300); font-size: 12px; font-weight: 600; text-align: center;';
        receivedInput.onchange = function() {
          orderingSystemState.checkInItems[item.id].received = parseFloat(this.value) || 0;
          // Highlight if different from ordered
          if (parseFloat(this.value) !== item.quantity_ordered) {
            this.style.borderColor = '#f59e0b';
            this.style.background = '#fffbeb';
          } else {
            this.style.borderColor = 'var(--gray-300)';
            this.style.background = 'white';
          }
        };
        receivedCell.appendChild(receivedInput);
        row.appendChild(receivedCell);

        // Unit
        const unitCell = document.createElement('div');
        unitCell.textContent = item.unit;
        unitCell.style.cssText = 'font-size: 11px; color: var(--gray-600);';
        row.appendChild(unitCell);

        // Price input
        const priceCell = document.createElement('div');
        const priceInput = document.createElement('input');
        priceInput.type = 'number';
        priceInput.min = '0';
        priceInput.step = '0.01';
        priceInput.id = `price${item.id}`;
        priceInput.value = defaultPrice != null ? formatCurrencyInput(defaultPrice) : '';
        priceInput.placeholder = '0.00';
        priceInput.style.cssText = 'width: 100%; padding: 6px; border: 2px solid var(--gray-300); font-size: 12px; font-weight: 600; text-align: center;';
        if (defaultPrice == null) {
          priceInput.style.borderColor = '#dc2626';
          priceInput.style.background = '#fee2e2';
        }
        priceInput.onchange = function() {
          const value = parseFloat(this.value);
          if (Number.isFinite(value) && value > 0) {
            orderingSystemState.checkInItems[item.id].price = value;
            this.value = formatCurrencyInput(value);
            this.style.borderColor = 'var(--gray-300)';
            this.style.background = 'white';
          } else {
            orderingSystemState.checkInItems[item.id].price = null;
            this.style.borderColor = '#dc2626';
            this.style.background = '#fee2e2';
          }
        };
        priceCell.appendChild(priceInput);
        row.appendChild(priceCell);

        // Notes (editable input)
        const notesCell = document.createElement('div');
        const notesInput = document.createElement('input');
        notesInput.type = 'text';
        notesInput.placeholder = 'Add notes...';
        notesInput.id = `notes${item.id}`;
        notesInput.style.cssText = 'width: 100%; padding: 6px; border: 2px solid var(--gray-300); font-size: 11px;';
        if (orderingSystemState.checkInItems[item.id].notes) {
          notesInput.value = orderingSystemState.checkInItems[item.id].notes;
        }
        notesInput.onchange = function() {
          orderingSystemState.checkInItems[item.id].notes = this.value;
        };
        notesCell.appendChild(notesInput);
        row.appendChild(notesCell);

        // Actions (delete)
        const actionCell = document.createElement('div');
        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = 'DELETE';
        deleteBtn.style.cssText = 'width: 100%; padding: 8px 6px; background: #dc2626; color: white; border: none; font-size: 10px; font-weight: 700; letter-spacing: 0.8px; cursor: pointer; text-transform: uppercase;';
        deleteBtn.onclick = () => deleteCheckInItem(item.id, orderId);
        actionCell.appendChild(deleteBtn);
        row.appendChild(actionCell);

        table.appendChild(row);
      });

      container.appendChild(table);

      // Bulk actions
      const bulkActions = document.createElement('div');
      bulkActions.style.cssText = 'display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 20px;';

      // PHOTO button for OCR invoice scanning
      const photoBtn = document.createElement('button');
      photoBtn.textContent = 'üì∏ PHOTO';
      photoBtn.style.cssText = 'flex: 1; padding: 14px; background: #0094D6; color: white; border: 2px solid #0094D6; font-size: 11px; font-weight: 700; letter-spacing: 1px; cursor: pointer; text-transform: uppercase;';
      photoBtn.onclick = () => openPhotoScanForCheckIn(orderId);
      bulkActions.appendChild(photoBtn);

      // Auto-fill all button
      const autoFillBtn = document.createElement('button');
      autoFillBtn.textContent = 'AUTO-FILL: ALL RECEIVED AS ORDERED';
      autoFillBtn.style.cssText = 'flex: 1; padding: 14px; background: var(--gray-100); color: var(--gray-900); border: 2px solid var(--gray-300); font-size: 11px; font-weight: 700; letter-spacing: 1px; cursor: pointer; text-transform: uppercase;';
      autoFillBtn.onclick = () => {
        orderData.pending_order_items.forEach(item => {
          const input = document.getElementById(`receivedQty${item.id}`);
          if (input) {
            input.value = item.quantity_ordered;
            input.style.borderColor = 'var(--gray-300)';
            input.style.background = 'white';
            orderingSystemState.checkInItems[item.id].received = item.quantity_ordered;
          }
        });
        showMessage('‚úì All quantities set to ordered amounts', 'success');
      };
      bulkActions.appendChild(autoFillBtn);

      // Check in all button
      const confirmBtn = document.createElement('button');
      confirmBtn.textContent = 'CONFIRM ORDER';
      confirmBtn.style.cssText = 'flex: 1; padding: 14px; background: var(--gray-700); color: white; border: 2px solid var(--gray-700); font-size: 11px; font-weight: 700; letter-spacing: 1px; cursor: pointer; text-transform: uppercase;';
      confirmBtn.onclick = () => confirmPendingOrder(orderId);
      bulkActions.appendChild(confirmBtn);

      container.appendChild(bulkActions);

      // Close button
      const closeBtn = document.createElement('button');
      closeBtn.textContent = 'CANCEL';
      closeBtn.style.cssText = 'width: 100%; padding: 12px; background: var(--gray-300); color: var(--gray-700); border: 2px solid var(--gray-400); font-size: 11px; font-weight: 700; letter-spacing: 1px; cursor: pointer; text-transform: uppercase;';
      closeBtn.onclick = () => {
        container.style.display = 'none';
        container.innerHTML = '';
        orderingSystemState.selectedPendingOrderId = null;
        orderingSystemState.currentCheckInOrder = null;
        orderingSystemState.checkInItems = {};
      };
      container.appendChild(closeBtn);

    } catch (error) {
      hideLoading();
      console.error('Error loading pending order:', error);
      showMessage('Failed to load order: ' + error.message, 'error');
    }
  }

  /**
   * Open photo upload/camera for invoice OCR scanning
   */
  function openPhotoScanForCheckIn(orderId) {
    // Create hidden file input
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.accept = 'image/*,application/pdf';
    fileInput.capture = 'environment'; // Open camera on mobile
    fileInput.style.display = 'none';

    fileInput.onchange = async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      await processCheckInPhoto(file, orderId);
      document.body.removeChild(fileInput);
    };

    document.body.appendChild(fileInput);
    fileInput.click();
  }

  /**
   * Process photo with OCR and extract invoice items
   */
  async function processCheckInPhoto(file, orderId) {
    showLoading('Processing Photo', 'Extracting text from invoice...');

    try {
      let ocrText = '';

      // Check if PDF
      const isPDF = file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf');

      if (isPDF) {
        // Handle PDF (use existing PDF logic)
        const arrayBuffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;

        for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
          const page = await pdf.getPage(pageNum);
          const scale = 2.0;
          const viewport = page.getViewport({ scale });

          const canvas = document.createElement('canvas');
          canvas.width = viewport.width;
          canvas.height = viewport.height;
          const ctx = canvas.getContext('2d');

          await page.render({ canvasContext: ctx, viewport }).promise;

          const result = await Tesseract.recognize(canvas, 'eng', {
            tessedit_pageseg_mode: '4',
            preserve_interword_spaces: '1'
          });

          ocrText += result.data.text + '\n\n';
        }
      } else {
        // Handle image
        const result = await Tesseract.recognize(file, 'eng', {
          tessedit_pageseg_mode: '4',
          preserve_interword_spaces: '1'
        });

        ocrText = result.data.text;
      }

      hideLoading();

      // Parse OCR text to extract items
      const ocrItems = parseInvoiceTextForItems(ocrText);

      if (ocrItems.length === 0) {
        showMessage('No items found in invoice photo. Try taking a clearer photo or enter manually.', 'warning');
        return;
      }

      // Show matching modal
      showOCRMatchingModal(ocrItems, orderId);

    } catch (error) {
      hideLoading();
      console.error('OCR processing error:', error);
      showMessage('Failed to process photo: ' + error.message, 'error');
    }
  }

  /**
   * Parse OCR text to extract invoice items with quantities and prices
   */
  function parseInvoiceTextForItems(text) {
    const items = [];
    const lines = text.split('\n');

    // Pattern: look for lines with item name, optional quantity, and price
    // Examples: "Tomatoes 10 lb $45.00" or "Chicken Breast $125.50" or "Eggs 12 doz @ 3.50 = 42.00"
    const patterns = [
      // Pattern 1: Item Qty Unit $Price or Item Qty Unit Price
      /^(.+?)\s+(\d+(?:\.\d+)?)\s*(lb|lbs|oz|kg|g|case|ea|each|doz|dozen|pc|pcs|gal|qt|pt|ct|box|bag)?\s*[x@]?\s*\$?(\d+\.\d{2})/i,
      // Pattern 2: Item $Price (no quantity)
      /^(.+?)\s+\$(\d+\.\d{2})$/,
      // Pattern 3: Item Qty @ Price = Total
      /^(.+?)\s+(\d+(?:\.\d+)?)\s*[x@]\s*\$?(\d+\.\d{2})\s*=\s*\$?(\d+\.\d{2})/i
    ];

    for (const line of lines) {
      const trimmed = line.trim();
      if (!trimmed || trimmed.length < 3) continue;

      // Try each pattern
      for (const pattern of patterns) {
        const match = trimmed.match(pattern);
        if (match) {
          let itemName, quantity, unit, price;

          if (pattern === patterns[0]) {
            // Pattern 1: Item Qty Unit Price
            itemName = match[1].trim();
            quantity = parseFloat(match[2]) || null;
            unit = match[3] ? match[3].toLowerCase() : '';
            price = parseFloat(match[4]);
          } else if (pattern === patterns[1]) {
            // Pattern 2: Item $Price
            itemName = match[1].trim();
            quantity = null;
            unit = '';
            price = parseFloat(match[2]);
          } else if (pattern === patterns[2]) {
            // Pattern 3: Item Qty @ Price = Total
            itemName = match[1].trim();
            quantity = parseFloat(match[2]) || null;
            unit = '';
            price = parseFloat(match[3]); // Unit price, not total
          }

          // Validate
          if (itemName && price > 0) {
            items.push({
              name: itemName,
              quantity: quantity,
              unit: unit,
              price: price,
              rawLine: trimmed
            });
          }

          break; // Found a match, move to next line
        }
      }
    }

    return items;
  }

  /**
   * Show OCR matching modal with side-by-side comparison
   */
  function showOCRMatchingModal(ocrItems, orderId) {
    const pendingOrder = orderingSystemState.currentCheckInOrder;
    if (!pendingOrder) return;

    const pendingItems = pendingOrder.pending_order_items;

    // Create modal overlay
    const modal = document.createElement('div');
    modal.id = 'ocrMatchingModal';
    modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 10000; overflow-y: auto; padding: 20px;';

    // Modal content
    const content = document.createElement('div');
    content.style.cssText = 'background: white; max-width: 1400px; margin: 0 auto; border: 3px solid var(--gray-700);';

    // Header
    const header = document.createElement('div');
    header.style.cssText = 'background: #0094D6; color: white; padding: 20px; border-bottom: 3px solid #0081C6;';
    const title = document.createElement('h3');
    title.textContent = `üì∏ MATCH INVOICE ITEMS - ${pendingOrder.vendor}`;
    title.style.cssText = 'margin: 0 0 8px 0; font-size: 18px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;';
    header.appendChild(title);
    const subtitle = document.createElement('p');
    subtitle.textContent = 'Click items from the invoice (left) to match them with your pending order (right). Unmatched items will be added as new lines.';
    subtitle.style.cssText = 'margin: 0; font-size: 13px; opacity: 0.9;';
    header.appendChild(subtitle);
    content.appendChild(header);

    // Body with side-by-side layout
    const body = document.createElement('div');
    body.style.cssText = 'padding: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px;';

    // LEFT SIDE: OCR Items
    const leftPanel = document.createElement('div');
    leftPanel.style.cssText = 'border: 2px solid #0094D6; background: #E3F4FC;';

    const leftHeader = document.createElement('div');
    leftHeader.style.cssText = 'background: #0094D6; color: white; padding: 12px; font-size: 14px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;';
    leftHeader.textContent = `üìÑ INVOICE ITEMS (${ocrItems.length})`;
    leftPanel.appendChild(leftHeader);

    const leftList = document.createElement('div');
    leftList.id = 'ocrItemsList';
    leftList.style.cssText = 'padding: 12px;';

    ocrItems.forEach((ocrItem, index) => {
      const card = document.createElement('div');
      card.id = `ocrItem${index}`;
      card.className = 'ocr-item-card';
      card.style.cssText = 'background: white; border: 2px solid var(--gray-300); padding: 12px; margin-bottom: 10px; cursor: pointer; transition: all 0.15s ease;';
      card.dataset.index = index;
      card.dataset.matched = 'false';

      const itemName = document.createElement('div');
      itemName.textContent = ocrItem.name;
      itemName.style.cssText = 'font-weight: 600; font-size: 13px; color: var(--gray-900); margin-bottom: 4px;';
      card.appendChild(itemName);

      const itemDetails = document.createElement('div');
      itemDetails.style.cssText = 'font-size: 11px; color: var(--gray-600); display: flex; gap: 12px; flex-wrap: wrap;';

      if (ocrItem.quantity) {
        const qty = document.createElement('span');
        qty.textContent = `QTY: ${ocrItem.quantity}${ocrItem.unit ? ' ' + ocrItem.unit : ''}`;
        itemDetails.appendChild(qty);
      }

      const price = document.createElement('span');
      price.textContent = `PRICE: $${ocrItem.price.toFixed(2)}`;
      price.style.cssText = 'font-weight: 700; color: #059669;';
      itemDetails.appendChild(price);

      card.appendChild(itemDetails);

      // Click to select
      card.onclick = () => selectOCRItem(index);

      leftList.appendChild(card);
    });

    leftPanel.appendChild(leftList);
    body.appendChild(leftPanel);

    // RIGHT SIDE: Pending Order Items
    const rightPanel = document.createElement('div');
    rightPanel.style.cssText = 'border: 2px solid #f59e0b; background: #fffbeb;';

    const rightHeader = document.createElement('div');
    rightHeader.style.cssText = 'background: #f59e0b; color: #78350f; padding: 12px; font-size: 14px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;';
    rightHeader.textContent = `üì¶ PENDING ORDER (${pendingItems.length})`;
    rightPanel.appendChild(rightHeader);

    const rightList = document.createElement('div');
    rightList.id = 'pendingItemsList';
    rightList.style.cssText = 'padding: 12px;';

    pendingItems.forEach((pendingItem, index) => {
      const card = document.createElement('div');
      card.id = `pendingItem${pendingItem.id}`;
      card.className = 'pending-item-card';
      card.style.cssText = 'background: white; border: 2px solid var(--gray-300); padding: 12px; margin-bottom: 10px; transition: all 0.15s ease;';
      card.dataset.itemId = pendingItem.id;
      card.dataset.matched = 'false';

      const itemName = document.createElement('div');
      itemName.textContent = pendingItem.item_name;
      itemName.style.cssText = 'font-weight: 600; font-size: 13px; color: var(--gray-900); margin-bottom: 4px;';
      card.appendChild(itemName);

      const itemDetails = document.createElement('div');
      itemDetails.style.cssText = 'font-size: 11px; color: var(--gray-600);';
      itemDetails.innerHTML = `ORDERED: ${pendingItem.quantity_ordered} ${pendingItem.unit || ''}`;
      card.appendChild(itemDetails);

      const matchStatus = document.createElement('div');
      matchStatus.id = `matchStatus${pendingItem.id}`;
      matchStatus.style.cssText = 'margin-top: 8px; padding: 6px; background: var(--gray-100); font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--gray-600); display: none;';
      matchStatus.textContent = 'Not matched yet';
      card.appendChild(matchStatus);

      rightList.appendChild(card);
    });

    rightPanel.appendChild(rightList);
    body.appendChild(rightPanel);

    content.appendChild(body);

    // Footer with instructions and action buttons
    const footer = document.createElement('div');
    footer.style.cssText = 'padding: 20px; background: var(--gray-100); border-top: 2px solid var(--gray-300);';

    const instructions = document.createElement('div');
    instructions.id = 'matchingInstructions';
    instructions.style.cssText = 'background: #dbeafe; border: 2px solid #1e40af; padding: 12px; margin-bottom: 16px; font-size: 13px; color: #1e3a8a;';
    instructions.innerHTML = '<strong>STEP 1:</strong> Click an item from the invoice (left) to select it, then click the matching item from your pending order (right) to link them.';
    footer.appendChild(instructions);

    const actions = document.createElement('div');
    actions.style.cssText = 'display: flex; gap: 12px;';

    const cancelBtn = document.createElement('button');
    cancelBtn.textContent = 'CANCEL';
    cancelBtn.style.cssText = 'flex: 1; padding: 14px; background: var(--gray-300); color: var(--gray-700); border: 2px solid var(--gray-400); font-size: 12px; font-weight: 700; letter-spacing: 1px; cursor: pointer; text-transform: uppercase;';
    cancelBtn.onclick = () => document.body.removeChild(modal);
    actions.appendChild(cancelBtn);

    const applyBtn = document.createElement('button');
    applyBtn.textContent = 'APPLY MATCHES';
    applyBtn.style.cssText = 'flex: 2; padding: 14px; background: #059669; color: white; border: 2px solid #059669; font-size: 12px; font-weight: 700; letter-spacing: 1px; cursor: pointer; text-transform: uppercase;';
    applyBtn.onclick = () => applyAllOCRMatches(orderId, modal);
    actions.appendChild(applyBtn);

    footer.appendChild(actions);
    content.appendChild(footer);

    modal.appendChild(content);
    document.body.appendChild(modal);

    // State for matching
    orderingSystemState.ocrMatchingState = {
      selectedOCRIndex: null,
      matches: {}, // ocrIndex -> pendingItemId
      ocrItems: ocrItems,
      pendingItems: pendingItems
    };
  }

  /**
   * Select an OCR item (step 1 of matching)
   */
  function selectOCRItem(ocrIndex) {
    const state = orderingSystemState.ocrMatchingState;
    if (!state) return;

    // Deselect previously selected OCR item
    if (state.selectedOCRIndex !== null) {
      const prevCard = document.getElementById(`ocrItem${state.selectedOCRIndex}`);
      if (prevCard) {
        prevCard.style.borderColor = 'var(--gray-300)';
        prevCard.style.background = 'white';
      }
    }

    // Select new OCR item
    state.selectedOCRIndex = ocrIndex;
    const card = document.getElementById(`ocrItem${ocrIndex}`);
    if (card) {
      card.style.borderColor = '#0094D6';
      card.style.background = '#dbeafe';
    }

    // Update instructions
    const instructions = document.getElementById('matchingInstructions');
    if (instructions) {
      const ocrItem = state.ocrItems[ocrIndex];
      instructions.innerHTML = `<strong>STEP 2:</strong> Now click the matching item from your pending order (right) to link "<strong>${ocrItem.name}</strong>" with it.`;
    }

    // Enable clicking on pending items
    document.querySelectorAll('.pending-item-card').forEach(card => {
      card.style.cursor = 'pointer';
      card.onclick = () => matchOCRToPending(parseInt(card.dataset.itemId));
    });
  }

  /**
   * Match selected OCR item to a pending item (step 2 of matching)
   */
  function matchOCRToPending(pendingItemId) {
    const state = orderingSystemState.ocrMatchingState;
    if (!state || state.selectedOCRIndex === null) return;

    const ocrIndex = state.selectedOCRIndex;
    const ocrItem = state.ocrItems[ocrIndex];

    // Save match
    state.matches[ocrIndex] = pendingItemId;

    // Update OCR card (mark as matched)
    const ocrCard = document.getElementById(`ocrItem${ocrIndex}`);
    if (ocrCard) {
      ocrCard.style.borderColor = '#059669';
      ocrCard.style.background = '#d1fae5';
      ocrCard.dataset.matched = 'true';
      ocrCard.onclick = null;
      ocrCard.style.cursor = 'default';

      const matchedBadge = document.createElement('div');
      matchedBadge.style.cssText = 'margin-top: 8px; padding: 4px 8px; background: #059669; color: white; font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.8px; display: inline-block;';
      matchedBadge.textContent = '‚úì MATCHED';
      ocrCard.appendChild(matchedBadge);
    }

    // Update pending card (mark as matched)
    const pendingCard = document.getElementById(`pendingItem${pendingItemId}`);
    if (pendingCard) {
      pendingCard.style.borderColor = '#059669';
      pendingCard.style.background = '#d1fae5';
      pendingCard.dataset.matched = 'true';
      pendingCard.onclick = null;
      pendingCard.style.cursor = 'default';

      const matchStatus = document.getElementById(`matchStatus${pendingItemId}`);
      if (matchStatus) {
        matchStatus.style.display = 'block';
        matchStatus.style.background = '#d1fae5';
        matchStatus.style.color = '#065f46';
        matchStatus.innerHTML = `‚úì Matched to: <strong>${ocrItem.name}</strong><br>Price: $${ocrItem.price.toFixed(2)}${ocrItem.quantity ? ` | Qty: ${ocrItem.quantity}` : ''}`;
      }
    }

    // Reset selection
    state.selectedOCRIndex = null;

    // Update instructions
    const instructions = document.getElementById('matchingInstructions');
    if (instructions) {
      const unmatchedOCR = state.ocrItems.filter((_, i) => !state.matches[i]).length;
      instructions.innerHTML = `<strong>Match saved!</strong> ${unmatchedOCR} invoice items remaining. Click another invoice item to continue matching, or click APPLY MATCHES to update your order.`;
    }
  }

  /**
   * Apply all OCR matches to the pending order
   */
  async function applyAllOCRMatches(orderId, modal) {
    const state = orderingSystemState.ocrMatchingState;
    if (!state) return;

    showLoading('Applying Matches', 'Updating order with invoice data...');

    try {
      const updates = [];
      const newItems = [];
      const priceChanges = [];

      // Process matched items
      Object.keys(state.matches).forEach(ocrIndex => {
        const pendingItemId = state.matches[ocrIndex];
        const ocrItem = state.ocrItems[ocrIndex];
        const pendingItem = state.pendingItems.find(p => p.id === pendingItemId);

        if (pendingItem) {
          // Check if price is different
          const currentPrice = orderingSystemState.checkInItems[pendingItemId]?.price;
          if (currentPrice && Math.abs(currentPrice - ocrItem.price) > 0.01) {
            priceChanges.push({
              itemName: pendingItem.item_name,
              oldPrice: currentPrice,
              newPrice: ocrItem.price
            });
          }

          // Update check-in state
          orderingSystemState.checkInItems[pendingItemId].price = ocrItem.price;
          if (ocrItem.quantity) {
            orderingSystemState.checkInItems[pendingItemId].received = ocrItem.quantity;
          }
        }
      });

      // Process unmatched OCR items (add as new lines)
      state.ocrItems.forEach((ocrItem, index) => {
        if (!state.matches[index]) {
          newItems.push(ocrItem);
        }
      });

      // Mark unmatched pending items as "not found"
      state.pendingItems.forEach(pendingItem => {
        const isMatched = Object.values(state.matches).includes(pendingItem.id);
        if (!isMatched) {
          // Mark as not found in notes
          if (orderingSystemState.checkInItems[pendingItem.id]) {
            const currentNotes = orderingSystemState.checkInItems[pendingItem.id].notes || '';
            orderingSystemState.checkInItems[pendingItem.id].notes = currentNotes ? `${currentNotes} | NOT ON INVOICE` : 'NOT ON INVOICE';
          }
        }
      });

      hideLoading();
      document.body.removeChild(modal);

      // Update the UI with new values
      Object.keys(orderingSystemState.checkInItems).forEach(itemId => {
        const item = orderingSystemState.checkInItems[itemId];

        // Update price input
        const priceInput = document.getElementById(`price${itemId}`);
        if (priceInput && item.price) {
          priceInput.value = formatCurrencyInput(item.price);
          priceInput.style.borderColor = '#059669';
          priceInput.style.background = '#d1fae5';
        }

        // Update received quantity
        const receivedInput = document.getElementById(`receivedQty${itemId}`);
        if (receivedInput && item.received) {
          receivedInput.value = item.received;
          receivedInput.style.borderColor = 'var(--gray-300)';
          receivedInput.style.background = 'white';
        }

        // Update notes
        const notesInput = document.getElementById(`notes${itemId}`);
        if (notesInput && item.notes) {
          notesInput.value = item.notes;
          if (item.notes.includes('NOT ON INVOICE')) {
            notesInput.style.borderColor = '#f59e0b';
            notesInput.style.background = '#fffbeb';
          }
        }
      });

      // Show summary
      let summaryMsg = `‚úì Applied ${Object.keys(state.matches).length} matches from invoice!\n\n`;

      if (priceChanges.length > 0) {
        summaryMsg += `<strong>Price Updates:</strong>\n`;
        priceChanges.forEach(change => {
          summaryMsg += `‚Ä¢ ${change.itemName}: $${change.oldPrice.toFixed(2)} ‚Üí $${change.newPrice.toFixed(2)}\n`;
        });
        summaryMsg += '\n';
      }

      if (newItems.length > 0) {
        summaryMsg += `<strong>${newItems.length} unmatched items</strong> from invoice. Add them manually if needed.\n\n`;
      }

      const unmatchedPending = state.pendingItems.filter(p => !Object.values(state.matches).includes(p.id)).length;
      if (unmatchedPending > 0) {
        summaryMsg += `<strong>${unmatchedPending} pending items</strong> were not found on invoice (marked in notes).`;
      }

      showMessage(summaryMsg, 'success');

      // Scroll to check-in view
      document.getElementById('pendingOrderCheckInView').scrollIntoView({ behavior: 'smooth', block: 'start' });

    } catch (error) {
      hideLoading();
      console.error('Error applying OCR matches:', error);
      showMessage('Failed to apply matches: ' + error.message, 'error');
    }
  }

  async function deleteCheckInItem(itemId, orderId) {
    showLoading('Removing Item', 'Deleting item from pending order...');

    try {
      const { error } = await supabase
        .from('pending_order_items')
        .delete()
        .eq('id', itemId);

      if (error) throw error;

      delete orderingSystemState.checkInItems[itemId];

      hideLoading();
      showMessage('Item removed from pending order', 'success');

      await loadPendingOrderForCheckIn(orderId);
    } catch (error) {
      hideLoading();
      console.error('Failed to delete check-in item:', error);
      showMessage('Failed to delete item: ' + error.message, 'error');
    }
  }

  async function confirmPendingOrder(orderId) {
    const items = Object.values(orderingSystemState.checkInItems || {});

    if (!items.length) {
      showMessage('No items left to receive for this order.', 'error');
      return;
    }

    let hasPriceError = false;
    items.forEach(item => {
      const priceInput = document.getElementById(`price${item.id}`);
      const value = Number(item.price);
      if (!Number.isFinite(value) || value <= 0) {
        hasPriceError = true;
        if (priceInput) {
          priceInput.style.borderColor = '#dc2626';
          priceInput.style.background = '#fee2e2';
        }
      }
    });

    if (hasPriceError) {
      showMessage('Enter a valid price for every item before confirming.', 'error');
      return;
    }

    showLoading('Confirming Order', 'Updating inventory and closing order...');

    try {
      for (const item of items) {
        const receivedQty = Number(item.received) || 0;
        const orderedQty = Number(item.ordered) || 0;

        const { error: updateItemError } = await supabase
          .from('pending_order_items')
          .update({
            quantity_received: receivedQty,
            variance: receivedQty - orderedQty,
            unit_price: item.price,
            receiving_notes: item.notes || null
          })
          .eq('id', item.id);

        if (updateItemError) throw updateItemError;

        if (item.inventoryItemId && receivedQty > 0) {
          const { data: currentItem, error: fetchError } = await supabase
            .from('inventory_items')
            .select('current_stock, current_unit_cost, vendor')
            .eq('id', item.inventoryItemId)
            .single();

          if (fetchError) throw fetchError;

          const currentStock = Number(currentItem?.current_stock) || 0;
          const newStock = currentStock + receivedQty;
          const oldPrice = Number(currentItem?.current_unit_cost) || 0;
          const newPrice = Number(item.price) || 0;

          const { error: inventoryError } = await supabase
            .from('inventory_items')
            .update({
              current_stock: newStock,
              last_counted_date: getPacificDate(),
              current_unit_cost: newPrice,
              last_cost_update: new Date().toISOString()
            })
            .eq('id', item.inventoryItemId);

          if (inventoryError) throw inventoryError;

          // Save price history if price changed
          if (oldPrice > 0 && newPrice > 0 && oldPrice !== newPrice) {
            const priceChangePercent = ((newPrice - oldPrice) / oldPrice) * 100;

            const { error: priceHistoryError } = await supabase
              .from('price_history')
              .insert({
                inventory_item_id: item.inventoryItemId,
                vendor: currentItem.vendor,
                old_price: oldPrice,
                new_price: newPrice,
                price_change_percent: priceChangePercent,
                source: 'pending_order',
                source_id: orderId,
                updated_at: new Date().toISOString()
              });

            if (priceHistoryError) {
              console.error('Failed to save price history:', priceHistoryError);
            } else {
              console.log(`üí∞ Price history saved: ${item.name} - $${oldPrice.toFixed(2)} ‚Üí $${newPrice.toFixed(2)} (${priceChangePercent > 0 ? '+' : ''}${priceChangePercent.toFixed(1)}%)`);
            }
          }
        }
      }

      const allReceived = items.every(item => (Number(item.received) || 0) >= (Number(item.ordered) || 0));
      const anyReceived = items.some(item => (Number(item.received) || 0) > 0);

      const { error: orderError } = await supabase
        .from('pending_orders')
        .update({
          status: anyReceived ? (allReceived ? 'completed' : 'partial') : 'pending',
          received_date: anyReceived ? getPacificDate() : null,
          updated_at: new Date().toISOString()
        })
        .eq('id', orderId);

      if (orderError) throw orderError;

      hideLoading();
      showMessage('üéâ Order confirmed and inventory updated!', 'success');

      const container = document.getElementById('pendingOrderCheckInView');
      if (container) {
        container.style.display = 'none';
        container.innerHTML = '';
      }

      orderingSystemState.selectedPendingOrderId = null;
      orderingSystemState.currentCheckInOrder = null;
      orderingSystemState.checkInItems = {};

      await loadInventoryData();
      await loadAllPendingOrders();
      await loadOrdersDueTodayAlert();
      calculateUpcomingOrders();
      renderReceivePendingOrders();

    } catch (error) {
      hideLoading();
      console.error('Failed to confirm order:', error);
      showMessage('Failed to confirm order: ' + error.message, 'error');
    }
  }

  /**
   * Load inventory data from database
   */
  async function loadInventoryData() {
    if (!supabase) {
      console.error('Supabase is not initialized!');
      throw new Error('Database not connected');
    }

    console.log('showLoading called...');
    showLoading('Loading Inventory', 'Fetching items from database...');

    try {
      console.log('Querying inventory_items table...');
      const { data, error } = await supabase
        .from('inventory_items')
        .select('*')
        .order('vendor', { ascending: true })
        .order('item_name', { ascending: true });

      console.log('Query result - error:', error);
      console.log('Query result - data:', data);
      console.log('Number of items loaded:', data?.length || 0);

      if (error) throw error;

      orderingSystemState.items = (data || []).map(item => ({
        id: item.id,
        itemName: item.item_name,
        vendor: item.vendor,
        parLevel: item.par_level || 0,
        currentStock: item.current_stock || 0,
        unit: item.unit,
        lastCountedDate: item.last_counted_date,
        countedBy: item.counted_by, // Who counted this item (staff name)
        countedAt: item.counted_at, // When this item was counted (ISO timestamp)
        currentUnitCost: item.current_unit_cost,
        lastCostUpdate: item.last_cost_update,
        itemType: item.item_type || 'ingredient', // Track if item is 'prep' or 'ingredient'
        urgent: item.urgent || false, // Track urgent flag for MAKE FIRST category
        lineCooksPrep: item.line_cooks_prep || false, // Track line cooks prep items
        notMadeDaily: item.not_made_daily || false, // Track items not made daily
        batchLifespan: item.batch_lifespan_hours,
        storageLocation: item.storage_location,
        lastInvoiceQty: item.last_invoice_qty, // Track quantity added from latest invoice
        lastInvoiceDate: item.last_invoice_date, // Track when latest invoice was received
        showInBottleCount: item.show_in_bottle_count || false, // Track if item should appear in bottle count
        hasMultipleLocations: item.has_multiple_locations || false, // Track if item uses multi-location counting
        locationCounts: item.location_counts || {} // Location-specific counts (JSONB)
      }));

      console.log('orderingSystemState.items:', orderingSystemState.items);
      console.log('orderingSystemState.items.length:', orderingSystemState.items.length);

      // LEARNING: Load aliases from past successful matches with intelligence
      // Prioritize manual matches (100% confidence) and frequent matches
      console.log('Loading learned aliases from invoice history...');
      const { data: aliasData, error: aliasError } = await supabase
        .from('invoice_items')
        .select('detected_item_name, inventory_item_id, match_confidence, checked_in_at')
        .eq('checked_in', true)
        .not('detected_item_name', 'is', null)
        .not('inventory_item_id', 'is', null)
        .order('checked_in_at', { ascending: false }); // Most recent first

      if (!aliasError && aliasData) {
        orderingSystemState.aliases = {};
        
        // Build frequency map to prioritize common matches
        const aliasFrequency = {};
        aliasData.forEach(alias => {
          const normalized = alias.detected_item_name.toLowerCase().replace(/[^a-z0-9\s]/g, '');
          const key = `${normalized}:${alias.inventory_item_id}`;
          aliasFrequency[key] = (aliasFrequency[key] || 0) + 1;
        });

        // Process aliases with intelligent prioritization
        aliasData.forEach(alias => {
          const normalized = alias.detected_item_name.toLowerCase().replace(/[^a-z0-9\s]/g, '');
          const key = `${normalized}:${alias.inventory_item_id}`;
          const frequency = aliasFrequency[key];
          const isManualMatch = alias.match_confidence === 1.0;
          
          // Only store if:
          // 1. Not already stored (keeps most recent)
          // 2. OR this is a manual match (100% confidence) overriding auto-match
          // 3. OR this match appears frequently (3+ times)
          if (!orderingSystemState.aliases[normalized] || 
              isManualMatch || 
              frequency >= 3) {
            orderingSystemState.aliases[normalized] = {
              inventory_item_id: alias.inventory_item_id,
              detected_name: alias.detected_item_name,
              confidence: alias.match_confidence,
              frequency: frequency,
              is_manual: isManualMatch
            };
          }
        });
        
        console.log('‚úÖ Loaded', Object.keys(orderingSystemState.aliases).length, 'learned aliases');
        console.log('üìä Manual matches:', Object.values(orderingSystemState.aliases).filter(a => a.is_manual).length);
        console.log('üìä Frequent matches (3+):', Object.values(orderingSystemState.aliases).filter(a => a.frequency >= 3).length);
      }

      orderingSystemState.lastUpdated = new Date();
      refreshPriceHistoryControls();
      refreshBottleCount(); // Auto-load bottle count
      hideLoading();
      console.log('hideLoading called');
    } catch (error) {
      hideLoading();
      console.error('loadInventoryData error:', error);
      throw new Error(`Failed to load inventory: ${error.message}`);
    }
  }

  /**
   * Calculate upcoming orders for next 7 days
   */
  function calculateUpcomingOrders() {
    console.log('calculateUpcomingOrders() called');
    const now = getPacificMidday();
    const orders = [];

    // Check next 7 days
    for (let i = 0; i < 7; i++) {
      const checkDate = addPacificDays(now, i);
      const dayName = formatPacificWeekday(checkDate);

      // Greenleaf - Daily orders (except Saturday)
      if (dayName !== 'Saturday') {
        const greenleafOrder = calculateGreenleafOrder(checkDate, dayName);
        if (greenleafOrder) orders.push(greenleafOrder);
      }

      // Performance - Sunday and Wednesday
      if (dayName === 'Sunday' || dayName === 'Wednesday') {
        const performanceOrder = calculatePerformanceOrder(checkDate, dayName);
        if (performanceOrder) orders.push(performanceOrder);
      }

      // Mani Imports - Tuesday and Thursday
      if (dayName === 'Tuesday' || dayName === 'Thursday') {
        const maniOrder = calculateManiOrder(checkDate, dayName);
        if (maniOrder) orders.push(maniOrder);
      }

      // Eatopia - Any Wednesday for Thursday delivery
      if (dayName === 'Wednesday') {
        const eatopiaOrder = calculateEatopiaOrder(checkDate);
        if (eatopiaOrder) orders.push(eatopiaOrder);
      }
    }

    // Filter to only show NEXT order per vendor (not all 7 days)
    const nextOrdersByVendor = {};
    orders.forEach(order => {
      if (!nextOrdersByVendor[order.vendor] || order.orderDate < nextOrdersByVendor[order.vendor].orderDate) {
        nextOrdersByVendor[order.vendor] = order;
      }
    });

    orderingSystemState.calculatedOrders = Object.values(nextOrdersByVendor);
    console.log('Filtered to next order per vendor:', orderingSystemState.calculatedOrders.length, 'orders');

    // Load any saved edits from previous sessions
    orderingSystemState.calculatedOrders.forEach(order => {
      loadOrderEditsFromStorage(order);
    });
  }

  /**
   * Calculate Greenleaf order
   */
  function calculateGreenleafOrder(orderDate, dayName) {
    const isFriday = dayName === 'Friday';
    const multiplier = isFriday ? 2 : 1; // Friday covers Sat + Sun

    const items = orderingSystemState.items
      .filter(item => item.vendor === 'Greenleaf')
      .map(item => ({
        id: item.id,
        itemName: item.itemName,
        quantity: Math.max(0, Math.ceil((item.parLevel - item.currentStock) * multiplier)),
        unit: item.unit,
        parLevel: item.parLevel,
        currentStock: item.currentStock,
        lastCountedDate: item.lastCountedDate,
        currentUnitCost: item.currentUnitCost,
        lastCostUpdate: item.lastCostUpdate
      }))
      .filter(item => item.quantity > 0);

    if (items.length === 0) return null;

    const deliveryDate = addPacificDays(orderDate, 1);

    return {
      vendor: 'Greenleaf',
      orderDate: orderDate,
      cutoffTime: '10:00 PM',
      deliveryDate: deliveryDate,
      items: items,
      notes: isFriday ? 'üö® 2-DAY SUPPLY for Saturday and Sunday' : null
    };
  }

  /**
   * Calculate Performance order
   */
  function calculatePerformanceOrder(orderDate, dayName) {
    const items = orderingSystemState.items
      .filter(item => item.vendor === 'Performance')
      .map(item => ({
        id: item.id,
        itemName: item.itemName,
        quantity: Math.max(0, item.parLevel - item.currentStock),
        unit: item.unit,
        parLevel: item.parLevel,
        currentStock: item.currentStock,
        lastCountedDate: item.lastCountedDate,
        currentUnitCost: item.currentUnitCost,
        lastCostUpdate: item.lastCostUpdate
      }))
      .filter(item => item.quantity > 0);

    if (items.length === 0) return null;

    const deliveryDate = addPacificDays(orderDate, 1);

    return {
      vendor: 'Performance',
      orderDate: orderDate,
      cutoffTime: '3:00 PM',
      deliveryDate: deliveryDate,
      items: items,
      notes: dayName === 'Sunday' ? 'Delivery Monday morning' : 'Delivery Thursday morning'
    };
  }

  /**
   * Calculate Mani Imports order
   */
  function calculateManiOrder(orderDate, dayName) {
    const isThursday = dayName === 'Thursday';
    const multiplier = isThursday ? 5 : 3; // Thursday = 5 days, Tuesday = 3 days

    const items = orderingSystemState.items
      .filter(item => item.vendor === 'Mani Imports')
      .map(item => ({
        id: item.id,
        itemName: item.itemName,
        quantity: Math.max(0, Math.ceil((item.parLevel - item.currentStock) * (multiplier / 7))),
        unit: item.unit,
        parLevel: item.parLevel,
        currentStock: item.currentStock,
        lastCountedDate: item.lastCountedDate,
        currentUnitCost: item.currentUnitCost,
        lastCostUpdate: item.lastCostUpdate
      }))
      .filter(item => item.quantity > 0);

    if (items.length === 0) return null;

    const deliveryDate = addPacificDays(orderDate, 1);

    return {
      vendor: 'Mani Imports',
      orderDate: orderDate,
      cutoffTime: '3:00 PM',
      deliveryDate: deliveryDate,
      items: items,
      notes: isThursday ? 'üö® LARGE ORDER - 5-day supply covering weekend' : 'Small order - 3-day supply'
    };
  }

  /**
   * Calculate Eatopia order
   */
  function calculateEatopiaOrder(orderDate) {
    const items = orderingSystemState.items
      .filter(item => item.vendor === 'Eatopia Foods')
      .map(item => ({
        id: item.id,
        itemName: item.itemName,
        quantity: Math.max(0, item.parLevel - item.currentStock),
        unit: item.unit,
        parLevel: item.parLevel,
        currentStock: item.currentStock,
        lastCountedDate: item.lastCountedDate,
        currentUnitCost: item.currentUnitCost,
        lastCostUpdate: item.lastCostUpdate
      }))
      .filter(item => item.quantity > 0);

    if (items.length === 0) return null;

    const deliveryDate = addPacificDays(orderDate, 1); // Thursday delivery

    return {
      vendor: 'Eatopia Foods',
      orderDate: orderDate,
      cutoffTime: 'Flexible',
      deliveryDate: deliveryDate,
      items: items,
      notes: 'Delivery always on Thursday'
    };
  }

  /**
   * Format timestamp as relative time with precise hours and minutes
   * Examples: "32m ago", "1hr and 32m ago", "5d ago"
   */
function formatRelativeTime(dateStr) {
  if (!dateStr) return 'Never';

  // Use actual timestamps, NOT midday-normalized dates (that loses hour/minute precision!)
  const date = parsePacificDate(dateStr) || new Date(dateStr);
  const now = new Date();
  
  // Calculate difference in milliseconds using actual timestamps
  const diffMs = now - date;
  const diffMinutes = Math.floor(diffMs / (1000 * 60));
  const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
  const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

  // Format: "15 mins ago", "1 hour ago", "1 hour and 32 mins ago", "1 day ago", "1 day, 4 hours, 34 minutes ago"
  if (diffMinutes < 60) {
    const minutes = Math.max(diffMinutes, 0);
    return `${minutes} min${minutes === 1 ? '' : 's'} ago`;
  }

  if (diffHours < 24) {
    const hours = diffHours;
    const minutes = diffMinutes % 60;
    if (minutes > 0) {
      return `${hours} hour${hours === 1 ? '' : 's'} and ${minutes} min${minutes === 1 ? '' : 's'} ago`;
    } else {
      return `${hours} hour${hours === 1 ? '' : 's'} ago`;
    }
  }

  // More than 24 hours: Always show detailed breakdown
  const days = diffDays;
  const remainingHours = diffHours % 24;
  const remainingMinutes = diffMinutes % 60;
  
  let result = `${days} day${days === 1 ? '' : 's'}`;
  
  // Always add hours and minutes if present (removed the shortcut for "1 day ago")
  if (remainingHours > 0) {
    result += `, ${remainingHours} hour${remainingHours === 1 ? '' : 's'}`;
  }
  if (remainingMinutes > 0) {
    result += `, ${remainingMinutes} minute${remainingMinutes === 1 ? '' : 's'}`;
  }
  
  return result + ' ago';
}

async function renderReceivePendingOrders() {
  const container = document.getElementById('pendingOrderCheckInView');
  if (!container || !container.parentNode) return;

  let pendingSection = document.getElementById('receivePendingOrdersSection');
  if (!pendingSection) {
    pendingSection = document.createElement('div');
    pendingSection.id = 'receivePendingOrdersSection';
    pendingSection.style.cssText = 'margin-top: 32px; border: 2px solid var(--gray-300); background: white;';
    container.parentNode.insertBefore(pendingSection, container.nextSibling);
  }

  pendingSection.innerHTML = `
    <div style="padding: 16px 20px; border-bottom: 2px solid var(--gray-300); background: var(--gray-100);">
      <h3 style="margin: 0 0 6px 0; color: var(--gray-900); text-transform: uppercase; letter-spacing: 1px; font-size: 16px;">Pending Orders to Check In</h3>
      <p style="margin: 0; color: var(--gray-600); font-size: 12px;">Select an order to review received quantities, enter prices, and confirm delivery.</p>
    </div>
    <div id="receiveOrdersList" style="padding: 0 20px 20px 20px;">Loading...</div>
  `;

  let listContainer = document.getElementById('receiveOrdersList');

  try {
    const { data: orders, error } = await supabase
      .from('pending_orders')
      .select(`
        id,
        vendor,
        order_date,
        expected_delivery_date,
        status,
        total_items,
        notes,
        pending_order_items (
          id,
          inventory_item_id,
          quantity_ordered,
          quantity_received,
          variance,
          unit,
          item_name,
          unit_price,
          receiving_notes
        )
      `)
      .in('status', ['pending', 'partial'])
      .order('expected_delivery_date', { ascending: true });

    if (error) throw error;

    if (!orders || orders.length === 0) {
      listContainer.innerHTML = '<p style="padding: 20px; color: var(--gray-600); font-size: 13px;">No pending orders found.</p>';
      return;
    }

    const today = getPacificDate();

    listContainer.innerHTML = orders.map(order => {
      const deliveryDate = parsePacificDate(order.expected_delivery_date);
      let badgeColor = '#d1fae5';
      let badgeBorder = '#059669';
      let badgeText = '#064e3b';
      let badgeLabel = 'Future Delivery';

      if (deliveryDate) {
        const deliveryDateStr = formatPacificDate(deliveryDate);
        if (deliveryDateStr === today) {
          badgeColor = '#fef3c7';
          badgeBorder = '#f59e0b';
          badgeText = '#92400e';
          badgeLabel = 'Due Today';
        } else if (deliveryDate < parsePacificDate(today)) {
          badgeColor = '#fee2e2';
          badgeBorder = '#b91c1c';
          badgeText = '#7f1d1d';
          badgeLabel = 'Past Due';
        }
      }

      const deliveryDisplay = deliveryDate
        ? formatPacificDateDisplay(deliveryDate, { month: 'short', day: 'numeric', year: 'numeric', weekday: 'long' })
        : 'Unknown';

      const previewItems = (order.pending_order_items || []).slice(0, 3).map(item => {
        const priceText = item.unit_price != null ? `$${Number(item.unit_price).toFixed(2)}` : 'No price';
        return `<div style="display:flex;justify-content:space-between;font-size:11px;color:var(--gray-600);margin-top:6px;">
                  <span style="font-weight:600;color:var(--gray-700);">${item.item_name}</span>
                  <span>${item.quantity_ordered} ${item.unit || ''} ‚Ä¢ ${priceText}</span>
                </div>`;
      }).join('');

      const remainingCount = Math.max(0, (order.pending_order_items || []).length - 3);
      const remainingText = remainingCount > 0
        ? `<div style='font-size:11px;color:var(--gray-500);margin-top:6px;'>+${remainingCount} more items</div>`
        : '';

      return `
        <div class="receive-order-card" data-order-id="${order.id}" style="border:2px solid var(--gray-300);margin-top:16px;background:white;cursor:pointer;">
          <div style="display:flex;justify-content:space-between;align-items:flex-start;padding:16px 18px;gap:18px;">
            <div style="flex:1;">
              <h4 style="margin:0 0 6px 0;color:var(--gray-900);font-size:15px;">${order.vendor}</h4>
              <div style="font-size:12px;color:var(--gray-600);">Ordered: ${order.order_date || 'Unknown'}</div>
              <div style="font-size:12px;color:var(--gray-600);">Expected: ${deliveryDisplay}</div>
              <div style="font-size:12px;color:var(--gray-600);">${order.total_items || 0} item(s)</div>
            </div>
            <div style="min-width:140px;">
              <span style="display:inline-block;padding:6px 10px;background:${badgeColor};border:2px solid ${badgeBorder};color:${badgeText};font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.8px;">${badgeLabel}</span>
            </div>
          </div>
          <div style="padding:0 18px 14px 18px;">
            ${previewItems}
            ${remainingText}
          </div>
        </div>`;
    }).join('');

    listContainer.querySelectorAll('.receive-order-card').forEach(card => {
      card.addEventListener('click', () => {
        const orderId = Number(card.dataset.orderId);
        loadPendingOrderForCheckIn(orderId);
        listContainer.querySelectorAll('.receive-order-card').forEach(el => el.style.borderColor = 'var(--gray-300)');
        card.style.borderColor = '#2563eb';
      });
    });

  } catch (error) {
    console.error('Failed to load pending orders for receive view:', error);
    listContainer = document.getElementById('receiveOrdersList');
    if (listContainer) {
      listContainer.innerHTML = `<p style="padding:20px;color:#dc2626;font-size:13px;">Failed to load pending orders: ${error.message}</p>`;
    }
  }
}

function formatCurrency(value) {
  if (value === null || value === undefined || Number.isNaN(Number(value))) return '--';
  return `$${Number(value).toFixed(2)}`;
}

function formatPercentage(value) {
  if (value === null || value === undefined || Number.isNaN(Number(value))) return '';
  return `${Number(value).toFixed(1)}%`;
}

function getPriceCache() {
  if (!orderingSystemState.priceHistory.cache) {
    orderingSystemState.priceHistory.cache = new Map();
  }
  return orderingSystemState.priceHistory.cache;
}

function formatPriceDateLabel(date) {
  if (!date) return '';
  const dateObj = date instanceof Date ? date : (parsePacificDate(date) || new Date(date));
  return formatPacificDateDisplay(dateObj, { month: 'short', day: 'numeric' });
}

// Load latest + previous invoice prices for the requested inventory items and cache results
async function ensurePriceSnapshotsForItems(itemIds) {
  if (!itemIds || itemIds.length === 0) return;

  const cache = getPriceCache();
  const uniqueIds = Array.from(new Set(
    itemIds
      .map(id => parseInt(id, 10))
      .filter(id => !Number.isNaN(id))
  ));

  const missing = uniqueIds.filter(id => !cache.has(id));
  if (missing.length === 0) return;

  try {
    const { data, error } = await supabase
      .from('invoice_items')
      .select('inventory_item_id, invoice_id, unit_price, detected_price, created_at')
      .in('inventory_item_id', missing)
      .order('created_at', { ascending: false })
      .limit(missing.length * 40);

    if (error) {
      console.warn('Failed to load price snapshots:', error);
      return;
    }

    const invoiceIds = Array.from(new Set((data || []).map(row => row.invoice_id).filter(id => id != null)));
    const invoiceMap = new Map();
    if (invoiceIds.length) {
      const { data: invoiceRows, error: invoiceError } = await supabase
        .from('invoices')
        .select('id, invoice_date, vendor_name, vendor')
        .in('id', invoiceIds);

      if (!invoiceError && invoiceRows) {
        invoiceRows.forEach(row => {
          invoiceMap.set(row.id, row);
        });
      }
    }

    const grouped = new Map();
    (data || []).forEach(row => {
      const itemId = row.inventory_item_id;
      if (!itemId) return;

      const priceValue = row.unit_price ?? row.detected_price;
      if (priceValue === null || priceValue === undefined) return;

      const invoice = row.invoice_id != null ? invoiceMap.get(row.invoice_id) : null;
      const invoiceDate = invoice?.invoice_date || row.created_at;
      const invoiceDateObj = parsePacificDate(invoiceDate) || new Date(invoiceDate);

      const entry = {
        price: Number(priceValue),
        invoiceDate,
        invoiceDateObj,
        vendor: invoice?.vendor_name || invoice?.vendor || null,
        invoiceId: invoice?.id || row.invoice_id || null,
        createdAt: row.created_at
      };

      if (!grouped.has(itemId)) grouped.set(itemId, []);
      grouped.get(itemId).push(entry);
    });

    grouped.forEach((entries, itemId) => {
      entries.sort((a, b) => {
        const aTime = a.invoiceDateObj ? a.invoiceDateObj.getTime() : 0;
        const bTime = b.invoiceDateObj ? b.invoiceDateObj.getTime() : 0;
        return bTime - aTime;
      });

      const latest = entries[0] || null;
      const previous = entries.find(entry => entry !== latest) || null;

      cache.set(itemId, {
        history: entries,
        latest,
        previous,
        fetchedAt: new Date()
      });
    });

    missing.forEach(id => {
      if (!cache.has(id)) {
        cache.set(id, {
          history: [],
          latest: null,
          previous: null,
          fetchedAt: new Date()
        });
      }
    });
  } catch (err) {
    console.warn('Error fetching price snapshots:', err);
  }
}

function getPriceInfoForInventoryId(itemId, fallbackPrice, fallbackDate) {
  if (!itemId && itemId !== 0) return {
    latestPrice: fallbackPrice != null ? Number(fallbackPrice) : null,
    latestDate: fallbackDate || null,
    previousPrice: null,
    previousDate: null,
    diff: null,
    diffPct: null
  };

  const cache = getPriceCache();
  const snapshot = cache.get(Number(itemId));

  const latestPrice = snapshot?.latest?.price ?? (fallbackPrice != null ? Number(fallbackPrice) : null);
  const latestDate = snapshot?.latest?.invoiceDate || fallbackDate || null;
  const previousPrice = snapshot?.previous?.price ?? null;
  const previousDate = snapshot?.previous?.invoiceDate || null;
  const diff = latestPrice != null && previousPrice != null ? latestPrice - previousPrice : null;
  const diffPct = diff != null && previousPrice !== 0 ? (diff / previousPrice) * 100 : null;

  return {
    latestPrice,
    latestDate,
    previousPrice,
    previousDate,
    diff,
    diffPct
  };
}

function getPriceInfoForItem(item) {
  if (!item) return getPriceInfoForInventoryId(null, null, null);
  return getPriceInfoForInventoryId(item.id, item.currentUnitCost, item.lastCostUpdate);
}

// Render a compact price summary (current value + arrow delta) for table display
function renderPriceTrendHtml(info) {
  const latest = info.latestPrice != null ? formatCurrency(info.latestPrice) : '--';
  const latestDateLabel = info.latestDate ? ` (${formatPriceDateLabel(info.latestDate)})` : '';

  let trendHtml = '';
  if (info.diff != null && info.previousPrice != null) {
    const arrow = info.diff > 0 ? '‚ñ≤' : info.diff < 0 ? '‚ñº' : '‚Ä¢';
    const color = info.diff > 0 ? '#c62828' : info.diff < 0 ? '#2e7d32' : 'var(--gray-500)';
    const diffAbs = formatCurrency(Math.abs(info.diff));
    const pct = info.diffPct != null ? formatPercentage(Math.abs(info.diffPct)) : '';
    const prevDate = info.previousDate ? formatPriceDateLabel(info.previousDate) : '';
    trendHtml = `<span style="color: ${color}; font-weight: 600; font-size: 11px;">${arrow} ${diffAbs}${pct ? ` (${pct})` : ''}${prevDate ? ` vs ${prevDate}` : ''}</span>`;
  } else if (info.previousPrice == null) {
    trendHtml = '<span style="color: var(--gray-500); font-size: 11px;">No prior price</span>';
  } else {
    trendHtml = '<span style="color: var(--gray-500); font-size: 11px;">No change</span>';
  }

  return `
    <div style="display: flex; flex-direction: column; gap: 2px;">
      <span style="font-weight: 700; color: var(--gray-900);">${latest}${latestDateLabel}</span>
      ${trendHtml}
    </div>
  `;
}

// Render price comparison for a new invoice price against cached historical values
function renderIncomingPriceHtml(itemId, incomingPrice, invoiceDate) {
  if (incomingPrice === null || incomingPrice === undefined || Number.isNaN(Number(incomingPrice))) {
    return '<span style="color: var(--gray-500); font-size: 11px;">No price on invoice</span>';
  }

  const cache = getPriceCache();
  const snapshot = cache.get(Number(itemId));
  const previousEntry = snapshot?.latest || snapshot?.previous || null;
  const previousPrice = previousEntry?.price ?? null;
  const info = {
    latestPrice: Number(incomingPrice),
    latestDate: invoiceDate || null,
    previousPrice,
    previousDate: previousEntry?.invoiceDate || null,
    diff: previousPrice != null ? Number(incomingPrice) - previousPrice : null,
    diffPct: previousPrice != null && previousPrice !== 0 ? ((Number(incomingPrice) - previousPrice) / previousPrice) * 100 : null
  };

  return renderPriceTrendHtml(info);
}

// Ensure price snapshots are loaded before rendering upcoming AI suggestions
async function refreshUpcomingOrdersUI(targetContainer) {
  const orders = orderingSystemState.calculatedOrders || [];
  const itemIds = [];
  orders.forEach(order => {
    (order.items || []).forEach(item => {
      if (item && item.id != null) {
        itemIds.push(item.id);
      }
    });
  });

  if (itemIds.length) {
    await ensurePriceSnapshotsForItems(itemIds);
  }

  orderingSystemState.lastUpdated = new Date();
  renderUpcomingOrders(targetContainer);
}

  /**
   * Format price with date (e.g., "$24.38 (9/22/25)")
   * Matches email format
   */
  function formatPriceWithDate(price, dateStr) {
    if (!price) return '';

    const formattedPrice = '$' + parseFloat(price).toFixed(2);

    if (!dateStr) return formattedPrice;

    const pacificDate = parsePacificDate(dateStr) || new Date(dateStr);
    const formattedDate = pacificDate
      ? formatPacificDateDisplay(pacificDate, { month: 'numeric', day: 'numeric', year: '2-digit' })
      : '';

    return `${formattedPrice} (${formattedDate})`;
  }

  /**
   * Render upcoming orders (AI suggestions)
   */
  function renderUpcomingOrders(targetContainer) {
    const container = targetContainer || document.getElementById('upcomingOrders');

    // Exit early if container doesn't exist (prevents errors when called from other tabs)
    if (!container) {
      console.warn('renderUpcomingOrders: Container not found, skipping render');
      return;
    }

    // Add section header
    let html = `
      <div style="margin-bottom: 20px; padding-bottom: 12px; border-bottom: 3px solid var(--gray-300);">
        <h3 style="color: var(--gray-900); margin: 0; font-size: 18px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;">AI-SUGGESTED ORDERS</h3>
        <p style="color: var(--gray-600); font-size: 12px; margin: 8px 0 0 0;">Based on current stock levels and par requirements</p>
      </div>
    `;

    if (orderingSystemState.calculatedOrders.length === 0) {
      html += `
        <div style="text-align: center; padding: 40px; background: #f0f4f8; border-radius: 4px;">
          <p style="font-size: 16px; color: #666;">‚úÖ No orders needed in the next 7 days!</p>
          <p style="font-size: 14px; color: #999; margin-top: 10px;">All inventory levels are sufficient.</p>
        </div>
      `;
      container.innerHTML = html;
      return;
    }

    html += `
      <div style="font-size: 12px; color: #666; margin-bottom: 20px;">
        Last updated: ${
          orderingSystemState.lastUpdated
            ? formatPacificDateDisplay(orderingSystemState.lastUpdated, {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
              })
            : 'Never'
        }
      </div>
    `;

    orderingSystemState.calculatedOrders.forEach((order, index) => {
      const orderDateStr = formatPacificDateDisplay(order.orderDate, {
        weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
      });
      const deliveryDateStr = formatPacificDateDisplay(order.deliveryDate, {
        weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
      });

      html += `
        <div class="order-card" id="order-${index}" style="
          border: 2px solid var(--gray-300);
          margin-bottom: 16px;
          padding: 14px;
          border-radius: 0;
          background: white;
          box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        ">
          <h3 style="color: var(--gray-900); margin-bottom: 12px; font-size: 14px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.8px;">
            ${order.vendor} - ORDER #${index + 1}
          </h3>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px; padding: 10px; background: var(--gray-100); border-radius: 0; border: 1px solid var(--gray-300);">
            <div>
              <div style="font-weight: 700; color: var(--gray-600); font-size: 9px; text-transform: uppercase; letter-spacing: 0.5px;">Order Date</div>
              <div style="font-size: 12px; margin-top: 3px; color: var(--gray-900);">${orderDateStr}</div>
            </div>
            <div>
              <div style="font-weight: 700; color: var(--gray-600); font-size: 9px; text-transform: uppercase; letter-spacing: 0.5px;">Cutoff</div>
              <div style="font-size: 12px; margin-top: 3px; color: var(--gray-900);">${order.cutoffTime}</div>
            </div>
            <div>
              <div style="font-weight: 700; color: var(--gray-600); font-size: 9px; text-transform: uppercase; letter-spacing: 0.5px;">Delivery</div>
              <div style="font-size: 12px; margin-top: 3px; color: var(--gray-900);">${deliveryDateStr}</div>
            </div>
            <div>
              <div style="font-weight: 700; color: var(--gray-600); font-size: 9px; text-transform: uppercase; letter-spacing: 0.5px;">Items</div>
              <div style="font-size: 12px; margin-top: 3px; color: var(--gray-900);">${order.items.length} items</div>
            </div>
          </div>

          ${order.notes ? `
            <div style="background: var(--light-blue); border-left: 3px solid var(--primary-blue); padding: 8px; margin-bottom: 12px; border-radius: 0; font-size: 11px;">
              <strong style="color: var(--gray-900);">Note:</strong> <span style="color: var(--gray-700);">${order.notes}</span>
            </div>
          ` : ''}

          <table style="width: 100%; border-collapse: collapse; margin-top: 12px; font-size: 12px;">
            <thead>
              <tr style="background: var(--gray-900); color: var(--white);">
                <th style="padding: 8px 6px; text-align: left; border: 1px solid var(--gray-300); font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">Item</th>
                <th style="padding: 8px 4px; text-align: center; border: 1px solid var(--gray-300); font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">Qty</th>
                <th style="padding: 8px 4px; text-align: center; border: 1px solid var(--gray-300); font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">Unit</th>
                <th style="padding: 8px 4px; text-align: center; border: 1px solid var(--gray-300); font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">Price</th>
                <th style="padding: 8px 4px; text-align: center; border: 1px solid var(--gray-300); font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">Par</th>
                <th style="padding: 8px 4px; text-align: center; border: 1px solid var(--gray-300); font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">Stock</th>
              </tr>
            </thead>
            <tbody>
              ${order.items.map((item, i) => {
                // Calculate reasoning text (matches email format)
                const isFriday = formatPacificWeekday(order.orderDate) === 'Friday';
                const isThursday = formatPacificWeekday(order.orderDate) === 'Thursday';
                let reasoningText = '';

                if (order.vendor === 'Greenleaf' && isFriday) {
                  // Friday Greenleaf = 2-day coverage
                  reasoningText = `AI: (Par ${item.parLevel} - Stock ${item.currentStock}) √ó 2 days = ${item.quantity} to order`;
                } else if (order.vendor === 'Mani Imports' && isThursday) {
                  // Thursday Mani = 5-day coverage
                  const calc = Math.ceil((item.parLevel - item.currentStock) * (5 / 7));
                  reasoningText = `AI: (Par ${item.parLevel} - Stock ${item.currentStock}) √ó 5/7 days = ${calc} to order`;
                } else if (order.vendor === 'Mani Imports') {
                  // Tuesday Mani = 3-day coverage
                  const calc = Math.ceil((item.parLevel - item.currentStock) * (3 / 7));
                  reasoningText = `AI: (Par ${item.parLevel} - Stock ${item.currentStock}) √ó 3/7 days = ${calc} to order`;
                } else {
                  // Simple par-based calculation
                  reasoningText = `AI: Par ${item.parLevel} - Stock ${item.currentStock} = ${item.quantity} to order`;
                }

                // Format last count and price trends
                const lastCountStr = item.lastCountedDate ? `Last count: ${formatRelativeTime(item.lastCountedDate)}` : '';
                const priceInfo = getPriceInfoForItem(item);
                const priceTrendHtml = renderPriceTrendHtml(priceInfo);

                return `
                <tr style="background: ${i % 2 === 0 ? 'var(--gray-100)' : 'white'};">
                  <td style="padding: 8px 6px; border: 1px solid var(--gray-300); font-size: 13px;">
                    <strong>${item.itemName}</strong>
                    ${lastCountStr ? `<div style="font-size: 10px; color: var(--gray-500); margin-top: 3px;">${lastCountStr}</div>` : ''}
                    <div style="font-size: 9px; color: var(--gray-400); margin-top: 3px; font-style: italic;">${reasoningText}</div>
                  </td>
                  <td style="padding: 6px 4px; text-align: center; border: 1px solid var(--gray-300);">
                    <input
                      type="number"
                      value="${item.quantity}"
                      data-order-index="${index}"
                      data-item-id="${item.id}"
                      onchange="updateOrderItemQuantity(${index}, ${item.id}, this.value)"
                      style="width: 60px; padding: 5px 4px; text-align: center; border: 2px solid var(--gray-600); border-radius: 0; font-size: 13px; font-weight: 700; color: var(--gray-900);"
                      min="0"
                      step="0.25"
                    />
                  </td>
                  <td style="padding: 6px 4px; text-align: center; border: 1px solid var(--gray-300);">
                    <input
                      type="text"
                      value="${item.unit}"
                      data-order-index="${index}"
                      data-item-id="${item.id}"
                      onchange="updateOrderItemUnit(${index}, ${item.id}, this.value)"
                      style="width: 65px; padding: 5px 4px; text-align: center; border: 2px solid var(--gray-300); border-radius: 0; font-size: 11px;"
                      placeholder="CS"
                    />
                  </td>
                  <td style="padding: 6px 6px; border: 1px solid var(--gray-300); vertical-align: middle;">${priceTrendHtml}</td>
                  <td style="padding: 6px 4px; text-align: center; border: 1px solid var(--gray-300); font-size: 12px; font-weight: 600;">${item.parLevel}</td>
                  <td style="padding: 6px 4px; text-align: center; border: 1px solid var(--gray-300); font-size: 12px; font-weight: 600;">${item.currentStock}</td>
                </tr>
                `;
              }).join('')}
            </tbody>
          </table>

          <div style="margin-top: 12px; margin-bottom: 20px;">
            <button class="submit-btn" onclick="addItemToAISuggestion(${index})" style="width: 100%; background: var(--gray-700); color: white; font-weight: 700; padding: 12px; font-size: 12px; text-transform: uppercase; letter-spacing: 1px;">
              + ADD ITEM
            </button>
          </div>

          <div style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
            <button class="submit-btn" onclick="generatePDFAndCreateOrder(${index})" style="flex: 1; min-width: 200px; background: #212121; color: white; font-weight: 700; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; padding: 14px;">
              üìÑ CREATE ORDER & DOWNLOAD PDF
            </button>
          </div>
        </div>
      `;
    });

    container.innerHTML = html;
  }

  /**
   * Update item quantity in AI suggestion
   */
  function updateOrderItemQuantity(orderIndex, itemId, newQuantity) {
    const order = orderingSystemState.calculatedOrders[orderIndex];
    if (!order) return;

    const item = order.items.find(i => i.id === itemId);
    if (item) {
      item.quantity = parseFloat(newQuantity) || 0;
      // Save immediately to persist edits
      saveOrderEditsToStorage(orderIndex);
    }
  }

  /**
   * Update item unit in AI suggestion (does NOT save to database, only updates order)
   */
  function updateOrderItemUnit(orderIndex, itemId, newUnit) {
    const order = orderingSystemState.calculatedOrders[orderIndex];
    if (!order) return;

    const item = order.items.find(i => i.id === itemId);
    if (item) {
      item.unit = newUnit.trim().toUpperCase();
      // Save immediately to persist edits
      saveOrderEditsToStorage(orderIndex);
    }
  }

  /**
   * Add item to AI suggestion
   */
  async function addItemToAISuggestion(orderIndex) {
    const order = orderingSystemState.calculatedOrders[orderIndex];
    if (!order) {
      showMessage('Order not found', 'error');
      return;
    }

    // Get current item IDs already in the order
    const currentItemIds = order.items.map(item => item.id);

    // Get available items from this vendor that aren't already in the order
    const availableItems = orderingSystemState.items
      .filter(item => item.vendor === order.vendor && !currentItemIds.includes(item.id))
      .sort((a, b) => a.itemName.localeCompare(b.itemName));

    if (availableItems.length === 0) {
      showMessage('No more items available for this vendor', 'warning');
      return;
    }

    // Create modal
    const overlay = document.createElement('div');
    overlay.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px;';

    const modal = document.createElement('div');
    modal.style.cssText = 'background: white; max-width: 600px; width: 100%; border: 2px solid var(--gray-400); max-height: 90vh; display: flex; flex-direction: column;';

    // Header
    const header = document.createElement('div');
    header.style.cssText = 'background: var(--gray-600); color: white; padding: 16px 20px;';

    const title = document.createElement('h3');
    title.textContent = `ADD ITEM - ${order.vendor}`;
    title.style.cssText = 'margin: 0; font-size: 16px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;';
    header.appendChild(title);

    modal.appendChild(header);

    // Content
    const content = document.createElement('div');
    content.style.cssText = 'padding: 20px; overflow-y: auto; flex: 1;';

    const instructions = document.createElement('p');
    instructions.textContent = 'Select an item to add to this order:';
    instructions.style.cssText = 'color: var(--gray-600); font-size: 13px; margin-bottom: 16px;';
    content.appendChild(instructions);

    // Search input
    const searchInput = document.createElement('input');
    searchInput.type = 'text';
    searchInput.placeholder = 'Search items...';
    searchInput.style.cssText = 'width: 100%; padding: 10px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 13px; margin-bottom: 16px;';
    content.appendChild(searchInput);

    // Items list container
    const itemsList = document.createElement('div');
    itemsList.style.cssText = 'display: flex; flex-direction: column; gap: 8px; max-height: 400px; overflow-y: auto;';

    function renderItemsList(items) {
      itemsList.innerHTML = '';

      items.forEach(item => {
        const itemBtn = document.createElement('button');
        itemBtn.style.cssText = 'padding: 12px; border: 2px solid var(--gray-300); background: white; text-align: left; cursor: pointer; transition: all 0.2s;';

        const itemName = document.createElement('div');
        itemName.textContent = item.itemName;
        itemName.style.cssText = 'font-weight: 700; font-size: 13px; color: var(--gray-900); margin-bottom: 4px;';
        itemBtn.appendChild(itemName);

        const itemDetails = document.createElement('div');
        itemDetails.textContent = `Par: ${item.parLevel} | Current: ${item.currentStock} | Unit: ${item.unit}`;
        itemDetails.style.cssText = 'font-size: 11px; color: var(--gray-600);';
        itemBtn.appendChild(itemDetails);

        itemBtn.onmouseover = () => {
          itemBtn.style.background = 'var(--gray-100)';
          itemBtn.style.borderColor = 'var(--gray-900)';
        };
        itemBtn.onmouseout = () => {
          itemBtn.style.background = 'white';
          itemBtn.style.borderColor = 'var(--gray-300)';
        };

        itemBtn.onclick = () => {
          // Show quantity input modal
          showQuantityInputModal(order, orderIndex, item, overlay);
        };

        itemsList.appendChild(itemBtn);
      });
    }

    renderItemsList(availableItems);

    // Search filter
    searchInput.oninput = (e) => {
      const searchTerm = e.target.value.toLowerCase();
      const filtered = availableItems.filter(item =>
        item.itemName.toLowerCase().includes(searchTerm)
      );
      renderItemsList(filtered);
    };

    content.appendChild(itemsList);
    modal.appendChild(content);

    // Footer
    const footer = document.createElement('div');
    footer.style.cssText = 'padding: 16px 20px; background: white; border-top: 2px solid var(--gray-300);';

    const cancelBtn = document.createElement('button');
    cancelBtn.textContent = 'CANCEL';
    cancelBtn.style.cssText = 'width: 100%; padding: 14px; background: white; color: var(--gray-700); border: 2px solid var(--gray-300); border-radius: 0; font-size: 12px; font-weight: 700; letter-spacing: 1px; cursor: pointer;';
    cancelBtn.onclick = () => document.body.removeChild(overlay);
    footer.appendChild(cancelBtn);

    modal.appendChild(footer);
    overlay.appendChild(modal);
    document.body.appendChild(overlay);
  }

  /**
   * Show quantity input modal for adding item
   */
  function showQuantityInputModal(order, orderIndex, item, previousOverlay) {
    // Remove previous modal
    document.body.removeChild(previousOverlay);

    // Create new modal for quantity input
    const overlay = document.createElement('div');
    overlay.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px;';

    const modal = document.createElement('div');
    modal.style.cssText = 'background: white; max-width: 500px; width: 100%; border: 2px solid var(--gray-400);';

    // Header
    const header = document.createElement('div');
    header.style.cssText = 'background: var(--gray-600); color: white; padding: 16px 20px;';

    const title = document.createElement('h3');
    title.textContent = 'ENTER QUANTITY';
    title.style.cssText = 'margin: 0; font-size: 16px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;';
    header.appendChild(title);

    modal.appendChild(header);

    // Content
    const content = document.createElement('div');
    content.style.cssText = 'padding: 20px;';

    const itemLabel = document.createElement('div');
    itemLabel.textContent = item.itemName;
    itemLabel.style.cssText = 'font-weight: 700; font-size: 14px; color: var(--gray-900); margin-bottom: 16px;';
    content.appendChild(itemLabel);

    const qtyLabel = document.createElement('label');
    qtyLabel.textContent = 'QUANTITY:';
    qtyLabel.style.cssText = 'display: block; color: var(--gray-700); font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;';
    content.appendChild(qtyLabel);

    const qtyInput = document.createElement('input');
    qtyInput.type = 'number';
    qtyInput.min = '0';
    qtyInput.step = '0.25';
    qtyInput.value = Math.max(0, item.parLevel - item.currentStock);
    qtyInput.style.cssText = 'width: 100%; padding: 10px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 13px;';
    content.appendChild(qtyInput);

    modal.appendChild(content);

    // Footer
    const footer = document.createElement('div');
    footer.style.cssText = 'padding: 16px 20px; background: white; border-top: 2px solid var(--gray-300); display: flex; gap: 12px;';

    const cancelBtn = document.createElement('button');
    cancelBtn.textContent = 'CANCEL';
    cancelBtn.style.cssText = 'flex: 1; padding: 14px; background: white; color: var(--gray-700); border: 2px solid var(--gray-300); border-radius: 0; font-size: 12px; font-weight: 700; letter-spacing: 1px; cursor: pointer;';
    cancelBtn.onclick = () => document.body.removeChild(overlay);
    footer.appendChild(cancelBtn);

    const confirmBtn = document.createElement('button');
    confirmBtn.textContent = 'ADD ITEM';
    confirmBtn.style.cssText = 'flex: 2; padding: 14px; background: var(--gray-600); color: white; border: 2px solid var(--gray-600); border-radius: 0; font-size: 12px; font-weight: 700; letter-spacing: 1px; cursor: pointer;';
    confirmBtn.onclick = async () => {
      const quantity = parseFloat(qtyInput.value) || 0;
      if (quantity <= 0) {
        showMessage('Please enter a quantity greater than 0', 'warning');
        return;
      }

      // Add item to the order
      order.items.push({
        id: item.id,
        itemName: item.itemName,
        quantity: quantity,
        unit: item.unit,
        parLevel: item.parLevel,
        currentStock: item.currentStock,
        lastCountedDate: item.lastCountedDate,
        currentUnitCost: item.currentUnitCost,
        lastCostUpdate: item.lastCostUpdate
      });

      // Close modal
      document.body.removeChild(overlay);

      // Re-render the order card to show the new item
      await ensurePriceSnapshotsForItems([item.id]);
      await refreshUpcomingOrdersUI();

      showMessage(`Added ${item.itemName} (${quantity} ${item.unit})`, 'success');
    };
    footer.appendChild(confirmBtn);

    modal.appendChild(footer);
    overlay.appendChild(modal);
    document.body.appendChild(overlay);

    // Focus quantity input
    setTimeout(() => qtyInput.focus(), 100);
  }

  /**
   * Create pending order from AI suggestion
   */
  async function createOrderForReceiving(orderIndex) {
    const order = orderingSystemState.calculatedOrders[orderIndex];
    if (!order) {
      showMessage('Order not found', 'error');
      return Promise.reject('Order not found');
    }

    console.log('Creating order for receiving:', order);

    // Return a promise that resolves when user confirms or rejects when cancelled
    return new Promise((resolve, reject) => {
      // Create confirmation modal
      const overlay = document.createElement('div');
      overlay.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px;';

      const modal = document.createElement('div');
      modal.style.cssText = 'background: white; max-width: 600px; width: 100%; border: 2px solid var(--gray-400); max-height: 90vh; overflow-y: auto;';

      // Header
      const header = document.createElement('div');
      header.style.cssText = 'background: #212121; color: white; padding: 16px 20px;';

      const title = document.createElement('h3');
      title.textContent = `CREATE ORDER - ${order.vendor}`;
      title.style.cssText = 'margin: 0; font-size: 16px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;';
      header.appendChild(title);

      modal.appendChild(header);

      // Content
      const content = document.createElement('div');
      content.style.cssText = 'padding: 20px;';

      const instructions = document.createElement('p');
      instructions.textContent = 'Review the order details and confirm. After saving, a PDF will be generated with your final quantities.';
      instructions.style.cssText = 'color: var(--gray-600); font-size: 13px; margin-bottom: 20px;';
      content.appendChild(instructions);

      // Order details
      const detailsBox = document.createElement('div');
      detailsBox.style.cssText = 'background: #f9fafb; padding: 16px; border: 2px solid var(--gray-300); margin-bottom: 20px;';

      const orderDateLabel = document.createElement('div');
      orderDateLabel.textContent = 'Order Date:';
      orderDateLabel.style.cssText = 'font-size: 11px; font-weight: 700; color: var(--gray-700); margin-bottom: 4px; text-transform: uppercase;';
      detailsBox.appendChild(orderDateLabel);

      const orderDateValue = document.createElement('div');
      orderDateValue.textContent = formatPacificDateDisplay(order.orderDate, {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        weekday: 'long'
      });
      orderDateValue.style.cssText = 'font-size: 14px; color: var(--gray-900); margin-bottom: 12px;';
      detailsBox.appendChild(orderDateValue);

      const itemsLabel = document.createElement('div');
      itemsLabel.textContent = 'Items:';
      itemsLabel.style.cssText = 'font-size: 11px; font-weight: 700; color: var(--gray-700); margin-bottom: 4px; text-transform: uppercase;';
      detailsBox.appendChild(itemsLabel);

      const itemsValue = document.createElement('div');
      itemsValue.textContent = `${order.items.length} item(s) to order`;
      itemsValue.style.cssText = 'font-size: 14px; color: var(--gray-900);';
      detailsBox.appendChild(itemsValue);

      content.appendChild(detailsBox);

      // Delivery date input
      const dateLabel = document.createElement('label');
      dateLabel.textContent = 'EXPECTED DELIVERY DATE:';
      dateLabel.style.cssText = 'display: block; color: var(--gray-700); font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;';
      content.appendChild(dateLabel);

      const dateInput = document.createElement('input');
      dateInput.type = 'date';
      dateInput.id = 'createOrderDeliveryDate';
      dateInput.value = formatPacificDate(order.deliveryDate);
      dateInput.min = getPacificDate(); // Pacific Time, not UTC
      dateInput.style.cssText = 'width: 100%; padding: 10px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 13px; margin-bottom: 20px;';
      content.appendChild(dateInput);

      // Notes
      const notesLabel = document.createElement('label');
      notesLabel.textContent = 'NOTES (OPTIONAL):';
      notesLabel.style.cssText = 'display: block; color: var(--gray-700); font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;';
      content.appendChild(notesLabel);

      const notesInput = document.createElement('textarea');
      notesInput.id = 'createOrderNotes';
      notesInput.placeholder = 'Add any special instructions...';
      notesInput.style.cssText = 'width: 100%; padding: 10px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 13px; min-height: 80px; font-family: inherit;';
      if (order.notes) notesInput.value = order.notes;
      content.appendChild(notesInput);

      modal.appendChild(content);

      // Footer
      const footer = document.createElement('div');
      footer.style.cssText = 'padding: 16px 20px; background: white; border-top: 2px solid var(--gray-300); display: flex; gap: 12px;';

      const cancelBtn = document.createElement('button');
      cancelBtn.textContent = 'CANCEL';
      cancelBtn.style.cssText = 'flex: 1; padding: 14px; background: white; color: var(--gray-700); border: 2px solid var(--gray-300); border-radius: 0; font-size: 12px; font-weight: 700; letter-spacing: 1px; cursor: pointer;';
      cancelBtn.onclick = () => {
        document.body.removeChild(overlay);
        reject('User cancelled');
      };
      footer.appendChild(cancelBtn);

      const confirmBtn = document.createElement('button');
      confirmBtn.textContent = 'SAVE & CONTINUE';
      confirmBtn.style.cssText = 'flex: 2; padding: 14px; background: #212121; color: white; border: 2px solid #212121; border-radius: 0; font-size: 12px; font-weight: 700; letter-spacing: 1px; cursor: pointer;';
      confirmBtn.onclick = async () => {
        // Update order object with modal inputs BEFORE saving and generating PDF
      order.deliveryDate = parsePacificDate(dateInput.value);
        order.notes = notesInput.value;

        const success = await saveAIPendingOrder(order, dateInput.value, notesInput.value, overlay);
        if (success) {
          // Order object is now updated with latest notes and delivery date
          // PDF will use these updated values
          resolve();
        } else {
          reject('Failed to save order');
        }
      };
      footer.appendChild(confirmBtn);

      modal.appendChild(footer);
      overlay.appendChild(modal);
      document.body.appendChild(overlay);
    });
  }

  /**
   * Save AI-suggested order as pending order
   */
  async function saveAIPendingOrder(order, deliveryDate, notes, modalOverlay) {
    if (!deliveryDate) {
      showMessage('Please select a delivery date', 'warning');
      return false;
    }

    // Normalize delivery date to Pacific YYYY-MM-DD for Supabase storage.
    const deliveryDatePacific = parsePacificDate(deliveryDate);
    if (!deliveryDatePacific) {
      showMessage('Delivery date is invalid', 'error');
      return false;
    }
    const deliveryDateStr = formatPacificDate(deliveryDatePacific);
    order.deliveryDate = deliveryDatePacific;

    showLoading('Creating Order', 'Saving order for receiving...');

    try {
      // Create pending order record
      const { data: orderData, error: orderError } = await supabase
        .from('pending_orders')
        .insert({
          vendor: order.vendor,
          order_date: formatPacificDate(order.orderDate),
          expected_delivery_date: deliveryDateStr,
          status: 'pending',
          created_by: 'System (AI Suggestion)',
          notes: notes || `Cutoff: ${order.cutoffTime}`,
          total_items: order.items.length
        })
        .select()
        .single();

      if (orderError) throw orderError;

      const orderId = orderData.id;
      console.log('Created pending order from AI suggestion:', orderId);

      // Create order items
      const orderItems = order.items.map(item => ({
        order_id: orderId,
        inventory_item_id: item.id,
        quantity_ordered: item.quantity,
        unit: item.unit,
        item_name: item.itemName,
        vendor: order.vendor
      }));

      const { error: itemsError } = await supabase
        .from('pending_order_items')
        .insert(orderItems);

      if (itemsError) throw itemsError;

      hideLoading();

      // Close modal
      document.body.removeChild(modalOverlay);

      showMessage(`‚úÖ Order saved! Generating PDF...`, 'success');

      // Refresh the ORDERS tab to show the new pending order
      renderOrdersTab();

      console.log('‚úÖ AI order converted to pending order successfully');

      return true; // Success

    } catch (error) {
      hideLoading();
      console.error('Error creating pending order:', error);
      showMessage('Failed to create order: ' + error.message, 'error');
      return false; // Failure
    }
  }

  /**
   * Sort vendors with PREP first, then alphabetically
   */
  function sortVendorsWithPrepFirst(vendors) {
    return vendors.sort((a, b) => {
      if (a === 'PREP') return -1;
      if (b === 'PREP') return 1;
      return a.localeCompare(b);
    });
  }

  // Bulk edit state
  let bulkEditMode = false;
  let selectedItemsForBulkEdit = new Set();

  /**
   * Toggle bulk edit mode
   */
  function toggleBulkEditMode() {
    bulkEditMode = !bulkEditMode;
    selectedItemsForBulkEdit.clear();
    renderInventoryList();
  }

  /**
   * Toggle item selection for bulk edit
   */
  function toggleItemSelection(itemId) {
    if (selectedItemsForBulkEdit.has(itemId)) {
      selectedItemsForBulkEdit.delete(itemId);
    } else {
      selectedItemsForBulkEdit.add(itemId);
    }
    renderInventoryList();
  }

  /**
   * Toggle selection for all items in a vendor
   */
  function toggleVendorSelection(vendor) {
    const vendorItems = orderingSystemState.items.filter(item => item.vendor === vendor);
    const allSelected = vendorItems.every(item => selectedItemsForBulkEdit.has(item.id));
    
    if (allSelected) {
      // Deselect all items in this vendor
      vendorItems.forEach(item => selectedItemsForBulkEdit.delete(item.id));
    } else {
      // Select all items in this vendor
      vendorItems.forEach(item => selectedItemsForBulkEdit.add(item.id));
    }
    
    renderInventoryList();
  }

  /**
   * Open bulk edit modal for selected items
   */
  async function openBulkEditModal() {
    if (selectedItemsForBulkEdit.size === 0) {
      showMessage('Please select at least one item to edit', 'warning');
      return;
    }

    // Load locations first
    await loadPrepLocations();

    const selectedItems = orderingSystemState.items.filter(item =>
      selectedItemsForBulkEdit.has(item.id)
    );

    // Create modal
    const overlay = document.createElement('div');
    overlay.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px;';

    const modal = document.createElement('div');
    modal.style.cssText = 'background: white; max-width: 900px; width: 100%; max-height: 90vh; display: flex; flex-direction: column; border: 2px solid var(--gray-400);';

    // Header
    const header = document.createElement('div');
    header.style.cssText = 'background: #212121; color: white; padding: 16px 20px; display: flex; justify-content: space-between; align-items: center;';

    const title = document.createElement('h3');
    title.textContent = `BULK EDIT - ${selectedItems.length} ITEMS SELECTED`;
    title.style.cssText = 'margin: 0; font-size: 16px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;';
    header.appendChild(title);

    modal.appendChild(header);

    // Content
    const content = document.createElement('div');
    content.style.cssText = 'padding: 20px; overflow-y: auto; flex: 1;';

    // Render each selected item with editable fields
    selectedItems.forEach((item, index) => {
      const itemCard = document.createElement('div');
      itemCard.style.cssText = 'border: 2px solid var(--gray-300); padding: 16px; margin-bottom: 16px; background: var(--gray-50);';

      const itemHeader = document.createElement('div');
      itemHeader.textContent = item.itemName;
      itemHeader.style.cssText = 'font-weight: 700; font-size: 14px; color: var(--gray-900); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px;';
      itemCard.appendChild(itemHeader);

      // Create editable fields grid
      const fieldsGrid = document.createElement('div');
      fieldsGrid.style.cssText = 'display: grid; grid-template-columns: 1fr 1fr; gap: 12px;';

      // Item Name
      const nameField = document.createElement('div');
      nameField.style.cssText = 'grid-column: 1 / -1;';
      const nameLabel = document.createElement('label');
      nameLabel.textContent = 'ITEM NAME';
      nameLabel.style.cssText = 'display: block; color: var(--gray-700); font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px;';
      const nameInput = document.createElement('input');
      nameInput.type = 'text';
      nameInput.value = item.itemName;
      nameInput.dataset.itemId = item.id;
      nameInput.dataset.field = 'item_name';
      nameInput.style.cssText = 'width: 100%; padding: 8px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 13px; box-sizing: border-box;';
      nameField.appendChild(nameLabel);
      nameField.appendChild(nameInput);
      fieldsGrid.appendChild(nameField);

      // Vendor
      const vendorField = document.createElement('div');
      const vendorLabel = document.createElement('label');
      vendorLabel.textContent = 'VENDOR';
      vendorLabel.style.cssText = 'display: block; color: var(--gray-700); font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px;';
      
      // Get unique vendors from all items
      const allVendors = [...new Set(orderingSystemState.items.map(i => i.vendor).filter(v => v))].sort();
      
      const vendorInput = document.createElement('select');
      vendorInput.dataset.itemId = item.id;
      vendorInput.dataset.field = 'vendor';
      vendorInput.style.cssText = 'width: 100%; padding: 8px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 13px; box-sizing: border-box; background: white; cursor: pointer;';
      
      // Add options for each vendor
      allVendors.forEach(vendor => {
        const option = document.createElement('option');
        option.value = vendor;
        option.textContent = vendor;
        option.selected = vendor === item.vendor;
        vendorInput.appendChild(option);
      });
      
      vendorField.appendChild(vendorLabel);
      vendorField.appendChild(vendorInput);
      fieldsGrid.appendChild(vendorField);

      // Unit
      const unitField = document.createElement('div');
      const unitLabel = document.createElement('label');
      unitLabel.textContent = 'UNIT';
      unitLabel.style.cssText = 'display: block; color: var(--gray-700); font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px;';
      const unitInput = document.createElement('input');
      unitInput.type = 'text';
      unitInput.value = item.unit;
      unitInput.dataset.itemId = item.id;
      unitInput.dataset.field = 'unit';
      unitInput.style.cssText = 'width: 100%; padding: 8px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 13px; box-sizing: border-box;';
      unitField.appendChild(unitLabel);
      unitField.appendChild(unitInput);
      fieldsGrid.appendChild(unitField);

      // Par Level
      const parField = document.createElement('div');
      const parLabel = document.createElement('label');
      parLabel.textContent = 'PAR LEVEL';
      parLabel.style.cssText = 'display: block; color: var(--gray-700); font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px;';
      const parInput = document.createElement('input');
      parInput.type = 'number';
      parInput.value = item.parLevel;
      parInput.step = '0.25';
      parInput.dataset.itemId = item.id;
      parInput.dataset.field = 'par_level';
      parInput.style.cssText = 'width: 100%; padding: 8px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 13px; box-sizing: border-box;';
      parField.appendChild(parLabel);
      parField.appendChild(parInput);
      fieldsGrid.appendChild(parField);

      // Current Stock (read-only)
      const stockField = document.createElement('div');
      const stockLabel = document.createElement('label');
      stockLabel.textContent = 'CURRENT STOCK (READ-ONLY)';
      stockLabel.style.cssText = 'display: block; color: var(--gray-600); font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px;';
      const stockInput = document.createElement('input');
      stockInput.type = 'number';
      stockInput.value = item.currentStock || 0;
      stockInput.readOnly = true;
      stockInput.style.cssText = 'width: 100%; padding: 8px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 13px; box-sizing: border-box; background: var(--gray-100); color: var(--gray-600);';
      stockField.appendChild(stockLabel);
      stockField.appendChild(stockInput);
      fieldsGrid.appendChild(stockField);

      // Item Type (if exists)
      if (item.itemType || item.vendor === 'PREP') {
        const typeField = document.createElement('div');
        const typeLabel = document.createElement('label');
        typeLabel.textContent = 'ITEM TYPE';
        typeLabel.style.cssText = 'display: block; color: var(--gray-700); font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px;';
        const typeInput = document.createElement('input');
        typeInput.type = 'text';
        typeInput.value = item.itemType || 'prep';
        typeInput.dataset.itemId = item.id;
        typeInput.dataset.field = 'item_type';
        typeInput.style.cssText = 'width: 100%; padding: 8px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 13px; box-sizing: border-box;';
        typeField.appendChild(typeLabel);
        typeField.appendChild(typeInput);
        fieldsGrid.appendChild(typeField);

        // Batch Lifespan
        const lifespanField = document.createElement('div');
        const lifespanLabel = document.createElement('label');
        lifespanLabel.textContent = 'BATCH LIFESPAN (HOURS)';
        lifespanLabel.style.cssText = 'display: block; color: var(--gray-700); font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px;';
        const lifespanInput = document.createElement('input');
        lifespanInput.type = 'number';
        lifespanInput.value = item.batchLifespan || '';
        lifespanInput.placeholder = 'e.g., 24';
        lifespanInput.dataset.itemId = item.id;
        lifespanInput.dataset.field = 'batch_lifespan_hours';
        lifespanInput.style.cssText = 'width: 100%; padding: 8px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 13px; box-sizing: border-box;';
        lifespanField.appendChild(lifespanLabel);
        lifespanField.appendChild(lifespanInput);
        fieldsGrid.appendChild(lifespanField);
      }

      itemCard.appendChild(fieldsGrid);
      
      // Add compact checkboxes section
      const checkboxSection = document.createElement('div');
      checkboxSection.style.cssText = 'margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--gray-200); display: grid; grid-template-columns: 1fr 1fr; gap: 6px;';
      
      // Checkbox helper function
      const createCheckbox = (id, label, checked, field) => {
        const wrapper = document.createElement('label');
        wrapper.style.cssText = 'display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 10px; font-weight: 600; color: var(--gray-600); text-transform: uppercase; letter-spacing: 0.3px;';
        
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.checked = checked;
        checkbox.dataset.itemId = item.id;
        checkbox.dataset.field = field;
        checkbox.style.cssText = 'width: 12px; height: 12px; cursor: pointer; margin: 0;';
        
        const text = document.createElement('span');
        text.textContent = label;
        
        wrapper.appendChild(checkbox);
        wrapper.appendChild(text);
        return wrapper;
      };
      
      // Add all checkboxes
      checkboxSection.appendChild(createCheckbox(`urgent-${item.id}`, 'Make First', item.urgent, 'urgent'));
      checkboxSection.appendChild(createCheckbox(`line-cooks-${item.id}`, 'Line Cooks', item.lineCooksPrep, 'line_cooks_prep'));
      checkboxSection.appendChild(createCheckbox(`not-daily-${item.id}`, 'Not Daily', item.notMadeDaily, 'not_made_daily'));
      checkboxSection.appendChild(createCheckbox(`bottle-${item.id}`, 'Bottle Count', item.showInBottleCount, 'show_in_bottle_count'));

      itemCard.appendChild(checkboxSection);

      // Add Multiple Locations section
      const multiLocSection = document.createElement('div');
      multiLocSection.style.cssText = 'margin-top: 12px; padding-top: 12px; border-top: 2px solid var(--gray-300);';

      const multiLocCheckbox = createCheckbox(`multi-loc-${item.id}`, 'Multiple Locations', item.hasMultipleLocations, 'has_multiple_locations');
      multiLocCheckbox.style.cssText = 'display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 12px; font-weight: 700; color: var(--gray-700); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 12px;';
      multiLocSection.appendChild(multiLocCheckbox);

      // Location dropdowns container (initially hidden if not multi-location)
      const locationsContainer = document.createElement('div');
      locationsContainer.id = `locations-container-${item.id}`;
      locationsContainer.style.cssText = item.hasMultipleLocations ? 'display: block;' : 'display: none;';

      // Get existing locations for this item
      const existingLocations = Object.keys(item.locationCounts || {});

      // Location 1
      const loc1Div = document.createElement('div');
      loc1Div.style.cssText = 'margin-bottom: 8px;';
      const loc1Label = document.createElement('label');
      loc1Label.textContent = 'Location 1:';
      loc1Label.style.cssText = 'display: block; font-size: 10px; font-weight: 600; color: var(--gray-600); margin-bottom: 4px;';
      const loc1Select = document.createElement('select');
      loc1Select.id = `bulk-loc1-${item.id}`;
      loc1Select.dataset.itemId = item.id;
      loc1Select.dataset.locationNum = '1';
      loc1Select.style.cssText = 'width: 100%; padding: 6px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 12px;';
      loc1Select.innerHTML = '<option value="">Select location...</option><option value="__add_new__">+ Add New</option>';
      const loc1Input = document.createElement('input');
      loc1Input.type = 'text';
      loc1Input.id = `bulk-loc1-input-${item.id}`;
      loc1Input.placeholder = 'Enter new location';
      loc1Input.style.cssText = 'display: none; width: 100%; padding: 6px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 12px; margin-top: 4px;';
      loc1Div.appendChild(loc1Label);
      loc1Div.appendChild(loc1Select);
      loc1Div.appendChild(loc1Input);
      locationsContainer.appendChild(loc1Div);

      // Location 2
      const loc2Div = document.createElement('div');
      loc2Div.style.cssText = 'margin-bottom: 8px;';
      const loc2Label = document.createElement('label');
      loc2Label.textContent = 'Location 2:';
      loc2Label.style.cssText = 'display: block; font-size: 10px; font-weight: 600; color: var(--gray-600); margin-bottom: 4px;';
      const loc2Select = document.createElement('select');
      loc2Select.id = `bulk-loc2-${item.id}`;
      loc2Select.dataset.itemId = item.id;
      loc2Select.dataset.locationNum = '2';
      loc2Select.style.cssText = 'width: 100%; padding: 6px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 12px;';
      loc2Select.innerHTML = '<option value="">Select location...</option><option value="__add_new__">+ Add New</option>';
      const loc2Input = document.createElement('input');
      loc2Input.type = 'text';
      loc2Input.id = `bulk-loc2-input-${item.id}`;
      loc2Input.placeholder = 'Enter new location';
      loc2Input.style.cssText = 'display: none; width: 100%; padding: 6px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 12px; margin-top: 4px;';
      loc2Div.appendChild(loc2Label);
      loc2Div.appendChild(loc2Select);
      loc2Div.appendChild(loc2Input);
      locationsContainer.appendChild(loc2Div);

      // Location 3
      const loc3Div = document.createElement('div');
      loc3Div.id = `bulk-loc3-div-${item.id}`;
      loc3Div.style.cssText = 'margin-bottom: 8px; display: none;';
      const loc3Label = document.createElement('label');
      loc3Label.textContent = 'Location 3:';
      loc3Label.style.cssText = 'display: block; font-size: 10px; font-weight: 600; color: var(--gray-600); margin-bottom: 4px;';
      const loc3Select = document.createElement('select');
      loc3Select.id = `bulk-loc3-${item.id}`;
      loc3Select.dataset.itemId = item.id;
      loc3Select.dataset.locationNum = '3';
      loc3Select.style.cssText = 'width: 100%; padding: 6px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 12px;';
      loc3Select.innerHTML = '<option value="">Select location...</option><option value="__add_new__">+ Add New</option>';
      const loc3Input = document.createElement('input');
      loc3Input.type = 'text';
      loc3Input.id = `bulk-loc3-input-${item.id}`;
      loc3Input.placeholder = 'Enter new location';
      loc3Input.style.cssText = 'display: none; width: 100%; padding: 6px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 12px; margin-top: 4px;';
      loc3Div.appendChild(loc3Label);
      loc3Div.appendChild(loc3Select);
      loc3Div.appendChild(loc3Input);
      locationsContainer.appendChild(loc3Div);

      // Add Location link
      const addLocLink = document.createElement('a');
      addLocLink.href = 'javascript:void(0)';
      addLocLink.textContent = '+ Add Location';
      addLocLink.id = `bulk-add-loc-link-${item.id}`;
      addLocLink.style.cssText = 'color: #1976d2; font-size: 11px; font-weight: 600; text-decoration: underline; cursor: pointer;';
      addLocLink.onclick = () => {
        document.getElementById(`bulk-loc3-div-${item.id}`).style.display = 'block';
        addLocLink.style.display = 'none';
      };
      locationsContainer.appendChild(addLocLink);

      multiLocSection.appendChild(locationsContainer);

      // Populate dropdowns with saved locations
      prepLocationsCache.forEach(loc => {
        [loc1Select, loc2Select, loc3Select].forEach(select => {
          const opt = document.createElement('option');
          opt.value = loc.name;
          opt.textContent = loc.name;
          select.appendChild(opt);
        });
      });

      // Pre-select existing locations
      if (existingLocations.length > 0) {
        loc1Select.value = existingLocations[0] || '';
        if (existingLocations.length > 1) loc2Select.value = existingLocations[1] || '';
        if (existingLocations.length > 2) {
          loc3Select.value = existingLocations[2] || '';
          loc3Div.style.display = 'block';
          addLocLink.style.display = 'none';
        }
      }

      // Toggle locations visibility when checkbox changes
      const multiLocCheckboxInput = multiLocCheckbox.querySelector('input[type="checkbox"]');
      multiLocCheckboxInput.onchange = () => {
        locationsContainer.style.display = multiLocCheckboxInput.checked ? 'block' : 'none';
      };

      // Handle location select changes
      [loc1Select, loc2Select, loc3Select].forEach((select, idx) => {
        select.onchange = () => {
          const inputField = document.getElementById(`bulk-loc${idx + 1}-input-${item.id}`);
          if (select.value === '__add_new__') {
            inputField.style.display = 'block';
          } else {
            inputField.style.display = 'none';
            inputField.value = '';
          }
        };
      });

      itemCard.appendChild(multiLocSection);
      content.appendChild(itemCard);
    });

    modal.appendChild(content);

    // Footer with buttons
    const footer = document.createElement('div');
    footer.style.cssText = 'padding: 16px 20px; background: white; border-top: 2px solid var(--gray-300); display: flex; gap: 12px;';

    const cancelBtn = document.createElement('button');
    cancelBtn.textContent = 'CANCEL';
    cancelBtn.style.cssText = 'flex: 1; padding: 14px; background: white; color: var(--gray-700); border: 2px solid var(--gray-300); border-radius: 0; font-size: 12px; font-weight: 700; letter-spacing: 1px; cursor: pointer;';
    cancelBtn.onclick = () => document.body.removeChild(overlay);
    footer.appendChild(cancelBtn);

    const saveBtn = document.createElement('button');
    saveBtn.textContent = `SAVE ${selectedItems.length} ITEMS`;
    saveBtn.style.cssText = 'flex: 2; padding: 14px; background: #212121; color: white; border: 2px solid #212121; border-radius: 0; font-size: 12px; font-weight: 700; letter-spacing: 1px; cursor: pointer;';
    saveBtn.onclick = async () => {
      await saveBulkEdits(modal, overlay);
    };
    footer.appendChild(saveBtn);

    modal.appendChild(footer);
    overlay.appendChild(modal);
    document.body.appendChild(overlay);
  }

  /**
   * Save bulk edits for all selected items
   */
  async function saveBulkEdits(modal, overlay) {
    const inputs = modal.querySelectorAll('input[data-item-id], select[data-item-id]');
    const updates = {};

    // Group updates by item ID
    inputs.forEach(input => {
      const itemId = parseInt(input.dataset.itemId);
      const field = input.dataset.field;
      
      if (!updates[itemId]) {
        updates[itemId] = {};
      }

      // Handle checkboxes
      if (input.type === 'checkbox') {
        updates[itemId][field] = input.checked;
      }
      // Handle number fields
      else if (field === 'par_level' || field === 'batch_lifespan_hours') {
        const value = input.value.trim();
        if (value !== '') {
          updates[itemId][field] = parseFloat(value) || 0;
        }
      }
      // Handle unit (uppercase)
      else if (field === 'unit') {
        const value = input.value.trim();
        if (value !== '') {
          updates[itemId][field] = value.toUpperCase();
        }
      }
      // Handle all other text fields - only if not empty
      else {
        const value = input.value.trim();
        if (value !== '') {
          updates[itemId][field] = value;
        }
      }
    });

    // Process location selections for items with multi-location enabled
    for (const [itemId, data] of Object.entries(updates)) {
      if (data.has_multiple_locations) {
        const locations = [];

        // Check location 1
        const loc1Select = modal.querySelector(`#bulk-loc1-${itemId}`);
        const loc1Input = modal.querySelector(`#bulk-loc1-input-${itemId}`);
        if (loc1Select) {
          if (loc1Select.value === '__add_new__' && loc1Input && loc1Input.value.trim()) {
            const newLoc = loc1Input.value.trim();
            const capitalized = newLoc.charAt(0).toUpperCase() + newLoc.slice(1);
            locations.push(capitalized);
            await saveNewLocation(capitalized);
          } else if (loc1Select.value && loc1Select.value !== '__add_new__') {
            locations.push(loc1Select.value);
          }
        }

        // Check location 2
        const loc2Select = modal.querySelector(`#bulk-loc2-${itemId}`);
        const loc2Input = modal.querySelector(`#bulk-loc2-input-${itemId}`);
        if (loc2Select) {
          if (loc2Select.value === '__add_new__' && loc2Input && loc2Input.value.trim()) {
            const newLoc = loc2Input.value.trim();
            const capitalized = newLoc.charAt(0).toUpperCase() + newLoc.slice(1);
            locations.push(capitalized);
            await saveNewLocation(capitalized);
          } else if (loc2Select.value && loc2Select.value !== '__add_new__') {
            locations.push(loc2Select.value);
          }
        }

        // Check location 3
        const loc3Select = modal.querySelector(`#bulk-loc3-${itemId}`);
        const loc3Input = modal.querySelector(`#bulk-loc3-input-${itemId}`);
        if (loc3Select) {
          if (loc3Select.value === '__add_new__' && loc3Input && loc3Input.value.trim()) {
            const newLoc = loc3Input.value.trim();
            const capitalized = newLoc.charAt(0).toUpperCase() + newLoc.slice(1);
            locations.push(capitalized);
            await saveNewLocation(capitalized);
          } else if (loc3Select.value && loc3Select.value !== '__add_new__') {
            locations.push(loc3Select.value);
          }
        }

        // Initialize location counts
        const locationCounts = {};
        locations.forEach(loc => {
          locationCounts[loc] = 0;
        });

        data.location_counts = locationCounts;
      } else if (data.has_multiple_locations === false) {
        // If unchecking multi-location, clear location data
        data.location_counts = {};
      }
    }

    document.body.removeChild(overlay);
    showLoading('Saving Bulk Edits', `Updating ${Object.keys(updates).length} items...`);

    try {
      let successCount = 0;
      let errorCount = 0;

      // Update each item
      for (const [itemId, data] of Object.entries(updates)) {
        try {
          console.log(`Updating item ${itemId} with data:`, data);

          // Add last_counted_date to mark item as counted
          data.last_counted_date = new Date().toISOString();

          const { error } = await supabase
            .from('inventory_items')
            .update(data)
            .eq('id', parseInt(itemId));

          if (error) {
            console.error(`Supabase error for item ${itemId}:`, error);
            throw error;
          }

          // Update local state
          const localItem = orderingSystemState.items.find(i => i.id === parseInt(itemId));
          if (localItem) {
            if (data.item_name) localItem.itemName = data.item_name;
            if (data.vendor) localItem.vendor = data.vendor;
            if (data.unit) localItem.unit = data.unit;
            if (data.par_level !== undefined) localItem.parLevel = data.par_level;
            if (data.item_type) localItem.itemType = data.item_type;
            if (data.batch_lifespan_hours !== undefined) localItem.batchLifespan = data.batch_lifespan_hours;
            if (data.urgent !== undefined) localItem.urgent = data.urgent;
            if (data.line_cooks_prep !== undefined) localItem.lineCooksPrep = data.line_cooks_prep;
            if (data.not_made_daily !== undefined) localItem.notMadeDaily = data.not_made_daily;
            if (data.show_in_bottle_count !== undefined) localItem.showInBottleCount = data.show_in_bottle_count;
            if (data.has_multiple_locations !== undefined) localItem.hasMultipleLocations = data.has_multiple_locations;
            if (data.location_counts !== undefined) localItem.locationCounts = data.location_counts;
            if (data.last_counted_date) localItem.lastCountedDate = data.last_counted_date;
          }

          successCount++;
        } catch (error) {
          console.error(`Error updating item ${itemId}:`, error);
          errorCount++;
        }
      }

      hideLoading();

      if (errorCount === 0) {
        showMessage(`‚úÖ Successfully updated ${successCount} items!`, 'success');
      } else {
        showMessage(`‚ö†Ô∏è Updated ${successCount} items, ${errorCount} failed`, 'warning');
      }

      // Exit bulk edit mode and refresh
      bulkEditMode = false;
      selectedItemsForBulkEdit.clear();
      renderInventoryList();
      renderStockCountList();
      renderPrepCountList();
      refreshBottleCount(); // Refresh bottle count after updates
      calculateUpcomingOrders();
      await refreshUpcomingOrdersUI();
      await refreshUpcomingOrdersUI();
      await refreshUpcomingOrdersUI();

    } catch (error) {
      hideLoading();
      showMessage('Error saving bulk edits: ' + error.message, 'error');
    }
  }

  /**
   * Render inventory list for managing par levels
   */
  function renderInventoryList() {
    const container = document.getElementById('inventoryList');

    if (orderingSystemState.items.length === 0) {
      container.innerHTML = '<p style="text-align: center; padding: 20px;">No inventory items found. Add items using the form above.</p>';
      return;
    }

    // Add bulk edit toggle button at top
    let html = `
      <div style="margin-bottom: 20px; display: flex; gap: 12px; align-items: center;">
        <button
          onclick="toggleBulkEditMode()"
          style="
            padding: 12px 20px;
            background: ${bulkEditMode ? '#212121' : 'var(--gray-700)'};
            color: white;
            border: none;
            border-radius: 0;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
          "
        >
          ${bulkEditMode ? 'EXIT BULK EDIT' : 'BULK EDIT'}
        </button>
        ${bulkEditMode && selectedItemsForBulkEdit.size > 0 ? `
          <button
            onclick="openBulkEditModal()"
            style="
              padding: 12px 20px;
              background: #2e7d32;
              color: white;
              border: none;
              border-radius: 0;
              font-size: 12px;
              font-weight: 700;
              text-transform: uppercase;
              letter-spacing: 1px;
              cursor: pointer;
              display: inline-flex;
              align-items: center;
              justify-content: center;
              gap: 6px;
            "
          >
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" style="width: 14px; height: 14px; fill: currentColor;">
              <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
            </svg>
            EDIT ${selectedItemsForBulkEdit.size} SELECTED
          </button>
        ` : ''}
        ${bulkEditMode ? `
          <span style="color: var(--gray-600); font-size: 12px; font-weight: 600;">
            SELECT ITEMS TO BULK EDIT
          </span>
        ` : ''}
      </div>
    `;

    // Group by vendor
    const itemsByVendor = {};
    orderingSystemState.items.forEach(item => {
      if (!itemsByVendor[item.vendor]) {
        itemsByVendor[item.vendor] = [];
      }
      itemsByVendor[item.vendor].push(item);
    });

    sortVendorsWithPrepFirst(Object.keys(itemsByVendor)).forEach(vendor => {
      const items = itemsByVendor[vendor];
      const isPrepCategory = vendor === 'PREP';
      const headerColor = isPrepCategory ? '#212121' : 'var(--gray-700)';
      
      // Check if all items in this vendor are selected
      const allSelected = items.every(item => selectedItemsForBulkEdit.has(item.id));

      html += `
        <div style="margin-bottom: 24px;">
          <div style="background: ${headerColor}; color: white; padding: 12px 16px; border-radius: 0; margin-bottom: 0; display: flex; justify-content: space-between; align-items: center;">
            <h4 style="margin: 0; font-size: 14px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;">
              ${vendor} <span style="opacity: 0.7; font-weight: 400; font-size: 12px;">(${items.length})</span>
            </h4>
            ${bulkEditMode ? `
              <button
                onclick="toggleVendorSelection('${vendor.replace(/'/g, "\\'")}')"
                style="
                  background: ${allSelected ? 'rgba(255, 255, 255, 0.2)' : 'rgba(255, 255, 255, 0.15)'};
                  border: 2px solid rgba(255, 255, 255, 0.4);
                  border-radius: 4px;
                  color: white;
                  padding: 6px 12px;
                  font-size: 11px;
                  font-weight: 700;
                  text-transform: uppercase;
                  letter-spacing: 0.5px;
                  cursor: pointer;
                  transition: all 0.2s;
                "
                onmouseover="this.style.background='rgba(255, 255, 255, 0.3)'"
                onmouseout="this.style.background='${allSelected ? 'rgba(255, 255, 255, 0.2)' : 'rgba(255, 255, 255, 0.15)'}'"
              >
                ${allSelected ? '‚úì DESELECT ALL' : 'SELECT ALL'}
              </button>
            ` : ''}
          </div>
          <div style="background: white; border: 2px solid var(--gray-300); border-top: none;">
            ${items.map((item, i) => {
              const isSelected = selectedItemsForBulkEdit.has(item.id);
              return `
              <div
                style="
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  padding: 12px 16px;
                  border-bottom: 1px solid var(--gray-200);
                  transition: background 0.2s;
                  background: ${isSelected ? '#e3f2fd' : (i % 2 === 0 ? 'white' : '#f9fafb')};
                "
                ${!bulkEditMode ? `
                  onmouseover="this.style.background='#f3f4f6'"
                  onmouseout="this.style.background='${i % 2 === 0 ? 'white' : '#f9fafb'}'"
                ` : ''}
              >
                ${bulkEditMode ? `
                  <label style="display: flex; align-items: center; gap: 12px; flex: 1; cursor: pointer;">
                    <input
                      type="checkbox"
                      ${isSelected ? 'checked' : ''}
                      onchange="toggleItemSelection(${item.id})"
                      style="width: 18px; height: 18px; cursor: pointer;"
                    />
                    <span style="font-size: 14px; font-weight: 600; color: var(--gray-900);">
                      ${item.itemName}
                    </span>
                  </label>
                ` : `
                  <div style="flex: 1; font-size: 14px; font-weight: 600; color: var(--gray-900);">
                    ${item.itemName}
                  </div>
                  <button
                    onclick="openEditItemModal(${item.id}); return false;"
                    style="
                      background: var(--gray-100);
                      border: 2px solid var(--gray-300);
                      border-radius: 4px;
                      padding: 8px 12px;
                      cursor: pointer;
                      display: flex;
                      align-items: center;
                      gap: 6px;
                      color: var(--gray-700);
                      font-size: 12px;
                      font-weight: 700;
                      text-transform: uppercase;
                      letter-spacing: 0.5px;
                      transition: all 0.2s;
                    "
                    onmouseover="this.style.background='var(--gray-700)'; this.style.color='var(--white)'; this.style.borderColor='var(--gray-700)';"
                    onmouseout="this.style.background='var(--gray-100)'; this.style.color='var(--gray-700)'; this.style.borderColor='var(--gray-300)';"
                  >
                    <span style="font-size: 16px;">‚úèÔ∏è</span>
                    <span>Edit</span>
                  </button>
                `}
              </div>
              `;
            }).join('')}
          </div>
        </div>
      `;
    });

    container.innerHTML = html;
  }

  /**
   * Render stock count list for updating inventory
   * Mobile-first card-based design with large touch targets
   */
  function renderStockCountList() {
    const container = document.getElementById('stockCountList');

    if (orderingSystemState.items.length === 0) {
      container.innerHTML = '<p style="text-align: center; padding: 20px;">No inventory items found.</p>';
      return;
    }

    // Group by vendor (exclude PREP items - they go in PREP tab)
    const itemsByVendor = {};
    orderingSystemState.items.forEach(item => {
      // Skip PREP items - they belong in PREP tab
      if (item.vendor === 'PREP' || item.itemType === 'prep') {
        return;
      }
      if (!itemsByVendor[item.vendor]) {
        itemsByVendor[item.vendor] = [];
      }
      itemsByVendor[item.vendor].push(item);
    });

    // Helper function to get stock status
    function getStockStatus(currentStock, parLevel) {
      if (parLevel === 0) return { label: 'N/A', color: 'var(--gray-600)', bg: 'var(--gray-100)' };
      const percentage = (currentStock / parLevel) * 100;
      if (percentage < 30) return { label: 'LOW', color: '#d32f2f', bg: '#ffebee' }; // Keep red for warnings
      if (percentage < 70) return { label: 'MEDIUM', color: 'var(--gray-700)', bg: 'var(--gray-200)' };
      return { label: 'GOOD', color: '#2e7d32', bg: '#e8f5e9' }; // Keep green for success
    }

    // Helper function to format last counted date
    function formatLastCounted(dateStr) {
      if (!dateStr) return 'Never';
      const date = new Date(dateStr);
      const now = new Date();
      const diffMs = now - date;
      const diffMinutes = Math.floor(diffMs / (1000 * 60));
      const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
      const diffDays = Math.floor(diffHours / 24);

      // Less than 1 hour: show minutes
      if (diffMinutes < 60) {
        return `${diffMinutes} minute${diffMinutes === 1 ? '' : 's'} ago`;
      }
      
      // Less than 24 hours: show hours and minutes
      if (diffHours < 24) {
        const remainingMinutes = diffMinutes % 60;
        if (remainingMinutes === 0) {
          return `${diffHours} hour${diffHours === 1 ? '' : 's'} ago`;
        }
        return `${diffHours} hour${diffHours === 1 ? '' : 's'} and ${remainingMinutes} minute${remainingMinutes === 1 ? '' : 's'} ago`;
      }
      
      // Less than 7 days: show days, hours, and minutes
      if (diffDays < 7) {
        const remainingHours = diffHours % 24;
        const remainingMinutes = diffMinutes % 60;
        let result = `${diffDays} day${diffDays === 1 ? '' : 's'}`;
        if (remainingHours > 0) {
          result += `, ${remainingHours} hour${remainingHours === 1 ? '' : 's'}`;
        }
        if (remainingMinutes > 0) {
          result += `, ${remainingMinutes} minute${remainingMinutes === 1 ? '' : 's'}`;
        }
        return result + ' ago';
      }
      
      // 7+ days: show date
      return date.toLocaleDateString('en-US', { month: 'numeric', day: 'numeric', year: '2-digit' });
    }

    let html = '';
    sortVendorsWithPrepFirst(Object.keys(itemsByVendor)).forEach(vendor => {
      const items = itemsByVendor[vendor];
      const isPrepCategory = vendor === 'PREP';
      const headerColor = isPrepCategory ? '#212121' : 'var(--gray-700)'; // Grayscale throughout
      html += `
        <div style="margin-bottom: 30px;">
          <h4 style="background: ${headerColor}; color: white; padding: 12px 16px; border-radius: 0; margin-bottom: 12px; font-size: 14px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;">
            ${vendor} <span style="opacity: 0.7; font-weight: 400; font-size: 12px;">(${items.length})</span>
          </h4>

          <!-- Single column layout for all screens -->
          <div style="display: flex; flex-direction: column; gap: ${isCompactMode ? '8px' : '10px'};">
            ${items.map((item) => {
              const status = getStockStatus(item.currentStock, item.parLevel);
              const lastCounted = formatLastCounted(item.lastCountedDate);

              return `
                <div style="
                  background: white;
                  border: 1px solid #e0e0e0;
                  border-radius: ${isCompactMode ? '6px' : '8px'};
                  padding: ${isCompactMode ? '10px' : '14px'};
                  box-shadow: 0 1px 3px rgba(0,0,0,0.08);
                  transition: box-shadow 0.2s;
                "
                onmouseover="this.style.boxShadow='0 2px 8px rgba(0,0,0,0.12)'"
                onmouseout="this.style.boxShadow='0 1px 3px rgba(0,0,0,0.08)'">

                  <!-- Header: Item Name + Status Badge -->
                  <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: ${isCompactMode ? '8px' : '12px'}; gap: 8px;">
                    <div style="flex: 1; font-weight: 600; font-size: ${isCompactMode ? '14px' : '15px'}; line-height: 1.3; color: #333;">
                      ${item.itemName}
                    </div>
                    <div style="
                      background: ${status.bg};
                      color: ${status.color};
                      padding: ${isCompactMode ? '3px 8px' : '4px 10px'};
                      border-radius: 12px;
                      font-size: ${isCompactMode ? '10px' : '11px'};
                      font-weight: 700;
                      white-space: nowrap;
                      letter-spacing: 0.3px;
                    ">
                      ${status.label}
                    </div>
                  </div>

                  <!-- Metadata Row -->
                  <div style="
                    display: flex;
                    gap: ${isCompactMode ? '12px' : '16px'};
                    margin-bottom: ${isCompactMode ? '8px' : '12px'};
                    font-size: ${isCompactMode ? '12px' : '13px'};
                    color: #666;
                  ">
                    <div>
                      <span style="color: #999;">Unit:</span> <strong>${item.unit}</strong>
                    </div>
                    <div>
                      <span style="color: #999;">Par:</span> <strong>${item.parLevel}</strong>
                    </div>
                    <div style="margin-left: auto; color: #999; font-size: ${isCompactMode ? '11px' : '12px'};">
                      ${lastCounted}
                    </div>
                  </div>

                  ${item.lastInvoiceQty && item.lastInvoiceDate ? `
                  <!-- Invoice Addition Info -->
                  <div style="
                    margin-top: 8px;
                    margin-bottom: 12px;
                    padding: 8px 10px;
                    background: var(--blue-bg);
                    border-left: 3px solid var(--blue-text);
                    border-radius: 0;
                    font-size: ${isCompactMode ? '11px' : '12px'};
                    color: var(--blue-text);
                    font-weight: 600;
                    font-style: italic;
                  ">
                    ${item.lastInvoiceQty} ADDED VIA INVOICE ON ${formatPacificDateDisplay(new Date(item.lastInvoiceDate), {
                      month: 'short',
                      day: 'numeric',
                      year: 'numeric',
                      hour: 'numeric',
                      minute: '2-digit',
                      hour12: true
                    })}
                  </div>
                  ` : ''}

                  <!-- Stock Input with Quick Adjustments (Mobile-Optimized) -->
                  <div>
                    <label style="display: block; font-size: 12px; color: #666; margin-bottom: 6px; font-weight: 500;">
                      Current Stock
                    </label>
                    <!-- Input with Stepper Buttons -->
                    <div style="display: flex; gap: 5px; align-items: stretch;">
                      <!-- Decrement Button -->
                      <button
                        type="button"
                        onclick="quickAdjustStock(${item.id}, -0.25)"
                        style="
                          flex: 0 0 40px;
                          padding: 0;
                          font-size: 22px;
                          font-weight: 700;
                          background: #f5f5f5;
                          border: 2px solid #e0e0e0;
                          border-radius: 6px;
                          color: #666;
                          cursor: pointer;
                          transition: all 0.2s;
                          min-height: 48px;
                          display: flex;
                          align-items: center;
                          justify-content: center;
                        "
                        onmousedown="this.style.background='#e0e0e0'; this.style.transform='scale(0.95)';"
                        onmouseup="this.style.background='#f5f5f5'; this.style.transform='scale(1)';"
                        onmouseleave="this.style.background='#f5f5f5'; this.style.transform='scale(1)';"
                      >‚àí</button>

                      <!-- Stock Input Field -->
                      <input
                        type="number"
                        inputmode="decimal"
                        id="stock-${item.id}"
                        value="${item.currentStock}"
                        min="0"
                        step="0.25"
                        onblur="autoSaveStockCount(${item.id}, this.value, this)"
                        onchange="autoSaveStockCount(${item.id}, this.value, this)"
                        style="
                          flex: 1;
                          padding: 12px 6px;
                          font-size: 20px;
                          font-weight: 700;
                          text-align: center;
                          border: 2px solid #2e7d32;
                          border-radius: 6px;
                          background: #f9fdf9;
                          color: #2e7d32;
                          box-sizing: border-box;
                          -webkit-appearance: none;
                          -moz-appearance: textfield;
                          min-height: 48px;
                          transition: all 0.2s;
                        "
                        onfocus="this.style.borderColor='#1b5e20'; this.style.background='#ffffff'; this.select();"
                        onblur="this.style.borderColor='#2e7d32'; this.style.background='#f9fdf9';"
                      />

                      <!-- Increment Button -->
                      <button
                        type="button"
                        onclick="quickAdjustStock(${item.id}, 0.25)"
                        style="
                          flex: 0 0 40px;
                          padding: 0;
                          font-size: 22px;
                          font-weight: 700;
                          background: #2e7d32;
                          border: 2px solid #2e7d32;
                          border-radius: 6px;
                          color: white;
                          cursor: pointer;
                          transition: all 0.2s;
                          min-height: 48px;
                          display: flex;
                          align-items: center;
                          justify-content: center;
                        "
                        onmousedown="this.style.background='#1b5e20'; this.style.transform='scale(0.95)';"
                        onmouseup="this.style.background='#2e7d32'; this.style.transform='scale(1)';"
                        onmouseleave="this.style.background='#2e7d32'; this.style.transform='scale(1)';"
                      >+</button>
                    </div>

                    <!-- Save Status Indicator -->
                    <div
                      id="save-status-${item.id}"
                      style="
                        margin-top: 6px;
                        font-size: 11px;
                        text-align: center;
                        min-height: 16px;
                        font-weight: 600;
                        opacity: 0;
                        transition: opacity 0.2s;
                      "
                    ></div>
                  </div>

                  <!-- Par Level Editor -->
                  <div style="margin-top: 14px;">
                    <label style="display: block; font-size: 11px; color: #666; margin-bottom: 6px; font-weight: 500;">
                      Par Level
                    </label>
                    <p style="margin: 0 0 6px 0; font-size: 9px; color: #999; font-style: italic;">
                      ‚ö†Ô∏è Warning: Only edit par level if it is incorrect!
                    </p>
                    <div style="display: flex; gap: 4px; align-items: stretch; max-width: 35%;">
                      <!-- Decrement Button (Smaller) -->
                      <button
                        type="button"
                        onclick="quickAdjustParLevel(${item.id}, -0.25)"
                        style="
                          flex: 0 0 28px;
                          padding: 0;
                          font-size: 16px;
                          font-weight: 700;
                          background: #f5f5f5;
                          border: 2px solid #e0e0e0;
                          border-radius: 6px;
                          color: #666;
                          cursor: pointer;
                          transition: all 0.2s;
                          min-height: 32px;
                          display: flex;
                          align-items: center;
                          justify-content: center;
                        "
                        onmousedown="this.style.background='#e0e0e0'; this.style.transform='scale(0.95)';"
                        onmouseup="this.style.background='#f5f5f5'; this.style.transform='scale(1)';"
                        onmouseleave="this.style.background='#f5f5f5'; this.style.transform='scale(1)';"
                      >‚àí</button>

                      <!-- Par Level Input Field (Smaller) -->
                      <input
                        type="number"
                        inputmode="decimal"
                        id="par-${item.id}"
                        value="${item.parLevel}"
                        min="0"
                        step="0.25"
                        onblur="autoSaveParLevel(${item.id}, this.value, this)"
                        onchange="autoSaveParLevel(${item.id}, this.value, this)"
                        style="
                          flex: 1;
                          padding: 6px 4px;
                          font-size: 14px;
                          font-weight: 600;
                          text-align: center;
                          border: 2px solid #999;
                          border-radius: 6px;
                          background: #ffffff;
                          color: #333;
                          box-sizing: border-box;
                          -webkit-appearance: none;
                          -moz-appearance: textfield;
                          min-height: 32px;
                          transition: all 0.2s;
                        "
                        onfocus="this.style.borderColor='#1976d2'; this.style.background='#f0f9ff'; this.select();"
                        onblur="this.style.borderColor='#999'; this.style.background='#ffffff';"
                      />

                      <!-- Increment Button (Smaller) -->
                      <button
                        type="button"
                        onclick="quickAdjustParLevel(${item.id}, 0.25)"
                        style="
                          flex: 0 0 28px;
                          padding: 0;
                          font-size: 16px;
                          font-weight: 700;
                          background: #1976d2;
                          border: 2px solid #1976d2;
                          border-radius: 6px;
                          color: white;
                          cursor: pointer;
                          transition: all 0.2s;
                          min-height: 32px;
                          display: flex;
                          align-items: center;
                          justify-content: center;
                        "
                        onmousedown="this.style.background='#1565c0'; this.style.transform='scale(0.95)';"
                        onmouseup="this.style.background='#1976d2'; this.style.transform='scale(1)';"
                        onmouseleave="this.style.background='#1976d2'; this.style.transform='scale(1)';"
                      >+</button>
                    </div>

                    <!-- Par Save Status Indicator -->
                    <div
                      id="par-save-status-${item.id}"
                      style="
                        margin-top: 4px;
                        font-size: 10px;
                        text-align: left;
                        min-height: 14px;
                        font-weight: 600;
                        opacity: 0;
                        transition: opacity 0.2s;
                        max-width: 35%;
                      "
                    ></div>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        </div>
      `;
    });

    container.innerHTML = html;
  }

  /**
   * Render PREP items count list (for PREP tab)
   * Shows only PREP category items
   */
  /**
   * Refresh Bottle Count Display
   */
  function refreshBottleCount() {
    const container = document.getElementById('bottleCountGrid');
    if (!container) return;

    // Filter to only items with "Include in Bottle Count" checkbox enabled
    const bottleItems = orderingSystemState.items.filter(item =>
      item.showInBottleCount === true
    );

    if (bottleItems.length === 0) {
      container.innerHTML = `
        <div style="text-align: center; color: rgba(255, 255, 255, 0.8); font-size: 12px; padding: 20px; grid-column: 1 / -1;">
          No items marked for bottle count. Enable "Include in Bottle Count" checkbox on prep items.
        </div>
      `;
      return;
    }

    // Sort alphabetically
    bottleItems.sort((a, b) => a.itemName.localeCompare(b.itemName));

    // Render bottle cards
    const html = bottleItems.map(item => {
      const stock = item.currentStock || 0;
      const par = item.parLevel || 0;
      const percentage = par > 0 ? Math.round((stock / par) * 100) : 0;

      // Status color
      let statusColor = '#4CAF50'; // Good (green)
      if (percentage < 30) statusColor = '#F44336'; // Low (red)
      else if (percentage < 70) statusColor = '#FF9800'; // Medium (orange)

      return `
        <div style="
          background: rgba(255, 255, 255, 0.15);
          border: 2px solid rgba(255, 255, 255, 0.3);
          padding: 12px;
          text-align: center;
          transition: all 0.2s;
          cursor: pointer;
        " onmouseover="this.style.background='rgba(255,255,255,0.25)'" onmouseout="this.style.background='rgba(255,255,255,0.15)'">
          <div style="color: white; font-size: 11px; font-weight: 700; text-transform: uppercase; margin-bottom: 8px; line-height: 1.3;">
            ${item.itemName}
          </div>
          <div style="color: white; font-size: 24px; font-weight: 700; margin-bottom: 4px;">
            ${stock}
          </div>
          <div style="color: rgba(255, 255, 255, 0.7); font-size: 10px; margin-bottom: 8px;">
            / ${par} ${item.unit || 'UNITS'}
          </div>
          <div style="
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
            overflow: hidden;
          ">
            <div style="
              width: ${Math.min(percentage, 100)}%;
              height: 100%;
              background: ${statusColor};
              transition: width 0.3s;
            "></div>
          </div>
        </div>
      `;
    }).join('');

    container.innerHTML = html;
  }

  function renderPrepCountList() {
    // Update the active counter display at the top
    updatePrepCounterDisplay();

    const container = document.getElementById('prepCountList');
    if (!container) return;

    // Filter to only PREP items
    const prepItems = orderingSystemState.items.filter(item =>
      item.vendor === 'PREP' || item.itemType === 'prep'
    );

    if (prepItems.length === 0) {
      container.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--gray-500); font-size: 13px;">No prep items found. Add prep items using the form above.</p>';
      return;
    }

    // Group items by storage location
    // MULTI-LOCATION ITEMS: appear in EACH location's group
    const groupedItems = {};
    prepItems.forEach(item => {
      if (item.hasMultipleLocations && item.locationCounts) {
        // Multi-location: add item to EACH location group
        Object.keys(item.locationCounts).forEach(location => {
          if (!groupedItems[location]) {
            groupedItems[location] = [];
          }
          groupedItems[location].push(item);
        });
      } else {
        // Single location: add to storageLocation group
        const area = item.storageLocation || 'No Defined Area';
        if (!groupedItems[area]) {
          groupedItems[area] = [];
        }
        groupedItems[area].push(item);
      }
    });

    // Sort areas alphabetically, but put "No Defined Area" last
    const sortedAreas = Object.keys(groupedItems).sort((a, b) => {
      if (a === 'No Defined Area') return 1;
      if (b === 'No Defined Area') return -1;
      return a.localeCompare(b);
    });

    // Helper functions
    function getStockStatus(currentStock, parLevel) {
      if (parLevel === 0) return { label: 'N/A', color: '#999', bg: '#f5f5f5' };
      const percentage = (currentStock / parLevel) * 100;
      if (percentage < 30) return { label: 'LOW', color: '#d32f2f', bg: '#ffebee' };
      if (percentage < 70) return { label: 'MEDIUM', color: '#f57c00', bg: '#fff3e0' };
      return { label: 'GOOD', color: '#388e3c', bg: '#e8f5e9' };
    }

    function formatLastCounted(dateStr) {
      if (!dateStr) return 'Never';
      const date = new Date(dateStr);
      const now = new Date();
      const diffMs = now - date;
      const diffMinutes = Math.floor(diffMs / (1000 * 60));
      const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
      const diffDays = Math.floor(diffHours / 24);

      // Less than 1 hour: show minutes
      if (diffMinutes < 60) {
        return `${diffMinutes} minute${diffMinutes === 1 ? '' : 's'} ago`;
      }

      // Less than 24 hours: show hours and minutes
      if (diffHours < 24) {
        const remainingMinutes = diffMinutes % 60;
        if (remainingMinutes === 0) {
          return `${diffHours} hour${diffHours === 1 ? '' : 's'} ago`;
        }
        return `${diffHours} hour${diffHours === 1 ? '' : 's'} and ${remainingMinutes} minute${remainingMinutes === 1 ? '' : 's'} ago`;
      }

      // Less than 7 days: show days, hours, and minutes
      if (diffDays < 7) {
        const remainingHours = diffHours % 24;
        const remainingMinutes = diffMinutes % 60;
        let result = `${diffDays} day${diffDays === 1 ? '' : 's'}`;
        if (remainingHours > 0) {
          result += `, ${remainingHours} hour${remainingHours === 1 ? '' : 's'}`;
        }
        if (remainingMinutes > 0) {
          result += `, ${remainingMinutes} minute${remainingMinutes === 1 ? '' : 's'}`;
        }
        return result + ' ago';
      }

      // 7+ days: show date
      return date.toLocaleDateString('en-US', { month: 'numeric', day: 'numeric', year: '2-digit' });
    }

    /**
     * Helper function to check if item was counted recently (within last 12 hours)
     * Used for progress bar time-based reset logic
     */
    function isCountedRecently(item) {
      if (!item.countedBy || !item.countedAt) return false;

      const now = new Date();
      const cutoffHours = 12; // 12-hour window to cover nightly counting cycle
      const cutoffTime = new Date(now.getTime() - (cutoffHours * 60 * 60 * 1000));
      const countedDate = new Date(item.countedAt);

      return countedDate > cutoffTime;
    }

    let html = '';

    // Render each area group
    sortedAreas.forEach((area, areaIndex) => {
      const areaItems = groupedItems[area];

      html += `
        <div class="prep-location-section" style="margin-bottom: ${areaIndex < sortedAreas.length - 1 ? '32px' : '20px'};">
          <h4
            onclick="toggleLocationSection('${area.replace(/'/g, "\\'")}')"
            style="background: var(--gray-700); color: var(--white); padding: 12px 16px; border-radius: 0; margin-bottom: 12px; font-size: 14px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; cursor: pointer; user-select: none; display: flex; justify-content: space-between; align-items: center;"
            onmouseover="this.style.background='var(--gray-600)'"
            onmouseout="this.style.background='var(--gray-700)'"
          >
            <span>
              <span id="location-arrow-${area.replace(/\s/g, '_')}" style="display: inline-block; transition: transform 0.3s;">‚ñ∂</span>
              ${area.toUpperCase()} <span style="opacity: 0.85; font-weight: 400; font-size: 12px;">(${areaItems.length} items)</span>
            </span>
          </h4>

          <!-- Single column layout for all screens - DEFAULT COLLAPSED -->
          <div id="location-items-${area.replace(/\s/g, '_')}" class="location-items-container" style="display: none; flex-direction: column; gap: ${isCompactMode ? '8px' : '10px'};">
            ${areaItems.map((item) => {
            const status = getStockStatus(item.currentStock, item.parLevel);
            const lastCounted = formatLastCounted(item.lastCountedDate);

            return `
              <div
                class="prep-item-card ${isCountedRecently(item) ? 'counted-item' : 'uncounted-item'}"
                data-item-id="${item.id}"
                data-item-counted="${isCountedRecently(item) ? 'true' : 'false'}"
                data-stock-status="${status.label.toLowerCase()}"
                style="
                  background: var(--white);
                  border: 2px solid var(--gray-300);
                  border-radius: 0;
                  padding: ${isCompactMode ? '10px' : '14px'};
                  box-shadow: 0 1px 3px rgba(0,0,0,0.08);
                  transition: box-shadow 0.2s;
                "
                onmouseover="this.style.boxShadow='0 2px 8px rgba(0,0,0,0.12)'"
                onmouseout="this.style.boxShadow='0 1px 3px rgba(0,0,0,0.08)'"
              >
                <!-- FEATURE 8: Bulk Selection Checkbox -->
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                  <input
                    type="checkbox"
                    class="bulk-select-checkbox"
                    data-item-id="${item.id}"
                    style="width: 18px; height: 18px; cursor: pointer;"
                    onchange="updateBulkSelectionCount()"
                  />
                  <label style="font-size: 11px; color: var(--gray-500); cursor: pointer; user-select: none;" onclick="event.target.previousElementSibling.click()">
                    Select for bulk action
                  </label>
                </div>

                <!-- Header: Item Name + Status Badge -->
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: ${isCompactMode ? '4px' : '6px'}; gap: 8px;">
                  <div style="flex: 1;">
                    <div style="font-weight: 700; font-size: ${isCompactMode ? '14px' : '15px'}; line-height: 1.3; color: var(--gray-900); text-transform: uppercase; letter-spacing: 0.5px;">
                      ${item.itemName}
                    </div>
                    <div style="margin-top: 4px;">
                      <a href="javascript:void(0)"
                         onclick="showAreaSelector(${item.id}, '${(item.storageLocation || '').replace(/'/g, "\\'")}', event)"
                         style="
                           color: #1976d2;
                           font-size: 10px;
                           font-style: italic;
                           text-decoration: none;
                           cursor: pointer;
                           opacity: 0.85;
                         "
                         onmouseover="this.style.opacity='1'; this.style.textDecoration='underline'"
                         onmouseout="this.style.opacity='0.85'; this.style.textDecoration='none'">
                        ${item.hasMultipleLocations ? Object.keys(item.locationCounts || {}).join(', ') : (item.storageLocation || 'No defined area')}
                      </a>
                    </div>
                  </div>
                  <div style="
                    background: ${status.bg};
                    color: ${status.color};
                    padding: ${isCompactMode ? '3px 8px' : '4px 10px'};
                    border-radius: 0;
                    font-size: ${isCompactMode ? '10px' : '11px'};
                    font-weight: 700;
                    white-space: nowrap;
                    letter-spacing: 0.3px;
                  ">
                    ${status.label}
                  </div>
                </div>

                <!-- Metadata Row -->
                <div style="
                  display: flex;
                  gap: ${isCompactMode ? '12px' : '16px'};
                  margin-bottom: ${isCompactMode ? '8px' : '12px'};
                  font-size: ${isCompactMode ? '12px' : '13px'};
                  color: var(--gray-600);
                ">
                  <div>
                    <span style="color: var(--gray-500);">Unit:</span> <strong>${item.unit}</strong>
                  </div>
                  <div>
                    <span style="color: var(--gray-500);">Par:</span> <strong>${item.parLevel}</strong>
                  </div>
                  ${item.batchLifespan ? `<div><span style="color: var(--gray-500);">Life:</span> <strong>${item.batchLifespan}h</strong></div>` : ''}
                  <div style="margin-left: auto; color: var(--gray-500); font-size: ${isCompactMode ? '11px' : '12px'};">
                    ${lastCounted}
                  </div>
                </div>

                <!-- Counted By Display (shows after item is counted) -->
                ${item.countedBy ? `
                  <div style="display: flex; align-items: center; gap: 6px; font-size: 11px; color: var(--gray-600); margin-bottom: 12px; font-style: italic; flex-wrap: wrap; padding: 8px 12px; background: var(--gray-50); border-left: 3px solid var(--gray-400);">
                    <!-- Color dot for user -->
                    ${(() => {
                      const userIndex = prepCountingState.teamNames.findIndex(u => u.name === item.countedBy);
                      const userColor = userIndex >= 0 ? prepCountingState.teamNames[userIndex].color : getUserColor(0);
                      return `<div style="width: 12px; height: 12px; border-radius: 50%; background: ${userColor}; flex-shrink: 0;"></div>`;
                    })()}
                    <!-- CLICKABLE NAME: Click entire name text to cycle through clocked-in users -->
                    ${prepCountingState.teamNames.length > 1 || prepCountingState.clockedInEmployees.length > 0 ? `
                      <a href="javascript:void(0)"
                         onclick="event.stopPropagation(); changePrepItemUser(${item.id})"
                         style="
                           color: var(--gray-600);
                           font-size: 11px;
                           text-decoration: none;
                           cursor: pointer;
                           font-style: italic;
                           padding: 2px 4px;
                           border-radius: 0;
                           transition: all 0.15s ease;
                         "
                         onmouseover="this.style.color='var(--primary-blue)'"
                         onmouseout="this.style.color='var(--gray-600)'"
                         title="Click to cycle to next user (${prepCountingState.clockedInEmployees.length} clocked in)">
                        ‚úì ${item.countedBy}${item.countedAt ? ` ‚Ä¢ ${formatPacificDateDisplay(new Date(item.countedAt), {
                          hour: 'numeric',
                          minute: '2-digit',
                          hour12: true
                        })}` : ''}
                      </a>
                    ` : `
                      <span>
                        ‚úì ${item.countedBy}${item.countedAt ? ` ‚Ä¢ ${formatPacificDateDisplay(new Date(item.countedAt), {
                          hour: 'numeric',
                          minute: '2-digit',
                          hour12: true
                        })}` : ''}
                      </span>
                    `}
                  </div>
                ` : ''}

                <!-- FEATURE 3: Quick-Fill Buttons -->
                <div style="display: flex; gap: 6px; margin-bottom: 12px; flex-wrap: wrap;">
                  <button
                    type="button"
                    onclick="quickFillStock(${item.id}, 'full')"
                    style="
                      flex: 1;
                      min-width: 60px;
                      padding: 8px 12px;
                      font-size: 11px;
                      font-weight: 700;
                      background: #4caf50;
                      border: 2px solid #4caf50;
                      border-radius: 0;
                      color: white;
                      cursor: pointer;
                      transition: all 0.2s;
                      text-transform: uppercase;
                      letter-spacing: 0.5px;
                      min-height: 44px;
                    "
                    onmouseover="this.style.background='#45a049'"
                    onmouseout="this.style.background='#4caf50'"
                  >FULL</button>
                  <button
                    type="button"
                    onclick="quickFillStock(${item.id}, 'half')"
                    style="
                      flex: 1;
                      min-width: 60px;
                      padding: 8px 12px;
                      font-size: 11px;
                      font-weight: 700;
                      background: #ff9800;
                      border: 2px solid #ff9800;
                      border-radius: 0;
                      color: white;
                      cursor: pointer;
                      transition: all 0.2s;
                      text-transform: uppercase;
                      letter-spacing: 0.5px;
                      min-height: 44px;
                    "
                    onmouseover="this.style.background='#fb8c00'"
                    onmouseout="this.style.background='#ff9800'"
                  >¬Ω</button>
                  <button
                    type="button"
                    onclick="quickFillStock(${item.id}, 'empty')"
                    style="
                      flex: 1;
                      min-width: 60px;
                      padding: 8px 12px;
                      font-size: 11px;
                      font-weight: 700;
                      background: #f44336;
                      border: 2px solid #f44336;
                      border-radius: 0;
                      color: white;
                      cursor: pointer;
                      transition: all 0.2s;
                      text-transform: uppercase;
                      letter-spacing: 0.5px;
                      min-height: 44px;
                    "
                    onmouseover="this.style.background='#e53935'"
                    onmouseout="this.style.background='#f44336'"
                  >EMPTY</button>
                  <button
                    type="button"
                    onclick="quickFillStock(${item.id}, 'skip')"
                    style="
                      flex: 1;
                      min-width: 60px;
                      padding: 8px 12px;
                      font-size: 11px;
                      font-weight: 700;
                      background: var(--gray-400);
                      border: 2px solid var(--gray-400);
                      border-radius: 0;
                      color: white;
                      cursor: pointer;
                      transition: all 0.2s;
                      text-transform: uppercase;
                      letter-spacing: 0.5px;
                      min-height: 44px;
                    "
                    onmouseover="this.style.background='var(--gray-500)'"
                    onmouseout="this.style.background='var(--gray-400)'"
                  >SKIP</button>
                </div>

                <!-- Stock Input with Quick Adjustments -->
                <div>
                  ${item.hasMultipleLocations ? `
                    <!-- MULTIPLE LOCATIONS MODE -->
                    ${Object.keys(item.locationCounts || {}).map(location => `
                      <div style="margin-bottom: 12px;">
                        <label style="display: block; font-size: 11px; color: var(--gray-600); margin-bottom: 6px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">
                          ${location}
                        </label>
                        <div style="display: flex; gap: 5px; align-items: stretch;">
                          <button
                            type="button"
                            onclick="quickAdjustLocationStock(${item.id}, '${location.replace(/'/g, "\\'")}', -0.25)"
                            style="
                              flex: 0 0 36px;
                              padding: 0;
                              font-size: 18px;
                              font-weight: 700;
                              background: var(--gray-100);
                              border: 2px solid var(--gray-300);
                              border-radius: 0;
                              color: var(--gray-700);
                              cursor: pointer;
                              transition: all 0.2s;
                              min-height: 40px;
                              display: flex;
                              align-items: center;
                              justify-content: center;
                            "
                          >‚àí</button>
                          <input
                            type="number"
                            inputmode="decimal"
                            id="location-stock-${item.id}-${location.replace(/\s/g, '_')}"
                            value="${item.locationCounts[location] || 0}"
                            min="0"
                            step="0.25"
                            onblur="autoSaveLocationStock(${item.id}, '${location.replace(/'/g, "\\'")}', this.value, this)"
                            onchange="autoSaveLocationStock(${item.id}, '${location.replace(/'/g, "\\'")}', this.value, this)"
                            style="
                              flex: 1;
                              padding: 10px 6px;
                              font-size: 16px;
                              font-weight: 700;
                              text-align: center;
                              border: 2px solid var(--gray-500);
                              border-radius: 0;
                              background: white;
                              color: var(--gray-900);
                              box-sizing: border-box;
                              min-height: 40px;
                            "
                          />
                          <button
                            type="button"
                            onclick="quickAdjustLocationStock(${item.id}, '${location.replace(/'/g, "\\'")}', 0.25)"
                            style="
                              flex: 0 0 36px;
                              padding: 0;
                              font-size: 18px;
                              font-weight: 700;
                              background: var(--gray-700);
                              border: 2px solid var(--gray-700);
                              border-radius: 0;
                              color: white;
                              cursor: pointer;
                              transition: all 0.2s;
                              min-height: 40px;
                              display: flex;
                              align-items: center;
                              justify-content: center;
                            "
                          >+</button>
                        </div>
                      </div>
                    `).join('')}

                    <!-- TOTAL COUNT (Read-only, grayed out) -->
                    <div style="margin-top: 16px; padding-top: 12px; border-top: 2px solid var(--gray-300);">
                      <label style="display: block; font-size: 12px; color: var(--gray-600); margin-bottom: 6px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">
                        Total Stock (All Locations)
                      </label>
                      <input
                        type="number"
                        id="stock-${item.id}"
                        value="${Object.values(item.locationCounts || {}).reduce((sum, count) => sum + parseFloat(count || 0), 0)}"
                        disabled
                        style="
                          width: 100%;
                          padding: 12px 6px;
                          font-size: 20px;
                          font-weight: 700;
                          text-align: center;
                          border: 2px solid var(--gray-400);
                          border-radius: 0;
                          background: var(--gray-200);
                          color: var(--gray-500);
                          box-sizing: border-box;
                          min-height: 48px;
                          cursor: not-allowed;
                        "
                      />
                    </div>

                  ` : `
                    <!-- SINGLE LOCATION MODE (Normal) -->
                    <label style="display: block; font-size: 12px; color: var(--gray-600); margin-bottom: 6px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">
                      Current Stock
                    </label>
                    <div style="display: flex; gap: 5px; align-items: stretch;">
                      <button
                        type="button"
                        onclick="quickAdjustStock(${item.id}, -0.25)"
                        style="
                          flex: 0 0 40px;
                          padding: 0;
                          font-size: 22px;
                          font-weight: 700;
                          background: var(--gray-100);
                          border: 2px solid var(--gray-300);
                          border-radius: 0;
                          color: var(--gray-700);
                          cursor: pointer;
                          transition: all 0.2s;
                          min-height: 48px;
                          display: flex;
                          align-items: center;
                          justify-content: center;
                        "
                      >‚àí</button>
                      <input
                        type="number"
                        inputmode="decimal"
                        id="stock-${item.id}"
                        value="${item.currentStock}"
                        min="0"
                        step="0.25"
                        onblur="autoSaveStockCount(${item.id}, this.value, this)"
                        onchange="autoSaveStockCount(${item.id}, this.value, this)"
                        style="
                          flex: 1;
                          padding: 12px 6px;
                          font-size: 20px;
                          font-weight: 700;
                          text-align: center;
                          border: 2px solid var(--gray-700);
                          border-radius: 0;
                          background: var(--gray-100);
                          color: var(--gray-900);
                          box-sizing: border-box;
                          min-height: 48px;
                        "
                      />
                      <button
                        type="button"
                        onclick="quickAdjustStock(${item.id}, 0.25)"
                        style="
                          flex: 0 0 40px;
                          padding: 0;
                          font-size: 22px;
                          font-weight: 700;
                          background: var(--gray-700);
                          border: 2px solid var(--gray-700);
                          border-radius: 0;
                          color: var(--white);
                          cursor: pointer;
                          transition: all 0.2s;
                          min-height: 48px;
                          display: flex;
                          align-items: center;
                          justify-content: center;
                        "
                      >+</button>
                    </div>
                  `}

                  <!-- Save Status Indicator -->
                  <div
                    id="save-status-${item.id}"
                    style="
                      margin-top: 6px;
                      font-size: 11px;
                      text-align: center;
                      min-height: 16px;
                      font-weight: 600;
                      opacity: 0;
                      transition: opacity 0.2s;
                    "
                  ></div>
                </div>

                <!-- Unified EDIT Section (Collapsible) -->
                <div style="border-top: 1px solid var(--gray-200); margin-top: 12px; padding-top: 8px;">
                  <!-- EDIT Toggle -->
                  <div
                    id="edit-toggle-${item.id}"
                    onclick="toggleItemEditor(${item.id})"
                    style="
                      color: #999;
                      font-size: 11px;
                      font-weight: 600;
                      text-transform: uppercase;
                      cursor: pointer;
                      padding: 8px 0;
                      display: flex;
                      align-items: center;
                      gap: 6px;
                      user-select: none;
                    "
                    onmouseover="this.style.color='#666'"
                    onmouseout="this.style.color='#999'"
                  >
                    <span id="edit-arrow-${item.id}" style="display: inline-block; transition: transform 0.3s;">‚ñ∂</span>
                    EDIT
                  </div>

                  <!-- Collapsible Editor Section -->
                  <div
                    id="item-editor-${item.id}"
                    style="display: none; padding: 16px; background: #f5f5f5; border: 1px solid #e0e0e0; margin-top: 8px;"
                  >
                    <!-- ITEM NAME -->
                    <div style="margin-bottom: 16px;">
                      <label style="display: block; font-size: 11px; color: var(--gray-600); margin-bottom: 6px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">
                        ITEM NAME
                      </label>
                      <input
                        type="text"
                        id="edit-name-${item.id}"
                        value="${item.itemName}"
                        style="
                          width: 100%;
                          padding: 10px 12px;
                          font-size: 14px;
                          font-weight: 600;
                          border: 2px solid var(--gray-300);
                          border-radius: 0;
                          background: var(--white);
                          color: var(--gray-900);
                          box-sizing: border-box;
                          min-height: 44px;
                        "
                        onfocus="this.style.borderColor='var(--gray-700)'"
                        onblur="this.style.borderColor='var(--gray-300)'"
                      />
                    </div>

                    <!-- PAR LEVEL -->
                    <div style="margin-bottom: 16px;">
                      <label style="display: block; font-size: 11px; color: var(--gray-600); margin-bottom: 6px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">
                        PAR LEVEL
                      </label>
                      <p style="margin: 0 0 8px 0; font-size: 9px; color: var(--gray-500); font-style: italic;">
                        ‚ö†Ô∏è Warning: Only edit if incorrect!
                      </p>
                      <div style="display: flex; gap: 5px;">
                        <button
                          type="button"
                          onclick="adjustEditPar(${item.id}, -0.25)"
                          style="
                            flex: 0 0 44px;
                            padding: 0;
                            font-size: 20px;
                            font-weight: 700;
                            background: var(--gray-100);
                            border: 2px solid var(--gray-300);
                            border-radius: 0;
                            color: var(--gray-700);
                            cursor: pointer;
                            transition: all 0.2s;
                            min-height: 44px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                          "
                        >‚àí</button>
                        <input
                          type="number"
                          inputmode="decimal"
                          id="edit-par-${item.id}"
                          value="${item.parLevel}"
                          min="0"
                          step="0.25"
                          style="
                            flex: 1;
                            padding: 10px 12px;
                            font-size: 16px;
                            font-weight: 700;
                            text-align: center;
                            border: 2px solid var(--gray-400);
                            border-radius: 0;
                            background: var(--white);
                            color: var(--gray-900);
                            box-sizing: border-box;
                            min-height: 44px;
                          "
                          onfocus="this.style.borderColor='var(--gray-700)'; this.select();"
                          onblur="this.style.borderColor='var(--gray-400)'"
                        />
                        <button
                          type="button"
                          onclick="adjustEditPar(${item.id}, 0.25)"
                          style="
                            flex: 0 0 44px;
                            padding: 0;
                            font-size: 20px;
                            font-weight: 700;
                            background: var(--gray-700);
                            border: 2px solid var(--gray-700);
                            border-radius: 0;
                            color: var(--white);
                            cursor: pointer;
                            transition: all 0.2s;
                            min-height: 44px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                          "
                        >+</button>
                      </div>
                    </div>

                    <!-- UNIT -->
                    <div style="margin-bottom: 16px;">
                      <label style="display: block; font-size: 11px; color: var(--gray-600); margin-bottom: 6px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">
                        UNIT
                      </label>
                      <select
                        id="edit-unit-${item.id}"
                        style="
                          width: 100%;
                          padding: 10px 12px;
                          font-size: 14px;
                          font-weight: 600;
                          border: 2px solid var(--gray-300);
                          border-radius: 0;
                          background: var(--white);
                          color: var(--gray-900);
                          box-sizing: border-box;
                          min-height: 44px;
                        "
                        onfocus="this.style.borderColor='var(--gray-700)'"
                        onblur="this.style.borderColor='var(--gray-300)'"
                      >
                        ${['Containers', 'Batches', 'Portions', 'Pieces', 'Ounces', 'Pounds', 'Quarts', 'Gallons', 'Liters', 'Each', 'Box', 'Case'].map(unit =>
                          `<option value="${unit}" ${item.unit === unit ? 'selected' : ''}>${unit}</option>`
                        ).join('')}
                      </select>
                    </div>

                    <!-- VENDOR -->
                    <div style="margin-bottom: 16px;">
                      <label style="display: block; font-size: 11px; color: var(--gray-600); margin-bottom: 6px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">
                        VENDOR
                      </label>
                      <select
                        id="edit-vendor-${item.id}"
                        style="
                          width: 100%;
                          padding: 10px 12px;
                          font-size: 14px;
                          font-weight: 600;
                          border: 2px solid var(--gray-300);
                          border-radius: 0;
                          background: var(--white);
                          color: var(--gray-900);
                          box-sizing: border-box;
                          min-height: 44px;
                        "
                        onfocus="this.style.borderColor='var(--gray-700)'"
                        onblur="this.style.borderColor='var(--gray-300)'"
                      >
                        ${(() => {
                          const vendors = Array.from(new Set(orderingSystemState.items.map(i => i.vendor).filter(Boolean))).sort();
                          return vendors.map(vendor =>
                            `<option value="${vendor}" ${item.vendor === vendor ? 'selected' : ''}>${vendor}</option>`
                          ).join('');
                        })()}
                      </select>
                    </div>

                    <!-- STORAGE LOCATION -->
                    <div style="margin-bottom: 16px;">
                      <label style="display: block; font-size: 11px; color: var(--gray-600); margin-bottom: 6px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">
                        STORAGE LOCATION
                      </label>
                      <select
                        id="edit-location-${item.id}"
                        style="
                          width: 100%;
                          padding: 10px 12px;
                          font-size: 14px;
                          font-weight: 600;
                          border: 2px solid var(--gray-300);
                          border-radius: 0;
                          background: var(--white);
                          color: var(--gray-900);
                          box-sizing: border-box;
                          min-height: 44px;
                        "
                        onfocus="this.style.borderColor='var(--gray-700)'"
                        onblur="this.style.borderColor='var(--gray-300)'"
                      >
                        ${(() => {
                          const prepItems = orderingSystemState.items.filter(i => i.vendor === 'PREP' || i.itemType === 'prep');
                          const locations = new Set();
                          prepItems.forEach(i => {
                            if (i.storageLocation && i.storageLocation.trim()) locations.add(i.storageLocation.trim());
                            if (i.locationCounts) {
                              Object.keys(i.locationCounts).forEach(loc => locations.add(loc));
                            }
                          });
                          const sortedLocations = Array.from(locations).sort();
                          return sortedLocations.map(loc =>
                            `<option value="${loc}" ${item.storageLocation === loc ? 'selected' : ''}>${loc}</option>`
                          ).join('');
                        })()}
                      </select>
                    </div>

                    <!-- BATCH LIFESPAN (if PREP item) -->
                    ${item.vendor === 'PREP' || item.itemType === 'prep' ? `
                    <div style="margin-bottom: 16px;">
                      <label style="display: block; font-size: 11px; color: var(--gray-600); margin-bottom: 6px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">
                        BATCH LIFESPAN (HOURS)
                      </label>
                      <input
                        type="number"
                        id="edit-lifespan-${item.id}"
                        value="${item.batchLifespan || ''}"
                        placeholder="e.g., 24"
                        min="0"
                        step="1"
                        style="
                          width: 100%;
                          padding: 10px 12px;
                          font-size: 14px;
                          font-weight: 600;
                          border: 2px solid var(--gray-300);
                          border-radius: 0;
                          background: var(--white);
                          color: var(--gray-900);
                          box-sizing: border-box;
                          min-height: 44px;
                        "
                        onfocus="this.style.borderColor='var(--gray-700)'"
                        onblur="this.style.borderColor='var(--gray-300)'"
                      />
                    </div>
                    ` : ''}

                    <!-- CHECKBOXES -->
                    <div style="margin-bottom: 16px;">
                      <label style="display: block; font-size: 11px; color: var(--gray-600); margin-bottom: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">
                        OPTIONS
                      </label>
                      <div style="display: flex; flex-direction: column; gap: 10px;">
                        <!-- Urgent -->
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 8px; background: var(--white); border: 1px solid var(--gray-300);">
                          <input
                            type="checkbox"
                            id="edit-urgent-${item.id}"
                            ${item.urgent ? 'checked' : ''}
                            style="width: 18px; height: 18px; cursor: pointer;"
                          />
                          <span style="font-size: 12px; font-weight: 600; color: var(--gray-700); text-transform: uppercase; letter-spacing: 0.3px;">
                            MAKE FIRST (URGENT)
                          </span>
                        </label>

                        <!-- Line Cooks Prep -->
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 8px; background: var(--white); border: 1px solid var(--gray-300);">
                          <input
                            type="checkbox"
                            id="edit-line-cooks-prep-${item.id}"
                            ${item.lineCooksPrep ? 'checked' : ''}
                            style="width: 18px; height: 18px; cursor: pointer;"
                          />
                          <span style="font-size: 12px; font-weight: 600; color: var(--gray-700); text-transform: uppercase; letter-spacing: 0.3px;">
                            LINE COOKS PREP
                          </span>
                        </label>

                        <!-- Not Made Daily -->
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 8px; background: var(--white); border: 1px solid var(--gray-300);">
                          <input
                            type="checkbox"
                            id="edit-not-made-daily-${item.id}"
                            ${item.notMadeDaily ? 'checked' : ''}
                            style="width: 18px; height: 18px; cursor: pointer;"
                          />
                          <span style="font-size: 12px; font-weight: 600; color: var(--gray-700); text-transform: uppercase; letter-spacing: 0.3px;">
                            NOT MADE DAILY
                          </span>
                        </label>

                        <!-- Show in Bottle Count -->
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 8px; background: var(--white); border: 1px solid var(--gray-300);">
                          <input
                            type="checkbox"
                            id="edit-bottle-count-${item.id}"
                            ${item.showInBottleCount ? 'checked' : ''}
                            style="width: 18px; height: 18px; cursor: pointer;"
                          />
                          <span style="font-size: 12px; font-weight: 600; color: var(--gray-700); text-transform: uppercase; letter-spacing: 0.3px;">
                            SHOW IN BOTTLE COUNT
                          </span>
                        </label>
                      </div>
                    </div>

                    <!-- SAVE BUTTON -->
                    <button
                      onclick="saveItemEdits(${item.id})"
                      style="
                        width: 100%;
                        padding: 14px 24px;
                        font-size: 13px;
                        font-weight: 700;
                        text-transform: uppercase;
                        letter-spacing: 0.5px;
                        background: var(--gray-900);
                        border: 2px solid var(--gray-900);
                        border-radius: 0;
                        color: var(--white);
                        cursor: pointer;
                        transition: all 0.15s ease;
                        min-height: 48px;
                      "
                      onmouseover="this.style.background='var(--gray-700)'"
                      onmouseout="this.style.background='var(--gray-900)'"
                    >
                      SAVE CHANGES
                    </button>

                    <!-- Save Status Indicator -->
                    <div
                      id="edit-save-status-${item.id}"
                      style="
                        margin-top: 10px;
                        font-size: 12px;
                        text-align: center;
                        min-height: 18px;
                        font-weight: 600;
                        opacity: 0;
                        transition: opacity 0.2s;
                      "
                    ></div>
                  </div>
                </div>
              </div>
            `;
            }).join('')}
          </div>
        </div>
      `;
    });

    container.innerHTML = html;

    // FEATURE 1: Update progress bar after rendering
    updatePrepCountProgressBar();

    // FEATURE 2: Apply hide counted items filter if enabled
    applyHideCountedFilter();

    // FEATURE 4: Restore collapsed state from localStorage
    restoreCollapsedSections();
  }

  /**
   * FEATURE 1: Update Progress Bar
   *
   * CRITICAL FIX (Jan 11, 2026): Time-based reset logic
   * - Progress bar only counts items as "counted" if counted within last 12 hours
   * - This ensures progress bar shows 0% at start of new counting session
   * - Input fields still show last known counts (for reference)
   * - Covers nightly counting cycle (~10pm) with 12-hour window
   */
  function updatePrepCountProgressBar() {
    const prepItems = orderingSystemState.items.filter(item =>
      item.vendor === 'PREP' || item.itemType === 'prep'
    );

    const totalItems = prepItems.length;

    // TIME-BASED RESET LOGIC
    // Only count as "counted" if within last 12 hours
    const now = new Date();
    const cutoffHours = 12; // 12-hour window to cover nightly counting cycle
    const cutoffTime = new Date(now.getTime() - (cutoffHours * 60 * 60 * 1000));

    const countedItems = prepItems.filter(item => {
      // Must have countedBy and countedAt fields
      if (!item.countedBy || !item.countedAt) return false;

      // Parse countedAt timestamp (ISO 8601 format)
      const countedDate = new Date(item.countedAt);

      // Only count if within cutoff window (last 12 hours)
      return countedDate > cutoffTime;
    }).length;

    const remainingItems = totalItems - countedItems;
    const percentage = totalItems > 0 ? Math.round((countedItems / totalItems) * 100) : 0;

    // Count low stock items (< 30% of par)
    const lowStockItems = prepItems.filter(item => {
      const parLevel = item.parLevel || 0;
      if (parLevel === 0) return false;
      const stockPercentage = (item.currentStock / parLevel) * 100;
      return stockPercentage < 30;
    }).length;

    // Update progress bar UI
    const progressText = document.getElementById('prepProgressText');
    const progressBar = document.getElementById('prepProgressBar');
    const countedCount = document.getElementById('prepCountedCount');
    const remainingCount = document.getElementById('prepRemainingCount');
    const lowStockCount = document.getElementById('prepLowStockCount');

    if (progressText) {
      progressText.textContent = `${countedItems} / ${totalItems} items counted (${percentage}%)`;
    }

    if (progressBar) {
      progressBar.style.width = `${percentage}%`;
    }

    if (countedCount) countedCount.textContent = countedItems;
    if (remainingCount) remainingCount.textContent = remainingItems;
    if (lowStockCount) lowStockCount.textContent = lowStockItems;
  }

  /**
   * FEATURE 2: Toggle Hide Counted Items
   */
  function toggleHideCountedItems() {
    const checkbox = document.getElementById('hideCountedItemsToggle');
    const isChecked = checkbox ? checkbox.checked : false;

    // Save to localStorage
    localStorage.setItem('prepHideCountedItems', isChecked);

    // Apply filter
    applyHideCountedFilter();
  }

  function applyHideCountedFilter() {
    const isHidden = localStorage.getItem('prepHideCountedItems') === 'true';
    const checkbox = document.getElementById('hideCountedItemsToggle');

    if (checkbox) {
      checkbox.checked = isHidden;
    }

    // Hide/show counted items
    const countedItems = document.querySelectorAll('.prep-item-card.counted-item');
    countedItems.forEach(item => {
      item.style.display = isHidden ? 'none' : '';
    });
  }

  /**
   * FEATURE 3: Quick-Fill Stock Buttons
   */
  async function quickFillStock(itemId, action) {
    const item = orderingSystemState.items.find(i => i.id === itemId);
    if (!item) return;

    let newValue = 0;

    switch (action) {
      case 'full':
        newValue = item.parLevel || 0;
        break;
      case 'half':
        newValue = Math.round((item.parLevel || 0) / 2 * 4) / 4; // Round to nearest 0.25
        break;
      case 'empty':
        newValue = 0;
        break;
      case 'skip':
        // Mark as skipped - we'll set count to current but mark as counted
        newValue = item.currentStock || 0;
        break;
    }

    // Update the input field
    const stockInput = document.getElementById(`stock-${itemId}`);
    if (stockInput) {
      stockInput.value = newValue;

      // Trigger save
      await autoSaveStockCount(itemId, newValue, stockInput);

      // Visual feedback
      if (action === 'skip') {
        stockInput.style.background = '#fafafa';
        stockInput.style.borderColor = '#999';
      }
    }
  }

  /**
   * FEATURE 4: Collapsible Location Sections
   */
  function toggleLocationSection(locationName) {
    const safeLocation = locationName.replace(/\s/g, '_');
    const itemsContainer = document.getElementById(`location-items-${safeLocation}`);
    const arrow = document.getElementById(`location-arrow-${safeLocation}`);

    if (!itemsContainer || !arrow) return;

    const isCollapsed = itemsContainer.style.display === 'none';

    if (isCollapsed) {
      // Expand
      itemsContainer.style.display = 'flex';
      arrow.style.transform = 'rotate(0deg)';
      arrow.textContent = '‚ñº';
    } else {
      // Collapse
      itemsContainer.style.display = 'none';
      arrow.style.transform = 'rotate(-90deg)';
      arrow.textContent = '‚ñ∂';
    }

    // Save EXPANDED state to localStorage (sections are collapsed by default)
    const expandedSections = JSON.parse(localStorage.getItem('prepExpandedSections') || '{}');
    expandedSections[locationName] = !isCollapsed; // true if expanding, false if collapsing
    localStorage.setItem('prepExpandedSections', JSON.stringify(expandedSections));
  }

  function restoreCollapsedSections() {
    // Sections are collapsed by default
    // This function restores EXPANDED sections from localStorage
    const expandedSections = JSON.parse(localStorage.getItem('prepExpandedSections') || '{}');

    Object.keys(expandedSections).forEach(locationName => {
      if (expandedSections[locationName]) {
        const safeLocation = locationName.replace(/\s/g, '_');
        const itemsContainer = document.getElementById(`location-items-${safeLocation}`);
        const arrow = document.getElementById(`location-arrow-${safeLocation}`);

        if (itemsContainer && arrow) {
          itemsContainer.style.display = 'flex';
          arrow.style.transform = 'rotate(0deg)';
          arrow.textContent = '‚ñº';
        }
      }
    });
  }

  /**
   * Toggle PAR Level Editor for individual item
   * Collapsed by default - user clicks "EDIT PAR" to expand
   */
  function toggleParEditor(itemId) {
    const editorSection = document.getElementById(`par-editor-${itemId}`);
    const arrow = document.getElementById(`par-editor-arrow-${itemId}`);

    if (!editorSection || !arrow) return;

    const isCollapsed = editorSection.style.display === 'none';

    if (isCollapsed) {
      // Expand
      editorSection.style.display = 'block';
      arrow.style.transform = 'rotate(90deg)';
      arrow.textContent = '‚ñº';
    } else {
      // Collapse
      editorSection.style.display = 'none';
      arrow.style.transform = 'rotate(0deg)';
      arrow.textContent = '‚ñ∂';
    }
  }

  /**
   * Toggle unified item editor section
   */
  function toggleItemEditor(itemId) {
    console.log('‚úÖ toggleItemEditor called with itemId:', itemId, 'type:', typeof itemId);

    const editorDiv = document.getElementById(`item-editor-${itemId}`);
    const arrow = document.getElementById(`edit-arrow-${itemId}`);

    console.log('üì¶ editorDiv element:', editorDiv);
    console.log('‚û°Ô∏è  arrow element:', arrow);

    if (!editorDiv) {
      console.error('‚ùå Editor div not found! Looking for ID:', `item-editor-${itemId}`);
      console.log('üîç Checking if element exists in DOM...');
      const allEditors = document.querySelectorAll('[id^="item-editor-"]');
      console.log('üìã Found editor elements:', allEditors.length, Array.from(allEditors).map(e => e.id));
      return;
    }

    if (!arrow) {
      console.error('‚ùå Arrow element not found! Looking for ID:', `edit-arrow-${itemId}`);
      console.log('üîç Checking if arrow exists in DOM...');
      const allArrows = document.querySelectorAll('[id^="edit-arrow-"]');
      console.log('üìã Found arrow elements:', allArrows.length, Array.from(allArrows).map(e => e.id));
      return;
    }

    const currentDisplay = window.getComputedStyle(editorDiv).display;
    const inlineDisplay = editorDiv.style.display;
    console.log('üìä Display values - computed:', currentDisplay, 'inline:', inlineDisplay);

    // Check if collapsed (display is 'none' or empty string)
    const isCollapsed = currentDisplay === 'none' || inlineDisplay === 'none' || inlineDisplay === '';

    if (isCollapsed) {
      // Expand
      console.log('‚¨áÔ∏è EXPANDING editor section');
      editorDiv.style.display = 'block';
      arrow.style.transform = 'rotate(90deg)';
      arrow.textContent = '‚ñº';
      console.log('‚úÖ Editor expanded successfully');
    } else {
      // Collapse
      console.log('‚¨ÜÔ∏è COLLAPSING editor section');
      editorDiv.style.display = 'none';
      arrow.style.transform = 'rotate(0deg)';
      arrow.textContent = '‚ñ∂';
      console.log('‚úÖ Editor collapsed successfully');
    }
  }

  // Expose function to window scope for debugging
  window.toggleItemEditor = toggleItemEditor;

  /**
   * Adjust PAR level in edit section (+ / - buttons)
   */
  function adjustEditPar(itemId, adjustment) {
    const inputElement = document.getElementById(`edit-par-${itemId}`);
    if (!inputElement) return;

    const currentValue = parseFloat(inputElement.value) || 0;
    const newValue = Math.max(0, currentValue + adjustment); // Don't go below 0

    // Round to 2 decimal places to avoid floating point errors
    const roundedValue = Math.round(newValue * 100) / 100;

    inputElement.value = roundedValue;
  }

  /**
   * Save all item edits from unified EDIT section
   */
  async function saveItemEdits(itemId) {
    const item = orderingSystemState.items.find(i => i.id === itemId);
    if (!item) {
      console.error('Item not found:', itemId);
      return;
    }

    const statusDiv = document.getElementById(`edit-save-status-${itemId}`);

    // Show saving status
    if (statusDiv) {
      statusDiv.textContent = 'üíæ Saving...';
      statusDiv.style.color = '#ff9800';
      statusDiv.style.opacity = '1';
    }

    try {
      // Collect all edited values
      const itemName = document.getElementById(`edit-name-${itemId}`)?.value?.trim();
      const parLevel = parseFloat(document.getElementById(`edit-par-${itemId}`)?.value);
      const unit = document.getElementById(`edit-unit-${itemId}`)?.value;
      const vendor = document.getElementById(`edit-vendor-${itemId}`)?.value;
      const storageLocation = document.getElementById(`edit-location-${itemId}`)?.value;
      const batchLifespan = document.getElementById(`edit-lifespan-${itemId}`)?.value;
      const urgent = document.getElementById(`edit-urgent-${itemId}`)?.checked;
      const lineCooksPrep = document.getElementById(`edit-line-cooks-prep-${itemId}`)?.checked;
      const notMadeDaily = document.getElementById(`edit-not-made-daily-${itemId}`)?.checked;
      const showInBottleCount = document.getElementById(`edit-bottle-count-${itemId}`)?.checked;

      // Build update object
      const updates = {
        item_name: itemName,
        par_level: parLevel,
        unit: unit,
        vendor: vendor,
        storage_location: storageLocation,
        urgent: urgent,
        line_cooks_prep: lineCooksPrep,
        not_made_daily: notMadeDaily,
        show_in_bottle_count: showInBottleCount
      };

      // Add batch lifespan if it exists (PREP items only)
      if (batchLifespan !== undefined && batchLifespan !== null && batchLifespan !== '') {
        updates.batch_lifespan_hours = parseInt(batchLifespan) || null;
      }

      // Validate required fields
      if (!itemName || itemName.length === 0) {
        throw new Error('Item name cannot be empty');
      }
      if (isNaN(parLevel) || parLevel < 0) {
        throw new Error('PAR level must be a valid number >= 0');
      }

      // Save to Supabase
      const { data, error } = await supabase
        .from('inventory_items')
        .update(updates)
        .eq('id', itemId);

      if (error) throw error;

      // Update local state
      item.itemName = itemName;
      item.parLevel = parLevel;
      item.unit = unit;
      item.vendor = vendor;
      item.storageLocation = storageLocation;
      item.urgent = urgent;
      item.lineCooksPrep = lineCooksPrep;
      item.notMadeDaily = notMadeDaily;
      item.showInBottleCount = showInBottleCount;
      if (updates.batch_lifespan_hours !== undefined) {
        item.batchLifespan = updates.batch_lifespan_hours;
      }

      // Success feedback
      if (statusDiv) {
        statusDiv.textContent = '‚úì Item updated successfully!';
        statusDiv.style.color = '#4caf50';
      }

      // Re-render prep list to show updated values
      setTimeout(() => {
        renderPrepCountList();

        // Show success message
        showMessage('‚úì Item updated successfully!', 'success');

        // Hide status after delay
        setTimeout(() => {
          if (statusDiv) statusDiv.style.opacity = '0';
        }, 2000);
      }, 500);

    } catch (error) {
      console.error('Error saving item edits:', error);

      // Error feedback
      if (statusDiv) {
        statusDiv.textContent = `‚úó Error: ${error.message}`;
        statusDiv.style.color = '#d32f2f';

        setTimeout(() => {
          statusDiv.style.opacity = '0';
        }, 3000);
      }

      showMessage(`Failed to save changes: ${error.message}`, 'error');
    }
  }

  /**
   * FEATURE 5: Voice Input Mode
   */
  window.voiceModeActive = false;
  window.voiceRecognition = null;

  function toggleVoiceMode() {
    if (!window.voiceModeActive) {
      startVoiceMode();
    } else {
      stopVoiceMode();
    }
  }

  function startVoiceMode() {
    // Check for browser support
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

    if (!SpeechRecognition) {
      showMessage('‚ùå Voice mode not supported in this browser. Please use Chrome or Edge.', 'error');
      return;
    }

    window.voiceRecognition = new SpeechRecognition();
    window.voiceRecognition.continuous = true;
    window.voiceRecognition.interimResults = false;
    window.voiceRecognition.lang = 'en-US';

    window.voiceRecognition.onstart = () => {
      window.voiceModeActive = true;
      const button = document.getElementById('voiceModeButton');
      const icon = document.getElementById('voiceModeIcon');
      const text = document.getElementById('voiceModeText');

      if (button) button.style.background = '#d32f2f';
      if (icon) icon.textContent = 'üî¥';
      if (text) text.textContent = 'LISTENING...';

      showMessage('üéôÔ∏è Voice mode active! Say: "[number] [item name]"', 'success');
    };

    window.voiceRecognition.onresult = (event) => {
      const result = event.results[event.results.length - 1];
      if (result.isFinal) {
        const transcript = result[0].transcript.trim().toLowerCase();
        processVoiceCommand(transcript);
      }
    };

    window.voiceRecognition.onerror = (event) => {
      console.error('Voice recognition error:', event.error);
      showMessage(`‚ùå Voice error: ${event.error}`, 'error');
    };

    window.voiceRecognition.onend = () => {
      // Restart if still in voice mode
      if (window.voiceModeActive) {
        window.voiceRecognition.start();
      }
    };

    window.voiceRecognition.start();
  }

  function stopVoiceMode() {
    window.voiceModeActive = false;

    if (window.voiceRecognition) {
      window.voiceRecognition.stop();
      window.voiceRecognition = null;
    }

    const button = document.getElementById('voiceModeButton');
    const icon = document.getElementById('voiceModeIcon');
    const text = document.getElementById('voiceModeText');

    if (button) button.style.background = '#9c27b0';
    if (icon) icon.textContent = 'üéôÔ∏è';
    if (text) text.textContent = 'VOICE MODE';
  }

  function processVoiceCommand(transcript) {
    // Parse: "[number] [unit?] [item name]"
    // Examples: "twelve containers tzatziki", "5 gyro meat", "three hummus"

    const words = transcript.split(' ');
    if (words.length < 2) {
      showMessage('‚ùå Could not understand. Say: "[number] [item name]"', 'error');
      return;
    }

    // Extract number (first word)
    const numberWord = words[0];
    let count = parseNumberWord(numberWord);

    if (isNaN(count)) {
      // Try parsing as digit
      count = parseFloat(numberWord);
      if (isNaN(count)) {
        showMessage('‚ùå Could not understand number. Try again.', 'error');
        return;
      }
    }

    // Extract item name (remaining words, skip "containers", "boxes", etc.)
    const skipWords = ['containers', 'container', 'boxes', 'box', 'bags', 'bag', 'of'];
    const itemWords = words.slice(1).filter(word => !skipWords.includes(word));
    const itemName = itemWords.join(' ');

    // Fuzzy match item name
    const prepItems = orderingSystemState.items.filter(item => item.vendor === 'PREP' || item.itemType === 'prep');
    const matchedItem = fuzzyMatchItem(itemName, prepItems);

    if (!matchedItem) {
      showMessage(`‚ùå Could not find item: "${itemName}"`, 'error');
      return;
    }

    // Update count
    const stockInput = document.getElementById(`stock-${matchedItem.id}`);
    if (stockInput) {
      stockInput.value = count;
      autoSaveStockCount(matchedItem.id, count, stockInput);

      // Success feedback
      showMessage(`‚úì ${matchedItem.itemName}: ${count} ${matchedItem.unit}`, 'success');

      // Auto-advance to next uncounted item (optional)
      // scrollToNextUncountedItem();
    }
  }

  function parseNumberWord(word) {
    const numberMap = {
      'zero': 0, 'one': 1, 'two': 2, 'three': 3, 'four': 4, 'five': 5,
      'six': 6, 'seven': 7, 'eight': 8, 'nine': 9, 'ten': 10,
      'eleven': 11, 'twelve': 12, 'thirteen': 13, 'fourteen': 14, 'fifteen': 15,
      'sixteen': 16, 'seventeen': 17, 'eighteen': 18, 'nineteen': 19, 'twenty': 20
    };

    return numberMap[word] || NaN;
  }

  function fuzzyMatchItem(searchTerm, items) {
    searchTerm = searchTerm.toLowerCase();

    // Exact match first
    let match = items.find(item => item.itemName.toLowerCase() === searchTerm);
    if (match) return match;

    // Contains match
    match = items.find(item => item.itemName.toLowerCase().includes(searchTerm));
    if (match) return match;

    // Word match (any word in item name matches search term)
    match = items.find(item => {
      const itemWords = item.itemName.toLowerCase().split(' ');
      return itemWords.some(word => word.includes(searchTerm) || searchTerm.includes(word));
    });

    return match || null;
  }

  /**
   * FEATURE 7: Copy Yesterday's Counts
   */
  async function copyYesterdayCounts() {
    const yesterday = new Date();
    yesterday.setDate(yesterday.getDate() - 1);
    const yesterdayDate = yesterday.toISOString().split('T')[0];

    showLoading('Loading Yesterday\'s Counts', 'Fetching data...');

    try {
      const prepItems = orderingSystemState.items.filter(item => item.vendor === 'PREP' || item.itemType === 'prep');
      const itemIds = prepItems.map(item => item.id);

      const { data, error } = await supabase
        .from('prep_count_log')
        .select('item_id, new_count, counted_at')
        .in('item_id', itemIds)
        .gte('counted_at', yesterdayDate)
        .order('counted_at', { ascending: false });

      if (error) throw error;

      // Group by item_id and take most recent
      const yesterdayCounts = {};
      data.forEach(log => {
        if (!yesterdayCounts[log.item_id]) {
          yesterdayCounts[log.item_id] = log.new_count;
        }
      });

      let prefilled = 0;

      // Prefill inputs (don't auto-save)
      prepItems.forEach(item => {
        const yesterdayCount = yesterdayCounts[item.id];
        if (yesterdayCount !== undefined) {
          const stockInput = document.getElementById(`stock-${item.id}`);
          if (stockInput) {
            stockInput.value = yesterdayCount;
            stockInput.style.background = '#e3f2fd';
            stockInput.style.borderColor = '#2196f3';
            prefilled++;
          }
        }
      });

      hideLoading();
      showMessage(`‚úÖ Prefilled ${prefilled} items from ${yesterday.toLocaleDateString()}. Review and adjust before counting completes.`, 'success');

    } catch (error) {
      hideLoading();
      showMessage(`‚ùå Error loading yesterday's counts: ${error.message}`, 'error');
    }
  }

  /**
   * FEATURE 8: Bulk Actions
   */
  function updateBulkSelectionCount() {
    const checkboxes = document.querySelectorAll('.bulk-select-checkbox:checked');
    const count = checkboxes.length;

    const bulkBar = document.getElementById('bulkActionsBar');
    const countDisplay = document.getElementById('bulkSelectedCount');

    if (bulkBar) {
      bulkBar.style.display = count > 0 ? 'block' : 'none';
    }

    if (countDisplay) {
      countDisplay.textContent = count;
    }
  }

  function clearBulkSelection() {
    const checkboxes = document.querySelectorAll('.bulk-select-checkbox');
    checkboxes.forEach(cb => cb.checked = false);
    updateBulkSelectionCount();
  }

  async function bulkMarkAs(action) {
    const checkboxes = document.querySelectorAll('.bulk-select-checkbox:checked');
    const itemIds = Array.from(checkboxes).map(cb => parseInt(cb.dataset.itemId));

    if (itemIds.length === 0) return;

    showLoading('Bulk Action', `Updating ${itemIds.length} items...`);

    try {
      for (const itemId of itemIds) {
        const item = orderingSystemState.items.find(i => i.id === itemId);
        if (!item) continue;

        let newValue = 0;

        switch (action) {
          case 'full':
            newValue = item.parLevel || 0;
            break;
          case 'empty':
            newValue = 0;
            break;
        }

        const stockInput = document.getElementById(`stock-${itemId}`);
        if (stockInput) {
          stockInput.value = newValue;
          await autoSaveStockCount(itemId, newValue, stockInput);
        }
      }

      hideLoading();
      clearBulkSelection();
      showMessage(`‚úÖ Updated ${itemIds.length} items!`, 'success');

    } catch (error) {
      hideLoading();
      showMessage(`‚ùå Error: ${error.message}`, 'error');
    }
  }

  async function bulkCopyYesterday() {
    const checkboxes = document.querySelectorAll('.bulk-select-checkbox:checked');
    const itemIds = Array.from(checkboxes).map(cb => parseInt(cb.dataset.itemId));

    if (itemIds.length === 0) return;

    const yesterday = new Date();
    yesterday.setDate(yesterday.getDate() - 1);
    const yesterdayDate = yesterday.toISOString().split('T')[0];

    showLoading('Bulk Copy', `Loading ${itemIds.length} items from yesterday...`);

    try {
      const { data, error } = await supabase
        .from('prep_count_log')
        .select('item_id, new_count, counted_at')
        .in('item_id', itemIds)
        .gte('counted_at', yesterdayDate)
        .order('counted_at', { ascending: false });

      if (error) throw error;

      const yesterdayCounts = {};
      data.forEach(log => {
        if (!yesterdayCounts[log.item_id]) {
          yesterdayCounts[log.item_id] = log.new_count;
        }
      });

      let prefilled = 0;

      itemIds.forEach(itemId => {
        const yesterdayCount = yesterdayCounts[itemId];
        if (yesterdayCount !== undefined) {
          const stockInput = document.getElementById(`stock-${itemId}`);
          if (stockInput) {
            stockInput.value = yesterdayCount;
            stockInput.style.background = '#e3f2fd';
            stockInput.style.borderColor = '#2196f3';
            prefilled++;
          }
        }
      });

      hideLoading();
      clearBulkSelection();
      showMessage(`‚úÖ Prefilled ${prefilled} selected items from yesterday!`, 'success');

    } catch (error) {
      hideLoading();
      showMessage(`‚ùå Error: ${error.message}`, 'error');
    }
  }

  /**
   * Filter inventory list based on search and vendor
   */
  function filterInventoryList() {
    const searchTerm = document.getElementById('inventorySearchInput').value.toLowerCase();
    const selectedVendor = document.getElementById('inventoryVendorFilter').value;

    // Filter items
    const filteredItems = orderingSystemState.items.filter(item => {
      const matchesSearch = item.itemName.toLowerCase().includes(searchTerm);
      const matchesVendor = !selectedVendor || item.vendor === selectedVendor;
      return matchesSearch && matchesVendor;
    });

    // Re-render with filtered items
    renderFilteredInventoryList(filteredItems);
  }

  /**
   * Render filtered inventory list (SAME CLEAN FORMAT AS UNFILTERED)
   */
  function renderFilteredInventoryList(filteredItems) {
    const container = document.getElementById('inventoryList');

    if (filteredItems.length === 0) {
      container.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--gray-500);">No items match your search.</p>';
      return;
    }

    // Group by vendor
    const itemsByVendor = {};
    filteredItems.forEach(item => {
      if (!itemsByVendor[item.vendor]) {
        itemsByVendor[item.vendor] = [];
      }
      itemsByVendor[item.vendor].push(item);
    });

    let html = '';
    sortVendorsWithPrepFirst(Object.keys(itemsByVendor)).forEach(vendor => {
      const items = itemsByVendor[vendor];
      const isPrepCategory = vendor === 'PREP';
      const headerColor = isPrepCategory ? '#212121' : 'var(--gray-700)';

      html += `
        <div style="margin-bottom: 24px;">
          <h4 style="background: ${headerColor}; color: white; padding: 12px 16px; border-radius: 0; margin-bottom: 0; font-size: 14px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;">
            ${vendor} <span style="opacity: 0.7; font-weight: 400; font-size: 12px;">(${items.length})</span>
          </h4>
          <div style="background: white; border: 2px solid var(--gray-300); border-top: none;">
            ${items.map((item, i) => `
              <div
                style="
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  padding: 12px 16px;
                  border-bottom: 1px solid var(--gray-200);
                  transition: background 0.2s;
                  background: ${i % 2 === 0 ? 'white' : '#f9fafb'};
                "
                onmouseover="this.style.background='#f3f4f6'"
                onmouseout="this.style.background='${i % 2 === 0 ? 'white' : '#f9fafb'}'"
              >
                <div style="flex: 1; font-size: 14px; font-weight: 600; color: var(--gray-900);">
                  ${item.itemName}
                </div>
                <button
                  onclick="openEditItemModal(${item.id}); return false;"
                  style="
                    background: var(--gray-100);
                    border: 2px solid var(--gray-300);
                    border-radius: 4px;
                    padding: 8px 12px;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    gap: 6px;
                    color: var(--gray-700);
                    font-size: 12px;
                    font-weight: 700;
                    text-transform: uppercase;
                    letter-spacing: 0.5px;
                    transition: all 0.2s;
                  "
                  onmouseover="this.style.background='var(--gray-700)'; this.style.color='var(--white)'; this.style.borderColor='var(--gray-700)';"
                  onmouseout="this.style.background='var(--gray-100)'; this.style.color='var(--gray-700)'; this.style.borderColor='var(--gray-300)';"
                >
                  <span style="font-size: 16px;">‚úèÔ∏è</span>
                  <span>Edit</span>
                </button>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    });

    container.innerHTML = html;
  }

  /**
   * Filter stock count list based on search and vendor
   */
  function filterStockCountList() {
    const searchTerm = document.getElementById('stockCountSearchInput').value.toLowerCase();
    const selectedVendor = document.getElementById('stockCountVendorFilter').value;

    // Filter items
    const filteredItems = orderingSystemState.items.filter(item => {
      const matchesSearch = item.itemName.toLowerCase().includes(searchTerm);
      const matchesVendor = !selectedVendor || item.vendor === selectedVendor;
      return matchesSearch && matchesVendor;
    });

    // Re-render with filtered items
    renderFilteredStockCountList(filteredItems);
  }

  /**
   * Render filtered stock count list
   */
  function renderFilteredStockCountList(filteredItems) {
    const container = document.getElementById('stockCountList');

    if (filteredItems.length === 0) {
      container.innerHTML = '<p style="text-align: center; padding: 20px; color: #999;">No items match your search.</p>';
      return;
    }

    // Helper function to get stock status
    function getStockStatus(currentStock, parLevel) {
      if (parLevel === 0) return { label: 'N/A', color: 'var(--gray-600)', bg: 'var(--gray-100)' };
      const percentage = (currentStock / parLevel) * 100;
      if (percentage < 30) return { label: 'LOW', color: '#d32f2f', bg: '#ffebee' }; // Keep red for warnings
      if (percentage < 70) return { label: 'MEDIUM', color: 'var(--gray-700)', bg: 'var(--gray-200)' };
      return { label: 'GOOD', color: '#2e7d32', bg: '#e8f5e9' }; // Keep green for success
    }

    // Helper function to format last counted date
    function formatLastCounted(dateStr) {
      if (!dateStr) return 'Never';
      const date = new Date(dateStr);
      const now = new Date();
      const diffMs = now - date;
      const diffMinutes = Math.floor(diffMs / (1000 * 60));
      const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
      const diffDays = Math.floor(diffHours / 24);

      // Less than 1 hour: show minutes
      if (diffMinutes < 60) {
        return `${diffMinutes} minute${diffMinutes === 1 ? '' : 's'} ago`;
      }
      
      // Less than 24 hours: show hours and minutes
      if (diffHours < 24) {
        const remainingMinutes = diffMinutes % 60;
        if (remainingMinutes === 0) {
          return `${diffHours} hour${diffHours === 1 ? '' : 's'} ago`;
        }
        return `${diffHours} hour${diffHours === 1 ? '' : 's'} and ${remainingMinutes} minute${remainingMinutes === 1 ? '' : 's'} ago`;
      }
      
      // Less than 7 days: show days, hours, and minutes
      if (diffDays < 7) {
        const remainingHours = diffHours % 24;
        const remainingMinutes = diffMinutes % 60;
        let result = `${diffDays} day${diffDays === 1 ? '' : 's'}`;
        if (remainingHours > 0) {
          result += `, ${remainingHours} hour${remainingHours === 1 ? '' : 's'}`;
        }
        if (remainingMinutes > 0) {
          result += `, ${remainingMinutes} minute${remainingMinutes === 1 ? '' : 's'}`;
        }
        return result + ' ago';
      }
      
      // 7+ days: show date
      return date.toLocaleDateString('en-US', { month: 'numeric', day: 'numeric', year: '2-digit' });
    }

    // Group by vendor
    const itemsByVendor = {};
    filteredItems.forEach(item => {
      if (!itemsByVendor[item.vendor]) {
        itemsByVendor[item.vendor] = [];
      }
      itemsByVendor[item.vendor].push(item);
    });

    let html = '';
    sortVendorsWithPrepFirst(Object.keys(itemsByVendor)).forEach(vendor => {
      const items = itemsByVendor[vendor];
      const isPrepCategory = vendor === 'PREP';
      const headerColor = isPrepCategory ? '#212121' : 'var(--gray-700)'; // Grayscale throughout
      html += `
        <div style="margin-bottom: 30px;">
          <h4 style="background: ${headerColor}; color: white; padding: 12px 16px; border-radius: 0; margin-bottom: 12px; font-size: 14px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;">
            ${vendor} <span style="opacity: 0.7; font-weight: 400; font-size: 12px;">(${items.length})</span>
          </h4>

          <!-- Single column layout for all screens -->
          <div style="display: flex; flex-direction: column; gap: ${isCompactMode ? '8px' : '10px'};">
            ${items.map((item) => {
              const status = getStockStatus(item.currentStock, item.parLevel);
              const lastCounted = formatLastCounted(item.lastCountedDate);

              return `
                <div style="
                  background: white;
                  border: 1px solid #e0e0e0;
                  border-radius: ${isCompactMode ? '6px' : '8px'};
                  padding: ${isCompactMode ? '10px' : '14px'};
                  box-shadow: 0 1px 3px rgba(0,0,0,0.08);
                  transition: box-shadow 0.2s;
                "
                onmouseover="this.style.boxShadow='0 2px 8px rgba(0,0,0,0.12)'"
                onmouseout="this.style.boxShadow='0 1px 3px rgba(0,0,0,0.08)'">

                  <!-- Header: Item Name + Status Badge -->
                  <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: ${isCompactMode ? '8px' : '12px'}; gap: 8px;">
                    <div style="flex: 1; font-weight: 600; font-size: ${isCompactMode ? '14px' : '15px'}; line-height: 1.3; color: #333;">
                      ${item.itemName}
                    </div>
                    <div style="
                      background: ${status.bg};
                      color: ${status.color};
                      padding: ${isCompactMode ? '3px 8px' : '4px 10px'};
                      border-radius: 12px;
                      font-size: ${isCompactMode ? '10px' : '11px'};
                      font-weight: 700;
                      white-space: nowrap;
                      letter-spacing: 0.3px;
                    ">
                      ${status.label}
                    </div>
                  </div>

                  <!-- Metadata Row -->
                  <div style="
                    display: flex;
                    gap: ${isCompactMode ? '12px' : '16px'};
                    margin-bottom: ${isCompactMode ? '8px' : '12px'};
                    font-size: ${isCompactMode ? '12px' : '13px'};
                    color: #666;
                  ">
                    <div>
                      <span style="color: #999;">Unit:</span> <strong>${item.unit}</strong>
                    </div>
                    <div>
                      <span style="color: #999;">Par:</span> <strong>${item.parLevel}</strong>
                    </div>
                    <div style="margin-left: auto; color: #999; font-size: ${isCompactMode ? '11px' : '12px'};">
                      ${lastCounted}
                    </div>
                  </div>

                  ${item.lastInvoiceQty && item.lastInvoiceDate ? `
                  <!-- Invoice Addition Info -->
                  <div style="
                    margin-top: 8px;
                    margin-bottom: 12px;
                    padding: 8px 10px;
                    background: var(--blue-bg);
                    border-left: 3px solid var(--blue-text);
                    border-radius: 0;
                    font-size: ${isCompactMode ? '11px' : '12px'};
                    color: var(--blue-text);
                    font-weight: 600;
                    font-style: italic;
                  ">
                    ${item.lastInvoiceQty} ADDED VIA INVOICE ON ${formatPacificDateDisplay(new Date(item.lastInvoiceDate), {
                      month: 'short',
                      day: 'numeric',
                      year: 'numeric',
                      hour: 'numeric',
                      minute: '2-digit',
                      hour12: true
                    })}
                  </div>
                  ` : ''}

                  <!-- Stock Input with Quick Adjustments (Mobile-Optimized) -->
                  <div>
                    <label style="display: block; font-size: 12px; color: #666; margin-bottom: 6px; font-weight: 500;">
                      Current Stock
                    </label>
                    <!-- Input with Stepper Buttons -->
                    <div style="display: flex; gap: 5px; align-items: stretch;">
                      <!-- Decrement Button -->
                      <button
                        type="button"
                        onclick="quickAdjustStock(${item.id}, -0.25)"
                        style="
                          flex: 0 0 40px;
                          padding: 0;
                          font-size: 22px;
                          font-weight: 700;
                          background: #f5f5f5;
                          border: 2px solid #e0e0e0;
                          border-radius: 6px;
                          color: #666;
                          cursor: pointer;
                          transition: all 0.2s;
                          min-height: 48px;
                          display: flex;
                          align-items: center;
                          justify-content: center;
                        "
                        onmousedown="this.style.background='#e0e0e0'; this.style.transform='scale(0.95)';"
                        onmouseup="this.style.background='#f5f5f5'; this.style.transform='scale(1)';"
                        onmouseleave="this.style.background='#f5f5f5'; this.style.transform='scale(1)';"
                      >‚àí</button>

                      <!-- Stock Input Field -->
                      <input
                        type="number"
                        inputmode="decimal"
                        id="stock-${item.id}"
                        value="${item.currentStock}"
                        min="0"
                        step="0.25"
                        onblur="autoSaveStockCount(${item.id}, this.value, this)"
                        onchange="autoSaveStockCount(${item.id}, this.value, this)"
                        style="
                          flex: 1;
                          padding: 12px 6px;
                          font-size: 20px;
                          font-weight: 700;
                          text-align: center;
                          border: 2px solid #2e7d32;
                          border-radius: 6px;
                          background: #f9fdf9;
                          color: #2e7d32;
                          box-sizing: border-box;
                          -webkit-appearance: none;
                          -moz-appearance: textfield;
                          min-height: 48px;
                          transition: all 0.2s;
                        "
                        onfocus="this.style.borderColor='#1b5e20'; this.style.background='#ffffff'; this.select();"
                        onblur="this.style.borderColor='#2e7d32'; this.style.background='#f9fdf9';"
                      />

                      <!-- Increment Button -->
                      <button
                        type="button"
                        onclick="quickAdjustStock(${item.id}, 0.25)"
                        style="
                          flex: 0 0 40px;
                          padding: 0;
                          font-size: 22px;
                          font-weight: 700;
                          background: #2e7d32;
                          border: 2px solid #2e7d32;
                          border-radius: 6px;
                          color: white;
                          cursor: pointer;
                          transition: all 0.2s;
                          min-height: 48px;
                          display: flex;
                          align-items: center;
                          justify-content: center;
                        "
                        onmousedown="this.style.background='#1b5e20'; this.style.transform='scale(0.95)';"
                        onmouseup="this.style.background='#2e7d32'; this.style.transform='scale(1)';"
                        onmouseleave="this.style.background='#2e7d32'; this.style.transform='scale(1)';"
                      >+</button>
                    </div>

                    <!-- Save Status Indicator -->
                    <div
                      id="save-status-${item.id}"
                      style="
                        margin-top: 6px;
                        font-size: 11px;
                        text-align: center;
                        min-height: 16px;
                        font-weight: 600;
                        opacity: 0;
                        transition: opacity 0.2s;
                      "
                    ></div>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        </div>
      `;
    });

    container.innerHTML = html;
  }

  /**
   * Update current count session and create/update session record
   */
  /**
   * Automatically detect current count session based on time of day
   * Before 3pm = Morning Prep
   * 3pm-8pm = Afternoon Prep
   * After 8pm = Closing Line
   */
  function getAutomaticCountSession() {
    const now = new Date();
    const hour = getPacificHour(now);
    const effectiveHour = (hour === null || Number.isNaN(hour)) ? now.getHours() : hour;

    if (effectiveHour < 15) { // Before 3pm Pacific
      return {
        value: 'morning_prep',
        name: 'Morning Prep',
        icon: 'üåÖ',
        time: '7:00 AM - 3:00 PM'
      };
    } else if (effectiveHour < 20) { // 3pm-8pm Pacific
      return {
        value: 'afternoon_prep',
        name: 'Afternoon Prep',
        icon: '‚òÄÔ∏è',
        time: '3:00 PM - 8:00 PM'
      };
    } else { // After 8pm
      return {
        value: 'closing_line',
        name: 'Closing Line',
        icon: 'üåô',
        time: 'After 8:00 PM'
      };
    }
  }

  /**
   * Update count session display and fetch completion stats
   */
  async function updateCountSessionDisplay() {
    const session = getAutomaticCountSession();

    // Update current session display
    document.getElementById('currentSessionIcon').textContent = session.icon;
    document.getElementById('currentSessionName').textContent = session.name;
    document.getElementById('currentSessionTime').textContent = session.time;

    // Update orderingSystemState
    orderingSystemState.currentCountSession = session.value;

    // Fetch and display completion stats
    await fetchAndDisplaySessionStats(session.value);

    // Update session record in database
    const today = getPacificDate();
    try {
      await supabase
        .from('prep_count_sessions')
        .upsert({
          count_date: today,
          session_type: session.value,
          session_timestamp: new Date().toISOString(),
          notes: 'Auto-detected session'
        }, {
          onConflict: 'count_date,session_type'
        });
    } catch (error) {
      console.error('Failed to update session record:', error);
    }
  }

  /**
   * Fetch and display completion stats for previous count sessions
   */
  async function fetchAndDisplaySessionStats(currentSession) {
    const today = getPacificDate();
    const yesterday = formatPacificDate(addPacificDays(getPacificMidday(new Date()), -1));
    const statsContainer = document.getElementById('sessionCompletionStats');

    try {
      // Fetch PREP items with their names and stock levels for detail view
      const { data: prepItems, error } = await supabase
        .from('inventory_items')
        .select('id, item_name, last_counted_date, current_stock, item_type, vendor')
        .or('item_type.eq.prep,vendor.eq.PREP');

      if (error) throw error;

      // Group items by session (with full details for expandable view)
      const yesterdayClosingItems = prepItems.filter(item => {
        if (!item.last_counted_date) return false;
        const lastCounted = new Date(item.last_counted_date);
        const countDate = formatPacificDate(lastCounted);
        const hour = getPacificHour(lastCounted);
        return countDate === yesterday && hour !== null && hour >= 20; // Yesterday after 8pm
      });

      const morningItems = prepItems.filter(item => {
        if (!item.last_counted_date) return false;
        const lastCounted = new Date(item.last_counted_date);
        const isToday = formatPacificDate(lastCounted) === today;
        const hour = getPacificHour(lastCounted);
        return isToday && hour !== null && hour < 15; // Before 3pm Pacific
      });

      const afternoonItems = prepItems.filter(item => {
        if (!item.last_counted_date) return false;
        const lastCounted = new Date(item.last_counted_date);
        const isToday = formatPacificDate(lastCounted) === today;
        const hour = getPacificHour(lastCounted);
        return isToday && hour !== null && hour >= 15 && hour < 20; // 3pm-8pm Pacific
      });

      const closingItems = prepItems.filter(item => {
        if (!item.last_counted_date) return false;
        const lastCounted = new Date(item.last_counted_date);
        const isToday = formatPacificDate(lastCounted) === today;
        const hour = getPacificHour(lastCounted);
        return isToday && hour !== null && hour >= 20; // After 8pm Pacific
      });

      // Build status message based on current session
      let statusHTML = '';

      if (currentSession === 'morning_prep') {
        // Morning: Show yesterday's closing line count
        if (yesterdayClosingItems.length > 0) {
          statusHTML = `
            <div style="cursor: pointer; padding: 8px; background: var(--white); border: 1px solid var(--gray-300); border-radius: 4px; margin-bottom: 4px;" onclick="toggleSessionDetails('yesterday-closing')">
              <strong>${yesterdayClosingItems.length}</strong> prep items counted during Yesterday's Closing Line
              <span id="toggle-yesterday-closing" style="float: right; font-size: 10px;">‚ñº Show Details</span>
            </div>
            <div id="details-yesterday-closing" style="display: none; padding: 12px; background: var(--gray-50); border: 1px solid var(--gray-200); margin-top: 4px; font-size: 11px; max-height: 200px; overflow-y: auto;">
              ${yesterdayClosingItems.map(item => `
                <div style="display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid var(--gray-200);">
                  <span>${item.item_name}</span>
                  <span style="font-weight: 600;">${item.current_stock || 0} ${orderingSystemState.items.find(i => i.id === item.id)?.unit || ''}</span>
                </div>
              `).join('')}
            </div>
          `;
        } else {
          statusHTML = '<div style="color: var(--gray-500); font-style: italic;">No items counted during yesterday\'s Closing Line</div>';
        }
      } else if (currentSession === 'afternoon_prep') {
        // Afternoon: Show morning count
        if (morningItems.length > 0) {
          statusHTML = `
            <div style="cursor: pointer; padding: 8px; background: var(--white); border: 1px solid var(--gray-300); border-radius: 4px; margin-bottom: 4px;" onclick="toggleSessionDetails('morning')">
              <strong>${morningItems.length}</strong> prep items counted during Morning Prep
              <span id="toggle-morning" style="float: right; font-size: 10px;">‚ñº Show Details</span>
            </div>
            <div id="details-morning" style="display: none; padding: 12px; background: var(--gray-50); border: 1px solid var(--gray-200); margin-top: 4px; font-size: 11px; max-height: 200px; overflow-y: auto;">
              ${morningItems.map(item => `
                <div style="display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid var(--gray-200);">
                  <span>${item.item_name}</span>
                  <span style="font-weight: 600;">${item.current_stock || 0} ${orderingSystemState.items.find(i => i.id === item.id)?.unit || ''}</span>
                </div>
              `).join('')}
            </div>
          `;
        } else {
          statusHTML = '<div style="color: var(--gray-500); font-style: italic;">No items counted during Morning Prep</div>';
        }
      } else { // closing_line
        // Closing: Show both morning and afternoon
        const sections = [];
        
        if (morningItems.length > 0) {
          sections.push(`
            <div style="cursor: pointer; padding: 8px; background: var(--white); border: 1px solid var(--gray-300); border-radius: 4px; margin-bottom: 4px;" onclick="toggleSessionDetails('morning-closing')">
              <strong>${morningItems.length}</strong> prep items counted during Morning Prep
              <span id="toggle-morning-closing" style="float: right; font-size: 10px;">‚ñº Show Details</span>
            </div>
            <div id="details-morning-closing" style="display: none; padding: 12px; background: var(--gray-50); border: 1px solid var(--gray-200); margin-top: 4px; margin-bottom: 8px; font-size: 11px; max-height: 200px; overflow-y: auto;">
              ${morningItems.map(item => `
                <div style="display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid var(--gray-200);">
                  <span>${item.item_name}</span>
                  <span style="font-weight: 600;">${item.current_stock || 0} ${orderingSystemState.items.find(i => i.id === item.id)?.unit || ''}</span>
                </div>
              `).join('')}
            </div>
          `);
        }
        
        if (afternoonItems.length > 0) {
          sections.push(`
            <div style="cursor: pointer; padding: 8px; background: var(--white); border: 1px solid var(--gray-300); border-radius: 4px; margin-bottom: 4px;" onclick="toggleSessionDetails('afternoon')">
              <strong>${afternoonItems.length}</strong> prep items counted during Afternoon Prep
              <span id="toggle-afternoon" style="float: right; font-size: 10px;">‚ñº Show Details</span>
            </div>
            <div id="details-afternoon" style="display: none; padding: 12px; background: var(--gray-50); border: 1px solid var(--gray-200); margin-top: 4px; font-size: 11px; max-height: 200px; overflow-y: auto;">
              ${afternoonItems.map(item => `
                <div style="display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid var(--gray-200);">
                  <span>${item.item_name}</span>
                  <span style="font-weight: 600;">${item.current_stock || 0} ${orderingSystemState.items.find(i => i.id === item.id)?.unit || ''}</span>
                </div>
              `).join('')}
            </div>
          `);
        }
        
        if (sections.length === 0) {
          statusHTML = '<div style="color: var(--gray-500); font-style: italic;">No prep counts completed today</div>';
        } else {
          statusHTML = sections.join('');
        }
      }

      statsContainer.innerHTML = statusHTML;

    } catch (error) {
      console.error('Error fetching session stats:', error);
      statsContainer.innerHTML = '<div style="color: var(--gray-500); font-style: italic;">Unable to load count statistics</div>';
    }
  }

  /**
   * Toggle visibility of session detail items
   */
  function toggleSessionDetails(sessionId) {
    const detailsDiv = document.getElementById(`details-${sessionId}`);
    const toggleSpan = document.getElementById(`toggle-${sessionId}`);
    
    if (detailsDiv && toggleSpan) {
      if (detailsDiv.style.display === 'none') {
        detailsDiv.style.display = 'block';
        toggleSpan.textContent = '‚ñ≤ Hide Details';
      } else {
        detailsDiv.style.display = 'none';
        toggleSpan.textContent = '‚ñº Show Details';
      }
    }
  }

  /**
   * Legacy function - kept for compatibility
   */
  async function updateCountSession() {
    // This function is now handled automatically by updateCountSessionDisplay()
    await updateCountSessionDisplay();
  }

  /**
   * Track stock updates before saving (legacy - kept for compatibility)
   */
  function trackStockUpdate(itemId, newValue) {
    orderingSystemState.pendingStockUpdates.set(itemId, parseInt(newValue));
    console.log('Tracked stock update:', itemId, newValue);
  }

  /**
   * Auto-save stock count when input loses focus
   */
  async function autoSaveStockCount(itemId, newValue, inputElement) {
    const stockValue = parseFloat(newValue); // Support decimal counts (0.25, 0.5, 0.75)
    if (isNaN(stockValue)) return;

    // Visual feedback - saving state
    const originalBorder = inputElement.style.borderColor;
    const originalBg = inputElement.style.background;
    const statusDiv = document.getElementById(`save-status-${itemId}`);

    inputElement.style.borderColor = '#ff9800';
    inputElement.style.background = '#fff3e0';
    inputElement.disabled = true;

    // Show "Saving..." status
    if (statusDiv) {
      statusDiv.textContent = 'üíæ Saving...';
      statusDiv.style.color = '#ff9800';
      statusDiv.style.opacity = '1';
    }

    try {
      // Get active prep counter name and timestamp
      const countedBy = getActivePrepCounterName();
      const countedAt = new Date().toISOString();

      // Get item info for logging
      const item = orderingSystemState.items.find(i => i.id === itemId);
      const previousCount = item ? item.currentStock : 0;
      const itemName = item ? item.itemName : 'Unknown Item';

      const { error } = await supabase
        .from('inventory_items')
        .update({
          current_stock: stockValue,
          last_counted_date: countedAt,
          counted_by: countedBy,
          counted_at: countedAt
        })
        .eq('id', itemId);

      if (error) throw error;

      // Log this counting action for leaderboard (don't fail save if log fails)
      try {
        await supabase
          .from('prep_count_log')
          .insert({
            item_id: itemId,
            item_name: itemName,
            counted_by: countedBy,
            counted_at: countedAt,
            new_count: stockValue,
            previous_count: previousCount
          });
      } catch (logError) {
        console.warn('Failed to log prep count action:', logError);
      }

      // Update local state
      if (item) {
        item.currentStock = stockValue;
        item.lastCountedDate = countedAt;
        item.countedBy = countedBy;
        item.countedAt = countedAt;
      }

      // PREP CONSUMPTION TRACKING: Track consumption between sessions
      if (item && item.itemType === 'prep') {
        const currentSession = orderingSystemState.currentCountSession;
        const previousData = orderingSystemState.previousCounts.get(itemId);
        const today = getPacificDate(); // YYYY-MM-DD in Pacific time

        // If we have a previous count from a different session, calculate consumption
        if (previousData && previousData.session !== currentSession) {
          const consumption = previousData.count - stockValue;

          // Only log if there was consumption (or waste if negative)
          if (consumption !== 0) {
            try {
              await supabase
                .from('prep_consumption_log')
                .insert({
                  item_id: itemId,
                  count_date: today,
                  from_session: previousData.session,
                  to_session: currentSession,
                  starting_count: previousData.count,
                  ending_count: stockValue,
                  consumption_amount: consumption > 0 ? consumption : 0,
                  waste_amount: consumption < 0 ? Math.abs(consumption) : 0
                });

              console.log(`Consumption tracked: ${item.itemName} - ${consumption} units from ${previousData.session} to ${currentSession}`);
            } catch (err) {
              console.error('Failed to log consumption:', err);
              // Don't block the save if consumption logging fails
            }
          }
        }

        // Update previous counts with current data
        orderingSystemState.previousCounts.set(itemId, {
          count: stockValue,
          session: currentSession
        });
      }

      // Success feedback - green flash
      inputElement.style.borderColor = '#388e3c';
      inputElement.style.background = '#e8f5e9';

      // Show "Saved!" status
      if (statusDiv) {
        statusDiv.textContent = '‚úì Saved!';
        statusDiv.style.color = '#388e3c';
        statusDiv.style.opacity = '1';
      }

      // Recalculate orders in background
      calculateUpcomingOrders();
      await refreshUpcomingOrdersUI();
      refreshBottleCount(); // Refresh bottle count after stock update

      setTimeout(() => {
        inputElement.style.borderColor = '#2e7d32';
        inputElement.style.background = '#f9fdf9';
        inputElement.disabled = false;

        // Fade out status message
        if (statusDiv) {
          statusDiv.style.opacity = '0';
        }

        // Re-render AFTER visual feedback shows
        renderPrepCountList(); // Re-render to show counted_by name
      }, 800);

    } catch (error) {
      console.error('Auto-save failed:', error);
      // Error feedback - red flash
      inputElement.style.borderColor = '#d32f2f';
      inputElement.style.background = '#ffebee';

      // Show error status
      if (statusDiv) {
        statusDiv.textContent = '‚úó Failed';
        statusDiv.style.color = '#d32f2f';
        statusDiv.style.opacity = '1';
      }

      setTimeout(() => {
        inputElement.style.borderColor = originalBorder;
        inputElement.style.background = originalBg;
        inputElement.disabled = false;

        // Fade out error message
        if (statusDiv) {
          statusDiv.style.opacity = '0';
        }
      }, 1000);

      showMessage(`Failed to save: ${error.message}`, 'error');
    }
  }

  /**
   * Toggle urgent flag for prep item
   */
  async function toggleUrgent(itemId, isUrgent) {
    const checkbox = document.getElementById(`urgent-${itemId}`);
    const label = checkbox?.nextElementSibling;
    const statusDiv = document.getElementById(`save-status-${itemId}`);

    // Visual feedback - saving state
    if (checkbox) checkbox.disabled = true;
    if (label) label.style.opacity = '0.5';

    // Show saving status
    if (statusDiv) {
      statusDiv.textContent = 'üíæ Saving...';
      statusDiv.style.color = '#ff9800';
      statusDiv.style.opacity = '1';
    }

    try {
      const { error } = await supabase
        .from('inventory_items')
        .update({ urgent: isUrgent })
        .eq('id', itemId);

      if (error) throw error;

      // Update local state
      const item = orderingSystemState.items.find(i => i.id === itemId);
      if (item) {
        item.urgent = isUrgent;
      }

      // Success feedback
      if (statusDiv) {
        statusDiv.textContent = '‚úì Saved';
        statusDiv.style.color = '#4caf50';
      }

      setTimeout(() => {
        if (checkbox) checkbox.disabled = false;
        if (label) label.style.opacity = '1';
        if (statusDiv) statusDiv.style.opacity = '0';
      }, 800);

      // Refresh prep sheet to reorder
      refreshPrepSheet();

    } catch (error) {
      console.error('Failed to toggle urgent:', error);

      // Error feedback
      if (statusDiv) {
        statusDiv.textContent = '‚úó Failed';
        statusDiv.style.color = '#d32f2f';
      }

      // Revert checkbox state
      if (checkbox) checkbox.checked = !isUrgent;

      setTimeout(() => {
        if (checkbox) checkbox.disabled = false;
        if (label) label.style.opacity = '1';
        if (statusDiv) statusDiv.style.opacity = '0';
      }, 1000);

      showMessage(`Failed to update urgent status: ${error.message}`, 'error');
    }
  }

  /**
   * Toggle line cooks prep flag for prep item
   */
  async function toggleLineCooksPrep(itemId, isLineCooksPrep) {
    const checkbox = document.getElementById(`line-cooks-prep-${itemId}`);
    const label = checkbox?.nextElementSibling;
    const statusDiv = document.getElementById(`save-status-${itemId}`);

    // Visual feedback - saving state
    if (checkbox) checkbox.disabled = true;
    if (label) label.style.opacity = '0.5';

    // Show saving status
    if (statusDiv) {
      statusDiv.textContent = 'üíæ Saving...';
      statusDiv.style.color = '#ff9800';
      statusDiv.style.opacity = '1';
    }

    try {
      const { error } = await supabase
        .from('inventory_items')
        .update({ line_cooks_prep: isLineCooksPrep })
        .eq('id', itemId);

      if (error) throw error;

      // Update local state
      const item = orderingSystemState.items.find(i => i.id === itemId);
      if (item) {
        item.lineCooksPrep = isLineCooksPrep;
      }

      // Success feedback
      if (statusDiv) {
        statusDiv.textContent = '‚úì Saved';
        statusDiv.style.color = '#4caf50';
      }

      setTimeout(() => {
        if (checkbox) checkbox.disabled = false;
        if (label) label.style.opacity = '1';
        if (statusDiv) statusDiv.style.opacity = '0';
      }, 800);

      // Refresh prep sheet to update categories
      refreshPrepSheet();

    } catch (error) {
      console.error('Failed to toggle line cooks prep:', error);

      // Error feedback
      if (statusDiv) {
        statusDiv.textContent = '‚úó Failed';
        statusDiv.style.color = '#d32f2f';
      }

      // Revert checkbox state
      if (checkbox) checkbox.checked = !isLineCooksPrep;

      setTimeout(() => {
        if (checkbox) checkbox.disabled = false;
        if (label) label.style.opacity = '1';
        if (statusDiv) statusDiv.style.opacity = '0';
      }, 1000);

      showMessage(`Failed to update line cooks prep status: ${error.message}`, 'error');
    }
  }

  /**
   * Toggle not made daily flag for prep item
   */
  async function toggleNotMadeDaily(itemId, isNotMadeDaily) {
    const checkbox = document.getElementById(`not-made-daily-${itemId}`);
    const label = checkbox?.nextElementSibling;
    const statusDiv = document.getElementById(`save-status-${itemId}`);

    // Visual feedback - saving state
    if (checkbox) checkbox.disabled = true;
    if (label) label.style.opacity = '0.5';

    // Show saving status
    if (statusDiv) {
      statusDiv.textContent = 'üíæ Saving...';
      statusDiv.style.color = '#ff9800';
      statusDiv.style.opacity = '1';
    }

    try {
      const { error } = await supabase
        .from('inventory_items')
        .update({ not_made_daily: isNotMadeDaily })
        .eq('id', itemId);

      if (error) throw error;

      // Update local state
      const item = orderingSystemState.items.find(i => i.id === itemId);
      if (item) {
        item.notMadeDaily = isNotMadeDaily;
      }

      // Success feedback
      if (statusDiv) {
        statusDiv.textContent = '‚úì Saved';
        statusDiv.style.color = '#4caf50';
      }

      setTimeout(() => {
        if (checkbox) checkbox.disabled = false;
        if (label) label.style.opacity = '1';
        if (statusDiv) statusDiv.style.opacity = '0';
      }, 800);

      // Refresh prep sheet to update recommendations
      refreshPrepSheet();

    } catch (error) {
      console.error('Failed to toggle not made daily:', error);

      // Error feedback
      if (statusDiv) {
        statusDiv.textContent = '‚úó Failed';
        statusDiv.style.color = '#d32f2f';
      }

      // Revert checkbox state
      if (checkbox) checkbox.checked = !isNotMadeDaily;

      setTimeout(() => {
        if (checkbox) checkbox.disabled = false;
        if (label) label.style.opacity = '1';
        if (statusDiv) statusDiv.style.opacity = '0';
      }, 1000);

      showMessage(`Failed to update not made daily status: ${error.message}`, 'error');
    }
  }

  /**
   * Toggle show in bottle count checkbox for prep item
   */
  async function toggleBottleCount(itemId, showInBottle) {
    const checkbox = document.getElementById(`bottle-count-${itemId}`);
    const label = checkbox?.nextElementSibling;
    const statusDiv = document.getElementById(`save-status-${itemId}`);

    // Visual feedback - saving state
    if (checkbox) checkbox.disabled = true;
    if (label) label.style.opacity = '0.5';

    // Show saving status
    if (statusDiv) {
      statusDiv.textContent = 'üíæ Saving...';
      statusDiv.style.color = '#ff9800';
      statusDiv.style.opacity = '1';
    }

    try {
      const { error } = await supabase
        .from('inventory_items')
        .update({ show_in_bottle_count: showInBottle })
        .eq('id', itemId);

      if (error) throw error;

      // Update local state
      const item = orderingSystemState.items.find(i => i.id === itemId);
      if (item) {
        item.showInBottleCount = showInBottle;
      }

      // Success feedback
      if (statusDiv) {
        statusDiv.textContent = '‚úì Saved';
        statusDiv.style.color = '#4caf50';
      }

      setTimeout(() => {
        if (checkbox) checkbox.disabled = false;
        if (label) label.style.opacity = '1';
        if (statusDiv) statusDiv.style.opacity = '0';
      }, 800);

      // Refresh prep sheet to update recommendations
      refreshPrepSheet();

    } catch (error) {
      console.error('Failed to toggle bottle count:', error);

      // Error feedback
      if (statusDiv) {
        statusDiv.textContent = '‚úó Failed';
        statusDiv.style.color = '#d32f2f';
      }

      // Revert checkbox state
      if (checkbox) checkbox.checked = !showInBottle;

      setTimeout(() => {
        if (checkbox) checkbox.disabled = false;
        if (label) label.style.opacity = '1';
        if (statusDiv) statusDiv.style.opacity = '0';
      }, 1000);

      showMessage(`Failed to update bottle count status: ${error.message}`, 'error');
    }
  }

  /**
   * Toggle multiple locations checkbox and show location selector modal
   */
  async function toggleMultipleLocations(itemId, enableMultipleLocations) {
    console.log('toggleMultipleLocations called:', itemId, enableMultipleLocations);
    const checkbox = document.getElementById(`multiple-locations-${itemId}`);

    if (enableMultipleLocations) {
      // Show location selector modal
      console.log('Opening location selector modal for item:', itemId);
      await showLocationSelectorModal(itemId);
    } else {
      // Disable multi-location: clear location data (no confirmation needed - user can re-enable)
      try {
        const { error } = await supabase
          .from('inventory_items')
          .update({
            has_multiple_locations: false,
            location_counts: {}
          })
          .eq('id', itemId);

        if (error) throw error;

        // Update local state
        const item = orderingSystemState.items.find(i => i.id === itemId);
        if (item) {
          item.hasMultipleLocations = false;
          item.locationCounts = {};
        }

        renderPrepCountList();
        showMessage('‚úì Multiple locations disabled', 'success');

      } catch (error) {
        console.error('Failed to disable multiple locations:', error);
        checkbox.checked = true; // Revert
        showMessage(`Failed: ${error.message}`, 'error');
      }
    }
  }

  /**
   * Show modal to select locations for an item
   */
  async function showLocationSelectorModal(itemId) {
    console.log('showLocationSelectorModal called for item:', itemId);
    await loadPrepLocations();
    console.log('Prep locations loaded:', prepLocationsCache);

    const item = orderingSystemState.items.find(i => i.id === itemId);
    if (!item) {
      console.error('Item not found:', itemId);
      return;
    }
    console.log('Found item:', item);

    const existingLocations = Object.keys(item.locationCounts || {});

    const overlay = document.createElement('div');
    overlay.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 10001; display: flex; align-items: center; justify-content: center; padding: 20px;';

    const modal = document.createElement('div');
    modal.style.cssText = 'background: white; max-width: 500px; width: 100%; padding: 24px; border: 2px solid var(--gray-400);';

    const header = document.createElement('h3');
    header.textContent = `SELECT LOCATIONS FOR ${item.itemName}`;
    header.style.cssText = 'margin: 0 0 20px 0; font-size: 14px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: var(--gray-900);';
    modal.appendChild(header);

    // Location 1
    const loc1Div = document.createElement('div');
    loc1Div.style.cssText = 'margin-bottom: 12px;';
    const loc1Label = document.createElement('label');
    loc1Label.textContent = 'Location 1:';
    loc1Label.style.cssText = 'display: block; font-size: 11px; font-weight: 600; color: var(--gray-600); margin-bottom: 6px;';
    const loc1Select = document.createElement('select');
    loc1Select.id = 'modal-loc1';
    loc1Select.style.cssText = 'width: 100%; padding: 10px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 13px;';
    loc1Select.innerHTML = '<option value="">Select location...</option><option value="__add_new__">+ Add New</option>';
    const loc1Input = document.createElement('input');
    loc1Input.type = 'text';
    loc1Input.id = 'modal-loc1-input';
    loc1Input.placeholder = 'Enter new location';
    loc1Input.style.cssText = 'display: none; width: 100%; padding: 10px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 13px; margin-top: 6px;';
    loc1Div.appendChild(loc1Label);
    loc1Div.appendChild(loc1Select);
    loc1Div.appendChild(loc1Input);
    modal.appendChild(loc1Div);

    // Location 2
    const loc2Div = document.createElement('div');
    loc2Div.style.cssText = 'margin-bottom: 12px;';
    const loc2Label = document.createElement('label');
    loc2Label.textContent = 'Location 2:';
    loc2Label.style.cssText = 'display: block; font-size: 11px; font-weight: 600; color: var(--gray-600); margin-bottom: 6px;';
    const loc2Select = document.createElement('select');
    loc2Select.id = 'modal-loc2';
    loc2Select.style.cssText = 'width: 100%; padding: 10px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 13px;';
    loc2Select.innerHTML = '<option value="">Select location...</option><option value="__add_new__">+ Add New</option>';
    const loc2Input = document.createElement('input');
    loc2Input.type = 'text';
    loc2Input.id = 'modal-loc2-input';
    loc2Input.placeholder = 'Enter new location';
    loc2Input.style.cssText = 'display: none; width: 100%; padding: 10px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 13px; margin-top: 6px;';
    loc2Div.appendChild(loc2Label);
    loc2Div.appendChild(loc2Select);
    loc2Div.appendChild(loc2Input);
    modal.appendChild(loc2Div);

    // Location 3
    const loc3Div = document.createElement('div');
    loc3Div.id = 'modal-loc3-div';
    loc3Div.style.cssText = 'margin-bottom: 12px; display: none;';
    const loc3Label = document.createElement('label');
    loc3Label.textContent = 'Location 3:';
    loc3Label.style.cssText = 'display: block; font-size: 11px; font-weight: 600; color: var(--gray-600); margin-bottom: 6px;';
    const loc3Select = document.createElement('select');
    loc3Select.id = 'modal-loc3';
    loc3Select.style.cssText = 'width: 100%; padding: 10px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 13px;';
    loc3Select.innerHTML = '<option value="">Select location...</option><option value="__add_new__">+ Add New</option>';
    const loc3Input = document.createElement('input');
    loc3Input.type = 'text';
    loc3Input.id = 'modal-loc3-input';
    loc3Input.placeholder = 'Enter new location';
    loc3Input.style.cssText = 'display: none; width: 100%; padding: 10px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 13px; margin-top: 6px;';
    loc3Div.appendChild(loc3Label);
    loc3Div.appendChild(loc3Select);
    loc3Div.appendChild(loc3Input);
    modal.appendChild(loc3Div);

    // Add Location link
    const addLocLink = document.createElement('a');
    addLocLink.href = 'javascript:void(0)';
    addLocLink.textContent = '+ Add Location';
    addLocLink.style.cssText = 'color: #1976d2; font-size: 12px; font-weight: 600; text-decoration: underline; cursor: pointer; display: block; margin-bottom: 20px;';
    addLocLink.onclick = () => {
      loc3Div.style.display = 'block';
      addLocLink.style.display = 'none';
    };
    modal.appendChild(addLocLink);

    // Populate dropdowns
    prepLocationsCache.forEach(loc => {
      [loc1Select, loc2Select, loc3Select].forEach(select => {
        const opt = document.createElement('option');
        opt.value = loc.name;
        opt.textContent = loc.name;
        select.appendChild(opt);
      });
    });

    // Pre-select existing locations
    if (existingLocations.length > 0) {
      loc1Select.value = existingLocations[0] || '';
      if (existingLocations.length > 1) loc2Select.value = existingLocations[1] || '';
      if (existingLocations.length > 2) {
        loc3Select.value = existingLocations[2] || '';
        loc3Div.style.display = 'block';
        addLocLink.style.display = 'none';
      }
    }

    // Handle select changes
    [loc1Select, loc2Select, loc3Select].forEach((select, idx) => {
      select.onchange = () => {
        const input = document.getElementById(`modal-loc${idx + 1}-input`);
        if (select.value === '__add_new__') {
          input.style.display = 'block';
        } else {
          input.style.display = 'none';
          input.value = '';
        }
      };
    });

    // Buttons
    const btnContainer = document.createElement('div');
    btnContainer.style.cssText = 'display: flex; gap: 12px; margin-top: 20px;';

    const cancelBtn = document.createElement('button');
    cancelBtn.textContent = 'CANCEL';
    cancelBtn.style.cssText = 'flex: 1; padding: 12px; background: white; color: var(--gray-700); border: 2px solid var(--gray-300); border-radius: 0; font-size: 12px; font-weight: 700; cursor: pointer;';
    cancelBtn.onclick = () => {
      document.body.removeChild(overlay);
      document.getElementById(`multiple-locations-${itemId}`).checked = false; // Uncheck
    };
    btnContainer.appendChild(cancelBtn);

    const saveBtn = document.createElement('button');
    saveBtn.textContent = 'SAVE LOCATIONS';
    saveBtn.style.cssText = 'flex: 2; padding: 12px; background: #212121; color: white; border: 2px solid #212121; border-radius: 0; font-size: 12px; font-weight: 700; cursor: pointer;';
    saveBtn.onclick = async () => {
      const locations = [];

      // Process location 1
      if (loc1Select.value === '__add_new__' && loc1Input.value.trim()) {
        const capitalized = loc1Input.value.trim().charAt(0).toUpperCase() + loc1Input.value.trim().slice(1);
        locations.push(capitalized);
        await saveNewLocation(capitalized);
      } else if (loc1Select.value && loc1Select.value !== '__add_new__') {
        locations.push(loc1Select.value);
      }

      // Process location 2
      if (loc2Select.value === '__add_new__' && loc2Input.value.trim()) {
        const capitalized = loc2Input.value.trim().charAt(0).toUpperCase() + loc2Input.value.trim().slice(1);
        locations.push(capitalized);
        await saveNewLocation(capitalized);
      } else if (loc2Select.value && loc2Select.value !== '__add_new__') {
        locations.push(loc2Select.value);
      }

      // Process location 3
      if (loc3Div.style.display !== 'none') {
        if (loc3Select.value === '__add_new__' && loc3Input.value.trim()) {
          const capitalized = loc3Input.value.trim().charAt(0).toUpperCase() + loc3Input.value.trim().slice(1);
          locations.push(capitalized);
          await saveNewLocation(capitalized);
        } else if (loc3Select.value && loc3Select.value !== '__add_new__') {
          locations.push(loc3Select.value);
        }
      }

      if (locations.length === 0) {
        showMessage('Please select at least one location', 'error');
        return;
      }

      // Initialize location counts
      const locationCounts = {};
      locations.forEach(loc => {
        locationCounts[loc] = item.locationCounts?.[loc] || 0; // Preserve existing counts
      });

      try {
        const { error } = await supabase
          .from('inventory_items')
          .update({
            has_multiple_locations: true,
            location_counts: locationCounts
          })
          .eq('id', itemId);

        if (error) throw error;

        // Update local state
        item.hasMultipleLocations = true;
        item.locationCounts = locationCounts;

        document.body.removeChild(overlay);
        renderPrepCountList();
        showMessage('‚úì Locations saved successfully!', 'success');

      } catch (error) {
        console.error('Failed to save locations:', error);
        showMessage(`Failed: ${error.message}`, 'error');
      }
    };
    btnContainer.appendChild(saveBtn);

    modal.appendChild(btnContainer);
    overlay.appendChild(modal);
    console.log('Appending location selector modal to body');
    document.body.appendChild(overlay);
    console.log('Modal should now be visible');
  }

  /**
   * Quick adjust stock count with +/- buttons (Mobile-Optimized)
   */
  function quickAdjustStock(itemId, adjustment) {
    const inputElement = document.getElementById(`stock-${itemId}`);
    if (!inputElement) return;

    const currentValue = parseFloat(inputElement.value) || 0;
    const newValue = Math.max(0, currentValue + adjustment); // Don't go below 0

    // Round to 2 decimal places to avoid floating point errors
    const roundedValue = Math.round(newValue * 100) / 100;

    inputElement.value = roundedValue;

    // Trigger auto-save
    autoSaveStockCount(itemId, roundedValue, inputElement);
  }

  /**
   * Quick adjust location-specific stock with +/- buttons
   */
  function quickAdjustLocationStock(itemId, location, adjustment) {
    const locationKey = location.replace(/\s/g, '_');
    const inputElement = document.getElementById(`location-stock-${itemId}-${locationKey}`);
    if (!inputElement) return;

    const currentValue = parseFloat(inputElement.value) || 0;
    const newValue = Math.max(0, currentValue + adjustment);
    const roundedValue = Math.round(newValue * 100) / 100;

    inputElement.value = roundedValue;
    autoSaveLocationStock(itemId, location, roundedValue, inputElement);
  }

  /**
   * Auto-save location-specific stock count
   */
  async function autoSaveLocationStock(itemId, location, newValue, inputElement) {
    const stockValue = parseFloat(newValue);
    if (isNaN(stockValue)) return;

    const statusDiv = document.getElementById(`save-status-${itemId}`);

    inputElement.style.borderColor = '#ff9800';
    inputElement.style.background = '#fff3e0';
    inputElement.disabled = true;

    if (statusDiv) {
      statusDiv.textContent = 'üíæ Saving...';
      statusDiv.style.color = '#ff9800';
      statusDiv.style.opacity = '1';
    }

    try {
      // Find item in local state
      const item = orderingSystemState.items.find(i => i.id === itemId);
      if (!item) throw new Error('Item not found');

      // Update location counts
      const updatedLocationCounts = { ...(item.locationCounts || {}) };
      updatedLocationCounts[location] = stockValue;

      // Calculate total stock as sum of all locations
      const totalStock = Object.values(updatedLocationCounts).reduce((sum, count) => sum + parseFloat(count || 0), 0);

      // Save to database with counter name and timestamp
      const countedBy = getActivePrepCounterName();
      const countedAt = new Date().toISOString();

      // Get item info for logging
      const previousCount = item.currentStock || 0;
      const itemName = item.itemName || 'Unknown Item';

      const { error } = await supabase
        .from('inventory_items')
        .update({
          location_counts: updatedLocationCounts,
          current_stock: totalStock,
          last_counted_date: countedAt,
          counted_by: countedBy,
          counted_at: countedAt
        })
        .eq('id', itemId);

      if (error) throw error;

      // Log this counting action for leaderboard (don't fail save if log fails)
      try {
        await supabase
          .from('prep_count_log')
          .insert({
            item_id: itemId,
            item_name: itemName,
            counted_by: countedBy,
            counted_at: countedAt,
            new_count: totalStock,
            previous_count: previousCount
          });
      } catch (logError) {
        console.warn('Failed to log prep count action (location):', logError);
      }

      // Update local state
      item.locationCounts = updatedLocationCounts;
      item.currentStock = totalStock;
      item.lastCountedDate = countedAt;
      item.countedBy = countedBy;
      item.countedAt = countedAt;

      // Update total display
      const totalInput = document.getElementById(`stock-${itemId}`);
      if (totalInput) {
        totalInput.value = totalStock;
      }

      // Success feedback
      inputElement.style.borderColor = '#388e3c';
      inputElement.style.background = '#e8f5e9';

      if (statusDiv) {
        statusDiv.textContent = '‚úì Saved!';
        statusDiv.style.color = '#388e3c';
        statusDiv.style.opacity = '1';
      }

      calculateUpcomingOrders();
      await refreshUpcomingOrdersUI();
      refreshBottleCount();

      setTimeout(() => {
        inputElement.style.borderColor = '#2e7d32';
        inputElement.style.background = 'white';
        inputElement.disabled = false;

        if (statusDiv) {
          statusDiv.style.opacity = '0';
        }

        // Re-render AFTER visual feedback shows
        renderPrepCountList(); // Re-render to show counted_by name
      }, 800);

    } catch (error) {
      console.error('Auto-save location failed:', error);
      inputElement.style.borderColor = '#d32f2f';
      inputElement.style.background = '#ffebee';

      if (statusDiv) {
        statusDiv.textContent = '‚úó Failed';
        statusDiv.style.color = '#d32f2f';
        statusDiv.style.opacity = '1';
      }

      setTimeout(() => {
        inputElement.style.borderColor = '';
        inputElement.style.background = '';
        inputElement.disabled = false;

        if (statusDiv) {
          statusDiv.style.opacity = '0';
        }
      }, 1000);

      showMessage(`Failed to save: ${error.message}`, 'error');
    }
  }

  /**
   * Quick adjust par level with +/- buttons
   */
  function quickAdjustParLevel(itemId, adjustment) {
    const inputElement = document.getElementById(`par-${itemId}`);
    if (!inputElement) return;

    const currentValue = parseFloat(inputElement.value) || 0;
    const newValue = Math.max(0, currentValue + adjustment); // Don't go below 0

    // Round to 2 decimal places to avoid floating point errors
    const roundedValue = Math.round(newValue * 100) / 100;

    inputElement.value = roundedValue;

    // Trigger auto-save
    autoSaveParLevel(itemId, roundedValue, inputElement);
  }

  /**
   * Auto-save par level when input loses focus or +/- buttons clicked
   */
  async function autoSaveParLevel(itemId, newValue, inputElement) {
    const parValue = parseFloat(newValue);
    if (isNaN(parValue)) return;

    // Visual feedback - saving state
    const originalBorder = inputElement.style.borderColor;
    const originalBg = inputElement.style.background;
    const statusDiv = document.getElementById(`par-save-status-${itemId}`);

    inputElement.style.borderColor = '#ff9800';
    inputElement.style.background = '#fff3e0';
    inputElement.disabled = true;

    // Show "Saving..." status
    if (statusDiv) {
      statusDiv.textContent = 'üíæ Saving...';
      statusDiv.style.color = '#ff9800';
      statusDiv.style.opacity = '1';
    }

    try {
      const { error } = await supabase
        .from('inventory_items')
        .update({
          par_level: parValue
        })
        .eq('id', itemId);

      if (error) throw error;

      // Update local state
      const item = orderingSystemState.items.find(i => i.id === itemId);
      if (item) {
        item.parLevel = parValue;
      }

      // Success feedback - green
      inputElement.style.borderColor = '#2e7d32';
      inputElement.style.background = '#e8f5e9';
      inputElement.disabled = false;

      if (statusDiv) {
        statusDiv.textContent = '‚úÖ Saved';
        statusDiv.style.color = '#2e7d32';
        setTimeout(() => {
          statusDiv.style.opacity = '0';
        }, 2000);
      }

      // Recalculate orders since par level changed
      calculateUpcomingOrders();
      await refreshUpcomingOrdersUI();
      refreshBottleCount(); // Refresh bottle count after par level update

    } catch (error) {
      console.error('Error saving par level:', error);
      
      // Error feedback - red
      inputElement.style.borderColor = '#d32f2f';
      inputElement.style.background = '#ffebee';
      inputElement.disabled = false;

      if (statusDiv) {
        statusDiv.textContent = '‚ùå Failed';
        statusDiv.style.color = '#d32f2f';
        setTimeout(() => {
          statusDiv.style.opacity = '0';
        }, 3000);
      }
    }

    // Reset to original after delay
    setTimeout(() => {
      inputElement.style.borderColor = originalBorder;
      inputElement.style.background = originalBg;
    }, 2500);
  }

  /**
   * Show area selector popup for a prep item - NOW SUPPORTS MULTIPLE LOCATIONS (up to 3)
   */
  async function showAreaSelector(itemId, currentArea, event) {
    event.preventDefault();
    event.stopPropagation();

    const item = orderingSystemState.items.find(i => i.id === itemId);
    if (!item) return;

    // Get existing selected locations for this item
    const existingLocations = Object.keys(item.locationCounts || {});
    const selectedAreas = new Set(existingLocations);

    // Get all unique storage locations from ALL prep items (combines storageLocation + locationCounts keys)
    const prepItems = orderingSystemState.items.filter(item =>
      item.vendor === 'PREP' || item.itemType === 'prep'
    );

    const allLocations = new Set();

    // Add from storageLocation field
    prepItems.forEach(item => {
      if (item.storageLocation && item.storageLocation.trim()) {
        allLocations.add(item.storageLocation.trim());
      }
    });

    // Add from locationCounts keys (multi-location items)
    prepItems.forEach(item => {
      if (item.locationCounts) {
        Object.keys(item.locationCounts).forEach(loc => {
          if (loc && loc.trim()) {
            allLocations.add(loc.trim());
          }
        });
      }
    });

    const uniqueAreas = Array.from(allLocations).sort();

    console.log('üìç uniqueAreas to display:', uniqueAreas);

    // Create modal
    const modal = document.createElement('div');
    modal.id = 'areaSelectorModal';
    modal.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      padding: 20px;
    `;

    const content = document.createElement('div');
    content.style.cssText = `
      background: white;
      padding: 24px;
      max-width: 400px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      border: 3px solid var(--gray-700);
    `;

    const title = document.createElement('h3');
    title.textContent = 'SELECT LOCATIONS (UP TO 3)';
    title.style.cssText = `
      margin: 0 0 8px 0;
      font-size: 16px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--gray-900);
    `;

    const subtitle = document.createElement('p');
    subtitle.textContent = 'Click to select/deselect. Select multiple to track counts per location.';
    subtitle.style.cssText = `
      margin: 0 0 16px 0;
      font-size: 12px;
      color: var(--gray-600);
      font-style: italic;
    `;

    const areaList = document.createElement('div');
    areaList.style.cssText = 'margin-bottom: 16px;';

    // Function to update button appearance
    const updateButtonStyle = (btn, area, isSelected) => {
      btn.style.background = isSelected ? '#e3f2fd' : 'var(--gray-100)';
      btn.style.borderColor = isSelected ? '#1976d2' : 'var(--gray-300)';
      btn.style.fontWeight = isSelected ? '700' : '400';
      btn.style.color = isSelected ? '#1976d2' : 'var(--gray-900)';
    };

    // If no locations exist yet, show helpful message
    if (uniqueAreas.length === 0) {
      const noLocationsMsg = document.createElement('p');
      noLocationsMsg.textContent = 'No locations yet. Click "Add New Area" below to create your first location.';
      noLocationsMsg.style.cssText = `
        padding: 16px;
        background: var(--gray-100);
        border: 2px solid var(--gray-300);
        color: var(--gray-600);
        font-size: 13px;
        font-style: italic;
        text-align: center;
        margin-bottom: 12px;
      `;
      areaList.appendChild(noLocationsMsg);
    }

    // Add existing areas as toggleable buttons
    uniqueAreas.forEach(area => {
      const areaBtn = document.createElement('button');
      areaBtn.textContent = area;
      const isSelected = selectedAreas.has(area);
      areaBtn.style.cssText = `
        display: block;
        width: 100%;
        padding: 12px;
        margin-bottom: 8px;
        background: ${isSelected ? '#e3f2fd' : 'var(--gray-100)'};
        border: 2px solid ${isSelected ? '#1976d2' : 'var(--gray-300)'};
        color: ${isSelected ? '#1976d2' : 'var(--gray-900)'};
        font-size: 13px;
        font-weight: ${isSelected ? '700' : '400'};
        cursor: pointer;
        text-align: left;
        transition: all 0.15s;
      `;
      areaBtn.onmouseover = () => {
        if (!selectedAreas.has(area)) {
          areaBtn.style.background = '#f5f5f5';
          areaBtn.style.borderColor = 'var(--gray-400)';
        }
      };
      areaBtn.onmouseout = () => {
        updateButtonStyle(areaBtn, area, selectedAreas.has(area));
      };
      areaBtn.onclick = () => {
        // Toggle selection
        if (selectedAreas.has(area)) {
          selectedAreas.delete(area);
        } else {
          if (selectedAreas.size >= 3) {
            showMessage('Maximum 3 locations allowed', 'warning');
            return;
          }
          selectedAreas.add(area);
        }
        updateButtonStyle(areaBtn, area, selectedAreas.has(area));
      };
      areaList.appendChild(areaBtn);
    });

    content.appendChild(title);
    content.appendChild(subtitle);
    content.appendChild(areaList);

    // Add "Add New Area" section
    const addNewContainer = document.createElement('div');
    addNewContainer.id = 'addNewAreaContainer';
    addNewContainer.style.cssText = 'margin-top: 16px; padding-top: 16px; border-top: 2px solid var(--gray-300);';

    const addNewBtn = document.createElement('button');
    addNewBtn.textContent = '+ ADD NEW AREA';
    addNewBtn.style.cssText = `
      display: block;
      width: 100%;
      padding: 12px;
      background: var(--gray-700);
      border: 2px solid var(--gray-700);
      color: white;
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      transition: all 0.15s;
    `;
    addNewBtn.onmouseover = () => {
      addNewBtn.style.background = 'var(--gray-900)';
      addNewBtn.style.borderColor = 'var(--gray-900)';
    };
    addNewBtn.onmouseout = () => {
      addNewBtn.style.background = 'var(--gray-700)';
      addNewBtn.style.borderColor = 'var(--gray-700)';
    };
    addNewBtn.onclick = () => {
      showPrompt('Enter new location name:', '', (newAreaName) => {
        if (newAreaName && newAreaName.trim()) {
          const capitalized = newAreaName.trim().charAt(0).toUpperCase() + newAreaName.trim().slice(1);

          // Add to the list if not already there
          if (!uniqueAreas.includes(capitalized)) {
            uniqueAreas.push(capitalized);
            uniqueAreas.sort();
          }

          // Auto-select the new location
          if (selectedAreas.size < 3) {
            selectedAreas.add(capitalized);
          }

          // Close and reopen modal to refresh with new location
          document.body.removeChild(modal);
          showAreaSelector(itemId, currentArea, event);
        }
      });
    };

    addNewContainer.appendChild(addNewBtn);
    content.appendChild(addNewContainer);

    // Button container
    const btnContainer = document.createElement('div');
    btnContainer.style.cssText = 'display: flex; gap: 12px; margin-top: 16px;';

    // Cancel button
    const cancelBtn = document.createElement('button');
    cancelBtn.textContent = 'CANCEL';
    cancelBtn.style.cssText = `
      flex: 1;
      padding: 12px;
      background: var(--gray-100);
      border: 2px solid var(--gray-300);
      color: var(--gray-900);
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    `;
    cancelBtn.onclick = () => document.body.removeChild(modal);

    // Save button
    const saveBtn = document.createElement('button');
    saveBtn.textContent = 'SAVE';
    saveBtn.style.cssText = `
      flex: 2;
      padding: 12px;
      background: #212121;
      border: 2px solid #212121;
      color: white;
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    `;
    saveBtn.onclick = async () => {
      const selectedLocationsArray = Array.from(selectedAreas);

      if (selectedLocationsArray.length === 0) {
        // No locations selected - disable multi-location
        try {
          await supabase
            .from('inventory_items')
            .update({
              has_multiple_locations: false,
              location_counts: {}
            })
            .eq('id', itemId);

          item.hasMultipleLocations = false;
          item.locationCounts = {};

          document.body.removeChild(modal);
          renderPrepCountList();
          showMessage('‚úì Locations cleared', 'success');
        } catch (error) {
          showMessage(`Error: ${error.message}`, 'error');
        }
      } else {
        // Save selected locations
        const locationCounts = {};
        selectedLocationsArray.forEach(loc => {
          locationCounts[loc] = item.locationCounts?.[loc] || 0; // Preserve existing counts
        });

        try {
          await supabase
            .from('inventory_items')
            .update({
              has_multiple_locations: selectedLocationsArray.length > 1,
              location_counts: locationCounts
            })
            .eq('id', itemId);

          item.hasMultipleLocations = selectedLocationsArray.length > 1;
          item.locationCounts = locationCounts;

          document.body.removeChild(modal);
          renderPrepCountList();
          showMessage(`‚úì ${selectedLocationsArray.length} location(s) saved!`, 'success');
        } catch (error) {
          showMessage(`Error: ${error.message}`, 'error');
        }
      }
    };

    btnContainer.appendChild(cancelBtn);
    btnContainer.appendChild(saveBtn);
    content.appendChild(btnContainer);
    modal.appendChild(content);

    // Close on backdrop click
    modal.onclick = (e) => {
      if (e.target === modal) {
        document.body.removeChild(modal);
      }
    };

    document.body.appendChild(modal);
  }

  /**
   * Show input for adding new area
   */
  function showAddNewAreaInput(itemId, container) {
    container.innerHTML = '';

    const inputGroup = document.createElement('div');

    const label = document.createElement('label');
    label.textContent = 'NEW AREA NAME';
    label.style.cssText = `
      display: block;
      margin-bottom: 8px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--gray-700);
    `;

    const input = document.createElement('input');
    input.type = 'text';
    input.placeholder = 'e.g., Walk-in Cooler';
    input.style.cssText = `
      width: 100%;
      padding: 12px;
      border: 2px solid var(--gray-300);
      font-size: 14px;
      margin-bottom: 12px;
      box-sizing: border-box;
    `;

    const saveStatus = document.createElement('div');
    saveStatus.id = 'newAreaSaveStatus';
    saveStatus.style.cssText = `
      text-align: center;
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 12px;
      opacity: 0;
      transition: opacity 0.2s;
    `;

    // Auto-capitalize first letter
    input.oninput = (e) => {
      const value = e.target.value;
      if (value.length > 0) {
        e.target.value = value.charAt(0).toUpperCase() + value.slice(1);
      }
    };

    // Save on Enter key
    input.onkeypress = (e) => {
      if (e.key === 'Enter') {
        saveNewArea(itemId, input.value.trim(), saveStatus);
      }
    };

    const saveBtn = document.createElement('button');
    saveBtn.textContent = 'SAVE NEW AREA';
    saveBtn.style.cssText = `
      display: block;
      width: 100%;
      padding: 12px;
      background: #2e7d32;
      border: 2px solid #2e7d32;
      color: white;
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    `;
    saveBtn.onclick = () => {
      saveNewArea(itemId, input.value.trim(), saveStatus);
    };

    const cancelBtn = document.createElement('button');
    cancelBtn.textContent = 'CANCEL';
    cancelBtn.style.cssText = `
      display: block;
      width: 100%;
      padding: 12px;
      background: var(--gray-100);
      border: 2px solid var(--gray-300);
      color: var(--gray-900);
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    `;
    cancelBtn.onclick = () => {
      const modal = document.getElementById('areaSelectorModal');
      if (modal) document.body.removeChild(modal);
    };

    inputGroup.appendChild(label);
    inputGroup.appendChild(input);
    inputGroup.appendChild(saveStatus);
    inputGroup.appendChild(saveBtn);
    inputGroup.appendChild(cancelBtn);
    container.appendChild(inputGroup);

    // Focus input
    setTimeout(() => input.focus(), 100);
  }

  /**
   * Save new area and assign to item
   */
  async function saveNewArea(itemId, areaName, statusDiv) {
    if (!areaName) {
      showMessage('Please enter an area name', 'error');
      return;
    }

    // Show saving status
    statusDiv.textContent = 'üíæ Saving...';
    statusDiv.style.color = '#ff9800';
    statusDiv.style.opacity = '1';

    try {
      // Save to database
      const { error } = await supabase
        .from('inventory_items')
        .update({ storage_location: areaName })
        .eq('id', itemId);

      if (error) throw error;

      // Update local state
      const item = orderingSystemState.items.find(i => i.id === itemId);
      if (item) {
        item.storageLocation = areaName;
      }

      // Success feedback
      statusDiv.textContent = '‚úÖ Saved!';
      statusDiv.style.color = '#2e7d32';

      // Close modal after delay
      setTimeout(() => {
        const modal = document.getElementById('areaSelectorModal');
        if (modal) document.body.removeChild(modal);

        // Re-render prep list to show updated area
        renderPrepCountList();
      }, 1000);

    } catch (error) {
      console.error('Error saving area:', error);
      statusDiv.textContent = '‚ùå Failed to save';
      statusDiv.style.color = '#d32f2f';
      setTimeout(() => {
        statusDiv.style.opacity = '0';
      }, 3000);
    }
  }

  /**
   * Save item area selection
   */
  async function saveItemArea(itemId, areaName) {
    try {
      const { error } = await supabase
        .from('inventory_items')
        .update({ storage_location: areaName })
        .eq('id', itemId);

      if (error) throw error;

      // Update local state
      const item = orderingSystemState.items.find(i => i.id === itemId);
      if (item) {
        item.storageLocation = areaName;
      }

      // Re-render prep list to show updated area
      renderPrepCountList();

    } catch (error) {
      console.error('Error saving area:', error);
      showMessage('Failed to save area. Please try again.', 'error');
    }
  }

  /**
   * Toggle compact mode for Update Counts view
   */
  let isCompactMode = false;
  function toggleCompactMode() {
    isCompactMode = !isCompactMode;
    const icon = document.getElementById('compactModeIcon');

    if (isCompactMode) {
      // Compact mode: smaller cards, tighter spacing
      icon.textContent = 'üì±';
      // Apply compact styles by re-rendering
      renderStockCountList();
    } else {
      // Normal mode: larger cards, comfortable spacing
      icon.textContent = 'üìã';
      // Apply normal styles by re-rendering
      renderStockCountList();
    }
  }

  /**
   * Save all pending stock count updates
   */
  async function saveAllStockCounts() {
    if (orderingSystemState.pendingStockUpdates.size === 0) {
      showMessage('No changes to save!', 'info');
      return;
    }

    showLoading('Saving Stock Counts', `Updating ${orderingSystemState.pendingStockUpdates.size} items...`);

    try {
      const updates = [];
      for (const [itemId, newStock] of orderingSystemState.pendingStockUpdates.entries()) {
        updates.push(
          supabase
            .from('inventory_items')
            .update({
              current_stock: newStock,
              last_counted_date: new Date().toISOString()
            })
            .eq('id', itemId)
        );

        // Update local state
        const item = orderingSystemState.items.find(i => i.id === itemId);
        if (item) {
          item.currentStock = newStock;
          item.lastCountedDate = new Date().toISOString();
        }
      }

      await Promise.all(updates);

      // Clear pending updates
      orderingSystemState.pendingStockUpdates.clear();

      // Recalculate orders and refresh UI
      calculateUpcomingOrders();
      await refreshUpcomingOrdersUI();
      renderStockCountList();

      hideLoading();
      showMessage(`‚úÖ Successfully updated ${updates.length} items!`, 'success');
    } catch (error) {
      hideLoading();
      showMessage(`Error saving stock counts: ${error.message}`, 'error');
    }
  }

  /**
   * Update par level for an item
   */
  async function updateParLevel(itemId, newParLevel) {
    showLoading('Updating Par Level', 'Saving changes...');

    try {
      const { error } = await supabase
        .from('inventory_items')
        .update({ par_level: parseInt(newParLevel) })
        .eq('id', itemId);

      if (error) throw error;

      // Update local state
      const item = orderingSystemState.items.find(i => i.id === itemId);
      if (item) {
        item.parLevel = parseInt(newParLevel);
      }

      // Recalculate orders
      calculateUpcomingOrders();
      await refreshUpcomingOrdersUI();

      hideLoading();
      showMessage('‚úÖ Par level updated!', 'success');
    } catch (error) {
      hideLoading();
      showMessage(`Error updating par level: ${error.message}`, 'error');
    }
  }

  /**
   * Update unit type for an inventory item
   */
  async function updateItemUnit(itemId, newUnit) {
    if (!newUnit || newUnit.trim() === '') {
      showMessage('Unit cannot be empty', 'error');
      return;
    }

    showLoading('Updating Unit', 'Saving changes...');

    try {
      const { error } = await supabase
        .from('inventory_items')
        .update({ unit: newUnit.trim().toUpperCase() })
        .eq('id', itemId);

      if (error) throw error;

      // Update local state
      const item = orderingSystemState.items.find(i => i.id === itemId);
      if (item) {
        item.unit = newUnit.trim().toUpperCase();
      }

      hideLoading();
      showMessage('Unit updated', 'success');

      // Re-render to show updated value
      renderInventoryList();
    } catch (error) {
      hideLoading();
      showMessage('Error updating unit: ' + error.message, 'error');
    }
  }

  /**
   * Handle add new item form submission
   */
  async function handleAddItem(event) {
    event.preventDefault();

    const itemName = document.getElementById('newItemName').value.trim();
    let vendor = document.getElementById('newItemVendor').value;
    const unit = document.getElementById('newItemUnit').value.trim();
    const parLevel = parseInt(document.getElementById('newItemPar').value);

    if (!itemName || !vendor || !unit) {
      showMessage('Please fill in all required fields!', 'error');
      return;
    }

    // Handle new vendor creation
    if (vendor === 'OTHER') {
      showPrompt('Enter new vendor name:', '', (newVendor) => {
        if (!newVendor || newVendor.trim() === '') {
          showMessage('Vendor name is required', 'error');
          return;
        }
        vendor = newVendor.trim();
        continueAddItem();
      });
      return;
    }

    continueAddItem();

    async function continueAddItem() {
      showLoading('Adding Item', 'Saving to database...');

    try {
      const { data, error } = await supabase
        .from('inventory_items')
        .insert([{
          item_name: itemName,
          vendor: vendor,
          unit: unit,
          par_level: parLevel,
          current_stock: 0,
          created_date: new Date().toISOString()
        }])
        .select();

      if (error) throw error;

      // Add to local state
      orderingSystemState.items.push({
        id: data[0].id,
        itemName: data[0].item_name,
        vendor: data[0].vendor,
        parLevel: data[0].par_level,
        currentStock: data[0].current_stock,
        unit: data[0].unit,
        lastCountedDate: null
      });

      refreshPriceHistoryControls();

      // Reset form
      document.getElementById('addItemForm').reset();

      // Refresh displays
      renderInventoryList();
      renderStockCountList();
      renderPrepCountList();
      refreshPriceHistoryControls();
      calculateUpcomingOrders();
      await refreshUpcomingOrdersUI();

      hideLoading();
      showMessage('‚úÖ Item added successfully!', 'success');
    } catch (error) {
      hideLoading();
      showMessage(`Error adding item: ${error.message}`, 'error');
    }
    }
  }

  /**
   * Handle adding a new prep item
   */
  async function handleAddPrepItem(event) {
    event.preventDefault();

    const itemName = document.getElementById('newPrepItemName').value.trim();
    let vendor = document.getElementById('newPrepItemVendor').value;
    const unit = document.getElementById('newPrepItemUnit').value.trim().toUpperCase();
    const parLevel = parseFloat(document.getElementById('newPrepItemPar').value);
    const batchLifespan = parseInt(document.getElementById('newPrepItemLifespan').value);

    if (!itemName || !vendor || !unit) {
      showMessage('Please fill in all required fields!', 'error');
      return;
    }

    // Handle new vendor creation
    if (vendor === 'OTHER') {
      showPrompt('Enter new vendor name:', '', (newVendor) => {
        if (!newVendor || newVendor.trim() === '') {
          showMessage('Vendor name is required', 'error');
          return;
        }
        vendor = newVendor.trim();
        continueAddPrepItem();
      });
      return;
    }

    continueAddPrepItem();

    async function continueAddPrepItem() {
      showLoading('Adding Prep Item', 'Saving to database...');

      try {
      const { data, error } = await supabase
        .from('inventory_items')
        .insert([{
          item_name: itemName,
          vendor: vendor,
          unit: unit,
          par_level: parLevel,
          current_stock: 0,
          item_type: 'prep',
          batch_lifespan_hours: batchLifespan,
          created_date: new Date().toISOString()
        }])
        .select();

      if (error) throw error;

      // Add to local state
      orderingSystemState.items.push({
        id: data[0].id,
        itemName: data[0].item_name,
        vendor: data[0].vendor,
        parLevel: data[0].par_level,
        currentStock: data[0].current_stock,
        unit: data[0].unit,
        itemType: data[0].item_type,
        batchLifespan: data[0].batch_lifespan_hours,
        lastCountedDate: null
      });

      refreshPriceHistoryControls();

      // Reset form
      document.getElementById('addPrepItemForm').reset();

      // Refresh displays
      renderInventoryList();
      renderStockCountList();
      renderPrepCountList();
      refreshPrepSheet(); // Refresh prep recommendations

      hideLoading();
      showMessage('Prep item added successfully!', 'success');
    } catch (error) {
      hideLoading();
      showMessage(`Error adding prep item: ${error.message}`, 'error');
    }
    }
  }

  /**
   * Delete an inventory item
   */
  async function deleteInventoryItem(itemId) {
    showConfirm('Are you sure you want to delete this item? This action cannot be undone.', async () => {
      showLoading('Deleting Item', 'Removing from database...');

    try {
      const { error } = await supabase
        .from('inventory_items')
        .delete()
        .eq('id', itemId);

      if (error) throw error;

      // Remove from local state
      orderingSystemState.items = orderingSystemState.items.filter(i => i.id !== itemId);

      // Refresh displays
      renderInventoryList();
      renderStockCountList();
      renderPrepCountList();
      calculateUpcomingOrders();

      hideLoading();
      showMessage('‚úÖ Item deleted successfully!', 'success');
    } catch (error) {
      hideLoading();
      showMessage(`Error deleting item: ${error.message}`, 'error');
    }
    });
  }

  /**
   * Open modal to edit inventory item
   */
  function openEditItemModal(itemId) {
    // Find the item
    const item = orderingSystemState.items.find(i => i.id === itemId);
    if (!item) {
      showMessage('Item not found', 'error');
      return;
    }

    // Create modal overlay
    const overlay = document.createElement('div');
    overlay.id = 'editItemModal';
    overlay.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      z-index: 10000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
    `;

    // Create modal content container
    const modal = document.createElement('div');
    modal.style.cssText = `
      background: white;
      border: 2px solid #e0e0e0;
      width: 100%;
      height: 100%;
      max-width: 500px;
      max-height: 100vh;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    `;

    // Responsive: full screen on mobile, centered on desktop
    if (window.innerWidth <= 600) {
      modal.style.maxWidth = '100%';
      modal.style.maxHeight = '100%';
      modal.style.border = 'none';
    }

    // Create header
    const header = document.createElement('div');
    header.style.cssText = `
      background: #212121;
      color: white;
      padding: 16px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 10;
    `;

    const headerTitle = document.createElement('h3');
    headerTitle.textContent = 'EDIT ITEM';
    headerTitle.style.cssText = `
      margin: 0;
      font-size: 16px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
    `;

    const closeBtn = document.createElement('button');
    closeBtn.textContent = '‚úï';
    closeBtn.style.cssText = `
      background: none;
      border: none;
      color: var(--white);
      font-size: 24px;
      cursor: pointer;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
    `;
    closeBtn.onclick = () => overlay.remove();

    header.appendChild(headerTitle);
    header.appendChild(closeBtn);

    // Create form container
    const formContainer = document.createElement('div');
    formContainer.style.cssText = `
      padding: 20px;
      padding-bottom: 100px;
    `;

    // Helper function to create form field
    function createField(label, inputElement) {
      const fieldDiv = document.createElement('div');
      fieldDiv.style.cssText = `
        margin-bottom: 16px;
      `;

      const labelEl = document.createElement('label');
      labelEl.textContent = label;
      labelEl.style.cssText = `
        display: block;
        margin-bottom: 6px;
        font-size: 12px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--gray-700);
      `;

      fieldDiv.appendChild(labelEl);
      fieldDiv.appendChild(inputElement);
      return fieldDiv;
    }

    // Item Name field
    const nameInput = document.createElement('input');
    nameInput.type = 'text';
    nameInput.value = item.itemName || '';
    nameInput.id = 'editItemName';
    nameInput.style.cssText = `
      width: 100%;
      padding: 10px;
      border: 2px solid var(--gray-300);
      border-radius: 0;
      font-size: 14px;
      box-sizing: border-box;
    `;
    formContainer.appendChild(createField('Item Name', nameInput));

    // Vendor dropdown
    const vendorSelect = document.createElement('select');
    vendorSelect.id = 'editItemVendor';
    vendorSelect.style.cssText = `
      width: 100%;
      padding: 10px;
      border: 2px solid var(--gray-300);
      border-radius: 0;
      font-size: 14px;
      box-sizing: border-box;
      background: var(--white);
    `;

    // Get all unique vendors
    const vendors = new Set(['PREP']);
    orderingSystemState.items.forEach(i => {
      if (i.vendor) vendors.add(i.vendor);
    });
    const sortedVendors = Array.from(vendors).sort();

    sortedVendors.forEach(vendor => {
      const option = document.createElement('option');
      option.value = vendor;
      option.textContent = vendor;
      if (vendor === item.vendor) option.selected = true;
      vendorSelect.appendChild(option);
    });

    formContainer.appendChild(createField('Vendor', vendorSelect));

    // Unit field
    const unitInput = document.createElement('input');
    unitInput.type = 'text';
    unitInput.value = item.unit || '';
    unitInput.id = 'editItemUnit';
    unitInput.style.cssText = `
      width: 100%;
      padding: 10px;
      border: 2px solid var(--gray-300);
      border-radius: 0;
      font-size: 14px;
      box-sizing: border-box;
      text-transform: uppercase;
    `;
    formContainer.appendChild(createField('Unit (CS, EA, LB)', unitInput));

    // Par Level field
    const parInput = document.createElement('input');
    parInput.type = 'number';
    parInput.step = '0.25';
    parInput.value = item.parLevel || 0;
    parInput.id = 'editItemPar';
    parInput.style.cssText = `
      width: 100%;
      padding: 10px;
      border: 2px solid var(--gray-300);
      border-radius: 0;
      font-size: 14px;
      box-sizing: border-box;
    `;
    formContainer.appendChild(createField('Par Level', parInput));

    // Current Stock (read-only for display)
    const stockInput = document.createElement('input');
    stockInput.type = 'number';
    stockInput.step = '0.25';
    stockInput.value = item.currentStock || 0;
    stockInput.id = 'editItemStock';
    stockInput.readOnly = true;
    stockInput.style.cssText = `
      width: 100%;
      padding: 10px;
      border: 2px solid var(--gray-300);
      border-radius: 0;
      font-size: 14px;
      box-sizing: border-box;
      background: var(--gray-100);
      color: var(--gray-600);
    `;
    const stockField = createField('Current Stock (update via COUNT tab)', stockInput);
    formContainer.appendChild(stockField);

    // Item Type field (only if PREP)
    if (item.vendor === 'PREP' || item.itemType === 'prep') {
      const itemTypeInput = document.createElement('input');
      itemTypeInput.type = 'text';
      itemTypeInput.value = item.itemType || 'prep';
      itemTypeInput.id = 'editItemType';
      itemTypeInput.style.cssText = `
        width: 100%;
        padding: 10px;
        border: 2px solid var(--gray-300);
        border-radius: 0;
        font-size: 14px;
        box-sizing: border-box;
      `;
      formContainer.appendChild(createField('Item Type', itemTypeInput));

      // Batch Lifespan
      const lifespanInput = document.createElement('input');
      lifespanInput.type = 'number';
      lifespanInput.value = item.batchLifespan || '';
      lifespanInput.id = 'editItemLifespan';
      lifespanInput.placeholder = 'Hours (e.g., 24)';
      lifespanInput.style.cssText = `
        width: 100%;
        padding: 10px;
        border: 2px solid var(--gray-300);
        border-radius: 0;
        font-size: 14px;
        box-sizing: border-box;
      `;
      formContainer.appendChild(createField('Batch Lifespan (Hours)', lifespanInput));

      // Show in Bottle Count checkbox (ONLY for PREP items)
      const bottleCheckboxContainer = document.createElement('div');
      bottleCheckboxContainer.style.cssText = `
        margin-bottom: 16px;
        padding: 12px;
        background: #e3f2fd;
        border: 2px solid #2196f3;
        border-radius: 4px;
      `;

      const bottleCheckboxLabel = document.createElement('label');
      bottleCheckboxLabel.style.cssText = `
        display: flex;
        align-items: center;
        gap: 10px;
        cursor: pointer;
        font-size: 13px;
        font-weight: 600;
        color: var(--gray-900);
      `;

      const bottleCheckbox = document.createElement('input');
      bottleCheckbox.type = 'checkbox';
      bottleCheckbox.id = 'editItemShowInBottle';
      bottleCheckbox.checked = item.showInBottleCount || false;
      bottleCheckbox.style.cssText = `
        width: 18px;
        height: 18px;
        cursor: pointer;
      `;

      const bottleCheckboxText = document.createElement('span');
      bottleCheckboxText.textContent = 'üìã Show in "BOTTLED & TO-GO PREP CHECK" section';
      
      const bottleCheckboxHint = document.createElement('div');
      bottleCheckboxHint.textContent = 'Check this to include item in the bottled/to-go PDF section (in addition to items with "BOTTLED" or "TO GO" in the name)';
      bottleCheckboxHint.style.cssText = `
        font-size: 11px;
        color: var(--gray-600);
        margin-left: 28px;
        margin-top: 4px;
        line-height: 1.4;
      `;

      bottleCheckboxLabel.appendChild(bottleCheckbox);
      bottleCheckboxLabel.appendChild(bottleCheckboxText);
      bottleCheckboxContainer.appendChild(bottleCheckboxLabel);
      bottleCheckboxContainer.appendChild(bottleCheckboxHint);
      formContainer.appendChild(bottleCheckboxContainer);
    }

    // Button container
    const btnContainer = document.createElement('div');
    btnContainer.style.cssText = `
      display: flex;
      gap: 10px;
      padding: 16px 20px;
      background: white;
      position: sticky;
      bottom: 0;
      z-index: 10;
      border-top: 2px solid #e0e0e0;
      margin-top: 24px;
    `;

    // Delete button (left side, red)
    const deleteBtn = document.createElement('button');
    deleteBtn.textContent = 'DELETE';
    deleteBtn.style.cssText = `
      flex: 0 0 auto;
      padding: 12px 20px;
      background: #dc3545;
      color: var(--white);
      border: none;
      cursor: pointer;
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      transition: background 0.2s;
    `;
    deleteBtn.onmouseover = () => deleteBtn.style.background = '#c82333';
    deleteBtn.onmouseout = () => deleteBtn.style.background = '#dc3545';
    deleteBtn.onclick = () => {
      overlay.remove();
      deleteInventoryItem(itemId);
    };

    // Spacer
    const spacer = document.createElement('div');
    spacer.style.flex = '1';

    // Cancel button
    const cancelBtn = document.createElement('button');
    cancelBtn.textContent = 'CANCEL';
    cancelBtn.style.cssText = `
      padding: 12px 20px;
      background: var(--gray-300);
      color: var(--gray-700);
      border: none;
      cursor: pointer;
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      transition: background 0.2s;
    `;
    cancelBtn.onmouseover = () => cancelBtn.style.background = 'var(--gray-400)';
    cancelBtn.onmouseout = () => cancelBtn.style.background = 'var(--gray-300)';
    cancelBtn.onclick = () => overlay.remove();

    // Save button
    const saveBtn = document.createElement('button');
    saveBtn.textContent = 'SAVE CHANGES';
    saveBtn.style.cssText = `
      padding: 12px 20px;
      background: var(--gray-700);
      color: var(--white);
      border: none;
      cursor: pointer;
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      transition: background 0.2s;
    `;
    saveBtn.onmouseover = () => saveBtn.style.background = 'var(--gray-900)';
    saveBtn.onmouseout = () => saveBtn.style.background = 'var(--gray-700)';
    saveBtn.onclick = async () => {
      const updatedData = {
        item_name: nameInput.value.trim(),
        vendor: vendorSelect.value,
        unit: unitInput.value.trim().toUpperCase(),
        par_level: parseFloat(parInput.value) || 0
      };

      // Add PREP-specific fields if present
      const itemTypeInput = document.getElementById('editItemType');
      const lifespanInput = document.getElementById('editItemLifespan');
      const bottleCheckbox = document.getElementById('editItemShowInBottle');

      if (itemTypeInput) {
        updatedData.item_type = itemTypeInput.value.trim();
      }
      if (lifespanInput && lifespanInput.value) {
        updatedData.batch_lifespan_hours = parseInt(lifespanInput.value) || null;
      }
      if (bottleCheckbox) {
        updatedData.show_in_bottle_count = bottleCheckbox.checked;
      }

      // Validate
      if (!updatedData.item_name) {
        showMessage('Item name is required', 'error');
        return;
      }

      overlay.remove();
      showLoading('Updating Item', 'Saving changes...');

      try {
        const { error } = await supabase
          .from('inventory_items')
          .update(updatedData)
          .eq('id', itemId);

        if (error) throw error;

        // Update local state
        const localItem = orderingSystemState.items.find(i => i.id === itemId);
        if (localItem) {
          localItem.itemName = updatedData.item_name;
          localItem.vendor = updatedData.vendor;
          localItem.unit = updatedData.unit;
          localItem.parLevel = updatedData.par_level;
          localItem.showInBottleCount = updatedData.show_in_bottle_count;
          if (updatedData.item_type) localItem.itemType = updatedData.item_type;
          if (updatedData.batch_lifespan_hours !== undefined) localItem.batchLifespan = updatedData.batch_lifespan_hours;
        }

        // Refresh displays
        renderInventoryList();
        renderStockCountList();
        renderPrepCountList();
        calculateUpcomingOrders();
        await refreshUpcomingOrdersUI();

        hideLoading();
        showMessage('‚úÖ Item updated successfully!', 'success');
      } catch (error) {
        hideLoading();
        showMessage(`Error updating item: ${error.message}`, 'error');
      }
    };

    btnContainer.appendChild(deleteBtn);
    btnContainer.appendChild(spacer);
    btnContainer.appendChild(cancelBtn);
    btnContainer.appendChild(saveBtn);

    formContainer.appendChild(btnContainer);

    // Assemble modal
    modal.appendChild(header);
    modal.appendChild(formContainer);
    overlay.appendChild(modal);

    // Add to page
    document.body.appendChild(overlay);

    // Focus first input
    nameInput.focus();
  }

  /**
   * Get all unique vendors from inventory
   */
  function getAllVendors() {
    const vendors = new Set();
    orderingSystemState.items.forEach(item => {
      if (item.vendor) vendors.add(item.vendor);
    });
    return Array.from(vendors).sort();
  }

  /**
   * Update item vendor
   */
  async function updateItemVendor(itemId, newVendor) {
    showLoading('Updating Vendor', 'Saving changes...');

    try {
      const { error } = await supabase
        .from('inventory_items')
        .update({ vendor: newVendor })
        .eq('id', itemId);

      if (error) throw error;

      // Update local state
      const item = orderingSystemState.items.find(i => i.id === itemId);
      if (item) {
        item.vendor = newVendor;
      }

      // Refresh displays
      renderInventoryList();
      renderStockCountList();
      renderPrepCountList();
      calculateUpcomingOrders();

      hideLoading();
      showMessage('‚úÖ Vendor updated!', 'success');
    } catch (error) {
      hideLoading();
      showMessage(`Error updating vendor: ${error.message}`, 'error');
    }
  }

  /**
   * Rename vendor (updates all items with that vendor)
   */
  async function renameVendor(oldVendorName, newVendorName) {
    if (!newVendorName || newVendorName.trim() === '') {
      showMessage('Vendor name cannot be empty!', 'error');
      return;
    }

    const itemsWithVendor = orderingSystemState.items.filter(i => i.vendor === oldVendorName);

    if (itemsWithVendor.length === 0) {
      showMessage('No items found for this vendor!', 'error');
      return;
    }

    showConfirm(`Rename "${oldVendorName}" to "${newVendorName}"? This will update ${itemsWithVendor.length} items.`, async () => {
      showLoading('Renaming Vendor', `Updating ${itemsWithVendor.length} items...`);

    try {
      const { error } = await supabase
        .from('inventory_items')
        .update({ vendor: newVendorName })
        .eq('vendor', oldVendorName);

      if (error) throw error;

      // Update local state
      itemsWithVendor.forEach(item => {
        item.vendor = newVendorName;
      });

      // Refresh displays
      renderInventoryList();
      renderStockCountList();
      renderPrepCountList();
      calculateUpcomingOrders();

      hideLoading();
      showMessage(`‚úÖ Renamed "${oldVendorName}" to "${newVendorName}" (${itemsWithVendor.length} items updated)`, 'success');
    } catch (error) {
      hideLoading();
      showMessage(`Error renaming vendor: ${error.message}`, 'error');
    }
    });
  }

  /**
   * Delete vendor (requires moving all items to another vendor first)
   */
  async function deleteVendor(vendorName) {
    const itemsWithVendor = orderingSystemState.items.filter(i => i.vendor === vendorName);

    if (itemsWithVendor.length > 0) {
      showMessage(`Cannot delete vendor "${vendorName}" - ${itemsWithVendor.length} items are still assigned to it. Move them to another vendor first.`, 'error');
      return;
    }

    showMessage(`Vendor "${vendorName}" has no items and can be removed. Simply rename it or ignore it.`, 'info');
  }

  /**
   * Show vendor management modal
   */
  function showVendorManagement() {
    const vendors = getAllVendors();
    const vendorList = vendors.map(vendor => {
      const itemCount = orderingSystemState.items.filter(i => i.vendor === vendor).length;
      return `
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #e0e0e0;">
          <div>
            <strong style="font-size: 15px;">${vendor}</strong>
            <span style="color: #666; font-size: 13px; margin-left: 8px;">(${itemCount} items)</span>
          </div>
          <div style="display: flex; gap: 8px;">
            <button onclick="promptRenameVendor('${vendor.replace(/'/g, "\\'")}')" style="
              background: #1e3c72;
              color: white;
              border: none;
              padding: 6px 12px;
              border-radius: 4px;
              cursor: pointer;
              font-size: 12px;
            ">Rename</button>
          </div>
        </div>
      `;
    }).join('');

    const modalHTML = `
      <div style="
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10000;
      " onclick="closeVendorManagement(event)">
        <div style="
          background: white;
          border-radius: 8px;
          padding: 24px;
          max-width: 600px;
          width: 90%;
          max-height: 80vh;
          overflow-y: auto;
        " onclick="event.stopPropagation()">
          <h2 style="margin: 0 0 20px 0; color: #1e3c72;">Vendor Management</h2>
          <div style="margin-bottom: 20px;">
            ${vendorList}
          </div>
          <button onclick="closeVendorManagement()" class="submit-btn" style="background: #666;">Close</button>
        </div>
      </div>
    `;

    const modalDiv = document.createElement('div');
    modalDiv.id = 'vendorManagementModal';
    modalDiv.innerHTML = modalHTML;
    document.body.appendChild(modalDiv);
  }

  /**
   * Close vendor management modal
   */
  function closeVendorManagement(event) {
    if (event && event.target !== event.currentTarget) return;
    const modal = document.getElementById('vendorManagementModal');
    if (modal) modal.remove();
  }

  /**
   * Prompt to rename vendor
   */
  function promptRenameVendor(vendorName) {
    showPrompt(`Rename vendor "${vendorName}" to:`, vendorName, (newName) => {
      if (newName && newName !== vendorName) {
        renameVendor(vendorName, newName);
        closeVendorManagement();
      }
    });
  }

  // ============================================
  // PRICE HISTORY EXPLORER
  // ============================================

  function initializePriceHistoryTab() {
    const startInput = document.getElementById('priceHistoryStartDate');
    const endInput = document.getElementById('priceHistoryEndDate');

    if (startInput && !startInput.value) {
      const defaultStart = formatPacificDate(addPacificDays(getPacificMidday(), -30));
      startInput.value = defaultStart;
    }

    if (endInput && !endInput.value) {
      endInput.value = getPacificDate();
    }

    refreshPriceHistoryControls();
    orderingSystemState.priceHistory.initialized = true;
  }

  function refreshPriceHistoryControls() {
    const vendorSelect = document.getElementById('priceHistoryVendor');
    const itemList = document.getElementById('priceHistoryItemList');
    if (!vendorSelect || !itemList) return;

    const vendors = Array.from(new Set(orderingSystemState.items.map(item => item.vendor || 'Other'))).sort((a, b) => a.localeCompare(b));
    const previouslySelectedVendor = vendorSelect.value || 'ALL';

    vendorSelect.innerHTML = '<option value="ALL">All Vendors</option>' + vendors.map(vendor => `<option value="${vendor}">${vendor}</option>`).join('');
    if ([...vendorSelect.options].some(opt => opt.value === previouslySelectedVendor)) {
      vendorSelect.value = previouslySelectedVendor;
    }

    const selectedIds = orderingSystemState.priceHistory.selectedItemIds;

    itemList.innerHTML = '';
    orderingSystemState.items
      .slice()
      .sort((a, b) => a.itemName.localeCompare(b.itemName))
      .forEach(item => {
        const row = document.createElement('label');
        row.className = 'price-history-item';
        row.dataset.vendor = item.vendor || 'Other';
        row.dataset.name = item.itemName.toLowerCase();
        row.style.cssText = 'display: flex; align-items: center; justify-content: space-between; gap: 8px; padding: 6px 8px; border-bottom: 1px solid var(--gray-200); font-size: 12px; background: white;';

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.value = item.id;
        checkbox.checked = selectedIds.has(item.id);
        checkbox.onchange = () => handlePriceHistoryItemToggle(item.id, checkbox.checked);
        row.appendChild(checkbox);

        const labelSpan = document.createElement('span');
        labelSpan.textContent = `${item.itemName} (${item.vendor || 'Other'})`;
        labelSpan.style.cssText = 'flex: 1; margin-left: 8px; color: var(--gray-800);';
        row.appendChild(labelSpan);

        itemList.appendChild(row);
      });

    handlePriceHistoryVendorChange();
    const searchInput = document.getElementById('priceHistoryItemSearch');
    handlePriceHistorySearch(searchInput ? searchInput.value : '');
  }

  function handlePriceHistoryItemToggle(itemId, checked) {
    const selected = orderingSystemState.priceHistory.selectedItemIds;
    if (checked) {
      selected.add(itemId);
    } else {
      selected.delete(itemId);
    }
  }

  function handlePriceHistoryVendorChange() {
    const vendorSelect = document.getElementById('priceHistoryVendor');
    const vendor = vendorSelect ? vendorSelect.value : 'ALL';
    const searchInput = document.getElementById('priceHistoryItemSearch');
    const query = searchInput ? searchInput.value : '';
    handlePriceHistorySearch(query, vendor);
  }

  function handlePriceHistorySearch(value, vendorOverride) {
    const query = (value || '').trim().toLowerCase();
    const vendorSelect = document.getElementById('priceHistoryVendor');
    const vendor = vendorOverride || (vendorSelect ? vendorSelect.value : 'ALL');

    const rows = document.querySelectorAll('#priceHistoryItemList .price-history-item');
    rows.forEach(row => {
      const matchesVendor = vendor === 'ALL' || row.dataset.vendor === vendor;
      const matchesText = !query || row.dataset.name.includes(query);
      row.style.display = matchesVendor && matchesText ? 'flex' : 'none';
    });
  }

  function priceHistorySelectAll() {
    const rows = document.querySelectorAll('#priceHistoryItemList .price-history-item');
    rows.forEach(row => {
      if (row.style.display === 'none') return;
      const checkbox = row.querySelector('input[type="checkbox"]');
      if (checkbox && !checkbox.checked) {
        checkbox.checked = true;
        handlePriceHistoryItemToggle(Number(checkbox.value), true);
      }
    });
  }

  function priceHistoryClearSelection() {
    const rows = document.querySelectorAll('#priceHistoryItemList .price-history-item input[type="checkbox"]');
    rows.forEach(checkbox => {
      checkbox.checked = false;
    });
    orderingSystemState.priceHistory.selectedItemIds.clear();
  }

  async function loadPriceHistory() {
    const statusEl = document.getElementById('priceHistoryStatus');
    const resultsContainer = document.getElementById('priceHistoryResults');
    if (!resultsContainer) return;

    if (statusEl) statusEl.textContent = 'Loading...';
    resultsContainer.innerHTML = '<p style="font-size: 12px; color: var(--gray-500);">Fetching price data...</p>';

    const startInput = document.getElementById('priceHistoryStartDate');
    const endInput = document.getElementById('priceHistoryEndDate');
    const vendorSelect = document.getElementById('priceHistoryVendor');

    const todayPacific = getPacificMidday();
    const defaultStart = formatPacificDate(addPacificDays(todayPacific, -30));
    const defaultEnd = formatPacificDate(todayPacific);

    const startDate = startInput?.value || defaultStart;
    const endDate = endInput?.value || defaultEnd;

    if (startInput && !startInput.value) startInput.value = startDate;
    if (endInput && !endInput.value) endInput.value = endDate;

    const vendorFilter = vendorSelect ? vendorSelect.value : 'ALL';

    let itemIds = Array.from(orderingSystemState.priceHistory.selectedItemIds);
    if (itemIds.length === 0 && vendorFilter !== 'ALL') {
      itemIds = orderingSystemState.items
        .filter(item => (item.vendor || 'Other') === vendorFilter)
        .map(item => item.id);
    }

    if (itemIds.length === 0) {
      if (statusEl) statusEl.textContent = 'Select at least one item or choose a vendor.';
      resultsContainer.innerHTML = '<p style="color: var(--gray-600); font-size: 12px;">Select inventory items to analyze price history.</p>';
      return;
    }

    try {
      const { data, error } = await supabase
        .from('invoice_items')
        .select('inventory_item_id, invoice_id, item_description, unit_price, detected_price, created_at')
        .in('inventory_item_id', itemIds)
        .order('created_at', { ascending: false })
        .limit(itemIds.length * 200);

      if (error) throw error;

      const startObj = parsePacificDate(startDate);
      const endObj = parsePacificDate(endDate);
      const endInclusive = endObj ? addPacificDays(endObj, 1) : null;

      const itemLookup = new Map(orderingSystemState.items.map(item => [item.id, item]));

      const invoiceIds = Array.from(new Set((data || []).map(row => row.invoice_id).filter(id => id != null)));
      const invoiceMap = new Map();
      if (invoiceIds.length) {
        const { data: invoiceRows, error: invoiceError } = await supabase
          .from('invoices')
          .select('id, invoice_date, vendor_name, vendor')
          .in('id', invoiceIds);

        if (!invoiceError && invoiceRows) {
          invoiceRows.forEach(row => invoiceMap.set(row.id, row));
        }
      }

      const grouped = new Map();
      (data || []).forEach(row => {
        const itemId = row.inventory_item_id;
        if (!itemId) return;

        const priceValue = row.unit_price ?? row.detected_price;
        if (priceValue === null || priceValue === undefined) return;

        const invoice = row.invoice_id != null ? invoiceMap.get(row.invoice_id) : null;
        const invoiceDate = invoice?.invoice_date || row.created_at;
        const invoiceDateObj = parsePacificDate(invoiceDate) || new Date(invoiceDate);

        if (startObj && invoiceDateObj < startObj) return;
        if (endInclusive && invoiceDateObj >= endInclusive) return;

        const entry = {
          price: Number(priceValue),
          invoiceDate,
          invoiceDateObj,
          vendor: invoice?.vendor_name || invoice?.vendor || (itemLookup.get(itemId)?.vendor || 'Unknown'),
          createdAt: row.created_at
        };

        if (!grouped.has(itemId)) grouped.set(itemId, []);
        grouped.get(itemId).push(entry);
      });

      const results = [];
      grouped.forEach((entries, itemId) => {
        entries.sort((a, b) => (b.invoiceDateObj?.getTime() || 0) - (a.invoiceDateObj?.getTime() || 0));
        const computedEntries = entries.map((entry, index) => {
          const prev = entries[index + 1] || null;
          const diff = prev ? entry.price - prev.price : null;
          const diffPct = diff != null && prev.price !== 0 ? (diff / prev.price) * 100 : null;
          return {
            ...entry,
            diff,
            diffPct,
            previousPrice: prev ? prev.price : null,
            previousDate: prev ? prev.invoiceDate : null
          };
        });

        const inventoryItem = itemLookup.get(itemId);
        results.push({
          itemId,
          item: inventoryItem,
          entries: computedEntries
        });
      });

      orderingSystemState.priceHistory.results = results;
      orderingSystemState.priceHistory.lastFetchParams = { startDate, endDate, vendorFilter, itemIds };

      renderPriceHistoryResults(results);

      if (statusEl) {
        const totalEntries = results.reduce((sum, group) => sum + group.entries.length, 0);
        statusEl.textContent = `${totalEntries} price point${totalEntries === 1 ? '' : 's'} across ${results.length} item${results.length === 1 ? '' : 's'}.`;
      }
    } catch (error) {
      console.error('Failed to load price history:', error);
      if (statusEl) statusEl.textContent = 'Failed to load price history.';
      resultsContainer.innerHTML = `<p style="color: #c62828; font-size: 12px;">Error: ${error.message}</p>`;
    }
  }

  function renderPriceHistoryResults(results) {
    const container = document.getElementById('priceHistoryResults');
    if (!container) return;

    if (!results || results.length === 0) {
      container.innerHTML = '<p style="color: var(--gray-600); font-size: 12px;">No pricing data found for the selected filters.</p>';
      return;
    }

    let html = '';
    results.forEach(group => {
      const itemName = group.item ? group.item.itemName : `Item #${group.itemId}`;
      const vendor = group.item ? (group.item.vendor || 'Other') : 'Unknown';

      html += `
        <div style="border: 2px solid var(--gray-300); margin-bottom: 18px; background: white;">
          <div style="padding: 12px 16px; background: var(--gray-900); color: white; display: flex; justify-content: space-between; align-items: center;">
            <div style="font-weight: 700; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;">${itemName}</div>
            <div style="font-size: 12px; color: rgba(255,255,255,0.8);">Vendor: ${vendor}</div>
          </div>
          <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
            <thead>
              <tr style="background: #f5f5f5; color: #444; text-transform: uppercase; font-size: 11px;">
                <th style="padding: 8px; border-bottom: 1px solid #e0e0e0; text-align: left;">Date</th>
                <th style="padding: 8px; border-bottom: 1px solid #e0e0e0; text-align: left;">Vendor</th>
                <th style="padding: 8px; border-bottom: 1px solid #e0e0e0; text-align: right;">Price</th>
                <th style="padding: 8px; border-bottom: 1px solid #e0e0e0; text-align: right;">Œî vs Prev</th>
              </tr>
            </thead>
            <tbody>
              ${group.entries.map((entry, idx) => {
                const rowColor = idx % 2 === 0 ? 'white' : '#fafafa';
                const arrow = entry.diff > 0 ? '‚ñ≤' : entry.diff < 0 ? '‚ñº' : '‚Ä¢';
                const color = entry.diff > 0 ? '#c62828' : entry.diff < 0 ? '#2e7d32' : 'var(--gray-500)';
                const diffLabel = entry.diff != null ? `${formatCurrency(Math.abs(entry.diff))}${entry.diffPct != null ? ` (${formatPercentage(Math.abs(entry.diffPct))})` : ''}` : '--';
                const diffHtml = entry.diff != null
                  ? `<span style="color: ${color}; font-weight: 600;">${arrow} ${diffLabel}</span>`
                  : '<span style="color: var(--gray-400);">--</span>';
                return `
                  <tr style="background: ${rowColor};">
                    <td style="padding: 8px; border-bottom: 1px solid #f0f0f0;">${formatPacificDateDisplay(entry.invoiceDateObj, { month: 'short', day: 'numeric', year: 'numeric' })}</td>
                    <td style="padding: 8px; border-bottom: 1px solid #f0f0f0;">${entry.vendor || 'Unknown'}</td>
                    <td style="padding: 8px; border-bottom: 1px solid #f0f0f0; text-align: right; font-weight: 600;">${formatCurrency(entry.price)}</td>
                    <td style="padding: 8px; border-bottom: 1px solid #f0f0f0; text-align: right;">${diffHtml}</td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        </div>
      `;
    });

    container.innerHTML = html;
  }

  // ============================================
  // PREP SHEET SYSTEM
  // ============================================

  /**
   * Check auto-print status and update disclaimer
   */
  async function checkAutoPrintStatus() {
    const statusDiv = document.getElementById('autoPrintStatus');
    if (!statusDiv) return;

    try {
      // Calculate 8-hour window (9pm to 4am) based on current time
      const now = new Date();
      const pacificNow = new Date(now.toLocaleString('en-US', { timeZone: 'America/Los_Angeles' }));
      const currentHour = pacificNow.getHours();

      let windowStart, windowEnd;

      if (currentHour >= 21) {
        // After 9pm - check from 9pm today to 4am tomorrow
        windowStart = new Date(pacificNow);
        windowStart.setHours(21, 0, 0, 0);

        windowEnd = new Date(windowStart);
        windowEnd.setDate(windowEnd.getDate() + 1); // Next day
        windowEnd.setHours(4, 0, 0, 0);
      } else if (currentHour < 4) {
        // Before 4am - check from 9pm yesterday to 4am today
        windowEnd = new Date(pacificNow);
        windowEnd.setHours(4, 0, 0, 0);

        windowStart = new Date(windowEnd);
        windowStart.setDate(windowStart.getDate() - 1); // Previous day
        windowStart.setHours(21, 0, 0, 0);
      } else {
        // Between 4am and 9pm - check LAST completed window (9pm yesterday to 4am today)
        windowEnd = new Date(pacificNow);
        windowEnd.setHours(4, 0, 0, 0);

        windowStart = new Date(windowEnd);
        windowStart.setDate(windowStart.getDate() - 1); // Previous day
        windowStart.setHours(21, 0, 0, 0);
      }

      console.log('Checking prep window:', windowStart.toLocaleString(), 'to', windowEnd.toLocaleString());

      // Check if any prep items were counted in the 8-hour window
      const { data: recentCounts, error } = await supabase
        .from('inventory_items')
        .select('item_name, last_counted_date')
        .or('vendor.eq.PREP,item_type.eq.prep')
        .gte('last_counted_date', windowStart.toISOString())
        .lte('last_counted_date', windowEnd.toISOString())
        .limit(5); // Get up to 5 items for display

      if (error) {
        console.error('Error checking auto-print status:', error);
        statusDiv.innerHTML = `
          <p style="text-align: center; padding: 12px; background: var(--gray-100); border-left: 4px solid var(--gray-500); color: var(--gray-700); font-size: 12px; border-radius: 0;">
            ‚ö†Ô∏è Unable to check auto-print status
          </p>
        `;
        return;
      }

      if (!recentCounts || recentCounts.length === 0) {
        // RED disclaimer: No counts detected
        statusDiv.innerHTML = `
          <div style="padding: 14px 16px; background: #fee2e2; border-left: 4px solid #dc2626; border-radius: 0;">
            <p style="color: #991b1b; font-size: 13px; margin: 0 0 8px 0; font-weight: 700;">
              ‚ö†Ô∏è NO AUTO-PRINT AT 4AM
            </p>
            <p style="color: #7f1d1d; font-size: 12px; margin: 0; line-height: 1.6;">
              No prep counts detected between 9pm and 4am. Please update stock counts above and click <strong>PRINT PREP LIST</strong> to get today's prep list.
            </p>
          </div>
        `;
      } else {
        // GREEN disclaimer: Auto-print ran successfully
        const itemNames = recentCounts.map(c => c.item_name).join(', ');
        const itemCount = recentCounts.length;

        statusDiv.innerHTML = `
          <div style="padding: 14px 16px; background: #d1fae5; border-left: 4px solid #059669; border-radius: 0;">
            <p style="color: #065f46; font-size: 13px; margin: 0 0 8px 0; font-weight: 700;">
              ‚úÖ PREP LIST AUTO-PRINTED AT 4AM
            </p>
            <p style="color: #047857; font-size: 12px; margin: 0; line-height: 1.6;">
              ${itemCount} prep item${itemCount !== 1 ? 's' : ''} counted overnight (${itemNames}${itemCount === 5 ? ', ...' : ''}). <strong>Check the printer</strong> for today's auto-generated prep list.
            </p>
          </div>
        `;
      }

    } catch (error) {
      console.error('Error in checkAutoPrintStatus:', error);
      statusDiv.innerHTML = `
        <p style="text-align: center; padding: 12px; background: var(--gray-100); border-left: 4px solid var(--gray-500); color: var(--gray-700); font-size: 12px; border-radius: 0;">
          ‚ö†Ô∏è Error checking auto-print status
        </p>
      `;
    }
  }

  /**
   * Refresh prep sheet with current recommendations
   */
  async function refreshPrepSheet() {
    console.log('Refreshing prep sheet...');

    // Check auto-print status when refreshing
    checkAutoPrintStatus();
    const prepItems = orderingSystemState.items.filter(item => item.vendor === 'PREP' || item.itemType === 'prep');

    if (prepItems.length === 0) {
      document.getElementById('prepRecommendationsList').innerHTML = `
        <div style="text-align: center; padding: 40px; background: #f8f9fa; border-radius: 8px;">
          <p style="color: #666; font-size: 16px;">No prep items found. Add prep items to get started!</p>
        </div>
      `;
      return;
    }

    // Fetch consumption data for all prep items
    const todayPacificDate = getPacificMidday();
    const today = formatPacificDate(todayPacificDate);
    const sevenDaysAgoDate = addPacificDays(todayPacificDate, -7);
    const sevenDaysAgo = formatPacificDate(sevenDaysAgoDate);

    try {
      const { data: consumptionData, error } = await supabase
        .from('prep_consumption_log')
        .select('*')
        .gte('count_date', sevenDaysAgo)
        .lte('count_date', today);

      if (error) throw error;

      // Calculate recommendations for each prep item
      const recommendations = prepItems
        .map(item => calculatePrepRecommendation(item, consumptionData))
        .filter(rec => rec !== null); // Filter out null returns (e.g., line cooks prep with good stock)

      // Sort by priority (lowest stock % first, then by consumption rate)
      recommendations.sort((a, b) => {
        if (a.stockPercentage !== b.stockPercentage) {
          return a.stockPercentage - b.stockPercentage;
        }
        return (b.avgConsumptionRate || 0) - (a.avgConsumptionRate || 0);
      });

      // Store recommendations for PDF generation
      orderingSystemState.prepRecommendations = recommendations;

    } catch (error) {
      console.error('Error refreshing prep sheet:', error);
      showMessage(`Error loading prep data: ${error.message}`, 'error');
    }
  }

  /**
   * Calculate recommendation for a single prep item
   */
  function calculatePrepRecommendation(item, consumptionData) {
    // Filter consumption data for this item
    const itemConsumption = consumptionData.filter(c => c.item_id === item.id);

    // Calculate average consumption rate
    let avgConsumptionRate = 0;
    let totalConsumption = 0;
    if (itemConsumption.length > 0) {
      totalConsumption = itemConsumption.reduce((sum, c) => sum + (c.consumption_amount || 0), 0);
      avgConsumptionRate = totalConsumption / itemConsumption.length;
    }

    // Calculate stock percentage (current / par)
    const stockPercentage = item.parLevel > 0 ? (item.currentStock / item.parLevel) * 100 : 0;

    // Check flags from database
    const isLineCooksPrep = item.lineCooksPrep || false;
    const isNotMadeDaily = item.notMadeDaily || false;

    // Determine recommendation amount
    let recommendedAmount = 0;
    let priority = 'low';
    let reasoning = '';

    if (isNotMadeDaily) {
      // Special logic for items not made daily - use percentage-based thresholds
      if (item.currentStock === 0) {
        recommendedAmount = Math.ceil(item.parLevel);
        priority = 'urgent';
        reasoning = `Out of stock - Not made daily, check with manager first`;
      } else if (stockPercentage < 30) {
        // Very low stock - urgent
        recommendedAmount = Math.ceil(item.parLevel - item.currentStock);
        priority = 'urgent';
        reasoning = `Critical low (${stockPercentage.toFixed(0)}%) - Not made daily, check with manager`;
      } else if (stockPercentage < 50) {
        // Low stock - high priority
        recommendedAmount = Math.ceil(item.parLevel - item.currentStock);
        priority = 'high';
        reasoning = `Low stock (${stockPercentage.toFixed(0)}%) - Not made daily, check with manager`;
      } else if (stockPercentage < 70) {
        // Medium stock
        recommendedAmount = Math.ceil(item.parLevel - item.currentStock);
        priority = 'medium';
        reasoning = `Stock at ${stockPercentage.toFixed(0)}% - Not made daily, check with manager`;
      } else {
        // Stock is good
        priority = 'low';
        reasoning = `Stock good (${stockPercentage.toFixed(0)}%) - Not made daily`;
      }
    } else if (isLineCooksPrep) {
      // Special logic for line cooks prep items (Chili Oil, Iskender Sauce)
      // Only show in prep sheet when stock is low
      if (item.currentStock === 0) {
        recommendedAmount = Math.max(item.parLevel, Math.ceil(avgConsumptionRate * 2));
        priority = 'urgent';
        reasoning = 'Out of stock - line cooks need to prep';
      } else if (stockPercentage < 50) {
        recommendedAmount = Math.ceil(item.parLevel - item.currentStock);
        priority = 'high';
        reasoning = `Stock below 50% (${stockPercentage.toFixed(0)}%) - line cooks prep`;
      } else if (stockPercentage < 75) {
        recommendedAmount = Math.ceil(item.parLevel - item.currentStock);
        priority = 'medium';
        reasoning = `Stock at ${stockPercentage.toFixed(0)}% - line cooks prep`;
      } else {
        // Don't show in prep sheet if stock is good
        return null;
      }
    } else {
      // Standard logic for regular prep items
      if (item.currentStock === 0) {
        // Out of stock - urgent
        recommendedAmount = Math.max(item.parLevel, Math.ceil(avgConsumptionRate * 2)); // At least par or 2x consumption
        priority = 'urgent';
        reasoning = 'Out of stock - make immediately';
      } else if (stockPercentage < 50) {
        // Low stock - high priority
        recommendedAmount = Math.ceil(item.parLevel - item.currentStock);
        priority = 'high';
        reasoning = `Stock below 50% (${stockPercentage.toFixed(0)}%)`;
      } else if (stockPercentage < 75 && avgConsumptionRate > 0) {
        // Medium stock but consuming - medium priority
        recommendedAmount = Math.ceil(avgConsumptionRate * 1.5);
        priority = 'medium';
        reasoning = `Stock at ${stockPercentage.toFixed(0)}%, consuming ${avgConsumptionRate.toFixed(1)}/session`;
      } else {
        // Stock is good
        priority = 'low';
        reasoning = `Stock good (${stockPercentage.toFixed(0)}%)`;
      }
    }

    return {
      id: item.id,
      itemName: item.itemName,
      currentStock: item.currentStock,
      parLevel: item.parLevel,
      unit: item.unit,
      stockPercentage,
      avgConsumptionRate,
      recommendedAmount,
      priority,
      reasoning,
      urgent: item.urgent || false,
      lineCooksPrep: item.lineCooksPrep || false,
      notMadeDaily: item.notMadeDaily || false,
      lastCountedDate: item.lastCountedDate,
      countedBy: item.countedBy,
      storageLocation: item.storageLocation,
      showInBottleCount: item.showInBottleCount || false
    };
  }

  /**
   * Render summary statistics (grayscale styling)
   */
  function renderPrepSummaryStats(recommendations) {
    const urgent = recommendations.filter(r => r.priority === 'urgent').length;
    const high = recommendations.filter(r => r.priority === 'high').length;
    const medium = recommendations.filter(r => r.priority === 'medium').length;
    const low = recommendations.filter(r => r.priority === 'low').length;

    const totalToPrepare = recommendations.filter(r => r.recommendedAmount > 0).length;

    document.getElementById('prepSummaryStats').innerHTML = `
      <div style="background: #f5f5f5; padding: 16px; border-radius: 0; border: 2px solid #212121;">
        <div style="font-size: 24px; font-weight: 700; color: #212121;">${urgent}</div>
        <div style="font-size: 11px; color: #666; margin-top: 4px; text-transform: uppercase; letter-spacing: 0.5px;">Urgent Items</div>
      </div>
      <div style="background: #f5f5f5; padding: 16px; border-radius: 0; border: 2px solid #424242;">
        <div style="font-size: 24px; font-weight: 700; color: #424242;">${high}</div>
        <div style="font-size: 11px; color: #666; margin-top: 4px; text-transform: uppercase; letter-spacing: 0.5px;">High Priority</div>
      </div>
      <div style="background: #f5f5f5; padding: 16px; border-radius: 0; border: 2px solid #666;">
        <div style="font-size: 24px; font-weight: 700; color: #666;">${medium}</div>
        <div style="font-size: 11px; color: #666; margin-top: 4px; text-transform: uppercase; letter-spacing: 0.5px;">Medium Priority</div>
      </div>
      <div style="background: #f5f5f5; padding: 16px; border-radius: 0; border: 2px solid #2196F3;">
        <div style="font-size: 24px; font-weight: 700; color: #2196F3;">${totalToPrepare}</div>
        <div style="font-size: 11px; color: #666; margin-top: 4px; text-transform: uppercase; letter-spacing: 0.5px;">Total to Prepare</div>
      </div>
    `;
  }

  /**
   * Render prep recommendations list
   */
  function renderPrepRecommendations(recommendations) {
    const container = document.getElementById('prepRecommendationsList');

    // Store recommendations for print/PDF
    orderingSystemState.prepRecommendations = recommendations;

    if (recommendations.length === 0) {
      container.innerHTML = `
        <div style="text-align: center; padding: 40px;">
          <p style="color: #666;">All prep items are well-stocked! üéâ</p>
        </div>
      `;
      return;
    }

    // Group by priority and sort by stock percentage (lowest to highest)
    // FIRST: Filter MAKE FIRST items (urgent flag set)
    const makeFirst = recommendations.filter(r => r.urgent === true)
      .sort((a, b) => a.stockPercentage - b.stockPercentage);

    // SECOND: Filter LINE COOKS PREP items (lineCooksPrep flag set, exclude urgent items)
    const lineCooksPrep = recommendations.filter(r => r.lineCooksPrep === true && r.urgent !== true)
      .sort((a, b) => a.stockPercentage - b.stockPercentage);

    // THEN: Regular priority groups (exclude urgent and lineCooksPrep flagged items)
    const urgent = recommendations.filter(r => r.priority === 'urgent' && r.urgent !== true && r.lineCooksPrep !== true)
      .sort((a, b) => a.stockPercentage - b.stockPercentage);
    const high = recommendations.filter(r => r.priority === 'high' && r.urgent !== true && r.lineCooksPrep !== true)
      .sort((a, b) => a.stockPercentage - b.stockPercentage);
    const medium = recommendations.filter(r => r.priority === 'medium' && r.urgent !== true && r.lineCooksPrep !== true)
      .sort((a, b) => a.stockPercentage - b.stockPercentage);
    const low = recommendations.filter(r => r.priority === 'low' && r.urgent !== true && r.lineCooksPrep !== true)
      .sort((a, b) => a.stockPercentage - b.stockPercentage);

    let html = '';

    // Render MAKE FIRST category at the very top
    if (makeFirst.length > 0) {
      html += renderPriorityGroup('MAKE FIRST', makeFirst, 'makeFirst');
    }

    // Render LINE COOKS PREP category second
    if (lineCooksPrep.length > 0) {
      html += renderPriorityGroup('LINE COOKS PREP', lineCooksPrep, 'lineCooksPrep');
    }

    // Render each priority group with grayscale styling (matching PDF)
    if (urgent.length > 0) {
      html += renderPriorityGroup('URGENT - Out of Stock', urgent, 'urgent');
    }
    if (high.length > 0) {
      html += renderPriorityGroup('HIGH PRIORITY - Low Stock', high, 'high');
    }
    if (medium.length > 0) {
      html += renderPriorityGroup('MEDIUM PRIORITY', medium, 'medium');
    }
    if (low.length > 0) {
      html += renderPriorityGroup('LOW PRIORITY - Stock Good', low, 'low');
    }

    container.innerHTML = html;
  }

  /**
   * Render a priority group of recommendations (matching PDF styling)
   */
  function renderPriorityGroup(title, items, priority) {
    // LOW PRIORITY: compact list format
    if (priority === 'low') {
      const itemList = items.map(item =>
        `<span style="display: inline-block; width: 32%; padding: 4px 6px; font-size: 11px; color: #666;">${item.itemName} (${item.stockPercentage.toFixed(0)}%)</span>`
      ).join('');

      return `
        <div style="margin-bottom: 20px;">
          <div style="
            background: #424242;
            color: white;
            padding: 10px 14px;
            font-size: 13px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            border-radius: 0;
          ">
            ${title} (${items.length} items)
          </div>
          <div style="background: white; border: 2px solid #424242; border-top: none; padding: 12px 14px; display: flex; flex-wrap: wrap;">
            ${itemList}
          </div>
        </div>
      `;
    }

    // URGENT, HIGH, MEDIUM: full table format
    const headerBg = priority === 'makeFirst' ? '#dc0000' : priority === 'lineCooksPrep' ? '#4a148c' : priority === 'urgent' ? '#212121' : '#424242';

    const itemsHTML = items.map(item => {
      const lastCountStr = item.lastCountedDate ? formatRelativeTime(item.lastCountedDate) : 'Never';
      const isOut = item.currentStock === 0;
      const stockStatus = isOut ? 'OUT' : `${item.currentStock} ${item.unit}`;

      return `
        <div style="
          display: grid;
          grid-template-columns: 2fr 1fr 1fr 1fr 0.75fr 2fr;
          gap: 8px;
          padding: 12px 16px;
          border-bottom: 1px solid #e0e0e0;
          align-items: center;
        ">
          <div>
            <div style="font-weight: 700; font-size: 13px; color: #212121; text-transform: uppercase; letter-spacing: 0.3px;">${item.itemName}</div>
            <div style="font-size: 10px; color: #999; margin-top: 2px;">Last count: ${lastCountStr}</div>
          </div>
          <div style="text-align: center;">
            <div style="font-weight: 700; font-size: 14px; color: ${isOut ? '#d32f2f' : '#212121'};">${stockStatus}</div>
            <div style="font-size: 9px; color: #666; text-transform: uppercase; margin-top: 2px;">Current</div>
          </div>
          <div style="text-align: center;">
            <div style="font-weight: 700; font-size: 14px; color: #212121;">${item.parLevel} ${item.unit}</div>
            <div style="font-size: 9px; color: #666; text-transform: uppercase; margin-top: 2px;">Par</div>
          </div>
          <div style="text-align: center;">
            <div style="font-weight: 700; font-size: 16px; color: #2196F3;">${item.recommendedAmount > 0 ? item.recommendedAmount : '‚Äî'}</div>
            <div style="font-size: 9px; color: #666; text-transform: uppercase; margin-top: 2px;">Make</div>
          </div>
          <div style="text-align: center;">
            <div style="font-weight: 700; font-size: 14px; color: #666;">${item.unit}</div>
            <div style="font-size: 9px; color: #666; text-transform: uppercase; margin-top: 2px;">Unit</div>
          </div>
          <div style="font-size: 11px; color: #666; font-style: italic;">
            ${item.reasoning}
          </div>
        </div>
      `;
    }).join('');

    return `
      <div style="margin-bottom: 20px;">
        <div style="
          background: ${headerBg};
          color: white;
          padding: 10px 14px;
          font-size: 13px;
          font-weight: 700;
          text-transform: uppercase;
          letter-spacing: 0.8px;
          border-radius: 0;
        ">
          ${title} (${items.length} items)
        </div>
        <div style="background: white; border: 2px solid ${headerBg}; border-top: none;">
          <!-- Header Row -->
          <div style="
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 0.75fr 2fr;
            gap: 8px;
            padding: 8px 16px;
            background: #f5f5f5;
            border-bottom: 2px solid #e0e0e0;
            font-size: 10px;
            font-weight: 700;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
          ">
            <div>ITEM NAME</div>
            <div style="text-align: center;">CURRENT</div>
            <div style="text-align: center;">PAR</div>
            <div style="text-align: center;">MAKE</div>
            <div style="text-align: center;">UNIT</div>
            <div>REASON</div>
          </div>
          ${itemsHTML}
        </div>
      </div>
    `;
  }

  /**
   * Calculate estimated height for all PDF content
   */
  function calculateContentHeight(sections, customNotesHeight) {
    let totalHeight = 0;
    
    // Header: 0.4" (fixed)
    totalHeight += 0.4;
    
    // Custom notes (if any)
    totalHeight += customNotesHeight;
    
    // Each section
    sections.forEach(section => {
      if (!section.items || section.items.length === 0) return;
      
      // Section header: 0.18"
      totalHeight += 0.18;
      
      if (section.isCompact) {
        // Compact format: header gap + (items * lineHeight) + bottom margin
        const itemsPerColumn = Math.ceil(section.items.length / section.columns);
        totalHeight += 0.08 + (itemsPerColumn * 0.20) + 0.08;
      } else {
        // Table format: header + (rows * avgRowHeight) + bottom margin
        const avgRowHeight = 0.21; // 0.18 minCellHeight + 0.03 padding
        totalHeight += (section.items.length * avgRowHeight) + 0.06;
      }
    });
    
    // Footer: 0.4"
    totalHeight += 0.4;
    
    return totalHeight;
  }

  /**
   * Calculate dynamic scale factor to fit content on one page
   */
  function calculateScaleFactor(estimatedHeight) {
    const MAX_PAGE_HEIGHT = 9.5; // Usable page height (0.7" to 10.2")
    
    if (estimatedHeight <= MAX_PAGE_HEIGHT) {
      return 1.0; // No scaling needed
    }
    
    // Calculate scale factor, but don't go below 0.70 (70%) for readability
    const scaleFactor = MAX_PAGE_HEIGHT / estimatedHeight;
    return Math.max(0.70, Math.min(1.0, scaleFactor));
  }

  /**
   * Generate prep sheet PDF with compact grayscale design
   */
  async function generatePrepSheetPDF() {
    // First refresh the prep sheet to get latest data
    await refreshPrepSheet();

    const recommendations = orderingSystemState.prepRecommendations;
    if (!recommendations || recommendations.length === 0) {
      showMessage('No prep recommendations to export', 'warning');
      return;
    }

    showMessage('Generating prep sheet PDF...', 'info');

    try {
      if (typeof jspdf === 'undefined' || typeof jspdf.jsPDF === 'undefined') {
        throw new Error('jsPDF library not loaded. Please refresh the page.');
      }

      const { jsPDF } = jspdf;
      const doc = new jsPDF({ orientation: 'portrait', unit: 'in', format: 'letter' });

      const jaynaBlue = [33, 150, 243];
      const darkGray = [66, 66, 66];
      const black = [33, 33, 33];
      const redText = [220, 38, 38];

      // Date logic
      const now = new Date();
      const currentHour = getPacificHour(now);
      const baseDate = getPacificMidday(now);
      const prepDate = currentHour !== null && currentHour >= 20 ? addPacificDays(baseDate, 1) : baseDate;
      const dateStr = formatPacificDateDisplay(prepDate, { weekday: 'long', month: '2-digit', day: '2-digit', year: 'numeric' }).toUpperCase();
      const timeStr = formatPacificDateDisplay(now, { hour: '2-digit', minute: '2-digit' });

      // Filter items - separate bottles from to-go
      const allBottleAndToGo = recommendations.filter(r => {
        const nameMatch = isBottledOrToGoItem(r.itemName);
        const checkboxMatch = r.showInBottleCount === true;
        return nameMatch || checkboxMatch;
      });

      const bottleItems = allBottleAndToGo.filter(r => {
        const name = (r.itemName || '').toLowerCase();
        const isToGo = name.includes('to go') || name.includes('to-go');
        return !isToGo; // Only bottles, not to-go
      });

      const toGoItems = allBottleAndToGo.filter(r => {
        const name = (r.itemName || '').toLowerCase();
        return name.includes('to go') || name.includes('to-go');
      });

      const prepItems = recommendations.filter(r => {
        const nameMatch = isBottledOrToGoItem(r.itemName);
        const checkboxMatch = r.showInBottleCount === true;
        return !nameMatch && !checkboxMatch;
      });

      const needsToBePrepped = (item) => item.currentStock === 0 || item.stockPercentage < 100 || item.recommendedAmount > 0;

      const lineCooksPrep = prepItems.filter(r => r.lineCooksPrep === true && needsToBePrepped(r))
        .sort((a, b) => a.stockPercentage - b.stockPercentage);

      const makeFirst = prepItems.filter(r => r.urgent === true && !r.lineCooksPrep && needsToBePrepped(r))
        .sort((a, b) => a.stockPercentage - b.stockPercentage);

      const urgent = prepItems.filter(r => r.priority === 'urgent' && !r.urgent && !r.lineCooksPrep);

      // COMBINED SECTION: MAKE FIRST + URGENT
      const makeFirstAndUrgent = [...makeFirst, ...urgent];
      const makeFirstCount = makeFirst.length;
      const urgentCount = urgent.length;
      const combinedTitle = `MAKE FIRST (${makeFirstCount}) | URGENT (${urgentCount})`;

      const high = prepItems.filter(r => r.priority === 'high' && !r.urgent && !r.lineCooksPrep);
      const medium = prepItems.filter(r => r.priority === 'medium' && !r.urgent && !r.lineCooksPrep);

      const lowPriority = prepItems.filter(r => r.priority === 'low' && !r.urgent && !r.lineCooksPrep);

      // COMBINED SECTION: LOW PRIORITY + LINE COOKS (with line cooks at end, in blue)
      const lowAndLineCooks = [...lowPriority, ...lineCooksPrep];
      const lowAndLineCooksTitle = `LOW PRIORITY (${lowPriority.length}) | LINE COOKS (${lineCooksPrep.length})`;

      const scaleFactor = 1.0; // Fixed scale for new design

      // Header
      doc.setFontSize(14);
      doc.setFont('helvetica', 'bold');
      doc.setTextColor(black[0], black[1], black[2]);
      doc.text('PREP SHEET - ' + dateStr, 4.25, 0.7, { align: 'center' });

      doc.setDrawColor(jaynaBlue[0], jaynaBlue[1], jaynaBlue[2]);
      doc.setLineWidth(0.02);
      doc.line(0.5, 0.78, 8, 0.78);

      doc.setFontSize(7);
      doc.setFont('helvetica', 'normal');
      doc.setTextColor(102, 102, 102);
      doc.text('Generated ' + timeStr, 4.25, 0.95, { align: 'center' });

      // Start Y position
      let yPos = 1.05;

      // MANDATORY NOTE (dark red box)
      yPos = renderMandatoryNote(doc, yPos, scaleFactor);
      yPos += 0.1;

      // BOTTLE COUNT + TO GO PREP (separate sections with divider)
      if (bottleItems.length > 0 || toGoItems.length > 0) {
        const title = `BOTTLE COUNT (${bottleItems.length}) & TO-GO PREP (${toGoItems.length})`;
        yPos = renderBottleAndToGoSection(doc, title, bottleItems, toGoItems, yPos, jaynaBlue, scaleFactor);
      }

      // MAKE FIRST + URGENT COMBINED
      if (makeFirstAndUrgent.length > 0) {
        yPos = renderPrepPDFSection(doc, combinedTitle, makeFirstAndUrgent, yPos, redText, scaleFactor, false);
      }

      // HIGH PRIORITY
      if (high.length > 0) {
        yPos = renderPrepPDFSection(doc, `HIGH PRIORITY (${high.length})`, high, yPos, darkGray, scaleFactor, false);
      }

      // MEDIUM PRIORITY
      if (medium.length > 0) {
        yPos = renderPrepPDFSection(doc, `MEDIUM PRIORITY (${medium.length})`, medium, yPos, darkGray, scaleFactor, false);
      }

      // LOW PRIORITY + LINE COOKS COMBINED (4-column layout)
      if (lowAndLineCooks.length > 0) {
        yPos = renderLowAndLineCooksSection(doc, lowAndLineCooksTitle, lowAndLineCooks, yPos, darkGray, scaleFactor);
      }

      // Footer
      if (yPos < 10) {
        doc.setDrawColor(224, 224, 224);
        doc.line(0.5, 10.2, 8, 10.2);
        doc.setFontSize(6);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(153, 153, 153);
        doc.text('MISTAKES HAPPEN, PLEASE USE YOUR BRAIN WHEN READING THIS LIST AND', 4.25, 10.32, { align: 'center' });
        doc.text('DOUBLE CHECK BY CLARIFYING WITH YOUR MANAGER IF YOU DOUBT ANYTHING.', 4.25, 10.40, { align: 'center' });

        doc.setFontSize(5.5);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(170, 170, 170);
        doc.text('PREP GENERATION FLOW CREATED AND DESIGNED BY DEMETRI GREGORAKIS', 4.25, 10.52, { align: 'center' });
      }

      // SEPARATE PAGE: LINE COOKS PREP (large 18pt text)
      if (lineCooksPrep.length > 0) {
        renderLineCooksPage(doc, lineCooksPrep, prepDate);
      }

      // CATERING ORDERS PAGES (page 2/3)
      await fetchAndRenderCateringOrders(doc, prepDate);

      // Save PDF
      const filename = `Prep_Sheet_${dateStr.replace(/\//g, '-')}.pdf`;
      doc.save(filename);

      showMessage('Prep sheet PDF generated successfully!', 'success');

      return doc;

    } catch (error) {
      console.error('PDF generation error:', error);
      showMessage('Failed to generate PDF: ' + error.message, 'error');
      throw error;
    }
  }

  /**
   * Print all prep items in simple 3-column format and email to printer
   */
  async function printAllPrepItems() {
    // Get button reference for visual feedback
    const button = document.getElementById('printItemListButton');
    const originalBg = button?.style.background || '#4a4a4a';
    const originalText = button?.textContent || 'PRINT ITEM LIST';

    showMessage('Generating and sending item list to printer...', 'info');

    try {
      // Get all prep items
      const prepItems = orderingSystemState.items.filter(item =>
        item.vendor === 'PREP' || item.itemType === 'prep'
      );

      if (prepItems.length === 0) {
        showMessage('No prep items to print', 'warning');
        return;
      }

      if (typeof jspdf === 'undefined' || typeof jspdf.jsPDF === 'undefined') {
        throw new Error('jsPDF library not loaded. Please refresh the page.');
      }

      // Generate PDF
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'letter' });

      // Title
      doc.setFontSize(20);
      doc.setFont('helvetica', 'bold');
      doc.text('PREP ITEMS', 40, 50);

      // Timestamp
      const now = new Date();
      const dateStr = now.toLocaleDateString('en-US', {
        month: '2-digit',
        day: '2-digit',
        year: 'numeric'
      });
      const timeStr = now.toLocaleTimeString('en-US', {
        hour: '2-digit',
        minute: '2-digit',
        hour12: true
      });

      doc.setFontSize(10);
      doc.setFont('helvetica', 'normal');
      doc.text(`Generated on: ${dateStr} at: ${timeStr}`, 40, 70);

      // Prepare table data
      const tableData = [];

      prepItems.forEach(item => {
        const unit = item.unit || 'units';

        // Handle multi-location items
        if (item.hasMultipleLocations && item.locationCounts) {
          // Calculate total current stock across all locations
          let totalStock = 0;
          Object.values(item.locationCounts).forEach(locationData => {
            totalStock += locationData.currentStock || 0;
          });

          tableData.push([
            item.itemName,
            `${totalStock} - ${unit}`,
            `${item.parLevel || 0} - ${unit}`
          ]);
        } else {
          // Single location item
          tableData.push([
            item.itemName,
            `${item.currentStock || 0} - ${unit}`,
            `${item.parLevel || 0} - ${unit}`
          ]);
        }
      });

      // Generate table
      doc.autoTable({
        startY: 90,
        head: [['Item Name', 'Current Count', 'Par']],
        body: tableData,
        theme: 'grid',
        headStyles: {
          fillColor: [26, 26, 26],
          fontSize: 12,
          fontStyle: 'bold',
          halign: 'left'
        },
        styles: {
          fontSize: 10,
          cellPadding: 8
        },
        columnStyles: {
          0: { cellWidth: 300 }, // Item Name
          1: { cellWidth: 100, halign: 'center' }, // Current Count
          2: { cellWidth: 100, halign: 'center' }  // Par
        },
        margin: { left: 40, right: 40 }
      });

      // Add page numbers after table is complete (ensures correct total page count)
      const totalPages = doc.internal.getNumberOfPages();
      for (let i = 1; i <= totalPages; i++) {
        doc.setPage(i);
        doc.setFontSize(9);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(100);
        doc.text(
          `Page ${i} of ${totalPages}`,
          doc.internal.pageSize.getWidth() / 2,
          doc.internal.pageSize.getHeight() - 20,
          { align: 'center' }
        );
      }

      // Get PDF as base64
      const pdfBase64 = doc.output('datauristring').split(',')[1];
      const filename = `Prep_Items_${dateStr.replace(/\//g, '-')}.pdf`;

      // Send via backend Gmail API
      const response = await fetch('/api/send-prep-sheet-email', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          pdfBase64: pdfBase64,
          filename: filename,
          subject: `Prep Item List - ${dateStr}`,
          toEmail: 'GSS4168CTJJA73@print.epsonconnect.com'
        })
      });

      const result = await response.json();

      if (!response.ok) {
        throw new Error(result.error || 'Failed to send email');
      }

      showMessage('‚úÖ Item list sent to printer successfully!', 'success');

      // Visual feedback: Turn button green with "SENT!" text
      if (button) {
        button.style.background = '#059669'; // Success green
        button.textContent = '‚úì SENT!';

        // Reset after 3 seconds
        setTimeout(() => {
          button.style.background = originalBg;
          button.textContent = originalText;
        }, 3000);
      }

    } catch (error) {
      console.error('Print all prep items error:', error);
      showMessage('Failed to send to printer: ' + error.message, 'error');
    }
  }

  /**
   * Email prep sheet PDF to Epson printer
   */
  async function emailPrepSheetToPrinter() {
    // First refresh the prep sheet to get latest data
    await refreshPrepSheet();

    const recommendations = orderingSystemState.prepRecommendations;
    if (!recommendations || recommendations.length === 0) {
      showMessage('No prep recommendations to send', 'warning');
      return;
    }

    // Get button reference for visual feedback
    const button = document.getElementById('emailPrepButton');
    const originalBg = button?.style.background || '#2196f3';
    const originalText = button?.textContent || 'PRINT PREP LIST';

    showMessage('Generating and sending prep sheet to printer...', 'info');

    try {
      if (typeof jspdf === 'undefined' || typeof jspdf.jsPDF === 'undefined') {
        throw new Error('jsPDF library not loaded. Please refresh the page.');
      }

      const { jsPDF } = jspdf;
      const doc = new jsPDF({ orientation: 'portrait', unit: 'in', format: 'letter' });

      const jaynaBlue = [33, 150, 243];
      const darkGray = [66, 66, 66];
      const black = [33, 33, 33];
      const redText = [220, 38, 38];

      // Date logic
      const now = new Date();
      const currentHour = getPacificHour(now);
      const baseDate = getPacificMidday(now);
      const prepDate = currentHour !== null && currentHour >= 20 ? addPacificDays(baseDate, 1) : baseDate;
      const dateStr = formatPacificDateDisplay(prepDate, { weekday: 'long', month: '2-digit', day: '2-digit', year: 'numeric' }).toUpperCase();
      const timeStr = formatPacificDateDisplay(now, { hour: '2-digit', minute: '2-digit' });

      // Filter items - separate bottles from to-go
      const allBottleAndToGo = recommendations.filter(r => {
        const nameMatch = isBottledOrToGoItem(r.itemName);
        const checkboxMatch = r.showInBottleCount === true;
        return nameMatch || checkboxMatch;
      });

      const bottleItems = allBottleAndToGo.filter(r => {
        const name = (r.itemName || '').toLowerCase();
        const isToGo = name.includes('to go') || name.includes('to-go');
        return !isToGo; // Only bottles, not to-go
      });

      const toGoItems = allBottleAndToGo.filter(r => {
        const name = (r.itemName || '').toLowerCase();
        return name.includes('to go') || name.includes('to-go');
      });

      const prepItems = recommendations.filter(r => {
        const nameMatch = isBottledOrToGoItem(r.itemName);
        const checkboxMatch = r.showInBottleCount === true;
        return !nameMatch && !checkboxMatch;
      });

      const needsToBePrepped = (item) => item.currentStock === 0 || item.stockPercentage < 100 || item.recommendedAmount > 0;

      const lineCooksPrep = prepItems.filter(r => r.lineCooksPrep === true && needsToBePrepped(r))
        .sort((a, b) => a.stockPercentage - b.stockPercentage);

      const makeFirst = prepItems.filter(r => r.urgent === true && !r.lineCooksPrep && needsToBePrepped(r))
        .sort((a, b) => a.stockPercentage - b.stockPercentage);

      const urgent = prepItems.filter(r => r.priority === 'urgent' && !r.urgent && !r.lineCooksPrep);

      // COMBINED SECTION: MAKE FIRST + URGENT
      const makeFirstAndUrgent = [...makeFirst, ...urgent];
      const makeFirstCount = makeFirst.length;
      const urgentCount = urgent.length;
      const combinedTitle = `MAKE FIRST (${makeFirstCount}) | URGENT (${urgentCount})`;

      const high = prepItems.filter(r => r.priority === 'high' && !r.urgent && !r.lineCooksPrep);
      const medium = prepItems.filter(r => r.priority === 'medium' && !r.urgent && !r.lineCooksPrep);

      const lowPriority = prepItems.filter(r => r.priority === 'low' && !r.urgent && !r.lineCooksPrep);

      // COMBINED SECTION: LOW PRIORITY + LINE COOKS
      const lowAndLineCooks = [...lowPriority, ...lineCooksPrep];
      const lowAndLineCooksTitle = `LOW PRIORITY (${lowPriority.length}) | LINE COOKS (${lineCooksPrep.length})`;

      const scaleFactor = 1.0;

      // Header
      doc.setFontSize(14);
      doc.setFont('helvetica', 'bold');
      doc.setTextColor(black[0], black[1], black[2]);
      doc.text('PREP SHEET - ' + dateStr, 4.25, 0.7, { align: 'center' });

      doc.setDrawColor(jaynaBlue[0], jaynaBlue[1], jaynaBlue[2]);
      doc.setLineWidth(0.02);
      doc.line(0.5, 0.78, 8, 0.78);

      doc.setFontSize(7);
      doc.setFont('helvetica', 'normal');
      doc.setTextColor(102, 102, 102);
      doc.text('Generated ' + timeStr, 4.25, 0.95, { align: 'center' });

      // Start Y position
      let yPos = 1.05;

      // MANDATORY NOTE (dark red box)
      yPos = renderMandatoryNote(doc, yPos, scaleFactor);
      yPos += 0.1;

      // BOTTLE COUNT + TO GO PREP (separate sections with divider)
      if (bottleItems.length > 0 || toGoItems.length > 0) {
        const title = `BOTTLE COUNT (${bottleItems.length}) & TO-GO PREP (${toGoItems.length})`;
        yPos = renderBottleAndToGoSection(doc, title, bottleItems, toGoItems, yPos, jaynaBlue, scaleFactor);
      }

      // MAKE FIRST + URGENT COMBINED
      if (makeFirstAndUrgent.length > 0) {
        yPos = renderPrepPDFSection(doc, combinedTitle, makeFirstAndUrgent, yPos, redText, scaleFactor, false);
      }

      // HIGH PRIORITY
      if (high.length > 0) {
        yPos = renderPrepPDFSection(doc, `HIGH PRIORITY (${high.length})`, high, yPos, darkGray, scaleFactor, false);
      }

      // MEDIUM PRIORITY
      if (medium.length > 0) {
        yPos = renderPrepPDFSection(doc, `MEDIUM PRIORITY (${medium.length})`, medium, yPos, darkGray, scaleFactor, false);
      }

      // LOW PRIORITY + LINE COOKS COMBINED (4-column layout)
      if (lowAndLineCooks.length > 0) {
        yPos = renderLowAndLineCooksSection(doc, lowAndLineCooksTitle, lowAndLineCooks, yPos, darkGray, scaleFactor);
      }

      // Footer
      if (yPos < 10) {
        doc.setDrawColor(224, 224, 224);
        doc.line(0.5, 10.2, 8, 10.2);
        doc.setFontSize(6);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(153, 153, 153);
        doc.text('MISTAKES HAPPEN, PLEASE USE YOUR BRAIN WHEN READING THIS LIST AND', 4.25, 10.32, { align: 'center' });
        doc.text('DOUBLE CHECK BY CLARIFYING WITH YOUR MANAGER IF YOU DOUBT ANYTHING.', 4.25, 10.40, { align: 'center' });

        doc.setFontSize(5.5);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(170, 170, 170);
        doc.text('PREP GENERATION FLOW CREATED AND DESIGNED BY DEMETRI GREGORAKIS', 4.25, 10.52, { align: 'center' });
      }

      // SEPARATE PAGE: LINE COOKS PREP (large 18pt text)
      if (lineCooksPrep.length > 0) {
        renderLineCooksPage(doc, lineCooksPrep, prepDate);
      }

      // CATERING ORDERS PAGES (page 2/3)
      await fetchAndRenderCateringOrders(doc, prepDate);

      // Get PDF as base64
      const pdfBase64 = doc.output('datauristring').split(',')[1];
      const filename = `Prep_Sheet_${dateStr.replace(/\//g, '-')}.pdf`;

      // Send via backend Gmail API
      const response = await fetch('/api/send-prep-sheet-email', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          pdfBase64: pdfBase64,
          filename: filename,
          subject: `Prep Sheet - ${dateStr}`,
          toEmail: 'GSS4168CTJJA73@print.epsonconnect.com'
        })
      });

      const result = await response.json();

      if (!response.ok) {
        throw new Error(result.error || 'Failed to send email');
      }

      showMessage('‚úÖ Prep sheet sent to printer successfully!', 'success');

      // Visual feedback: Turn button green with "SENT!" text
      if (button) {
        button.style.background = '#059669'; // Success green
        button.textContent = '‚úì SENT!';

        // Reset after 3 seconds
        setTimeout(() => {
          button.style.background = originalBg;
          button.textContent = originalText;
        }, 3000);
      }

    } catch (error) {
      console.error('Email send error:', error);
      showMessage('Failed to send to printer: ' + error.message, 'error');
    }
  }

  function buildBottledSauceSummary(recommendations = []) {
    const summary = [];

    // Get all bottled/to-go items from recommendations
    recommendations.forEach((item) => {
      // Check if item should be in bottle section:
      // 1. Has "BOTTLED" in name
      // 2. Has "TO GO" or "TO-GO" in name
      // 3. Has showInBottleCount checkbox checked
      const nameMatch = isBottledOrToGoItem(item.itemName);
      const checkboxMatch = item.showInBottleCount === true;
      
      if (nameMatch || checkboxMatch) {
        const quantitySource = item.currentStock != null ? item.currentStock : item.recommendedAmount;
        summary.push({
          label: item.itemName,
          quantity: formatPrepQuantity(quantitySource),
          lastCounted: formatLastCountedDetail(item.lastCountedDate)
        });
      }
    });

    // Sort alphabetically by label
    summary.sort((a, b) => a.label.localeCompare(b.label));

    return summary;
  }

  function formatPrepQuantity(value) {
    if (value === null || value === undefined) return '‚Äî';
    const number = Number(value);
    if (!Number.isFinite(number)) return '‚Äî';
    if (Math.abs(number % 1) < 0.01) return number.toString();
    return number.toFixed(2).replace(/\.00$/, '');
  }

  function formatCurrencyInput(value) {
    if (!Number.isFinite(value)) return '';
    return Number(value).toFixed(2);
  }

  function formatLastCountedDetail(dateStr) {
    if (!dateStr) return 'Never';
    const date = new Date(dateStr);
    if (Number.isNaN(date.getTime())) return 'Never';
    const datePart = formatPacificDateDisplay(date, { month: '2-digit', day: '2-digit', year: 'numeric' });
    const timePart = formatPacificDateDisplay(date, { hour: '2-digit', minute: '2-digit' });
    return `${datePart} ${timePart}`;
  }

  /**
   * Generate pending orders PDF (download version - matches email version exactly)
   */
  async function generatePendingOrdersPDF() {
    showMessage('Generating pending orders PDF...', 'info');

    try {
      // Check if jsPDF is loaded
      if (typeof jspdf === 'undefined' || typeof jspdf.jsPDF === 'undefined') {
        throw new Error('jsPDF library not loaded. Please refresh the page.');
      }

      // Fetch pending orders
      const { data: orders, error } = await supabase
        .from('pending_orders')
        .select(`
          *,
          pending_order_items (
            id,
            inventory_item_id,
            quantity_ordered,
            unit,
            item_name,
            quantity_received,
            variance
          )
        `)
        .in('status', ['pending', 'partial'])
        .order('expected_delivery_date', { ascending: true });

      if (error) throw error;

      if (!orders || orders.length === 0) {
        showMessage('No pending orders to export', 'warning');
        return;
      }

      const { jsPDF } = jspdf;
      const doc = new jsPDF({
        orientation: 'portrait',
        unit: 'in',
        format: 'letter'
      });

      const jaynaBlue = [33, 150, 243];
      const black = [33, 33, 33];
      const darkGray = [66, 66, 66];
      const lightGray = [102, 102, 102];

      let isFirstOrder = true;

      // Render each order (each gets its own page)
      for (const order of orders) {
        if (!isFirstOrder) {
          doc.addPage();
        }
        isFirstOrder = false;

        let yPos = 0.7;

        // BIG HEADER: "INCOMING ORDER FROM [VENDOR]"
        doc.setFontSize(16);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(black[0], black[1], black[2]);
        doc.text(`INCOMING ORDER FROM ${order.vendor.toUpperCase()}`, 4.25, yPos, { align: 'center' });
        yPos += 0.25;

        // SUBHEADER: "EXPECTED DELIVERY ON TUESDAY, 10/21/2025"
        const deliveryDate = parsePacificDate(order.expected_delivery_date);
        const dayName = formatPacificDateDisplay(deliveryDate, { weekday: 'long' }).toUpperCase();
        const dateStr = formatPacificDateDisplay(deliveryDate, { month: '2-digit', day: '2-digit', year: 'numeric' });

        doc.setFontSize(14);
        doc.setFont('helvetica', 'bold');
        doc.text(`EXPECTED DELIVERY ON ${dayName}, ${dateStr}`, 4.25, yPos, { align: 'center' });
        yPos += 0.1;

        // Blue underline
        doc.setDrawColor(jaynaBlue[0], jaynaBlue[1], jaynaBlue[2]);
        doc.setLineWidth(0.02);
        doc.line(0.5, yPos, 8, yPos);
        yPos += 0.25;

        // ORDER METADATA: "Order generated by DEMETRI on Monday, 7:01PM"
        const orderDate = parsePacificDate(order.order_date) || (order.created_at ? new Date(order.created_at) : new Date());
        const orderDayName = formatPacificDateDisplay(orderDate, { weekday: 'long' });
        const orderTime = formatPacificDateDisplay(orderDate, { hour: 'numeric', minute: '2-digit', hour12: true });
        const createdBy = order.created_by || 'System';

        doc.setFontSize(9);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(lightGray[0], lightGray[1], lightGray[2]);
        doc.text(`Order generated by ${createdBy} on ${orderDayName}, ${orderTime}`, 4.25, yPos, { align: 'center' });
        yPos += 0.15;

        // NOTES SECTION
        const notes = order.notes?.trim();
        if (!notes) {
          doc.text(`${createdBy.toUpperCase()} DID NOT LEAVE ANY NOTES`, 4.25, yPos, { align: 'center' });
          yPos += 0.3;
        } else {
          doc.text(`${createdBy.toUpperCase()} LEFT THESE NOTES:`, 4.25, yPos, { align: 'center' });
          yPos += 0.15;

          // Notes box
          doc.setFillColor(255, 249, 196);  // Light yellow background
          const notesLines = doc.splitTextToSize(notes, 7);
          const notesHeight = (notesLines.length * 0.12) + 0.15;
          doc.rect(0.5, yPos, 7.5, notesHeight, 'F');
          doc.setDrawColor(jaynaBlue[0], jaynaBlue[1], jaynaBlue[2]);
          doc.rect(0.5, yPos, 7.5, notesHeight);

          doc.setFontSize(8);
          doc.setFont('helvetica', 'normal');
          doc.setTextColor(black[0], black[1], black[2]);
          doc.text(notesLines, 0.6, yPos + 0.12);
          yPos += notesHeight + 0.2;
        }

        // ITEMS TABLE HEADER
        doc.setFontSize(10);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(darkGray[0], darkGray[1], darkGray[2]);
        doc.text('‚úì', 0.65, yPos, { align: 'center' });  // Checkbox column header
        doc.text('ITEM', 1.1, yPos);
        doc.text('QTY', 6.5, yPos);
        doc.text('UNIT', 7.2, yPos);
        yPos += 0.05;

        // Underline
        doc.setDrawColor(darkGray[0], darkGray[1], darkGray[2]);
        doc.setLineWidth(0.01);
        doc.line(0.5, yPos, 8, yPos);
        yPos += 0.2;

        // ITEMS WITH CHECKBOXES
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(9);

        const items = order.pending_order_items || [];
        for (const item of items) {
          if (yPos > 10) {
            doc.addPage();
            yPos = 0.7;
          }

          // Draw checkbox (empty square)
          doc.setDrawColor(black[0], black[1], black[2]);
          doc.setLineWidth(0.015);
          doc.rect(0.55, yPos - 0.12, 0.15, 0.15);  // Big checkbox

          // Item details
          doc.setTextColor(black[0], black[1], black[2]);
          doc.text(item.item_name || 'Unknown Item', 1.1, yPos, { maxWidth: 5 });
          doc.text(String(item.quantity_ordered || 0), 6.5, yPos);
          doc.text(item.unit || '', 7.2, yPos);

          yPos += 0.25;
        }
      }

      // Footer credit
      doc.setFontSize(6);
      doc.setFont('helvetica', 'italic');
      doc.setTextColor(150, 150, 150);
      doc.text('PREP GENERATION FLOW CREATED AND DESIGNED BY DEMETRI GREGORAKIS', 4.25, 10.7, { align: 'center' });

      // Save PDF
      const filename = `Pending_Orders_${getPacificDate()}.pdf`;
      doc.save(filename);

      showMessage('Pending orders PDF generated successfully!', 'success');

    } catch (error) {
      console.error('PDF generation error:', error);
      showMessage('Failed to generate PDF: ' + error.message, 'error');
    }
  }

  /**
   * Email pending orders PDF to printer
   */
  async function emailPendingOrdersToPrinter() {
    showMessage('Generating and sending pending orders to printer...', 'info');

    try {
      // Check if jsPDF is loaded
      if (typeof jspdf === 'undefined' || typeof jspdf.jsPDF === 'undefined') {
        throw new Error('jsPDF library not loaded. Please refresh the page.');
      }

      // Fetch pending orders
      const { data: orders, error } = await supabase
        .from('pending_orders')
        .select(`
          *,
          pending_order_items (
            id,
            inventory_item_id,
            quantity_ordered,
            unit,
            item_name,
            quantity_received,
            variance
          )
        `)
        .in('status', ['pending', 'partial'])
        .order('expected_delivery_date', { ascending: true });

      if (error) throw error;

      if (!orders || orders.length === 0) {
        showMessage('No pending orders to send', 'warning');
        return;
      }

      const { jsPDF } = jspdf;
      const doc = new jsPDF({
        orientation: 'portrait',
        unit: 'in',
        format: 'letter'
      });

      const jaynaBlue = [33, 150, 243];
      const black = [33, 33, 33];
      const darkGray = [66, 66, 66];
      const lightGray = [102, 102, 102];

      let isFirstOrder = true;

      // Render each order (each gets its own page)
      for (const order of orders) {
        if (!isFirstOrder) {
          doc.addPage();
        }
        isFirstOrder = false;

        let yPos = 0.7;

        // BIG HEADER: "INCOMING ORDER FROM [VENDOR]"
        doc.setFontSize(16);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(black[0], black[1], black[2]);
        doc.text(`INCOMING ORDER FROM ${order.vendor.toUpperCase()}`, 4.25, yPos, { align: 'center' });
        yPos += 0.25;

        // SUBHEADER: "EXPECTED DELIVERY ON TUESDAY, 10/21/2025"
        const deliveryDate = parsePacificDate(order.expected_delivery_date);
        const dayName = formatPacificDateDisplay(deliveryDate, { weekday: 'long' }).toUpperCase();
        const dateStr = formatPacificDateDisplay(deliveryDate, { month: '2-digit', day: '2-digit', year: 'numeric' });

        doc.setFontSize(14);
        doc.setFont('helvetica', 'bold');
        doc.text(`EXPECTED DELIVERY ON ${dayName}, ${dateStr}`, 4.25, yPos, { align: 'center' });
        yPos += 0.1;

        // Blue underline
        doc.setDrawColor(jaynaBlue[0], jaynaBlue[1], jaynaBlue[2]);
        doc.setLineWidth(0.02);
        doc.line(0.5, yPos, 8, yPos);
        yPos += 0.25;

        // ORDER METADATA: "Order generated by DEMETRI on Monday, 7:01PM"
        const orderDate = parsePacificDate(order.order_date) || (order.created_at ? new Date(order.created_at) : new Date());
        const orderDayName = formatPacificDateDisplay(orderDate, { weekday: 'long' });
        const orderTime = formatPacificDateDisplay(orderDate, { hour: 'numeric', minute: '2-digit', hour12: true });
        const createdBy = order.created_by || 'System';

        doc.setFontSize(9);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(lightGray[0], lightGray[1], lightGray[2]);
        doc.text(`Order generated by ${createdBy} on ${orderDayName}, ${orderTime}`, 4.25, yPos, { align: 'center' });
        yPos += 0.15;

        // NOTES SECTION
        const notes = order.notes?.trim();
        if (!notes) {
          doc.text(`${createdBy.toUpperCase()} DID NOT LEAVE ANY NOTES`, 4.25, yPos, { align: 'center' });
          yPos += 0.3;
        } else {
          doc.text(`${createdBy.toUpperCase()} LEFT THESE NOTES:`, 4.25, yPos, { align: 'center' });
          yPos += 0.15;

          // Notes box
          doc.setFillColor(255, 249, 196);  // Light yellow background
          const notesLines = doc.splitTextToSize(notes, 7);
          const notesHeight = (notesLines.length * 0.12) + 0.15;
          doc.rect(0.5, yPos, 7.5, notesHeight, 'F');
          doc.setDrawColor(jaynaBlue[0], jaynaBlue[1], jaynaBlue[2]);
          doc.rect(0.5, yPos, 7.5, notesHeight);

          doc.setFontSize(8);
          doc.setFont('helvetica', 'normal');
          doc.setTextColor(black[0], black[1], black[2]);
          doc.text(notesLines, 0.6, yPos + 0.12);
          yPos += notesHeight + 0.2;
        }

        // ITEMS TABLE HEADER
        doc.setFontSize(10);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(darkGray[0], darkGray[1], darkGray[2]);
        doc.text('‚úì', 0.65, yPos, { align: 'center' });  // Checkbox column header
        doc.text('ITEM', 1.1, yPos);
        doc.text('QTY', 6.5, yPos);
        doc.text('UNIT', 7.2, yPos);
        yPos += 0.05;

        // Underline
        doc.setDrawColor(darkGray[0], darkGray[1], darkGray[2]);
        doc.setLineWidth(0.01);
        doc.line(0.5, yPos, 8, yPos);
        yPos += 0.2;

        // ITEMS WITH CHECKBOXES
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(9);

        const items = order.pending_order_items || [];
        for (const item of items) {
          if (yPos > 10) {
            doc.addPage();
            yPos = 0.7;
          }

          // Draw checkbox (empty square)
          doc.setDrawColor(black[0], black[1], black[2]);
          doc.setLineWidth(0.015);
          doc.rect(0.55, yPos - 0.12, 0.15, 0.15);  // Big checkbox

          // Item details
          doc.setTextColor(black[0], black[1], black[2]);
          doc.text(item.item_name || 'Unknown Item', 1.1, yPos, { maxWidth: 5 });
          doc.text(String(item.quantity_ordered || 0), 6.5, yPos);
          doc.text(item.unit || '', 7.2, yPos);

          yPos += 0.25;
        }
      }

      // Footer credit
      doc.setFontSize(6);
      doc.setFont('helvetica', 'italic');
      doc.setTextColor(150, 150, 150);
      doc.text('PREP GENERATION FLOW CREATED AND DESIGNED BY DEMETRI GREGORAKIS', 4.25, 10.7, { align: 'center' });

      // Convert PDF to base64
      const pdfBase64 = doc.output('datauristring').split(',')[1];
      const filename = `Pending_Orders_${getPacificDate()}.pdf`;

      // Send via backend Gmail API (same as prep sheet)
      const response = await fetch('/api/send-prep-sheet-email', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          pdfBase64: pdfBase64,
          filename: filename,
          subject: `Pending Orders - ${getPacificDate()}`,
          toEmail: 'GSS4168CTJJA73@print.epsonconnect.com'  // Epson printer email
        })
      });

      const result = await response.json();

      if (!response.ok) {
        throw new Error(result.error || 'Failed to send email');
      }

      showMessage('‚úÖ Pending orders sent to printer successfully!', 'success');

    } catch (error) {
      console.error('Email error:', error);
      showMessage('Failed to send to printer: ' + error.message, 'error');
    }
  }

  function renderSauceSummaryCard(doc, summary, startY) {
    if (!summary.length) return startY;

    const headerColor = [33, 150, 243];
    const pageTop = 0.7;
    const pageBottom = 10.4;
    const itemColX = 0.6;
    const itemColWidth = 3.8;
    const qtyColX = 4.8;
    const lastColX = 5.7;
    const lastColWidth = 2.2;
    const lineGap = 0.16;

    const drawHeader = (y, continuation = false) => {
      if (y > pageBottom) {
        doc.addPage();
        y = pageTop;
      }

      doc.setFillColor(headerColor[0], headerColor[1], headerColor[2]);
      doc.rect(0.5, y, 7.5, 0.25, 'F');
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(8);
      doc.setTextColor(255, 255, 255);
      doc.text(continuation ? 'BOTTLED & TO-GO PREP CHECK (CONT.)' : 'BOTTLED & TO-GO PREP CHECK', 0.6, y + 0.17);
      
      const columnHeaderY = y + 0.32;
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(5.5);
      doc.setTextColor(102, 102, 102);
      doc.text('ITEM NAME', itemColX, columnHeaderY);
      doc.text('CURRENT', qtyColX, columnHeaderY);
      doc.text('LAST COUNTED', lastColX, columnHeaderY);

      doc.setDrawColor(224, 224, 224);
      doc.setLineWidth(0.01);
      doc.line(0.5, columnHeaderY + 0.05, 8.0, columnHeaderY + 0.05);

      return columnHeaderY + 0.12;
    };

    let yPos = drawHeader(startY);

    summary.forEach((row) => {
      const itemLines = doc.splitTextToSize(row.label.toUpperCase(), itemColWidth);
      const lastLines = doc.splitTextToSize(row.lastCounted, lastColWidth);
      const rowLineCount = Math.max(itemLines.length, lastLines.length);
      const rowHeight = rowLineCount * lineGap + 0.1;

      if (yPos + rowHeight > pageBottom) {
        yPos = drawHeader(pageTop, true);
      }

      doc.setFont('helvetica', 'bold');
      doc.setFontSize(6.4);
      doc.setTextColor(33, 33, 33);
      doc.text(itemLines[0], itemColX, yPos, { maxWidth: itemColWidth });

      doc.setFont('helvetica', 'normal');
      doc.setFontSize(5.4);
      for (let i = 1; i < itemLines.length; i++) {
        doc.text(itemLines[i], itemColX, yPos + (i * lineGap), { maxWidth: itemColWidth });
      }

      doc.setFont('helvetica', 'bold');
      doc.setFontSize(6);
      doc.setTextColor(33, 33, 33);
      doc.text(row.quantity, qtyColX, yPos);

      doc.setFont('helvetica', 'normal');
      doc.setFontSize(5.4);
      doc.setTextColor(102, 102, 102);
      lastLines.forEach((line, idx) => {
        doc.text(line, lastColX, yPos + (idx * lineGap), { maxWidth: lastColWidth });
      });

      const rowBottom = yPos + rowHeight - 0.05;
      doc.setDrawColor(224, 224, 224);
      doc.setLineWidth(0.005);
      doc.line(0.5, rowBottom, 8.0, rowBottom);

      yPos = rowBottom + 0.07;
    });

    return yPos + 0.15;
  }

  /**
   * Render mandatory note - clean and well-padded
   */
  function renderMandatoryNote(doc, yPos, scaleFactor = 1.0) {
    const darkRed = [139, 0, 0];
    const black = [33, 33, 33];
    const gray = [120, 120, 120];

    const boxHeight = 0.70;
    const padding = 0.12;

    // Box background and border
    doc.setFillColor(255, 240, 240);
    doc.rect(0.5, yPos, 7.5, boxHeight, 'F');
    doc.setDrawColor(darkRed[0], darkRed[1], darkRed[2]);
    doc.setLineWidth(0.02);
    doc.rect(0.5, yPos, 7.5, boxHeight, 'S');

    let currentY = yPos + padding;

    // Title
    doc.setFontSize(8);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(darkRed[0], darkRed[1], darkRed[2]);
    doc.text('MUST HAVE THESE ITEMS AT PAR BEFORE LEAVING FOR THE DAY', 0.65, currentY);

    currentY += 0.20;

    const col1X = 0.65;
    const col2X = 4.3;
    const checkboxSize = 0.09;

    // LEFT: BLANCHED POTATOES 4X
    doc.setFontSize(7);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(black[0], black[1], black[2]);
    doc.setDrawColor(gray[0], gray[1], gray[2]);
    doc.rect(col1X, currentY - 0.05, checkboxSize, checkboxSize, 'S');
    doc.text('BLANCHED POTATOES 4X', col1X + checkboxSize + 0.05, currentY);

    // RIGHT: SALAD MIX 3X
    doc.rect(col2X, currentY - 0.05, checkboxSize, checkboxSize, 'S');
    doc.text('SALAD MIX 3X', col2X + checkboxSize + 0.05, currentY);

    currentY += 0.14;

    // Fields
    doc.setFontSize(5.5);
    doc.setFont('helvetica', 'normal');
    doc.setDrawColor(200, 200, 200);

    // LEFT fields
    doc.text('INITIAL:', col1X, currentY);
    doc.line(col1X + 0.28, currentY, col1X + 0.75, currentY);
    doc.text('COUNT:', col1X + 0.90, currentY);
    doc.line(col1X + 1.18, currentY, col1X + 1.65, currentY);
    doc.text('TIME:', col1X + 1.80, currentY);
    doc.line(col1X + 2.05, currentY, col1X + 2.52, currentY);

    // RIGHT fields
    doc.text('INITIAL:', col2X, currentY);
    doc.line(col2X + 0.28, currentY, col2X + 0.75, currentY);
    doc.text('COUNT:', col2X + 0.90, currentY);
    doc.line(col2X + 1.18, currentY, col2X + 1.65, currentY);
    doc.text('TIME:', col2X + 1.80, currentY);
    doc.line(col2X + 2.05, currentY, col2X + 2.52, currentY);

    return yPos + boxHeight + 0.10;
  }

  /**
   * NEW: Render BOTTLE COUNT + TO GO PREP with vertical divider
   * Bottles on left, to-go items on right in Jayna Blue
   */
  function renderBottleAndToGoSection(doc, title, bottleItems, toGoItems, startY, headerColor, scaleFactor = 1.0) {
    const white = [255, 255, 255];
    const darkText = [33, 33, 33];
    const grayText = [102, 102, 102];
    const lightGray = [220, 220, 220];
    const jaynaBlue = [33, 150, 243];

    // Check if we need a new page
    if (startY > 9.5) {
      doc.addPage();
      startY = 0.7;
    }

    // Section header
    const headerHeight = 0.18 * scaleFactor;
    doc.setFillColor(headerColor[0], headerColor[1], headerColor[2]);
    doc.rect(0.5, startY, 7.5, headerHeight, 'F');
    doc.setFontSize(7 * scaleFactor);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(white[0], white[1], white[2]);
    doc.text(title, 0.6, startY + (0.12 * scaleFactor));

    startY += headerHeight;

    // Note about FOH completion in bold italic
    doc.setFontSize(6 * scaleFactor);
    doc.setFont('helvetica', 'bolditalic');
    doc.setTextColor(darkText[0], darkText[1], darkText[2]);
    doc.text('To-go items are to be completed by the FOH staff', 0.6, startY + (0.1 * scaleFactor));

    startY += 0.16 * scaleFactor;

    // Separator line
    doc.setDrawColor(lightGray[0], lightGray[1], lightGray[2]);
    doc.setLineWidth(0.003);
    doc.line(0.5, startY, 8, startY);

    startY += 0.08 * scaleFactor;

    // Layout: 2 columns with vertical divider
    const leftColumnX = 0.5;
    const rightColumnX = 4.25;
    const dividerX = 4.15;
    const columnWidth = 3.65;
    const lineHeight = 0.20 * scaleFactor;

    let maxY = startY;

    // Render bottle items (left column)
    for (let i = 0; i < bottleItems.length; i++) {
      const item = bottleItems[i];
      const y = startY + (i * lineHeight);

      doc.setFontSize(5.8 * scaleFactor);
      doc.setFont('helvetica', 'bold');
      doc.setTextColor(darkText[0], darkText[1], darkText[2]);

      const maxWidth = columnWidth - 0.16;
      let itemName = item.itemName;

      // Truncate if too long
      const nameWidth = doc.getTextWidth(itemName);
      if (nameWidth > maxWidth * 0.7) {
        const chars = Math.floor((maxWidth * 0.7) / (nameWidth / itemName.length));
        itemName = itemName.substring(0, chars - 3) + '...';
      }

      const qtyText = `${item.currentStock || 0} - ${item.unit || ''}`;
      doc.text(itemName + ':', leftColumnX + 0.08, y);

      const nameDisplayWidth = doc.getTextWidth(itemName + ':');
      doc.setFont('helvetica', 'normal');
      doc.setFontSize(5.5 * scaleFactor);
      doc.setTextColor(grayText[0], grayText[1], grayText[2]);
      doc.text(` ${qtyText}`, leftColumnX + 0.08 + nameDisplayWidth, y);

      // Last counted on second line
      const lastCountStr = item.lastCountedDate ? formatLastCountForPrepSheet(item.lastCountedDate, item.countedBy) : 'Never counted';
      doc.setFontSize(4.0 * scaleFactor);
      doc.setFont('helvetica', 'italic');
      doc.setTextColor(0, 0, 0);
      doc.text(`  ${lastCountStr}`, leftColumnX + 0.08, y + (0.08 * scaleFactor));

      maxY = Math.max(maxY, y + (0.12 * scaleFactor));
    }

    // Render to-go items (right column, in Jayna Blue)
    for (let i = 0; i < toGoItems.length; i++) {
      const item = toGoItems[i];
      const y = startY + (i * lineHeight);

      doc.setFontSize(5.8 * scaleFactor);
      doc.setFont('helvetica', 'bold');
      doc.setTextColor(jaynaBlue[0], jaynaBlue[1], jaynaBlue[2]); // TO-GO in Jayna Blue

      const maxWidth = columnWidth - 0.16;
      let itemName = item.itemName;

      // Truncate if too long
      const nameWidth = doc.getTextWidth(itemName);
      if (nameWidth > maxWidth * 0.7) {
        const chars = Math.floor((maxWidth * 0.7) / (nameWidth / itemName.length));
        itemName = itemName.substring(0, chars - 3) + '...';
      }

      const qtyText = `${item.currentStock || 0} - ${item.unit || ''}`;
      doc.text(itemName + ':', rightColumnX + 0.08, y);

      const nameDisplayWidth = doc.getTextWidth(itemName + ':');
      doc.setFont('helvetica', 'normal');
      doc.setFontSize(5.5 * scaleFactor);
      doc.setTextColor(grayText[0], grayText[1], grayText[2]);
      doc.text(` ${qtyText}`, rightColumnX + 0.08 + nameDisplayWidth, y);

      // Last counted on second line
      const lastCountStr = item.lastCountedDate ? formatLastCountForPrepSheet(item.lastCountedDate, item.countedBy) : 'Never counted';
      doc.setFontSize(4.0 * scaleFactor);
      doc.setFont('helvetica', 'italic');
      doc.setTextColor(0, 0, 0);
      doc.text(`  ${lastCountStr}`, rightColumnX + 0.08, y + (0.08 * scaleFactor));

      maxY = Math.max(maxY, y + (0.12 * scaleFactor));
    }

    // Draw vertical divider line
    doc.setDrawColor(lightGray[0], lightGray[1], lightGray[2]);
    doc.setLineWidth(0.01);
    doc.line(dividerX, startY - 0.08, dividerX, maxY);

    return maxY + (0.08 * scaleFactor);
  }

  /**
   * NEW: Render LOW PRIORITY + LINE COOKS in 4-column layout
   * Line cooks items in Jayna Blue
   */
  function renderLowAndLineCooksSection(doc, title, items, startY, headerColor, scaleFactor = 1.0) {
    const white = [255, 255, 255];
    const darkText = [33, 33, 33];
    const grayText = [102, 102, 102];
    const lightGray = [220, 220, 220];
    const jaynaBlue = [33, 150, 243];

    // Check if we need a new page
    if (startY > 9.5) {
      doc.addPage();
      startY = 0.7;
    }

    // Section header
    const headerHeight = 0.18 * scaleFactor;
    doc.setFillColor(headerColor[0], headerColor[1], headerColor[2]);
    doc.rect(0.5, startY, 7.5, headerHeight, 'F');
    doc.setFontSize(7 * scaleFactor);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(white[0], white[1], white[2]);
    doc.text(title, 0.6, startY + (0.12 * scaleFactor));

    startY += headerHeight;
    startY += 0.08 * scaleFactor;

    // Calculate 4-column layout
    const columns = 4;
    const columnWidth = 7.5 / columns;
    const itemsPerColumn = Math.ceil(items.length / columns);
    const lineHeight = 0.18 * scaleFactor;

    let maxY = startY;

    for (let i = 0; i < items.length; i++) {
      const item = items[i];
      const columnIndex = Math.floor(i / itemsPerColumn);
      const rowIndex = i % itemsPerColumn;
      const x = 0.5 + (columnIndex * columnWidth) + 0.08;
      const y = startY + (rowIndex * lineHeight);

      doc.setFontSize(5.5 * scaleFactor);
      doc.setFont('helvetica', 'bold');

      // Color: LINE COOKS in Jayna Blue, others in dark text
      if (item.lineCooksPrep === true) {
        doc.setTextColor(jaynaBlue[0], jaynaBlue[1], jaynaBlue[2]);
      } else {
        doc.setTextColor(darkText[0], darkText[1], darkText[2]);
      }

      const maxWidth = columnWidth - 0.16;
      let itemName = item.itemName;

      // Truncate if too long
      const nameWidth = doc.getTextWidth(itemName);
      if (nameWidth > maxWidth * 0.65) {
        const chars = Math.floor((maxWidth * 0.65) / (nameWidth / itemName.length));
        itemName = itemName.substring(0, chars - 3) + '...';
      }

      const stockDisplay = item.currentStock === 0 ? 'OUT' : `${item.currentStock}`;
      doc.text(`${itemName}:`, x, y);

      const nameDisplayWidth = doc.getTextWidth(`${itemName}:`);
      doc.setFont('helvetica', 'normal');
      doc.setFontSize(5 * scaleFactor);
      doc.setTextColor(grayText[0], grayText[1], grayText[2]);
      doc.text(` ${stockDisplay}`, x + nameDisplayWidth, y);

      // Last counted on second line
      const lastCountStr = item.lastCountedDate ? formatLastCountForPrepSheet(item.lastCountedDate, item.countedBy) : 'Never counted';
      doc.setFontSize(3.6 * scaleFactor);
      doc.setFont('helvetica', 'italic');
      doc.setTextColor(0, 0, 0);
      doc.text(`  ${lastCountStr}`, x, y + (0.07 * scaleFactor));

      maxY = Math.max(maxY, y + (0.10 * scaleFactor));
    }

    return maxY + (0.08 * scaleFactor);
  }

  /**
   * NEW: Render delegation key at top of page
   */
  function renderDelegationKey(doc, yPos, scaleFactor = 1.0) {
    const huseyinColor = [239, 68, 68]; // Softer red
    const savanahColor = [34, 197, 94]; // Softer green
    const emilioColor = [96, 165, 250]; // Softer blue
    const black = [33, 33, 33];

    doc.setFontSize(6 * scaleFactor);
    doc.setFont('helvetica', 'normal');

    const startX = 0.6;
    let xPos = startX;

    // E - EMILIO
    doc.setTextColor(...emilioColor);
    doc.setFont('helvetica', 'bold');
    doc.text('E', xPos, yPos);
    xPos += 0.08;
    doc.setTextColor(...black);
    doc.setFont('helvetica', 'normal');
    doc.text('- EMILIO', xPos, yPos);
    xPos += 0.5;

    // S - SAVANAH
    doc.setTextColor(...savanahColor);
    doc.setFont('helvetica', 'bold');
    doc.text('S', xPos, yPos);
    xPos += 0.08;
    doc.setTextColor(...black);
    doc.setFont('helvetica', 'normal');
    doc.text('- SAVANAH', xPos, yPos);
    xPos += 0.6;

    // H - HUSEYIN
    doc.setTextColor(...huseyinColor);
    doc.setFont('helvetica', 'bold');
    doc.text('H', xPos, yPos);
    xPos += 0.08;
    doc.setTextColor(...black);
    doc.setFont('helvetica', 'normal');
    doc.text('- HUSEYIN', xPos, yPos);

    return yPos + 0.15;
  }

  /**
   * NEW: Render delegation initials (H, S, E) in line with spacing
   */
  function renderDelegationInitials(doc, x, y, scaleFactor = 1.0) {
    // Softer colors for each staff member
    const huseyinColor = [239, 68, 68]; // Softer red
    const savanahColor = [34, 197, 94]; // Softer green
    const emilioColor = [96, 165, 250]; // Softer blue

    const fontSize = 7 * scaleFactor;
    const spacing = 0.12; // Enough space for circling, all visible

    doc.setFontSize(fontSize);
    doc.setFont('helvetica', 'bold');

    // H
    doc.setTextColor(...huseyinColor);
    doc.text('H', x - spacing, y, { align: 'center' });

    // S
    doc.setTextColor(...savanahColor);
    doc.text('S', x, y, { align: 'center' });

    // E
    doc.setTextColor(...emilioColor);
    doc.text('E', x + spacing, y, { align: 'center' });
  }

  /**
   * NEW: Render a priority section with redesigned table structure
   * Columns: ‚òê | ITEM (with last counted below) | CURRENT | PAR | MAKE | NOTES
   * Priority color coding: HIGH=ORANGE, MEDIUM=YELLOW, LOW=GREEN
   */
  function renderPrepPDFSection(doc, title, items, startY, headerColor, scaleFactor = 1.0, isCombinedSection = false) {
    const white = [255, 255, 255];
    const darkText = [33, 33, 33];
    const grayText = [102, 102, 102];
    const lightGray = [136, 136, 136];
    const redText = [220, 38, 38]; // Red for MAKE FIRST
    const orangeText = [249, 115, 22]; // Orange for HIGH
    const yellowText = [234, 179, 8]; // Yellow for MEDIUM
    const greenText = [34, 197, 94]; // Green for LOW
    const jaynaBlue = [33, 150, 243]; // Blue for LINE COOKS

    // Check if we need a new page
    if (startY > 9.5) {
      doc.addPage();
      startY = 0.7;
    }

    // Section header
    const headerHeight = 0.18 * scaleFactor;
    doc.setFillColor(headerColor[0], headerColor[1], headerColor[2]);
    doc.rect(0.5, startY, 7.5, headerHeight, 'F');
    doc.setFontSize(7 * scaleFactor);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(white[0], white[1], white[2]);
    doc.text(`${title}`, 0.6, startY + (0.12 * scaleFactor));

    startY += headerHeight;

    // Build table data with item name + last counted together
    const tableData = items.map(item => {
      const lastCountStr = item.lastCountedDate ? formatLastCountForPrepSheet(item.lastCountedDate, item.countedBy) : 'Never counted';
      const isOut = item.currentStock === 0;
      const stockDisplay = isOut ? 'OUT' : `${item.currentStock} - ${item.unit}`;
      const parDisplay = `${item.parLevel} - ${item.unit}`;
      const recommendValue = item.recommendedAmount > 0 ? `${item.recommendedAmount} - ${item.unit}` : '‚Äî';

      return [
        item.itemName,    // ITEM (timestamp drawn separately in didDrawCell)
        stockDisplay,     // CURRENT
        parDisplay,       // PAR (swapped with MAKE)
        recommendValue,   // MAKE (swapped with PAR)
        ''                // NOTES (blank for pen)
      ];
    });

    // Render table (no borders, only horizontal lines)
    doc.autoTable({
      startY: startY,
      head: [['ITEM', 'CURRENT', 'PAR', 'MAKE', 'NOTES']],
      body: tableData,
      theme: 'plain',
      margin: { left: 0.5, right: 0.5 },
      tableWidth: 7.5,
      styles: {
        fontSize: 5.8 * scaleFactor,
        cellPadding: 0.04 * scaleFactor,
        lineColor: [153, 153, 153], // 60% gray
        lineWidth: 0.005,
        valign: 'top',
        minCellHeight: 0.25 * scaleFactor,
        halign: 'left',
        textColor: darkText,
        overflow: 'linebreak'
      },
      headStyles: {
        fillColor: [240, 240, 240],
        textColor: grayText,
        fontStyle: 'bold',
        fontSize: 5.2 * scaleFactor,
        cellPadding: 0.03 * scaleFactor,
        halign: 'center',
        valign: 'middle'
      },
      columnStyles: {
        0: { cellWidth: 2.15, fontStyle: 'bold', fontSize: 5.8 * scaleFactor }, // ITEM
        1: { cellWidth: 0.7, halign: 'center', fontSize: 5.8 * scaleFactor },  // CURRENT
        2: { cellWidth: 0.7, halign: 'center', fontSize: 5.8 * scaleFactor },  // PAR
        3: { cellWidth: 0.7, halign: 'center', fontSize: 5.8 * scaleFactor },  // MAKE
        4: { cellWidth: 3.1, fontSize: 5.3 * scaleFactor }                     // NOTES (blank)
      },
      didDrawCell: function(data) {
        // Draw timestamp in ITEM column
        if (data.column.index === 0 && data.section === 'body') {
          const rowIndex = data.row.index;
          const item = items[rowIndex];
          const lastCountStr = item.lastCountedDate ? formatLastCountForPrepSheet(item.lastCountedDate, item.countedBy) : 'Never counted';

          // Draw timestamp below item name in black italic
          doc.setFontSize(3.6 * scaleFactor);
          doc.setFont('helvetica', 'italic');
          doc.setTextColor(0, 0, 0);
          const timestampX = data.cell.x + 0.04 * scaleFactor;
          const timestampY = data.cell.y + data.cell.height - 0.04 * scaleFactor;
          doc.text(lastCountStr, timestampX, timestampY);
        }
      },
      didParseCell: function(data) {
        // Apply priority color coding to item names
        if (data.column.index === 0 && data.section === 'body') {
          const rowIndex = data.row.index;
          const item = items[rowIndex];

          // Priority color coding
          if (title.includes('MAKE FIRST')) {
            data.cell.styles.textColor = redText;
            data.cell.styles.fontSize = 6.5 * scaleFactor;
          } else if (item.priority === 'high') {
            data.cell.styles.textColor = orangeText;
          } else if (item.priority === 'medium') {
            data.cell.styles.textColor = yellowText;
          } else if (item.priority === 'low') {
            data.cell.styles.textColor = greenText;
          }

          // LINE COOKS in blue (in combined section)
          if (isCombinedSection && item.lineCooksPrep === true) {
            data.cell.styles.textColor = jaynaBlue;
          }

          // Format "Last: X ago" in smaller gray italic
          const cellText = data.cell.text[0] || '';
          if (cellText.includes('\n')) {
            // Split into name and time
            const lines = cellText.split('\n');
            data.cell.text = [lines[0], lines[1]]; // Keep both lines
          }
        }

        // RED TEXT for OUT in CURRENT column
        if (data.column.index === 2 && data.section === 'body') {
          const cellText = data.cell.text[0];
          if (cellText && cellText.includes('OUT')) {
            data.cell.styles.textColor = redText;
            data.cell.styles.fontStyle = 'bold';
            data.cell.styles.fontSize = 7 * scaleFactor;
          }
        }
      },
      didDrawPage: function(data) {
        // Custom rendering for "Last: X ago" in gray italic
        // This is handled in didParseCell above
      }
    });

    return doc.lastAutoTable.finalY + (0.06 * scaleFactor);
  }

  /**
   * NEW: Render separate LINE COOKS PREP page with large 18pt text
   */
  function renderLineCooksPage(doc, items, prepDate) {
    if (!items || items.length === 0) return;

    doc.addPage();

    const black = [33, 33, 33];
    const grayText = [128, 128, 128];
    const jaynaBlue = [33, 150, 243];

    let yPos = 0.7;

    // Page title
    doc.setFontSize(18);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(black[0], black[1], black[2]);
    doc.text('LINE COOKS PREP', 4.25, yPos, { align: 'center' });

    yPos += 0.3;

    // Date
    doc.setFontSize(14);
    doc.setFont('helvetica', 'normal');
    doc.setTextColor(grayText[0], grayText[1], grayText[2]);
    const dateStr = formatPacificDateDisplay(prepDate, { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
    doc.text(dateStr, 4.25, yPos, { align: 'center' });

    yPos += 0.4;

    // Render each item with large text
    items.forEach(item => {
      if (yPos > 10) {
        doc.addPage();
        yPos = 0.7;
      }

      // Item name in large 18pt text
      doc.setFontSize(18);
      doc.setFont('helvetica', 'bold');
      doc.setTextColor(jaynaBlue[0], jaynaBlue[1], jaynaBlue[2]);
      doc.text(item.itemName, 0.6, yPos);

      yPos += 0.3;

      // Details in smaller text
      doc.setFontSize(12);
      doc.setFont('helvetica', 'normal');
      doc.setTextColor(black[0], black[1], black[2]);

      const stockDisplay = item.currentStock === 0 ? 'OUT' : `${item.currentStock} ${item.unit}`;
      const parDisplay = `${item.parLevel} ${item.unit}`;
      const location = item.storageLocation || item.storage_location || item.area || 'No location defined';
      const lastCounted = item.lastCountedDate ? formatRelativeTime(item.lastCountedDate) : 'Never';

      doc.text(`Current Stock: ${stockDisplay}`, 0.8, yPos);
      yPos += 0.2;

      doc.text(`Par Level: ${parDisplay}`, 0.8, yPos);
      yPos += 0.2;

      doc.text(`Location: ${location}`, 0.8, yPos);
      yPos += 0.2;

      doc.setFontSize(10);
      doc.setTextColor(grayText[0], grayText[1], grayText[2]);
      doc.text(`Last Counted: ${lastCounted}`, 0.8, yPos);

      yPos += 0.4;

      // Separator line
      doc.setDrawColor(200, 200, 200);
      doc.setLineWidth(0.005);
      doc.line(0.6, yPos, 7.9, yPos);

      yPos += 0.3;
    });
  }

  /**
   * NEW: Fetch and render catering orders for tomorrow and day after
   */
  async function fetchAndRenderCateringOrders(doc, prepDate) {
    try {
      const tomorrow = new Date(prepDate);
      tomorrow.setDate(tomorrow.getDate() + 1);
      const tomorrowStr = tomorrow.toISOString().split('T')[0];

      const dayAfter = new Date(prepDate);
      dayAfter.setDate(dayAfter.getDate() + 2);
      const dayAfterStr = dayAfter.toISOString().split('T')[0];

      console.log(`üìã Fetching catering orders for ${tomorrowStr} and ${dayAfterStr}`);

      // Fetch orders for both dates (simple query)
      const { data: orders, error: ordersError } = await supabase
        .from('catering_orders')
        .select('*')
        .in('delivery_date', [tomorrowStr, dayAfterStr])
        .order('delivery_date', { ascending: true });

      if (ordersError) {
        console.error('‚ùå Catering orders fetch error:', ordersError);
        throw ordersError;
      }

      console.log(`‚úÖ Found ${orders?.length || 0} catering orders`);

      if (!orders || orders.length === 0) {
        console.log('‚ÑπÔ∏è No catering orders for tomorrow or day after');
        return;
      }

      // Fetch line items for all orders
      const orderIds = orders.map(o => o.id);
      const { data: items, error: itemsError } = await supabase
        .from('catering_order_items')
        .select('*')
        .in('order_id', orderIds);

      if (itemsError) {
        console.error('‚ùå Catering items fetch error:', itemsError);
        throw itemsError;
      }

      console.log(`‚úÖ Found ${items?.length || 0} catering order items`);

      // Manually attach items to orders
      orders.forEach(order => {
        order.catering_order_items = items.filter(item => item.order_id === order.id);
      });

      // Group by date
      const ordersByDate = {};
      orders.forEach(order => {
        if (!ordersByDate[order.delivery_date]) {
          ordersByDate[order.delivery_date] = [];
        }
        ordersByDate[order.delivery_date].push(order);
      });

      // Render page for each date
      Object.keys(ordersByDate).sort().forEach(date => {
        renderCateringOrdersPage(doc, ordersByDate[date], date);
      });

    } catch (error) {
      console.error('Error fetching catering orders:', error);
    }
  }

  /**
   * Calculate prep list from catering order line items
   */
  function calculateCateringPrepList(lineItems) {
    const prep = {
      byoGyros: { total: 0, items: [] },
      salads: [],
      dips: [],
      sides: [],
      desserts: []
    };

    lineItems.forEach(item => {
      const itemName = (item.item_name || '').toUpperCase();
      const qty = parseFloat(item.quantity || 1);

      if (itemName.includes('MAKE YOUR OWN') || itemName.includes('BYO')) {
        prep.byoGyros.total += qty;
        prep.byoGyros.items.push({ name: item.item_name, qty });
      }
      else if (itemName.includes('SALAD')) {
        prep.salads.push({ name: item.item_name, qty });
      }
      else if (itemName.includes('HUMMUS') || itemName.includes('BABA') || itemName.includes('TZATZIKI')) {
        prep.dips.push({ name: item.item_name, qty });
      }
      else if (itemName.includes('FRIES') || itemName.includes('PITA') || itemName.includes('DOLMAS') || itemName.includes('SPANAKOPITA')) {
        prep.sides.push({ name: item.item_name, qty });
      }
      else if (itemName.includes('BAKLAVA') || itemName.includes('RICE PUDDING')) {
        prep.desserts.push({ name: item.item_name, qty });
      }
    });

    return prep;
  }

  /**
   * Render prep list breakdown in PDF (beautiful version)
   */
  function renderPrepBreakdown(doc, orders, yPos) {
    const jaynaBlue = [33, 150, 243];
    const black = [33, 33, 33];
    const gray = [102, 102, 102];
    const lightGray = [240, 240, 240];

    // Combine all line items
    const allLineItems = [];
    orders.forEach(order => {
      if (order.catering_order_items) {
        allLineItems.push(...order.catering_order_items);
      }
    });

    const prep = calculateCateringPrepList(allLineItems);

    // Title section with background
    yPos += 0.15;
    const titleBoxHeight = 0.35;
    doc.setFillColor(jaynaBlue[0], jaynaBlue[1], jaynaBlue[2]);
    doc.rect(0.5, yPos, 7.5, titleBoxHeight, 'F');

    doc.setFontSize(14);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(255, 255, 255);
    doc.text('PREP LIST BREAKDOWN', 0.65, yPos + 0.22);

    yPos += titleBoxHeight + 0.20;

    // Helper function to draw checkbox
    function drawCheckbox(x, y, size = 0.10) {
      doc.setDrawColor(gray[0], gray[1], gray[2]);
      doc.setLineWidth(0.01);
      doc.rect(x, y - size + 0.02, size, size, 'S');
    }

    // Helper function to render section
    function renderSection(title, items, yPos) {
      if (items.length === 0) return yPos;

      // Section header with subtle background
      doc.setFillColor(lightGray[0], lightGray[1], lightGray[2]);
      doc.rect(0.5, yPos - 0.05, 7.5, 0.22, 'F');

      doc.setFontSize(11);
      doc.setFont('helvetica', 'bold');
      doc.setTextColor(black[0], black[1], black[2]);
      doc.text(title, 0.65, yPos + 0.10);
      yPos += 0.25;

      // Items
      doc.setFontSize(10);
      doc.setFont('helvetica', 'normal');
      doc.setTextColor(black[0], black[1], black[2]);

      items.forEach(item => {
        drawCheckbox(0.70, yPos);
        doc.text(item, 0.95, yPos);
        yPos += 0.16;
      });

      yPos += 0.10;
      return yPos;
    }

    // BYO GYROS section
    if (prep.byoGyros.total > 0) {
      const sets = Math.ceil(prep.byoGyros.total / 20);  // 20 portions per 1 set of sauces
      const items = [
        `${sets}x 16oz Tzatziki (no dill)`,
        `${sets}x 16oz Spicy Aioli`,
        `${sets}x 16oz Lemon Vinaigrette`
      ];

      const fullPans = Math.floor(sets / 2);
      const halfPans = sets % 2;
      let panText = fullPans > 0 && halfPans > 0 ? `${fullPans} full + 1 half pan` :
                    fullPans > 0 ? `${fullPans} full pan${fullPans > 1 ? 's' : ''}` : '1 half pan';
      items.push(`${panText} Mixed Greens`);

      yPos = renderSection(`BYO GYRO PITAS (${prep.byoGyros.total} PORTIONS)`, items, yPos);
    }

    // SALADS section
    if (prep.salads.length > 0) {
      const items = prep.salads.map(s => `${s.qty}x ${s.name}`);
      yPos = renderSection('SALADS', items, yPos);
    }

    // DIPS section
    if (prep.dips.length > 0) {
      const items = prep.dips.map(d => `${d.qty}x ${d.name}`);
      yPos = renderSection('DIPS', items, yPos);
    }

    // SIDES section
    if (prep.sides.length > 0) {
      const items = prep.sides.map(s => `${s.qty}x ${s.name}`);
      yPos = renderSection('SIDES', items, yPos);
    }

    // DESSERTS section
    if (prep.desserts.length > 0) {
      const items = prep.desserts.map(d => `${d.qty}x ${d.name}`);
      yPos = renderSection('DESSERTS', items, yPos);
    }

    return yPos;
  }

  /**
   * NEW: Render catering orders summary page
   */
  function renderCateringOrdersPage(doc, orders, date) {
    doc.addPage();

    const black = [33, 33, 33];
    const grayText = [102, 102, 102];
    const jaynaBlue = [33, 150, 243];

    let yPos = 0.7;

    // Page title
    doc.setFontSize(16);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(black[0], black[1], black[2]);
    doc.text('CATERING ORDERS PREP SUMMARY', 4.25, yPos, { align: 'center' });

    yPos += 0.25;

    // Generated date/time (smaller text)
    doc.setFontSize(9);
    doc.setFont('helvetica', 'italic');
    doc.setTextColor(grayText[0], grayText[1], grayText[2]);
    const now = new Date();
    const generatedStr = formatPacificDateDisplay(now, { month: 'numeric', day: 'numeric', year: 'numeric', hour: 'numeric', minute: '2-digit', hour12: true });
    doc.text(`Generated on: ${generatedStr}`, 4.25, yPos, { align: 'center' });

    yPos += 0.35;

    // Render each order with beautiful boxes
    orders.forEach((order, index) => {
      if (yPos > 9.5) {
        doc.addPage();
        yPos = 0.7;
      }

      const orderStartY = yPos;

      // Order header with blue background
      const headerHeight = 0.30;
      doc.setFillColor(jaynaBlue[0], jaynaBlue[1], jaynaBlue[2]);
      doc.rect(0.5, yPos, 7.5, headerHeight, 'F');

      doc.setFontSize(11);
      doc.setFont('helvetica', 'bold');
      doc.setTextColor(255, 255, 255);
      const orderNum = order.order_number || order.id;
      doc.text(`ORDER #${orderNum} - ${order.customer_name || 'Customer'}`, 0.65, yPos + 0.20);

      yPos += headerHeight + 0.12;

      // Delivery info in gray box (expanded for DUE DATE)
      const infoHeight = 0.35;
      doc.setFillColor(245, 245, 245);
      doc.rect(0.5, yPos, 7.5, infoHeight, 'F');

      // DUE DATE (prominent)
      doc.setFontSize(10);
      doc.setFont('helvetica', 'bold');
      doc.setTextColor(black[0], black[1], black[2]);
      const dueDateObj = parsePacificDate(order.delivery_date || date);
      const dueDateStr = formatPacificDateDisplay(dueDateObj, { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
      doc.text(`DUE DATE: ${dueDateStr}`, 0.65, yPos + 0.14);

      // Delivery time and headcount (smaller, below)
      doc.setFontSize(9);
      doc.setFont('helvetica', 'normal');
      doc.setTextColor(grayText[0], grayText[1], grayText[2]);
      let deliveryTime = 'TBD';
      if (order.delivery_time) {
        const timeObj = new Date(order.delivery_time);
        deliveryTime = formatPacificDateDisplay(timeObj, { hour: 'numeric', minute: '2-digit', hour12: true });
      }
      doc.text(`Delivery Time: ${deliveryTime} | Headcount: ${order.headcount || 'N/A'}`, 0.65, yPos + 0.28);

      yPos += infoHeight + 0.15;

      // Line items with bullets
      if (order.catering_order_items && order.catering_order_items.length > 0) {
        doc.setFontSize(9);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(black[0], black[1], black[2]);

        order.catering_order_items.forEach(item => {
          if (yPos > 10) {
            doc.addPage();
            yPos = 0.7;
          }

          // Draw bullet point
          doc.setFillColor(jaynaBlue[0], jaynaBlue[1], jaynaBlue[2]);
          doc.circle(0.62, yPos - 0.02, 0.02, 'F');

          doc.text(`${item.quantity}x ${item.item_name}`, 0.75, yPos);
          yPos += 0.16;
        });
      }

      yPos += 0.20;

      // Separator between orders
      if (index < orders.length - 1) {
        doc.setDrawColor(200, 200, 200);
        doc.setLineWidth(0.01);
        doc.line(0.5, yPos, 8.0, yPos);
        yPos += 0.25;
      }
    });

    // Add prep breakdown showing what needs to be made
    yPos += 0.3;
    if (yPos > 9.5) {
      doc.addPage();
      yPos = 0.7;
    }
    yPos = renderPrepBreakdown(doc, orders, yPos);
  }

  /**
   * Send prep sheet PDF to printer via email
   */
  function printPrepSheet() {
    // Print button now emails PDF to printer
    emailPrepSheetToPrinter();

    let html = `
<!DOCTYPE html>
<html>
<head>
  <title>Prep Sheet - ${dateStr}</title>
  <style>
    @page {
      margin: 0.5in;
    }
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      color: #212121;
      font-size: 9pt;
      line-height: 1.3;
    }
    .header {
      text-align: center;
      margin-bottom: 16pt;
      border-bottom: 2px solid #2196F3;
      padding-bottom: 8pt;
    }
    .header h1 {
      font-size: 16pt;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1.2px;
      color: #212121;
      margin-bottom: 4pt;
    }
    .header .subtitle {
      font-size: 9pt;
      color: #666;
      font-weight: 400;
    }
    .section {
      margin-bottom: 14pt;
      page-break-inside: avoid;
    }
    .section-header {
      background: #424242;
      color: white;
      padding: 6pt 8pt;
      font-size: 10pt;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      border: 2px solid #424242;
    }
    .section-header.urgent {
      background: #212121;
      border-color: #212121;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      border: 2px solid #424242;
      border-top: none;
    }
    th {
      background: #f5f5f5;
      padding: 5pt 6pt;
      font-size: 8pt;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #666;
      border-bottom: 2px solid #e0e0e0;
      text-align: left;
    }
    td {
      padding: 5pt 6pt;
      border-bottom: 1px solid #e0e0e0;
      font-size: 8pt;
      vertical-align: top;
    }
    tr:last-child td {
      border-bottom: none;
    }
    .item-name {
      font-weight: 700;
      color: #212121;
      text-transform: uppercase;
      font-size: 9pt;
      letter-spacing: 0.3px;
    }
    .last-count {
      font-size: 8pt;
      color: #000;
      margin-top: 1pt;
    }
    .stock-value {
      font-weight: 700;
      font-size: 10pt;
      color: #212121;
    }
    .stock-value.out {
      color: #d32f2f;
      text-transform: uppercase;
      font-size: 9pt;
      letter-spacing: 0.5px;
    }
    .stock-label {
      font-size: 7pt;
      color: #666;
      text-transform: uppercase;
      margin-top: 1pt;
    }
    .recommend-value {
      font-weight: 700;
      font-size: 11pt;
      color: #2196F3;
    }
    .reasoning {
      font-size: 7pt;
      color: #666;
      font-style: italic;
      line-height: 1.2;
    }
    .col-name { width: 28%; }
    .col-current { width: 15%; text-align: center; }
    .col-par { width: 15%; text-align: center; }
    .col-recommend { width: 12%; text-align: center; }
    .col-reasoning { width: 30%; }
    .footer {
      margin-top: 16pt;
      padding-top: 8pt;
      border-top: 1px solid #e0e0e0;
      font-size: 7pt;
      color: #999;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>Prep Sheet - ${dateStr}</h1>
    <div class="subtitle">Generated ${new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}</div>
  </div>
`;

    // Render each priority group
    if (urgent.length > 0) {
      html += renderPrintPriorityGroup('URGENT - Out of Stock', urgent, 'urgent');
    }
    if (high.length > 0) {
      html += renderPrintPriorityGroup('HIGH PRIORITY - Low Stock', high, 'high');
    }
    if (medium.length > 0) {
      html += renderPrintPriorityGroup('MEDIUM PRIORITY', medium, 'medium');
    }
    if (low.length > 0) {
      html += renderPrintPriorityGroup('LOW PRIORITY - Stock Good', low, 'low');
    }

    html += `
  <div class="footer">
    Jayna Organic Eatery | Prep Recommendations
  </div>
</body>
</html>`;

    printWindow.document.write(html);
    printWindow.document.close();
    printWindow.print();
  }

  /**
   * Render a priority group for printing
   */
  function renderPrintPriorityGroup(title, items, priority) {
    // LOW PRIORITY items: use compact list format
    if (priority === 'low') {
      const itemList = items.map(item =>
        `<span style="display: inline-block; width: 32%; padding: 2pt 4pt; font-size: 6pt; color: #666;">${item.itemName} (${item.stockPercentage.toFixed(0)}%)</span>`
      ).join('');

      return `
        <div class="section">
          <div class="section-header ${priority}">${title} (${items.length} items)</div>
          <div style="background: white; border: 2px solid #424242; border-top: none; padding: 6pt 8pt; display: flex; flex-wrap: wrap;">
            ${itemList}
          </div>
        </div>
      `;
    }

    // URGENT, HIGH, MEDIUM: use full table format
    const itemRows = items.map(item => {
      const lastCountStr = item.lastCountedDate
        ? formatLastCountForPrepSheet(item.lastCountedDate, item.countedBy)
        : 'Never counted';
      const isOut = item.currentStock === 0;
      const stockDisplay = isOut ? 'OUT' : `${item.currentStock} ${item.unit}`;
      const recommendValue = item.recommendedAmount > 0 ? item.recommendedAmount : '‚Äî';

      return `
        <tr>
          <td class="col-name">
            <div class="item-name">${item.itemName}</div>
            <div class="last-count">${lastCountStr}</div>
          </td>
          <td class="col-current">
            <div class="stock-value ${isOut ? 'out' : ''}">${stockDisplay}</div>
            <div class="stock-label">Current</div>
          </td>
          <td class="col-par">
            <div class="stock-value">${item.parLevel} ${item.unit}</div>
            <div class="stock-label">Par</div>
          </td>
          <td class="col-recommend">
            <div class="recommend-value">${recommendValue}</div>
            <div class="stock-label">To Make</div>
          </td>
          <td class="col-reasoning">
            <div class="reasoning">${item.reasoning}</div>
          </td>
        </tr>
      `;
    }).join('');

    return `
      <div class="section">
        <div class="section-header ${priority}">${title} (${items.length} items)</div>
        <table>
          <thead>
            <tr>
              <th class="col-name">ITEM NAME</th>
              <th class="col-current">CURRENT</th>
              <th class="col-par">PAR</th>
              <th class="col-recommend">RECOMMEND</th>
              <th class="col-reasoning">REASONING</th>
            </tr>
          </thead>
          <tbody>
            ${itemRows}
          </tbody>
        </table>
      </div>
    `;
  }

  // ===================================================================
  // INVOICE CHECK-IN SYSTEM - DOM-BASED MODAL APPROACH (SAFE)
  // ===================================================================

  /**
   * Select invoice type (invoice vs order)
   */
  function selectInvoiceType(type) {
    console.log('Selected invoice type:', type);
    orderingSystemState.invoiceType = type;

    const description = document.getElementById('invoiceTypeDescription');
    const uploadSection = document.getElementById('uploadSection');
    const pendingOrderMetadata = document.getElementById('pendingOrderMetadata');
    const pendingOrderDate = document.getElementById('pendingOrderDate');

    if (type === 'invoice') {
      description.innerHTML = '<strong>INVOICE MODE:</strong> Items will be checked in immediately and inventory quantities will be UPDATED (qty += received amount).';

      // Enable upload section
      uploadSection.style.opacity = '1';
      uploadSection.style.pointerEvents = 'auto';
      uploadSection.querySelector('h4').textContent = 'Upload Invoice Image';
      uploadSection.querySelector('p').textContent = 'Take a photo or select an image from your device';

      // Hide pending order fields
      pendingOrderMetadata.style.display = 'none';

    } else if (type === 'order') {
      description.innerHTML = '<strong>PENDING ORDER MODE:</strong> Enter order details below, then upload the order document. Inventory will NOT be updated until you check in the order on delivery day.';

      // Show pending order metadata fields
      pendingOrderMetadata.style.display = 'block';

      // Set min date to today
      if (pendingOrderDate) {
        pendingOrderDate.min = getPacificDate();
      }

      // Enable upload section
      uploadSection.style.opacity = '1';
      uploadSection.style.pointerEvents = 'auto';
      uploadSection.querySelector('h4').textContent = 'Upload Order Document';
      uploadSection.querySelector('p').textContent = 'Upload the order document or CSV';

    } else {
      // No type selected - gray out upload
      description.textContent = 'Select whether this is an invoice from a delivery you\'re receiving now, or a pending order for a future date.';
      uploadSection.style.opacity = '0.5';
      uploadSection.style.pointerEvents = 'none';
      uploadSection.querySelector('p').textContent = 'Select document type above first';
      pendingOrderMetadata.style.display = 'none';
    }
  }

  /**
   * Handle invoice/order image upload
   */
  function handleInvoiceUpload(event) {
    const file = event.target.files[0];
    if (!file) return;

    // REQUIRED: Check if document type is selected
    if (!orderingSystemState.invoiceType) {
      showMessage('‚ùå Please select DOCUMENT TYPE first (Invoice or Pending Order)', 'error');
      // Reset file input
      event.target.value = '';
      return;
    }

    // REQUIRED: If pending order, validate metadata fields are filled
    if (orderingSystemState.invoiceType === 'order') {
      const nameInput = document.getElementById('pendingOrderName');
      const dateInput = document.getElementById('pendingOrderDate');

      if (!nameInput || !nameInput.value.trim()) {
        showMessage('‚ùå Please enter YOUR NAME for the pending order', 'error');
        event.target.value = '';
        if (nameInput) nameInput.focus();
        return;
      }

      if (!dateInput || !dateInput.value) {
        showMessage('‚ùå Please select EXPECTED DELIVERY DATE for the pending order', 'error');
        event.target.value = '';
        if (dateInput) dateInput.focus();
        return;
      }

      // Store metadata in orderingSystemState for use when creating the order
      orderingSystemState.pendingOrderMetadata = {
        createdBy: nameInput.value.trim(),
        expectedDeliveryDate: dateInput.value,
        notes: document.getElementById('pendingOrderNotes')?.value.trim() || ''
      };

      console.log('üìã Pending order metadata stored:', orderingSystemState.pendingOrderMetadata);
    }

    // Validate file type (accept images, PDFs, CSV, and Excel)
    const isImage = file.type.startsWith('image/');
    const isPDF = file.type === 'application/pdf';
    const isCSV = file.name.endsWith('.csv') || file.type === 'text/csv';
    const isExcel = file.name.endsWith('.xlsx') || file.name.endsWith('.xls') ||
                    file.type === 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' ||
                    file.type === 'application/vnd.ms-excel';

    if (!isImage && !isPDF && !isCSV && !isExcel) {
      showMessage('Please upload an image, PDF, CSV, or Excel file', 'error');
      return;
    }

    // Handle CSV files (Auto-detect vendor format)
    if (isCSV) {
      detectVendorAndParseCSV(file);
      return;
    }

    // Handle Excel files (Invoice Insights)
    if (isExcel) {
      handlePFGInsightsExcel(file);
      return;
    }

    /**
     * Detect Vendor from CSV Headers and Route to Appropriate Parser
     */
    async function detectVendorAndParseCSV(file) {
      const reader = new FileReader();
      reader.onload = async function(e) {
        const csvText = e.target.result;

        // Parse just the header row to detect vendor
        Papa.parse(csvText, {
          header: true,
          preview: 1, // Just read first row to get headers
          complete: async function(results) {
            const headers = results.meta.fields || [];
            console.log('üìã Detected CSV headers:', headers);

            // Detect vendor by header columns
            const hasPFGHeaders = headers.includes('Product #') && headers.includes('Manufacturer Product #') && headers.includes('GTIN');
            const hasGreenleafHeaders = headers.includes('Product No.') && headers.includes('Description') && headers.includes('Receiving Date');
            const hasManiHeaders = headers.includes('Item Code') && headers.includes('Item Name') && headers.includes('Order Qty');

            if (hasPFGHeaders) {
              console.log('‚úÖ Detected PFG Invoice format');
              showMessage('Detected PFG Invoice - Processing...', 'success');
              handlePFGInvoiceCSV(file);
            } else if (hasGreenleafHeaders) {
              console.log('‚úÖ Detected Greenleaf Invoice format');
              showMessage('Detected Greenleaf Invoice - Processing...', 'success');
              handleGreenleafInvoiceCSV(file);
            } else if (hasManiHeaders) {
              console.log('‚úÖ Detected Mani Invoice format');
              showMessage('Detected Mani Invoice - Processing...', 'success');
              handleManiInvoiceCSV(file);
            } else {
              console.log('ü§ñ Unknown vendor format - Using SMART UNIVERSAL parser');
              showMessage('Unknown vendor - Using smart parser...', 'success');
              handleUniversalSmartCSV(file, headers);
            }
          }
        });
      };
      reader.readAsText(file);
    }

    /**
     * Handle Greenleaf Invoice CSV Upload
     * Parses Greenleaf order CSV format
     * Columns: Product No., Description, Order Date, Receiving Date, Unit Price, Quantity
     */
    async function handleGreenleafInvoiceCSV(file) {
      console.log('ü•¨ Handling Greenleaf Invoice CSV:', file.name);
      console.log('üìã Document type:', orderingSystemState.invoiceType);
      showMessage('Processing Greenleaf CSV...', 'success');

      // Type already set by selectInvoiceType - DO NOT override

      const reader = new FileReader();
      reader.onload = async function(e) {
        const csvText = e.target.result;

        // Parse CSV with PapaParse
        Papa.parse(csvText, {
          header: true,
          skipEmptyLines: true,
          complete: async function(results) {
            console.log('‚úÖ CSV parsed:', results.data.length, 'rows');

            if (results.errors.length > 0) {
              console.warn('CSV parsing errors:', results.errors);
            }

            // Clear existing extracted items
            orderingSystemState.extractedInvoiceItems = [];

            // Load ALL inventory items if not loaded
            if (orderingSystemState.items.length === 0) {
              console.log('Loading inventory items...');
              await loadInventoryItemsForOrdering();
            }

            // Extract items from CSV
            let itemsMatched = 0;
            let itemsNotMatched = 0;

            for (const row of results.data) {
              // Parse Greenleaf columns
              const productNo = row['Product No.']?.trim();
              const description = row['Description']?.trim();
              const quantity = parseFloat(row['Quantity']) || 0;
              const unitPrice = parseFloat(row['Unit Price']) || 0;
              const receivingDate = row['Receiving Date']?.trim();

              if (!description || quantity === 0) {
                console.warn('Skipping row with no description or 0 quantity');
                continue;
              }

              // Extract item name from description (everything before pack size info)
              // Example: "WILD ARUGULA                        4#/CS" -> "WILD ARUGULA"
              // Remove pack size patterns like "4#/CS", "24ct/CS", "1bunch/EA", "25#", "90ct"
              let itemName = description.replace(/\s+\d+(\.\d+)?(#|ct|bunch|lb|oz|g|kg)(\/[A-Z]+)?/gi, '').trim();
              itemName = itemName.replace(/\s+/g, ' ').trim(); // Normalize whitespace

              console.log(`\nü•¨ Processing: ${itemName} (Greenleaf #${productNo})`);
              console.log(`   Description: ${description}`);
              console.log(`   Quantity: ${quantity}, Price: $${unitPrice}`);

              // Try to match with existing inventory using fuzzy matching
              let matchedItem = null;
              let matchConfidence = 0;

              // PRIORITY 1: Match by item_number (Greenleaf Product No.)
              matchedItem = orderingSystemState.items.find(inv =>
                inv.item_number && inv.item_number.toLowerCase() === productNo.toLowerCase()
              );

              if (matchedItem) {
                matchConfidence = 1.0;
                console.log(`‚úÖ MATCHED by item_number: ${matchedItem.item_name} (100%)`);
              } else {
                // PRIORITY 2: Fuzzy match by name
                const fuzzyResult = fuzzyMatchInventoryItem(itemName, 'Greenleaf');
                if (fuzzyResult) {
                  // fuzzyResult has: {id, itemName, vendor, unit, confidence}
                  matchedItem = {
                    id: fuzzyResult.id,
                    item_name: fuzzyResult.itemName,
                    vendor: fuzzyResult.vendor,
                    unit: fuzzyResult.unit
                  };
                  matchConfidence = fuzzyResult.confidence;
                  console.log(`‚úÖ FUZZY MATCHED: "${itemName}" -> "${matchedItem.item_name}" (${(matchConfidence * 100).toFixed(1)}%)`);
                }
              }

              if (matchedItem && matchConfidence >= 0.7) {
                // Matched successfully
                orderingSystemState.extractedInvoiceItems.push({
                  id: Date.now() + Math.random(),
                  detectedName: itemName,
                  detectedQuantity: quantity,
                  detectedPrice: unitPrice,
                  detectedUnit: matchedItem.unit || 'case',
                  matchedInventoryId: matchedItem.id,
                  matchedItemName: matchedItem.item_name,
                  matchedVendor: matchedItem.vendor,
                  matchConfidence: matchConfidence,
                  skipped: false,
                  flaggedAsNew: false,
                  greenleafData: {
                    productNo: productNo,
                    description: description,
                    receivingDate: receivingDate,
                    vendor: 'Greenleaf'
                  }
                });
                itemsMatched++;
              } else {
                // No match - add to extracted items for manual review
                orderingSystemState.extractedInvoiceItems.push({
                  id: Date.now() + Math.random(),
                  detectedName: itemName,
                  detectedQuantity: quantity,
                  detectedPrice: unitPrice,
                  detectedUnit: 'case',
                  matchedInventoryId: null,
                  matchedItemName: null,
                  matchedVendor: null,
                  matchConfidence: 0,
                  skipped: false,
                  flaggedAsNew: true,
                  greenleafData: {
                    productNo: productNo,
                    description: description,
                    receivingDate: receivingDate,
                    vendor: 'Greenleaf'
                  }
                });
                itemsNotMatched++;
                console.warn(`‚ö†Ô∏è NO MATCH FOUND for: ${itemName}`);
              }
            }

            console.log(`\n‚úÖ Greenleaf CSV processed:`);
            console.log(`   - Items matched: ${itemsMatched}`);
            console.log(`   - Items not matched: ${itemsNotMatched}`);
            console.log(`   - Total items: ${orderingSystemState.extractedInvoiceItems.length}`);

            // Show extracted items section
            document.getElementById('extractedItemsSection').style.display = 'block';
            renderExtractedItems();
            showMessage(`‚úÖ Greenleaf CSV processed! ${itemsMatched} items matched, ${itemsNotMatched} need review.`, 'success');
          }
        });
      };
      reader.readAsText(file);
    }

    /**
     * Handle Mani Invoice CSV Upload
     * Parses Mani order CSV format
     * Columns: Item Code, Item Name, Order Qty, Unit Price, etc.
     */
    async function handleManiInvoiceCSV(file) {
      console.log('üçö Handling Mani CSV:', file.name);
      console.log('üìã Document type:', orderingSystemState.invoiceType);
      showMessage('Processing Mani CSV...', 'success');

      // Type already set by selectInvoiceType - DO NOT override

      const reader = new FileReader();
      reader.onload = async function(e) {
        const csvText = e.target.result;

        Papa.parse(csvText, {
          header: true,
          skipEmptyLines: true,
          complete: async function(results) {
            console.log('‚úÖ CSV parsed:', results.data.length, 'rows');

            if (results.errors.length > 0) {
              console.warn('CSV parsing errors:', results.errors);
            }

            orderingSystemState.extractedInvoiceItems = [];

            if (orderingSystemState.items.length === 0) {
              console.log('Loading inventory items...');
              await loadInventoryItemsForOrdering();
            }

            let itemsMatched = 0;
            let itemsNotMatched = 0;

            for (const row of results.data) {
              const itemCode = row['Item Code']?.trim();
              const itemName = row['Item Name']?.trim();
              const quantity = parseFloat(row['Order Qty'] || row['Quantity']) || 0;
              const unitPrice = parseFloat(row['Unit Price'] || row['Price']) || 0;

              if (!itemName || quantity === 0) {
                console.warn('Skipping row with no item name or 0 quantity');
                continue;
              }

              console.log(`\nüçö Processing: ${itemName} (Mani #${itemCode})`);
              console.log(`   Quantity: ${quantity}, Price: $${unitPrice}`);

              let matchedItem = null;
              let matchConfidence = 0;

              // PRIORITY 1: Match by item_number (Mani Item Code)
              matchedItem = orderingSystemState.items.find(inv =>
                inv.item_number && inv.item_number.toLowerCase() === itemCode?.toLowerCase()
              );

              if (matchedItem) {
                matchConfidence = 1.0;
                console.log(`‚úÖ MATCHED by item_number: ${matchedItem.item_name} (100%)`);
              } else {
                // PRIORITY 2: Fuzzy match by name
                const fuzzyResult = fuzzyMatchInventoryItem(itemName, 'Mani');
                if (fuzzyResult) {
                  // fuzzyResult has: {id, itemName, vendor, unit, confidence}
                  matchedItem = {
                    id: fuzzyResult.id,
                    item_name: fuzzyResult.itemName,
                    vendor: fuzzyResult.vendor,
                    unit: fuzzyResult.unit
                  };
                  matchConfidence = fuzzyResult.confidence;
                  console.log(`‚úÖ FUZZY MATCHED: "${itemName}" -> "${matchedItem.item_name}" (${(matchConfidence * 100).toFixed(1)}%)`);
                }
              }

              if (matchedItem && matchConfidence >= 0.7) {
                orderingSystemState.extractedInvoiceItems.push({
                  id: Date.now() + Math.random(),
                  detectedName: itemName,
                  detectedQuantity: quantity,
                  detectedPrice: unitPrice,
                  detectedUnit: matchedItem.unit || 'case',
                  matchedInventoryId: matchedItem.id,
                  matchedItemName: matchedItem.item_name,
                  matchedVendor: matchedItem.vendor,
                  matchConfidence: matchConfidence,
                  skipped: false,
                  flaggedAsNew: false,
                  maniData: {
                    itemCode: itemCode,
                    vendor: 'Mani'
                  }
                });
                itemsMatched++;
              } else {
                orderingSystemState.extractedInvoiceItems.push({
                  id: Date.now() + Math.random(),
                  detectedName: itemName,
                  detectedQuantity: quantity,
                  detectedPrice: unitPrice,
                  detectedUnit: 'case',
                  matchedInventoryId: null,
                  matchedItemName: null,
                  matchedVendor: null,
                  matchConfidence: 0,
                  skipped: false,
                  flaggedAsNew: true,
                  maniData: {
                    itemCode: itemCode,
                    vendor: 'Mani'
                  }
                });
                itemsNotMatched++;
                console.warn(`‚ö†Ô∏è NO MATCH FOUND for: ${itemName}`);
              }
            }

            console.log(`\n‚úÖ Mani CSV processed:`);
            console.log(`   - Items matched: ${itemsMatched}`);
            console.log(`   - Items not matched: ${itemsNotMatched}`);

            // Show extracted items section
            document.getElementById('extractedItemsSection').style.display = 'block';
            renderExtractedItems();
            showMessage(`‚úÖ Mani CSV processed! ${itemsMatched} items matched, ${itemsNotMatched} need review.`, 'success');
          }
        });
      };
      reader.readAsText(file);
    }

    /**
     * UNIVERSAL SMART CSV Parser
     * Intelligently detects columns and parses ANY CSV format
     * Uses AI-like column detection to figure out item names, quantities, prices
     */
    async function handleUniversalSmartCSV(file, detectedHeaders) {
      console.log('ü§ñ SMART UNIVERSAL CSV Parser activated');
      console.log('üìã Document type:', orderingSystemState.invoiceType);
      console.log('üß† Analyzing CSV structure...');

      // Type already set by selectInvoiceType - DO NOT override

      const reader = new FileReader();
      reader.onload = async function(e) {
        const csvText = e.target.result;

        Papa.parse(csvText, {
          header: true,
          skipEmptyLines: true,
          complete: async function(results) {
            console.log('‚úÖ CSV parsed:', results.data.length, 'rows');

            const headers = results.meta.fields || detectedHeaders;
            console.log('üìã Available columns:', headers);

            // INTELLIGENT COLUMN DETECTION
            const columnMap = detectColumns(headers);
            console.log('üß† Smart column detection:', columnMap);

            if (!columnMap.itemName) {
              showMessage('‚ùå Could not detect item name column. Please use a supported vendor format.', 'error');
              return;
            }

            orderingSystemState.extractedInvoiceItems = [];

            if (orderingSystemState.items.length === 0) {
              console.log('Loading inventory items...');
              await loadInventoryItemsForOrdering();
            }

            let itemsMatched = 0;
            let itemsNotMatched = 0;

            for (const row of results.data) {
              const itemName = row[columnMap.itemName]?.trim();
              const quantity = parseFloat(row[columnMap.quantity] || 1) || 1;
              const unitPrice = parseFloat(row[columnMap.price] || 0) || 0;
              const itemCode = columnMap.itemCode ? row[columnMap.itemCode]?.trim() : null;

              if (!itemName) {
                console.warn('Skipping row with no item name');
                continue;
              }

              console.log(`\nü§ñ Processing: ${itemName}${itemCode ? ` (Code: ${itemCode})` : ''}`);
              console.log(`   Quantity: ${quantity}, Price: $${unitPrice}`);

              let matchedItem = null;
              let matchConfidence = 0;

              // PRIORITY 1: Match by item_number/code
              if (itemCode) {
                matchedItem = orderingSystemState.items.find(inv =>
                  inv.item_number && inv.item_number.toLowerCase() === itemCode.toLowerCase()
                );
                if (matchedItem) {
                  matchConfidence = 1.0;
                  console.log(`‚úÖ MATCHED by item_number: ${matchedItem.item_name} (100%)`);
                }
              }

              // PRIORITY 2: Fuzzy match by name
              if (!matchedItem) {
                const fuzzyResult = fuzzyMatchInventoryItem(itemName, null);
                if (fuzzyResult) {
                  // fuzzyResult has: {id, itemName, vendor, unit, confidence}
                  matchedItem = {
                    id: fuzzyResult.id,
                    item_name: fuzzyResult.itemName,
                    vendor: fuzzyResult.vendor,
                    unit: fuzzyResult.unit
                  };
                  matchConfidence = fuzzyResult.confidence;
                  console.log(`‚úÖ FUZZY MATCHED: "${itemName}" -> "${matchedItem.item_name}" (${(matchConfidence * 100).toFixed(1)}%)`);
                }
              }

              if (matchedItem && matchConfidence >= 0.7) {
                orderingSystemState.extractedInvoiceItems.push({
                  id: Date.now() + Math.random(),
                  detectedName: itemName,
                  detectedQuantity: quantity,
                  detectedPrice: unitPrice,
                  detectedUnit: matchedItem.unit || 'case',
                  matchedInventoryId: matchedItem.id,
                  matchedItemName: matchedItem.item_name,
                  matchedVendor: matchedItem.vendor,
                  matchConfidence: matchConfidence,
                  skipped: false,
                  flaggedAsNew: false,
                  universalData: {
                    itemCode: itemCode,
                    vendor: 'Unknown',
                    detectedColumns: columnMap
                  }
                });
                itemsMatched++;
              } else {
                orderingSystemState.extractedInvoiceItems.push({
                  id: Date.now() + Math.random(),
                  detectedName: itemName,
                  detectedQuantity: quantity,
                  detectedPrice: unitPrice,
                  detectedUnit: 'case',
                  matchedInventoryId: null,
                  matchedItemName: null,
                  matchedVendor: null,
                  matchConfidence: 0,
                  skipped: false,
                  flaggedAsNew: true,
                  universalData: {
                    itemCode: itemCode,
                    vendor: 'Unknown',
                    detectedColumns: columnMap
                  }
                });
                itemsNotMatched++;
                console.warn(`‚ö†Ô∏è NO MATCH FOUND for: ${itemName}`);
              }
            }

            console.log(`\n‚úÖ Smart CSV processed:`);
            console.log(`   - Items matched: ${itemsMatched}`);
            console.log(`   - Items not matched: ${itemsNotMatched}`);

            // Show extracted items section
            document.getElementById('extractedItemsSection').style.display = 'block';
            renderExtractedItems();
            showMessage(`ü§ñ Smart parser processed ${itemsMatched} matches, ${itemsNotMatched} need review.`, 'success');
          }
        });
      };
      reader.readAsText(file);
    }

    /**
     * Intelligent Column Detection
     * Analyzes CSV headers and detects which columns contain item names, quantities, prices
     */
    function detectColumns(headers) {
      const columnMap = {
        itemName: null,
        quantity: null,
        price: null,
        itemCode: null
      };

      // ITEM NAME detection (product, item, description, name)
      const nameKeywords = ['name', 'description', 'product', 'item', 'desc'];
      for (const header of headers) {
        const lower = header.toLowerCase();
        if (nameKeywords.some(kw => lower.includes(kw))) {
          columnMap.itemName = header;
          break;
        }
      }

      // QUANTITY detection (qty, quantity, amount, count, ordered, shipped)
      const qtyKeywords = ['qty', 'quantity', 'amount', 'count', 'order', 'ship'];
      for (const header of headers) {
        const lower = header.toLowerCase();
        if (qtyKeywords.some(kw => lower.includes(kw))) {
          columnMap.quantity = header;
          break;
        }
      }

      // PRICE detection (price, cost, unit price, each)
      const priceKeywords = ['price', 'cost', 'unit', 'each'];
      for (const header of headers) {
        const lower = header.toLowerCase();
        if (priceKeywords.some(kw => lower.includes(kw)) && !lower.includes('total')) {
          columnMap.price = header;
          break;
        }
      }

      // ITEM CODE detection (code, number, sku, id, #)
      const codeKeywords = ['code', 'number', 'sku', 'id', '#', 'no'];
      for (const header of headers) {
        const lower = header.toLowerCase();
        if (codeKeywords.some(kw => lower.includes(kw)) && !lower.includes('phone') && !lower.includes('order')) {
          columnMap.itemCode = header;
          break;
        }
      }

      return columnMap;
    }

    /**
     * Handle PFG Invoice CSV Upload
     * Parses PFG Customer First Invoice Export CSV format
     * Auto-creates missing items with full PFG data tracking
     */
    async function handlePFGInvoiceCSV(file) {
      console.log('üìã Handling PFG CSV:', file.name);
      console.log('üìã Document type:', orderingSystemState.invoiceType);
      showMessage('Processing PFG CSV...', 'success');

      // Type already set by selectInvoiceType - DO NOT override

      const reader = new FileReader();
      reader.onload = async function(e) {
        const csvText = e.target.result;

        // Parse CSV with PapaParse
        Papa.parse(csvText, {
          header: true,
          skipEmptyLines: true,
          complete: async function(results) {
            console.log('‚úÖ CSV parsed:', results.data.length, 'rows');

            if (results.errors.length > 0) {
              console.warn('CSV parsing errors:', results.errors);
            }

            // Clear existing extracted items
            orderingSystemState.extractedInvoiceItems = [];

            // Load ALL inventory items if not loaded
            if (orderingSystemState.items.length === 0) {
              console.log('Loading inventory items...');
              await loadInventoryItemsForOrdering();
            }

            // Extract items from CSV
            let itemsCreated = 0;
            let itemsMatched = 0;

            for (const row of results.data) {
              // Skip rows with no quantity shipped
              const qtyShipped = parseFloat(row['Qty Shipped']) || 0;
              if (qtyShipped === 0) {
                console.log('Skipping item with 0 qty shipped:', row['Product Description']);
                continue;
              }

              const itemName = row['Product Description']?.trim();
              const pfgItemNumber = row['Product #']?.trim();
              const manufacturerItemNumber = row['Manufacturer Product #']?.trim();
              const gtin = row['GTIN']?.trim();
              const category = row['Category/Class']?.trim();
              const brand = row['Brand']?.trim();
              const manufacturerName = row['Manufacturer Name']?.trim();
              const packSize = row['Pack Size']?.trim();
              const uom = row['UOM']?.trim();
              const unitPrice = parseFloat(row['Unit Price']) || 0;

              if (!itemName) {
                console.warn('Skipping row with no product description');
                continue;
              }

              console.log(`\nüì¶ Processing: ${itemName} (PFG #${pfgItemNumber})`);

              // Try to match with existing inventory
              // PRIORITY 1: Match by item_number (PFG Product #)
              let matchedItem = null;
              let matchConfidence = 0;

              if (pfgItemNumber) {
                matchedItem = orderingSystemState.items.find(item => item.item_number === pfgItemNumber);
                if (matchedItem) {
                  matchConfidence = 1.0;
                  console.log(`‚úÖ Matched by item_number: ${matchedItem.itemName}`);
                }
              }

              // PRIORITY 2: Fuzzy match by name if no item_number match
              if (!matchedItem) {
                const fuzzyMatch = fuzzyMatchInventoryItem(itemName, null);
                if (fuzzyMatch && fuzzyMatch.confidence >= 0.7) {
                  const item = orderingSystemState.items.find(i => i.id === fuzzyMatch.id);
                  if (item) {
                    matchedItem = item;
                    matchConfidence = fuzzyMatch.confidence;
                    console.log(`üîç Fuzzy matched: ${matchedItem.itemName} (${Math.round(matchConfidence * 100)}%)`);
                  }
                }
              }

              // Create extracted item object
              const extractedItem = {
                id: Date.now() + Math.random(),
                detectedName: itemName,
                detectedQuantity: qtyShipped,
                detectedQuantityShipped: qtyShipped,
                detectedUnit: uom === 'CS' ? 'case' : uom?.toLowerCase(),
                detectedPrice: unitPrice,
                matchedInventoryId: matchedItem ? matchedItem.id : null,
                matchConfidence: matchConfidence,
                matchedItemName: matchedItem ? matchedItem.itemName : null,
                matchedVendor: matchedItem ? matchedItem.vendor : null,
                skipped: false,
                flaggedAsNew: !matchedItem, // Flag as new if no match found

                // Store PFG data for auto-create and price tracking
                pfgData: {
                  itemNumber: pfgItemNumber,
                  manufacturerItemNumber: manufacturerItemNumber,
                  gtin: gtin,
                  category: category,
                  brand: brand,
                  manufacturerName: manufacturerName,
                  packSize: packSize,
                  invoiceNumber: row['Invoice Number']?.trim(),
                  invoiceDate: row['Invoice Date']?.trim(),
                  vendor: 'PFG' // Always PFG for these invoices
                }
              };

              orderingSystemState.extractedInvoiceItems.push(extractedItem);

              if (matchedItem) {
                itemsMatched++;
              } else {
                itemsCreated++;
                console.log(`üÜï Will auto-create: ${itemName}`);
              }
            }

            console.log(`\nüìä PFG CSV Processing Complete:`);
            console.log(`   - Total items: ${orderingSystemState.extractedInvoiceItems.length}`);
            console.log(`   - Matched: ${itemsMatched}`);
            console.log(`   - New items to create: ${itemsCreated}`);

            // Show extracted items section
            document.getElementById('extractedItemsSection').style.display = 'block';
            renderExtractedItems();

            showMessage(`‚úÖ Processed ${orderingSystemState.extractedInvoiceItems.length} items! ${itemsMatched} matched, ${itemsCreated} new.`, 'success');
          },
          error: function(error) {
            console.error('CSV parsing error:', error);
            showMessage('Failed to parse CSV: ' + error.message, 'error');
          }
        });
      };

      reader.readAsText(file);
    }

    /**
     * Handle PFG Invoice Insights Excel Upload (ONE-TIME IMPORT)
     * This is for initial data seeding, not ongoing system feature
     */
    async function handlePFGInsightsExcel(file) {
      console.log('üìä Handling PFG Invoice Insights Excel (one-time import):', file.name);
      showMessage('Processing Invoice Insights Excel (this may take a moment)...', 'success');

      const reader = new FileReader();
      reader.onload = async function(e) {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });

          // Read first sheet
          const sheetName = workbook.SheetNames[0];
          const sheet = workbook.Sheets[sheetName];
          const rows = XLSX.utils.sheet_to_json(sheet);

          console.log('‚úÖ Excel parsed:', rows.length, 'rows');

          // Process rows and update existing inventory items with item numbers and price history
          let itemsUpdated = 0;
          let itemsNotFound = 0;

          for (const row of rows) {
            const itemName = row['Product Description']?.trim();
            const pfgItemNumber = row['Product #']?.toString()?.trim();
            const manufacturerItemNumber = row['Manufacturer Product #']?.trim();
            const gtin = row['GTIN']?.toString()?.trim();
            const category = row['Category/Class']?.trim();
            const brand = row['Brand']?.trim();
            const manufacturerName = row['Manufacturer Name']?.trim();
            const unitPrice = parseFloat(row['Unit Price']) || 0;

            if (!itemName || !pfgItemNumber) {
              continue;
            }

            // Find matching inventory item by fuzzy name match
            const fuzzyMatch = fuzzyMatchInventoryItem(itemName, null);
            if (fuzzyMatch && fuzzyMatch.confidence >= 0.7) {
              const inventoryItem = orderingSystemState.items.find(i => i.id === fuzzyMatch.id);
              if (inventoryItem) {
                // Update item in database with PFG tracking data
                const { error } = await supabase
                  .from('inventory_items')
                  .update({
                    item_number: pfgItemNumber,
                    manufacturer_item_number: manufacturerItemNumber,
                    gtin: gtin,
                    category: category,
                    brand: brand,
                    manufacturer_name: manufacturerName
                  })
                  .eq('id', inventoryItem.id);

                if (error) {
                  console.error('Failed to update item:', inventoryItem.itemName, error);
                } else {
                  itemsUpdated++;
                  console.log(`‚úÖ Updated: ${inventoryItem.itemName} ‚Üí PFG #${pfgItemNumber}`);
                }
              }
            } else {
              itemsNotFound++;
              console.log(`‚ö†Ô∏è No match found for: ${itemName}`);
            }
          }

          console.log(`\nüìä Insights Excel Import Complete:`);
          console.log(`   - Items updated: ${itemsUpdated}`);
          console.log(`   - Items not matched: ${itemsNotFound}`);

          showMessage(`‚úÖ Imported data for ${itemsUpdated} items! ${itemsNotFound} not matched.`, 'success');

          // Reload inventory to reflect changes
          await loadInventoryItemsForOrdering();

        } catch (error) {
          console.error('Excel processing error:', error);
          showMessage('Failed to process Excel: ' + error.message, 'error');
        }
      };

      reader.readAsArrayBuffer(file);
    }

    // Handle PDF files
    if (isPDF) {
      showMessage('PDF uploaded! Processing with OCR...', 'success');
      const reader = new FileReader();
      reader.onload = async function(e) {
        // Store the PDF data
        orderingSystemState.currentInvoiceImage = e.target.result;

        // Show preview section (show PDF icon placeholder)
        document.getElementById('invoicePreviewSection').style.display = 'block';
        const previewImg = document.getElementById('invoicePreviewImage');

        // Create PDF preview indicator
        previewImg.style.display = 'none';
        let pdfPreview = document.getElementById('pdfPreviewIndicator');
        if (!pdfPreview) {
          pdfPreview = document.createElement('div');
          pdfPreview.id = 'pdfPreviewIndicator';
          pdfPreview.style.cssText = 'padding: 40px; text-align: center; background: var(--gray-100); border: 2px dashed var(--gray-400); border-radius: 0;';
          previewImg.parentNode.insertBefore(pdfPreview, previewImg);
        }
        pdfPreview.innerHTML = `
          <div style="font-size: 48px; margin-bottom: 12px;">üìÑ</div>
          <div style="font-size: 14px; font-weight: 700; color: var(--gray-700); text-transform: uppercase; letter-spacing: 1px;">PDF UPLOADED</div>
          <div style="font-size: 11px; color: var(--gray-600); margin-top: 6px;">${file.name}</div>
        `;
        pdfPreview.style.display = 'block';

        // Hide other sections
        document.getElementById('ocrProcessingStatus').style.display = 'none';
        document.getElementById('extractedItemsSection').style.display = 'none';
      };
      reader.readAsDataURL(file);
      return;
    }

    // Handle image files
    const reader = new FileReader();
    reader.onload = function(e) {
      orderingSystemState.currentInvoiceImage = e.target.result;

      // Show preview section
      document.getElementById('invoicePreviewSection').style.display = 'block';
      const previewImg = document.getElementById('invoicePreviewImage');
      previewImg.src = e.target.result;
      previewImg.style.display = 'block';

      // Hide PDF preview if exists
      const pdfPreview = document.getElementById('pdfPreviewIndicator');
      if (pdfPreview) pdfPreview.style.display = 'none';

      // Hide other sections
      document.getElementById('ocrProcessingStatus').style.display = 'none';
      document.getElementById('extractedItemsSection').style.display = 'none';
    };
    reader.readAsDataURL(file);
  }

  /**
   * Clear uploaded invoice and reset
   */
  function clearInvoiceUpload() {
    orderingSystemState.currentInvoiceImage = null;
    orderingSystemState.extractedInvoiceItems = [];

    document.getElementById('invoiceFileInput').value = '';
    document.getElementById('invoiceCameraInput').value = '';
    document.getElementById('invoicePreviewSection').style.display = 'none';
    document.getElementById('ocrProcessingStatus').style.display = 'none';
    document.getElementById('extractedItemsSection').style.display = 'none';
  }

  /**
   * Convert PDF to images (one per page) for OCR processing
   */
  async function convertPdfToImages(pdfDataUrl) {
    console.log('üìÑ Converting PDF to images...');

    // Extract base64 data
    const base64Data = pdfDataUrl.split(',')[1];
    const binaryData = atob(base64Data);
    const uint8Array = new Uint8Array(binaryData.length);
    for (let i = 0; i < binaryData.length; i++) {
      uint8Array[i] = binaryData.charCodeAt(i);
    }

    // Load PDF with PDF.js
    const loadingTask = pdfjsLib.getDocument({ data: uint8Array });
    const pdf = await loadingTask.promise;

    console.log(`üìÑ PDF loaded: ${pdf.numPages} page(s)`);

    const images = [];

    // Process ALL pages
    for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
      console.log(`üìÑ Processing page ${pageNum}/${pdf.numPages}...`);

      const page = await pdf.getPage(pageNum);

      // Set scale for good quality (2 = 2x resolution)
      const scale = 2.0;
      const viewport = page.getViewport({ scale });

      // Create canvas for this page
      const canvas = document.createElement('canvas');
      const context = canvas.getContext('2d');
      canvas.width = viewport.width;
      canvas.height = viewport.height;

      // Render PDF page to canvas
      await page.render({
        canvasContext: context,
        viewport: viewport
      }).promise;

      console.log(`‚úÖ Page ${pageNum} rendered:`, canvas.width, 'x', canvas.height);

      // Convert canvas to image data URL
      const imageDataUrl = canvas.toDataURL('image/png');
      images.push(imageDataUrl);
    }

    console.log(`‚úÖ All ${pdf.numPages} pages converted to images`);

    return images;
  }

  /**
   * ============================================
   * VENDOR FORMAT LEARNING SYSTEM
   * ============================================
   */

  /**
   * Load custom vendor formats from database and populate dropdown
   */
  async function loadCustomVendorFormats() {
    try {
      const { data: formats, error } = await supabase
        .from('vendor_formats')
        .select('*')
        .eq('active', true)
        .order('format_name');

      if (error) throw error;

      if (formats && formats.length > 0) {
        const dropdown = document.getElementById('ocrVendorFormat');
        const addNewOption = dropdown.querySelector('option[value="__ADD_NEW__"]');

        // Add custom formats before "ADD NEW" option
        formats.forEach(format => {
          const option = document.createElement('option');
          option.value = format.format_id;
          option.textContent = format.format_name;
          option.dataset.customFormat = 'true';
          dropdown.insertBefore(option, addNewOption);
        });

        console.log('‚úÖ Loaded', formats.length, 'custom vendor formats');
      }
    } catch (error) {
      console.warn('Failed to load custom formats:', error);
    }
  }

  /**
   * Handle vendor format dropdown change
   */
  async function handleVendorFormatChange(value) {
    if (value === '__ADD_NEW__') {
      showCreateFormatModal();
    } else {
      // Store selected format for later use
      orderingSystemState.selectedVendorFormat = value;
      console.log('Selected vendor format:', value);

      // If this is a custom format (not hardcoded), fetch its database ID
      const dropdown = document.getElementById('ocrVendorFormat');
      const selectedOption = dropdown.querySelector(`option[value="${value}"]`);

      if (selectedOption && selectedOption.dataset.customFormat === 'true') {
        // Fetch format ID from database
        const { data, error } = await supabase
          .from('vendor_formats')
          .select('id')
          .eq('format_id', value)
          .single();

        if (!error && data) {
          orderingSystemState.currentVendorFormatId = data.id;
          console.log('‚úÖ Format ID loaded:', data.id);
        }
      } else {
        // Hardcoded formats don't have DB IDs yet
        orderingSystemState.currentVendorFormatId = null;
      }
    }
  }

  /**
   * Show modal to create new vendor format
   */
  function showCreateFormatModal() {
    const modal = document.createElement('div');
    modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10000;';

    const content = document.createElement('div');
    content.style.cssText = 'background: white; padding: 24px; max-width: 500px; width: 90%; border: 3px solid var(--gray-700);';

    content.innerHTML = `
      <h3 style="margin: 0 0 16px 0; font-size: 16px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;">
        üß† CREATE NEW VENDOR FORMAT
      </h3>
      <p style="margin: 0 0 20px 0; font-size: 13px; color: var(--gray-600); line-height: 1.5;">
        Give this format a name (e.g., "Greenleaf Order", "Sysco Invoice").
        The system will learn from your manual corrections and improve accuracy next time!
      </p>

      <label style="display: block; margin-bottom: 8px; font-size: 11px; font-weight: 700; text-transform: uppercase; color: var(--gray-700); letter-spacing: 0.5px;">
        FORMAT NAME
      </label>
      <input
        type="text"
        id="newFormatName"
        placeholder="e.g., Greenleaf Order"
        style="width: 100%; padding: 12px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 14px; margin-bottom: 20px; box-sizing: border-box;"
        autofocus
      />

      <div style="display: flex; gap: 12px; justify-content: flex-end;">
        <button
          onclick="closeCreateFormatModal()"
          style="padding: 12px 24px; background: var(--gray-100); border: 2px solid var(--gray-300); color: var(--gray-900); font-size: 13px; font-weight: 700; cursor: pointer; text-transform: uppercase; letter-spacing: 0.5px;"
        >
          CANCEL
        </button>
        <button
          onclick="saveNewVendorFormat()"
          style="padding: 12px 24px; background: var(--gray-900); border: 2px solid var(--gray-900); color: white; font-size: 13px; font-weight: 700; cursor: pointer; text-transform: uppercase; letter-spacing: 0.5px;"
        >
          CREATE
        </button>
      </div>
    `;

    modal.appendChild(content);
    document.body.appendChild(modal);
    modal.id = 'createFormatModal';

    // Focus input
    setTimeout(() => document.getElementById('newFormatName').focus(), 100);

    // Allow Enter key to submit
    document.getElementById('newFormatName').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') saveNewVendorFormat();
    });
  }

  /**
   * Close create format modal
   */
  function closeCreateFormatModal() {
    const modal = document.getElementById('createFormatModal');
    if (modal) modal.remove();

    // Reset dropdown to previously selected format
    const dropdown = document.getElementById('ocrVendorFormat');
    dropdown.value = orderingSystemState.selectedVendorFormat || 'auto';
  }

  /**
   * Save new vendor format
   */
  async function saveNewVendorFormat() {
    const nameInput = document.getElementById('newFormatName');
    const formatName = nameInput.value.trim();

    if (!formatName) {
      nameInput.style.borderColor = 'red';
      return;
    }

    // Generate format_id from name (e.g., "Greenleaf Order" ‚Üí "greenleaf-order")
    const formatId = formatName.toLowerCase().replace(/[^a-z0-9]+/g, '-');

    showLoading('Creating Format', `Saving "${formatName}"...`);

    try {
      const { data, error } = await supabase
        .from('vendor_formats')
        .insert({
          format_name: formatName,
          format_id: formatId,
          parsing_rules: {}, // Empty initially, will be populated from corrections
          sample_corrections: [],
          confidence_score: 0,
          created_by: 'User',
          notes: 'Created via OCR interface'
        })
        .select()
        .single();

      if (error) throw error;

      hideLoading();
      closeCreateFormatModal();

      // Add to dropdown
      const dropdown = document.getElementById('ocrVendorFormat');
      const addNewOption = dropdown.querySelector('option[value="__ADD_NEW__"]');
      const option = document.createElement('option');
      option.value = formatId;
      option.textContent = formatName;
      option.dataset.customFormat = 'true';
      dropdown.insertBefore(option, addNewOption);

      // Select the new format
      dropdown.value = formatId;
      orderingSystemState.selectedVendorFormat = formatId;
      orderingSystemState.currentVendorFormatId = data.id; // Store DB ID for corrections

      showMessage(`‚úÖ Created format "${formatName}"! System will learn from your corrections.`, 'success');
    } catch (error) {
      hideLoading();
      console.error('Error creating format:', error);
      showMessage('Failed to create format: ' + error.message, 'error');
    }
  }

  /**
   * Track OCR correction for learning
   * Call this when user manually edits item name, quantity, or price
   */
  async function trackOCRCorrection(originalItem, correctedData) {
    if (!orderingSystemState.currentVendorFormatId) return; // No format selected

    try {
      const correction = {
        format_id: orderingSystemState.currentVendorFormatId,
        invoice_id: orderingSystemState.currentInvoiceId || null,
        original_text: originalItem.detectedName,
        corrected_item_name: correctedData.itemName,
        corrected_quantity: correctedData.quantity,
        corrected_price: correctedData.price,
        full_line_text: originalItem.fullLineText || originalItem.detectedName,
        correction_type: determineCorrectionType(originalItem, correctedData)
      };

      const { error } = await supabase
        .from('ocr_corrections')
        .insert(correction);

      if (error) throw error;

      console.log('üìù Logged correction for learning:', correction);

      // Update format's sample_corrections for pattern learning
      await updateFormatPatterns(orderingSystemState.currentVendorFormatId, correction);

    } catch (error) {
      console.warn('Failed to track correction:', error);
    }
  }

  /**
   * Determine what type of correction was made
   */
  function determineCorrectionType(original, corrected) {
    const itemChanged = original.detectedName !== corrected.itemName;
    const qtyChanged = original.detectedQuantity !== corrected.quantity;
    const priceChanged = original.detectedPrice !== corrected.price;

    if (itemChanged && qtyChanged && priceChanged) return 'all';
    if (itemChanged) return 'item_name';
    if (qtyChanged) return 'quantity';
    if (priceChanged) return 'price';
    return 'none';
  }

  /**
   * Update format patterns based on correction
   */
  async function updateFormatPatterns(formatId, correction) {
    try {
      // Fetch current format
      const { data: format, error: fetchError } = await supabase
        .from('vendor_formats')
        .select('sample_corrections, parsing_rules')
        .eq('id', formatId)
        .single();

      if (fetchError) throw fetchError;

      // Add this correction to samples (keep last 50)
      const samples = format.sample_corrections || [];
      samples.push({
        original: correction.original_text,
        corrected_name: correction.corrected_item_name,
        corrected_qty: correction.corrected_quantity,
        corrected_price: correction.corrected_price,
        timestamp: new Date().toISOString()
      });

      // Keep only last 50 corrections
      const recentSamples = samples.slice(-50);

      // Analyze patterns (simple pattern detection for now)
      const patterns = analyzeCorrections(recentSamples);

      // Update format
      const { error: updateError } = await supabase
        .from('vendor_formats')
        .update({
          sample_corrections: recentSamples,
          parsing_rules: patterns,
          updated_at: new Date().toISOString()
        })
        .eq('id', formatId);

      if (updateError) throw updateError;

      console.log('üß† Updated format patterns:', patterns);

    } catch (error) {
      console.warn('Failed to update patterns:', error);
    }
  }

  /**
   * Detect vendor from OCR text
   * Looks for known vendor names in the header of the invoice
   */
  function detectVendorFromText(text) {
    if (!text) return null;

    // Check first 500 characters (vendor info usually at top)
    const header = text.substring(0, 500).toLowerCase();
    
    // Known vendor patterns (add more as needed)
    const vendorPatterns = [
      { pattern: /greenleaf|green\s*leaf/i, vendor: 'Greenleaf' },
      { pattern: /performance\s*food|pfg/i, vendor: 'Performance' },
      { pattern: /mani\s*imports?/i, vendor: 'Mani Imports' },
      { pattern: /eatopia/i, vendor: 'Eatopia' },
      { pattern: /restaurant\s*depot/i, vendor: 'Restaurant Depot' },
      { pattern: /alsco/i, vendor: 'Alsco' },
      { pattern: /src\s*pumping/i, vendor: 'SRC Pumping' },
      { pattern: /southern\s*glazer/i, vendor: 'Southern Glazer\'s' },
      { pattern: /breakthru\s*bev/i, vendor: 'Breakthru Beverage' },
      { pattern: /sysco/i, vendor: 'Sysco' },
      { pattern: /us\s*foods/i, vendor: 'US Foods' }
    ];

    for (const { pattern, vendor } of vendorPatterns) {
      if (pattern.test(header)) {
        console.log('‚úÖ Vendor detected:', vendor, 'from pattern:', pattern);
        return vendor;
      }
    }

    console.log('‚ö†Ô∏è No vendor detected from text');
    return null;
  }

  /**
   * Analyze corrections to detect patterns
   * This is a simple version - can be enhanced with ML
   */
  function analyzeCorrections(samples) {
    if (!samples || samples.length < 3) return {}; // Need at least 3 samples

    const patterns = {
      common_price_positions: [],
      common_quantity_patterns: [],
      item_name_length_avg: 0,
      detected_at: new Date().toISOString()
    };

    // Analyze where prices typically appear
    const priceMatches = samples.map(s => {
      const match = s.original.match(/\$?\d+\.\d{2}/);
      return match ? match.index : -1;
    }).filter(i => i !== -1);

    if (priceMatches.length > 0) {
      patterns.common_price_positions = [Math.round(priceMatches.reduce((a,b) => a+b) / priceMatches.length)];
    }

    // Analyze average item name length
    const nameLengths = samples.map(s => s.corrected_name?.length || 0).filter(l => l > 0);
    if (nameLengths.length > 0) {
      patterns.item_name_length_avg = Math.round(nameLengths.reduce((a,b) => a+b) / nameLengths.length);
    }

    return patterns;
  }

  /**
   * Process invoice with Tesseract OCR
   */
  async function processInvoiceOCR() {
    if (!orderingSystemState.currentInvoiceImage) {
      showMessage('No image uploaded', 'error');
      return;
    }

    // Show processing status
    document.getElementById('ocrProcessingStatus').style.display = 'block';
    document.getElementById('ocrProgressText').textContent = 'Initializing OCR engine...';
    document.getElementById('processOCRButton').disabled = true;

    try {
      // Check if Tesseract is loaded
      if (typeof Tesseract === 'undefined') {
        throw new Error('Tesseract OCR library not loaded. Please refresh the page.');
      }

      console.log('Starting OCR process...');
      console.log('Image data:', orderingSystemState.currentInvoiceImage?.substring(0, 50));

      // Check if this is a PDF file
      const isPDF = orderingSystemState.currentInvoiceImage.startsWith('data:application/pdf');
      let extractedText = '';

      if (isPDF) {
        console.log('üìÑ PDF detected - converting to images and processing all pages...');
        document.getElementById('ocrProgressText').textContent = 'Converting PDF to images...';

        // Check if PDF.js is loaded
        if (typeof pdfjsLib === 'undefined') {
          throw new Error('PDF.js library not loaded. Please refresh the page.');
        }

        // Convert PDF to multiple images (one per page)
        const images = await convertPdfToImages(orderingSystemState.currentInvoiceImage);
        console.log('‚úÖ PDF converted to', images.length, 'image(s)');

        // Process each page with OCR
        for (let i = 0; i < images.length; i++) {
          const pageNum = i + 1;
          console.log(`üîç OCR processing page ${pageNum}/${images.length}...`);
          document.getElementById('ocrProgressText').textContent = `Extracting text from page ${pageNum}/${images.length}...`;

          const result = await Tesseract.recognize(
            images[i],
            'eng',
            {
              logger: (m) => {
                if (m.status === 'recognizing text') {
                  const progress = Math.round(m.progress * 100);
                  document.getElementById('ocrProgressText').textContent = `Page ${pageNum}/${images.length}: ${progress}%`;
                }
              }
            }
          );

          const pageText = result?.data?.text || '';
          console.log(`‚úÖ Page ${pageNum} OCR completed: ${pageText.length} characters`);

          // Combine text from all pages
          extractedText += pageText + '\n\n'; // Add spacing between pages
        }

        console.log('‚úÖ All pages processed. Total text length:', extractedText.length);

      } else {
        // Process single image
        document.getElementById('ocrProgressText').textContent = 'Loading OCR engine...';

        const result = await Tesseract.recognize(
          orderingSystemState.currentInvoiceImage,
          'eng',
          {
            logger: (m) => {
              console.log('Tesseract progress:', m);
              if (m.status === 'recognizing text') {
                document.getElementById('ocrProgressText').textContent = `Extracting text: ${Math.round(m.progress * 100)}%`;
              }
            }
          }
        );

        console.log('OCR completed, result:', result);
        extractedText = result?.data?.text || '';
      }
      console.log('Extracted text length:', extractedText.length);
      console.log('First 200 chars:', extractedText.substring(0, 200));

      // Update progress
      document.getElementById('ocrProgressText').textContent = 'Parsing extracted text...';

      // Parse the extracted text to find items
      const extractedItems = parseInvoiceText(extractedText);
      console.log('Parsed items:', extractedItems.length);

      // Detect vendor from OCR text for better matching
      const detectedVendor = detectVendorFromText(extractedText);
      console.log('üè¢ Detected vendor from invoice:', detectedVendor || 'none');

      // Update progress
      document.getElementById('ocrProgressText').textContent = 'Matching items with inventory...';

      // Ensure inventory items are loaded
      if (!orderingSystemState.items || orderingSystemState.items.length === 0) {
        console.warn('No inventory items loaded for matching');
      }

      // Match items with inventory using advanced fuzzy matching (only if items were found)
      if (extractedItems.length > 0) {
        for (const item of extractedItems) {
          const match = fuzzyMatchInventoryItem(item.detectedName, detectedVendor);
          if (match) {
            item.matchedInventoryId = match.id;
            item.matchConfidence = match.confidence;
            item.matchedItemName = match.itemName;
            item.matchedVendor = match.vendor; // NEW: Get vendor from matched inventory item
            
            // If unit wasn't detected, use inventory item's unit
            if (!item.detectedUnit && match.unit) {
              item.detectedUnit = match.unit;
            }
          }
        }
        
        // NEW: Determine the most likely vendor from matched items
        const vendorCounts = {};
        extractedItems.forEach(item => {
          if (item.matchedVendor) {
            vendorCounts[item.matchedVendor] = (vendorCounts[item.matchedVendor] || 0) + 1;
          }
        });
        
        // Get vendor with most matches
        let determinedVendor = null;
        let maxCount = 0;
        for (const [vendor, count] of Object.entries(vendorCounts)) {
          if (count > maxCount) {
            maxCount = count;
            determinedVendor = vendor;
          }
        }
        
        if (determinedVendor) {
          console.log(`üè¢ Vendor determined from item matching: ${determinedVendor} (${maxCount}/${extractedItems.length} items matched)`);
          // Store for later use
          orderingSystemState.determinedVendor = determinedVendor;
        }
      }

      // Store extracted items (even if empty array - user can add manually)
      orderingSystemState.extractedInvoiceItems = extractedItems;

      // Hide processing, show results
      document.getElementById('ocrProcessingStatus').style.display = 'none';
      document.getElementById('extractedItemsSection').style.display = 'block';

      // Render extracted items (will show "add manually" button if empty)
      renderExtractedItems();

      // Re-enable button
      document.getElementById('processOCRButton').disabled = false;

      // Show appropriate message
      if (extractedItems.length === 0) {
        showMessage('No items auto-detected. You can add items manually below.', 'info');
      } else {
        showMessage(`Successfully extracted ${extractedItems.length} items from invoice!`, 'success');
      }

    } catch (error) {
      console.error('OCR processing error:', error);
      const errorMsg = error?.message || error?.toString() || 'Unknown error occurred';
      showMessage('Failed to process invoice: ' + errorMsg, 'error');
      document.getElementById('ocrProcessingStatus').style.display = 'none';
      document.getElementById('processOCRButton').disabled = false;
    }
  }

  /**
   * Parse extracted OCR text to find line items
   * Simple pattern matching for common invoice formats
   */
  function parseInvoiceText(text) {
    if (!text) {
      console.warn('No text provided to parseInvoiceText');
      return [];
    }

    const items = [];

    // CRITICAL: Filter out blank lines (OCR creates double newlines)
    const allLines = text.split('\n');
    const lines = allLines.map(l => l.trim()).filter(l => l.length > 0);

    console.log('üîç Parsing OCR text - Total lines (after removing blanks):', lines.length);
    console.log('üìÑ Invoice type:', orderingSystemState.invoiceType || 'invoice');

    // ==== PERFORMANCE ORDER FORMAT ====
    // Format from image:
    // WATER DRINKING
    // 543845 HILTON (6-digit SKU + Brand)
    // 24/16.9 OZ    Confirmed: 2    Qty: 2
    // CS            $5.12           $10.24

    const vendorFormat = document.getElementById('ocrVendorFormat')?.value || 'auto';

    if (orderingSystemState.invoiceType === 'order' || vendorFormat === 'performance-order') {
      console.log('üîç Trying Performance Order format...');
      console.log('üìÑ Vendor format selected:', vendorFormat);
      console.log('üìÑ First 15 OCR lines:');
      for (let i = 0; i < Math.min(15, lines.length); i++) {
        console.log(`  Line ${i}: "${lines[i]}"`);
      }

      for (let i = 0; i < lines.length - 3; i++) {
        const currentLine = lines[i].trim();
        const nextLine = lines[i + 1].trim();
        const line3 = lines[i + 2].trim();
        const line4 = lines[i + 3].trim();

        // Look for SKU pattern: Line starts with 6 digits followed by brand name
        // Example: "543845 HILTON" or "276375 COKE ZERO"
        const skuMatch = nextLine.match(/^(\d{6})\s+(.+)$/);

        if (skuMatch) {
          const itemName = currentLine; // Line BEFORE SKU is the item name
          const sku = skuMatch[1];
          const brand = skuMatch[2];

          console.log(`  ‚úì Found SKU pattern: "${sku} ${brand}" at line ${i+1}`);
          console.log(`  ‚Üí Item name (line ${i}): "${itemName}"`);

          // Skip if item name is junk (too short, just numbers, etc.)
          if (itemName.length < 3 || itemName.match(/^[\d\s\-\/]+$/)) {
            console.log(`  ‚úó Skipping - item name is junk`);
            continue;
          }

          // Extract quantity from "Confirmed: X" in line3
          let quantity = 1;
          const confirmedMatch = line3.match(/confirmed:?\s*(\d+)/i);
          if (confirmedMatch) {
            quantity = parseInt(confirmedMatch[1]);
            console.log(`  ‚úì Extracted quantity: ${quantity} from line ${i+2}`);
          }

          // Extract price from line4 or nearby lines
          // Performance orders show: "CS $35.55 $70.22" (unit price, then total)
          // We want the FIRST price (unit price per case)
          let price = null;

          // Try to find price in next 5 lines after item
          for (let j = i + 2; j < Math.min(i + 7, lines.length); j++) {
            const priceLine = lines[j];

            // Pattern 1: "CS $XX.XX" or "CS $XX.XX $YYY.YY" (unit price first)
            const csWithPrice = priceLine.match(/cs\s+\$(\d+\.\d{2})/i);
            if (csWithPrice) {
              price = parseFloat(csWithPrice[1]);
              console.log(`  ‚úì Found CS unit price: $${price} at line ${j} [${priceLine.trim()}]`);
              break;
            }

            // Pattern 2: Just "$XX.XX" anywhere in line (first occurrence)
            const dollarMatch = priceLine.match(/\$(\d+\.\d{2})/);
            if (dollarMatch && !price) {  // Only if we haven't found CS price yet
              const foundPrice = parseFloat(dollarMatch[1]);
              // Reasonable price range check (avoid order numbers like $55229235)
              if (foundPrice > 0.01 && foundPrice < 1000) {
                price = foundPrice;
                console.log(`  ‚úì Found $ price: $${price} at line ${j} [${priceLine.trim()}]`);
                break;
              }
            }

            // Pattern 3: Numbers that look like prices (without $, OCR might miss it)
            // Look for XX.XX pattern after "CS" or "Confirmed"
            if (!price) {
              const numericPrice = priceLine.match(/(?:cs|confirmed:?\s+\d+).*?(\d+\.\d{2})/i);
              if (numericPrice) {
                const foundPrice = parseFloat(numericPrice[1]);
                if (foundPrice > 0.50 && foundPrice < 1000) {
                  price = foundPrice;
                  console.log(`  ‚úì Found numeric price: $${price} at line ${j} [${priceLine.trim()}]`);
                  break;
                }
              }
            }
          }

          if (!price) {
            console.log(`  ‚ö†Ô∏è No price found for "${itemName}"`);
          }

          // Extract unit from nearby lines (CS, EA, LB, etc.)
          let detectedUnit = null;
          for (let j = Math.max(0, i - 1); j < Math.min(i + 5, lines.length); j++) {
            const unitLine = lines[j];
            const unitMatch = unitLine.match(/\b(cs|case|ea|each|lb|lbs|pound|kg|oz|gallon|gal|bt|bottle)\b/i);
            if (unitMatch) {
              detectedUnit = unitMatch[1].toUpperCase();
              if (detectedUnit === 'CASE') detectedUnit = 'CS';
              if (detectedUnit === 'EACH') detectedUnit = 'EA';
              if (detectedUnit === 'POUND' || detectedUnit === 'LBS') detectedUnit = 'LB';
              if (detectedUnit === 'GALLON') detectedUnit = 'GAL';
              if (detectedUnit === 'BOTTLE') detectedUnit = 'BT';
              console.log(`  ‚úì Detected unit: ${detectedUnit} from line ${j}`);
              break;
            }
          }

          // Try to extract Qty Shipped (if different from Qty Ordered)
          // Look for patterns like "Shipped: X" or "Ship Qty: X"
          let qtyShipped = null;
          for (let j = i; j < Math.min(i + 5, lines.length); j++) {
            const shippedMatch = lines[j].match(/(?:shipped|ship\s*qty|qty\s*ship):?\s*(\d+)/i);
            if (shippedMatch) {
              qtyShipped = parseInt(shippedMatch[1]);
              if (qtyShipped !== quantity) {
                console.log(`  ‚úì Qty Shipped: ${qtyShipped} (different from ordered: ${quantity})`);
              }
              break;
            }
          }

          items.push({
            id: Date.now() + Math.random() + i,
            detectedName: itemName,
            detectedQuantity: quantity,
            detectedQuantityShipped: qtyShipped, // NEW: Track shipped vs ordered
            detectedUnit: detectedUnit,          // NEW: Unit detection
            detectedPrice: price,
            matchedInventoryId: null,
            matchConfidence: 0,
            matchedItemName: null,
            matchedVendor: null                   // NEW: Will be set after matching
          });

          console.log(`‚úÖ Added item: "${itemName}" | Ordered: ${quantity}${qtyShipped && qtyShipped !== quantity ? ` | Shipped: ${qtyShipped}` : ''} | Unit: ${detectedUnit || 'N/A'} | Price: ${price ? '$' + price : 'N/A'}`);

          // Skip the lines we just processed
          // Instead of fixed skip, find the next item by looking for the next SKU
          // This handles variable spacing (Information lines, blank lines, etc.)
          let skipCount = 0;
          for (let j = i + 2; j < lines.length; j++) {
            skipCount++;
            const nextLine = lines[j];

            // Stop if we find the next SKU pattern (6 digits)
            if (nextLine.match(/^\d{6}\s+/)) {
              skipCount--; // Back up one so loop will land on item name before SKU
              break;
            }

            // Safety: max skip 10 lines
            if (skipCount >= 10) break;
          }

          console.log(`  ‚Üí Skipping ${skipCount} lines to next item`);
          i += skipCount;
        }
      }

      console.log('üìä Performance Order format matched items:', items.length);

      if (items.length > 0) {
        return items; // Success!
      }
    }

    // ==== STANDARD INVOICE FORMAT ====
    // Pattern to match: quantity, item name, unit, price
    // Example: "2 Arugula 4# CS 12.50" or "1.5 Fresh Basil Bunch EA 8.99"
    const itemPattern = /^[\s]*([0-9]+\.?[0-9]*)\s+(.+?)\s+([0-9]+\.[0-9]{2})[\s]*$/;
    
    // Enhanced pattern to catch unit in the line
    const itemWithUnitPattern = /^[\s]*([0-9]+\.?[0-9]*)\s+(.+?)\s+(CS|EA|LB|KG|OZ|GAL|BT|CASE|EACH|POUND)\s+([0-9]+\.[0-9]{2})[\s]*$/i;

    // Try pattern matching first
    let patternMatchCount = 0;
    for (const line of lines) {
      const trimmed = line.trim();
      if (trimmed.length < 5) continue; // Skip short lines

      // Try unit-aware pattern first
      let match = trimmed.match(itemWithUnitPattern);
      let detectedUnit = null;
      
      if (match) {
        const quantity = parseFloat(match[1]);
        const name = match[2].trim();
        detectedUnit = match[3].toUpperCase();
        const price = parseFloat(match[4]);
        
        // Normalize unit names
        if (detectedUnit === 'CASE') detectedUnit = 'CS';
        if (detectedUnit === 'EACH') detectedUnit = 'EA';
        if (detectedUnit === 'POUND') detectedUnit = 'LB';

        // Only add if quantity is reasonable (0.25 to 1000)
        if (quantity >= 0.25 && quantity <= 1000 && name.length > 2) {
          items.push({
            id: Date.now() + Math.random(),
            detectedName: name,
            detectedQuantity: quantity,
            detectedQuantityShipped: null,
            detectedUnit: detectedUnit,
            detectedPrice: price,
            matchedInventoryId: null,
            matchConfidence: 0,
            matchedItemName: null,
            matchedVendor: null
          });
          patternMatchCount++;
        }
      } else {
        // Try standard pattern (no unit in line)
        match = trimmed.match(itemPattern);
        if (match) {
          const quantity = parseFloat(match[1]);
          const name = match[2].trim();
          const price = parseFloat(match[3]);

          // Only add if quantity is reasonable (0.25 to 1000)
          if (quantity >= 0.25 && quantity <= 1000 && name.length > 2) {
            items.push({
              id: Date.now() + Math.random(),
              detectedName: name,
              detectedQuantity: quantity,
              detectedQuantityShipped: null,
              detectedUnit: null,
              detectedPrice: price,
              matchedInventoryId: null,
              matchConfidence: 0,
              matchedItemName: null,
              matchedVendor: null
            });
            patternMatchCount++;
          }
        }
      }
    }

    console.log('üìä Standard format matched items:', patternMatchCount);

    // If no pattern matches found, show ALL lines for manual matching
    if (items.length === 0) {
      console.log('‚ö†Ô∏è No pattern matches - showing ALL lines for manual review');

      // Skip common header/footer lines
      const skipPatterns = [
        /^(order|invoice|po#|est\.|qty|total|subtotal|tax|page)/i,
        /^[0-9]{10,}$/, // Long numbers (order IDs)
        /^[0-9\/\-]+$/, // Just dates
        /^\s*$/  // Empty
      ];

      for (let i = 0; i < lines.length; i++) {
        const trimmed = lines[i].trim();

        // Skip very short or very long lines
        if (trimmed.length < 3 || trimmed.length > 100) continue;

        // Skip header/footer patterns
        let shouldSkip = false;
        for (const pattern of skipPatterns) {
          if (pattern.test(trimmed)) {
            shouldSkip = true;
            break;
          }
        }

        if (shouldSkip) continue;

        // Add as potential item (user can skip/match manually)
        items.push({
          id: Date.now() + Math.random() + i, // Temporary ID
          detectedName: trimmed,
          detectedQuantity: 1, // Default quantity
          detectedQuantityShipped: null,
          detectedUnit: null,
          detectedPrice: null, // No price detected
          matchedInventoryId: null,
          matchConfidence: 0,
          matchedItemName: null,
          matchedVendor: null
        });
      }

      console.log('üìã Created', items.length, 'potential items from OCR lines for manual review');
    }

    return items;
  }

  /**
   * Fuzzy match detected item name with inventory items
   * Returns {id, itemName, confidence} or null
   */
  /**
   * Calculate Levenshtein distance between two strings
   * Industry-standard algorithm for string similarity
   */
  function levenshteinDistance(str1, str2) {
    const len1 = str1.length;
    const len2 = str2.length;
    const matrix = Array(len2 + 1).fill(null).map(() => Array(len1 + 1).fill(0));

    for (let i = 0; i <= len1; i++) matrix[0][i] = i;
    for (let j = 0; j <= len2; j++) matrix[j][0] = j;

    for (let j = 1; j <= len2; j++) {
      for (let i = 1; i <= len1; i++) {
        const cost = str1[i - 1] === str2[j - 1] ? 0 : 1;
        matrix[j][i] = Math.min(
          matrix[j][i - 1] + 1,     // deletion
          matrix[j - 1][i] + 1,     // insertion
          matrix[j - 1][i - 1] + cost // substitution
        );
      }
    }

    return matrix[len2][len1];
  }

  /**
   * Advanced normalization for better matching
   * Handles common OCR errors and variations
   */
  function normalizeForMatching(text) {
    return text
      .toLowerCase()
      .replace(/\b(case|cs|pack|pk|box|bx|ea|each|lb|lbs|pound|oz|ounce)\b/gi, '') // Remove unit words
      .replace(/[^\w\s]/g, ' ')  // Replace special chars with space
      .replace(/\s+/g, ' ')      // Collapse multiple spaces
      .trim();
  }

  /**
   * Generate character n-grams for fuzzy matching
   * Helps catch OCR errors and misspellings
   */
  function getNgrams(text, n = 2) {
    const ngrams = new Set();
    for (let i = 0; i <= text.length - n; i++) {
      ngrams.add(text.substring(i, i + n));
    }
    return ngrams;
  }

  /**
   * Calculate n-gram similarity between two strings
   * More robust than simple word matching
   */
  function ngramSimilarity(str1, str2, n = 2) {
    const ngrams1 = getNgrams(str1, n);
    const ngrams2 = getNgrams(str2, n);
    
    const intersection = new Set([...ngrams1].filter(x => ngrams2.has(x)));
    const union = new Set([...ngrams1, ...ngrams2]);
    
    return union.size > 0 ? intersection.size / union.size : 0;
  }

  /**
   * Advanced fuzzy matching with multiple strategies
   * Based on industry best practices for OCR and user input matching
   */
  function fuzzyMatchInventoryItem(detectedName, contextVendor = null) {
    console.log('üîç fuzzyMatchInventoryItem called with:', detectedName, 'vendor:', contextVendor);
    console.log('üì¶ Total inventory items:', orderingSystemState.items.length);
    console.log('üìö Total learned aliases:', orderingSystemState.aliases ? Object.keys(orderingSystemState.aliases).length : 0);
    
    if (!detectedName || orderingSystemState.items.length === 0) {
      console.log('‚ùå No detected name or empty inventory, returning null');
      return null;
    }

    const normalizedDetected = normalizeForMatching(detectedName);
    console.log('üî§ Normalized detected name:', normalizedDetected);

    // PRIORITY 1: Check learned aliases (exact match from past manual selections)
    const simpleNormalized = detectedName.toLowerCase().replace(/[^a-z0-9\s]/g, '');
    if (orderingSystemState.aliases && orderingSystemState.aliases[simpleNormalized]) {
      const aliasMatch = orderingSystemState.aliases[simpleNormalized];
      console.log('üí° Found alias match:', aliasMatch);
      const item = orderingSystemState.items.find(i => i.id === aliasMatch.inventory_item_id);
      if (item) {
        console.log('‚úÖ LEARNED MATCH:', detectedName, '‚Üí', item.itemName, '(ID:', item.id, ')');
        return {
          id: item.id,
          itemName: item.itemName,
          vendor: item.vendor,
          unit: item.unit,
          confidence: 1.0 // 100% confidence from learned alias
        };
      }
    }

    // PRIORITY 2: Advanced fuzzy matching with multiple algorithms
    console.log('üîé No alias match, starting multi-strategy fuzzy matching...');
    let bestMatch = null;
    let bestScore = 0;
    let allScores = [];

    const detectedWords = normalizedDetected.split(/\s+/).filter(w => w.length > 2);
    const detectedBigrams = getNgrams(normalizedDetected, 2);
    const detectedTrigrams = getNgrams(normalizedDetected, 3);

    for (const item of orderingSystemState.items) {
      const normalizedItem = normalizeForMatching(item.itemName);
      const itemWords = normalizedItem.split(/\s+/).filter(w => w.length > 2);

      // Strategy 1: Token-based matching (word overlap with better logic)
      let tokenScore = 0;
      let matchedWords = 0;
      for (const detWord of detectedWords) {
        let bestWordMatch = 0;
        for (const itemWord of itemWords) {
          // Check both substring containment and similarity
          if (itemWord.includes(detWord) || detWord.includes(itemWord)) {
            bestWordMatch = 1.0;
          } else {
            // Use Levenshtein for near-matches
            const maxLen = Math.max(detWord.length, itemWord.length);
            const dist = levenshteinDistance(detWord, itemWord);
            const similarity = 1 - (dist / maxLen);
            if (similarity > 0.7) { // 70% similar words count
              bestWordMatch = Math.max(bestWordMatch, similarity);
            }
          }
        }
        if (bestWordMatch > 0) {
          matchedWords++;
          tokenScore += bestWordMatch;
        }
      }
      tokenScore = detectedWords.length > 0 ? tokenScore / detectedWords.length : 0;

      // Strategy 2: Character n-gram similarity (catches OCR errors)
      const bigramScore = ngramSimilarity(normalizedDetected, normalizedItem, 2);
      const trigramScore = ngramSimilarity(normalizedDetected, normalizedItem, 3);
      const ngramScore = (bigramScore * 0.6 + trigramScore * 0.4);

      // Strategy 3: Levenshtein distance (normalized)
      const maxLen = Math.max(normalizedDetected.length, normalizedItem.length);
      const levDist = levenshteinDistance(normalizedDetected, normalizedItem);
      const levScore = 1 - (levDist / maxLen);

      // Strategy 4: Exact substring bonus
      let substringBonus = 0;
      if (normalizedItem.includes(normalizedDetected) || normalizedDetected.includes(normalizedItem)) {
        substringBonus = 0.3;
      }

      // Strategy 5: Vendor context bonus (if vendor is known from invoice)
      let vendorBonus = 0;
      if (contextVendor && item.vendor.toLowerCase().includes(contextVendor.toLowerCase())) {
        vendorBonus = 0.15;
      }

      // Weighted combination of all strategies
      // Token matching is most important (40%), then n-grams (25%), then Levenshtein (20%)
      // Bonuses add to the final score
      const combinedScore = (
        tokenScore * 0.40 +
        ngramScore * 0.25 +
        levScore * 0.20 +
        (matchedWords / Math.max(detectedWords.length, itemWords.length, 1)) * 0.15
      ) + substringBonus + vendorBonus;

      // Store detailed score for debugging
      if (combinedScore > 0.15) { // Only log meaningful scores
        allScores.push({
          itemName: item.itemName,
          itemId: item.id,
          vendor: item.vendor,
          finalScore: combinedScore.toFixed(3),
          breakdown: {
            token: tokenScore.toFixed(3),
            ngram: ngramScore.toFixed(3),
            levenshtein: levScore.toFixed(3),
            substring: substringBonus.toFixed(3),
            vendor: vendorBonus.toFixed(3)
          }
        });
      }

      if (combinedScore > bestScore) {
        bestScore = combinedScore;
        bestMatch = {
          id: item.id,
          itemName: item.itemName,
          vendor: item.vendor,        // NEW: Include vendor from inventory item
          unit: item.unit,            // NEW: Include unit from inventory item
          confidence: Math.min(combinedScore, 0.99) // Cap at 99% (only learned aliases get 100%)
        };
      }
    }

    // Sort and log top matches
    allScores.sort((a, b) => parseFloat(b.finalScore) - parseFloat(a.finalScore));
    console.log('üìä Top 10 fuzzy match candidates:', allScores.slice(0, 10));
    console.log('üèÜ Best match:', bestMatch, 'Final score:', bestScore.toFixed(3));

    // Adaptive threshold based on match quality
    // Use lower threshold (0.35) if we have high token matches
    // Use higher threshold (0.50) for low-quality matches
    const threshold = bestScore > 0.6 ? 0.35 : 0.50;
    console.log('üìè Using threshold:', threshold);

    if (bestScore >= threshold) {
      console.log('‚úÖ Match found above threshold:', bestMatch.itemName, '(ID:', bestMatch.id, 'Vendor:', bestMatch.vendor, 'Unit:', bestMatch.unit, ')');
      return bestMatch;
    } else {
      console.log('‚ùå No match found above threshold (best score:', bestScore.toFixed(3), ')');
      return null;
    }
  }

  /**
   * Render extracted invoice items with matched inventory
   * Uses DOM manipulation to avoid template literal issues
   */
  function renderExtractedItems() {
    const container = document.getElementById('extractedItemsList');
    if (!container) return;

    // Clear existing items
    container.innerHTML = '';

    if (orderingSystemState.extractedInvoiceItems.length === 0) {
      // Show message that no items were extracted
      const emptyMessage = document.createElement('div');
      emptyMessage.style.cssText = 'background: var(--gray-100); border: 2px dashed var(--gray-400); padding: 40px 20px; text-align: center; border-radius: 0; margin-bottom: 20px;';

      const icon = document.createElement('div');
      icon.textContent = 'üìã';
      icon.style.cssText = 'font-size: 48px; margin-bottom: 16px;';
      emptyMessage.appendChild(icon);

      const title = document.createElement('div');
      title.textContent = 'NO TEXT DETECTED';
      title.style.cssText = 'font-size: 14px; font-weight: 700; color: var(--gray-900); margin-bottom: 8px; letter-spacing: 1px;';
      emptyMessage.appendChild(title);

      const desc = document.createElement('div');
      desc.textContent = 'OCR could not extract any text from the image. Please try a clearer photo.';
      desc.style.cssText = 'font-size: 12px; color: var(--gray-600);';
      emptyMessage.appendChild(desc);

      container.appendChild(emptyMessage);
      return; // No items to display
    }

    // Create a card for each extracted item
    orderingSystemState.extractedInvoiceItems.forEach((item, index) => {
      const card = document.createElement('div');
      card.style.cssText = 'background: var(--white); border: 2px solid var(--gray-300); border-radius: 0; padding: 12px; margin-bottom: 10px;';

      // Header row with detected name and quantity
      const headerRow = document.createElement('div');
      headerRow.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; gap: 12px;';

      const detectedName = document.createElement('strong');
      detectedName.textContent = item.detectedName;
      detectedName.style.cssText = 'font-size: 14px; color: var(--gray-900); text-transform: uppercase; letter-spacing: 0.5px; flex: 1;';

      // Editable quantity input
      const qtyContainer = document.createElement('div');
      qtyContainer.style.cssText = 'display: flex; align-items: center; gap: 6px;';

      const qtyLabel = document.createElement('span');
      qtyLabel.textContent = 'QTY:';
      qtyLabel.style.cssText = 'font-size: 11px; font-weight: 700; color: var(--gray-700); letter-spacing: 0.5px;';
      qtyContainer.appendChild(qtyLabel);

      const qtyInput = document.createElement('input');
      qtyInput.type = 'number';
      qtyInput.min = '0';
      qtyInput.step = '1';
      qtyInput.value = item.detectedQuantity;
      qtyInput.style.cssText = 'width: 60px; padding: 6px 8px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 13px; font-weight: 700; text-align: center; background: white;';
      qtyInput.onchange = function() {
        item.detectedQuantity = parseInt(this.value) || 1;
        console.log('‚úèÔ∏è Updated quantity for', item.detectedName, '‚Üí', item.detectedQuantity);
      };
      qtyContainer.appendChild(qtyInput);

      headerRow.appendChild(detectedName);
      headerRow.appendChild(qtyContainer);
      card.appendChild(headerRow);

      // Match confidence indicator
      const matchRow = document.createElement('div');
      matchRow.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;';

      const matchInfo = document.createElement('div');
      matchInfo.style.flex = '1';

      if (item.matchedInventoryId) {
        // Has a match
        const matchLabel = document.createElement('div');
        matchLabel.textContent = 'Matched: ' + item.matchedItemName;
        matchLabel.style.cssText = 'font-size: 12px; color: var(--gray-700); margin-bottom: 4px;';

        const confidenceBadge = document.createElement('span');
        const confidence = Math.round(item.matchConfidence * 100);
        confidenceBadge.textContent = confidence + '%';
        confidenceBadge.style.cssText = 'font-size: 10px; padding: 2px 6px; border-radius: 0; font-weight: 700; letter-spacing: 0.5px;';

        // Grayscale based on confidence (darker = higher confidence)
        if (item.matchConfidence >= 0.7) {
          confidenceBadge.style.background = 'var(--gray-700)';
          confidenceBadge.style.color = 'var(--white)';
        } else if (item.matchConfidence >= 0.5) {
          confidenceBadge.style.background = 'var(--gray-400)';
          confidenceBadge.style.color = 'var(--gray-900)';
        } else {
          confidenceBadge.style.background = 'var(--gray-300)';
          confidenceBadge.style.color = 'var(--gray-700)';
        }

        matchInfo.appendChild(matchLabel);
        matchInfo.appendChild(confidenceBadge);
      } else {
        // No match found
        const noMatchLabel = document.createElement('div');
        noMatchLabel.textContent = 'NO MATCH FOUND';
        noMatchLabel.style.cssText = 'font-size: 11px; color: var(--gray-500); font-weight: 700; letter-spacing: 0.5px;';
        matchInfo.appendChild(noMatchLabel);
      }

      matchRow.appendChild(matchInfo);

      // Button container for MATCH, ADD NEW, and SKIP
      // ALWAYS show these buttons - user needs control even on 100% matches!
      const btnContainer = document.createElement('div');
      btnContainer.style.cssText = 'display: flex; gap: 6px;';

      // MATCH/CHANGE button (always visible)
      const manualMatchBtn = document.createElement('button');
      manualMatchBtn.textContent = item.matchedInventoryId ? 'CHANGE' : 'MATCH';
      manualMatchBtn.style.cssText = 'background: var(--gray-100); color: var(--gray-900); border: 2px solid var(--gray-300); padding: 6px 12px; border-radius: 0; cursor: pointer; font-size: 10px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase;';
      manualMatchBtn.onclick = function() {
        console.log('üñ±Ô∏è MATCH/CHANGE button clicked! Index:', index);
        showManualMatchModal(index);
      };
      btnContainer.appendChild(manualMatchBtn);

      // ADD NEW button (always visible)
      const addNewBtn = document.createElement('button');
      addNewBtn.textContent = item.flaggedAsNew ? '‚úì NEW' : 'ADD NEW';
      addNewBtn.style.cssText = item.flaggedAsNew
        ? 'background: #212121; color: white; border: 2px solid #212121; padding: 6px 12px; border-radius: 0; cursor: pointer; font-size: 10px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase;'
        : 'background: white; color: #212121; border: 2px solid #212121; padding: 6px 12px; border-radius: 0; cursor: pointer; font-size: 10px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase;';
      addNewBtn.onclick = function() {
        item.flaggedAsNew = !item.flaggedAsNew;
        if (item.flaggedAsNew) {
          item.matchedInventoryId = null; // Clear any existing match
          item.skipped = false; // Clear skipped if flagging as new
        }
        renderExtractedItems();
      };
      btnContainer.appendChild(addNewBtn);

      // SKIP button (always visible)
      const skipBtn = document.createElement('button');
      skipBtn.textContent = item.skipped ? '‚úì SKIP' : 'SKIP';
      skipBtn.style.cssText = item.skipped
        ? 'background: var(--gray-700); color: white; border: 2px solid var(--gray-700); padding: 6px 12px; border-radius: 0; cursor: pointer; font-size: 10px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase;'
        : 'background: var(--gray-300); color: var(--gray-700); border: 2px solid var(--gray-400); padding: 6px 12px; border-radius: 0; cursor: pointer; font-size: 10px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase;';
      skipBtn.onclick = function() {
        item.skipped = !item.skipped;
        if (item.skipped) {
          item.matchedInventoryId = null; // Clear any existing match
          item.flaggedAsNew = false; // Clear flagged as new
        }
        renderExtractedItems();
      };
      btnContainer.appendChild(skipBtn);

      // Always append buttons (no conditional check)
      matchRow.appendChild(btnContainer);

      card.appendChild(matchRow);

      // Editable price input (optional for orders)
      const priceRow = document.createElement('div');
      priceRow.style.cssText = 'display: flex; align-items: center; gap: 8px; margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--gray-200);';

      const priceLabel = document.createElement('span');
      priceLabel.textContent = orderingSystemState.invoiceType === 'order' ? 'PRICE (per case - optional):' : 'PRICE:';
      priceLabel.style.cssText = 'font-size: 11px; font-weight: 700; color: var(--gray-600); letter-spacing: 0.5px;';
      priceRow.appendChild(priceLabel);

      const priceInputContainer = document.createElement('div');
      priceInputContainer.style.cssText = 'display: flex; align-items: center;';

      const dollarSign = document.createElement('span');
      dollarSign.textContent = '$';
      dollarSign.style.cssText = 'font-size: 13px; font-weight: 700; color: var(--gray-700); margin-right: 4px;';
      priceInputContainer.appendChild(dollarSign);

      const priceInput = document.createElement('input');
      priceInput.type = 'number';
      priceInput.min = '0';
      priceInput.step = '0.01';
      priceInput.placeholder = '0.00';
      priceInput.value = item.detectedPrice ? item.detectedPrice.toFixed(2) : '';
      priceInput.style.cssText = 'width: 80px; padding: 6px 8px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 13px; font-weight: 600; text-align: right; background: white;';
      priceInput.onchange = function() {
        item.detectedPrice = parseFloat(this.value) || null;
        console.log('‚úèÔ∏è Updated price for', item.detectedName, '‚Üí', item.detectedPrice);
      };
      priceInputContainer.appendChild(priceInput);

      priceRow.appendChild(priceInputContainer);
      card.appendChild(priceRow);

      container.appendChild(card);
    });

    // Add vendor selector if type is 'order' (for vendor detection from items)
    if (orderingSystemState.invoiceType === 'order') {
      // Show detected vendor from items
      const vendorSection = document.createElement('div');
      vendorSection.style.cssText = 'margin-top: 24px; padding: 16px; background: white; border: 2px solid var(--gray-300);';

      const vendorLabel = document.createElement('label');
      vendorLabel.textContent = 'VENDOR (Auto-detected from items):';
      vendorLabel.style.cssText = 'display: block; color: var(--gray-700); font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;';
      vendorSection.appendChild(vendorLabel);

      const vendorSelect = document.createElement('select');
      vendorSelect.id = 'orderVendorSelect';
      vendorSelect.style.cssText = 'width: 100%; padding: 10px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 13px; background: white;';

      // Get unique vendors from matched items
      const matchedVendors = [...new Set(
        orderingSystemState.extractedInvoiceItems
          .filter(item => item.matchedVendor)
          .map(item => item.matchedVendor)
      )];

      // If only one vendor detected, auto-select it
      if (matchedVendors.length === 1) {
        const option = document.createElement('option');
        option.value = matchedVendors[0];
        option.textContent = matchedVendors[0];
        option.selected = true;
        vendorSelect.appendChild(option);
      } else {
        // Multiple vendors or none - show dropdown
        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = matchedVendors.length === 0 ? 'No vendor detected - enter manually' : 'Select vendor...';
        vendorSelect.appendChild(defaultOption);

        const vendors = [...new Set(orderingSystemState.items.map(item => item.vendor).filter(v => v))];
        vendors.sort();

        vendors.forEach(vendor => {
          const option = document.createElement('option');
          option.value = vendor;
          option.textContent = vendor;
          if (matchedVendors.includes(vendor)) {
            option.textContent += ' ‚úì';
          }
          vendorSelect.appendChild(option);
        });
      }

      vendorSection.appendChild(vendorSelect);
      container.appendChild(vendorSection);
    }

    // Add action button at the bottom
    const actionButton = document.createElement('button');
    actionButton.className = 'submit-btn';
    actionButton.style.cssText = 'width: 100%; padding: 14px; background: var(--gray-100); color: var(--gray-900); border: 2px solid var(--gray-300); border-radius: 0; font-size: 12px; font-weight: 700; letter-spacing: 1.2px; text-transform: uppercase; cursor: pointer; margin-top: 20px;';

    if (orderingSystemState.invoiceType === 'order') {
      actionButton.textContent = 'SAVE ORDER';
      actionButton.onclick = savePendingOrder;
    } else {
      actionButton.textContent = 'CHECK IN ALL ITEMS';
      actionButton.onclick = checkInInvoiceItems;
    }

    container.appendChild(actionButton);
  }

  /**
   * Show manual matching modal using DOM manipulation (Option 1 - safest)
   * Avoids template literals that caused previous crash
   */
  function showManualMatchModal(itemIndex) {
    console.log('üîç showManualMatchModal called with itemIndex:', itemIndex);
    const item = orderingSystemState.extractedInvoiceItems[itemIndex];
    console.log('üì¶ Extracted item:', item);
    if (!item) {
      console.error('‚ùå No item found at index:', itemIndex);
      return;
    }

    // Create modal overlay
    const overlay = document.createElement('div');
    overlay.id = 'manualMatchModal';
    overlay.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 10000;';

    // Create modal content container
    const modal = document.createElement('div');
    modal.style.cssText = 'background: var(--white); border-radius: 0; padding: 20px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; border: 2px solid var(--gray-400);';

    // Header
    const header = document.createElement('h3');
    header.textContent = 'MANUAL ITEM MATCHING';
    header.style.cssText = 'margin: 0 0 16px 0; font-size: 14px; color: var(--gray-900); font-weight: 700; text-transform: uppercase; letter-spacing: 1px;';
    modal.appendChild(header);

    // Detected item info
    const detectedInfo = document.createElement('div');
    detectedInfo.style.cssText = 'background: var(--gray-100); padding: 12px; border-radius: 0; margin-bottom: 16px; border: 1px solid var(--gray-300);';

    const detectedLabel = document.createElement('div');
    detectedLabel.textContent = 'DETECTED ITEM:';
    detectedLabel.style.cssText = 'font-size: 10px; color: var(--gray-500); margin-bottom: 4px; font-weight: 700; letter-spacing: 0.5px;';
    detectedInfo.appendChild(detectedLabel);

    const detectedName = document.createElement('div');
    detectedName.textContent = item.detectedName;
    detectedName.style.cssText = 'font-size: 14px; font-weight: 700; color: var(--gray-900); text-transform: uppercase; letter-spacing: 0.5px;';
    detectedInfo.appendChild(detectedName);

    modal.appendChild(detectedInfo);

    // Search box
    const searchLabel = document.createElement('label');
    searchLabel.textContent = 'SEARCH INVENTORY:';
    searchLabel.style.cssText = 'display: block; font-size: 11px; margin-bottom: 8px; color: var(--gray-700); font-weight: 700; letter-spacing: 0.5px;';
    modal.appendChild(searchLabel);

    const searchInput = document.createElement('input');
    searchInput.type = 'text';
    searchInput.placeholder = 'Type to search...';
    searchInput.style.cssText = 'width: 100%; padding: 10px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 13px; margin-bottom: 16px; box-sizing: border-box;';
    modal.appendChild(searchInput);

    // Items list container
    const itemsList = document.createElement('div');
    itemsList.id = 'manualMatchItemsList';
    itemsList.style.cssText = 'max-height: 300px; overflow-y: auto; border: 2px solid var(--gray-300); border-radius: 0; margin-bottom: 16px;';
    modal.appendChild(itemsList);

    // Function to render inventory items
    function renderInventoryItems(filter = '') {
      itemsList.innerHTML = '';

      const filterLower = filter.toLowerCase();
      const filteredItems = orderingSystemState.items.filter(invItem =>
        invItem.itemName.toLowerCase().includes(filterLower) ||
        invItem.vendor.toLowerCase().includes(filterLower)
      );

      if (filteredItems.length === 0) {
        const noResults = document.createElement('div');
        noResults.textContent = 'No items found';
        noResults.style.cssText = 'padding: 20px; text-align: center; color: #666;';
        itemsList.appendChild(noResults);
        return;
      }

      // Group by vendor
      const byVendor = {};
      filteredItems.forEach(invItem => {
        if (!byVendor[invItem.vendor]) byVendor[invItem.vendor] = [];
        byVendor[invItem.vendor].push(invItem);
      });

      // Render each vendor group
      Object.keys(byVendor).sort().forEach(vendor => {
        const vendorHeader = document.createElement('div');
        vendorHeader.textContent = vendor;
        vendorHeader.style.cssText = 'background: var(--gray-300); padding: 8px 12px; font-weight: 700; font-size: 11px; color: var(--gray-900); position: sticky; top: 0; text-transform: uppercase; letter-spacing: 1px;';
        itemsList.appendChild(vendorHeader);

        byVendor[vendor].forEach(invItem => {
          const itemRow = document.createElement('div');
          itemRow.style.cssText = 'padding: 10px 12px; border-bottom: 1px solid var(--gray-300); cursor: pointer; display: flex; justify-content: space-between; align-items: center; background: var(--white);';
          itemRow.onmouseover = function() { this.style.background = 'var(--gray-100)'; };
          itemRow.onmouseout = function() { this.style.background = 'var(--white)'; };
          itemRow.onclick = function() {
            // Update the matched item
            orderingSystemState.extractedInvoiceItems[itemIndex].matchedInventoryId = invItem.id;
            orderingSystemState.extractedInvoiceItems[itemIndex].matchedItemName = invItem.itemName;
            orderingSystemState.extractedInvoiceItems[itemIndex].matchConfidence = 1.0; // Manual match = 100%

            // Close modal and re-render
            document.body.removeChild(overlay);
            renderExtractedItems();
            showMessage('Item matched successfully!', 'success');
          };

          const itemName = document.createElement('div');
          itemName.textContent = invItem.itemName;
          itemName.style.cssText = 'font-size: 13px; color: var(--gray-900); font-weight: 600;';
          itemRow.appendChild(itemName);

          const itemUnit = document.createElement('div');
          itemUnit.textContent = invItem.unit;
          itemUnit.style.cssText = 'font-size: 10px; color: var(--gray-700); padding: 2px 6px; background: var(--gray-100); border-radius: 0; font-weight: 700; letter-spacing: 0.5px;';
          itemRow.appendChild(itemUnit);

          itemsList.appendChild(itemRow);
        });
      });
    }

    // Initial render
    renderInventoryItems();

    // Search handler
    searchInput.addEventListener('input', function() {
      renderInventoryItems(this.value);
    });

    // Button row
    const buttonRow = document.createElement('div');
    buttonRow.style.cssText = 'display: flex; gap: 8px;';

    const cancelBtn = document.createElement('button');
    cancelBtn.textContent = 'CANCEL';
    cancelBtn.style.cssText = 'flex: 1; padding: 12px; background: var(--gray-100); color: var(--gray-900); border: 2px solid var(--gray-300); border-radius: 0; font-size: 11px; font-weight: 700; letter-spacing: 1px; cursor: pointer;';
    cancelBtn.onclick = function() {
      document.body.removeChild(overlay);
    };
    buttonRow.appendChild(cancelBtn);

    const createNewBtn = document.createElement('button');
    createNewBtn.textContent = 'CREATE NEW';
    createNewBtn.style.cssText = 'flex: 1; padding: 12px; background: var(--gray-700); color: var(--white); border: 2px solid var(--gray-700); border-radius: 0; font-size: 11px; font-weight: 700; letter-spacing: 1px; cursor: pointer;';
    createNewBtn.onclick = function() {
      // Prompt for new item details (chained prompts)
      showPrompt('Enter item name:', item.detectedName || '', (newItemName) => {
        if (!newItemName || newItemName.trim() === '') {
          showMessage('Item name is required', 'error');
          return;
        }

        const vendorOptions = ['Greenleaf', 'Performance', 'Mani Imports', 'Eatopia', 'Restaurant Depot', 'Alsco', 'SRC Pumping', 'Southern Glazer\'s', 'Breakthru Beverage', 'PREP'];
        showPrompt('Enter vendor name (or choose from: ' + vendorOptions.join(', ') + '):', '', (vendorChoice) => {
          if (!vendorChoice || vendorChoice.trim() === '') {
            showMessage('Vendor is required', 'error');
            return;
          }

          showPrompt('Enter unit (e.g., CS, EA, LB):', '', (unit) => {
            if (!unit || unit.trim() === '') {
              showMessage('Unit is required', 'error');
              return;
            }

            showPrompt('Enter par level (default 0):', '0', (parLevel) => {
              showConfirm('Is this a PREP item?', async () => {
                // YES - it's a prep item
                const itemType = 'prep';

                showPrompt('Enter batch lifespan in hours (default 48):', '48', async (batchLifespan) => {
                  await createNewItem(newItemName, vendorChoice, unit, parLevel, itemType, batchLifespan);
                });
              }, async () => {
                // NO - it's not a prep item
                const itemType = 'ingredient';
                await createNewItem(newItemName, vendorChoice, unit, parLevel, itemType, null);
              });
            });
          });
        });
      });
    };

    async function createNewItem(newItemName, vendorChoice, unit, parLevel, itemType, batchLifespan) {
      // Create the item
      document.body.removeChild(overlay);
      showLoading('Creating New Item', 'Saving to database...');

      try {
        const insertData = {
          item_name: newItemName.trim(),
          vendor: vendorChoice.trim(),
          unit: unit.trim().toUpperCase(),
          par_level: parseFloat(parLevel) || 0,
          current_stock: 0,
          item_type: itemType,
          created_date: new Date().toISOString()
        };

        // Add prep-specific fields if PREP item
        if (itemType === 'prep' && batchLifespan) {
          insertData.batch_lifespan_hours = parseInt(batchLifespan) || 48;
        }

        const { data, error } = await supabase
          .from('inventory_items')
          .insert([insertData])
          .select();

        if (error) throw error;

        // Add to local state
        orderingSystemState.items.push({
          id: data[0].id,
          itemName: data[0].item_name,
          vendor: data[0].vendor,
          parLevel: data[0].par_level,
          currentStock: data[0].current_stock,
          unit: data[0].unit,
          itemType: data[0].item_type,
          batchLifespan: data[0].batch_lifespan_hours,
          lastCountedDate: null
        });

        // Auto-match the newly created item
        orderingSystemState.extractedInvoiceItems[itemIndex].matchedInventoryId = data[0].id;
        orderingSystemState.extractedInvoiceItems[itemIndex].matchedItemName = data[0].item_name;
        orderingSystemState.extractedInvoiceItems[itemIndex].matchConfidence = 1.0;

        hideLoading();
        renderExtractedItems();
        showMessage('New item created and matched!', 'success');
      } catch (error) {
        hideLoading();
        showMessage('Error creating item: ' + error.message, 'error');
      }
    }


    buttonRow.appendChild(createNewBtn);

    const skipBtn = document.createElement('button');
    skipBtn.textContent = 'SKIP';
    skipBtn.style.cssText = 'flex: 1; padding: 12px; background: var(--gray-100); color: var(--gray-900); border: 2px solid var(--gray-300); border-radius: 0; font-size: 11px; font-weight: 700; letter-spacing: 1px; cursor: pointer;';
    skipBtn.onclick = function() {
      // Mark as skipped
      orderingSystemState.extractedInvoiceItems[itemIndex].matchedInventoryId = null;
      orderingSystemState.extractedInvoiceItems[itemIndex].matchConfidence = 0;
      document.body.removeChild(overlay);
      renderExtractedItems();
      showMessage('Item skipped', 'info');
    };
    buttonRow.appendChild(skipBtn);

    modal.appendChild(buttonRow);

    // Assemble modal
    overlay.appendChild(modal);
    console.log('‚úÖ Modal created, appending to body...');
    console.log('üìç Overlay element:', overlay);
    console.log('üìç Modal element:', modal);
    document.body.appendChild(overlay);
    console.log('‚úÖ Modal appended to body successfully!');
    console.log('üìä document.body children count:', document.body.children.length);

    // Check if modal is actually in DOM
    const modalCheck = document.getElementById('manualMatchModal');
    console.log('üîç Modal found in DOM:', modalCheck ? 'YES' : 'NO');
    if (modalCheck) {
      console.log('üìê Modal computed style:', window.getComputedStyle(modalCheck).display);
      console.log('üìê Modal z-index:', window.getComputedStyle(modalCheck).zIndex);
    }

    // Focus search input
    searchInput.focus();
  }

  /**
   * Save order as pending order for future delivery check-in
   */
  async function savePendingOrder() {
    console.log('savePendingOrder called');
    const items = orderingSystemState.extractedInvoiceItems;

    if (items.length === 0) {
      showMessage('No items to save', 'warning');
      return;
    }

    // Get vendor from auto-detected dropdown
    const vendorSelect = document.getElementById('orderVendorSelect');

    if (!vendorSelect || !vendorSelect.value) {
      showMessage('Please select a vendor', 'warning');
      return;
    }

    const vendor = vendorSelect.value;

    // Get delivery date from metadata collected BEFORE upload
    const metadata = orderingSystemState.pendingOrderMetadata || {};
    const deliveryDate = metadata.expectedDeliveryDate;

    if (!deliveryDate) {
      showMessage('‚ùå Expected delivery date is missing. Please go back and fill in the required fields.', 'error');
      return;
    }

    // Filter matched items (exclude skipped and flagged as new)
    const matchedItems = items.filter(item => item.matchedInventoryId && !item.flaggedAsNew && !item.skipped);

    // Get items flagged as NEW to create inventory items
    const newItems = items.filter(item => item.flaggedAsNew && !item.skipped);

    console.log('Matched items to save:', matchedItems.length);
    console.log('New items to create:', newItems.length);

    if (matchedItems.length === 0 && newItems.length === 0) {
      showMessage('Please match items or flag as new', 'warning');
      return;
    }

    // ‚úÖ CREATE NEW INVENTORY ITEMS IMMEDIATELY
    if (newItems.length > 0) {
      showLoading('Creating New Items', `Adding ${newItems.length} new inventory items...`);

      try {
        for (const item of newItems) {
          const { data: newInvItem, error: createError } = await supabase
            .from('inventory_items')
            .insert({
              item_name: item.detectedName,
              vendor: vendor,
              unit: 'EA', // Default unit
              par_level: 0,
              current_stock: 0,
              item_type: 'ingredient',
              created_date: new Date().toISOString()
            })
            .select()
            .single();

          if (createError) {
            console.error('Failed to create item:', item.detectedName, createError);
            continue;
          }

          console.log('‚úÖ Created new inventory item:', newInvItem.item_name, 'ID:', newInvItem.id);

          // Add to local state
          orderingSystemState.items.push({
            id: newInvItem.id,
            itemName: newInvItem.item_name,
            vendor: newInvItem.vendor,
            parLevel: newInvItem.par_level,
            currentStock: newInvItem.current_stock,
            unit: newInvItem.unit,
            itemType: newInvItem.item_type,
            lastCountedDate: null
          });

          // Convert to matched item for order
          item.matchedInventoryId = newInvItem.id;
          item.matchedItemName = newInvItem.item_name;
          item.matchConfidence = 1.0;
          matchedItems.push(item);
        }

        console.log('‚úÖ Created', newItems.length, 'new inventory items!');
      } catch (error) {
        console.error('Error creating new items:', error);
        showMessage('Some items failed to create: ' + error.message, 'warning');
      }
    }

    if (matchedItems.length === 0) {
      hideLoading();
      showMessage('No items were successfully matched or created', 'warning');
      return;
    }

    showLoading('Saving Order', 'Creating pending order...');

    try {
      // Use metadata from form if available, otherwise fall back to existing fields
      const metadata = orderingSystemState.pendingOrderMetadata || {};
      const createdBy = metadata.createdBy || 'System';
      const notes = metadata.notes || '';  // Empty string if no notes, don't show fallback
      const expectedDate = metadata.expectedDeliveryDate || deliveryDate;

      // Create pending order record
      const { data: orderData, error: orderError } = await supabase
        .from('pending_orders')
        .insert({
          vendor: vendor,
          order_date: getPacificDate(),
          expected_delivery_date: expectedDate,
          status: 'pending',
          created_by: createdBy,
          notes: notes,
          total_items: matchedItems.length
        })
        .select()
        .single();

      if (orderError) throw orderError;

      const orderId = orderData.id;
      console.log('Created pending order:', orderId);

      // Create order items
      const orderItems = matchedItems.map(item => ({
        order_id: orderId,
        inventory_item_id: item.matchedInventoryId,
        quantity_ordered: item.detectedQuantity || 0,
        unit: orderingSystemState.items.find(i => i.id === item.matchedInventoryId)?.unit || 'EA',
        item_name: item.matchedItemName,
        vendor: vendor
      }));

      const { error: itemsError } = await supabase
        .from('pending_order_items')
        .insert(orderItems);

      if (itemsError) throw itemsError;

      // ‚úÖ LEARNING: Save matches to invoice_items immediately for future auto-matching
      console.log('üíæ Saving matches to invoice_items for learning...');

      // Create a temporary invoice record for learning purposes
      const { data: invoiceData, error: invoiceError } = await supabase
        .from('invoices')
        .insert({
          invoice_date: getPacificDate(),
          vendor: vendor, // Column is 'vendor' not 'vendor_name'
          invoice_type: 'order', // Added by migration
          entered_by: 'System',
          processed: true,
          notes: `Pending order #${orderId} - saved for learning`
        })
        .select()
        .single();

      if (invoiceError) {
        console.error('‚ùå Failed to create learning invoice:', invoiceError);
        console.error('Invoice data attempted:', {
          invoice_date: getPacificDate(),
          vendor: vendor,
          invoice_type: 'order',
          entered_by: 'System',
          processed: true
        });
      }

      if (!invoiceError && invoiceData) {
        // Save each match for learning
        const learningItems = matchedItems.map(item => {
          const inventoryItem = orderingSystemState.items.find(i => i.id === item.matchedInventoryId);
          const quantity = item.detectedQuantity || 0;
          const unitPrice = item.detectedPrice || 0;
          const totalPrice = quantity * unitPrice;

          return {
            invoice_id: invoiceData.id,
            inventory_item_id: item.matchedInventoryId,

            // Required fields from invoice_items schema
            item_description: item.detectedName,
            quantity: quantity,
            unit: inventoryItem?.unit || 'EA',
            unit_price: unitPrice,
            total_price: totalPrice,
            matched: true,

            // Learning/tracking fields (added via migrations)
            detected_item_name: item.detectedName,
            detected_quantity: quantity,
            detected_price: unitPrice,
            match_confidence: item.matchConfidence,
            matched_at: new Date().toISOString(),
            checked_in: true,
            checked_in_at: new Date().toISOString()
          };
        });

        const { error: learningError } = await supabase
          .from('invoice_items')
          .insert(learningItems);

        if (learningError) {
          console.warn('Failed to save learning data:', learningError);
        } else {
          console.log('‚úÖ Saved', learningItems.length, 'matches for learning!');
        }
      }

      hideLoading();
      showMessage(`‚úÖ Order saved! ${matchedItems.length} items ordered from ${vendor}. Matches saved for future auto-detection!`, 'success');

      // Clear state
      orderingSystemState.extractedInvoiceItems = [];
      orderingSystemState.currentInvoiceImage = null;

      // Clear the extracted items display
      const container = document.getElementById('extractedInvoiceItems');
      if (container) {
        container.innerHTML = '';
      }

      // Clear the image preview
      const preview = document.getElementById('invoiceImagePreview');
      if (preview) {
        preview.innerHTML = '';
      }

      console.log('‚úÖ Pending order saved successfully');

    } catch (error) {
      hideLoading();
      console.error('Error saving pending order:', error);
      showMessage('Failed to save order: ' + error.message, 'error');
    }
  }

  /**
   * Show reconciliation view comparing ordered vs received items
   */
  async function showReconciliationView(pendingOrderId, receivedItems) {
    console.log('Loading pending order for reconciliation...', pendingOrderId);
    showLoading('Loading Order', 'Fetching order details...');

    try {
      // Fetch pending order with items
      const { data: orderData, error: orderError } = await supabase
        .from('pending_orders')
        .select(`
          *,
          pending_order_items (
            id,
            inventory_item_id,
            quantity_ordered,
            unit,
            item_name,
            vendor
          )
        `)
        .eq('id', pendingOrderId)
        .single();

      if (orderError) throw orderError;
      if (!orderData) throw new Error('Order not found');

      hideLoading();

      console.log('Loaded pending order:', orderData);

      // Match received items to ordered items
      const reconciliationData = orderData.pending_order_items.map(orderedItem => {
        // Find matching received item
        const receivedItem = receivedItems.find(r => r.matchedInventoryId === orderedItem.inventory_item_id);

        return {
          orderItemId: orderedItem.id,
          inventoryItemId: orderedItem.inventory_item_id,
          itemName: orderedItem.item_name,
          unit: orderedItem.unit,
          quantityOrdered: orderedItem.quantity_ordered,
          quantityReceived: receivedItem ? receivedItem.detectedQuantity : 0,
          variance: receivedItem ? (receivedItem.detectedQuantity - orderedItem.quantity_ordered) : -orderedItem.quantity_ordered,
          hasReceived: !!receivedItem,
          invoicePrice: receivedItem && receivedItem.detectedPrice != null ? Number(receivedItem.detectedPrice) : null
        };
      });

      const reconciliationItemIds = reconciliationData
        .map(item => item.inventoryItemId)
        .filter(id => id !== null && id !== undefined);
      if (reconciliationItemIds.length) {
        await ensurePriceSnapshotsForItems(reconciliationItemIds);
      }

      // Create modal
      const overlay = document.createElement('div');
      overlay.id = 'reconciliationModal';
      overlay.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 10000; padding: 0; overflow-y: auto;';

      const modal = document.createElement('div');
      modal.style.cssText = 'background: white; max-width: 800px; width: 100%; margin: 20px auto; border: 2px solid var(--gray-400);';

      // Responsive: full screen on mobile
      if (window.innerWidth <= 600) {
        modal.style.maxWidth = '100%';
        modal.style.margin = '0';
        modal.style.minHeight = '100vh';
      }

      // Header (sticky)
      const header = document.createElement('div');
      header.style.cssText = 'background: #212121; color: white; padding: 16px 20px; position: sticky; top: 0; z-index: 10;';

      const title = document.createElement('h3');
      title.textContent = `RECONCILE ORDER - ${orderData.vendor}`;
      title.style.cssText = 'margin: 0 0 4px 0; font-size: 16px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;';
      header.appendChild(title);

      const subtitle = document.createElement('p');
      const expectedReconciliationDate = parsePacificDate(orderData.expected_delivery_date);
      subtitle.textContent = `Expected: ${
        expectedReconciliationDate
          ? formatPacificDateDisplay(expectedReconciliationDate, { month: 'short', day: 'numeric', year: 'numeric', weekday: 'long' })
          : 'Unknown'
      } | ${reconciliationData.length} item(s)`;
      subtitle.style.cssText = 'margin: 0; font-size: 11px; color: #b0b0b0;';
      header.appendChild(subtitle);

      modal.appendChild(header);

      // Content (scrollable)
      const content = document.createElement('div');
      content.style.cssText = 'padding: 20px; max-height: calc(100vh - 200px); overflow-y: auto;';

      // Instructions
      const instructions = document.createElement('p');
      instructions.textContent = 'Review the quantities below. Update received amounts if needed, then confirm to complete check-in.';
      instructions.style.cssText = 'color: var(--gray-600); font-size: 12px; margin-bottom: 20px; padding: 12px; background: #f3f4f6; border-left: 3px solid var(--gray-400);';
      content.appendChild(instructions);

      // Table
      const table = document.createElement('div');
      table.style.cssText = 'border: 2px solid var(--gray-300);';

      // Table header
      const headerRow = document.createElement('div');
      headerRow.style.cssText = 'display: grid; grid-template-columns: 2fr 1fr 1fr 1fr 1.6fr; gap: 8px; padding: 10px; background: var(--gray-100); border-bottom: 2px solid var(--gray-300); font-weight: 700; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--gray-700);';

      ['ITEM', 'ORDERED', 'RECEIVED', 'VARIANCE', 'PRICE'].forEach(label => {
        const cell = document.createElement('div');
        cell.textContent = label;
        cell.style.textAlign = label === 'ITEM' ? 'left' : 'center';
        headerRow.appendChild(cell);
      });
      table.appendChild(headerRow);

      // Table rows
      reconciliationData.forEach((item, index) => {
        const row = document.createElement('div');
        row.style.cssText = `display: grid; grid-template-columns: 2fr 1fr 1fr 1fr 1.6fr; gap: 8px; padding: 12px 10px; background: ${index % 2 === 0 ? 'white' : '#f9fafb'}; border-bottom: 1px solid var(--gray-200); align-items: center;`;

        // Item name
        const nameCell = document.createElement('div');
        nameCell.textContent = item.itemName;
        nameCell.style.cssText = 'font-size: 13px; font-weight: 600; color: var(--gray-900);';
        row.appendChild(nameCell);

        // Ordered quantity
        const orderedCell = document.createElement('div');
        orderedCell.textContent = `${item.quantityOrdered} ${item.unit}`;
        orderedCell.style.cssText = 'text-align: center; font-size: 13px; color: var(--gray-700);';
        row.appendChild(orderedCell);

        // Received quantity (editable)
        const receivedCell = document.createElement('div');
        receivedCell.style.cssText = 'text-align: center;';

        const receivedInput = document.createElement('input');
        receivedInput.type = 'number';
        receivedInput.value = item.quantityReceived;
        receivedInput.step = '0.25';
        receivedInput.min = '0';
        receivedInput.id = `received-${item.orderItemId}`;
        receivedInput.style.cssText = 'width: 70px; padding: 6px; border: 2px solid var(--gray-300); border-radius: 0; text-align: center; font-size: 13px; font-weight: 600;';
        receivedInput.onchange = () => {
          // Recalculate variance
          const newReceived = parseFloat(receivedInput.value) || 0;
          const newVariance = newReceived - item.quantityOrdered;
          varianceCell.textContent = newVariance >= 0 ? `+${newVariance.toFixed(2)}` : newVariance.toFixed(2);

          // Update color
          if (newVariance < 0) {
            varianceCell.style.color = '#ef4444'; // Red
          } else if (newVariance > 0) {
            varianceCell.style.color = '#10b981'; // Green
          } else {
            varianceCell.style.color = 'var(--gray-600)'; // Gray
          }

          // Update item data
          item.quantityReceived = newReceived;
          item.variance = newVariance;
        };
        receivedCell.appendChild(receivedInput);
        row.appendChild(receivedCell);

        // Variance
        const varianceCell = document.createElement('div');
        varianceCell.textContent = item.variance >= 0 ? `+${item.variance.toFixed(2)}` : item.variance.toFixed(2);
        varianceCell.style.cssText = 'text-align: center; font-size: 13px; font-weight: 700;';
        if (item.variance < 0) {
          varianceCell.style.color = '#ef4444'; // Red - short
        } else if (item.variance > 0) {
          varianceCell.style.color = '#10b981'; // Green - over
        } else {
          varianceCell.style.color = 'var(--gray-600)'; // Gray - exact
        }
        row.appendChild(varianceCell);

        const priceCell = document.createElement('div');
        priceCell.style.cssText = 'text-align: center; font-size: 11px;';
        priceCell.innerHTML = item.inventoryItemId ? renderIncomingPriceHtml(item.inventoryItemId, item.invoicePrice, orderData.expected_delivery_date) : '<span style="color: var(--gray-500); font-size: 11px;">N/A</span>';
        row.appendChild(priceCell);

        table.appendChild(row);
      });

      content.appendChild(table);
      modal.appendChild(content);

      // Footer buttons (sticky)
      const footer = document.createElement('div');
      footer.style.cssText = 'padding: 16px 20px; background: white; border-top: 2px solid var(--gray-300); display: flex; gap: 12px; position: sticky; bottom: 0;';

      const cancelBtn = document.createElement('button');
      cancelBtn.textContent = 'CANCEL';
      cancelBtn.style.cssText = 'flex: 1; padding: 14px; background: white; color: var(--gray-700); border: 2px solid var(--gray-300); border-radius: 0; font-size: 12px; font-weight: 700; letter-spacing: 1px; cursor: pointer;';
      cancelBtn.onclick = () => document.body.removeChild(overlay);
      footer.appendChild(cancelBtn);

      const confirmBtn = document.createElement('button');
      confirmBtn.textContent = 'CONFIRM RECONCILIATION';
      confirmBtn.style.cssText = 'flex: 2; padding: 14px; background: #212121; color: white; border: 2px solid #212121; border-radius: 0; font-size: 12px; font-weight: 700; letter-spacing: 1px; cursor: pointer;';
      confirmBtn.onclick = async () => {
        await completeReconciliation(pendingOrderId, orderData, reconciliationData, overlay);
      };
      footer.appendChild(confirmBtn);

      modal.appendChild(footer);
      overlay.appendChild(modal);
      document.body.appendChild(overlay);

    } catch (error) {
      hideLoading();
      console.error('Error loading order for reconciliation:', error);
      showMessage('Failed to load order: ' + error.message, 'error');
    }
  }

  /**
   * Complete reconciliation and update database
   */
  async function completeReconciliation(pendingOrderId, orderData, reconciliationData, modalOverlay) {
    showLoading('Reconciling Order', 'Updating inventory and order status...');

    try {
      // Update each order item with received quantities
      for (const item of reconciliationData) {
        const { error: updateError } = await supabase
          .from('pending_order_items')
          .update({
            quantity_received: item.quantityReceived,
            variance: item.variance
          })
          .eq('id', item.orderItemId);

        if (updateError) throw updateError;

        // Update inventory stock with received amount
        if (item.quantityReceived > 0) {
          const { data: currentItem, error: fetchError } = await supabase
            .from('inventory_items')
            .select('current_stock')
            .eq('id', item.inventoryItemId)
            .single();

          if (fetchError) throw fetchError;

          const newStock = (parseFloat(currentItem.current_stock) || 0) + item.quantityReceived;

          const { error: stockError } = await supabase
            .from('inventory_items')
            .update({
              current_stock: newStock,
              last_counted_date: getPacificDate(),
              last_invoice_qty: item.quantityReceived,
              last_invoice_date: new Date().toISOString()
            })
            .eq('id', item.inventoryItemId);

          if (stockError) throw stockError;
        }
      }

      // Determine order status (delivered or partial)
      const allReceived = reconciliationData.every(item => item.variance === 0);
      const noneReceived = reconciliationData.every(item => item.quantityReceived === 0);
      const newStatus = noneReceived ? 'pending' : (allReceived ? 'delivered' : 'partial');

      // Update pending order status
      const { error: orderError } = await supabase
        .from('pending_orders')
        .update({
          status: newStatus,
          reconciled: true,
          reconciled_at: new Date().toISOString(),
          reconciled_by: 'System'
        })
        .eq('id', pendingOrderId);

      if (orderError) throw orderError;

      // Create invoice record linked to this order
      const { data: invoiceData, error: invoiceError } = await supabase
        .from('invoices')
        .insert({
          vendor: orderData.vendor,
          invoice_date: getPacificDate(),
          invoice_type: 'invoice',
          pending_order_id: pendingOrderId,
          total_items: reconciliationData.filter(i => i.quantityReceived > 0).length,
          processed_by: 'System',
          notes: 'Reconciled against pending order'
        })
        .select()
        .single();

      if (invoiceError) throw invoiceError;

      const reconciledItemIds = reconciliationData
        .map(item => item.inventoryItemId)
        .filter(id => id !== null && id !== undefined);

      const priceCache = getPriceCache();
      reconciledItemIds.forEach(id => priceCache.delete(id));
      if (reconciledItemIds.length) {
        await ensurePriceSnapshotsForItems(reconciledItemIds);
      }

      hideLoading();

      // Close modal
      document.body.removeChild(modalOverlay);

      // Clear state
      orderingSystemState.extractedInvoiceItems = [];
      orderingSystemState.currentInvoiceImage = null;
      orderingSystemState.selectedPendingOrderId = null;

      // Clear displays
      const container = document.getElementById('extractedInvoiceItems');
      if (container) container.innerHTML = '';

      const preview = document.getElementById('invoiceImagePreview');
      if (preview) preview.innerHTML = '';

      // Reload inventory
      await loadInventoryData();
      calculateUpcomingOrders();
      await refreshUpcomingOrdersUI();

      showMessage(`‚úÖ Order reconciled! Status: ${newStatus.toUpperCase()}`, 'success');

      console.log('‚úÖ Reconciliation completed successfully');

    } catch (error) {
      hideLoading();
      console.error('Error completing reconciliation:', error);
      showMessage('Failed to complete reconciliation: ' + error.message, 'error');
    }
  }

  /**
   * Check in invoice items and update inventory
   * Handles both invoice reconciliation and order receiving flows
   */
  async function checkInInvoiceItems() {
    console.log('checkInInvoiceItems called');
    const items = orderingSystemState.extractedInvoiceItems;

    if (items.length === 0) {
      showMessage('No items to check in', 'warning');
      return;
    }

    // Split items: matched (auto + manual) vs flagged as new (EXCLUDING skipped items)
    const matchedItems = items.filter(item => item.matchedInventoryId && !item.flaggedAsNew && !item.skipped);
    const newItems = items.filter(item => item.flaggedAsNew && !item.skipped);
    const skippedItems = items.filter(item => item.skipped);

    console.log('Matched items (to check in):', matchedItems.length);
    console.log('Flagged as new (to add):', newItems.length);
    console.log('Skipped items (ignored):', skippedItems.length);

    if (matchedItems.length === 0 && newItems.length === 0) {
      showMessage('Please match items, flag as new, or skip unwanted items', 'warning');
      return;
    }

    if (matchedItems.length === 0) {
      // No matched items, just show add new items modal
      showAddNewItemsModal(newItems);
      return;
    }

    // Check if reconciliation against pending order is needed
    if (orderingSystemState.selectedPendingOrderId) {
      console.log('Reconciliation mode: pending order ID', orderingSystemState.selectedPendingOrderId);
      showReconciliationView(orderingSystemState.selectedPendingOrderId, matchedItems);
      return;
    }

    showLoading('Checking In Items', 'Updating inventory...');

    try {
      // Create invoice record
      const { data: invoiceData, error: invoiceError } = await supabase
        .from('invoices')
        .insert({
          invoice_date: getPacificDate(),
          vendor: 'MIXED', // Could be enhanced to detect vendor from items
          invoice_type: orderingSystemState.invoiceType || 'invoice',
          total_items: matchedItems.length,
          processed_by: 'System',
          notes: 'Auto-processed via OCR'
        })
        .select()
        .single();

      if (invoiceError) throw invoiceError;

      const invoiceId = invoiceData.id;

      // Process each matched item
      let successCount = 0;
      let errorCount = 0;

      for (const item of matchedItems) {
        try {
          // LEARNING: Save to invoice_items table - this creates the learning data
          console.log('üíæ SAVING LEARNING DATA:', {
            detected_name: item.detectedName,
            inventory_item_id: item.matchedInventoryId,
            confidence: item.matchConfidence
          });

          const quantity = parseFloat(item.detectedQuantity) || 0;
          const unitPrice = parseFloat(item.detectedPrice) || 0;
          const totalPrice = quantity * unitPrice;

          const { error: itemError } = await supabase
            .from('invoice_items')
            .insert({
              invoice_id: invoiceId,
              inventory_item_id: item.matchedInventoryId,

              // Required fields from invoice_items schema
              item_description: item.detectedName,
              quantity: quantity,
              unit: 'case', // Default for PFG items
              unit_price: unitPrice,
              total_price: totalPrice,
              matched: true,

              // Learning/tracking fields
              detected_item_name: item.detectedName,
              detected_quantity: quantity,
              detected_price: unitPrice,
              match_confidence: item.matchConfidence,
              matched_at: new Date().toISOString(),
              checked_in: true,
              checked_in_at: new Date().toISOString()
            });

          if (itemError) {
            console.error('‚ùå Failed to save learning data:', itemError);
            throw itemError;
          }
          console.log('‚úÖ Learning data saved successfully!');

          // Update inventory stock and PFG tracking data
          // Get current item data
          const { data: currentItem, error: fetchError } = await supabase
            .from('inventory_items')
            .select('current_stock, item_name, last_price, item_number, manufacturer_item_number, gtin, category, brand, manufacturer_name')
            .eq('id', item.matchedInventoryId)
            .single();

          if (fetchError) throw fetchError;

          const newStock = (parseFloat(currentItem.current_stock) || 0) + (parseFloat(item.detectedQuantity) || 0);

          // Prepare update object
          const updateData = {
            current_stock: newStock,
            last_counted_date: new Date().toISOString()
          };

          // Update PFG tracking fields if this item has PFG data and fields are empty
          if (item.pfgData) {
            console.log('üì¶ PFG data detected for', currentItem.item_name);

            if (item.pfgData.itemNumber && !currentItem.item_number) {
              updateData.item_number = item.pfgData.itemNumber;
              console.log('  ‚Üí Adding item_number:', item.pfgData.itemNumber);
            }
            if (item.pfgData.manufacturerItemNumber && !currentItem.manufacturer_item_number) {
              updateData.manufacturer_item_number = item.pfgData.manufacturerItemNumber;
            }
            if (item.pfgData.gtin && !currentItem.gtin) {
              updateData.gtin = item.pfgData.gtin;
            }
            if (item.pfgData.category && !currentItem.category) {
              updateData.category = item.pfgData.category;
            }
            if (item.pfgData.brand && !currentItem.brand) {
              updateData.brand = item.pfgData.brand;
            }
            if (item.pfgData.manufacturerName && !currentItem.manufacturer_name) {
              updateData.manufacturer_name = item.pfgData.manufacturerName;
            }

            // Track price changes if price is provided
            if (item.detectedPrice && item.detectedPrice > 0) {
              const oldPrice = parseFloat(currentItem.last_price) || 0;
              const newPrice = parseFloat(item.detectedPrice);

              if (oldPrice !== newPrice && oldPrice > 0) {
                const priceChange = newPrice - oldPrice;
                const priceChangePercent = ((priceChange / oldPrice) * 100).toFixed(2);

                console.log(`  üí∞ Price change: $${oldPrice} ‚Üí $${newPrice} (${priceChangePercent > 0 ? '+' : ''}${priceChangePercent}%)`);

                // Save to price_history table
                const { error: priceHistoryError } = await supabase
                  .from('price_history')
                  .insert({
                    inventory_item_id: item.matchedInventoryId,
                    item_number: item.pfgData.itemNumber,
                    old_price: oldPrice,
                    new_price: newPrice,
                    price_change: priceChange,
                    price_change_percent: parseFloat(priceChangePercent),
                    invoice_number: item.pfgData.invoiceNumber,
                    invoice_date: item.pfgData.invoiceDate,
                    vendor: item.pfgData.vendor
                  });

                if (priceHistoryError) {
                  console.error('Failed to save price history:', priceHistoryError);
                } else {
                  console.log('  ‚úÖ Price history saved!');
                }
              }

              // Update last_price regardless
              updateData.last_price = newPrice;
            }
          }

          // Update the inventory item
          const { error: updateError } = await supabase
            .from('inventory_items')
            .update(updateData)
            .eq('id', item.matchedInventoryId);

          if (updateError) throw updateError;

          successCount++;

        } catch (itemError) {
          console.error('Error processing item:', item.detectedName, itemError);
          errorCount++;
        }
      }

      hideLoading();

      // Show success message
      if (errorCount === 0) {
        showMessage('‚úÖ Checked in ' + successCount + ' matched items!', 'success');
      } else {
        showMessage(
          'Checked in ' + successCount + ' items with ' + errorCount + ' errors. Check console for details.',
          'warning'
        );
      }

      // Reload inventory to show updated counts
      await loadInventoryData();

      // Clear the checked-in items
      orderingSystemState.extractedInvoiceItems = [];
      orderingSystemState.currentInvoiceImage = null;

      // Reset UI
      document.getElementById('extractedItemsSection').style.display = 'none';
      document.getElementById('invoicePreviewSection').style.display = 'none';
      document.getElementById('invoicePreviewImage').src = '';
      document.getElementById('invoiceFileInput').value = '';
      document.getElementById('invoiceCameraInput').value = '';

      // If there are flagged new items, auto-create them with PFG data or show modal
      if (newItems.length > 0) {
        // Separate items with PFG data (auto-create) from items without (manual entry)
        const itemsWithPFG = newItems.filter(item => item.pfgData && item.pfgData.itemNumber);
        const itemsWithoutPFG = newItems.filter(item => !item.pfgData || !item.pfgData.itemNumber);

        // Auto-create items with PFG data
        if (itemsWithPFG.length > 0) {
          console.log(`üÜï Auto-creating ${itemsWithPFG.length} new items with PFG data...`);

          showLoading('Creating New Items', `Adding ${itemsWithPFG.length} item(s) to inventory...`);

          setTimeout(async () => {
            try {
              const itemsToCreate = itemsWithPFG.map(item => ({
                item_name: item.detectedName,
                vendor: item.pfgData.vendor || 'PFG',
                unit: item.detectedUnit || 'case',
                par_level: item.detectedQuantity || 1,
                current_stock: item.detectedQuantity || 0,
                last_price: item.detectedPrice || 0,
                item_number: item.pfgData.itemNumber,
                manufacturer_item_number: item.pfgData.manufacturerItemNumber,
                gtin: item.pfgData.gtin,
                category: item.pfgData.category,
                brand: item.pfgData.brand,
                manufacturer_name: item.pfgData.manufacturerName,
                item_type: 'regular',
                last_counted_date: new Date().toISOString()
              }));

              const { data: createdItems, error: createError } = await supabase
                .from('inventory_items')
                .insert(itemsToCreate)
                .select();

              if (createError) throw createError;

              hideLoading();
              showMessage(`‚úÖ Auto-created ${createdItems.length} new item(s) with PFG tracking data!`, 'success');
              console.log('‚úÖ Created items:', createdItems.map(i => i.item_name).join(', '));

              // Reload inventory
              await loadInventoryData();

              // If there are items without PFG data, show modal for manual entry
              if (itemsWithoutPFG.length > 0) {
                setTimeout(() => {
                  showAddNewItemsModal(itemsWithoutPFG);
                }, 500);
              }

            } catch (error) {
              hideLoading();
              console.error('Error auto-creating items:', error);
              showMessage('Failed to auto-create items: ' + error.message, 'error');

              // Fallback: show modal for all new items (including PFG ones)
              setTimeout(() => {
                showAddNewItemsModal(newItems);
              }, 500);
            }
          }, 100);

        } else if (itemsWithoutPFG.length > 0) {
          // No PFG data, show modal for manual entry
          setTimeout(() => {
            showAddNewItemsModal(itemsWithoutPFG);
          }, 500);
        }
      }

    } catch (error) {
      hideLoading();
      console.error('Check-in error:', error);
      showMessage('Failed to check in items: ' + error.message, 'error');
    }
  }

  /**
   * Show modal to add new items (unmatched items from invoice)
   */
  function showAddNewItemsModal(newItems) {
    if (!newItems || newItems.length === 0) return;

    // Create overlay
    const overlay = document.createElement('div');
    overlay.id = 'addNewItemsModal';
    overlay.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 10000; overflow-y: auto; padding: 20px;';

    // Create modal
    const modal = document.createElement('div');
    modal.style.cssText = 'background: white; max-width: 600px; margin: 0 auto; padding: 20px; border-radius: 0; border: 2px solid #212121;';

    // Header
    const header = document.createElement('h3');
    header.textContent = 'ADD NEW ITEMS TO INVENTORY';
    header.style.cssText = 'margin: 0 0 16px 0; color: #212121; font-size: 16px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;';
    modal.appendChild(header);

    const desc = document.createElement('p');
    desc.textContent = 'Fill in details for ' + newItems.length + ' new item(s):';
    desc.style.cssText = 'margin: 0 0 20px 0; color: #666; font-size: 13px;';
    modal.appendChild(desc);

    // Form for each item
    newItems.forEach((item, index) => {
      const itemCard = document.createElement('div');
      itemCard.style.cssText = 'background: #f5f5f5; padding: 16px; margin-bottom: 16px; border: 2px solid #e0e0e0;';

      const itemTitle = document.createElement('div');
      itemTitle.textContent = 'FROM INVOICE: ' + item.detectedName;
      itemTitle.style.cssText = 'font-weight: 700; margin-bottom: 12px; color: #212121; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;';
      itemCard.appendChild(itemTitle);

      // Item Name
      const nameLabel = document.createElement('label');
      nameLabel.textContent = 'ITEM NAME:';
      nameLabel.style.cssText = 'display: block; margin-bottom: 4px; font-size: 11px; font-weight: 700; color: #666; letter-spacing: 0.5px;';
      itemCard.appendChild(nameLabel);

      const nameInput = document.createElement('input');
      nameInput.type = 'text';
      nameInput.value = item.detectedName;
      nameInput.style.cssText = 'width: 100%; padding: 8px; border: 2px solid #e0e0e0; margin-bottom: 12px; font-size: 13px;';
      nameInput.dataset.index = index;
      nameInput.dataset.field = 'name';
      itemCard.appendChild(nameInput);

      // Vendor
      const vendorLabel = document.createElement('label');
      vendorLabel.textContent = 'VENDOR:';
      vendorLabel.style.cssText = 'display: block; margin-bottom: 4px; font-size: 11px; font-weight: 700; color: #666; letter-spacing: 0.5px;';
      itemCard.appendChild(vendorLabel);

      const vendorInput = document.createElement('input');
      vendorInput.type = 'text';
      vendorInput.placeholder = 'e.g., Greenleaf';
      vendorInput.style.cssText = 'width: 100%; padding: 8px; border: 2px solid #e0e0e0; margin-bottom: 12px; font-size: 13px;';
      vendorInput.dataset.index = index;
      vendorInput.dataset.field = 'vendor';
      itemCard.appendChild(vendorInput);

      // Unit
      const unitLabel = document.createElement('label');
      unitLabel.textContent = 'UNIT:';
      unitLabel.style.cssText = 'display: block; margin-bottom: 4px; font-size: 11px; font-weight: 700; color: #666; letter-spacing: 0.5px;';
      itemCard.appendChild(unitLabel);

      const unitInput = document.createElement('input');
      unitInput.type = 'text';
      unitInput.placeholder = 'e.g., CS, EA, LB';
      unitInput.style.cssText = 'width: 100%; padding: 8px; border: 2px solid #e0e0e0; margin-bottom: 12px; font-size: 13px; text-transform: uppercase;';
      unitInput.dataset.index = index;
      unitInput.dataset.field = 'unit';
      itemCard.appendChild(unitInput);

      // Par Level
      const parLabel = document.createElement('label');
      parLabel.textContent = 'PAR LEVEL:';
      parLabel.style.cssText = 'display: block; margin-bottom: 4px; font-size: 11px; font-weight: 700; color: #666; letter-spacing: 0.5px;';
      itemCard.appendChild(parLabel);

      const parInput = document.createElement('input');
      parInput.type = 'number';
      parInput.step = '0.25';
      parInput.value = item.detectedQuantity || 1;
      parInput.style.cssText = 'width: 100%; padding: 8px; border: 2px solid #e0e0e0; font-size: 13px;';
      parInput.dataset.index = index;
      parInput.dataset.field = 'par';
      itemCard.appendChild(parInput);

      modal.appendChild(itemCard);
    });

    // Buttons
    const btnRow = document.createElement('div');
    btnRow.style.cssText = 'display: flex; gap: 10px; margin-top: 20px;';

    const cancelBtn = document.createElement('button');
    cancelBtn.textContent = 'SKIP';
    cancelBtn.style.cssText = 'flex: 1; padding: 12px; background: #e0e0e0; color: #212121; border: none; cursor: pointer; font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;';
    cancelBtn.onclick = () => overlay.remove();
    btnRow.appendChild(cancelBtn);

    const saveBtn = document.createElement('button');
    saveBtn.textContent = 'ADD TO INVENTORY';
    saveBtn.style.cssText = 'flex: 2; padding: 12px; background: #212121; color: white; border: none; cursor: pointer; font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;';
    saveBtn.onclick = async () => {
      const inputs = modal.querySelectorAll('input');
      const itemsToAdd = [];

      newItems.forEach((item, index) => {
        const name = modal.querySelector(`input[data-index="${index}"][data-field="name"]`).value.trim();
        const vendor = modal.querySelector(`input[data-index="${index}"][data-field="vendor"]`).value.trim();
        const unit = modal.querySelector(`input[data-index="${index}"][data-field="unit"]`).value.trim().toUpperCase();
        const par = parseFloat(modal.querySelector(`input[data-index="${index}"][data-field="par"]`).value) || 0;

        if (!name) {
          showMessage('Item name required for all items', 'error');
          return;
        }

        itemsToAdd.push({
          item_name: name,
          vendor: vendor || 'Unknown',
          unit: unit || 'EA',
          par_level: par,
          current_stock: item.detectedQuantity || 0
        });
      });

      if (itemsToAdd.length === 0) return;

      overlay.remove();
      showLoading('Adding Items', 'Creating inventory items...');

      try {
        const { error } = await supabase.from('inventory_items').insert(itemsToAdd);
        if (error) throw error;

        hideLoading();
        showMessage(`‚úÖ Added ${itemsToAdd.length} new item(s) to inventory!`, 'success');
        await loadInventoryData();
      } catch (error) {
        hideLoading();
        showMessage('Error adding items: ' + error.message, 'error');
      }
    };
    btnRow.appendChild(saveBtn);

    modal.appendChild(btnRow);
    overlay.appendChild(modal);
    document.body.appendChild(overlay);
  }

  /**
   * Print a specific order
   */
  function printOrder(orderIndex) {
    const order = orderingSystemState.calculatedOrders[orderIndex];
    if (!order) return;

    const printWindow = window.open('', '', 'height=800,width=800');
    printWindow.document.write('<html><head><title>Order - ' + order.vendor + '</title>');
    printWindow.document.write(`<style>
      @page { margin: 0.5in; }
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
        padding: 0;
        margin: 0;
        color: #1a1a1a;
        font-size: 9pt;
        line-height: 1.3;
      }
      .header {
        border-bottom: 2px solid #2196F3;
        padding-bottom: 8px;
        margin-bottom: 12px;
      }
      .company {
        font-size: 16pt;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: #1a1a1a;
        margin: 0 0 4px 0;
      }
      .order-title {
        font-size: 12pt;
        font-weight: 600;
        color: #424242;
        margin: 0;
      }
      .order-details {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 6px;
        margin: 12px 0;
        padding: 8px;
        background: #f5f5f5;
        font-size: 8pt;
      }
      .detail-label {
        font-weight: 600;
        color: #616161;
        text-transform: uppercase;
        font-size: 7pt;
        letter-spacing: 0.5px;
      }
      .detail-value {
        color: #1a1a1a;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 12px;
        font-size: 8pt;
      }
      th {
        background: #424242;
        color: white;
        padding: 6px 8px;
        text-align: left;
        font-weight: 600;
        font-size: 7pt;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      td {
        border-bottom: 1px solid #e0e0e0;
        padding: 6px 8px;
        vertical-align: top;
      }
      tr:hover { background: #fafafa; }
      .item-name {
        font-weight: 600;
        color: #1a1a1a;
        font-size: 8pt;
      }
      .item-meta {
        font-size: 7pt;
        color: #757575;
        margin-top: 2px;
      }
      .item-reasoning {
        font-size: 6pt;
        color: #9e9e9e;
        font-style: italic;
        margin-top: 2px;
      }
      .qty-cell {
        font-weight: 700;
        color: #2196F3;
        text-align: center;
      }
      .notes-box {
        background: #e3f2fd;
        border-left: 3px solid #2196F3;
        padding: 8px;
        margin: 12px 0;
        font-size: 8pt;
      }
      .footer {
        margin-top: 16px;
        padding-top: 8px;
        border-top: 1px solid #e0e0e0;
        font-size: 7pt;
        color: #757575;
        text-align: center;
      }
    </style>`);
    printWindow.document.write('</head><body>');

    // Header
    printWindow.document.write(`
      <div class="header">
        <div class="company">JAYNA GYRO</div>
        <div class="order-title">${order.vendor} - Order #${orderIndex + 1}</div>
      </div>
    `);

    // Order details
    const orderDateStr = formatPacificDateDisplay(order.orderDate, { month: 'short', day: 'numeric', year: 'numeric' });
    const deliveryDateStr = formatPacificDateDisplay(order.deliveryDate, { month: 'short', day: 'numeric', year: 'numeric' });

    printWindow.document.write(`
      <div class="order-details">
        <div><span class="detail-label">Order Date:</span> <span class="detail-value">${orderDateStr}</span></div>
        <div><span class="detail-label">Cutoff:</span> <span class="detail-value">${order.cutoffTime}</span></div>
        <div><span class="detail-label">Delivery:</span> <span class="detail-value">${deliveryDateStr}</span></div>
        <div><span class="detail-label">Items:</span> <span class="detail-value">${order.items.length}</span></div>
      </div>
    `);

    // Notes
    if (order.notes) {
      printWindow.document.write(`<div class="notes-box"><strong>Note:</strong> ${order.notes}</div>`);
    }

    // Table
    printWindow.document.write('<table><thead><tr><th>Item</th><th style="text-align:center;">Qty</th><th style="text-align:center;">Unit</th><th style="text-align:center;">Par</th><th style="text-align:center;">Current</th></tr></thead><tbody>');

    const isFriday = formatPacificWeekday(order.orderDate) === 'Friday';
    const isThursday = formatPacificWeekday(order.orderDate) === 'Thursday';

    order.items.forEach(item => {
      let reasoningText = '';
      if (order.vendor === 'Greenleaf' && isFriday) {
        reasoningText = `AI: (Par ${item.parLevel} - Stock ${item.currentStock}) √ó 2 days = ${item.quantity}`;
      } else if (order.vendor === 'Mani Imports' && isThursday) {
        const calc = Math.ceil((item.parLevel - item.currentStock) * (5 / 7));
        reasoningText = `AI: (Par ${item.parLevel} - Stock ${item.currentStock}) √ó 5/7 = ${calc}`;
      } else if (order.vendor === 'Mani Imports') {
        const calc = Math.ceil((item.parLevel - item.currentStock) * (3 / 7));
        reasoningText = `AI: (Par ${item.parLevel} - Stock ${item.currentStock}) √ó 3/7 = ${calc}`;
      } else {
        reasoningText = `AI: Par ${item.parLevel} - Stock ${item.currentStock} = ${item.quantity}`;
      }

      const lastCountStr = item.lastCountedDate ? `Last count: ${formatRelativeTime(item.lastCountedDate)}` : '';
      const lastPriceStr = item.currentUnitCost ? `Last price: ${formatPriceWithDate(item.currentUnitCost, item.lastCostUpdate)}` : '';

      printWindow.document.write(`
        <tr>
          <td>
            <div class="item-name">${item.itemName}</div>
            ${lastCountStr ? `<div class="item-meta">${lastCountStr}</div>` : ''}
            ${lastPriceStr ? `<div class="item-meta">${lastPriceStr}</div>` : ''}
            <div class="item-reasoning">${reasoningText}</div>
          </td>
          <td class="qty-cell">${item.quantity}</td>
          <td style="text-align:center;">${item.unit}</td>
          <td style="text-align:center;">${item.parLevel}</td>
          <td style="text-align:center;">${item.currentStock}</td>
        </tr>
      `);
    });

    printWindow.document.write('</tbody></table>');
    printWindow.document.write(`<div class="footer">Generated: ${new Date().toLocaleString()}</div>`);
    printWindow.document.write('</body></html>');
    printWindow.document.close();
    printWindow.print();
  }

  /**
   * Generate PDF for a specific order
   */
  async function generateOrderPDF(orderIndex) {
    const order = orderingSystemState.calculatedOrders[orderIndex];
    if (!order) return;

    showLoading('Generating PDF', 'Creating order document...');

    try {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      // Blue accent color (Jayna blue)
      const jaynaBlue = [33, 150, 243]; // #2196F3
      const darkGray = [66, 66, 66]; // #424242
      const mediumGray = [117, 117, 117]; // #757575
      const lightGray = [158, 158, 158]; // #9e9e9e

      // Header with blue underline
      doc.setFontSize(14);
      doc.setFont('helvetica', 'bold');
      doc.setTextColor(26, 26, 26);
      doc.text('JAYNA GYRO', 105, 15, { align: 'center' });

      doc.setFontSize(10);
      doc.setFont('helvetica', 'normal');
      doc.setTextColor(darkGray[0], darkGray[1], darkGray[2]);
      doc.text(`${order.vendor} - Order #${orderIndex + 1}`, 105, 22, { align: 'center' });

      // Blue line
      doc.setDrawColor(jaynaBlue[0], jaynaBlue[1], jaynaBlue[2]);
      doc.setLineWidth(0.5);
      doc.line(20, 25, 190, 25);

      // Order details in compact grid
      const orderDateStr = formatPacificDateDisplay(order.orderDate, { month: 'short', day: 'numeric', year: 'numeric' });
      const deliveryDateStr = formatPacificDateDisplay(order.deliveryDate, { month: 'short', day: 'numeric', year: 'numeric' });

      doc.setFillColor(245, 245, 245);
      doc.rect(20, 28, 170, 16, 'F');

      doc.setFontSize(7);
      doc.setFont('helvetica', 'bold');
      doc.setTextColor(mediumGray[0], mediumGray[1], mediumGray[2]);
      doc.text('ORDER DATE', 25, 33);
      doc.text('CUTOFF', 75, 33);
      doc.text('DELIVERY', 125, 33);
      doc.text('ITEMS', 165, 33);

      doc.setFontSize(8);
      doc.setFont('helvetica', 'normal');
      doc.setTextColor(26, 26, 26);
      doc.text(orderDateStr, 25, 40);
      doc.text(order.cutoffTime, 75, 40);
      doc.text(deliveryDateStr, 125, 40);
      doc.text(order.items.length.toString(), 165, 40);

      let startY = 47;

      // Notes box if present
      if (order.notes) {
        doc.setFillColor(227, 242, 253); // Light blue
        doc.rect(20, startY, 170, 10, 'F');
        doc.setDrawColor(jaynaBlue[0], jaynaBlue[1], jaynaBlue[2]);
        doc.setLineWidth(1);
        doc.line(20, startY, 20, startY + 10);

        doc.setFontSize(7);
        doc.setTextColor(26, 26, 26);
        doc.text(`Note: ${order.notes}`, 25, startY + 6);
        startY += 13;
      }

      // Table with compact styling
      const isFriday = formatPacificWeekday(order.orderDate) === 'Friday';
      const isThursday = formatPacificWeekday(order.orderDate) === 'Thursday';

      const tableData = order.items.map(item => {
        let reasoningText = '';
        if (order.vendor === 'Greenleaf' && isFriday) {
          reasoningText = `AI: (${item.parLevel} - ${item.currentStock}) √ó 2 = ${item.quantity}`;
        } else if (order.vendor === 'Mani Imports' && isThursday) {
          const calc = Math.ceil((item.parLevel - item.currentStock) * (5 / 7));
          reasoningText = `AI: (${item.parLevel} - ${item.currentStock}) √ó 5/7 = ${calc}`;
        } else if (order.vendor === 'Mani Imports') {
          const calc = Math.ceil((item.parLevel - item.currentStock) * (3 / 7));
          reasoningText = `AI: (${item.parLevel} - ${item.currentStock}) √ó 3/7 = ${calc}`;
        } else {
          reasoningText = `AI: ${item.parLevel} - ${item.currentStock} = ${item.quantity}`;
        }

        const lastCountStr = item.lastCountedDate ? `Count: ${formatRelativeTime(item.lastCountedDate)}` : '';
        const lastPriceStr = item.currentUnitCost ? `Price: ${formatPriceWithDate(item.currentUnitCost, item.lastCostUpdate)}` : '';

        let itemNameWithMetadata = item.itemName;
        if (lastCountStr) itemNameWithMetadata += '\n' + lastCountStr;
        if (lastPriceStr) itemNameWithMetadata += '\n' + lastPriceStr;
        itemNameWithMetadata += '\n' + reasoningText;

        return [
          itemNameWithMetadata,
          item.quantity.toString(),
          item.unit,
          item.parLevel.toString(),
          item.currentStock.toString()
        ];
      });

      doc.autoTable({
        head: [['Item', 'Qty', 'Unit', 'Par', 'Stock']],
        body: tableData,
        startY: startY,
        theme: 'plain',
        headStyles: {
          fillColor: darkGray,
          textColor: [255, 255, 255],
          fontSize: 7,
          fontStyle: 'bold',
          halign: 'left',
          cellPadding: { top: 3, right: 4, bottom: 3, left: 4 }
        },
        styles: {
          fontSize: 7,
          cellPadding: { top: 3, right: 4, bottom: 3, left: 4 },
          lineColor: [224, 224, 224],
          lineWidth: 0.1
        },
        columnStyles: {
          0: { cellWidth: 90 },
          1: { halign: 'center', textColor: jaynaBlue, fontStyle: 'bold' },
          2: { halign: 'center', cellWidth: 20 },
          3: { halign: 'center', cellWidth: 20 },
          4: { halign: 'center', cellWidth: 25 }
        },
        alternateRowStyles: {
          fillColor: [250, 250, 250]
        },
        willDrawCell: function(data) {
          if (data.column.index === 0 && data.cell.section === 'body' && data.cell.text.length > 1) {
            data.cell.text = [];
          }
        },
        didDrawCell: function(data) {
          if (data.column.index === 0 && data.cell.section === 'body') {
            const rowData = tableData[data.row.index];
            if (!rowData) {
              return;
            }
            const cellData = rowData[0];
            if (!cellData) {
              return;
            }
            const lines = cellData.split('\n');

            if (lines.length > 1) {
              let yPos = data.cell.y + 4;
              const lineHeight = 3.5;

              lines.forEach((line, index) => {
                if (index === 0) {
                  doc.setFontSize(7);
                  doc.setFont('helvetica', 'bold');
                  doc.setTextColor(26, 26, 26);
                  doc.text(line, data.cell.x + 4, yPos);
                } else if (line.startsWith('Count:') || line.startsWith('Price:')) {
                  doc.setFontSize(6);
                  doc.setFont('helvetica', 'normal');
                  doc.setTextColor(mediumGray[0], mediumGray[1], mediumGray[2]);
                  doc.text(line, data.cell.x + 4, yPos);
                } else if (line.startsWith('AI:')) {
                  doc.setFontSize(5.5);
                  doc.setFont('helvetica', 'italic');
                  doc.setTextColor(lightGray[0], lightGray[1], lightGray[2]);
                  doc.text(line, data.cell.x + 4, yPos);
                  doc.setFont('helvetica', 'normal');
                }
                yPos += lineHeight;
              });

              doc.setFont('helvetica', 'normal');
              doc.setTextColor(26, 26, 26);
            }
          }
        }
      });

      // Footer
      const pageCount = doc.internal.getNumberOfPages();
      for (let i = 1; i <= pageCount; i++) {
        doc.setPage(i);
        doc.setDrawColor(224, 224, 224);
        doc.setLineWidth(0.1);
        doc.line(20, 282, 190, 282);

        doc.setFontSize(6);
        doc.setTextColor(mediumGray[0], mediumGray[1], mediumGray[2]);
        doc.text(`Generated: ${new Date().toLocaleString()}`, 20, 287);
        doc.text(`Page ${i} of ${pageCount}`, 190, 287, { align: 'right' });
      }

      doc.save(`${order.vendor}_Order_${formatPacificDate(order.orderDate)}.pdf`);

      hideLoading();
      showMessage('‚úÖ PDF generated successfully!', 'success');
    } catch (error) {
      hideLoading();
      console.error('PDF generation error:', error);
      showMessage(`Error generating PDF: ${error.message}`, 'error');
    }
  }

  /**
   * Save order edits to localStorage (persist across sessions)
   */
  function saveOrderEditsToStorage(orderIndex) {
    const order = orderingSystemState.calculatedOrders[orderIndex];
    if (!order) return;

    const storageKey = `orderEdits_${order.vendor}_${formatPacificDate(order.orderDate)}`;
    const edits = {};

    order.items.forEach(item => {
      edits[item.id] = {
        quantity: item.quantity,
        unit: item.unit
      };
    });

    localStorage.setItem(storageKey, JSON.stringify(edits));
  }

  /**
   * Load order edits from localStorage
   */
  function loadOrderEditsFromStorage(order) {
    const storageKey = `orderEdits_${order.vendor}_${formatPacificDate(order.orderDate)}`;
    const saved = localStorage.getItem(storageKey);

    if (saved) {
      try {
        const edits = JSON.parse(saved);
        order.items.forEach(item => {
          if (edits[item.id]) {
            item.quantity = edits[item.id].quantity;
            item.unit = edits[item.id].unit;
          }
        });
      } catch (e) {
        console.error('Failed to load saved edits:', e);
      }
    }
  }

  /**
   * Capture all current input field values before PDF generation
   */
  function captureAllOrderEdits(orderIndex) {
    const order = orderingSystemState.calculatedOrders[orderIndex];
    if (!order) return;

    // Get the specific order card
    const orderCard = document.getElementById(`order-${orderIndex}`);
    if (!orderCard) return;

    // Find all quantity inputs WITHIN this specific order card
    const qtyInputs = orderCard.querySelectorAll('input[type="number"]');
    qtyInputs.forEach(input => {
      const itemId = parseInt(input.getAttribute('data-item-id'));
      const newQty = parseFloat(input.value) || 0;
      const item = order.items.find(i => i.id === itemId);
      if (item) {
        item.quantity = newQty;
      }
    });

    // Find all unit inputs WITHIN this specific order card
    const unitInputs = orderCard.querySelectorAll('input[type="text"]');
    unitInputs.forEach(input => {
      const itemId = parseInt(input.getAttribute('data-item-id'));
      const newUnit = input.value.trim().toUpperCase();
      const item = order.items.find(i => i.id === itemId);
      if (item) {
        item.unit = newUnit;
      }
    });

    // Save to localStorage so edits persist
    saveOrderEditsToStorage(orderIndex);
  }

  /**
   * Generate PDF and create order for receiving (combined action)
   */
  async function generatePDFAndCreateOrder(orderIndex) {
    try {
      // FIRST: Capture any unsaved edits from input fields
      captureAllOrderEdits(orderIndex);

      // SECOND: Show the create order modal to save
      await createOrderForReceiving(orderIndex);

      // THIRD: Generate the PDF with the final edited quantities
      await generateOrderPDF(orderIndex);
    } catch (error) {
      // User cancelled or error occurred - do nothing
      console.log('Order creation cancelled or failed:', error);
    }
  }

  /**
   * Generate combined PDF with all orders
   */
  async function generateAllPDFs() {
    if (orderingSystemState.calculatedOrders.length === 0) {
      showMessage('No orders to generate!', 'info');
      return;
    }

    showLoading('Generating Combined PDF', 'Creating document with all orders...');

    try {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      // Cover page
      doc.setFontSize(24);
      doc.setFont('helvetica', 'bold');
      doc.text('JAYNA GYRO', 105, 40, { align: 'center' });

      doc.setFontSize(18);
      doc.text('Weekly Order Summary', 105, 55, { align: 'center' });

      doc.setFontSize(12);
      doc.setFont('helvetica', 'normal');
      doc.text(`Generated: ${new Date().toLocaleString()}`, 105, 70, { align: 'center' });
      doc.text(`Total Orders: ${orderingSystemState.calculatedOrders.length}`, 105, 80, { align: 'center' });

      // Add each order
      orderingSystemState.calculatedOrders.forEach((order, index) => {
        doc.addPage();

        // Header
        doc.setFontSize(18);
        doc.setFont('helvetica', 'bold');
        doc.text(`${order.vendor} - Order #${index + 1}`, 105, 20, { align: 'center' });

        // Order details
        doc.setFontSize(10);
        doc.setFont('helvetica', 'normal');
        doc.text(`Order Date: ${formatPacificDateDisplay(order.orderDate, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}`, 20, 35);
        doc.text(`Cutoff Time: ${order.cutoffTime}`, 20, 42);
        doc.text(`Delivery Date: ${order.deliveryDate.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}`, 20, 49);

        if (order.notes) {
          doc.setFont('helvetica', 'bold');
          doc.text(`Notes: ${order.notes}`, 20, 56);
        }

        // Table with AI reasoning
        const isFriday = formatPacificWeekday(order.orderDate) === 'Friday';
        const isThursday = formatPacificWeekday(order.orderDate) === 'Thursday';

        const tableData = order.items.map(item => {
          // Calculate reasoning text (matches email format)
          let reasoningText = '';
          if (order.vendor === 'Greenleaf' && isFriday) {
            reasoningText = `AI: (Par ${item.parLevel} - Stock ${item.currentStock}) √ó 2 days = ${item.quantity} to order`;
          } else if (order.vendor === 'Mani Imports' && isThursday) {
            const calc = Math.ceil((item.parLevel - item.currentStock) * (5 / 7));
            reasoningText = `AI: (Par ${item.parLevel} - Stock ${item.currentStock}) √ó 5/7 days = ${calc} to order`;
          } else if (order.vendor === 'Mani Imports') {
            const calc = Math.ceil((item.parLevel - item.currentStock) * (3 / 7));
            reasoningText = `AI: (Par ${item.parLevel} - Stock ${item.currentStock}) √ó 3/7 days = ${calc} to order`;
          } else {
            reasoningText = `AI: Par ${item.parLevel} - Stock ${item.currentStock} = ${item.quantity} to order`;
          }

          // Format last count and last price (matches email format)
          const lastCountStr = item.lastCountedDate ? `Last count: ${formatRelativeTime(item.lastCountedDate)}` : '';
          const lastPriceStr = item.currentUnitCost ? `Last price: ${formatPriceWithDate(item.currentUnitCost, item.lastCostUpdate)}` : '';

          // Combine all metadata
          let itemNameWithMetadata = item.itemName;
          if (lastCountStr) itemNameWithMetadata += '\n' + lastCountStr;
          if (lastPriceStr) itemNameWithMetadata += '\n' + lastPriceStr;
          itemNameWithMetadata += '\n' + reasoningText;

          return [
            itemNameWithMetadata,
            item.quantity.toString(),
            item.unit,
            item.parLevel.toString(),
            item.currentStock.toString()
          ];
        });

        doc.autoTable({
          head: [['Item', 'Qty', 'Unit', 'Par', 'Stock']],
          body: tableData,
          startY: order.notes ? 65 : 58,
          theme: 'grid',
          headStyles: { fillColor: [30, 60, 114] },
          styles: { fontSize: 9, cellPadding: 3 },
          columnStyles: {
            0: { cellWidth: 80 } // Wider first column for multi-line content
          },
          willDrawCell: function(data) {
            // Prevent default text rendering for Item column - clear BEFORE drawing
            if (data.column.index === 0 && data.cell.section === 'body' && data.cell.text.length > 1) {
              data.cell.text = []; // This prevents the default rendering
            }
          },
          didDrawCell: function(data) {
            // Custom rendering for Item column with metadata
            if (data.column.index === 0 && data.cell.section === 'body') {
              const cellData = tableData[data.row.index][0];
              const lines = cellData.split('\n');

              if (lines.length > 1) {
                let yPos = data.cell.y + 5;
                const lineHeight = 4;

                // Draw each line with appropriate styling
                lines.forEach((line, index) => {
                  if (index === 0) {
                    // Item name - normal size, black
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(0, 0, 0);
                    doc.text(line, data.cell.x + 2, yPos);
                  } else if (line.startsWith('Last count:') || line.startsWith('Last price:')) {
                    // Metadata - smaller, gray
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(120, 120, 120);
                    doc.text(line, data.cell.x + 2, yPos);
                  } else if (line.startsWith('AI:')) {
                    // Reasoning - smallest, light gray, italic
                    doc.setFontSize(7);
                    doc.setFont('helvetica', 'italic');
                    doc.setTextColor(170, 170, 170);
                    doc.text(line, data.cell.x + 2, yPos);
                    doc.setFont('helvetica', 'normal');
                  }
                  yPos += lineHeight;
                });

                // Reset to defaults
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(0, 0, 0);
              }
            }
          }
        });
      });

      // Footer on all pages
      const pageCount = doc.internal.getNumberOfPages();
      for (let i = 1; i <= pageCount; i++) {
        doc.setPage(i);
        doc.setFontSize(8);
        doc.setFont('helvetica', 'normal');
        doc.text(`Jayna Gyro Ordering System`, 20, 285);
        doc.text(`Page ${i} of ${pageCount}`, 190, 285, { align: 'right' });
      }

      const filename = `Jayna_All_Orders_${getPacificDate()}.pdf`;
      doc.save(filename);

      hideLoading();
      showMessage('‚úÖ Combined PDF generated successfully!', 'success');
    } catch (error) {
      hideLoading();
      showMessage(`Error generating PDF: ${error.message}`, 'error');
    }
  }

  // ====================================
  // ADD ITEM MODALS
  // ====================================

  /**
   * Show Add Inventory Modal
   */
  function showAddInventoryModal() {
    const modalHTML = `
      <div id="addInventoryModal" style="
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10000;
        padding: 20px;
      ">
        <div style="
          background: var(--white);
          border-radius: 0;
          padding: 24px;
          max-width: 600px;
          width: 100%;
          max-height: 90vh;
          overflow-y: auto;
          border: 2px solid var(--gray-300);
        ">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 style="margin: 0; color: var(--gray-900); font-size: 16px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;">Add New Inventory Item</h3>
            <button onclick="closeAddInventoryModal()" style="
              background: none;
              border: none;
              font-size: 24px;
              cursor: pointer;
              color: var(--gray-500);
              padding: 0;
              line-height: 1;
            ">&times;</button>
          </div>

          <form id="addItemFormModal" onsubmit="handleAddItemModal(event)" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div class="form-group">
              <label for="newItemNameModal" style="display: block; margin-bottom: 6px; color: var(--gray-700); font-size: 12px; font-weight: 700; text-transform: uppercase;">Item Name:</label>
              <input type="text" id="newItemNameModal" class="form-input" placeholder="e.g., Wild Arugula 4#/CS" required style="width: 100%; padding: 10px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 13px;">
            </div>
            <div class="form-group">
              <label for="newItemVendorModal" style="display: block; margin-bottom: 6px; color: var(--gray-700); font-size: 12px; font-weight: 700; text-transform: uppercase;">Vendor:</label>
              <select id="newItemVendorModal" class="form-select" required style="width: 100%; padding: 10px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 13px; background: var(--white);">
                <option value="">Select Vendor</option>
                <option value="Greenleaf">Greenleaf</option>
                <option value="Performance">Performance</option>
                <option value="Mani Imports">Mani Imports</option>
                <option value="Eatopia">Eatopia</option>
                <option value="Restaurant Depot">Restaurant Depot</option>
                <option value="Alsco">Alsco</option>
                <option value="SRC Pumping">SRC Pumping</option>
                <option value="Southern Glazer's">Southern Glazer's</option>
                <option value="Breakthru Beverage">Breakthru Beverage</option>
                <option value="Ecolab">Ecolab</option>
                <option value="OTHER">OTHER (Add New Vendor)</option>
              </select>
            </div>
            <div class="form-group">
              <label for="newItemUnitModal" style="display: block; margin-bottom: 6px; color: var(--gray-700); font-size: 12px; font-weight: 700; text-transform: uppercase;">Unit:</label>
              <input type="text" id="newItemUnitModal" class="form-input" placeholder="e.g., CS, EA, LB" required style="width: 100%; padding: 10px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 13px;">
            </div>
            <div class="form-group">
              <label for="newItemParModal" style="display: block; margin-bottom: 6px; color: var(--gray-700); font-size: 12px; font-weight: 700; text-transform: uppercase;">Par Level:</label>
              <input type="number" id="newItemParModal" class="form-input" min="0" value="0" required style="width: 100%; padding: 10px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 13px;">
            </div>
            <div style="grid-column: 1 / -1; display: flex; gap: 10px; margin-top: 10px;">
              <button type="button" onclick="closeAddInventoryModal()" style="
                flex: 1;
                background: var(--gray-300);
                color: var(--gray-900);
                border: none;
                padding: 12px 24px;
                cursor: pointer;
                font-size: 13px;
                font-weight: 700;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                border-radius: 0;
              ">Cancel</button>
              <button type="submit" style="
                flex: 1;
                background: var(--gray-700);
                color: var(--white);
                border: none;
                padding: 12px 24px;
                cursor: pointer;
                font-size: 13px;
                font-weight: 700;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                border-radius: 0;
              ">Add Item</button>
            </div>
          </form>
        </div>
      </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modalHTML);
  }

  function closeAddInventoryModal() {
    const modal = document.getElementById('addInventoryModal');
    if (modal) modal.remove();
  }

  async function handleAddItemModal(event) {
    event.preventDefault();

    const itemName = document.getElementById('newItemNameModal').value.trim();
    let vendor = document.getElementById('newItemVendorModal').value;
    const unit = document.getElementById('newItemUnitModal').value.trim().toUpperCase();
    const parLevel = parseFloat(document.getElementById('newItemParModal').value);

    if (!itemName || !vendor || !unit) {
      showMessage('Please fill in all required fields!', 'error');
      return;
    }

    if (vendor === 'OTHER') {
      showPrompt('Enter new vendor name:', '', (newVendor) => {
        if (!newVendor || newVendor.trim() === '') {
          showMessage('Vendor name is required', 'error');
          return;
        }
        vendor = newVendor.trim();
        continueAddItemModal();
      });
      return;
    }

    continueAddItemModal();

    async function continueAddItemModal() {
      closeAddInventoryModal();
      showLoading('Adding Item', 'Saving to database...');

      try {
      const { data, error } = await supabase
        .from('inventory_items')
        .insert([{
          item_name: itemName,
          vendor: vendor,
          unit: unit,
          par_level: parLevel,
          current_stock: 0,
          item_type: 'ingredient',
          created_date: new Date().toISOString()
        }])
        .select();

      if (error) throw error;

      orderingSystemState.items.push({
        id: data[0].id,
        itemName: data[0].item_name,
        vendor: data[0].vendor,
        parLevel: data[0].par_level,
        currentStock: data[0].current_stock,
        unit: data[0].unit,
        itemType: data[0].item_type,
        lastCountedDate: null
      });

      renderInventoryList();
      hideLoading();
      showMessage(`‚úÖ ${itemName} added successfully!`, 'success');
    } catch (error) {
      hideLoading();
      showMessage(`Error adding item: ${error.message}`, 'error');
    }
    }
  }

  /**
   * Show Add Prep Item Modal
   */
  let prepLocationsCache = [];

  async function loadPrepLocations() {
    try {
      const response = await fetch('/api/prep-locations');
      const result = await response.json();
      if (result.success) {
        prepLocationsCache = result.data || [];
      }
    } catch (error) {
      console.error('Error loading prep locations:', error);
    }
  }

  function toggleMultipleLocations() {
    const checkbox = document.getElementById('multipleLocationsCheckbox');
    const container = document.getElementById('multipleLocationsContainer');
    container.style.display = checkbox.checked ? 'block' : 'none';

    if (checkbox.checked) {
      populateLocationDropdowns();
    }
  }

  function populateLocationDropdowns() {
    const selects = [
      document.getElementById('location1Select'),
      document.getElementById('location2Select'),
      document.getElementById('location3Select')
    ];

    selects.forEach(select => {
      if (!select) return;

      // Clear existing options except first two
      while (select.options.length > 2) {
        select.remove(2);
      }

      // Add location options
      prepLocationsCache.forEach(loc => {
        const option = document.createElement('option');
        option.value = loc.name;
        option.textContent = loc.name;
        select.appendChild(option);
      });
    });
  }

  function handleLocationSelect(locationNum) {
    const select = document.getElementById(`location${locationNum}Select`);
    const input = document.getElementById(`location${locationNum}Input`);

    if (select.value === '__add_new__') {
      input.style.display = 'block';
      input.focus();
    } else {
      input.style.display = 'none';
      input.value = '';
    }
  }

  function showLocation3() {
    const container = document.getElementById('location3Container');
    const link = document.getElementById('addLocationLink');
    container.style.display = 'block';
    link.style.display = 'none';
  }

  async function showAddPrepModal() {
    // Load locations first
    await loadPrepLocations();

    const modalHTML = `
      <div id="addPrepModal" style="
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10000;
        padding: 20px;
      ">
        <div style="
          background: var(--white);
          border-radius: 0;
          padding: 24px;
          max-width: 700px;
          width: 100%;
          max-height: 90vh;
          overflow-y: auto;
          border: 2px solid var(--gray-300);
        ">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 style="margin: 0; color: var(--gray-900); font-size: 16px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;">Add New Prep Item</h3>
            <button onclick="closeAddPrepModal()" style="
              background: none;
              border: none;
              font-size: 24px;
              cursor: pointer;
              color: var(--gray-500);
              padding: 0;
              line-height: 1;
            ">&times;</button>
          </div>

          <form id="addPrepItemFormModal" onsubmit="handleAddPrepItemModal(event)" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div class="form-group">
              <label for="newPrepItemNameModal" style="display: block; margin-bottom: 6px; color: var(--gray-700); font-size: 12px; font-weight: 700; text-transform: uppercase;">Item Name:</label>
              <input type="text" id="newPrepItemNameModal" class="form-input" placeholder="e.g., Marinated Tomatoes" required style="width: 100%; padding: 10px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 13px;">
            </div>
            <div class="form-group">
              <label for="newPrepItemUnitModal" style="display: block; margin-bottom: 6px; color: var(--gray-700); font-size: 12px; font-weight: 700; text-transform: uppercase;">Unit:</label>
              <input type="text" id="newPrepItemUnitModal" class="form-input" placeholder="e.g., CAMBRO, PIECE" required style="width: 100%; padding: 10px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 13px;">
            </div>
            <div class="form-group">
              <label for="newPrepItemParModal" style="display: block; margin-bottom: 6px; color: var(--gray-700); font-size: 12px; font-weight: 700; text-transform: uppercase;">Par Level:</label>
              <input type="number" id="newPrepItemParModal" class="form-input" min="0" step="0.25" value="0" required style="width: 100%; padding: 10px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 13px;">
            </div>
            <div class="form-group">
              <label for="newPrepItemLifespanModal" style="display: block; margin-bottom: 6px; color: var(--gray-700); font-size: 12px; font-weight: 700; text-transform: uppercase;">Batch Lifespan (hours):</label>
              <input type="number" id="newPrepItemLifespanModal" class="form-input" min="0" value="48" required style="width: 100%; padding: 10px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 13px;">
            </div>
            <div class="form-group">
              <label for="newPrepItemStorageModal" style="display: block; margin-bottom: 6px; color: var(--gray-700); font-size: 12px; font-weight: 700; text-transform: uppercase;">Storage Location:</label>
              <input type="text" id="newPrepItemStorageModal" class="form-input" placeholder="e.g., Walk-in Cooler, Freezer, Dry Storage" style="width: 100%; padding: 10px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 13px;">
            </div>

            <div style="grid-column: 1 / -1; margin-top: 8px; padding-top: 16px; border-top: 2px solid var(--gray-300);">
              <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 13px; font-weight: 600; color: var(--gray-900);">
                <input type="checkbox" id="multipleLocationsCheckbox" onchange="toggleMultipleLocations()" style="width: 18px; height: 18px; cursor: pointer;">
                Multiple Locations:
              </label>
            </div>

            <div id="multipleLocationsContainer" style="grid-column: 1 / -1; display: none; margin-top: 12px;">
              <div id="location1Container" style="margin-bottom: 12px;">
                <label style="display: block; margin-bottom: 6px; color: var(--gray-700); font-size: 11px; font-weight: 700; text-transform: uppercase;">Location 1:</label>
                <select id="location1Select" onchange="handleLocationSelect(1)" style="width: 100%; padding: 10px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 13px; background: white;">
                  <option value="">Select location...</option>
                  <option value="__add_new__">+ Add New</option>
                </select>
                <input type="text" id="location1Input" placeholder="Enter new location name" style="width: 100%; padding: 10px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 13px; margin-top: 8px; display: none;">
              </div>

              <div id="location2Container" style="margin-bottom: 12px;">
                <label style="display: block; margin-bottom: 6px; color: var(--gray-700); font-size: 11px; font-weight: 700; text-transform: uppercase;">Location 2:</label>
                <select id="location2Select" onchange="handleLocationSelect(2)" style="width: 100%; padding: 10px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 13px; background: white;">
                  <option value="">Select location...</option>
                  <option value="__add_new__">+ Add New</option>
                </select>
                <input type="text" id="location2Input" placeholder="Enter new location name" style="width: 100%; padding: 10px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 13px; margin-top: 8px; display: none;">
              </div>

              <div id="location3Container" style="margin-bottom: 12px; display: none;">
                <label style="display: block; margin-bottom: 6px; color: var(--gray-700); font-size: 11px; font-weight: 700; text-transform: uppercase;">Location 3:</label>
                <select id="location3Select" onchange="handleLocationSelect(3)" style="width: 100%; padding: 10px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 13px; background: white;">
                  <option value="">Select location...</option>
                  <option value="__add_new__">+ Add New</option>
                </select>
                <input type="text" id="location3Input" placeholder="Enter new location name" style="width: 100%; padding: 10px; border: 2px solid var(--gray-300); border-radius: 0; font-size: 13px; margin-top: 8px; display: none;">
              </div>

              <a href="javascript:void(0)" id="addLocationLink" onclick="showLocation3()" style="color: var(--primary-blue); font-size: 12px; font-weight: 600; text-decoration: underline;">
                + Add Location
              </a>
            </div>
            <div style="grid-column: 1 / -1; display: flex; gap: 10px; margin-top: 10px;">
              <button type="button" onclick="closeAddPrepModal()" style="
                flex: 1;
                background: var(--gray-300);
                color: var(--gray-900);
                border: none;
                padding: 12px 24px;
                cursor: pointer;
                font-size: 13px;
                font-weight: 700;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                border-radius: 0;
              ">Cancel</button>
              <button type="submit" style="
                flex: 1;
                background: var(--gray-700);
                color: var(--white);
                border: none;
                padding: 12px 24px;
                cursor: pointer;
                font-size: 13px;
                font-weight: 700;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                border-radius: 0;
              ">Add Prep Item</button>
            </div>
          </form>
        </div>
      </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modalHTML);
  }

  function closeAddPrepModal() {
    const modal = document.getElementById('addPrepModal');
    if (modal) modal.remove();
  }

  async function handleAddPrepItemModal(event) {
    event.preventDefault();

    const itemName = document.getElementById('newPrepItemNameModal').value.trim();
    const vendor = 'PREP';  // All prep items are vendor "PREP"
    const unit = document.getElementById('newPrepItemUnitModal').value.trim().toUpperCase();
    const parLevel = parseFloat(document.getElementById('newPrepItemParModal').value);
    const batchLifespan = parseInt(document.getElementById('newPrepItemLifespanModal').value);
    const storageLocation = document.getElementById('newPrepItemStorageModal').value;

    // Check multi-location settings
    const multiLocCheckbox = document.getElementById('multipleLocationsCheckbox');
    const hasMultipleLocations = multiLocCheckbox && multiLocCheckbox.checked;

    if (!itemName || !unit) {
      showMessage('Please fill in all required fields!', 'error');
      return;
    }

    closeAddPrepModal();
    showLoading('Adding Prep Item', 'Saving to database...');

    try {
      // Gather locations if multi-location is enabled
      let locationCounts = {};
      if (hasMultipleLocations) {
        const locations = [];

        // Process location 1
        const loc1Select = document.getElementById('location1Select');
        const loc1Input = document.getElementById('location1Input');
        if (loc1Select.value === '__add_new__' && loc1Input.value.trim()) {
          const newLoc = loc1Input.value.trim();
          const capitalized = newLoc.charAt(0).toUpperCase() + newLoc.slice(1);
          locations.push(capitalized);
          await saveNewLocation(capitalized);
        } else if (loc1Select.value && loc1Select.value !== '__add_new__') {
          locations.push(loc1Select.value);
        }

        // Process location 2
        const loc2Select = document.getElementById('location2Select');
        const loc2Input = document.getElementById('location2Input');
        if (loc2Select.value === '__add_new__' && loc2Input.value.trim()) {
          const newLoc = loc2Input.value.trim();
          const capitalized = newLoc.charAt(0).toUpperCase() + newLoc.slice(1);
          locations.push(capitalized);
          await saveNewLocation(capitalized);
        } else if (loc2Select.value && loc2Select.value !== '__add_new__') {
          locations.push(loc2Select.value);
        }

        // Process location 3 (if visible)
        const loc3Container = document.getElementById('location3Container');
        if (loc3Container.style.display !== 'none') {
          const loc3Select = document.getElementById('location3Select');
          const loc3Input = document.getElementById('location3Input');
          if (loc3Select.value === '__add_new__' && loc3Input.value.trim()) {
            const newLoc = loc3Input.value.trim();
            const capitalized = newLoc.charAt(0).toUpperCase() + newLoc.slice(1);
            locations.push(capitalized);
            await saveNewLocation(capitalized);
          } else if (loc3Select.value && loc3Select.value !== '__add_new__') {
            locations.push(loc3Select.value);
          }
        }

        // Initialize counts for each location
        locations.forEach(loc => {
          locationCounts[loc] = 0;
        });
      }

      const insertData = {
        item_name: itemName,
        vendor: vendor,
        unit: unit,
        par_level: parLevel,
        current_stock: 0,
        item_type: 'prep',
        batch_lifespan_hours: batchLifespan,
        storage_location: storageLocation,
        created_date: new Date().toISOString(),
        has_multiple_locations: hasMultipleLocations,
        location_counts: hasMultipleLocations ? locationCounts : {}
      };

      const { data, error } = await supabase
        .from('inventory_items')
        .insert([insertData])
        .select();

      if (error) throw error;

      orderingSystemState.items.push({
        id: data[0].id,
        itemName: data[0].item_name,
        vendor: data[0].vendor,
        parLevel: data[0].par_level,
        currentStock: data[0].current_stock,
        unit: data[0].unit,
        itemType: data[0].item_type,
        batchLifespan: data[0].batch_lifespan_hours,
        storageLocation: data[0].storage_location,
        lastCountedDate: null,
        hasMultipleLocations: data[0].has_multiple_locations,
        locationCounts: data[0].location_counts || {}
      });

      renderPrepCountList();
      refreshPrepSheet();
      refreshBottleCount(); // Refresh bottle count after adding item
      hideLoading();
      showMessage(`‚úÖ ${itemName} added successfully!`, 'success');
    } catch (error) {
      hideLoading();
      showMessage(`Error adding prep item: ${error.message}`, 'error');
    }
  }

  // Helper function to save new location to database
  async function saveNewLocation(locationName) {
    try {
      await fetch('/api/prep-locations', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name: locationName })
      });
      await loadPrepLocations(); // Refresh cache
    } catch (error) {
      console.error('Error saving location:', error);
    }
  }

  // ====================================
  // ORDERING SYSTEM - END
  // ====================================

  // ==================== LIVE STATS (CLOCKED IN, TIPS/HR, LEADER, VOID TRACKING) ====================
  // NOTE: These functions are now provided by app-header.js and are loaded globally.
  // Previously, this file had duplicate definitions which caused "duplicate variable" errors.
  // All live stats initialization is handled by app-header.js.
  // ==================== END LIVE STATS ====================


</script>

<script src="./app-header.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    // Initialize Supabase first
    initializeSupabase();

    // app-header.js auto-renders header, just start ordering system
    setTimeout(() => {
      startOrderingSystem();
    }, 100);
  });
</script>

</body>
</html>
