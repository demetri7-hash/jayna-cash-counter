<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Team Updates - Jayna Gyro</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    /* Jayna Brand Design - Sky Blue & Grayscale */
    :root {
      --primary-blue: #00A8E1;
      --secondary-blue: #0094D6;
      --light-blue: #E3F4FC;
      --accent-blue: #0081C6;
      --gray-900: #212121;
      --gray-700: #424242;
      --gray-600: #616161;
      --gray-500: #757575;
      --gray-400: #BDBDBD;
      --gray-300: #E0E0E0;
      --gray-100: #F5F5F5;
      --success: #00C853;
      --warning: #FFB300;
      --error: #D32F2F;
      --white: #FFFFFF;
      --blue-bg: #dbeafe;
      --blue-text: #1e40af;
      --success-bg: #d1fae5;
      --success-text: #065f46;
      --success-border: #059669;
      --warning-bg: #fef3c7;
      --warning-text: #92400e;
      --warning-border: #f59e0b;
      --error-bg: #fee2e2;
      --error-text: #991b1b;
      --error-border: #dc2626;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body {
      font-family: 'Aptos', 'Segoe UI Variable', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      background: var(--white);
      min-height: 100vh;
      padding: 0;
      overflow-x: hidden;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
      background: var(--white);
      border-radius: 0;
      overflow: visible;
      box-shadow: none;
      min-height: auto;
      max-height: none;
    }
    .content {
      padding: 12px;
      max-height: none;
      overflow: visible;
    }

    h2 {
      font-size: 18px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--gray-900);
      margin-bottom: 16px;
      text-align: center;
    }

    .header {
      background: var(--white);
      color: var(--gray-900);
      text-align: center;
      padding: 12px;
      border-radius: 0;
      border-bottom: 1px solid var(--gray-300);
    }

    .header img {
      width: 300px;
      height: 155px;
      margin-bottom: 4px;
    }

    .header h1 {
      margin-bottom: 4px;
      font-size: 18px;
      font-weight: 700;
      letter-spacing: 1.5px;
      text-transform: uppercase;
    }

    .header p {
      font-size: 11px;
      font-weight: 500;
      letter-spacing: 1px;
      margin-bottom: 8px;
    }

    .menu-btn {
      text-decoration: none;
      padding: 16px 12px;
      border: 2px solid var(--gray-700);
      border-radius: 0;
      background: var(--gray-700);
      font-size: 11px;
      font-weight: 700;
      color: white;
      cursor: pointer;
      text-align: center;
      min-height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      text-transform: uppercase;
      letter-spacing: 1.2px;
      transition: all 0.15s ease;
    }

    .menu-btn.primary {
      border: 2px solid var(--gray-300);
      background: var(--gray-100);
      color: var(--gray-900);
    }

    .menu-btn:hover {
      opacity: 0.9;
    }

    /* Leaderboard Styles */
    .leaderboard-section {
      background: var(--white);
      border: 2px solid var(--gray-300);
      padding: 20px;
      margin-bottom: 20px;
    }

    .leaderboard-item {
      display: grid;
      grid-template-columns: 50px 1fr 80px;
      gap: 12px;
      padding: 16px;
      margin-bottom: 12px;
      align-items: center;
      border: 2px solid var(--gray-300);
      background: white;
      transition: all 0.15s ease;
    }

    .leaderboard-item:hover {
      border-color: var(--primary-blue);
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .leaderboard-item.rank-1 {
      background: linear-gradient(135deg, #FFD700 0%, #FFF9E6 100%);
      border-color: #FFD700;
      border-width: 3px;
    }

    .leaderboard-item.rank-2 {
      background: linear-gradient(135deg, #C0C0C0 0%, #F5F5F5 100%);
      border-color: #C0C0C0;
    }

    .leaderboard-item.rank-3 {
      background: linear-gradient(135deg, #CD7F32 0%, #FFF5E6 100%);
      border-color: #CD7F32;
    }

    .rank-badge {
      font-size: 32px;
      text-align: center;
      font-weight: 700;
    }

    .player-info {
      display: flex;
      flex-direction: column;
    }

    .player-name {
      font-size: 16px;
      font-weight: 700;
      color: var(--gray-900);
      margin-bottom: 4px;
    }

    .player-stats {
      font-size: 11px;
      color: var(--gray-600);
      font-weight: 500;
    }

    .score {
      text-align: center;
    }

    .score-number {
      font-size: 28px;
      font-weight: 700;
      color: var(--primary-blue);
    }

    .score-label {
      font-size: 9px;
      text-transform: uppercase;
      color: var(--gray-600);
      letter-spacing: 0.5px;
      margin-top: 2px;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: var(--gray-600);
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--gray-600);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: var(--gray-100);
      border: 2px solid var(--gray-300);
      padding: 16px;
      text-align: center;
    }

    .stat-value {
      font-size: 32px;
      font-weight: 700;
      color: var(--gray-900);
      margin-bottom: 4px;
    }

    .stat-label {
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--gray-600);
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <img src="jayna-logo-new.png" alt="Jayna Gyro Logo">
      <h1>JAYNA GYRO</h1>
      <p>FOR AUTHORIZED USE ONLY</p>

      <!-- TIPS PER HOUR -->
      <div style="margin-top: 8px; font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: #666;">
        CURRENT TIPS PER HOUR
      </div>
      <div id="tipsPerHourText" style="margin-top: 4px; font-size: 9px; line-height: 1.3;">
        <!-- Tips/hr will display here -->
      </div>
      <div id="tipsLastUpdated" style="margin-top: 4px; font-size: 8px; color: #999; font-weight: 500;">
        <!-- Last updated timestamp -->
      </div>

      <!-- TOP LEADER DISPLAY -->
      <div id="topLeaderDisplay" style="margin-top: 12px; padding: 8px 12px; background: linear-gradient(135deg, #FFD700 0%, #FFF9E6 100%); border: 2px solid #FFD700; border-radius: 0; cursor: default; transition: all 0.15s ease;">
        <div style="font-size: 9px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: #666; margin-bottom: 2px;">üèÜ TODAY'S LEADER</div>
        <div id="topLeaderText" style="font-size: 13px; font-weight: 700; color: #212121;">
          Loading...
        </div>
      </div>

    </div>

    <!-- Navigation -->
    <div class="content">
      <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-bottom: 12px;">
        <a href="index.html" class="menu-btn primary">Cash</a>
        <a href="index.html" class="menu-btn">Orders & Prep</a>
        <a href="foh-checklists.html" class="menu-btn primary">FOH</a>
        <a href="boh.html" class="menu-btn">BOH</a>
        <a href="catering.html" class="menu-btn primary">Catering</a>
        <a href="drivers.html" class="menu-btn">Drivers</a>
        <a href="scheduling.html" class="menu-btn primary">Scheduling</a>
        <a href="manager.html" class="menu-btn">Manager</a>
        <button class="menu-btn" style="cursor: default; background: var(--gray-300) !important; border-color: var(--gray-300) !important; color: var(--gray-700) !important;">Team Updates</button>
      </div>
    </div>

    <!-- Leaderboard Content -->
    <div class="content">
      <h2>üèÜ TEAM LEADERBOARD üèÜ</h2>

      <div style="text-align: center; margin-bottom: 16px; font-size: 12px; color: var(--gray-600); font-weight: 600;">
        Today's Top Performers ‚Ä¢ Tasks + Prep Counts
      </div>

      <!-- Stats Grid -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value" id="totalTasksToday">0</div>
          <div class="stat-label">Total Points</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="activePlayersToday">0</div>
          <div class="stat-label">Active Team Members</div>
        </div>
      </div>

      <!-- Leaderboard List -->
      <div class="leaderboard-section">
        <div id="leaderboardContainer">
          <div class="loading">Loading leaderboard...</div>
        </div>
      </div>

      <div style="text-align: center; font-size: 10px; color: var(--gray-500); margin-top: 20px;">
        Updates every 30 seconds ‚Ä¢ FOH Tasks + Prep Counts (1 point each)
      </div>
    </div>
  </div>

  <script>
    const supabase = (() => {
      if (window._teamupdatesSupabaseClient) {
        return window._teamupdatesSupabaseClient;
      }
      window._teamupdatesSupabaseClient = window.supabase.createClient(
        'https://gaawtbqpnnbbnsyswqwv.supabase.co',
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdhYXd0YnFwbm5iYm5zeXN3cXd2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1MDE1NTAsImV4cCI6MjA3MjA3NzU1MH0.F-y7AIQTWaUe7DRT4OnIZVn94mhXxfhpBbng2aJ8nXg',
        { db: { schema: 'public' }, auth: { persistSession: false } }
      );
      return window._teamupdatesSupabaseClient;
    })();

    // ==================== TIPS PER HOUR DISPLAY ====================

    let lastTipsUpdate = null;

    async function fetchTipsPerHour() {
      try {
        const response = await fetch('/api/toast-tips-per-hour-today', {
          method: 'POST'
        });

        if (!response.ok) {
          updateTipsPerHourDisplay(null);
          return;
        }

        const result = await response.json();

        if (result.success && result.data) {
          lastTipsUpdate = new Date();
          updateTipsPerHourDisplay(result.data);
          updateLastUpdatedTime();
        } else {
          updateTipsPerHourDisplay(null);
        }
      } catch (error) {
        console.error('Error fetching tips per hour:', error);
        updateTipsPerHourDisplay(null);
      }
    }

    function updateTipsPerHourDisplay(data) {
      const displayDiv = document.getElementById('tipsPerHourText');
      if (!displayDiv) return;

      if (!data) {
        displayDiv.innerHTML = '';
        return;
      }

      let html = '';

      // Main tips/hr with color
      const mainColor = data.trendingUp ? '#059669' : '#dc2626';
      const arrow = data.trendingUp ? '‚Üë' : '‚Üì';

      html += `<div style="color: ${mainColor}; font-weight: 600; margin-bottom: 2px;">`;
      html += `${arrow} ${data.tipsPerHour.toFixed(2)}/hr`;
      html += `</div>`;

      // Yesterday comparison
      if (data.percentChangeFromYesterday !== null) {
        const color = data.trendingUp ? '#059669' : '#dc2626';
        html += `<div style="color: ${color}; margin-bottom: 2px;">`;
        html += `${data.percentChangeFromYesterday > 0 ? '+' : ''}${data.percentChangeFromYesterday.toFixed(1)}% vs yesterday`;
        html += `</div>`;
      }

      // Week comparison
      if (data.percentChangeFromLastWeek !== null) {
        const color = data.trendingUpWeek ? '#059669' : '#dc2626';
        html += `<div style="color: ${color}; margin-bottom: 2px;">`;
        html += `${data.percentChangeFromLastWeek > 0 ? '+' : ''}${data.percentChangeFromLastWeek.toFixed(1)}% vs last week`;
        html += `</div>`;
      }

      // Month comparison
      if (data.percentChangeFromLastMonth !== null) {
        const color = data.trendingUpMonth ? '#059669' : '#dc2626';
        html += `<div style="color: ${color};">`;
        html += `${data.percentChangeFromLastMonth > 0 ? '+' : ''}${data.percentChangeFromLastMonth.toFixed(1)}% vs last month`;
        html += `</div>`;
      }

      displayDiv.innerHTML = html;
    }

    function updateLastUpdatedTime() {
      const lastUpdatedDiv = document.getElementById('tipsLastUpdated');
      if (!lastUpdatedDiv || !lastTipsUpdate) return;

      const now = new Date();
      const diffMs = now - lastTipsUpdate;
      const diffSec = Math.floor(diffMs / 1000);
      const diffMin = Math.floor(diffSec / 60);

      let timeAgo = '';
      if (diffMin < 1) {
        timeAgo = 'Just now';
      } else if (diffMin === 1) {
        timeAgo = '1 minute ago';
      } else if (diffMin < 60) {
        timeAgo = `${diffMin} minutes ago`;
      } else {
        const diffHour = Math.floor(diffMin / 60);
        timeAgo = diffHour === 1 ? '1 hour ago' : `${diffHour} hours ago`;
      }

      lastUpdatedDiv.textContent = `LAST UPDATED: ${timeAgo}`;
    }

    // Auto-refresh tips/hr every 5 minutes
    setInterval(fetchTipsPerHour, 5 * 60 * 1000);

    // Update "time ago" display every 30 seconds
    setInterval(updateLastUpdatedTime, 30 * 1000);

    // ==================== TOP LEADER DISPLAY ====================

    async function fetchTopLeader() {
      try {
        const todayPacific = new Date().toLocaleString('en-US', {
          timeZone: 'America/Los_Angeles',
          year: 'numeric',
          month: '2-digit',
          day: '2-digit'
        });

        const [month, day, year] = todayPacific.split(', ')[0].split('/');
        const today = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;

        // Fetch FOH tasks
        const { data: tasks, error: tasksError } = await supabase
          .from('foh_checklist_tasks')
          .select('completed_by, completed_at, is_completed')
          .eq('is_completed', true)
          .gte('completed_at', `${today}T00:00:00`)
          .lt('completed_at', `${today}T23:59:59`);

        // Fetch prep counts
        const { data: prepCounts, error: prepError } = await supabase
          .from('inventory_items')
          .select('counted_by, counted_at')
          .not('counted_by', 'is', null)
          .not('counted_at', 'is', null)
          .gte('counted_at', `${today}T00:00:00`)
          .lt('counted_at', `${today}T23:59:59`);

        if ((!tasks || tasks.length === 0) && (!prepCounts || prepCounts.length === 0)) {
          updateTopLeaderDisplay(null);
          return;
        }

        const leaderboard = {};

        // Count FOH tasks
        if (tasks && tasks.length > 0) {
          tasks.forEach(task => {
            const name = task.completed_by || 'Unknown';
            if (!leaderboard[name]) {
              leaderboard[name] = { name, count: 0, lastCompleted: null };
            }
            leaderboard[name].count++;
            const completedAt = new Date(task.completed_at);
            if (!leaderboard[name].lastCompleted || completedAt > leaderboard[name].lastCompleted) {
              leaderboard[name].lastCompleted = completedAt;
            }
          });
        }

        // Count prep items
        if (prepCounts && prepCounts.length > 0) {
          prepCounts.forEach(prep => {
            const name = prep.counted_by || 'Unknown';
            if (!leaderboard[name]) {
              leaderboard[name] = { name, count: 0, lastCompleted: null };
            }
            leaderboard[name].count++;
            const countedAt = new Date(prep.counted_at);
            if (!leaderboard[name].lastCompleted || countedAt > leaderboard[name].lastCompleted) {
              leaderboard[name].lastCompleted = countedAt;
            }
          });
        }

        const sortedLeaderboard = Object.values(leaderboard)
          .sort((a, b) => {
            if (b.count !== a.count) return b.count - a.count;
            return b.lastCompleted - a.lastCompleted;
          });

        updateTopLeaderDisplay(sortedLeaderboard[0]);

      } catch (error) {
        console.error('Error fetching top leader:', error);
        updateTopLeaderDisplay(null);
      }
    }

    function updateTopLeaderDisplay(leader) {
      const displayDiv = document.getElementById('topLeaderText');
      if (!displayDiv) return;

      if (!leader) {
        displayDiv.textContent = 'No activity yet today! üéØ';
        return;
      }

      displayDiv.textContent = `${leader.name} is crushing it with ${leader.count} point${leader.count !== 1 ? 's' : ''}! üî•`;
    }

    // Fetch on page load and refresh every 2 minutes
    fetchTopLeader();
    setInterval(fetchTopLeader, 2 * 60 * 1000);

    // ==================== END TOP LEADER DISPLAY ====================

    // ==================== END TIPS PER HOUR DISPLAY ====================

    // ==================== LEADERBOARD ====================

    async function loadLeaderboard() {
      try {
        // Get today's date in Pacific Time
        const todayPacific = new Date().toLocaleString('en-US', {
          timeZone: 'America/Los_Angeles',
          year: 'numeric',
          month: '2-digit',
          day: '2-digit'
        });

        const [month, day, year] = todayPacific.split(', ')[0].split('/');
        const today = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;

        // Fetch all completed FOH checklist tasks for today
        const { data: tasks, error: tasksError } = await supabase
          .from('foh_checklist_tasks')
          .select('completed_by, completed_at, is_completed')
          .eq('is_completed', true)
          .gte('completed_at', `${today}T00:00:00`)
          .lt('completed_at', `${today}T23:59:59`);

        if (tasksError) {
          console.error('Error loading tasks:', tasksError);
        }

        // Fetch all prep items counted today
        const { data: prepCounts, error: prepError } = await supabase
          .from('inventory_items')
          .select('counted_by, counted_at, item_name')
          .not('counted_by', 'is', null)
          .not('counted_at', 'is', null)
          .gte('counted_at', `${today}T00:00:00`)
          .lt('counted_at', `${today}T23:59:59`);

        if (prepError) {
          console.error('Error loading prep counts:', prepError);
        }

        // If both queries failed or no data at all, show empty state
        if ((!tasks || tasks.length === 0) && (!prepCounts || prepCounts.length === 0)) {
          showEmptyState();
          return;
        }

        // Count tasks and prep counts by person
        const leaderboard = {};

        // Add FOH checklist tasks (1 point each)
        if (tasks && tasks.length > 0) {
          tasks.forEach(task => {
            const name = task.completed_by || 'Unknown';
            if (!leaderboard[name]) {
              leaderboard[name] = {
                name: name,
                taskCount: 0,
                prepCount: 0,
                totalPoints: 0,
                lastCompleted: null
              };
            }
            leaderboard[name].taskCount++;
            leaderboard[name].totalPoints++;

            // Track most recent completion
            const completedAt = new Date(task.completed_at);
            if (!leaderboard[name].lastCompleted || completedAt > leaderboard[name].lastCompleted) {
              leaderboard[name].lastCompleted = completedAt;
            }
          });
        }

        // Add prep counts (1 point per prep item counted)
        if (prepCounts && prepCounts.length > 0) {
          prepCounts.forEach(prep => {
            const name = prep.counted_by || 'Unknown';
            if (!leaderboard[name]) {
              leaderboard[name] = {
                name: name,
                taskCount: 0,
                prepCount: 0,
                totalPoints: 0,
                lastCompleted: null
              };
            }
            leaderboard[name].prepCount++;
            leaderboard[name].totalPoints++;

            // Track most recent activity
            const countedAt = new Date(prep.counted_at);
            if (!leaderboard[name].lastCompleted || countedAt > leaderboard[name].lastCompleted) {
              leaderboard[name].lastCompleted = countedAt;
            }
          });
        }

        // Convert to array and sort by total points
        const sortedLeaderboard = Object.values(leaderboard)
          .sort((a, b) => {
            if (b.totalPoints !== a.totalPoints) return b.totalPoints - a.totalPoints;
            // Tie-breaker: most recent completion wins
            return b.lastCompleted - a.lastCompleted;
          });

        // Update stats
        const totalTasks = tasks ? tasks.length : 0;
        const totalPrep = prepCounts ? prepCounts.length : 0;
        const totalPoints = totalTasks + totalPrep;

        document.getElementById('totalTasksToday').textContent = totalPoints;
        document.getElementById('activePlayersToday').textContent = sortedLeaderboard.length;

        // Render leaderboard
        renderLeaderboard(sortedLeaderboard);

      } catch (error) {
        console.error('Error loading leaderboard:', error);
        showEmptyState();
      }
    }

    function renderLeaderboard(leaderboard) {
      const container = document.getElementById('leaderboardContainer');

      if (leaderboard.length === 0) {
        showEmptyState();
        return;
      }

      const rankEmojis = ['ü•á', 'ü•à', 'ü•â', '4Ô∏è‚É£', '5Ô∏è‚É£', '6Ô∏è‚É£', '7Ô∏è‚É£', '8Ô∏è‚É£', '9Ô∏è‚É£', 'üîü'];
      const motivationalEmojis = ['‚≠ê', 'üåü', '‚ú®', 'üí™', 'üöÄ', 'üî•', 'üíØ', 'üëè'];

      let html = '';

      leaderboard.forEach((player, index) => {
        const rank = index + 1;
        const rankClass = rank <= 3 ? `rank-${rank}` : '';
        const rankDisplay = rankEmojis[index] || `#${rank}`;

        // Get a random motivational emoji for non-top-3
        const randomEmoji = rank > 3 ? motivationalEmojis[Math.floor(Math.random() * motivationalEmojis.length)] : '';

        // Format last completed time
        const timeSince = getTimeSince(player.lastCompleted);

        // Build stats breakdown
        const statsBreakdown = [];
        if (player.taskCount > 0) {
          statsBreakdown.push(`${player.taskCount} task${player.taskCount !== 1 ? 's' : ''}`);
        }
        if (player.prepCount > 0) {
          statsBreakdown.push(`${player.prepCount} prep`);
        }
        const statsText = statsBreakdown.length > 0 ? statsBreakdown.join(' ‚Ä¢ ') : 'No activity';

        html += `
          <div class="leaderboard-item ${rankClass}">
            <div class="rank-badge">${rankDisplay}</div>
            <div class="player-info">
              <div class="player-name">${player.name} ${rank > 3 ? randomEmoji : ''}</div>
              <div class="player-stats">${statsText} ‚Ä¢ ${timeSince}</div>
            </div>
            <div class="score">
              <div class="score-number">${player.totalPoints}</div>
              <div class="score-label">POINTS</div>
            </div>
          </div>
        `;
      });

      container.innerHTML = html;
    }

    function getTimeSince(date) {
      const now = new Date();
      const diffMs = now - date;
      const diffMin = Math.floor(diffMs / (1000 * 60));

      if (diffMin < 1) return 'Just now';
      if (diffMin === 1) return '1 min ago';
      if (diffMin < 60) return `${diffMin} mins ago`;

      const diffHour = Math.floor(diffMin / 60);
      if (diffHour === 1) return '1 hour ago';
      if (diffHour < 24) return `${diffHour} hours ago`;

      return 'Today';
    }

    function showEmptyState() {
      const container = document.getElementById('leaderboardContainer');
      container.innerHTML = `
        <div class="empty-state">
          <div style="font-size: 48px; margin-bottom: 16px;">üìã</div>
          <div style="font-size: 14px; font-weight: 600; margin-bottom: 8px;">No activity yet today</div>
          <div style="font-size: 12px; color: var(--gray-500);">Complete FOH tasks or count prep items to earn points!</div>
        </div>
      `;
      document.getElementById('totalTasksToday').textContent = '0';
      document.getElementById('activePlayersToday').textContent = '0';
    }

    // ==================== INITIALIZATION ====================

    document.addEventListener('DOMContentLoaded', async () => {
      await loadLeaderboard();
      fetchTipsPerHour();

      // Auto-refresh leaderboard every 30 seconds
      setInterval(loadLeaderboard, 30 * 1000);
    });
  </script>
</body>
</html>
