<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, viewport-fit=cover">
  <title>Jayna Gyro - COGs Management</title>

  <link rel="apple-touch-icon" href="https://static.spotapps.co/website_images/ab_websites/229800_website_v1/logo.png">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#00A8E1">

  <style>
    /* Jayna Brand Design - Sky Blue & Grayscale */
    :root {
      --primary-blue: #00A8E1;
      --secondary-blue: #0094D6;
      --light-blue: #E3F4FC;
      --accent-blue: #0081C6;
      --gray-900: #212121;
      --gray-700: #424242;
      --gray-500: #757575;
      --gray-400: #BDBDBD;
      --gray-300: #E0E0E0;
      --gray-100: #F5F5F5;
      --dark-gray: #616161;
      --success: #00C853;
      --warning: #FFB300;
      --error: #D32F2F;
      --white: #FFFFFF;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body {
      font-family: 'Aptos', 'Segoe UI Variable', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      background: var(--gray-100);
      min-height: 100vh;
      padding: 0;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
      background: var(--white);
      min-height: 100vh;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }
    .header {
      background: var(--white);
      color: var(--gray-900);
      text-align: center;
      padding: 12px;
      border-bottom: 1px solid var(--gray-300);
    }
    .header h1 { font-size: 18px; font-weight: 700; margin-bottom: 2px; letter-spacing: 1.5px; text-transform: uppercase; }
    .header p { opacity: 0.7; font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }

    .content { padding: 12px; }

    /* Navigation Buttons */
    .main-menu {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 8px;
      margin-bottom: 16px;
    }
    .menu-btn {
      padding: 16px 12px;
      border: 2px solid var(--gray-300);
      background: var(--gray-100);
      font-size: 11px;
      font-weight: 700;
      color: var(--gray-900);
      cursor: pointer;
      text-align: center;
      min-height: 50px;
      text-transform: uppercase;
      letter-spacing: 1.2px;
    }
    .menu-btn:hover { background: var(--gray-300); }
    .menu-btn.primary { background: var(--white); }
    .menu-btn.cogs {
      background: var(--dark-gray);
      color: var(--white);
      border-color: var(--dark-gray);
    }

    /* Quick Actions Grid */
    .quick-actions {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 20px;
    }
    .action-btn {
      padding: 24px 16px;
      background: var(--white);
      border: 2px solid var(--gray-300);
      cursor: pointer;
      text-align: center;
    }
    .action-btn:hover {
      border-color: var(--primary-blue);
      background: var(--light-blue);
    }
    .action-btn .icon { font-size: 32px; margin-bottom: 8px; }
    .action-btn .label {
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--gray-700);
    }

    /* Summary Card */
    .summary-card {
      background: var(--white);
      border: 2px solid var(--gray-300);
      padding: 20px;
    }
    .summary-card h3 {
      font-size: 14px;
      font-weight: 700;
      color: var(--gray-700);
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .summary-stat {
      display: flex;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid var(--gray-300);
    }
    .summary-stat:last-child { border-bottom: none; }
    .stat-label {
      font-size: 12px;
      color: var(--gray-500);
      text-transform: uppercase;
    }
    .stat-value {
      font-size: 18px;
      font-weight: 700;
      color: var(--gray-900);
    }
    .stat-value.good { color: var(--success); }
    .stat-value.warning { color: var(--warning); }

    /* Forms */
    .form-group { margin-bottom: 12px; }
    .form-group label {
      display: block;
      margin-bottom: 4px;
      font-weight: 700;
      font-size: 10px;
      color: var(--gray-700);
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .form-input, .form-select {
      width: 100%;
      padding: 12px 14px;
      border: 1px solid var(--gray-300);
      font-size: 14px;
      min-height: 44px;
      background: var(--white);
      color: var(--gray-900);
    }
    .form-input:focus, .form-select:focus {
      outline: none;
      border-color: var(--primary-blue);
      box-shadow: 0 0 0 2px rgba(0, 168, 225, 0.15);
    }
    .submit-btn {
      width: 100%;
      padding: 14px;
      background: var(--gray-100);
      color: var(--gray-900);
      border: none;
      font-size: 12px;
      font-weight: 700;
      cursor: pointer;
      margin-top: 12px;
      min-height: 44px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .submit-btn:hover { background: var(--gray-300); }
    .submit-btn.primary {
      background: var(--primary-blue);
      color: var(--white);
    }
    .submit-btn.primary:hover { background: var(--secondary-blue); }

    /* Items Table */
    .items-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 16px;
    }
    .items-table th {
      background: var(--gray-100);
      padding: 12px;
      text-align: left;
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--gray-700);
      border-bottom: 2px solid var(--gray-300);
    }
    .items-table td {
      padding: 12px;
      border-bottom: 1px solid var(--gray-300);
      font-size: 12px;
    }
    .items-table tr:hover { background: var(--light-blue); }
    .btn-small {
      padding: 6px 12px;
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      border: none;
      cursor: pointer;
      margin-right: 4px;
    }
    .btn-edit {
      background: var(--primary-blue);
      color: var(--white);
    }
    .btn-delete {
      background: var(--error);
      color: var(--white);
    }

    /* Spinner */
    .spinner {
      border: 3px solid var(--gray-300);
      border-top: 3px solid var(--primary-blue);
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @media (max-width: 768px) {
      .main-menu { grid-template-columns: 1fr 1fr; }
      .quick-actions { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>JAYNA GYRO</h1>
      <p>COST OF GOODS MANAGEMENT</p>
    </div>

    <div class="content">
      <!-- Navigation Buttons -->
      <div class="main-menu">
        <button class="menu-btn primary" onclick="window.location.href='index.html'">AM Count</button>
        <button class="menu-btn primary" onclick="window.location.href='index.html'">PM Close</button>
        <button class="menu-btn" onclick="window.location.href='index.html'">Generate Report</button>
        <button class="menu-btn" onclick="window.location.href='index.html'">Tip Pool</button>
        <button class="menu-btn" onclick="window.location.href='index.html'">Weekly Cashbox</button>
        <button class="menu-btn" onclick="window.location.href='manager.html'">Manager</button>
        <button class="menu-btn cogs">COGs</button>
      </div>

      <!-- Dashboard (default view) -->
      <div id="dashboard">
        <h2 style="margin-bottom: 20px; color: var(--gray-900); font-size: 18px; text-transform: uppercase;">Cost of Goods Sold</h2>

        <div class="quick-actions">
          <div class="action-btn" onclick="showManageItems()">
            <div class="icon">üè∑Ô∏è</div>
            <div class="label">Manage Items</div>
          </div>
          <div class="action-btn" onclick="showScanInvoice()">
            <div class="icon">üì∏</div>
            <div class="label">Scan Invoice</div>
          </div>
          <div class="action-btn" onclick="alert('Coming in Day 3: Camera-assisted counting')">
            <div class="icon">üì¶</div>
            <div class="label">Daily Count</div>
          </div>
          <div class="action-btn" onclick="alert('Coming in Day 3: COGs reporting and analysis')">
            <div class="icon">üìä</div>
            <div class="label">View Reports</div>
          </div>
        </div>

        <div class="summary-card">
          <h3>This Week Summary</h3>
          <div class="summary-stat">
            <span class="stat-label">Food Cost %</span>
            <span class="stat-value good">28.5%</span>
          </div>
          <div class="summary-stat">
            <span class="stat-label">COGs Total</span>
            <span class="stat-value">$12,450.00</span>
          </div>
          <div class="summary-stat">
            <span class="stat-label">Variance</span>
            <span class="stat-value warning">-$127.00</span>
          </div>
        </div>
      </div>

      <!-- Manage Items Section -->
      <div id="manageItems" style="display: none;">
        <h2 style="margin-bottom: 20px; color: var(--gray-900); font-size: 18px; text-transform: uppercase;">Inventory Items</h2>

        <button class="submit-btn primary" onclick="showAddItemForm()">+ Add New Item</button>

        <div class="form-group" style="margin-top: 16px;">
          <label for="categoryFilter">Filter by Category:</label>
          <select id="categoryFilter" class="form-select" onchange="filterItems()">
            <option value="">All Categories</option>
            <option value="PRODUCE">Produce</option>
            <option value="MEAT">Meat</option>
            <option value="GYROS">Gyros</option>
            <option value="BREADS">Breads</option>
            <option value="LIQUOR">Liquor</option>
            <option value="BEER">Beer</option>
            <option value="WINE">Wine</option>
            <option value="DAIRY">Dairy</option>
            <option value="NA DRINKS">NA Drinks</option>
            <option value="JUICES">Juices</option>
          </select>
        </div>

        <div id="itemsList" style="margin-top: 20px;">
          <p style="text-align: center; color: var(--gray-500); padding: 40px 0;">Loading items...</p>
        </div>

        <button class="submit-btn" onclick="showDashboard()">Back to Dashboard</button>
      </div>

      <!-- Add/Edit Item Form -->
      <div id="itemForm" style="display: none;">
        <h2 style="margin-bottom: 20px; color: var(--gray-900); font-size: 18px; text-transform: uppercase;" id="itemFormTitle">Add New Item</h2>

        <div class="form-group">
          <label for="itemName">Item Name*</label>
          <input type="text" id="itemName" class="form-input" required placeholder="e.g., Ground Beef 80/20">
        </div>

        <div class="form-group">
          <label for="itemCategory">Category*</label>
          <select id="itemCategory" class="form-select" required>
            <option value="">Select Category</option>
            <option value="PRODUCE">Produce</option>
            <option value="MEAT">Meat</option>
            <option value="GYROS">Gyros</option>
            <option value="BREADS">Breads</option>
            <option value="LIQUOR">Liquor</option>
            <option value="BEER">Beer</option>
            <option value="WINE">Wine</option>
            <option value="DAIRY">Dairy</option>
            <option value="NA DRINKS">NA Drinks</option>
            <option value="JUICES">Juices</option>
          </select>
        </div>

        <div class="form-group">
          <label for="itemUnit">Unit*</label>
          <input type="text" id="itemUnit" class="form-input" required placeholder="e.g., lb, case, each, oz, gal">
        </div>

        <div class="form-group">
          <label for="itemParLevel">Par Level</label>
          <input type="number" id="itemParLevel" class="form-input" step="0.01" placeholder="Ideal stock level">
        </div>

        <div class="form-group">
          <label for="itemCost">Current Cost per Unit</label>
          <input type="number" id="itemCost" class="form-input" step="0.01" placeholder="e.g., 5.99">
        </div>

        <div class="form-group">
          <label for="itemVendor">Primary Vendor</label>
          <input type="text" id="itemVendor" class="form-input" placeholder="e.g., Sysco Sacramento">
        </div>

        <div class="form-group">
          <label for="itemBarcode">Barcode/UPC (Optional)</label>
          <input type="text" id="itemBarcode" class="form-input" placeholder="For scanning beer/drinks">
        </div>

        <div class="form-group">
          <label for="itemFrequency">Count Frequency</label>
          <select id="itemFrequency" class="form-select">
            <option value="daily">Daily</option>
            <option value="weekly" selected>Weekly</option>
            <option value="monthly">Monthly</option>
          </select>
        </div>

        <button class="submit-btn primary" onclick="saveItem()">Save Item</button>
        <button class="submit-btn" onclick="showManageItems()">Cancel</button>
      </div>

      <!-- Scan Invoice Section -->
      <div id="scanInvoice" style="display: none;">
        <h2 style="margin-bottom: 20px; color: var(--gray-900); font-size: 18px; text-transform: uppercase;">Scan Invoice</h2>

        <!-- Vendor Selection -->
        <div class="form-group">
          <label for="invoiceVendor">Vendor*</label>
          <select id="invoiceVendor" class="form-select" required>
            <option value="">Select Vendor</option>
          </select>
        </div>

        <!-- File Upload -->
        <div class="form-group">
          <label for="invoiceFile">Upload Invoice (Photo or PDF)*</label>
          <input type="file" id="invoiceFile" class="form-input" accept="image/*,application/pdf" capture="environment">
          <p style="font-size: 11px; color: var(--gray-500); margin-top: 4px;">Supported: Photos (JPG, PNG) or PDF files</p>
        </div>

        <!-- Invoice Preview -->
        <div id="invoicePreview" style="display: none; margin-top: 16px;">
          <img id="previewImage" style="width: 100%; max-height: 400px; object-fit: contain; border: 2px solid var(--gray-300);">
        </div>

        <!-- OCR Processing Status -->
        <div id="ocrStatus" style="display: none; margin-top: 16px; padding: 16px; background: var(--light-blue); border: 2px solid var(--primary-blue);">
          <div style="display: flex; align-items: center; gap: 12px;">
            <div class="spinner"></div>
            <div>
              <strong>Processing Invoice...</strong>
              <p id="ocrProgress" style="font-size: 12px; color: var(--gray-700); margin-top: 4px;">Initializing OCR...</p>
            </div>
          </div>
        </div>

        <!-- Extracted Data Review -->
        <div id="extractedData" style="display: none; margin-top: 20px;">
          <h3 style="font-size: 14px; font-weight: 700; margin-bottom: 12px; color: var(--success);">‚úì Invoice Extracted</h3>

          <div class="form-group">
            <label for="extractedVendor">Vendor Name</label>
            <input type="text" id="extractedVendor" class="form-input" placeholder="Auto-detected vendor">
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <div class="form-group">
              <label for="extractedDate">Invoice Date</label>
              <input type="date" id="extractedDate" class="form-input">
            </div>
            <div class="form-group">
              <label for="extractedInvoiceNumber">Invoice #</label>
              <input type="text" id="extractedInvoiceNumber" class="form-input" placeholder="Invoice number">
            </div>
          </div>

          <div class="form-group">
            <label for="extractedTotal">Total Amount</label>
            <input type="number" id="extractedTotal" class="form-input" step="0.01" placeholder="0.00">
          </div>

          <!-- Extracted Items Table -->
          <div class="form-group">
            <label>Extracted Items</label>
            <div id="extractedItemsList" style="margin-top: 8px; max-height: 300px; overflow-y: auto; border: 2px solid var(--gray-300); padding: 12px;">
              <p style="text-align: center; color: var(--gray-500);">No items extracted yet</p>
            </div>
          </div>

          <!-- Raw OCR Text (for debugging) -->
          <details style="margin-top: 16px;">
            <summary style="cursor: pointer; font-size: 12px; color: var(--gray-500);">View Raw OCR Text</summary>
            <textarea id="rawOcrText" readonly style="width: 100%; min-height: 200px; margin-top: 8px; font-family: monospace; font-size: 11px; padding: 12px; border: 1px solid var(--gray-300);"></textarea>
          </details>
        </div>

        <div style="margin-top: 20px;">
          <button class="submit-btn primary" onclick="processInvoice()" id="processBtn">Process Invoice</button>
          <button class="submit-btn primary" onclick="saveInvoice()" id="saveInvoiceBtn" style="display: none;">Save to Database</button>
          <button class="submit-btn" onclick="showDashboard()">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

  <script>
    // Supabase
    const SUPABASE_URL = 'https://gaawtbqpnnbbnsyswqwv.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdhYXd0YnFwbm5iYm5zeXN3cXd2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1MDE1NTAsImV4cCI6MjA3MjA3NzU1MH0.F-y7AIQTWaUe7DRT4OnIZVn94mhXxfhpBbng2aJ8nXg';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let currentEditingId = null;

    // Simple navigation
    function showDashboard() {
      document.getElementById('dashboard').style.display = 'block';
      document.getElementById('manageItems').style.display = 'none';
      document.getElementById('itemForm').style.display = 'none';
    }

    function showManageItems() {
      document.getElementById('dashboard').style.display = 'none';
      document.getElementById('manageItems').style.display = 'block';
      document.getElementById('itemForm').style.display = 'none';
      loadItems();
    }

    function showAddItemForm() {
      currentEditingId = null;
      document.getElementById('itemFormTitle').textContent = 'Add New Item';
      document.getElementById('itemName').value = '';
      document.getElementById('itemCategory').value = '';
      document.getElementById('itemUnit').value = '';
      document.getElementById('itemParLevel').value = '';
      document.getElementById('itemCost').value = '';
      document.getElementById('itemVendor').value = '';
      document.getElementById('itemBarcode').value = '';
      document.getElementById('itemFrequency').value = 'weekly';

      document.getElementById('dashboard').style.display = 'none';
      document.getElementById('manageItems').style.display = 'none';
      document.getElementById('itemForm').style.display = 'block';
    }

    async function showScanInvoice() {
      document.getElementById('dashboard').style.display = 'none';
      document.getElementById('manageItems').style.display = 'none';
      document.getElementById('itemForm').style.display = 'none';
      document.getElementById('scanInvoice').style.display = 'block';

      // Load vendors
      await loadVendorsForInvoice();

      // Setup file input listener
      const fileInput = document.getElementById('invoiceFile');
      fileInput.addEventListener('change', handleFileSelect);
    }

    async function loadVendorsForInvoice() {
      try {
        const { data, error } = await supabase
          .from('vendors')
          .select('id, vendor_name')
          .eq('active', true)
          .order('vendor_name');

        if (error) throw error;

        const select = document.getElementById('invoiceVendor');
        select.innerHTML = '<option value="">Select Vendor</option>';

        data.forEach(vendor => {
          const option = document.createElement('option');
          option.value = vendor.id;
          option.textContent = vendor.vendor_name;
          select.appendChild(option);
        });
      } catch (error) {
        console.error('Error loading vendors:', error);
      }
    }

    let currentInvoiceFile = null;
    let currentOcrText = '';

    function handleFileSelect(event) {
      const file = event.target.files[0];
      if (!file) return;

      currentInvoiceFile = file;

      // Show preview
      const reader = new FileReader();
      reader.onload = (e) => {
        document.getElementById('previewImage').src = e.target.result;
        document.getElementById('invoicePreview').style.display = 'block';
      };
      reader.readAsDataURL(file);
    }

    async function processInvoice() {
      if (!currentInvoiceFile) {
        alert('Please select an invoice file first');
        return;
      }

      const vendorId = document.getElementById('invoiceVendor').value;
      if (!vendorId) {
        alert('Please select a vendor');
        return;
      }

      try {
        // Show processing status
        document.getElementById('ocrStatus').style.display = 'block';
        document.getElementById('processBtn').disabled = true;

        // Update progress
        document.getElementById('ocrProgress').textContent = 'Loading OCR engine...';

        // Process with Tesseract
        const result = await Tesseract.recognize(
          currentInvoiceFile,
          'eng',
          {
            logger: (m) => {
              if (m.status === 'recognizing text') {
                document.getElementById('ocrProgress').textContent = `Recognizing text... ${Math.round(m.progress * 100)}%`;
              }
            }
          }
        );

        currentOcrText = result.data.text;

        // Update progress
        document.getElementById('ocrProgress').textContent = 'Parsing invoice data...';

        // Parse the OCR text
        const parsedData = parseInvoiceText(currentOcrText, vendorId);

        // Show extracted data
        document.getElementById('extractedVendor').value = parsedData.vendorName || '';
        document.getElementById('extractedDate').value = parsedData.date || '';
        document.getElementById('extractedInvoiceNumber').value = parsedData.invoiceNumber || '';
        document.getElementById('extractedTotal').value = parsedData.total || '';
        document.getElementById('rawOcrText').value = currentOcrText;

        // Display extracted items
        displayExtractedItems(parsedData.items || []);

        // Hide processing, show extracted data
        document.getElementById('ocrStatus').style.display = 'none';
        document.getElementById('extractedData').style.display = 'block';
        document.getElementById('processBtn').style.display = 'none';
        document.getElementById('saveInvoiceBtn').style.display = 'block';

      } catch (error) {
        console.error('OCR Error:', error);
        alert('Error processing invoice: ' + error.message);
        document.getElementById('ocrStatus').style.display = 'none';
        document.getElementById('processBtn').disabled = false;
      }
    }

    function parseInvoiceText(text, vendorId) {
      // Basic invoice parser - will improve as we analyze real invoices
      const lines = text.split('\n').filter(line => line.trim());

      const result = {
        vendorName: '',
        date: '',
        invoiceNumber: '',
        total: '',
        items: []
      };

      // Date patterns
      const datePatterns = [
        /(\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4})/,
        /(\d{4}[\/\-]\d{1,2}[\/\-]\d{1,2})/
      ];

      // Invoice number patterns
      const invoicePatterns = [
        /inv(?:oice)?[#:\s]*(\w+)/i,
        /#\s*(\d+)/,
        /invoice\s*number[:\s]*(\w+)/i
      ];

      // Total patterns
      const totalPatterns = [
        /total[:\s]*\$?\s*(\d+\.?\d*)/i,
        /amount[:\s]*\$?\s*(\d+\.?\d*)/i,
        /balance[:\s]*\$?\s*(\d+\.?\d*)/i
      ];

      // Parse each line
      lines.forEach(line => {
        // Try to find date
        if (!result.date) {
          for (const pattern of datePatterns) {
            const match = line.match(pattern);
            if (match) {
              result.date = parseDate(match[1]);
              break;
            }
          }
        }

        // Try to find invoice number
        if (!result.invoiceNumber) {
          for (const pattern of invoicePatterns) {
            const match = line.match(pattern);
            if (match) {
              result.invoiceNumber = match[1];
              break;
            }
          }
        }

        // Try to find total
        if (!result.total) {
          for (const pattern of totalPatterns) {
            const match = line.match(pattern);
            if (match) {
              result.total = match[1];
              break;
            }
          }
        }

        // Try to extract line items (basic pattern: item name, quantity, price)
        const itemPattern = /^(.+?)\s+(\d+\.?\d*)\s+\$?\s*(\d+\.?\d*)$/;
        const match = line.match(itemPattern);
        if (match) {
          result.items.push({
            description: match[1].trim(),
            quantity: parseFloat(match[2]),
            price: parseFloat(match[3])
          });
        }
      });

      return result;
    }

    function parseDate(dateStr) {
      // Convert various date formats to YYYY-MM-DD
      const parts = dateStr.split(/[\/\-]/);
      if (parts.length === 3) {
        let year, month, day;

        if (parts[0].length === 4) {
          // YYYY-MM-DD or YYYY-DD-MM
          year = parts[0];
          month = parts[1].padStart(2, '0');
          day = parts[2].padStart(2, '0');
        } else {
          // MM-DD-YYYY or DD-MM-YYYY (assume MM-DD-YYYY for US)
          month = parts[0].padStart(2, '0');
          day = parts[1].padStart(2, '0');
          year = parts[2].length === 2 ? '20' + parts[2] : parts[2];
        }

        return `${year}-${month}-${day}`;
      }
      return '';
    }

    function displayExtractedItems(items) {
      const container = document.getElementById('extractedItemsList');

      if (!items || items.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: var(--gray-500);">No items extracted. You can add them manually after saving.</p>';
        return;
      }

      let html = '<table class="items-table" style="font-size: 11px;"><thead><tr>';
      html += '<th>Item</th><th>Qty</th><th>Price</th></tr></thead><tbody>';

      items.forEach(item => {
        html += `<tr>
          <td>${item.description}</td>
          <td>${item.quantity}</td>
          <td>$${item.price.toFixed(2)}</td>
        </tr>`;
      });

      html += '</tbody></table>';
      container.innerHTML = html;
    }

    async function saveInvoice() {
      const vendorId = document.getElementById('invoiceVendor').value;
      const vendorName = document.getElementById('invoiceVendor').selectedOptions[0].text;
      const date = document.getElementById('extractedDate').value;
      const invoiceNumber = document.getElementById('extractedInvoiceNumber').value;
      const total = parseFloat(document.getElementById('extractedTotal').value) || 0;

      if (!vendorId || !date) {
        alert('Please fill in vendor and date');
        return;
      }

      try {
        // Save to invoice_archive table
        const { data, error } = await supabase
          .from('invoice_archive')
          .insert([{
            vendor_id: vendorId,
            vendor_name: vendorName,
            invoice_date: date,
            invoice_number: invoiceNumber,
            total_amount: total,
            ocr_text: currentOcrText,
            processed: true,
            verified: false,
            uploaded_at: new Date().toISOString()
          }])
          .select();

        if (error) throw error;

        alert('Invoice saved successfully!');

        // Reset form and go back to dashboard
        document.getElementById('invoiceFile').value = '';
        document.getElementById('invoicePreview').style.display = 'none';
        document.getElementById('extractedData').style.display = 'none';
        document.getElementById('processBtn').style.display = 'block';
        document.getElementById('processBtn').disabled = false;
        document.getElementById('saveInvoiceBtn').style.display = 'none';
        currentInvoiceFile = null;
        currentOcrText = '';

        showDashboard();

      } catch (error) {
        console.error('Error saving invoice:', error);
        alert('Error saving invoice: ' + error.message);
      }
    }

    // Load items from database
    async function loadItems(category = '') {
      const itemsList = document.getElementById('itemsList');
      itemsList.innerHTML = '<p style="text-align: center; color: var(--gray-500); padding: 40px 0;">Loading items...</p>';

      try {
        let query = supabase
          .from('inventory_items')
          .select('*')
          .order('category', { ascending: true })
          .order('item_name', { ascending: true });

        if (category) {
          query = query.eq('category', category);
        }

        const { data, error } = await query;

        if (error) throw error;

        if (!data || data.length === 0) {
          itemsList.innerHTML = '<p style="text-align: center; color: var(--gray-500); padding: 40px 0;">No items found. Click "Add New Item" to get started.</p>';
          return;
        }

        let html = '<table class="items-table"><thead><tr>';
        html += '<th>Item</th><th>Category</th><th>Unit</th><th>Par</th><th>Cost</th><th>Actions</th>';
        html += '</tr></thead><tbody>';

        data.forEach(item => {
          html += `<tr>
            <td><strong>${item.item_name}</strong></td>
            <td><span style="font-size: 10px; padding: 4px 8px; background: var(--light-blue);">${item.category}</span></td>
            <td>${item.unit}</td>
            <td>${item.par_level || '-'}</td>
            <td>$${item.current_cost ? item.current_cost.toFixed(2) : '-'}</td>
            <td>
              <button class="btn-small btn-edit" onclick="editItem(${item.id})">Edit</button>
              <button class="btn-small btn-delete" onclick="deleteItem(${item.id})">Delete</button>
            </td>
          </tr>`;
        });

        html += '</tbody></table>';
        itemsList.innerHTML = html;

      } catch (error) {
        console.error('Error loading items:', error);
        itemsList.innerHTML = `<p style="text-align: center; color: var(--error); padding: 40px 0;">Error loading items: ${error.message}</p>`;
      }
    }

    function filterItems() {
      const category = document.getElementById('categoryFilter').value;
      loadItems(category);
    }

    async function saveItem() {
      const name = document.getElementById('itemName').value.trim();
      const category = document.getElementById('itemCategory').value;
      const unit = document.getElementById('itemUnit').value.trim();
      const parLevel = parseFloat(document.getElementById('itemParLevel').value) || null;
      const cost = parseFloat(document.getElementById('itemCost').value) || null;
      const vendor = document.getElementById('itemVendor').value.trim() || null;
      const barcode = document.getElementById('itemBarcode').value.trim() || null;
      const frequency = document.getElementById('itemFrequency').value;

      if (!name || !category || !unit) {
        alert('Please fill in all required fields (Item Name, Category, Unit)');
        return;
      }

      try {
        const itemData = {
          item_name: name,
          category: category,
          unit: unit,
          par_level: parLevel,
          current_cost: cost,
          vendor_name: vendor,
          barcode: barcode,
          count_frequency: frequency,
          last_updated: new Date().toISOString()
        };

        let result;
        if (currentEditingId) {
          result = await supabase
            .from('inventory_items')
            .update(itemData)
            .eq('id', currentEditingId);
        } else {
          itemData.created_at = new Date().toISOString();
          result = await supabase
            .from('inventory_items')
            .insert([itemData]);
        }

        if (result.error) throw result.error;

        alert(currentEditingId ? 'Item updated successfully!' : 'Item added successfully!');
        currentEditingId = null;
        showManageItems();

      } catch (error) {
        console.error('Error saving item:', error);
        alert('Error saving item: ' + error.message);
      }
    }

    async function editItem(id) {
      try {
        const { data, error } = await supabase
          .from('inventory_items')
          .select('*')
          .eq('id', id)
          .single();

        if (error) throw error;

        currentEditingId = id;
        document.getElementById('itemFormTitle').textContent = 'Edit Item';
        document.getElementById('itemName').value = data.item_name;
        document.getElementById('itemCategory').value = data.category;
        document.getElementById('itemUnit').value = data.unit;
        document.getElementById('itemParLevel').value = data.par_level || '';
        document.getElementById('itemCost').value = data.current_cost || '';
        document.getElementById('itemVendor').value = data.vendor_name || '';
        document.getElementById('itemBarcode').value = data.barcode || '';
        document.getElementById('itemFrequency').value = data.count_frequency || 'weekly';

        document.getElementById('dashboard').style.display = 'none';
        document.getElementById('manageItems').style.display = 'none';
        document.getElementById('itemForm').style.display = 'block';

      } catch (error) {
        console.error('Error loading item:', error);
        alert('Error loading item: ' + error.message);
      }
    }

    async function deleteItem(id) {
      if (!confirm('Are you sure you want to delete this item?')) {
        return;
      }

      try {
        const { error } = await supabase
          .from('inventory_items')
          .delete()
          .eq('id', id);

        if (error) throw error;

        alert('Item deleted successfully!');
        loadItems();

      } catch (error) {
        console.error('Error deleting item:', error);
        alert('Error deleting item: ' + error.message);
      }
    }
  </script>
</body>
</html>
