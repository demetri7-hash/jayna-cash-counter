<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, viewport-fit=cover">
  <title>Jayna Gyro - COGs Management</title>

  <link rel="apple-touch-icon" href="https://static.spotapps.co/website_images/ab_websites/229800_website_v1/logo.png">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#00A8E1">

  <style>
    /* Jayna Brand Design - Sky Blue & Grayscale */
    :root {
      --primary-blue: #00A8E1;
      --secondary-blue: #0094D6;
      --light-blue: #E3F4FC;
      --accent-blue: #0081C6;
      --gray-900: #212121;
      --gray-700: #424242;
      --gray-500: #757575;
      --gray-400: #BDBDBD;
      --gray-300: #E0E0E0;
      --gray-100: #F5F5F5;
      --dark-gray: #616161;
      --success: #00C853;
      --warning: #FFB300;
      --error: #D32F2F;
      --white: #FFFFFF;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body {
      font-family: 'Aptos', 'Segoe UI Variable', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      background: var(--gray-100);
      min-height: 100vh;
      padding: 0;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
      background: var(--white);
      min-height: 100vh;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }
    .header {
      background: var(--white);
      color: var(--gray-900);
      text-align: center;
      padding: 12px;
      border-bottom: 1px solid var(--gray-300);
    }
    .header h1 { font-size: 18px; font-weight: 700; margin-bottom: 2px; letter-spacing: 1.5px; text-transform: uppercase; }
    .header p { opacity: 0.7; font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }

    .content { padding: 12px; }

    /* Navigation Buttons */
    .main-menu {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 8px;
      margin-bottom: 16px;
    }
    .menu-btn {
      padding: 16px 12px;
      border: 2px solid var(--gray-300);
      background: var(--gray-100);
      font-size: 11px;
      font-weight: 700;
      color: var(--gray-900);
      cursor: pointer;
      text-align: center;
      min-height: 50px;
      text-transform: uppercase;
      letter-spacing: 1.2px;
    }
    .menu-btn:hover { background: var(--gray-300); }
    .menu-btn.primary { background: var(--white); }
    .menu-btn.cogs {
      background: var(--dark-gray);
      color: var(--white);
      border-color: var(--dark-gray);
    }

    /* Quick Actions Grid */
    .quick-actions {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 20px;
    }
    .action-btn {
      padding: 24px 16px;
      background: var(--white);
      border: 2px solid var(--gray-300);
      cursor: pointer;
      text-align: center;
    }
    .action-btn:hover {
      border-color: var(--primary-blue);
      background: var(--light-blue);
    }
    .action-btn .icon { font-size: 32px; margin-bottom: 8px; }
    .action-btn .label {
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--gray-700);
    }

    /* Summary Card */
    .summary-card {
      background: var(--white);
      border: 2px solid var(--gray-300);
      padding: 20px;
    }
    .summary-card h3 {
      font-size: 14px;
      font-weight: 700;
      color: var(--gray-700);
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .summary-stat {
      display: flex;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid var(--gray-300);
    }
    .summary-stat:last-child { border-bottom: none; }
    .stat-label {
      font-size: 12px;
      color: var(--gray-500);
      text-transform: uppercase;
    }
    .stat-value {
      font-size: 18px;
      font-weight: 700;
      color: var(--gray-900);
    }
    .stat-value.good { color: var(--success); }
    .stat-value.warning { color: var(--warning); }

    /* Forms */
    .form-group { margin-bottom: 12px; }
    .form-group label {
      display: block;
      margin-bottom: 4px;
      font-weight: 700;
      font-size: 10px;
      color: var(--gray-700);
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .form-input, .form-select {
      width: 100%;
      padding: 12px 14px;
      border: 1px solid var(--gray-300);
      font-size: 14px;
      min-height: 44px;
      background: var(--white);
      color: var(--gray-900);
    }
    .form-input:focus, .form-select:focus {
      outline: none;
      border-color: var(--primary-blue);
      box-shadow: 0 0 0 2px rgba(0, 168, 225, 0.15);
    }
    .submit-btn {
      width: 100%;
      padding: 14px;
      background: var(--gray-100);
      color: var(--gray-900);
      border: none;
      font-size: 12px;
      font-weight: 700;
      cursor: pointer;
      margin-top: 12px;
      min-height: 44px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .submit-btn:hover { background: var(--gray-300); }
    .submit-btn.primary {
      background: var(--primary-blue);
      color: var(--white);
    }
    .submit-btn.primary:hover { background: var(--secondary-blue); }

    /* Items Table */
    .items-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 16px;
    }
    .items-table th {
      background: var(--gray-100);
      padding: 12px;
      text-align: left;
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--gray-700);
      border-bottom: 2px solid var(--gray-300);
    }
    .items-table td {
      padding: 12px;
      border-bottom: 1px solid var(--gray-300);
      font-size: 12px;
    }
    .items-table tr:hover { background: var(--light-blue); }
    .btn-small {
      padding: 6px 12px;
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      border: none;
      cursor: pointer;
      margin-right: 4px;
    }
    .btn-edit {
      background: var(--primary-blue);
      color: var(--white);
    }
    .btn-delete {
      background: var(--error);
      color: var(--white);
    }

    /* Spinner */
    .spinner {
      border: 3px solid var(--gray-300);
      border-top: 3px solid var(--primary-blue);
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @media (max-width: 768px) {
      .main-menu { grid-template-columns: 1fr 1fr; }
      .quick-actions { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>JAYNA GYRO</h1>
      <p>COST OF GOODS MANAGEMENT</p>
    </div>

    <div class="content">
      <!-- Navigation Buttons -->
      <div class="main-menu">
        <button class="menu-btn primary" onclick="window.location.href='index.html'">AM Count</button>
        <button class="menu-btn primary" onclick="window.location.href='index.html'">PM Close</button>
        <button class="menu-btn" onclick="window.location.href='index.html'">Generate Report</button>
        <button class="menu-btn" onclick="window.location.href='index.html'">Tip Pool</button>
        <button class="menu-btn" onclick="window.location.href='index.html'">Weekly Cashbox</button>
        <button class="menu-btn" onclick="window.location.href='manager.html'">Manager</button>
        <button class="menu-btn cogs">COGs</button>
      </div>

      <!-- Dashboard (default view) -->
      <div id="dashboard">
        <h2 style="margin-bottom: 20px; color: var(--gray-900); font-size: 18px; text-transform: uppercase;">Cost of Goods Sold</h2>

        <div class="quick-actions">
          <div class="action-btn" onclick="showManageItems()">
            <div class="icon">üè∑Ô∏è</div>
            <div class="label">Manage Items</div>
          </div>
          <div class="action-btn" onclick="showScanInvoice()">
            <div class="icon">üì∏</div>
            <div class="label">Scan Invoice</div>
          </div>
          <div class="action-btn" onclick="alert('Coming in Day 3: Camera-assisted counting')">
            <div class="icon">üì¶</div>
            <div class="label">Daily Count</div>
          </div>
          <div class="action-btn" onclick="showReports()">
            <div class="icon">üìä</div>
            <div class="label">View Reports</div>
          </div>
        </div>

        <!-- Order Alerts Card -->
        <div class="summary-card" style="margin-bottom: 16px; border: 2px solid var(--primary-blue);">
          <h3>üìã Order Alerts Today</h3>
          <div id="orderAlertsToday">
            <p style="text-align: center; color: var(--gray-500); padding: 20px;">Loading order alerts...</p>
          </div>
        </div>

        <!-- Summary Card -->
        <div class="summary-card">
          <h3>This Week Summary</h3>
          <div class="summary-stat">
            <span class="stat-label">Food Cost %</span>
            <span class="stat-value good">28.5%</span>
          </div>
          <div class="summary-stat">
            <span class="stat-label">COGs Total</span>
            <span class="stat-value">$12,450.00</span>
          </div>
          <div class="summary-stat">
            <span class="stat-label">Variance</span>
            <span class="stat-value warning">-$127.00</span>
          </div>
        </div>
      </div>

      <!-- Manage Items Section -->
      <div id="manageItems" style="display: none;">
        <h2 style="margin-bottom: 20px; color: var(--gray-900); font-size: 18px; text-transform: uppercase;">Inventory Items</h2>

        <button class="submit-btn primary" onclick="showAddItemForm()">+ Add New Item</button>

        <div class="form-group" style="margin-top: 16px;">
          <label for="categoryFilter">Filter by Category:</label>
          <select id="categoryFilter" class="form-select" onchange="filterItems()">
            <option value="">All Categories</option>
            <option value="PRODUCE">Produce</option>
            <option value="MEAT">Meat</option>
            <option value="GYROS">Gyros</option>
            <option value="BREADS">Breads</option>
            <option value="LIQUOR">Liquor</option>
            <option value="BEER">Beer</option>
            <option value="WINE">Wine</option>
            <option value="DAIRY">Dairy</option>
            <option value="NA DRINKS">NA Drinks</option>
            <option value="JUICES">Juices</option>
          </select>
        </div>

        <div id="itemsList" style="margin-top: 20px;">
          <p style="text-align: center; color: var(--gray-500); padding: 40px 0;">Loading items...</p>
        </div>

        <button class="submit-btn" onclick="showDashboard()">Back to Dashboard</button>
      </div>

      <!-- Add/Edit Item Form -->
      <div id="itemForm" style="display: none;">
        <h2 style="margin-bottom: 20px; color: var(--gray-900); font-size: 18px; text-transform: uppercase;" id="itemFormTitle">Add New Item</h2>

        <div class="form-group">
          <label for="itemName">Item Name*</label>
          <input type="text" id="itemName" class="form-input" required placeholder="e.g., Ground Beef 80/20">
        </div>

        <div class="form-group">
          <label for="itemCategory">Category*</label>
          <select id="itemCategory" class="form-select" required>
            <option value="">Select Category</option>
            <option value="PRODUCE">Produce</option>
            <option value="MEAT">Meat</option>
            <option value="GYROS">Gyros</option>
            <option value="BREADS">Breads</option>
            <option value="LIQUOR">Liquor</option>
            <option value="BEER">Beer</option>
            <option value="WINE">Wine</option>
            <option value="DAIRY">Dairy</option>
            <option value="NA DRINKS">NA Drinks</option>
            <option value="JUICES">Juices</option>
          </select>
        </div>

        <div class="form-group">
          <label for="itemUnit">Unit*</label>
          <input type="text" id="itemUnit" class="form-input" required placeholder="e.g., lb, case, each, oz, gal">
        </div>

        <div class="form-group">
          <label for="itemParLevel">Par Level</label>
          <input type="number" id="itemParLevel" class="form-input" step="0.01" placeholder="Ideal stock level">
        </div>

        <div class="form-group">
          <label for="itemCost">Current Cost per Unit</label>
          <input type="number" id="itemCost" class="form-input" step="0.01" placeholder="e.g., 5.99">
        </div>

        <div class="form-group">
          <label for="itemVendor">Primary Vendor</label>
          <input type="text" id="itemVendor" class="form-input" placeholder="e.g., Sysco Sacramento">
        </div>

        <div class="form-group">
          <label for="itemBarcode">Barcode/UPC (Optional)</label>
          <input type="text" id="itemBarcode" class="form-input" placeholder="For scanning beer/drinks">
        </div>

        <div class="form-group">
          <label for="itemFrequency">Count Frequency</label>
          <select id="itemFrequency" class="form-select">
            <option value="daily">Daily</option>
            <option value="weekly" selected>Weekly</option>
            <option value="monthly">Monthly</option>
          </select>
        </div>

        <button class="submit-btn primary" onclick="saveItem()">Save Item</button>
        <button class="submit-btn" onclick="showManageItems()">Cancel</button>
      </div>

      <!-- Scan Invoice Section -->
      <div id="scanInvoice" style="display: none;">
        <h2 style="margin-bottom: 20px; color: var(--gray-900); font-size: 18px; text-transform: uppercase;">Scan Invoice</h2>

        <p style="margin-bottom: 16px; padding: 12px; background: var(--light-blue); border-left: 3px solid var(--primary-blue); font-size: 12px;">
          üìÑ Upload your invoices (photo or PDF). The system will automatically detect vendors from each page.
        </p>

        <!-- File Upload -->
        <div class="form-group">
          <label for="invoiceFile">Upload Invoice (Photo or PDF)*</label>
          <input type="file" id="invoiceFile" class="form-input" accept="image/*,application/pdf" capture="environment">
          <p style="font-size: 11px; color: var(--gray-500); margin-top: 4px;">Supported: Photos (JPG, PNG) or PDF files with multiple invoices</p>
        </div>

        <!-- Invoice Preview -->
        <div id="invoicePreview" style="display: none; margin-top: 16px;">
          <img id="previewImage" style="width: 100%; max-height: 400px; object-fit: contain; border: 2px solid var(--gray-300);">
        </div>

        <!-- OCR Processing Status -->
        <div id="ocrStatus" style="display: none; margin-top: 16px; padding: 16px; background: var(--light-blue); border: 2px solid var(--primary-blue);">
          <div style="display: flex; align-items: center; gap: 12px;">
            <div class="spinner"></div>
            <div>
              <strong>Processing Invoice...</strong>
              <p id="ocrProgress" style="font-size: 12px; color: var(--gray-700); margin-top: 4px;">Initializing OCR...</p>
            </div>
          </div>
        </div>

        <!-- Extracted Data Review -->
        <div id="extractedData" style="display: none; margin-top: 20px;">
          <h3 style="font-size: 14px; font-weight: 700; margin-bottom: 12px; color: var(--success);">‚úì Invoice Extracted</h3>

          <div class="form-group">
            <label for="extractedVendor">Vendor Name</label>
            <input type="text" id="extractedVendor" class="form-input" placeholder="Auto-detected vendor">
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <div class="form-group">
              <label for="extractedDate">Invoice Date</label>
              <input type="date" id="extractedDate" class="form-input">
            </div>
            <div class="form-group">
              <label for="extractedInvoiceNumber">Invoice #</label>
              <input type="text" id="extractedInvoiceNumber" class="form-input" placeholder="Invoice number">
            </div>
          </div>

          <div class="form-group">
            <label for="extractedTotal">Total Amount</label>
            <input type="number" id="extractedTotal" class="form-input" step="0.01" placeholder="0.00">
          </div>

          <!-- Extracted Items Table -->
          <div class="form-group">
            <label>Extracted Items</label>
            <div id="extractedItemsList" style="margin-top: 8px; max-height: 300px; overflow-y: auto; border: 2px solid var(--gray-300); padding: 12px;">
              <p style="text-align: center; color: var(--gray-500);">No items extracted yet</p>
            </div>
          </div>

          <!-- Raw OCR Text (for debugging) -->
          <details style="margin-top: 16px;">
            <summary style="cursor: pointer; font-size: 12px; color: var(--gray-500);">View Raw OCR Text</summary>
            <textarea id="rawOcrText" readonly style="width: 100%; min-height: 200px; margin-top: 8px; font-family: monospace; font-size: 11px; padding: 12px; border: 1px solid var(--gray-300);"></textarea>
          </details>
        </div>

        <div style="margin-top: 20px;">
          <button class="submit-btn primary" onclick="processInvoice()" id="processBtn">Process Invoice</button>
          <button class="submit-btn primary" onclick="saveInvoice()" id="saveInvoiceBtn" style="display: none;">Save to Database</button>
          <button class="submit-btn" onclick="downloadDebugPDF()" id="debugPdfBtn" style="display: none; background: var(--warning);">üìÑ Download Debug PDF</button>
          <button class="submit-btn" onclick="showDashboard()">Cancel</button>
        </div>
      </div>

      <!-- Reports Section -->
      <div id="reportsView" style="display: none;">
        <h2 style="margin-bottom: 20px; color: var(--gray-900); font-size: 18px; text-transform: uppercase;">Invoice Analysis & Reports</h2>

        <!-- Date Range Filter -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
          <div class="form-group">
            <label for="reportStartDate">From</label>
            <input type="date" id="reportStartDate" class="form-input">
          </div>
          <div class="form-group">
            <label for="reportEndDate">To</label>
            <input type="date" id="reportEndDate" class="form-input">
          </div>
        </div>

        <button class="submit-btn primary" onclick="loadReports()">Generate Report</button>

        <!-- Report Results -->
        <div id="reportResults" style="display: none; margin-top: 20px;">
          <!-- Spending Overview -->
          <div class="summary-card" style="margin-bottom: 16px;">
            <h3>Spending Overview</h3>
            <div id="spendingOverview"></div>
          </div>

          <!-- Vendor Breakdown -->
          <div class="summary-card" style="margin-bottom: 16px;">
            <h3>Vendor Breakdown</h3>
            <div id="vendorBreakdown"></div>
          </div>

          <!-- Ordering Frequency -->
          <div class="summary-card" style="margin-bottom: 16px;">
            <h3>Ordering Frequency</h3>
            <div id="orderingFrequency"></div>
          </div>

          <!-- Suggested Orders -->
          <div class="summary-card">
            <h3>Suggested Orders (Based on Par Levels)</h3>
            <div id="suggestedOrders"></div>
          </div>
        </div>

        <button class="submit-btn" onclick="showDashboard()" style="margin-top: 16px;">Back to Dashboard</button>
      </div>
    </div>
  </div>

  <!-- Add Vendor Modal -->
  <div id="addVendorModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 1000; overflow-y: auto;">
    <div style="max-width: 500px; margin: 40px auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);">
      <h3 style="margin-bottom: 16px; color: var(--gray-900); font-size: 16px;">Add New Vendor</h3>

      <div class="form-group">
        <label for="newVendorName">Vendor Name*</label>
        <input type="text" id="newVendorName" class="form-input" readonly style="background: var(--gray-100);">
      </div>

      <div class="form-group">
        <label>Order Days (Select all that apply)</label>
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 8px;">
          <label style="display: flex; align-items: center; gap: 4px; font-size: 12px;">
            <input type="checkbox" id="orderDay_Monday" value="Monday"> Monday
          </label>
          <label style="display: flex; align-items: center; gap: 4px; font-size: 12px;">
            <input type="checkbox" id="orderDay_Tuesday" value="Tuesday"> Tuesday
          </label>
          <label style="display: flex; align-items: center; gap: 4px; font-size: 12px;">
            <input type="checkbox" id="orderDay_Wednesday" value="Wednesday"> Wednesday
          </label>
          <label style="display: flex; align-items: center; gap: 4px; font-size: 12px;">
            <input type="checkbox" id="orderDay_Thursday" value="Thursday"> Thursday
          </label>
          <label style="display: flex; align-items: center; gap: 4px; font-size: 12px;">
            <input type="checkbox" id="orderDay_Friday" value="Friday"> Friday
          </label>
          <label style="display: flex; align-items: center; gap: 4px; font-size: 12px;">
            <input type="checkbox" id="orderDay_Saturday" value="Saturday"> Saturday
          </label>
        </div>
      </div>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
        <div class="form-group">
          <label for="newVendorCutoffTime">Order Cutoff Time</label>
          <input type="text" id="newVendorCutoffTime" class="form-input" placeholder="e.g., 3:00 PM">
        </div>
        <div class="form-group">
          <label for="newVendorMethod">Order Method*</label>
          <select id="newVendorMethod" class="form-select">
            <option value="">Select...</option>
            <option value="text">Text</option>
            <option value="online">Online</option>
            <option value="phone">Phone</option>
            <option value="email">Email</option>
          </select>
        </div>
      </div>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
        <div class="form-group">
          <label for="newVendorRepName">Rep Name</label>
          <input type="text" id="newVendorRepName" class="form-input" placeholder="Contact person">
        </div>
        <div class="form-group">
          <label for="newVendorRepPhone">Rep Phone</label>
          <input type="tel" id="newVendorRepPhone" class="form-input" placeholder="(555) 555-5555">
        </div>
      </div>

      <div class="form-group">
        <label for="newVendorNotes">Special Notes</label>
        <textarea id="newVendorNotes" class="form-input" rows="3" placeholder="Any special ordering instructions, delivery notes, etc."></textarea>
      </div>

      <div style="display: flex; gap: 8px; margin-top: 20px;">
        <button class="submit-btn primary" onclick="saveNewVendor()" style="flex: 1;">Save Vendor</button>
        <button class="submit-btn" onclick="closeAddVendorModal()" style="flex: 1;">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Template Mapper Modal -->
  <div id="templateMapperModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); z-index: 1000; overflow-y: auto;">
    <div style="max-width: 800px; margin: 20px auto; background: white; border-radius: 8px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);">
      <div style="background: var(--primary-blue); color: white; padding: 16px; border-radius: 8px 8px 0 0;">
        <h3 style="margin: 0; font-size: 18px;">üìç Map Invoice Fields - <span id="mapperVendorName"></span></h3>
        <p style="margin: 4px 0 0 0; font-size: 12px; opacity: 0.9;">Select text to teach the system where to find data</p>
      </div>

      <div style="padding: 20px;">
        <!-- Step indicator -->
        <div id="mapperSteps" style="margin-bottom: 20px;">
          <div style="display: flex; gap: 12px; align-items: center; justify-content: center;">
            <button id="stepBtn_invoice_number" class="mapper-step-btn active" onclick="setMappingField('invoice_number')">
              1. Invoice #
            </button>
            <button id="stepBtn_invoice_date" class="mapper-step-btn" onclick="setMappingField('invoice_date')">
              2. Date
            </button>
            <button id="stepBtn_total_amount" class="mapper-step-btn" onclick="setMappingField('total_amount')">
              3. Total
            </button>
            <button id="stepBtn_line_items" class="mapper-step-btn" onclick="setMappingField('line_items')">
              4. Line Items
            </button>
          </div>
        </div>

        <!-- Current field indicator -->
        <div id="currentFieldIndicator" style="padding: 12px; background: var(--light-blue); border-left: 4px solid var(--primary-blue); margin-bottom: 16px;">
          <strong>Mapping: <span id="currentFieldName">Invoice Number</span></strong>
          <p id="currentFieldHelp" style="margin: 4px 0 0 0; font-size: 12px; color: var(--gray-700);">
            Select the invoice number in the text below
          </p>
        </div>

        <!-- OCR Text Display (selectable) -->
        <div style="border: 2px solid var(--gray-300); border-radius: 4px; background: var(--gray-100); max-height: 400px; overflow-y: auto; padding: 16px; margin-bottom: 16px;">
          <pre id="mapperOcrText" style="font-family: 'Courier New', monospace; font-size: 11px; line-height: 1.6; margin: 0; white-space: pre-wrap; user-select: text; cursor: text;"></pre>
        </div>

        <!-- Selected text preview -->
        <div id="selectedTextPreview" style="display: none; padding: 12px; background: var(--success); color: white; border-radius: 4px; margin-bottom: 16px;">
          <strong>Selected:</strong> <span id="selectedTextValue"></span>
          <button onclick="confirmSelection()" style="margin-left: 12px; background: white; color: var(--success); border: none; padding: 4px 12px; cursor: pointer; font-weight: bold; border-radius: 3px;">
            ‚úì Confirm
          </button>
        </div>

        <!-- Mapped fields summary -->
        <div id="mappedFieldsSummary" style="padding: 12px; background: var(--gray-100); border-radius: 4px; margin-bottom: 16px; font-size: 12px;">
          <strong>Mapped Fields:</strong>
          <div id="mappedFieldsList" style="margin-top: 8px;">
            <em style="color: var(--gray-500);">No fields mapped yet</em>
          </div>
        </div>

        <!-- Action buttons -->
        <div style="display: flex; gap: 8px;">
          <button class="submit-btn primary" onclick="saveTemplate()" style="flex: 1;">
            üíæ Save Template
          </button>
          <button class="submit-btn" onclick="closeTemplateMapper()" style="flex: 1;">
            Cancel
          </button>
        </div>
      </div>
    </div>
  </div>

  <style>
    .mapper-step-btn {
      padding: 8px 16px;
      background: var(--gray-300);
      border: 2px solid var(--gray-400);
      color: var(--gray-700);
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      border-radius: 4px;
      transition: all 0.2s;
    }
    .mapper-step-btn.active {
      background: var(--primary-blue);
      border-color: var(--primary-blue);
      color: white;
    }
    .mapper-step-btn.completed {
      background: var(--success);
      border-color: var(--success);
      color: white;
    }
    .mapper-step-btn:hover {
      opacity: 0.9;
    }
    #mapperOcrText::selection {
      background: #FFC107;
      color: black;
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    // Configure PDF.js
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js';
  </script>

  <script>
    // Supabase
    const SUPABASE_URL = 'https://gaawtbqpnnbbnsyswqwv.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdhYXd0YnFwbm5iYm5zeXN3cXd2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1MDE1NTAsImV4cCI6MjA3MjA3NzU1MH0.F-y7AIQTWaUe7DRT4OnIZVn94mhXxfhpBbng2aJ8nXg';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let currentEditingId = null;
    let currentInvoiceIndexForVendor = null; // Track which invoice is adding a vendor

    // Simple navigation
    function showDashboard() {
      document.getElementById('dashboard').style.display = 'block';
      document.getElementById('manageItems').style.display = 'none';
      document.getElementById('itemForm').style.display = 'none';
      document.getElementById('scanInvoice').style.display = 'none';
      document.getElementById('reportsView').style.display = 'none';

      // Load order alerts
      loadOrderAlerts();
    }

    function showReports() {
      document.getElementById('dashboard').style.display = 'none';
      document.getElementById('manageItems').style.display = 'none';
      document.getElementById('itemForm').style.display = 'none';
      document.getElementById('scanInvoice').style.display = 'none';
      document.getElementById('reportsView').style.display = 'block';

      // Set default date range (last 30 days)
      const endDate = new Date();
      const startDate = new Date();
      startDate.setDate(startDate.getDate() - 30);

      document.getElementById('reportEndDate').value = endDate.toISOString().split('T')[0];
      document.getElementById('reportStartDate').value = startDate.toISOString().split('T')[0];
    }

    async function loadReports() {
      const startDate = document.getElementById('reportStartDate').value;
      const endDate = document.getElementById('reportEndDate').value;

      if (!startDate || !endDate) {
        alert('Please select date range');
        return;
      }

      try {
        // Call invoice analysis API
        const response = await fetch('/api/analyze-invoices', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ startDate, endDate })
        });

        const data = await response.json();

        if (!data.success) throw new Error('Failed to load report');

        // Display results
        displaySpendingOverview(data.analysis);
        displayVendorBreakdown(data.analysis);
        displayOrderingFrequency(data.analysis);
        displaySuggestedOrders(data.suggestions);

        document.getElementById('reportResults').style.display = 'block';

      } catch (error) {
        console.error('Error loading reports:', error);
        alert('Error loading reports: ' + error.message);
      }
    }

    function displaySpendingOverview(analysis) {
      const container = document.getElementById('spendingOverview');

      const html = `
        <div class="summary-stat">
          <span class="stat-label">Total Invoices</span>
          <span class="stat-value">${analysis.totalInvoices}</span>
        </div>
        <div class="summary-stat">
          <span class="stat-label">Total Spent</span>
          <span class="stat-value">$${analysis.totalSpent.toFixed(2)}</span>
        </div>
        <div class="summary-stat">
          <span class="stat-label">Average Invoice</span>
          <span class="stat-value">$${analysis.averageInvoiceAmount.toFixed(2)}</span>
        </div>
        <div class="summary-stat">
          <span class="stat-label">Date Range</span>
          <span class="stat-value" style="font-size: 12px;">${analysis.dateRange.start} to ${analysis.dateRange.end}</span>
        </div>
      `;

      container.innerHTML = html;
    }

    function displayVendorBreakdown(analysis) {
      const container = document.getElementById('vendorBreakdown');

      let html = '<table class="items-table" style="font-size: 12px;"><thead><tr>';
      html += '<th>Vendor</th><th>Orders</th><th>Total</th><th>Avg</th></tr></thead><tbody>';

      Object.keys(analysis.vendorBreakdown).forEach(vendor => {
        const data = analysis.vendorBreakdown[vendor];
        const avg = data.totalSpent / data.count;

        html += `<tr>
          <td><strong>${vendor}</strong></td>
          <td>${data.count}</td>
          <td>$${data.totalSpent.toFixed(2)}</td>
          <td>$${avg.toFixed(2)}</td>
        </tr>`;
      });

      html += '</tbody></table>';
      container.innerHTML = html;
    }

    function displayOrderingFrequency(analysis) {
      const container = document.getElementById('orderingFrequency');

      if (!analysis.frequencyByVendor || Object.keys(analysis.frequencyByVendor).length === 0) {
        container.innerHTML = '<p style="text-align: center; color: var(--gray-500);">Not enough data to calculate frequency</p>';
        return;
      }

      let html = '<table class="items-table" style="font-size: 12px;"><thead><tr>';
      html += '<th>Vendor</th><th>Avg Days Between Orders</th><th>Total Orders</th></tr></thead><tbody>';

      Object.keys(analysis.frequencyByVendor).forEach(vendor => {
        const freq = analysis.frequencyByVendor[vendor];

        html += `<tr>
          <td><strong>${vendor}</strong></td>
          <td>${freq.averageDaysBetweenOrders} days</td>
          <td>${freq.orderCount}</td>
        </tr>`;
      });

      html += '</tbody></table>';
      container.innerHTML = html;
    }

    function displaySuggestedOrders(suggestions) {
      const container = document.getElementById('suggestedOrders');

      if (!suggestions || suggestions.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: var(--gray-500);">No suggestions available. Set par levels for items.</p>';
        return;
      }

      // Filter to only show items that need ordering
      const needsOrder = suggestions.filter(s => s.suggestedOrderQty > 0);

      if (needsOrder.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: var(--success);">‚úì All items at or above par level</p>';
        return;
      }

      let html = '<table class="items-table" style="font-size: 11px;"><thead><tr>';
      html += '<th>Item</th><th>Current</th><th>Par</th><th>Order Qty</th><th>Urgency</th></tr></thead><tbody>';

      needsOrder.forEach(item => {
        const urgencyColor = item.urgency === 'critical' ? 'var(--error)' :
                            item.urgency === 'high' ? 'var(--warning)' :
                            'var(--gray-500)';

        html += `<tr>
          <td><strong>${item.itemName}</strong><br><span style="font-size: 10px; color: var(--gray-500);">${item.category}</span></td>
          <td>${item.currentStock}</td>
          <td>${item.parLevel}</td>
          <td><strong>${item.suggestedOrderQty}</strong></td>
          <td><span style="color: ${urgencyColor}; font-weight: bold;">${item.urgency.toUpperCase()}</span></td>
        </tr>`;
      });

      html += '</tbody></table>';
      container.innerHTML = html;
    }

    async function loadOrderAlerts() {
      try {
        const response = await fetch('/api/get-order-alerts');
        const data = await response.json();

        if (!data.success) throw new Error('Failed to load alerts');

        const container = document.getElementById('orderAlertsToday');

        if (!data.todayAlerts || data.todayAlerts.length === 0) {
          container.innerHTML = `
            <p style="text-align: center; color: var(--success); padding: 20px;">
              ‚úì No orders due today
            </p>
          `;
          return;
        }

        let html = '';
        data.todayAlerts.forEach(alert => {
          const urgencyColor = alert.priority === 'high' ? 'var(--error)' :
                               alert.priority === 'normal' ? 'var(--warning)' :
                               'var(--gray-500)';

          const timeWarning = alert.timeUntilCutoff !== null && alert.timeUntilCutoff < 2 ?
            ` ‚ö†Ô∏è ${Math.floor(alert.timeUntilCutoff * 60)}min left!` : '';

          html += `
            <div style="padding: 12px; border-bottom: 1px solid var(--gray-300); background: ${alert.priority === 'high' ? 'var(--light-blue)' : 'transparent'};">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <strong style="color: ${urgencyColor};">${alert.vendorName}</strong>
                  <p style="font-size: 11px; color: var(--gray-600); margin-top: 2px;">
                    ${alert.orderMethod === 'text' ? 'üì± Text' : alert.orderMethod === 'online' ? 'üåê Online' : 'üìû Phone'}
                    ‚Ä¢ Cutoff: ${alert.cutoffTime}${timeWarning}
                  </p>
                  ${alert.specialNotes ? `<p style="font-size: 10px; color: var(--gray-500); margin-top: 4px;">${alert.specialNotes}</p>` : ''}
                </div>
                <button onclick="startOrder('${alert.vendorName}', ${alert.vendorId})"
                        style="padding: 6px 12px; background: var(--primary-blue); color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer;">
                  Order
                </button>
              </div>
            </div>
          `;
        });

        // Add upcoming orders
        if (data.upcomingAlerts && data.upcomingAlerts.length > 0) {
          html += '<div style="margin-top: 12px; padding-top: 12px; border-top: 2px solid var(--gray-300);"><strong style="font-size: 12px; color: var(--gray-600);">Upcoming:</strong></div>';

          const upcomingByDay = {};
          data.upcomingAlerts.forEach(alert => {
            if (!upcomingByDay[alert.dayName]) {
              upcomingByDay[alert.dayName] = [];
            }
            upcomingByDay[alert.dayName].push(alert);
          });

          Object.keys(upcomingByDay).forEach(day => {
            const vendors = upcomingByDay[day].map(a => a.vendorName).join(', ');
            html += `<p style="font-size: 11px; color: var(--gray-600); margin-top: 4px;">${day}: ${vendors}</p>`;
          });
        }

        container.innerHTML = html;

      } catch (error) {
        console.error('Error loading order alerts:', error);
        document.getElementById('orderAlertsToday').innerHTML =
          '<p style="text-align: center; color: var(--error); padding: 20px;">Error loading alerts</p>';
      }
    }

    function startOrder(vendorName, vendorId) {
      alert(`Order workflow for ${vendorName} coming soon!\n\nWill show:\n- Suggested order quantities\n- Last order history\n- Quick order form`);
      // TODO: Implement order workflow
    }

    // Load alerts on page load
    window.addEventListener('DOMContentLoaded', () => {
      if (document.getElementById('dashboard').style.display !== 'none') {
        loadOrderAlerts();
      }
    });

    function showManageItems() {
      document.getElementById('dashboard').style.display = 'none';
      document.getElementById('manageItems').style.display = 'block';
      document.getElementById('itemForm').style.display = 'none';
      loadItems();
    }

    function showAddItemForm() {
      currentEditingId = null;
      document.getElementById('itemFormTitle').textContent = 'Add New Item';
      document.getElementById('itemName').value = '';
      document.getElementById('itemCategory').value = '';
      document.getElementById('itemUnit').value = '';
      document.getElementById('itemParLevel').value = '';
      document.getElementById('itemCost').value = '';
      document.getElementById('itemVendor').value = '';
      document.getElementById('itemBarcode').value = '';
      document.getElementById('itemFrequency').value = 'weekly';

      document.getElementById('dashboard').style.display = 'none';
      document.getElementById('manageItems').style.display = 'none';
      document.getElementById('itemForm').style.display = 'block';
    }

    let knownVendors = []; // Will load from database
    let vendorTemplates = {}; // Will load from database: { vendor_id: template_object }

    async function showScanInvoice() {
      document.getElementById('dashboard').style.display = 'none';
      document.getElementById('manageItems').style.display = 'none';
      document.getElementById('itemForm').style.display = 'none';
      document.getElementById('scanInvoice').style.display = 'block';

      // Load known vendors for auto-detection
      await loadKnownVendors();
      await loadVendorTemplates();

      // Setup file input listener
      const fileInput = document.getElementById('invoiceFile');
      fileInput.removeEventListener('change', handleFileSelect); // Remove old listener
      fileInput.addEventListener('change', handleFileSelect);
    }

    async function loadKnownVendors() {
      try {
        const { data, error } = await supabase
          .from('vendors')
          .select('*')
          .eq('active', true)
          .order('vendor_name');

        if (error) throw error;

        knownVendors = data;
      } catch (error) {
        console.error('Error loading vendors:', error);
        knownVendors = [];
      }
    }

    async function loadVendorTemplates() {
      /*
        SUPABASE TABLE SCHEMA (create if not exists):

        CREATE TABLE vendor_templates (
          id BIGSERIAL PRIMARY KEY,
          vendor_id BIGINT REFERENCES vendors(id) UNIQUE,
          vendor_name TEXT NOT NULL,
          template_data JSONB NOT NULL,
          created_at TIMESTAMPTZ DEFAULT NOW(),
          updated_at TIMESTAMPTZ DEFAULT NOW()
        );
      */

      try {
        const { data, error } = await supabase
          .from('vendor_templates')
          .select('*');

        if (error) {
          // Table might not exist yet
          console.log('No vendor templates found (table may not exist yet)');
          vendorTemplates = {};
          return;
        }

        // Convert array to object keyed by vendor_id
        vendorTemplates = {};
        data.forEach(template => {
          vendorTemplates[template.vendor_id] = JSON.parse(template.template_data);
        });

        console.log(`Loaded ${data.length} vendor templates`);
      } catch (error) {
        console.error('Error loading vendor templates:', error);
        vendorTemplates = {};
      }
    }

    let currentInvoiceFile = null;
    let currentOcrText = '';
    let extractedInvoices = []; // Array to hold multiple invoices from PDF

    function handleFileSelect(event) {
      const file = event.target.files[0];
      if (!file) return;

      currentInvoiceFile = file;

      // Check if PDF
      const isPDF = file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf');

      if (isPDF) {
        // Show PDF info instead of image preview
        document.getElementById('invoicePreview').innerHTML = `
          <div style="padding: 20px; background: var(--light-blue); border: 2px solid var(--primary-blue); text-align: center;">
            <p style="font-size: 16px; font-weight: bold; color: var(--primary-blue);">üìÑ PDF Uploaded</p>
            <p style="font-size: 12px; color: var(--gray-700); margin-top: 8px;">${file.name}</p>
            <p style="font-size: 11px; color: var(--gray-600); margin-top: 4px;">Click "Process Invoice" to extract all invoices from this PDF</p>
          </div>
        `;
        document.getElementById('invoicePreview').style.display = 'block';
      } else {
        // Show image preview for photos
        const reader = new FileReader();
        reader.onload = (e) => {
          document.getElementById('previewImage').src = e.target.result;
          document.getElementById('invoicePreview').style.display = 'block';
        };
        reader.readAsDataURL(file);
      }
    }

    async function processInvoice() {
      if (!currentInvoiceFile) {
        alert('Please select an invoice file first');
        return;
      }

      try {
        // Show processing status
        document.getElementById('ocrStatus').style.display = 'block';
        document.getElementById('processBtn').disabled = true;

        const isPDF = currentInvoiceFile.type === 'application/pdf' ||
                     currentInvoiceFile.name.toLowerCase().endsWith('.pdf');

        if (isPDF) {
          await processPDFInvoices();
        } else {
          await processSingleImageInvoice();
        }

      } catch (error) {
        console.error('OCR Error:', error);
        alert('Error processing invoice: ' + error.message);
        document.getElementById('ocrStatus').style.display = 'none';
        document.getElementById('processBtn').disabled = false;
      }
    }

    async function processPDFInvoices() {
      document.getElementById('ocrProgress').textContent = 'Loading PDF...';

      // Read PDF file
      const arrayBuffer = await currentInvoiceFile.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;

      const totalPages = pdf.numPages;
      document.getElementById('ocrProgress').textContent = `Found ${totalPages} pages in PDF`;

      extractedInvoices = [];

      // Process each page
      for (let pageNum = 1; pageNum <= totalPages; pageNum++) {
        document.getElementById('ocrProgress').textContent =
          `Processing page ${pageNum} of ${totalPages}...`;

        const page = await pdf.getPage(pageNum);

        // Render page to canvas
        const scale = 2.0; // Higher scale for better OCR
        const viewport = page.getViewport({ scale });

        let canvas = document.createElement('canvas'); // Changed to 'let' for reassignment
        const context = canvas.getContext('2d');
        canvas.height = viewport.height;
        canvas.width = viewport.width;

        await page.render({
          canvasContext: context,
          viewport: viewport
        }).promise;

        // Step 1: Detect and correct skew/rotation
        document.getElementById('ocrProgress').textContent =
          `Detecting skew on page ${pageNum}...`;
        canvas = await detectAndCorrectSkew(canvas);

        // Step 2: Preprocess image for better OCR accuracy
        document.getElementById('ocrProgress').textContent =
          `Preprocessing page ${pageNum} for better accuracy...`;
        preprocessImage(canvas);

        // Step 3: Run OCR on corrected and preprocessed canvas
        document.getElementById('ocrProgress').textContent =
          `Reading text from page ${pageNum}... 0%`;

        const result = await Tesseract.recognize(
          canvas,
          'eng',
          {
            tessedit_pageseg_mode: '4', // Single column of text (best for invoices)
            tessedit_char_whitelist: '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz .,/$#-:()',
            preserve_interword_spaces: '1',
            rotate_enabled: true, // Auto-rotation detection
            logger: (m) => {
              if (m.status === 'recognizing text') {
                document.getElementById('ocrProgress').textContent =
                  `Reading text from page ${pageNum}... ${Math.round(m.progress * 100)}%`;
              }
            }
          }
        );

        const ocrText = result.data.text;

        // Save canvas as image for preview
        const pageImageUrl = canvas.toDataURL('image/jpeg', 0.7); // 70% quality to reduce size

        // Detect vendor first (to get ID for template lookup)
        const detectedVendor = detectVendorName(ocrText);

        // Parse invoice data (with template if available)
        const parsedData = parseInvoiceText(ocrText, detectedVendor.id);

        // Store invoice with page number and image
        extractedInvoices.push({
          pageNumber: pageNum,
          pageImageUrl: pageImageUrl,
          ocrText: ocrText,
          vendorName: detectedVendor.name,
          vendorId: detectedVendor.id,
          isKnownVendor: detectedVendor.isKnown,
          date: parsedData.date || '',
          invoiceNumber: parsedData.invoiceNumber || '',
          subtotal: parsedData.subtotal || 0,
          tax: parsedData.tax || 0,
          deliveryFee: parsedData.deliveryFee || 0,
          driverFee: parsedData.driverFee || 0,
          total: parsedData.total || 0,
          items: parsedData.items || []
        });
      }

      // Display all extracted invoices
      displayMultipleInvoices();

      document.getElementById('ocrStatus').style.display = 'none';
      document.getElementById('extractedData').style.display = 'block';
      document.getElementById('processBtn').style.display = 'none';
      document.getElementById('saveInvoiceBtn').style.display = 'block';
      document.getElementById('debugPdfBtn').style.display = 'block';
      document.getElementById('saveInvoiceBtn').textContent = `Save All ${extractedInvoices.length} Invoices`;
    }

    async function processSingleImageInvoice() {
      document.getElementById('ocrProgress').textContent = 'Loading image...';

      // Load image into canvas for preprocessing
      const img = new Image();
      const imageUrl = URL.createObjectURL(currentInvoiceFile);

      await new Promise((resolve, reject) => {
        img.onload = resolve;
        img.onerror = reject;
        img.src = imageUrl;
      });

      // Create canvas with high resolution
      let canvas = document.createElement('canvas'); // Changed to 'let' for reassignment
      const scale = 2.0; // Higher resolution for better OCR
      canvas.width = img.width * scale;
      canvas.height = img.height * scale;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

      URL.revokeObjectURL(imageUrl);

      // Step 1: Detect and correct skew/rotation
      document.getElementById('ocrProgress').textContent = 'Detecting skew...';
      canvas = await detectAndCorrectSkew(canvas);

      // Step 2: Preprocess image for better OCR accuracy
      document.getElementById('ocrProgress').textContent = 'Preprocessing image for better accuracy...';
      preprocessImage(canvas);

      // Step 3: Run OCR on corrected and preprocessed canvas
      document.getElementById('ocrProgress').textContent = 'Recognizing text... 0%';

      const result = await Tesseract.recognize(
        canvas,
        'eng',
        {
          tessedit_pageseg_mode: '4', // Single column of text (best for invoices)
          tessedit_char_whitelist: '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz .,/$#-:()',
          preserve_interword_spaces: '1',
          rotate_enabled: true, // Auto-rotation detection
          logger: (m) => {
            if (m.status === 'recognizing text') {
              document.getElementById('ocrProgress').textContent = `Recognizing text... ${Math.round(m.progress * 100)}%`;
            }
          }
        }
      );

      currentOcrText = result.data.text;
      document.getElementById('ocrProgress').textContent = 'Parsing invoice data...';

      // Save canvas as image for preview
      const pageImageUrl = canvas.toDataURL('image/jpeg', 0.7);

      // Detect vendor first (to get ID for template lookup)
      const detectedVendor = detectVendorName(currentOcrText);

      // Parse invoice data (with template if available)
      const parsedData = parseInvoiceText(currentOcrText, detectedVendor.id);

      extractedInvoices = [{
        pageNumber: 1,
        pageImageUrl: pageImageUrl,
        ocrText: currentOcrText,
        vendorName: detectedVendor.name,
        vendorId: detectedVendor.id,
        isKnownVendor: detectedVendor.isKnown,
        date: parsedData.date || '',
        invoiceNumber: parsedData.invoiceNumber || '',
        subtotal: parsedData.subtotal || 0,
        tax: parsedData.tax || 0,
        deliveryFee: parsedData.deliveryFee || 0,
        driverFee: parsedData.driverFee || 0,
        total: parsedData.total || 0,
        items: parsedData.items || []
      }];

      displayMultipleInvoices();

      document.getElementById('ocrStatus').style.display = 'none';
      document.getElementById('extractedData').style.display = 'block';
      document.getElementById('processBtn').style.display = 'none';
      document.getElementById('saveInvoiceBtn').style.display = 'block';
      document.getElementById('debugPdfBtn').style.display = 'block';
    }

    function detectVendorName(text) {
      // Check against known vendors from database
      for (const vendor of knownVendors) {
        // Create flexible pattern from vendor name
        const vendorWords = vendor.vendor_name.split(' ').filter(w => w.length > 2);
        const pattern = new RegExp(vendorWords.join('\\s*'), 'i');

        if (pattern.test(text)) {
          return {
            name: vendor.vendor_name,
            id: vendor.id,
            isKnown: true
          };
        }
      }

      // Try to extract any company name from the invoice (usually at top)
      const lines = text.split('\n').slice(0, 10); // Check first 10 lines
      for (const line of lines) {
        // Look for company-like patterns (2-4 words, capitalized)
        const companyPattern = /([A-Z][a-z]+(?:\s+[A-Z][a-z]+){1,3}(?:\s+(?:Inc|LLC|Corp|Co|Ltd|Company|Foods?|Service|Market|Imports?))?)/.exec(line);
        if (companyPattern) {
          return {
            name: companyPattern[1],
            id: null,
            isKnown: false
          };
        }
      }

      return {
        name: '',
        id: null,
        isKnown: false
      };
    }

    function parseInvoiceText(text, vendorId = null) {
      const lines = text.split('\n').filter(line => line.trim());

      const result = {
        vendorName: '',
        date: '',
        invoiceNumber: '',
        subtotal: 0,
        tax: 0,
        deliveryFee: 0,
        driverFee: 0,
        total: 0,
        items: []
      };

      // ===== TEMPLATE-BASED EXTRACTION =====
      // If we have a template for this vendor, use it for better accuracy
      if (vendorId && vendorTemplates[vendorId]) {
        const template = vendorTemplates[vendorId];
        console.log(`Using template for vendor ${vendorId}:`, template);

        // Extract fields using template patterns
        if (template.fields) {
          // Invoice Number
          if (template.fields.invoice_number && template.fields.invoice_number.pattern) {
            const pattern = eval(template.fields.invoice_number.pattern);
            const match = text.match(pattern);
            if (match && match[1]) {
              result.invoiceNumber = match[1].trim();
              console.log(`Template extracted invoice #: ${result.invoiceNumber}`);
            }
          }

          // Invoice Date
          if (template.fields.invoice_date && template.fields.invoice_date.pattern) {
            const pattern = eval(template.fields.invoice_date.pattern);
            const match = text.match(pattern);
            if (match && match[1]) {
              result.date = parseDate(match[1]);
              console.log(`Template extracted date: ${result.date}`);
            }
          }

          // Total Amount
          if (template.fields.total_amount && template.fields.total_amount.pattern) {
            const pattern = eval(template.fields.total_amount.pattern);
            const match = text.match(pattern);
            if (match && match[1]) {
              result.total = parseFloat(match[1].replace(/,/g, ''));
              console.log(`Template extracted total: ${result.total}`);
            }
          }
        }

        // If template extraction succeeded for key fields, skip generic parsing
        if (result.invoiceNumber || result.date || result.total) {
          console.log('Template extraction successful, using template data');
          // Still try to parse line items with existing parser
          result.items = parseLineItems(text);
          return result;
        }

        console.log('Template extraction failed, falling back to generic parsing');
      }

      // ===== FALLBACK: GENERIC PATTERN MATCHING =====

      // Date patterns (multiple formats) - ordered by specificity
      const datePatterns = [
        /invoice\s*date[:\s]*(\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4})/i,
        /order\s*date[:\s]*(\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4})/i,
        /date[:\s]*(\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4})/i,
        /(\d{1,2}[\/\-]\d{1,2}[\/\-]\d{4})/,  // Prefer 4-digit year
        /(\d{4}[\/\-]\d{1,2}[\/\-]\d{1,2})/,
        /(\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2})/    // 2-digit year as fallback
      ];

      // Invoice number patterns
      const invoicePatterns = [
        /inv(?:oice)?[#:\s]*([A-Z0-9\-]+)/i,
        /#\s*([A-Z0-9\-]+)/i,
        /invoice\s*(?:number|no|#)[:\s]*([A-Z0-9\-]+)/i,
        /order[:\s#]*([A-Z0-9\-]+)/i
      ];

      // Money extraction patterns
      const subtotalPatterns = [
        /sub\s*total[:\s]*\$?\s*([\d,]+\.?\d*)/i,
        /subtotal[:\s]*\$?\s*([\d,]+\.?\d*)/i
      ];

      const taxPatterns = [
        /tax[:\s]*\$?\s*([\d,]+\.?\d*)/i,
        /sales\s*tax[:\s]*\$?\s*([\d,]+\.?\d*)/i
      ];

      const deliveryPatterns = [
        /delivery\s*(?:fee|charge)?[:\s]*\$?\s*([\d,]+\.?\d*)/i,
        /shipping[:\s]*\$?\s*([\d,]+\.?\d*)/i
      ];

      const driverPatterns = [
        /driver\s*(?:fee|tip)?[:\s]*\$?\s*([\d,]+\.?\d*)/i,
        /gratuity[:\s]*\$?\s*([\d,]+\.?\d*)/i
      ];

      const totalPatterns = [
        /(?:total|amount|balance)\s*(?:due)?[:\s]*\$?\s*([\d,]+\.?\d*)/i,
        /grand\s*total[:\s]*\$?\s*([\d,]+\.?\d*)/i
      ];

      // Parse each line
      lines.forEach((line, index) => {
        // Date
        if (!result.date) {
          for (const pattern of datePatterns) {
            const match = line.match(pattern);
            if (match) {
              result.date = parseDate(match[1]);
              break;
            }
          }
        }

        // Invoice number
        if (!result.invoiceNumber) {
          for (const pattern of invoicePatterns) {
            const match = line.match(pattern);
            if (match) {
              result.invoiceNumber = match[1];
              break;
            }
          }
        }

        // Subtotal
        if (!result.subtotal) {
          for (const pattern of subtotalPatterns) {
            const match = line.match(pattern);
            if (match) {
              result.subtotal = parseFloat(match[1].replace(/,/g, ''));
              break;
            }
          }
        }

        // Tax
        if (!result.tax) {
          for (const pattern of taxPatterns) {
            const match = line.match(pattern);
            if (match) {
              result.tax = parseFloat(match[1].replace(/,/g, ''));
              break;
            }
          }
        }

        // Delivery fee
        if (!result.deliveryFee) {
          for (const pattern of deliveryPatterns) {
            const match = line.match(pattern);
            if (match) {
              result.deliveryFee = parseFloat(match[1].replace(/,/g, ''));
              break;
            }
          }
        }

        // Driver fee
        if (!result.driverFee) {
          for (const pattern of driverPatterns) {
            const match = line.match(pattern);
            if (match) {
              result.driverFee = parseFloat(match[1].replace(/,/g, ''));
              break;
            }
          }
        }

        // Total (look for this last to avoid catching subtotals)
        const totalMatch = line.match(/(?:total|amount|balance)\s*(?:due)?[:\s]*\$?\s*([\d,]+\.?\d*)/i);
        if (totalMatch) {
          const amount = parseFloat(totalMatch[1].replace(/,/g, ''));
          if (amount > result.total) {
            result.total = amount;
          }
        }

        // Skip lines that are clearly not items
        const skipPatterns = [
          /lot\s*number/i,
          /salesperson/i,
          /customer\s*number/i,
          /ship\s*to/i,
          /sold\s*to/i,
          /invoice\s*number/i,
          /invoice\s*date/i,
          /order\s*date/i,
          /order\s*number/i,
          /terms/i,
          /f\.o\.b/i,
          /ship\s*via/i,
          /continued/i,
          /customer\s*copy/i,
          /subtotal/i,
          /ordered.*shipped.*uom/i  // Greenleaf header row
        ];

        let shouldSkip = false;
        for (const skipPattern of skipPatterns) {
          if (skipPattern.test(line)) {
            shouldSkip = true;
            break;
          }
        }

        if (!shouldSkip) {
          // Try to parse as enhanced line item with unit extraction
          const item = parseLineItem(line);
          if (item && item.description && item.description.length > 5) {
            result.items.push(item);
          }
        }
      });

      return result;
    }

    // Enhanced line item parser with unit extraction and math validation
    function parseLineItem(line) {
      // Skip lines with keywords
      const lowerLine = line.toLowerCase();
      if (lowerLine.includes('total') || lowerLine.includes('tax') ||
          lowerLine.includes('delivery') || lowerLine.includes('fee')) {
        return null;
      }

      // Common units of measure
      const unitPatterns = [
        { regex: /\b(EA|EACH)\b/i, unit: 'EA' },
        { regex: /\b(CS|CASE|CASES)\b/i, unit: 'CS' },
        { regex: /\b(DZ|DOZEN)\b/i, unit: 'DZ' },
        { regex: /\b(LB|LBS|POUND|POUNDS)\b/i, unit: 'LB' },
        { regex: /\b(BUNCH)\b/i, unit: 'BUNCH' },
        { regex: /\b(BAG|BAGS)\b/i, unit: 'BAG' },
        { regex: /\b(BOX|BOXES)\b/i, unit: 'BOX' },
        { regex: /\b(PKG|PACKAGE)\b/i, unit: 'PKG' },
        { regex: /\b(GAL|GALLON|GALLONS)\b/i, unit: 'GAL' },
        { regex: /\b(QT|QUART|QUARTS)\b/i, unit: 'QT' },
        { regex: /\b(PT|PINT|PINTS)\b/i, unit: 'PT' },
        { regex: /\b(OZ|OUNCE|OUNCES)\b/i, unit: 'OZ' }
      ];

      const item = {
        description: '',
        quantity: null,
        unit: '',
        unit_price: null,
        extended_price: null,
        price: null,  // For backwards compatibility
        validation_status: ''
      };

      // Extract unit
      for (const { regex, unit } of unitPatterns) {
        if (regex.test(line)) {
          item.unit = unit;
          break;
        }
      }

      // Extract all numbers from the line
      const numbers = line.match(/\d+\.?\d*/g);
      if (!numbers || numbers.length === 0) return null;

      const nums = numbers.map(n => parseFloat(n));

      // Try different invoice formats:

      // Format 1: Greenleaf style - "| qty | qty | UOM | product# | description | unit_price | ext_price"
      // Example: "| 4 | 4 | CS | 00267 | WILD ARUGULA 4#/CS | 11.639 | 46.56"
      const greenleafMatch = line.match(/\|\s*(\d+\.?\d*)\s*\|\s*(\d+\.?\d*)\s*\|\s*(EA|CS|DZ|LB|BUNCH|BAG|BOX|PKG|GAL|QT|PT|OZ)[|\s]+([A-Z0-9\-]+)[|\s]+(.+?)\s*[|\s]+([\d,]+\.?\d*)\s*[|\s]+([\d,]+\.?\d*)/i);
      if (greenleafMatch) {
        item.quantity = parseFloat(greenleafMatch[2]);  // Use "shipped" qty (2nd column)
        item.unit = greenleafMatch[3].toUpperCase();
        item.description = greenleafMatch[5].trim();
        item.unit_price = parseFloat(greenleafMatch[6].replace(/,/g, ''));
        item.extended_price = parseFloat(greenleafMatch[7].replace(/,/g, ''));
        item.price = item.extended_price;  // For backwards compatibility

        // Math validation
        const calculated = Math.round(item.quantity * item.unit_price * 100) / 100;
        const tolerance = 0.05;
        if (Math.abs(calculated - item.extended_price) <= tolerance) {
          item.validation_status = 'valid';
        } else {
          item.validation_status = 'warning';
          // Auto-calculate quantity from extended price if math doesn't match
          const calculatedQty = Math.round((item.extended_price / item.unit_price) * 100) / 100;
          item.quantity = calculatedQty;
          item.validation_status = 'auto_calculated';
        }

        return item;
      }

      // Format 2: Simple format - "description qty price"
      // Example: "WILD ARUGULA 4 46.56"
      const simpleMatch1 = line.match(/^(.{10,}?)\s+(\d+\.?\d*)\s+\$?\s*([\d,]+\.?\d*)$/);
      if (simpleMatch1) {
        item.description = simpleMatch1[1].trim();
        item.quantity = parseFloat(simpleMatch1[2]);
        item.price = parseFloat(simpleMatch1[3].replace(/,/g, ''));
        item.extended_price = item.price;
        item.validation_status = 'simple_format';
        return item;
      }

      // Format 3: Reverse - "qty description price"
      // Example: "4 WILD ARUGULA 46.56"
      const simpleMatch2 = line.match(/^(\d+\.?\d*)\s+(.{10,}?)\s+\$?\s*([\d,]+\.?\d*)$/);
      if (simpleMatch2) {
        item.quantity = parseFloat(simpleMatch2[1]);
        item.description = simpleMatch2[2].trim();
        item.price = parseFloat(simpleMatch2[3].replace(/,/g, ''));
        item.extended_price = item.price;
        item.validation_status = 'simple_format';
        return item;
      }

      // Format 4: Description with price only (assume qty = 1)
      // Example: "WILD ARUGULA 46.56"
      const simpleMatch3 = line.match(/^(.{15,}?)\s+\$?\s*([\d,]+\.?\d*)$/);
      if (simpleMatch3) {
        item.description = simpleMatch3[1].trim();
        item.quantity = 1;
        item.price = parseFloat(simpleMatch3[2].replace(/,/g, ''));
        item.extended_price = item.price;
        item.validation_status = 'assumed_qty_1';
        return item;
      }

      // Format 5: Multiple numbers - try to intelligently parse
      // Look for pattern: smallest number = qty, middle = unit price, largest = extended
      if (nums.length >= 2) {
        // Extract text before numbers
        const textMatch = line.match(/^([A-Za-z\s#\-\/]+)/);
        if (textMatch) {
          item.description = textMatch[1].trim();
        }

        // If we have 3+ numbers, assume: qty, unit_price, extended_price
        if (nums.length >= 3) {
          // Find the smallest (likely qty), and two prices
          const sorted = [...nums].sort((a, b) => a - b);
          item.quantity = sorted[0];
          item.unit_price = sorted[sorted.length - 2];
          item.extended_price = sorted[sorted.length - 1];
          item.price = item.extended_price;

          // Validate math
          const calculated = Math.round(item.quantity * item.unit_price * 100) / 100;
          if (Math.abs(calculated - item.extended_price) <= 0.05) {
            item.validation_status = 'valid';
          } else {
            // Try recalculating qty
            item.quantity = Math.round((item.extended_price / item.unit_price) * 100) / 100;
            item.validation_status = 'auto_calculated';
          }

          if (item.description.length > 5) return item;
        }

        // If we have 2 numbers, assume: qty and price (or just price)
        if (nums.length === 2) {
          if (nums[0] < 100 && nums[1] > nums[0]) {
            // Likely qty and price
            item.quantity = nums[0];
            item.price = nums[1];
            item.extended_price = nums[1];
            item.validation_status = 'simple_2_numbers';
          } else {
            // Just price
            item.quantity = 1;
            item.price = nums[nums.length - 1];
            item.extended_price = item.price;
            item.validation_status = 'assumed_qty_1';
          }
          if (item.description.length > 5) return item;
        }
      }

      return null;
    }

    function parseDate(dateStr) {
      // Convert various date formats to YYYY-MM-DD
      const parts = dateStr.split(/[\/\-]/);
      if (parts.length === 3) {
        let year, month, day;

        if (parts[0].length === 4) {
          // YYYY-MM-DD or YYYY-DD-MM
          year = parts[0];
          month = parts[1].padStart(2, '0');
          day = parts[2].padStart(2, '0');
        } else {
          // MM-DD-YYYY or DD-MM-YYYY (assume MM-DD-YYYY for US)
          month = parts[0].padStart(2, '0');
          day = parts[1].padStart(2, '0');
          year = parts[2].length === 2 ? '20' + parts[2] : parts[2];
        }

        return `${year}-${month}-${day}`;
      }
      return '';
    }

    function formatDateForDisplay(dateStr) {
      // Convert YYYY-MM-DD to readable format: "Sep 4, 2025"
      if (!dateStr) return 'No Date';

      try {
        const date = new Date(dateStr + 'T12:00:00'); // Add time to avoid timezone issues
        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        const month = months[date.getMonth()];
        const day = date.getDate();
        const year = date.getFullYear();
        return `${month} ${day}, ${year}`;
      } catch (e) {
        return dateStr; // Return as-is if parsing fails
      }
    }

    function displayMultipleInvoices() {
      const container = document.getElementById('extractedItemsList');

      if (!extractedInvoices || extractedInvoices.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: var(--gray-500);">No invoices extracted.</p>';
        return;
      }

      let html = `<div style="margin-bottom: 16px; padding: 12px; background: var(--light-blue); border: 2px solid var(--primary-blue); display: flex; justify-content: space-between; align-items: center;">
        <strong>‚úì Found ${extractedInvoices.length} invoice${extractedInvoices.length > 1 ? 's' : ''} in this file</strong>
        <button type="button" onclick="downloadDebugPDF()" class="submit-btn" style="margin: 0; padding: 8px 16px; font-size: 12px; width: auto; background: var(--primary-blue);">
          üìÑ Download Debug PDF (for review)
        </button>
      </div>`;

      extractedInvoices.forEach((invoice, index) => {
        const hasData = invoice.date || invoice.invoiceNumber || invoice.vendorName;

        // Format date for display
        const displayDate = invoice.date ? formatDateForDisplay(invoice.date) : 'No Date';
        const dateColor = invoice.date ? 'var(--primary-blue)' : 'var(--error)';

        html += `
          <div style="margin-bottom: 24px; padding: 16px; border: 2px solid var(--gray-300); background: white;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
              <strong style="font-size: 14px;">Invoice ${index + 1} ${invoice.pageNumber ? `(Page ${invoice.pageNumber})` : ''}</strong>
              <div style="display: flex; gap: 8px; align-items: center;">
                <span style="font-size: 12px; color: ${hasData ? 'var(--success)' : 'var(--warning)'};">
                  ${hasData ? '‚úì Data Found' : '‚ö†Ô∏è Review Needed'}
                </span>
                <button type="button" onclick="deleteInvoice(${index})"
                        style="background: var(--error); color: white; border: none; padding: 6px 12px; cursor: pointer; font-size: 11px; border-radius: 3px; font-weight: bold;">
                  üóëÔ∏è Delete Page
                </button>
              </div>
            </div>
            <div style="margin-bottom: 12px; padding: 8px; background: var(--light-blue); border-left: 3px solid ${dateColor};">
              <strong style="color: ${dateColor}; font-size: 13px;">üìÖ ${displayDate}</strong>
              ${invoice.vendorName ? `<span style="margin-left: 12px; color: var(--gray-700); font-size: 12px;">‚Ä¢ ${invoice.vendorName}</span>` : ''}
              ${invoice.invoiceNumber ? `<span style="margin-left: 12px; color: var(--gray-700); font-size: 12px;">‚Ä¢ #${invoice.invoiceNumber}</span>` : ''}
            </div>

            <!-- Editable fields for this invoice -->
            <div class="form-group">
              <label>Vendor ${invoice.isKnownVendor ? '<span style="color: var(--success);">‚úì Recognized</span>' : '<span style="color: var(--warning);">‚ö†Ô∏è Unknown</span>'}</label>

              ${!invoice.isKnownVendor && !invoice.vendorName ? `
                <!-- No vendor detected - show dropdown -->
                <select class="form-input" onchange="selectExistingVendor(${index}, this.value)" style="margin-bottom: 8px;">
                  <option value="">Select from existing vendors...</option>
                  ${knownVendors.map(v => `<option value="${v.id}">${v.vendor_name}</option>`).join('')}
                  <option value="new">+ Add New Vendor</option>
                </select>
              ` : ''}

              <div style="display: flex; gap: 8px; align-items: center;">
                <input type="text" class="form-input" value="${invoice.vendorName || ''}"
                       onchange="extractedInvoices[${index}].vendorName = this.value; extractedInvoices[${index}].isKnownVendor = false;"
                       placeholder="${invoice.vendorName ? 'Edit if needed' : 'Or type vendor name'}"
                       style="flex: 1;">
                ${!invoice.isKnownVendor && invoice.vendorName ? `
                  <button type="button" class="submit-btn primary"
                          onclick="showAddVendorModal(${index})"
                          style="width: auto; padding: 8px 16px; margin: 0; font-size: 11px;">
                    + Add Vendor
                  </button>
                ` : ''}
                ${invoice.vendorName && (!invoice.isKnownVendor || !vendorTemplates[invoice.vendorId]) ? `
                  <button type="button" class="submit-btn"
                          onclick="showTemplateMapper(${index})"
                          style="width: auto; padding: 8px 16px; margin: 0; font-size: 11px; background: var(--warning); color: white;">
                    üìç Map Fields
                  </button>
                ` : ''}
              </div>
              ${!invoice.isKnownVendor && invoice.vendorName ? `
                <p style="font-size: 10px; color: var(--warning); margin-top: 4px;">
                  This vendor is not in the system. Click "+ Add Vendor" to set up ordering details, then "üìç Map Fields" to teach the system where to find data.
                </p>
              ` : ''}
              ${invoice.isKnownVendor && !vendorTemplates[invoice.vendorId] ? `
                <p style="font-size: 10px; color: var(--warning); margin-top: 4px;">
                  No template for this vendor. Click "üìç Map Fields" to create one for better accuracy.
                </p>
              ` : ''}
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
              <div class="form-group">
                <label>Invoice Date*</label>
                <input type="date" class="form-input" value="${invoice.date || ''}"
                       onchange="extractedInvoices[${index}].date = this.value">
              </div>
              <div class="form-group">
                <label>Invoice #</label>
                <input type="text" class="form-input" value="${invoice.invoiceNumber || ''}"
                       onchange="extractedInvoices[${index}].invoiceNumber = this.value">
              </div>
            </div>

            <!-- Financial breakdown -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 12px;">
              <div class="form-group">
                <label>Subtotal</label>
                <input type="number" class="form-input" value="${invoice.subtotal || ''}" step="0.01"
                       onchange="extractedInvoices[${index}].subtotal = parseFloat(this.value) || 0">
              </div>
              <div class="form-group">
                <label>Tax</label>
                <input type="number" class="form-input" value="${invoice.tax || ''}" step="0.01"
                       onchange="extractedInvoices[${index}].tax = parseFloat(this.value) || 0">
              </div>
              <div class="form-group">
                <label>Delivery Fee</label>
                <input type="number" class="form-input" value="${invoice.deliveryFee || ''}" step="0.01"
                       onchange="extractedInvoices[${index}].deliveryFee = parseFloat(this.value) || 0">
              </div>
              <div class="form-group">
                <label>Driver Fee/Tip</label>
                <input type="number" class="form-input" value="${invoice.driverFee || ''}" step="0.01"
                       onchange="extractedInvoices[${index}].driverFee = parseFloat(this.value) || 0">
              </div>
            </div>

            <div class="form-group">
              <label>Total Amount*</label>
              <input type="number" class="form-input" value="${invoice.total || ''}" step="0.01"
                     onchange="extractedInvoices[${index}].total = parseFloat(this.value) || 0"
                     style="font-weight: bold;">
            </div>

            <!-- Line items -->
            <details style="margin-top: 12px;" open>
              <summary style="cursor: pointer; font-size: 12px; font-weight: bold;">
                ${invoice.items && invoice.items.length > 0 ? invoice.items.length : '0'} line item${invoice.items && invoice.items.length !== 1 ? 's' : ''} extracted
              </summary>
              <div style="margin-top: 8px;">
                ${invoice.items && invoice.items.length > 0 ? `
                  <table class="items-table" style="font-size: 11px; width: 100%;">
                    <thead>
                      <tr>
                        <th style="width: 35%;">Item Description</th>
                        <th style="width: 10%;">Qty</th>
                        <th style="width: 10%;">Unit</th>
                        <th style="width: 15%;">Unit Price</th>
                        <th style="width: 15%;">Total</th>
                        <th style="width: 10%;">‚úì</th>
                        <th style="width: 5%;"></th>
                      </tr>
                    </thead>
                    <tbody id="itemsTable_${index}">
                      ${invoice.items.map((item, itemIndex) => {
                        // Calculate validation status
                        let validationIcon = '';
                        let validationColor = '';
                        if (item.unit_price && item.extended_price && item.quantity) {
                          const calculated = Math.round(item.quantity * item.unit_price * 100) / 100;
                          const diff = Math.abs(calculated - item.extended_price);
                          if (diff <= 0.05) {
                            validationIcon = '‚úì';
                            validationColor = 'var(--success)';
                          } else {
                            validationIcon = '‚ö†';
                            validationColor = 'var(--warning)';
                          }
                        }

                        return `
                        <tr>
                          <td>
                            <input type="text" class="form-input" value="${item.description || ''}"
                                   onchange="extractedInvoices[${index}].items[${itemIndex}].description = this.value"
                                   style="width: 100%; font-size: 11px; padding: 4px;">
                          </td>
                          <td>
                            <input type="number" class="form-input" value="${item.quantity || ''}" step="0.01"
                                   onchange="extractedInvoices[${index}].items[${itemIndex}].quantity = parseFloat(this.value) || 0; displayMultipleInvoices();"
                                   style="width: 100%; font-size: 11px; padding: 4px;">
                          </td>
                          <td>
                            <input type="text" class="form-input" value="${item.unit || ''}"
                                   onchange="extractedInvoices[${index}].items[${itemIndex}].unit = this.value.toUpperCase()"
                                   placeholder="EA/CS/DZ"
                                   style="width: 100%; font-size: 11px; padding: 4px; text-transform: uppercase;">
                          </td>
                          <td>
                            <input type="number" class="form-input" value="${item.unit_price || item.price || ''}" step="0.01"
                                   onchange="extractedInvoices[${index}].items[${itemIndex}].unit_price = parseFloat(this.value) || 0; extractedInvoices[${index}].items[${itemIndex}].price = parseFloat(this.value) || 0; displayMultipleInvoices();"
                                   style="width: 100%; font-size: 11px; padding: 4px;">
                          </td>
                          <td>
                            <input type="number" class="form-input" value="${item.extended_price || item.price || ''}" step="0.01"
                                   onchange="extractedInvoices[${index}].items[${itemIndex}].extended_price = parseFloat(this.value) || 0; extractedInvoices[${index}].items[${itemIndex}].price = parseFloat(this.value) || 0; displayMultipleInvoices();"
                                   style="width: 100%; font-size: 11px; padding: 4px; font-weight: bold;">
                          </td>
                          <td style="text-align: center; color: ${validationColor}; font-size: 14px; font-weight: bold;">
                            ${validationIcon}
                          </td>
                          <td style="text-align: center;">
                            <button type="button" onclick="deleteLineItem(${index}, ${itemIndex})"
                                    style="background: var(--error); color: white; border: none; padding: 4px 8px; cursor: pointer; font-size: 10px; border-radius: 3px;">
                              ‚úï
                            </button>
                          </td>
                        </tr>
                      `;
                      }).join('')}
                    </tbody>
                  </table>
                ` : '<p style="font-size: 11px; color: var(--gray-500); margin-top: 8px;">No line items extracted</p>'}
                <button type="button" onclick="addLineItem(${index})"
                        class="submit-btn"
                        style="margin-top: 8px; padding: 6px 12px; font-size: 11px; width: auto;">
                  + Add Line Item
                </button>
              </div>
            </details>

            <!-- Page preview and raw OCR text -->
            <details style="margin-top: 12px;">
              <summary style="cursor: pointer; font-size: 11px; color: var(--gray-500);">View Page Image & Raw OCR Text</summary>
              <div style="margin-top: 8px;">
                ${invoice.pageImageUrl ? `
                  <div style="margin-bottom: 12px;">
                    <strong style="font-size: 11px; color: var(--gray-700);">Page Preview:</strong>
                    <img src="${invoice.pageImageUrl}"
                         style="width: 100%; max-width: 400px; border: 2px solid var(--gray-300); margin-top: 4px; cursor: pointer;"
                         onclick="window.open(this.src, '_blank')"
                         alt="Invoice page ${invoice.pageNumber}">
                    <p style="font-size: 10px; color: var(--gray-500); margin-top: 4px;">Click image to view full size ‚Ä¢ Images removed after saving</p>
                  </div>
                ` : ''}
                <strong style="font-size: 11px; color: var(--gray-700);">Raw OCR Text:</strong>
                <textarea readonly style="width: 100%; min-height: 150px; margin-top: 4px; font-family: monospace; font-size: 10px; padding: 8px; border: 1px solid var(--gray-300);">${invoice.ocrText}</textarea>
              </div>
            </details>
          </div>
        `;
      });

      container.innerHTML = html;

      // Update main fields to hidden (since we're showing individual invoice fields)
      document.getElementById('extractedVendor').closest('.form-group').style.display = 'none';
      document.getElementById('extractedDate').closest('.form-group').parentElement.style.display = 'none';
      document.getElementById('extractedTotal').closest('.form-group').style.display = 'none';
    }

    // ========== DEBUG PDF GENERATOR ==========
    function downloadDebugPDF() {
      if (!extractedInvoices || extractedInvoices.length === 0) {
        alert('No invoices to export');
        return;
      }

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('p', 'mm', 'a4');
      const pageWidth = doc.internal.pageSize.getWidth();
      const pageHeight = doc.internal.pageSize.getHeight();
      const margin = 15;
      const maxWidth = pageWidth - (margin * 2);
      let yPos = margin;

      // Title page
      doc.setFontSize(18);
      doc.setFont('helvetica', 'bold');
      doc.text('OCR Debug Report', margin, yPos);
      yPos += 10;

      doc.setFontSize(10);
      doc.setFont('helvetica', 'normal');
      doc.text(`Generated: ${new Date().toLocaleString()}`, margin, yPos);
      yPos += 6;
      doc.text(`Total Pages: ${extractedInvoices.length}`, margin, yPos);
      yPos += 15;

      // Process each invoice
      extractedInvoices.forEach((invoice, index) => {
        // Start new page for each invoice (except first)
        if (index > 0) {
          doc.addPage();
          yPos = margin;
        }

        // Header
        doc.setFontSize(14);
        doc.setFont('helvetica', 'bold');
        doc.text(`Page ${index + 1} ${invoice.pageNumber ? `(Original Page ${invoice.pageNumber})` : ''}`, margin, yPos);
        yPos += 8;

        // Add page image if available
        if (invoice.pageImageUrl) {
          try {
            const imgWidth = maxWidth;
            const imgHeight = (imgWidth * 11) / 8.5; // Maintain aspect ratio

            if (yPos + imgHeight > pageHeight - margin) {
              doc.addPage();
              yPos = margin;
            }

            doc.addImage(invoice.pageImageUrl, 'JPEG', margin, yPos, imgWidth, imgHeight);
            yPos += imgHeight + 8;
          } catch (e) {
            console.error('Error adding image to PDF:', e);
          }
        }

        // Extracted Fields Section
        if (yPos + 40 > pageHeight - margin) {
          doc.addPage();
          yPos = margin;
        }

        doc.setFontSize(12);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(0, 168, 225); // Primary blue
        doc.text('EXTRACTED FIELDS:', margin, yPos);
        yPos += 6;

        doc.setFontSize(10);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(0, 0, 0);

        doc.text(`Vendor: ${invoice.vendorName || 'NOT FOUND'}`, margin, yPos);
        yPos += 5;
        doc.text(`Invoice #: ${invoice.invoiceNumber || 'NOT FOUND'}`, margin, yPos);
        yPos += 5;
        doc.text(`Date: ${invoice.date || 'NOT FOUND'}`, margin, yPos);
        yPos += 5;
        doc.text(`Total Amount: $${invoice.total ? invoice.total.toFixed(2) : 'NOT FOUND'}`, margin, yPos);
        yPos += 10;

        // Line Items Table
        if (invoice.items && invoice.items.length > 0) {
          doc.setFont('helvetica', 'bold');
          doc.setTextColor(0, 168, 225);
          doc.text(`LINE ITEMS (${invoice.items.length}):`, margin, yPos);
          yPos += 6;

          doc.setFont('helvetica', 'normal');
          doc.setTextColor(0, 0, 0);

          invoice.items.forEach((item, itemIndex) => {
            if (yPos + 15 > pageHeight - margin) {
              doc.addPage();
              yPos = margin;
            }

            const itemNum = itemIndex + 1;
            doc.setFont('helvetica', 'bold');
            doc.text(`${itemNum}. ${item.description || 'NO DESCRIPTION'}`, margin, yPos);
            yPos += 5;

            doc.setFont('helvetica', 'normal');
            doc.text(`   Qty: ${item.quantity || '?'}  Unit: ${item.unit || 'N/A'}  Unit Price: $${item.unit_price ? item.unit_price.toFixed(2) : (item.price ? item.price.toFixed(2) : '?')}  Total: $${item.extended_price ? item.extended_price.toFixed(2) : (item.price ? item.price.toFixed(2) : '?')}`, margin, yPos);
            yPos += 6;

            // Math validation
            if (item.quantity && item.unit_price && item.extended_price) {
              const calculated = Math.round(item.quantity * item.unit_price * 100) / 100;
              const diff = Math.abs(calculated - item.extended_price);
              if (diff > 0.05) {
                doc.setTextColor(255, 179, 0); // Warning color
                doc.text(`   ‚ö† Math Warning: ${item.quantity} √ó $${item.unit_price.toFixed(2)} = $${calculated.toFixed(2)} (not $${item.extended_price.toFixed(2)})`, margin, yPos);
                doc.setTextColor(0, 0, 0);
                yPos += 5;
              }
            }
          });

          yPos += 5;
        } else {
          doc.setTextColor(211, 47, 47); // Error color
          doc.text('NO LINE ITEMS EXTRACTED', margin, yPos);
          doc.setTextColor(0, 0, 0);
          yPos += 8;
        }

        // Raw OCR Text Section
        if (yPos + 20 > pageHeight - margin) {
          doc.addPage();
          yPos = margin;
        }

        doc.setFontSize(12);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(0, 168, 225);
        doc.text('RAW OCR TEXT:', margin, yPos);
        yPos += 6;

        doc.setFontSize(8);
        doc.setFont('courier', 'normal');
        doc.setTextColor(0, 0, 0);

        // Split OCR text into lines and wrap
        const ocrLines = invoice.ocrText ? invoice.ocrText.split('\n') : ['No OCR text available'];
        ocrLines.forEach(line => {
          if (yPos + 4 > pageHeight - margin) {
            doc.addPage();
            yPos = margin;
          }

          // Wrap long lines
          const wrappedLines = doc.splitTextToSize(line || ' ', maxWidth);
          wrappedLines.forEach(wrappedLine => {
            if (yPos + 4 > pageHeight - margin) {
              doc.addPage();
              yPos = margin;
            }
            doc.text(wrappedLine, margin, yPos);
            yPos += 4;
          });
        });
      });

      // Save PDF
      const filename = `ocr-debug-${new Date().toISOString().slice(0, 10)}.pdf`;
      doc.save(filename);
    }

    async function saveInvoice() {
      // Batch save all extracted invoices
      if (!extractedInvoices || extractedInvoices.length === 0) {
        alert('No invoices to save');
        return;
      }

      try {
        const invoicesToSave = [];
        let missingData = [];

        // Validate each invoice
        extractedInvoices.forEach((invoice, index) => {
          if (!invoice.date) {
            missingData.push(`Invoice ${index + 1}: missing date`);
          }
          if (!invoice.total || invoice.total === 0) {
            missingData.push(`Invoice ${index + 1}: missing total amount`);
          }
          if (!invoice.vendorName) {
            missingData.push(`Invoice ${index + 1}: missing vendor name`);
          }

          invoicesToSave.push({
            vendor_id: invoice.vendorId || null,
            vendor_name: invoice.vendorName || 'Unknown',
            invoice_date: invoice.date,
            invoice_number: invoice.invoiceNumber,
            total_amount: invoice.total,
            ocr_text: invoice.ocrText,
            parsed_data: JSON.stringify({
              subtotal: invoice.subtotal,
              tax: invoice.tax,
              deliveryFee: invoice.deliveryFee,
              driverFee: invoice.driverFee,
              pageNumber: invoice.pageNumber,
              itemCount: invoice.items.length
            }),
            items_extracted: JSON.stringify(invoice.items),
            processed: true,
            verified: false,
            uploaded_at: new Date().toISOString()
          });
        });

        // Show warnings if data is missing but still allow save
        if (missingData.length > 0) {
          const proceed = confirm(
            `Warning: Some invoices are missing data:\n\n${missingData.join('\n')}\n\nDo you want to save anyway?`
          );
          if (!proceed) return;
        }

        // Save all invoices
        const { data, error } = await supabase
          .from('invoice_archive')
          .insert(invoicesToSave)
          .select();

        if (error) throw error;

        // Clear page images to free memory (they're large data URLs)
        extractedInvoices.forEach(invoice => {
          delete invoice.pageImageUrl;
        });

        alert(`‚úì Successfully saved ${invoicesToSave.length} invoice${invoicesToSave.length > 1 ? 's' : ''}!`);

        // Reset form
        document.getElementById('invoiceFile').value = '';
        document.getElementById('invoicePreview').style.display = 'none';
        document.getElementById('extractedData').style.display = 'none';
        document.getElementById('processBtn').style.display = 'block';
        document.getElementById('processBtn').disabled = false;
        document.getElementById('saveInvoiceBtn').style.display = 'none';
        currentInvoiceFile = null;
        currentOcrText = '';
        extractedInvoices = [];

        showDashboard();

      } catch (error) {
        console.error('Error saving invoices:', error);
        alert('Error saving invoices: ' + error.message);
      }
    }

    // Load items from database
    async function loadItems(category = '') {
      const itemsList = document.getElementById('itemsList');
      itemsList.innerHTML = '<p style="text-align: center; color: var(--gray-500); padding: 40px 0;">Loading items...</p>';

      try {
        let query = supabase
          .from('inventory_items')
          .select('*')
          .order('category', { ascending: true })
          .order('item_name', { ascending: true });

        if (category) {
          query = query.eq('category', category);
        }

        const { data, error } = await query;

        if (error) throw error;

        if (!data || data.length === 0) {
          itemsList.innerHTML = '<p style="text-align: center; color: var(--gray-500); padding: 40px 0;">No items found. Click "Add New Item" to get started.</p>';
          return;
        }

        let html = '<table class="items-table"><thead><tr>';
        html += '<th>Item</th><th>Category</th><th>Unit</th><th>Par</th><th>Cost</th><th>Actions</th>';
        html += '</tr></thead><tbody>';

        data.forEach(item => {
          html += `<tr>
            <td><strong>${item.item_name}</strong></td>
            <td><span style="font-size: 10px; padding: 4px 8px; background: var(--light-blue);">${item.category}</span></td>
            <td>${item.unit}</td>
            <td>${item.par_level || '-'}</td>
            <td>$${item.current_cost ? item.current_cost.toFixed(2) : '-'}</td>
            <td>
              <button class="btn-small btn-edit" onclick="editItem(${item.id})">Edit</button>
              <button class="btn-small btn-delete" onclick="deleteItem(${item.id})">Delete</button>
            </td>
          </tr>`;
        });

        html += '</tbody></table>';
        itemsList.innerHTML = html;

      } catch (error) {
        console.error('Error loading items:', error);
        itemsList.innerHTML = `<p style="text-align: center; color: var(--error); padding: 40px 0;">Error loading items: ${error.message}</p>`;
      }
    }

    function filterItems() {
      const category = document.getElementById('categoryFilter').value;
      loadItems(category);
    }

    async function saveItem() {
      const name = document.getElementById('itemName').value.trim();
      const category = document.getElementById('itemCategory').value;
      const unit = document.getElementById('itemUnit').value.trim();
      const parLevel = parseFloat(document.getElementById('itemParLevel').value) || null;
      const cost = parseFloat(document.getElementById('itemCost').value) || null;
      const vendor = document.getElementById('itemVendor').value.trim() || null;
      const barcode = document.getElementById('itemBarcode').value.trim() || null;
      const frequency = document.getElementById('itemFrequency').value;

      if (!name || !category || !unit) {
        alert('Please fill in all required fields (Item Name, Category, Unit)');
        return;
      }

      try {
        const itemData = {
          item_name: name,
          category: category,
          unit: unit,
          par_level: parLevel,
          current_cost: cost,
          vendor_name: vendor,
          barcode: barcode,
          count_frequency: frequency,
          last_updated: new Date().toISOString()
        };

        let result;
        if (currentEditingId) {
          result = await supabase
            .from('inventory_items')
            .update(itemData)
            .eq('id', currentEditingId);
        } else {
          itemData.created_at = new Date().toISOString();
          result = await supabase
            .from('inventory_items')
            .insert([itemData]);
        }

        if (result.error) throw result.error;

        alert(currentEditingId ? 'Item updated successfully!' : 'Item added successfully!');
        currentEditingId = null;
        showManageItems();

      } catch (error) {
        console.error('Error saving item:', error);
        alert('Error saving item: ' + error.message);
      }
    }

    async function editItem(id) {
      try {
        const { data, error } = await supabase
          .from('inventory_items')
          .select('*')
          .eq('id', id)
          .single();

        if (error) throw error;

        currentEditingId = id;
        document.getElementById('itemFormTitle').textContent = 'Edit Item';
        document.getElementById('itemName').value = data.item_name;
        document.getElementById('itemCategory').value = data.category;
        document.getElementById('itemUnit').value = data.unit;
        document.getElementById('itemParLevel').value = data.par_level || '';
        document.getElementById('itemCost').value = data.current_cost || '';
        document.getElementById('itemVendor').value = data.vendor_name || '';
        document.getElementById('itemBarcode').value = data.barcode || '';
        document.getElementById('itemFrequency').value = data.count_frequency || 'weekly';

        document.getElementById('dashboard').style.display = 'none';
        document.getElementById('manageItems').style.display = 'none';
        document.getElementById('itemForm').style.display = 'block';

      } catch (error) {
        console.error('Error loading item:', error);
        alert('Error loading item: ' + error.message);
      }
    }

    async function deleteItem(id) {
      if (!confirm('Are you sure you want to delete this item?')) {
        return;
      }

      try {
        const { error } = await supabase
          .from('inventory_items')
          .delete()
          .eq('id', id);

        if (error) throw error;

        alert('Item deleted successfully!');
        loadItems();

      } catch (error) {
        console.error('Error deleting item:', error);
        alert('Error deleting item: ' + error.message);
      }
    }

    // ========== Invoice & Line Item Management ==========
    function deleteInvoice(invoiceIndex) {
      if (confirm('‚ö†Ô∏è Delete this entire invoice/page?\n\nThis will remove all line items and cannot be undone.')) {
        extractedInvoices.splice(invoiceIndex, 1);
        displayMultipleInvoices();

        // Show message if no invoices left
        if (extractedInvoices.length === 0) {
          document.getElementById('extractedItemsList').innerHTML =
            '<p style="text-align: center; color: var(--gray-500); padding: 20px;">All pages removed. Upload a new file to start over.</p>';
        }
      }
    }

    function deleteLineItem(invoiceIndex, itemIndex) {
      if (confirm('Delete this line item?')) {
        extractedInvoices[invoiceIndex].items.splice(itemIndex, 1);
        displayMultipleInvoices();
      }
    }

    function addLineItem(invoiceIndex) {
      if (!extractedInvoices[invoiceIndex].items) {
        extractedInvoices[invoiceIndex].items = [];
      }
      extractedInvoices[invoiceIndex].items.push({
        description: '',
        quantity: 0,
        unit: '',
        unit_price: 0,
        extended_price: 0,
        price: 0,
        validation_status: 'manual'
      });
      displayMultipleInvoices();
    }

    // ========== Image Preprocessing for Better OCR ==========
    // ========== ROTATION & DESKEW CORRECTION ==========
    async function detectAndCorrectSkew(canvas) {
      try {
        // First try: Detect major rotations (90¬∞, 180¬∞, 270¬∞) using image analysis
        const majorRotation = detectMajorRotation(canvas);
        if (majorRotation !== 0) {
          console.log(`Detected ${majorRotation}¬∞ rotation, correcting...`);
          canvas = rotateCanvas(canvas, majorRotation);
        }

        // Second try: Detect small skew angles using Tesseract OSD
        const result = await Tesseract.detect(canvas, {
          logger: () => {} // Suppress logs
        });

        if (result && result.data) {
          const rotation = result.data.orientation_degrees || 0;
          const confidence = result.data.orientation_confidence || 0;

          console.log(`OSD detected rotation: ${rotation}¬∞, confidence: ${confidence}`);

          // Only correct small skews (not major rotations, we handled those)
          if (confidence > 0.3 && Math.abs(rotation) > 1 && Math.abs(rotation) < 45) {
            console.log(`Correcting skew: ${rotation}¬∞`);
            canvas = rotateCanvas(canvas, -rotation);
          }
        }

        return canvas;
      } catch (error) {
        console.error('Skew detection failed:', error);
        return canvas; // Return original if detection fails
      }
    }

    // Detect 90¬∞/180¬∞/270¬∞ rotations by analyzing image edges
    function detectMajorRotation(canvas) {
      const ctx = canvas.getContext('2d');
      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const data = imageData.data;
      const width = canvas.width;
      const height = canvas.height;

      // Sample edge pixels to detect orientation
      let topEdgeDark = 0, bottomEdgeDark = 0;
      let leftEdgeDark = 0, rightEdgeDark = 0;

      // Sample top edge
      for (let x = 0; x < width; x += 10) {
        const idx = (0 * width + x) * 4;
        const brightness = (data[idx] + data[idx + 1] + data[idx + 2]) / 3;
        if (brightness < 200) topEdgeDark++;
      }

      // Sample bottom edge
      for (let x = 0; x < width; x += 10) {
        const idx = ((height - 1) * width + x) * 4;
        const brightness = (data[idx] + data[idx + 1] + data[idx + 2]) / 3;
        if (brightness < 200) bottomEdgeDark++;
      }

      // Sample left edge
      for (let y = 0; y < height; y += 10) {
        const idx = (y * width + 0) * 4;
        const brightness = (data[idx] + data[idx + 1] + data[idx + 2]) / 3;
        if (brightness < 200) leftEdgeDark++;
      }

      // Sample right edge
      for (let y = 0; y < height; y += 10) {
        const idx = (y * width + (width - 1)) * 4;
        const brightness = (data[idx] + data[idx + 1] + data[idx + 2]) / 3;
        if (brightness < 200) rightEdgeDark++;
      }

      console.log(`Edge analysis: top=${topEdgeDark}, bottom=${bottomEdgeDark}, left=${leftEdgeDark}, right=${rightEdgeDark}`);

      // If left/right edges have significantly more content than top/bottom, it's rotated 90¬∞ or 270¬∞
      const horizontalContent = topEdgeDark + bottomEdgeDark;
      const verticalContent = leftEdgeDark + rightEdgeDark;

      if (verticalContent > horizontalContent * 1.5) {
        // Likely rotated 90¬∞ or 270¬∞
        // Check which way by comparing aspect ratio
        if (width > height) {
          return -90; // Rotate -90¬∞ to correct
        } else {
          return 90; // Rotate 90¬∞ to correct
        }
      }

      return 0; // No major rotation detected
    }

    function rotateCanvas(sourceCanvas, angleDegrees) {
      const angle = angleDegrees * Math.PI / 180;

      // Calculate new canvas size to fit rotated image
      const cos = Math.abs(Math.cos(angle));
      const sin = Math.abs(Math.sin(angle));
      const newWidth = Math.ceil(sourceCanvas.width * cos + sourceCanvas.height * sin);
      const newHeight = Math.ceil(sourceCanvas.width * sin + sourceCanvas.height * cos);

      // Create new canvas
      const rotatedCanvas = document.createElement('canvas');
      rotatedCanvas.width = newWidth;
      rotatedCanvas.height = newHeight;
      const ctx = rotatedCanvas.getContext('2d');

      // Fill with white background
      ctx.fillStyle = '#FFFFFF';
      ctx.fillRect(0, 0, newWidth, newHeight);

      // Rotate and draw
      ctx.translate(newWidth / 2, newHeight / 2);
      ctx.rotate(angle);
      ctx.drawImage(sourceCanvas, -sourceCanvas.width / 2, -sourceCanvas.height / 2);

      return rotatedCanvas;
    }

    // ========== IMAGE PREPROCESSING ==========
    function preprocessImage(canvas) {
      const ctx = canvas.getContext('2d');
      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const data = imageData.data;

      // Step 1: Convert to grayscale
      for (let i = 0; i < data.length; i += 4) {
        const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
        data[i] = avg;
        data[i + 1] = avg;
        data[i + 2] = avg;
      }

      // Step 2: Light denoising with Gaussian-like smoothing (3x3 kernel)
      // This reduces noise without losing detail
      const smoothed = new Uint8ClampedArray(data.length);
      const width = canvas.width;
      const height = canvas.height;

      for (let y = 1; y < height - 1; y++) {
        for (let x = 1; x < width - 1; x++) {
          const idx = (y * width + x) * 4;

          // Simple 3x3 average (light blur)
          let sum = 0;
          for (let dy = -1; dy <= 1; dy++) {
            for (let dx = -1; dx <= 1; dx++) {
              const nIdx = ((y + dy) * width + (x + dx)) * 4;
              sum += data[nIdx];
            }
          }

          const avg = sum / 9;
          smoothed[idx] = avg;
          smoothed[idx + 1] = avg;
          smoothed[idx + 2] = avg;
          smoothed[idx + 3] = 255;
        }
      }

      // Step 3: Slight contrast enhancement (NOT aggressive thresholding)
      // This helps text stand out without creating artifacts
      const contrast = 1.2; // Gentle contrast boost

      for (let i = 0; i < smoothed.length; i += 4) {
        let value = smoothed[i];

        // Enhance contrast around midpoint
        value = ((value - 128) * contrast) + 128;

        // Clamp to valid range
        value = Math.max(0, Math.min(255, value));

        smoothed[i] = value;
        smoothed[i + 1] = value;
        smoothed[i + 2] = value;
      }

      ctx.putImageData(new ImageData(smoothed, width, height), 0, 0);
      return canvas;
    }

    // ========== Vendor Selection ==========
    function selectExistingVendor(invoiceIndex, vendorId) {
      if (!vendorId) return;

      if (vendorId === 'new') {
        // Show add vendor modal with empty name
        showAddVendorModal(invoiceIndex);
        return;
      }

      // Find vendor in known vendors
      const vendor = knownVendors.find(v => v.id == vendorId);
      if (!vendor) return;

      // Update invoice with selected vendor
      extractedInvoices[invoiceIndex].vendorId = vendor.id;
      extractedInvoices[invoiceIndex].vendorName = vendor.vendor_name;
      extractedInvoices[invoiceIndex].isKnownVendor = true;

      // Refresh display
      displayMultipleInvoices();
    }

    // ========== Vendor Addition Modal ==========
    function showAddVendorModal(invoiceIndex) {
      currentInvoiceIndexForVendor = invoiceIndex;
      const vendorName = extractedInvoices[invoiceIndex].vendorName;

      // Pre-fill vendor name
      document.getElementById('newVendorName').value = vendorName;

      // Reset form fields
      const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
      days.forEach(day => {
        document.getElementById(`orderDay_${day}`).checked = false;
      });
      document.getElementById('newVendorCutoffTime').value = '';
      document.getElementById('newVendorMethod').value = '';
      document.getElementById('newVendorRepName').value = '';
      document.getElementById('newVendorRepPhone').value = '';
      document.getElementById('newVendorNotes').value = '';

      // Show modal
      document.getElementById('addVendorModal').style.display = 'block';
    }

    function closeAddVendorModal() {
      document.getElementById('addVendorModal').style.display = 'none';
      currentInvoiceIndexForVendor = null;
    }

    async function saveNewVendor() {
      if (currentInvoiceIndexForVendor === null) return;

      const vendorName = document.getElementById('newVendorName').value;
      const orderMethod = document.getElementById('newVendorMethod').value;

      if (!vendorName || !orderMethod) {
        alert('Please fill in vendor name and order method');
        return;
      }

      // Collect selected order days
      const orderDays = [];
      const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
      days.forEach(day => {
        if (document.getElementById(`orderDay_${day}`).checked) {
          orderDays.push(day);
        }
      });

      try {
        // Insert new vendor into database
        const { data, error } = await supabase
          .from('vendors')
          .insert([{
            vendor_name: vendorName,
            order_days: orderDays.length > 0 ? orderDays : null,
            order_cutoff_time: document.getElementById('newVendorCutoffTime').value || null,
            order_method: orderMethod,
            rep_name: document.getElementById('newVendorRepName').value || null,
            rep_phone: document.getElementById('newVendorRepPhone').value || null,
            special_notes: document.getElementById('newVendorNotes').value || null,
            priority: 'normal',
            active: true
          }])
          .select();

        if (error) throw error;

        const newVendor = data[0];

        // Update the invoice with the new vendor ID
        extractedInvoices[currentInvoiceIndexForVendor].vendorId = newVendor.id;
        extractedInvoices[currentInvoiceIndexForVendor].vendorName = newVendor.vendor_name;
        extractedInvoices[currentInvoiceIndexForVendor].isKnownVendor = true;

        // Add to known vendors array
        knownVendors.push(newVendor);

        // Refresh the display
        displayMultipleInvoices();

        // Close modal
        closeAddVendorModal();

        alert(`‚úì Vendor "${vendorName}" added successfully!`);

      } catch (error) {
        console.error('Error saving vendor:', error);
        alert('Error saving vendor: ' + error.message);
      }
    }

    // ==================== TEMPLATE MAPPER FUNCTIONS ====================

    let currentMapperInvoiceIndex = null;
    let currentMappingField = 'invoice_number';
    let templateMappings = {
      vendor_name: '',
      vendor_id: null,
      keywords: [],
      fields: {},
      line_items_config: {},
      rotation_hint: 0
    };

    const fieldConfigs = {
      invoice_number: {
        name: 'Invoice Number',
        help: 'Select the invoice number in the text below',
        next: 'invoice_date'
      },
      invoice_date: {
        name: 'Invoice Date',
        help: 'Select the date in the text below',
        next: 'total_amount'
      },
      total_amount: {
        name: 'Total Amount',
        help: 'Select the total amount in the text below',
        next: 'line_items'
      },
      line_items: {
        name: 'Line Items Table',
        help: 'Select a sample line item (quantity, description, price)',
        next: null
      }
    };

    function showTemplateMapper(invoiceIndex) {
      currentMapperInvoiceIndex = invoiceIndex;
      const invoice = extractedInvoices[invoiceIndex];

      // Reset mappings
      templateMappings = {
        vendor_name: invoice.vendorName,
        vendor_id: invoice.vendorId,
        keywords: [invoice.vendorName],
        fields: {},
        line_items_config: {},
        rotation_hint: 0
      };
      currentMappingField = 'invoice_number';

      // Set vendor name
      document.getElementById('mapperVendorName').textContent = invoice.vendorName;

      // Show OCR text
      document.getElementById('mapperOcrText').textContent = invoice.ocrText || 'No OCR text available';

      // Reset UI
      resetMapperSteps();
      updateCurrentFieldUI();
      updateMappedFieldsSummary();

      // Show modal
      document.getElementById('templateMapperModal').style.display = 'block';

      // Add text selection listener
      document.getElementById('mapperOcrText').addEventListener('mouseup', handleTextSelection);
    }

    function closeTemplateMapper() {
      document.getElementById('templateMapperModal').style.display = 'none';
      document.getElementById('mapperOcrText').removeEventListener('mouseup', handleTextSelection);
      currentMapperInvoiceIndex = null;
    }

    function setMappingField(fieldName) {
      currentMappingField = fieldName;
      updateCurrentFieldUI();

      // Update step buttons
      document.querySelectorAll('.mapper-step-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      document.getElementById(`stepBtn_${fieldName}`).classList.add('active');
    }

    function updateCurrentFieldUI() {
      const config = fieldConfigs[currentMappingField];
      document.getElementById('currentFieldName').textContent = config.name;
      document.getElementById('currentFieldHelp').textContent = config.help;
    }

    function resetMapperSteps() {
      document.querySelectorAll('.mapper-step-btn').forEach(btn => {
        btn.classList.remove('completed');
        btn.classList.remove('active');
      });
      document.getElementById('stepBtn_invoice_number').classList.add('active');
    }

    function handleTextSelection() {
      const selection = window.getSelection();
      const selectedText = selection.toString().trim();

      if (selectedText.length > 0) {
        // Show preview
        document.getElementById('selectedTextValue').textContent = selectedText;
        document.getElementById('selectedTextPreview').style.display = 'block';
      } else {
        document.getElementById('selectedTextPreview').style.display = 'none';
      }
    }

    function confirmSelection() {
      const selectedText = document.getElementById('selectedTextValue').textContent;

      if (!selectedText) return;

      // Generate regex pattern from selected text
      const pattern = generatePatternFromSelection(selectedText, currentMappingField);

      // Save mapping
      templateMappings.fields[currentMappingField] = {
        pattern: pattern,
        example: selectedText,
        required: true
      };

      // Mark step as completed
      document.getElementById(`stepBtn_${currentMappingField}`).classList.add('completed');

      // Move to next field
      const config = fieldConfigs[currentMappingField];
      if (config.next) {
        setMappingField(config.next);
      }

      // Update summary
      updateMappedFieldsSummary();

      // Hide preview
      document.getElementById('selectedTextPreview').style.display = 'none';
      window.getSelection().removeAllRanges();
    }

    function generatePatternFromSelection(text, fieldType) {
      // Escape special regex characters
      const escaped = text.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');

      if (fieldType === 'invoice_number') {
        // Extract just the number/ID pattern
        const numberMatch = text.match(/([A-Z0-9\-]+)/);
        if (numberMatch) {
          return `/(?:invoice|inv|#)?\\s*(?:number|no|#)?\\s*[:#]?\\s*(${numberMatch[1].replace(/[0-9]/g, '\\d')})/i`;
        }
        return `/(?:invoice|inv|#)?\\s*(?:number|no|#)?\\s*[:#]?\\s*([A-Z0-9\\-]+)/i`;
      }

      if (fieldType === 'invoice_date') {
        // Detect date format and create pattern
        if (/\d{1,2}\/\d{1,2}\/\d{2,4}/.test(text)) {
          return `/(?:date|invoice date)[:\\s]*(\\d{1,2}\\/\\d{1,2}\\/\\d{2,4})/i`;
        }
        if (/\d{4}-\d{1,2}-\d{1,2}/.test(text)) {
          return `/(?:date|invoice date)[:\\s]*(\\d{4}-\\d{1,2}-\\d{1,2})/i`;
        }
        return `/(?:date|invoice date)[:\\s]*([\\d\\/\\-]+)/i`;
      }

      if (fieldType === 'total_amount') {
        // Extract number pattern
        const amountMatch = text.match(/([\d,]+\.?\d*)/);
        if (amountMatch) {
          return `/(?:total|amount|grand total)[:\\s]*\\$?\\s*([\\d,]+\\.\\d{2})/i`;
        }
        return `/(?:total|amount)[:\\s]*\\$?\\s*([\\d,]+\\.\\d{2})/i`;
      }

      if (fieldType === 'line_items') {
        // For line items, save the example format
        return `/${escaped}/i`;
      }

      return `/${escaped}/i`;
    }

    function updateMappedFieldsSummary() {
      const listDiv = document.getElementById('mappedFieldsList');
      const mappedFields = Object.keys(templateMappings.fields);

      if (mappedFields.length === 0) {
        listDiv.innerHTML = '<em style="color: var(--gray-500);">No fields mapped yet</em>';
        return;
      }

      let html = '<div style="display: flex; flex-direction: column; gap: 6px;">';
      mappedFields.forEach(field => {
        const config = fieldConfigs[field];
        const mapping = templateMappings.fields[field];
        html += `
          <div style="display: flex; justify-content: space-between; align-items: center; padding: 6px; background: white; border-radius: 3px;">
            <span><strong>${config.name}:</strong> ${mapping.example}</span>
            <button onclick="removeMappedField('${field}')" style="background: var(--error); color: white; border: none; padding: 2px 8px; cursor: pointer; font-size: 10px; border-radius: 3px;">
              ‚úï
            </button>
          </div>
        `;
      });
      html += '</div>';

      listDiv.innerHTML = html;
    }

    function removeMappedField(fieldName) {
      delete templateMappings.fields[fieldName];
      document.getElementById(`stepBtn_${fieldName}`).classList.remove('completed');
      updateMappedFieldsSummary();
    }

    async function saveTemplate() {
      if (Object.keys(templateMappings.fields).length === 0) {
        alert('Please map at least one field before saving');
        return;
      }

      const invoice = extractedInvoices[currentMapperInvoiceIndex];

      if (!invoice.vendorId) {
        alert('Please add the vendor first before creating a template');
        return;
      }

      try {
        // Save template to database
        const { data, error } = await supabase
          .from('vendor_templates')
          .upsert([{
            vendor_id: invoice.vendorId,
            vendor_name: invoice.vendorName,
            template_data: JSON.stringify(templateMappings),
            created_at: new Date().toISOString(),
            updated_at: new Date().toISOString()
          }], {
            onConflict: 'vendor_id'
          })
          .select();

        if (error) throw error;

        // Update local templates cache
        vendorTemplates[invoice.vendorId] = templateMappings;

        // Refresh display
        displayMultipleInvoices();

        // Close modal
        closeTemplateMapper();

        alert(`‚úì Template saved for ${invoice.vendorName}!\n\nMapped fields: ${Object.keys(templateMappings.fields).join(', ')}`);

      } catch (error) {
        console.error('Error saving template:', error);
        alert('Error saving template: ' + error.message);
      }
    }
  </script>
</body>
</html>
