<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, viewport-fit=cover">
  <title>Jayna Gyro - COGs Management</title>

  <link rel="apple-touch-icon" href="https://static.spotapps.co/website_images/ab_websites/229800_website_v1/logo.png">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#00A8E1">

  <style>
    /* Jayna Brand Design - Sky Blue & Grayscale */
    :root {
      --primary-blue: #00A8E1;
      --secondary-blue: #0094D6;
      --light-blue: #E3F4FC;
      --accent-blue: #0081C6;
      --gray-900: #212121;
      --gray-700: #424242;
      --gray-500: #757575;
      --gray-400: #BDBDBD;
      --gray-300: #E0E0E0;
      --gray-100: #F5F5F5;
      --dark-gray: #616161;
      --success: #00C853;
      --warning: #FFB300;
      --error: #D32F2F;
      --white: #FFFFFF;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body {
      font-family: 'Aptos', 'Segoe UI Variable', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      background: var(--gray-100);
      min-height: 100vh;
      padding: 0;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
      background: var(--white);
      min-height: 100vh;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }
    .header {
      background: var(--white);
      color: var(--gray-900);
      text-align: center;
      padding: 12px;
      border-bottom: 1px solid var(--gray-300);
    }
    .header h1 { font-size: 18px; font-weight: 700; margin-bottom: 2px; letter-spacing: 1.5px; text-transform: uppercase; }
    .header p { opacity: 0.7; font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }

    .content { padding: 12px; }

    /* Navigation Buttons */
    .main-menu {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 8px;
      margin-bottom: 16px;
    }
    .menu-btn {
      padding: 16px 12px;
      border: 2px solid var(--gray-300);
      background: var(--gray-100);
      font-size: 11px;
      font-weight: 700;
      color: var(--gray-900);
      cursor: pointer;
      text-align: center;
      min-height: 50px;
      text-transform: uppercase;
      letter-spacing: 1.2px;
    }
    .menu-btn:hover { background: var(--gray-300); }
    .menu-btn.primary { background: var(--white); }
    .menu-btn.cogs {
      background: var(--dark-gray);
      color: var(--white);
      border-color: var(--dark-gray);
    }

    /* Quick Actions Grid */
    .quick-actions {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 20px;
    }
    .action-btn {
      padding: 24px 16px;
      background: var(--white);
      border: 2px solid var(--gray-300);
      cursor: pointer;
      text-align: center;
    }
    .action-btn:hover {
      border-color: var(--primary-blue);
      background: var(--light-blue);
    }
    .action-btn .icon { font-size: 32px; margin-bottom: 8px; }
    .action-btn .label {
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--gray-700);
    }

    /* Summary Card */
    .summary-card {
      background: var(--white);
      border: 2px solid var(--gray-300);
      padding: 20px;
    }
    .summary-card h3 {
      font-size: 14px;
      font-weight: 700;
      color: var(--gray-700);
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .summary-stat {
      display: flex;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid var(--gray-300);
    }
    .summary-stat:last-child { border-bottom: none; }
    .stat-label {
      font-size: 12px;
      color: var(--gray-500);
      text-transform: uppercase;
    }
    .stat-value {
      font-size: 18px;
      font-weight: 700;
      color: var(--gray-900);
    }
    .stat-value.good { color: var(--success); }
    .stat-value.warning { color: var(--warning); }

    /* Forms */
    .form-group { margin-bottom: 12px; }
    .form-group label {
      display: block;
      margin-bottom: 4px;
      font-weight: 700;
      font-size: 10px;
      color: var(--gray-700);
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .form-input, .form-select {
      width: 100%;
      padding: 12px 14px;
      border: 1px solid var(--gray-300);
      font-size: 14px;
      min-height: 44px;
      background: var(--white);
      color: var(--gray-900);
    }
    .form-input:focus, .form-select:focus {
      outline: none;
      border-color: var(--primary-blue);
      box-shadow: 0 0 0 2px rgba(0, 168, 225, 0.15);
    }
    .submit-btn {
      width: 100%;
      padding: 14px;
      background: var(--gray-100);
      color: var(--gray-900);
      border: none;
      font-size: 12px;
      font-weight: 700;
      cursor: pointer;
      margin-top: 12px;
      min-height: 44px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .submit-btn:hover { background: var(--gray-300); }
    .submit-btn.primary {
      background: var(--primary-blue);
      color: var(--white);
    }
    .submit-btn.primary:hover { background: var(--secondary-blue); }

    /* Items Table */
    .items-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 16px;
    }
    .items-table th {
      background: var(--gray-100);
      padding: 12px;
      text-align: left;
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--gray-700);
      border-bottom: 2px solid var(--gray-300);
    }
    .items-table td {
      padding: 12px;
      border-bottom: 1px solid var(--gray-300);
      font-size: 12px;
    }
    .items-table tr:hover { background: var(--light-blue); }
    .btn-small {
      padding: 6px 12px;
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      border: none;
      cursor: pointer;
      margin-right: 4px;
    }
    .btn-edit {
      background: var(--primary-blue);
      color: var(--white);
    }
    .btn-delete {
      background: var(--error);
      color: var(--white);
    }

    /* Spinner */
    .spinner {
      border: 3px solid var(--gray-300);
      border-top: 3px solid var(--primary-blue);
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @media (max-width: 768px) {
      .main-menu { grid-template-columns: 1fr 1fr; }
      .quick-actions { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>JAYNA GYRO</h1>
      <p>COST OF GOODS MANAGEMENT</p>
    </div>

    <div class="content">
      <!-- Navigation Buttons -->
      <div class="main-menu">
        <button class="menu-btn primary" onclick="window.location.href='index.html'">AM Count</button>
        <button class="menu-btn primary" onclick="window.location.href='index.html'">PM Close</button>
        <button class="menu-btn" onclick="window.location.href='index.html'">Generate Report</button>
        <button class="menu-btn" onclick="window.location.href='index.html'">Tip Pool</button>
        <button class="menu-btn" onclick="window.location.href='index.html'">Weekly Cashbox</button>
        <button class="menu-btn" onclick="window.location.href='manager.html'">Manager</button>
        <button class="menu-btn cogs">COGs</button>
      </div>

      <!-- Dashboard (default view) -->
      <div id="dashboard">
        <h2 style="margin-bottom: 20px; color: var(--gray-900); font-size: 18px; text-transform: uppercase;">Cost of Goods Sold</h2>

        <div class="quick-actions">
          <div class="action-btn" onclick="showManageItems()">
            <div class="icon">üè∑Ô∏è</div>
            <div class="label">Manage Items</div>
          </div>
          <div class="action-btn" onclick="showScanInvoice()">
            <div class="icon">üì∏</div>
            <div class="label">Scan Invoice</div>
          </div>
          <div class="action-btn" onclick="alert('Coming in Day 3: Camera-assisted counting')">
            <div class="icon">üì¶</div>
            <div class="label">Daily Count</div>
          </div>
          <div class="action-btn" onclick="showReports()">
            <div class="icon">üìä</div>
            <div class="label">View Reports</div>
          </div>
        </div>

        <!-- Order Alerts Card -->
        <div class="summary-card" style="margin-bottom: 16px; border: 2px solid var(--primary-blue);">
          <h3>üìã Order Alerts Today</h3>
          <div id="orderAlertsToday">
            <p style="text-align: center; color: var(--gray-500); padding: 20px;">Loading order alerts...</p>
          </div>
        </div>

        <!-- Summary Card -->
        <div class="summary-card">
          <h3>This Week Summary</h3>
          <div class="summary-stat">
            <span class="stat-label">Food Cost %</span>
            <span class="stat-value good">28.5%</span>
          </div>
          <div class="summary-stat">
            <span class="stat-label">COGs Total</span>
            <span class="stat-value">$12,450.00</span>
          </div>
          <div class="summary-stat">
            <span class="stat-label">Variance</span>
            <span class="stat-value warning">-$127.00</span>
          </div>
        </div>
      </div>

      <!-- Manage Items Section -->
      <div id="manageItems" style="display: none;">
        <h2 style="margin-bottom: 20px; color: var(--gray-900); font-size: 18px; text-transform: uppercase;">Inventory Items</h2>

        <button class="submit-btn primary" onclick="showAddItemForm()">+ Add New Item</button>

        <div class="form-group" style="margin-top: 16px;">
          <label for="categoryFilter">Filter by Category:</label>
          <select id="categoryFilter" class="form-select" onchange="filterItems()">
            <option value="">All Categories</option>
            <option value="PRODUCE">Produce</option>
            <option value="MEAT">Meat</option>
            <option value="GYROS">Gyros</option>
            <option value="BREADS">Breads</option>
            <option value="LIQUOR">Liquor</option>
            <option value="BEER">Beer</option>
            <option value="WINE">Wine</option>
            <option value="DAIRY">Dairy</option>
            <option value="NA DRINKS">NA Drinks</option>
            <option value="JUICES">Juices</option>
          </select>
        </div>

        <div id="itemsList" style="margin-top: 20px;">
          <p style="text-align: center; color: var(--gray-500); padding: 40px 0;">Loading items...</p>
        </div>

        <button class="submit-btn" onclick="showDashboard()">Back to Dashboard</button>
      </div>

      <!-- Add/Edit Item Form -->
      <div id="itemForm" style="display: none;">
        <h2 style="margin-bottom: 20px; color: var(--gray-900); font-size: 18px; text-transform: uppercase;" id="itemFormTitle">Add New Item</h2>

        <div class="form-group">
          <label for="itemName">Item Name*</label>
          <input type="text" id="itemName" class="form-input" required placeholder="e.g., Ground Beef 80/20">
        </div>

        <div class="form-group">
          <label for="itemCategory">Category*</label>
          <select id="itemCategory" class="form-select" required>
            <option value="">Select Category</option>
            <option value="PRODUCE">Produce</option>
            <option value="MEAT">Meat</option>
            <option value="GYROS">Gyros</option>
            <option value="BREADS">Breads</option>
            <option value="LIQUOR">Liquor</option>
            <option value="BEER">Beer</option>
            <option value="WINE">Wine</option>
            <option value="DAIRY">Dairy</option>
            <option value="NA DRINKS">NA Drinks</option>
            <option value="JUICES">Juices</option>
          </select>
        </div>

        <div class="form-group">
          <label for="itemUnit">Unit*</label>
          <input type="text" id="itemUnit" class="form-input" required placeholder="e.g., lb, case, each, oz, gal">
        </div>

        <div class="form-group">
          <label for="itemParLevel">Par Level</label>
          <input type="number" id="itemParLevel" class="form-input" step="0.01" placeholder="Ideal stock level">
        </div>

        <div class="form-group">
          <label for="itemCost">Current Cost per Unit</label>
          <input type="number" id="itemCost" class="form-input" step="0.01" placeholder="e.g., 5.99">
        </div>

        <div class="form-group">
          <label for="itemVendor">Primary Vendor</label>
          <input type="text" id="itemVendor" class="form-input" placeholder="e.g., Sysco Sacramento">
        </div>

        <div class="form-group">
          <label for="itemBarcode">Barcode/UPC (Optional)</label>
          <input type="text" id="itemBarcode" class="form-input" placeholder="For scanning beer/drinks">
        </div>

        <div class="form-group">
          <label for="itemFrequency">Count Frequency</label>
          <select id="itemFrequency" class="form-select">
            <option value="daily">Daily</option>
            <option value="weekly" selected>Weekly</option>
            <option value="monthly">Monthly</option>
          </select>
        </div>

        <button class="submit-btn primary" onclick="saveItem()">Save Item</button>
        <button class="submit-btn" onclick="showManageItems()">Cancel</button>
      </div>

      <!-- Scan Invoice Section -->
      <div id="scanInvoice" style="display: none;">
        <h2 style="margin-bottom: 20px; color: var(--gray-900); font-size: 18px; text-transform: uppercase;">Scan Invoice</h2>

        <p style="margin-bottom: 16px; padding: 12px; background: var(--light-blue); border-left: 3px solid var(--primary-blue); font-size: 12px;">
          üìÑ Upload your invoices (photo or PDF). The system will automatically detect vendors from each page.
        </p>

        <!-- File Upload -->
        <div class="form-group">
          <label for="invoiceFile">Upload Invoice (Photo or PDF)*</label>
          <input type="file" id="invoiceFile" class="form-input" accept="image/*,application/pdf" capture="environment">
          <p style="font-size: 11px; color: var(--gray-500); margin-top: 4px;">Supported: Photos (JPG, PNG) or PDF files with multiple invoices</p>
        </div>

        <!-- Invoice Preview -->
        <div id="invoicePreview" style="display: none; margin-top: 16px;">
          <img id="previewImage" style="width: 100%; max-height: 400px; object-fit: contain; border: 2px solid var(--gray-300);">
        </div>

        <!-- OCR Processing Status -->
        <div id="ocrStatus" style="display: none; margin-top: 16px; padding: 16px; background: var(--light-blue); border: 2px solid var(--primary-blue);">
          <div style="display: flex; align-items: center; gap: 12px;">
            <div class="spinner"></div>
            <div>
              <strong>Processing Invoice...</strong>
              <p id="ocrProgress" style="font-size: 12px; color: var(--gray-700); margin-top: 4px;">Initializing OCR...</p>
            </div>
          </div>
        </div>

        <!-- Extracted Data Review -->
        <div id="extractedData" style="display: none; margin-top: 20px;">
          <h3 style="font-size: 14px; font-weight: 700; margin-bottom: 12px; color: var(--success);">‚úì Invoice Extracted</h3>

          <div class="form-group">
            <label for="extractedVendor">Vendor Name</label>
            <input type="text" id="extractedVendor" class="form-input" placeholder="Auto-detected vendor">
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <div class="form-group">
              <label for="extractedDate">Invoice Date</label>
              <input type="date" id="extractedDate" class="form-input">
            </div>
            <div class="form-group">
              <label for="extractedInvoiceNumber">Invoice #</label>
              <input type="text" id="extractedInvoiceNumber" class="form-input" placeholder="Invoice number">
            </div>
          </div>

          <div class="form-group">
            <label for="extractedTotal">Total Amount</label>
            <input type="number" id="extractedTotal" class="form-input" step="0.01" placeholder="0.00">
          </div>

          <!-- Extracted Items Table -->
          <div class="form-group">
            <label>Extracted Items</label>
            <div id="extractedItemsList" style="margin-top: 8px; max-height: 300px; overflow-y: auto; border: 2px solid var(--gray-300); padding: 12px;">
              <p style="text-align: center; color: var(--gray-500);">No items extracted yet</p>
            </div>
          </div>

          <!-- Raw OCR Text (for debugging) -->
          <details style="margin-top: 16px;">
            <summary style="cursor: pointer; font-size: 12px; color: var(--gray-500);">View Raw OCR Text</summary>
            <textarea id="rawOcrText" readonly style="width: 100%; min-height: 200px; margin-top: 8px; font-family: monospace; font-size: 11px; padding: 12px; border: 1px solid var(--gray-300);"></textarea>
          </details>
        </div>

        <div style="margin-top: 20px;">
          <button class="submit-btn primary" onclick="processInvoice()" id="processBtn">Process Invoice</button>
          <button class="submit-btn primary" onclick="saveInvoice()" id="saveInvoiceBtn" style="display: none;">Save to Database</button>
          <button class="submit-btn" onclick="showDashboard()">Cancel</button>
        </div>
      </div>

      <!-- Reports Section -->
      <div id="reportsView" style="display: none;">
        <h2 style="margin-bottom: 20px; color: var(--gray-900); font-size: 18px; text-transform: uppercase;">Invoice Analysis & Reports</h2>

        <!-- Date Range Filter -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
          <div class="form-group">
            <label for="reportStartDate">From</label>
            <input type="date" id="reportStartDate" class="form-input">
          </div>
          <div class="form-group">
            <label for="reportEndDate">To</label>
            <input type="date" id="reportEndDate" class="form-input">
          </div>
        </div>

        <button class="submit-btn primary" onclick="loadReports()">Generate Report</button>

        <!-- Report Results -->
        <div id="reportResults" style="display: none; margin-top: 20px;">
          <!-- Spending Overview -->
          <div class="summary-card" style="margin-bottom: 16px;">
            <h3>Spending Overview</h3>
            <div id="spendingOverview"></div>
          </div>

          <!-- Vendor Breakdown -->
          <div class="summary-card" style="margin-bottom: 16px;">
            <h3>Vendor Breakdown</h3>
            <div id="vendorBreakdown"></div>
          </div>

          <!-- Ordering Frequency -->
          <div class="summary-card" style="margin-bottom: 16px;">
            <h3>Ordering Frequency</h3>
            <div id="orderingFrequency"></div>
          </div>

          <!-- Suggested Orders -->
          <div class="summary-card">
            <h3>Suggested Orders (Based on Par Levels)</h3>
            <div id="suggestedOrders"></div>
          </div>
        </div>

        <button class="submit-btn" onclick="showDashboard()" style="margin-top: 16px;">Back to Dashboard</button>
      </div>
    </div>
  </div>

  <!-- Add Vendor Modal -->
  <div id="addVendorModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 1000; overflow-y: auto;">
    <div style="max-width: 500px; margin: 40px auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);">
      <h3 style="margin-bottom: 16px; color: var(--gray-900); font-size: 16px;">Add New Vendor</h3>

      <div class="form-group">
        <label for="newVendorName">Vendor Name*</label>
        <input type="text" id="newVendorName" class="form-input" readonly style="background: var(--gray-100);">
      </div>

      <div class="form-group">
        <label>Order Days (Select all that apply)</label>
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 8px;">
          <label style="display: flex; align-items: center; gap: 4px; font-size: 12px;">
            <input type="checkbox" id="orderDay_Monday" value="Monday"> Monday
          </label>
          <label style="display: flex; align-items: center; gap: 4px; font-size: 12px;">
            <input type="checkbox" id="orderDay_Tuesday" value="Tuesday"> Tuesday
          </label>
          <label style="display: flex; align-items: center; gap: 4px; font-size: 12px;">
            <input type="checkbox" id="orderDay_Wednesday" value="Wednesday"> Wednesday
          </label>
          <label style="display: flex; align-items: center; gap: 4px; font-size: 12px;">
            <input type="checkbox" id="orderDay_Thursday" value="Thursday"> Thursday
          </label>
          <label style="display: flex; align-items: center; gap: 4px; font-size: 12px;">
            <input type="checkbox" id="orderDay_Friday" value="Friday"> Friday
          </label>
          <label style="display: flex; align-items: center; gap: 4px; font-size: 12px;">
            <input type="checkbox" id="orderDay_Saturday" value="Saturday"> Saturday
          </label>
        </div>
      </div>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
        <div class="form-group">
          <label for="newVendorCutoffTime">Order Cutoff Time</label>
          <input type="text" id="newVendorCutoffTime" class="form-input" placeholder="e.g., 3:00 PM">
        </div>
        <div class="form-group">
          <label for="newVendorMethod">Order Method*</label>
          <select id="newVendorMethod" class="form-select">
            <option value="">Select...</option>
            <option value="text">Text</option>
            <option value="online">Online</option>
            <option value="phone">Phone</option>
            <option value="email">Email</option>
          </select>
        </div>
      </div>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
        <div class="form-group">
          <label for="newVendorRepName">Rep Name</label>
          <input type="text" id="newVendorRepName" class="form-input" placeholder="Contact person">
        </div>
        <div class="form-group">
          <label for="newVendorRepPhone">Rep Phone</label>
          <input type="tel" id="newVendorRepPhone" class="form-input" placeholder="(555) 555-5555">
        </div>
      </div>

      <div class="form-group">
        <label for="newVendorNotes">Special Notes</label>
        <textarea id="newVendorNotes" class="form-input" rows="3" placeholder="Any special ordering instructions, delivery notes, etc."></textarea>
      </div>

      <div style="display: flex; gap: 8px; margin-top: 20px;">
        <button class="submit-btn primary" onclick="saveNewVendor()" style="flex: 1;">Save Vendor</button>
        <button class="submit-btn" onclick="closeAddVendorModal()" style="flex: 1;">Cancel</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
  <script>
    // Configure PDF.js
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js';
  </script>

  <script>
    // Supabase
    const SUPABASE_URL = 'https://gaawtbqpnnbbnsyswqwv.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdhYXd0YnFwbm5iYm5zeXN3cXd2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1MDE1NTAsImV4cCI6MjA3MjA3NzU1MH0.F-y7AIQTWaUe7DRT4OnIZVn94mhXxfhpBbng2aJ8nXg';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let currentEditingId = null;
    let currentInvoiceIndexForVendor = null; // Track which invoice is adding a vendor

    // Simple navigation
    function showDashboard() {
      document.getElementById('dashboard').style.display = 'block';
      document.getElementById('manageItems').style.display = 'none';
      document.getElementById('itemForm').style.display = 'none';
      document.getElementById('scanInvoice').style.display = 'none';
      document.getElementById('reportsView').style.display = 'none';

      // Load order alerts
      loadOrderAlerts();
    }

    function showReports() {
      document.getElementById('dashboard').style.display = 'none';
      document.getElementById('manageItems').style.display = 'none';
      document.getElementById('itemForm').style.display = 'none';
      document.getElementById('scanInvoice').style.display = 'none';
      document.getElementById('reportsView').style.display = 'block';

      // Set default date range (last 30 days)
      const endDate = new Date();
      const startDate = new Date();
      startDate.setDate(startDate.getDate() - 30);

      document.getElementById('reportEndDate').value = endDate.toISOString().split('T')[0];
      document.getElementById('reportStartDate').value = startDate.toISOString().split('T')[0];
    }

    async function loadReports() {
      const startDate = document.getElementById('reportStartDate').value;
      const endDate = document.getElementById('reportEndDate').value;

      if (!startDate || !endDate) {
        alert('Please select date range');
        return;
      }

      try {
        // Call invoice analysis API
        const response = await fetch('/api/analyze-invoices', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ startDate, endDate })
        });

        const data = await response.json();

        if (!data.success) throw new Error('Failed to load report');

        // Display results
        displaySpendingOverview(data.analysis);
        displayVendorBreakdown(data.analysis);
        displayOrderingFrequency(data.analysis);
        displaySuggestedOrders(data.suggestions);

        document.getElementById('reportResults').style.display = 'block';

      } catch (error) {
        console.error('Error loading reports:', error);
        alert('Error loading reports: ' + error.message);
      }
    }

    function displaySpendingOverview(analysis) {
      const container = document.getElementById('spendingOverview');

      const html = `
        <div class="summary-stat">
          <span class="stat-label">Total Invoices</span>
          <span class="stat-value">${analysis.totalInvoices}</span>
        </div>
        <div class="summary-stat">
          <span class="stat-label">Total Spent</span>
          <span class="stat-value">$${analysis.totalSpent.toFixed(2)}</span>
        </div>
        <div class="summary-stat">
          <span class="stat-label">Average Invoice</span>
          <span class="stat-value">$${analysis.averageInvoiceAmount.toFixed(2)}</span>
        </div>
        <div class="summary-stat">
          <span class="stat-label">Date Range</span>
          <span class="stat-value" style="font-size: 12px;">${analysis.dateRange.start} to ${analysis.dateRange.end}</span>
        </div>
      `;

      container.innerHTML = html;
    }

    function displayVendorBreakdown(analysis) {
      const container = document.getElementById('vendorBreakdown');

      let html = '<table class="items-table" style="font-size: 12px;"><thead><tr>';
      html += '<th>Vendor</th><th>Orders</th><th>Total</th><th>Avg</th></tr></thead><tbody>';

      Object.keys(analysis.vendorBreakdown).forEach(vendor => {
        const data = analysis.vendorBreakdown[vendor];
        const avg = data.totalSpent / data.count;

        html += `<tr>
          <td><strong>${vendor}</strong></td>
          <td>${data.count}</td>
          <td>$${data.totalSpent.toFixed(2)}</td>
          <td>$${avg.toFixed(2)}</td>
        </tr>`;
      });

      html += '</tbody></table>';
      container.innerHTML = html;
    }

    function displayOrderingFrequency(analysis) {
      const container = document.getElementById('orderingFrequency');

      if (!analysis.frequencyByVendor || Object.keys(analysis.frequencyByVendor).length === 0) {
        container.innerHTML = '<p style="text-align: center; color: var(--gray-500);">Not enough data to calculate frequency</p>';
        return;
      }

      let html = '<table class="items-table" style="font-size: 12px;"><thead><tr>';
      html += '<th>Vendor</th><th>Avg Days Between Orders</th><th>Total Orders</th></tr></thead><tbody>';

      Object.keys(analysis.frequencyByVendor).forEach(vendor => {
        const freq = analysis.frequencyByVendor[vendor];

        html += `<tr>
          <td><strong>${vendor}</strong></td>
          <td>${freq.averageDaysBetweenOrders} days</td>
          <td>${freq.orderCount}</td>
        </tr>`;
      });

      html += '</tbody></table>';
      container.innerHTML = html;
    }

    function displaySuggestedOrders(suggestions) {
      const container = document.getElementById('suggestedOrders');

      if (!suggestions || suggestions.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: var(--gray-500);">No suggestions available. Set par levels for items.</p>';
        return;
      }

      // Filter to only show items that need ordering
      const needsOrder = suggestions.filter(s => s.suggestedOrderQty > 0);

      if (needsOrder.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: var(--success);">‚úì All items at or above par level</p>';
        return;
      }

      let html = '<table class="items-table" style="font-size: 11px;"><thead><tr>';
      html += '<th>Item</th><th>Current</th><th>Par</th><th>Order Qty</th><th>Urgency</th></tr></thead><tbody>';

      needsOrder.forEach(item => {
        const urgencyColor = item.urgency === 'critical' ? 'var(--error)' :
                            item.urgency === 'high' ? 'var(--warning)' :
                            'var(--gray-500)';

        html += `<tr>
          <td><strong>${item.itemName}</strong><br><span style="font-size: 10px; color: var(--gray-500);">${item.category}</span></td>
          <td>${item.currentStock}</td>
          <td>${item.parLevel}</td>
          <td><strong>${item.suggestedOrderQty}</strong></td>
          <td><span style="color: ${urgencyColor}; font-weight: bold;">${item.urgency.toUpperCase()}</span></td>
        </tr>`;
      });

      html += '</tbody></table>';
      container.innerHTML = html;
    }

    async function loadOrderAlerts() {
      try {
        const response = await fetch('/api/get-order-alerts');
        const data = await response.json();

        if (!data.success) throw new Error('Failed to load alerts');

        const container = document.getElementById('orderAlertsToday');

        if (!data.todayAlerts || data.todayAlerts.length === 0) {
          container.innerHTML = `
            <p style="text-align: center; color: var(--success); padding: 20px;">
              ‚úì No orders due today
            </p>
          `;
          return;
        }

        let html = '';
        data.todayAlerts.forEach(alert => {
          const urgencyColor = alert.priority === 'high' ? 'var(--error)' :
                               alert.priority === 'normal' ? 'var(--warning)' :
                               'var(--gray-500)';

          const timeWarning = alert.timeUntilCutoff !== null && alert.timeUntilCutoff < 2 ?
            ` ‚ö†Ô∏è ${Math.floor(alert.timeUntilCutoff * 60)}min left!` : '';

          html += `
            <div style="padding: 12px; border-bottom: 1px solid var(--gray-300); background: ${alert.priority === 'high' ? 'var(--light-blue)' : 'transparent'};">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <strong style="color: ${urgencyColor};">${alert.vendorName}</strong>
                  <p style="font-size: 11px; color: var(--gray-600); margin-top: 2px;">
                    ${alert.orderMethod === 'text' ? 'üì± Text' : alert.orderMethod === 'online' ? 'üåê Online' : 'üìû Phone'}
                    ‚Ä¢ Cutoff: ${alert.cutoffTime}${timeWarning}
                  </p>
                  ${alert.specialNotes ? `<p style="font-size: 10px; color: var(--gray-500); margin-top: 4px;">${alert.specialNotes}</p>` : ''}
                </div>
                <button onclick="startOrder('${alert.vendorName}', ${alert.vendorId})"
                        style="padding: 6px 12px; background: var(--primary-blue); color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer;">
                  Order
                </button>
              </div>
            </div>
          `;
        });

        // Add upcoming orders
        if (data.upcomingAlerts && data.upcomingAlerts.length > 0) {
          html += '<div style="margin-top: 12px; padding-top: 12px; border-top: 2px solid var(--gray-300);"><strong style="font-size: 12px; color: var(--gray-600);">Upcoming:</strong></div>';

          const upcomingByDay = {};
          data.upcomingAlerts.forEach(alert => {
            if (!upcomingByDay[alert.dayName]) {
              upcomingByDay[alert.dayName] = [];
            }
            upcomingByDay[alert.dayName].push(alert);
          });

          Object.keys(upcomingByDay).forEach(day => {
            const vendors = upcomingByDay[day].map(a => a.vendorName).join(', ');
            html += `<p style="font-size: 11px; color: var(--gray-600); margin-top: 4px;">${day}: ${vendors}</p>`;
          });
        }

        container.innerHTML = html;

      } catch (error) {
        console.error('Error loading order alerts:', error);
        document.getElementById('orderAlertsToday').innerHTML =
          '<p style="text-align: center; color: var(--error); padding: 20px;">Error loading alerts</p>';
      }
    }

    function startOrder(vendorName, vendorId) {
      alert(`Order workflow for ${vendorName} coming soon!\n\nWill show:\n- Suggested order quantities\n- Last order history\n- Quick order form`);
      // TODO: Implement order workflow
    }

    // Load alerts on page load
    window.addEventListener('DOMContentLoaded', () => {
      if (document.getElementById('dashboard').style.display !== 'none') {
        loadOrderAlerts();
      }
    });

    function showManageItems() {
      document.getElementById('dashboard').style.display = 'none';
      document.getElementById('manageItems').style.display = 'block';
      document.getElementById('itemForm').style.display = 'none';
      loadItems();
    }

    function showAddItemForm() {
      currentEditingId = null;
      document.getElementById('itemFormTitle').textContent = 'Add New Item';
      document.getElementById('itemName').value = '';
      document.getElementById('itemCategory').value = '';
      document.getElementById('itemUnit').value = '';
      document.getElementById('itemParLevel').value = '';
      document.getElementById('itemCost').value = '';
      document.getElementById('itemVendor').value = '';
      document.getElementById('itemBarcode').value = '';
      document.getElementById('itemFrequency').value = 'weekly';

      document.getElementById('dashboard').style.display = 'none';
      document.getElementById('manageItems').style.display = 'none';
      document.getElementById('itemForm').style.display = 'block';
    }

    let knownVendors = []; // Will load from database

    async function showScanInvoice() {
      document.getElementById('dashboard').style.display = 'none';
      document.getElementById('manageItems').style.display = 'none';
      document.getElementById('itemForm').style.display = 'none';
      document.getElementById('scanInvoice').style.display = 'block';

      // Load known vendors for auto-detection
      await loadKnownVendors();

      // Setup file input listener
      const fileInput = document.getElementById('invoiceFile');
      fileInput.removeEventListener('change', handleFileSelect); // Remove old listener
      fileInput.addEventListener('change', handleFileSelect);
    }

    async function loadKnownVendors() {
      try {
        const { data, error } = await supabase
          .from('vendors')
          .select('*')
          .eq('active', true)
          .order('vendor_name');

        if (error) throw error;

        knownVendors = data;
      } catch (error) {
        console.error('Error loading vendors:', error);
        knownVendors = [];
      }
    }

    let currentInvoiceFile = null;
    let currentOcrText = '';
    let extractedInvoices = []; // Array to hold multiple invoices from PDF

    function handleFileSelect(event) {
      const file = event.target.files[0];
      if (!file) return;

      currentInvoiceFile = file;

      // Check if PDF
      const isPDF = file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf');

      if (isPDF) {
        // Show PDF info instead of image preview
        document.getElementById('invoicePreview').innerHTML = `
          <div style="padding: 20px; background: var(--light-blue); border: 2px solid var(--primary-blue); text-align: center;">
            <p style="font-size: 16px; font-weight: bold; color: var(--primary-blue);">üìÑ PDF Uploaded</p>
            <p style="font-size: 12px; color: var(--gray-700); margin-top: 8px;">${file.name}</p>
            <p style="font-size: 11px; color: var(--gray-600); margin-top: 4px;">Click "Process Invoice" to extract all invoices from this PDF</p>
          </div>
        `;
        document.getElementById('invoicePreview').style.display = 'block';
      } else {
        // Show image preview for photos
        const reader = new FileReader();
        reader.onload = (e) => {
          document.getElementById('previewImage').src = e.target.result;
          document.getElementById('invoicePreview').style.display = 'block';
        };
        reader.readAsDataURL(file);
      }
    }

    async function processInvoice() {
      if (!currentInvoiceFile) {
        alert('Please select an invoice file first');
        return;
      }

      try {
        // Show processing status
        document.getElementById('ocrStatus').style.display = 'block';
        document.getElementById('processBtn').disabled = true;

        const isPDF = currentInvoiceFile.type === 'application/pdf' ||
                     currentInvoiceFile.name.toLowerCase().endsWith('.pdf');

        if (isPDF) {
          await processPDFInvoices();
        } else {
          await processSingleImageInvoice();
        }

      } catch (error) {
        console.error('OCR Error:', error);
        alert('Error processing invoice: ' + error.message);
        document.getElementById('ocrStatus').style.display = 'none';
        document.getElementById('processBtn').disabled = false;
      }
    }

    async function processPDFInvoices() {
      document.getElementById('ocrProgress').textContent = 'Loading PDF...';

      // Read PDF file
      const arrayBuffer = await currentInvoiceFile.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;

      const totalPages = pdf.numPages;
      document.getElementById('ocrProgress').textContent = `Found ${totalPages} pages in PDF`;

      extractedInvoices = [];

      // Process each page
      for (let pageNum = 1; pageNum <= totalPages; pageNum++) {
        document.getElementById('ocrProgress').textContent =
          `Processing page ${pageNum} of ${totalPages}...`;

        const page = await pdf.getPage(pageNum);

        // Render page to canvas
        const scale = 2.0; // Higher scale for better OCR
        const viewport = page.getViewport({ scale });

        const canvas = document.createElement('canvas');
        const context = canvas.getContext('2d');
        canvas.height = viewport.height;
        canvas.width = viewport.width;

        await page.render({
          canvasContext: context,
          viewport: viewport
        }).promise;

        // Run OCR on canvas
        document.getElementById('ocrProgress').textContent =
          `Reading text from page ${pageNum}... 0%`;

        const result = await Tesseract.recognize(
          canvas,
          'eng',
          {
            logger: (m) => {
              if (m.status === 'recognizing text') {
                document.getElementById('ocrProgress').textContent =
                  `Reading text from page ${pageNum}... ${Math.round(m.progress * 100)}%`;
              }
            }
          }
        );

        const ocrText = result.data.text;

        // Parse invoice data
        const parsedData = parseInvoiceText(ocrText);
        const detectedVendor = detectVendorName(ocrText);

        // Store invoice with page number
        extractedInvoices.push({
          pageNumber: pageNum,
          ocrText: ocrText,
          vendorName: detectedVendor.name,
          vendorId: detectedVendor.id,
          isKnownVendor: detectedVendor.isKnown,
          date: parsedData.date || '',
          invoiceNumber: parsedData.invoiceNumber || '',
          subtotal: parsedData.subtotal || 0,
          tax: parsedData.tax || 0,
          deliveryFee: parsedData.deliveryFee || 0,
          driverFee: parsedData.driverFee || 0,
          total: parsedData.total || 0,
          items: parsedData.items || []
        });
      }

      // Display all extracted invoices
      displayMultipleInvoices();

      document.getElementById('ocrStatus').style.display = 'none';
      document.getElementById('extractedData').style.display = 'block';
      document.getElementById('processBtn').style.display = 'none';
      document.getElementById('saveInvoiceBtn').style.display = 'block';
      document.getElementById('saveInvoiceBtn').textContent = `Save All ${extractedInvoices.length} Invoices`;
    }

    async function processSingleImageInvoice() {
      document.getElementById('ocrProgress').textContent = 'Loading OCR engine...';

      const result = await Tesseract.recognize(
        currentInvoiceFile,
        'eng',
        {
          logger: (m) => {
            if (m.status === 'recognizing text') {
              document.getElementById('ocrProgress').textContent = `Recognizing text... ${Math.round(m.progress * 100)}%`;
            }
          }
        }
      );

      currentOcrText = result.data.text;
      document.getElementById('ocrProgress').textContent = 'Parsing invoice data...';

      const parsedData = parseInvoiceText(currentOcrText);
      const detectedVendor = detectVendorName(currentOcrText);

      extractedInvoices = [{
        pageNumber: 1,
        ocrText: currentOcrText,
        vendorName: detectedVendor.name,
        vendorId: detectedVendor.id,
        isKnownVendor: detectedVendor.isKnown,
        date: parsedData.date || '',
        invoiceNumber: parsedData.invoiceNumber || '',
        subtotal: parsedData.subtotal || 0,
        tax: parsedData.tax || 0,
        deliveryFee: parsedData.deliveryFee || 0,
        driverFee: parsedData.driverFee || 0,
        total: parsedData.total || 0,
        items: parsedData.items || []
      }];

      displayMultipleInvoices();

      document.getElementById('ocrStatus').style.display = 'none';
      document.getElementById('extractedData').style.display = 'block';
      document.getElementById('processBtn').style.display = 'none';
      document.getElementById('saveInvoiceBtn').style.display = 'block';
    }

    function detectVendorName(text) {
      // Check against known vendors from database
      for (const vendor of knownVendors) {
        // Create flexible pattern from vendor name
        const vendorWords = vendor.vendor_name.split(' ').filter(w => w.length > 2);
        const pattern = new RegExp(vendorWords.join('\\s*'), 'i');

        if (pattern.test(text)) {
          return {
            name: vendor.vendor_name,
            id: vendor.id,
            isKnown: true
          };
        }
      }

      // Try to extract any company name from the invoice (usually at top)
      const lines = text.split('\n').slice(0, 10); // Check first 10 lines
      for (const line of lines) {
        // Look for company-like patterns (2-4 words, capitalized)
        const companyPattern = /([A-Z][a-z]+(?:\s+[A-Z][a-z]+){1,3}(?:\s+(?:Inc|LLC|Corp|Co|Ltd|Company|Foods?|Service|Market|Imports?))?)/.exec(line);
        if (companyPattern) {
          return {
            name: companyPattern[1],
            id: null,
            isKnown: false
          };
        }
      }

      return {
        name: '',
        id: null,
        isKnown: false
      };
    }

    function parseInvoiceText(text) {
      const lines = text.split('\n').filter(line => line.trim());

      const result = {
        vendorName: '',
        date: '',
        invoiceNumber: '',
        subtotal: 0,
        tax: 0,
        deliveryFee: 0,
        driverFee: 0,
        total: 0,
        items: []
      };

      // Date patterns (multiple formats)
      const datePatterns = [
        /(\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4})/,
        /(\d{4}[\/\-]\d{1,2}[\/\-]\d{1,2})/,
        /(?:date|dated)[:\s]*(\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4})/i
      ];

      // Invoice number patterns
      const invoicePatterns = [
        /inv(?:oice)?[#:\s]*([A-Z0-9\-]+)/i,
        /#\s*([A-Z0-9\-]+)/i,
        /invoice\s*(?:number|no|#)[:\s]*([A-Z0-9\-]+)/i,
        /order[:\s#]*([A-Z0-9\-]+)/i
      ];

      // Money extraction patterns
      const subtotalPatterns = [
        /sub\s*total[:\s]*\$?\s*([\d,]+\.?\d*)/i,
        /subtotal[:\s]*\$?\s*([\d,]+\.?\d*)/i
      ];

      const taxPatterns = [
        /tax[:\s]*\$?\s*([\d,]+\.?\d*)/i,
        /sales\s*tax[:\s]*\$?\s*([\d,]+\.?\d*)/i
      ];

      const deliveryPatterns = [
        /delivery\s*(?:fee|charge)?[:\s]*\$?\s*([\d,]+\.?\d*)/i,
        /shipping[:\s]*\$?\s*([\d,]+\.?\d*)/i
      ];

      const driverPatterns = [
        /driver\s*(?:fee|tip)?[:\s]*\$?\s*([\d,]+\.?\d*)/i,
        /gratuity[:\s]*\$?\s*([\d,]+\.?\d*)/i
      ];

      const totalPatterns = [
        /(?:total|amount|balance)\s*(?:due)?[:\s]*\$?\s*([\d,]+\.?\d*)/i,
        /grand\s*total[:\s]*\$?\s*([\d,]+\.?\d*)/i
      ];

      // Parse each line
      lines.forEach((line, index) => {
        // Date
        if (!result.date) {
          for (const pattern of datePatterns) {
            const match = line.match(pattern);
            if (match) {
              result.date = parseDate(match[1]);
              break;
            }
          }
        }

        // Invoice number
        if (!result.invoiceNumber) {
          for (const pattern of invoicePatterns) {
            const match = line.match(pattern);
            if (match) {
              result.invoiceNumber = match[1];
              break;
            }
          }
        }

        // Subtotal
        if (!result.subtotal) {
          for (const pattern of subtotalPatterns) {
            const match = line.match(pattern);
            if (match) {
              result.subtotal = parseFloat(match[1].replace(/,/g, ''));
              break;
            }
          }
        }

        // Tax
        if (!result.tax) {
          for (const pattern of taxPatterns) {
            const match = line.match(pattern);
            if (match) {
              result.tax = parseFloat(match[1].replace(/,/g, ''));
              break;
            }
          }
        }

        // Delivery fee
        if (!result.deliveryFee) {
          for (const pattern of deliveryPatterns) {
            const match = line.match(pattern);
            if (match) {
              result.deliveryFee = parseFloat(match[1].replace(/,/g, ''));
              break;
            }
          }
        }

        // Driver fee
        if (!result.driverFee) {
          for (const pattern of driverPatterns) {
            const match = line.match(pattern);
            if (match) {
              result.driverFee = parseFloat(match[1].replace(/,/g, ''));
              break;
            }
          }
        }

        // Total (look for this last to avoid catching subtotals)
        const totalMatch = line.match(/(?:total|amount|balance)\s*(?:due)?[:\s]*\$?\s*([\d,]+\.?\d*)/i);
        if (totalMatch) {
          const amount = parseFloat(totalMatch[1].replace(/,/g, ''));
          if (amount > result.total) {
            result.total = amount;
          }
        }

        // Line items - flexible pattern for different invoice formats
        const itemPatterns = [
          // Pattern 1: Description Qty Price
          /^(.{10,}?)\s+(\d+\.?\d*)\s+\$?\s*([\d,]+\.?\d*)$/,
          // Pattern 2: Qty Description Price
          /^(\d+\.?\d*)\s+(.{10,}?)\s+\$?\s*([\d,]+\.?\d*)$/,
          // Pattern 3: Description Price (no qty)
          /^(.{15,}?)\s+\$?\s*([\d,]+\.?\d*)$/
        ];

        for (const pattern of itemPatterns) {
          const match = line.match(pattern);
          if (match && !line.toLowerCase().includes('total') &&
              !line.toLowerCase().includes('tax') &&
              !line.toLowerCase().includes('delivery') &&
              !line.toLowerCase().includes('subtotal')) {

            const item = {};

            if (pattern === itemPatterns[0]) {
              // Pattern 1
              item.description = match[1].trim();
              item.quantity = parseFloat(match[2]);
              item.price = parseFloat(match[3].replace(/,/g, ''));
            } else if (pattern === itemPatterns[1]) {
              // Pattern 2
              item.quantity = parseFloat(match[1]);
              item.description = match[2].trim();
              item.price = parseFloat(match[3].replace(/,/g, ''));
            } else {
              // Pattern 3 (no qty)
              item.description = match[1].trim();
              item.quantity = 1;
              item.price = parseFloat(match[2].replace(/,/g, ''));
            }

            // Only add if price seems reasonable (not a date or something else)
            if (item.price > 0 && item.price < 10000) {
              result.items.push(item);
            }
            break;
          }
        }
      });

      return result;
    }

    function parseDate(dateStr) {
      // Convert various date formats to YYYY-MM-DD
      const parts = dateStr.split(/[\/\-]/);
      if (parts.length === 3) {
        let year, month, day;

        if (parts[0].length === 4) {
          // YYYY-MM-DD or YYYY-DD-MM
          year = parts[0];
          month = parts[1].padStart(2, '0');
          day = parts[2].padStart(2, '0');
        } else {
          // MM-DD-YYYY or DD-MM-YYYY (assume MM-DD-YYYY for US)
          month = parts[0].padStart(2, '0');
          day = parts[1].padStart(2, '0');
          year = parts[2].length === 2 ? '20' + parts[2] : parts[2];
        }

        return `${year}-${month}-${day}`;
      }
      return '';
    }

    function displayMultipleInvoices() {
      const container = document.getElementById('extractedItemsList');

      if (!extractedInvoices || extractedInvoices.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: var(--gray-500);">No invoices extracted.</p>';
        return;
      }

      let html = `<div style="margin-bottom: 16px; padding: 12px; background: var(--light-blue); border: 2px solid var(--primary-blue);">
        <strong>‚úì Found ${extractedInvoices.length} invoice${extractedInvoices.length > 1 ? 's' : ''} in this file</strong>
      </div>`;

      extractedInvoices.forEach((invoice, index) => {
        const hasData = invoice.date || invoice.invoiceNumber || invoice.vendorName;

        html += `
          <div style="margin-bottom: 24px; padding: 16px; border: 2px solid var(--gray-300); background: white;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
              <strong style="font-size: 14px;">Invoice ${index + 1} ${invoice.pageNumber ? `(Page ${invoice.pageNumber})` : ''}</strong>
              <span style="font-size: 12px; color: ${hasData ? 'var(--success)' : 'var(--warning)'};">
                ${hasData ? '‚úì Data Found' : '‚ö†Ô∏è Review Needed'}
              </span>
            </div>

            <!-- Editable fields for this invoice -->
            <div class="form-group">
              <label>Vendor ${invoice.isKnownVendor ? '<span style="color: var(--success);">‚úì Recognized</span>' : '<span style="color: var(--warning);">‚ö†Ô∏è Unknown</span>'}</label>
              <div style="display: flex; gap: 8px; align-items: center;">
                <input type="text" class="form-input" value="${invoice.vendorName || ''}"
                       onchange="extractedInvoices[${index}].vendorName = this.value; extractedInvoices[${index}].isKnownVendor = false;"
                       placeholder="${invoice.vendorName ? 'Edit if needed' : 'Enter vendor name'}"
                       style="flex: 1;">
                ${!invoice.isKnownVendor && invoice.vendorName ? `
                  <button type="button" class="submit-btn primary"
                          onclick="showAddVendorModal(${index})"
                          style="width: auto; padding: 8px 16px; margin: 0; font-size: 11px;">
                    + Add Vendor
                  </button>
                ` : ''}
              </div>
              ${!invoice.isKnownVendor && invoice.vendorName ? `
                <p style="font-size: 10px; color: var(--warning); margin-top: 4px;">
                  This vendor is not in the system. Click "+ Add Vendor" to set up ordering details.
                </p>
              ` : ''}
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
              <div class="form-group">
                <label>Invoice Date*</label>
                <input type="date" class="form-input" value="${invoice.date || ''}"
                       onchange="extractedInvoices[${index}].date = this.value">
              </div>
              <div class="form-group">
                <label>Invoice #</label>
                <input type="text" class="form-input" value="${invoice.invoiceNumber || ''}"
                       onchange="extractedInvoices[${index}].invoiceNumber = this.value">
              </div>
            </div>

            <!-- Financial breakdown -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 12px;">
              <div class="form-group">
                <label>Subtotal</label>
                <input type="number" class="form-input" value="${invoice.subtotal || ''}" step="0.01"
                       onchange="extractedInvoices[${index}].subtotal = parseFloat(this.value) || 0">
              </div>
              <div class="form-group">
                <label>Tax</label>
                <input type="number" class="form-input" value="${invoice.tax || ''}" step="0.01"
                       onchange="extractedInvoices[${index}].tax = parseFloat(this.value) || 0">
              </div>
              <div class="form-group">
                <label>Delivery Fee</label>
                <input type="number" class="form-input" value="${invoice.deliveryFee || ''}" step="0.01"
                       onchange="extractedInvoices[${index}].deliveryFee = parseFloat(this.value) || 0">
              </div>
              <div class="form-group">
                <label>Driver Fee/Tip</label>
                <input type="number" class="form-input" value="${invoice.driverFee || ''}" step="0.01"
                       onchange="extractedInvoices[${index}].driverFee = parseFloat(this.value) || 0">
              </div>
            </div>

            <div class="form-group">
              <label>Total Amount*</label>
              <input type="number" class="form-input" value="${invoice.total || ''}" step="0.01"
                     onchange="extractedInvoices[${index}].total = parseFloat(this.value) || 0"
                     style="font-weight: bold;">
            </div>

            <!-- Line items -->
            ${invoice.items && invoice.items.length > 0 ? `
              <details style="margin-top: 12px;">
                <summary style="cursor: pointer; font-size: 12px; font-weight: bold;">
                  ${invoice.items.length} line item${invoice.items.length > 1 ? 's' : ''} extracted
                </summary>
                <table class="items-table" style="font-size: 11px; margin-top: 8px;">
                  <thead><tr><th>Item</th><th>Qty</th><th>Price</th></tr></thead>
                  <tbody>
                    ${invoice.items.map(item => `
                      <tr>
                        <td>${item.description}</td>
                        <td>${item.quantity}</td>
                        <td>$${item.price.toFixed(2)}</td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
              </details>
            ` : '<p style="font-size: 11px; color: var(--gray-500); margin-top: 8px;">No line items extracted</p>'}

            <!-- Raw OCR text for this invoice -->
            <details style="margin-top: 12px;">
              <summary style="cursor: pointer; font-size: 11px; color: var(--gray-500);">View Raw OCR Text</summary>
              <textarea readonly style="width: 100%; min-height: 150px; margin-top: 8px; font-family: monospace; font-size: 10px; padding: 8px; border: 1px solid var(--gray-300);">${invoice.ocrText}</textarea>
            </details>
          </div>
        `;
      });

      container.innerHTML = html;

      // Update main fields to hidden (since we're showing individual invoice fields)
      document.getElementById('extractedVendor').closest('.form-group').style.display = 'none';
      document.getElementById('extractedDate').closest('.form-group').parentElement.style.display = 'none';
      document.getElementById('extractedTotal').closest('.form-group').style.display = 'none';
    }

    async function saveInvoice() {
      // Batch save all extracted invoices
      if (!extractedInvoices || extractedInvoices.length === 0) {
        alert('No invoices to save');
        return;
      }

      try {
        const invoicesToSave = [];
        let missingData = [];

        // Validate each invoice
        extractedInvoices.forEach((invoice, index) => {
          if (!invoice.date) {
            missingData.push(`Invoice ${index + 1}: missing date`);
          }
          if (!invoice.total || invoice.total === 0) {
            missingData.push(`Invoice ${index + 1}: missing total amount`);
          }
          if (!invoice.vendorName) {
            missingData.push(`Invoice ${index + 1}: missing vendor name`);
          }

          invoicesToSave.push({
            vendor_id: invoice.vendorId || null,
            vendor_name: invoice.vendorName || 'Unknown',
            invoice_date: invoice.date,
            invoice_number: invoice.invoiceNumber,
            total_amount: invoice.total,
            ocr_text: invoice.ocrText,
            parsed_data: JSON.stringify({
              subtotal: invoice.subtotal,
              tax: invoice.tax,
              deliveryFee: invoice.deliveryFee,
              driverFee: invoice.driverFee,
              pageNumber: invoice.pageNumber,
              itemCount: invoice.items.length
            }),
            items_extracted: JSON.stringify(invoice.items),
            processed: true,
            verified: false,
            uploaded_at: new Date().toISOString()
          });
        });

        // Show warnings if data is missing but still allow save
        if (missingData.length > 0) {
          const proceed = confirm(
            `Warning: Some invoices are missing data:\n\n${missingData.join('\n')}\n\nDo you want to save anyway?`
          );
          if (!proceed) return;
        }

        // Save all invoices
        const { data, error } = await supabase
          .from('invoice_archive')
          .insert(invoicesToSave)
          .select();

        if (error) throw error;

        alert(`‚úì Successfully saved ${invoicesToSave.length} invoice${invoicesToSave.length > 1 ? 's' : ''}!`);

        // Reset form
        document.getElementById('invoiceFile').value = '';
        document.getElementById('invoicePreview').style.display = 'none';
        document.getElementById('extractedData').style.display = 'none';
        document.getElementById('processBtn').style.display = 'block';
        document.getElementById('processBtn').disabled = false;
        document.getElementById('saveInvoiceBtn').style.display = 'none';
        currentInvoiceFile = null;
        currentOcrText = '';
        extractedInvoices = [];

        showDashboard();

      } catch (error) {
        console.error('Error saving invoices:', error);
        alert('Error saving invoices: ' + error.message);
      }
    }

    // Load items from database
    async function loadItems(category = '') {
      const itemsList = document.getElementById('itemsList');
      itemsList.innerHTML = '<p style="text-align: center; color: var(--gray-500); padding: 40px 0;">Loading items...</p>';

      try {
        let query = supabase
          .from('inventory_items')
          .select('*')
          .order('category', { ascending: true })
          .order('item_name', { ascending: true });

        if (category) {
          query = query.eq('category', category);
        }

        const { data, error } = await query;

        if (error) throw error;

        if (!data || data.length === 0) {
          itemsList.innerHTML = '<p style="text-align: center; color: var(--gray-500); padding: 40px 0;">No items found. Click "Add New Item" to get started.</p>';
          return;
        }

        let html = '<table class="items-table"><thead><tr>';
        html += '<th>Item</th><th>Category</th><th>Unit</th><th>Par</th><th>Cost</th><th>Actions</th>';
        html += '</tr></thead><tbody>';

        data.forEach(item => {
          html += `<tr>
            <td><strong>${item.item_name}</strong></td>
            <td><span style="font-size: 10px; padding: 4px 8px; background: var(--light-blue);">${item.category}</span></td>
            <td>${item.unit}</td>
            <td>${item.par_level || '-'}</td>
            <td>$${item.current_cost ? item.current_cost.toFixed(2) : '-'}</td>
            <td>
              <button class="btn-small btn-edit" onclick="editItem(${item.id})">Edit</button>
              <button class="btn-small btn-delete" onclick="deleteItem(${item.id})">Delete</button>
            </td>
          </tr>`;
        });

        html += '</tbody></table>';
        itemsList.innerHTML = html;

      } catch (error) {
        console.error('Error loading items:', error);
        itemsList.innerHTML = `<p style="text-align: center; color: var(--error); padding: 40px 0;">Error loading items: ${error.message}</p>`;
      }
    }

    function filterItems() {
      const category = document.getElementById('categoryFilter').value;
      loadItems(category);
    }

    async function saveItem() {
      const name = document.getElementById('itemName').value.trim();
      const category = document.getElementById('itemCategory').value;
      const unit = document.getElementById('itemUnit').value.trim();
      const parLevel = parseFloat(document.getElementById('itemParLevel').value) || null;
      const cost = parseFloat(document.getElementById('itemCost').value) || null;
      const vendor = document.getElementById('itemVendor').value.trim() || null;
      const barcode = document.getElementById('itemBarcode').value.trim() || null;
      const frequency = document.getElementById('itemFrequency').value;

      if (!name || !category || !unit) {
        alert('Please fill in all required fields (Item Name, Category, Unit)');
        return;
      }

      try {
        const itemData = {
          item_name: name,
          category: category,
          unit: unit,
          par_level: parLevel,
          current_cost: cost,
          vendor_name: vendor,
          barcode: barcode,
          count_frequency: frequency,
          last_updated: new Date().toISOString()
        };

        let result;
        if (currentEditingId) {
          result = await supabase
            .from('inventory_items')
            .update(itemData)
            .eq('id', currentEditingId);
        } else {
          itemData.created_at = new Date().toISOString();
          result = await supabase
            .from('inventory_items')
            .insert([itemData]);
        }

        if (result.error) throw result.error;

        alert(currentEditingId ? 'Item updated successfully!' : 'Item added successfully!');
        currentEditingId = null;
        showManageItems();

      } catch (error) {
        console.error('Error saving item:', error);
        alert('Error saving item: ' + error.message);
      }
    }

    async function editItem(id) {
      try {
        const { data, error } = await supabase
          .from('inventory_items')
          .select('*')
          .eq('id', id)
          .single();

        if (error) throw error;

        currentEditingId = id;
        document.getElementById('itemFormTitle').textContent = 'Edit Item';
        document.getElementById('itemName').value = data.item_name;
        document.getElementById('itemCategory').value = data.category;
        document.getElementById('itemUnit').value = data.unit;
        document.getElementById('itemParLevel').value = data.par_level || '';
        document.getElementById('itemCost').value = data.current_cost || '';
        document.getElementById('itemVendor').value = data.vendor_name || '';
        document.getElementById('itemBarcode').value = data.barcode || '';
        document.getElementById('itemFrequency').value = data.count_frequency || 'weekly';

        document.getElementById('dashboard').style.display = 'none';
        document.getElementById('manageItems').style.display = 'none';
        document.getElementById('itemForm').style.display = 'block';

      } catch (error) {
        console.error('Error loading item:', error);
        alert('Error loading item: ' + error.message);
      }
    }

    async function deleteItem(id) {
      if (!confirm('Are you sure you want to delete this item?')) {
        return;
      }

      try {
        const { error } = await supabase
          .from('inventory_items')
          .delete()
          .eq('id', id);

        if (error) throw error;

        alert('Item deleted successfully!');
        loadItems();

      } catch (error) {
        console.error('Error deleting item:', error);
        alert('Error deleting item: ' + error.message);
      }
    }

    // ========== Vendor Addition Modal ==========
    function showAddVendorModal(invoiceIndex) {
      currentInvoiceIndexForVendor = invoiceIndex;
      const vendorName = extractedInvoices[invoiceIndex].vendorName;

      // Pre-fill vendor name
      document.getElementById('newVendorName').value = vendorName;

      // Reset form fields
      const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
      days.forEach(day => {
        document.getElementById(`orderDay_${day}`).checked = false;
      });
      document.getElementById('newVendorCutoffTime').value = '';
      document.getElementById('newVendorMethod').value = '';
      document.getElementById('newVendorRepName').value = '';
      document.getElementById('newVendorRepPhone').value = '';
      document.getElementById('newVendorNotes').value = '';

      // Show modal
      document.getElementById('addVendorModal').style.display = 'block';
    }

    function closeAddVendorModal() {
      document.getElementById('addVendorModal').style.display = 'none';
      currentInvoiceIndexForVendor = null;
    }

    async function saveNewVendor() {
      if (currentInvoiceIndexForVendor === null) return;

      const vendorName = document.getElementById('newVendorName').value;
      const orderMethod = document.getElementById('newVendorMethod').value;

      if (!vendorName || !orderMethod) {
        alert('Please fill in vendor name and order method');
        return;
      }

      // Collect selected order days
      const orderDays = [];
      const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
      days.forEach(day => {
        if (document.getElementById(`orderDay_${day}`).checked) {
          orderDays.push(day);
        }
      });

      try {
        // Insert new vendor into database
        const { data, error } = await supabase
          .from('vendors')
          .insert([{
            vendor_name: vendorName,
            order_days: orderDays.length > 0 ? orderDays : null,
            order_cutoff_time: document.getElementById('newVendorCutoffTime').value || null,
            order_method: orderMethod,
            rep_name: document.getElementById('newVendorRepName').value || null,
            rep_phone: document.getElementById('newVendorRepPhone').value || null,
            special_notes: document.getElementById('newVendorNotes').value || null,
            priority: 'normal',
            active: true
          }])
          .select();

        if (error) throw error;

        const newVendor = data[0];

        // Update the invoice with the new vendor ID
        extractedInvoices[currentInvoiceIndexForVendor].vendorId = newVendor.id;
        extractedInvoices[currentInvoiceIndexForVendor].vendorName = newVendor.vendor_name;
        extractedInvoices[currentInvoiceIndexForVendor].isKnownVendor = true;

        // Add to known vendors array
        knownVendors.push(newVendor);

        // Refresh the display
        displayMultipleInvoices();

        // Close modal
        closeAddVendorModal();

        alert(`‚úì Vendor "${vendorName}" added successfully!`);

      } catch (error) {
        console.error('Error saving vendor:', error);
        alert('Error saving vendor: ' + error.message);
      }
    }
  </script>
</body>
</html>
